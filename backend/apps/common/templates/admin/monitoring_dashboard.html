{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Дашборд мониторинга синхронизации{% endblock %}

{% block extrastyle %}
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .metric-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .metric-card h3 {
        margin-top: 0;
        color: #417690;
        font-size: 16px;
        font-weight: 600;
    }

    .metric-value {
        font-size: 32px;
        font-weight: bold;
        margin: 10px 0;
    }

    .metric-label {
        color: #666;
        font-size: 14px;
    }

    .metric-value.success {
        color: #28a745;
    }

    .metric-value.error {
        color: #dc3545;
    }

    .metric-value.warning {
        color: #ffc107;
    }

    .health-status {
        padding: 10px 20px;
        border-radius: 4px;
        display: inline-block;
        font-weight: bold;
    }

    .health-status.healthy {
        background: #d4edda;
        color: #155724;
    }

    .health-status.unhealthy {
        background: #f8d7da;
        color: #721c24;
    }

    .component-status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        background: #f8f9fa;
    }

    .component-status.available {
        border-left: 4px solid #28a745;
    }

    .component-status.unavailable {
        border-left: 4px solid #dc3545;
    }

    .refresh-info {
        color: #666;
        font-size: 12px;
        margin-top: 20px;
        text-align: center;
    }

    .chart-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Дашборд мониторинга синхронизации с 1С</h1>

    <!-- System Health -->
    <div class="metric-card">
        <h3>Статус системы</h3>
        {% if health.is_healthy %}
            <div class="health-status healthy">✓ Система работает нормально</div>
        {% else %}
            <div class="health-status unhealthy">✗ Обнаружены проблемы</div>
        {% endif %}

        <div style="margin-top: 15px;">
            {% for name, component in health.components.items %}
                <div class="component-status {% if component.available %}available{% else %}unavailable{% endif %}">
                    <strong>{{ name|title }}:</strong> {{ component.message }}
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Real-time Metrics -->
    <h2 style="margin-top: 30px;">Метрики в реальном времени</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Операции (5 мин)</h3>
            <div class="metric-value">{{ realtime.operations_last_5min }}</div>
            <div class="metric-label">Пропускная способность: {{ realtime.throughput_per_minute }} оп/мин</div>
        </div>

        <div class="metric-card">
            <h3>Текущий Error Rate</h3>
            <div class="metric-value {% if realtime.current_error_rate > 10 %}error{% elif realtime.current_error_rate > 5 %}warning{% else %}success{% endif %}">
                {{ realtime.current_error_rate }}%
            </div>
            <div class="metric-label">Ошибок: {{ realtime.errors_last_5min }}</div>
        </div>

        <div class="metric-card">
            <h3>В процессе</h3>
            <div class="metric-value">{{ realtime.pending_operations }}</div>
            <div class="metric-label">Операций ожидают выполнения</div>
        </div>
    </div>

    <!-- Operation Metrics (24h) -->
    <h2>Метрики операций (24 часа)</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Всего операций</h3>
            <div class="metric-value">{{ operations.total_operations }}</div>
            <div class="metric-label">
                <span class="metric-value success" style="font-size: 16px;">{{ operations.success_count }}</span> успешных<br>
                <span class="metric-value error" style="font-size: 16px;">{{ operations.error_count }}</span> ошибок
            </div>
        </div>

        <div class="metric-card">
            <h3>Success Rate</h3>
            <div class="metric-value success">{{ operations.success_rate }}%</div>
            <div class="metric-label">Error Rate: {{ operations.error_rate }}%</div>
        </div>

        <div class="metric-card">
            <h3>Среднее время выполнения</h3>
            <div class="metric-value">{{ operations.duration_avg_ms|floatformat:0 }} мс</div>
            <div class="metric-label">
                P95: {{ operations.duration_p95_ms|floatformat:0 }} мс<br>
                P99: {{ operations.duration_p99_ms|floatformat:0 }} мс
            </div>
        </div>
    </div>

    <!-- Operations by Type -->
    <div class="chart-container">
        <h3>Операции по типам</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Тип операции</th>
                    <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Количество</th>
                </tr>
            </thead>
            <tbody>
                {% for op_type, count in operations.operations_by_type.items %}
                <tr>
                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">{{ op_type }}</td>
                    <td style="padding: 10px; text-align: right; border-bottom: 1px solid #dee2e6;">{{ count }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Business Metrics -->
    <h2>Бизнес-метрики (24 часа)</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Синхронизированные клиенты</h3>
            <div class="metric-value">{{ business.synced_customers_count }}</div>
            <div class="metric-label">Уникальных клиентов</div>
        </div>

        <div class="metric-card">
            <h3>Разрешено конфликтов</h3>
            <div class="metric-value">{{ business.total_conflicts_resolved }}</div>
            <div class="metric-label">Авто-разрешение: {{ business.auto_resolution_rate }}%</div>
        </div>

        <div class="metric-card">
            <h3>Новые регистрации</h3>
            <div class="metric-value">{{ business.new_registrations }}</div>
            <div class="metric-label">Импорт из 1С: {{ business.imports_from_1c }}</div>
        </div>
    </div>

    <div class="refresh-info">
        Последнее обновление: {{ now|date:"d.m.Y H:i:s" }}<br>
        <a href="{% url 'admin:monitoring_dashboard' %}">Обновить дашборд</a>
    </div>
</div>
{% endblock %}
