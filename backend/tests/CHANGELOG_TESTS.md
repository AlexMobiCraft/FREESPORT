# Changelog - Исправления тестов

## [2025-09-30] - Исправление критичных проблем CI/CD

### Добавлено

#### 1. Автоматическое закрытие соединений БД
- **Файл:** `tests/conftest.py`
- **Изменение:** Добавлена фикстура `close_db_connections` с `autouse=True`
- **Цель:** Предотвращение ошибки "database is being accessed by other users"
- **Эффект:** Все соединения с БД автоматически закрываются после каждого теста

```python
@pytest.fixture(autouse=True, scope="function")
def close_db_connections():
    """
    Автоматическое закрытие соединений с БД после каждого теста.
    Предотвращает ошибки "database is being accessed by other users".
    """
    yield
    
    try:
        from django.db import connections
        connections.close_all()
    except Exception:
        pass
```

#### 2. Маркер django_db в pytest.ini
- **Файл:** `pytest.ini`
- **Изменение:** Добавлен маркер `django_db` в список markers
- **Цель:** Явное объявление маркера для тестов с доступом к БД
- **Эффект:** Устранение предупреждений pytest о неизвестных маркерах

#### 3. Руководство по исправлению тестов
- **Файл:** `tests/TEST_FIXES_GUIDE.md`
- **Содержание:**
  - Решение проблемы "Database access not allowed"
  - Исправление ошибок сравнения с Mock-объектами
  - Работа с уникальными ключами в тестах
  - Чеклист перед коммитом
  - Полезные команды для отладки

### Исправленные проблемы

#### Проблема 1: RuntimeError - Database access not allowed
**Симптом:**
```
RuntimeError: Database access not allowed, use the "django_db" mark
```

**Решение:**
- Все тесты сериализаторов уже имеют декоратор `@pytest.mark.django_db`
- Добавлен маркер в pytest.ini для корректной работы
- Создано руководство для разработчиков

#### Проблема 2: Сравнение с Mock-объектом
**Симптом:**
```
assert "<Mock name='...'>" == 'Доставлен'
```

**Решение:**
- Создано руководство с примерами правильного использования Mock
- Указано на необходимость вызова методов Mock с `()`
- Добавлены примеры правильного и неправильного кода

#### Проблема 3: Дублирование ключей в БД
**Симптом:**
```
duplicate key value violates unique constraint
```

**Решение:**
- В conftest.py уже есть функция `get_unique_suffix()`
- Добавлены примеры использования в руководстве
- Рекомендации по генерации уникальных значений

#### Проблема 4: Незакрытые соединения с БД
**Симптом:**
```
database 'test_test_db' is being accessed by other users
```

**Решение:**
- Добавлена автоматическая фикстура `close_db_connections`
- Соединения закрываются после каждого теста
- Предотвращение утечек соединений

### Рекомендации для разработчиков

1. **Всегда используйте `@pytest.mark.django_db`** для тестов, обращающихся к БД
2. **Вызывайте методы Mock с `()`**, не сравнивайте сам объект Mock
3. **Используйте `get_unique_suffix()`** для генерации уникальных значений
4. **Проверяйте тесты локально** перед коммитом: `pytest tests/ -v`
5. **Читайте `TEST_FIXES_GUIDE.md`** при возникновении проблем

### Связанные файлы

- `backend/tests/conftest.py` - Глобальные фикстуры
- `backend/pytest.ini` - Конфигурация pytest
- `backend/tests/TEST_FIXES_GUIDE.md` - Руководство по исправлению
- `.github/workflows/backend-ci.yml` - CI/CD конфигурация

### Проверка

Для проверки исправлений запустите:

```bash
cd backend
pytest tests/ -v --tb=short
```

Все тесты должны проходить без ошибок доступа к БД и предупреждений о незакрытых соединениях.

### Следующие шаги

- [ ] Проверить все тесты на использование Mock-объектов
- [ ] Убедиться, что все тесты с БД имеют декоратор `@pytest.mark.django_db`
- [ ] Проверить уникальность значений в фабриках
- [ ] Запустить полный набор тестов в CI/CD
