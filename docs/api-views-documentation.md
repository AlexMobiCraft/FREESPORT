# API Views Документация

## Оглавление

1. [Products API](#products-api) - Каталог товаров, категории, бренды
2. [Cart API](#cart-api) - Управление корзиной покупок  
3. [Orders API](#orders-api) - Система заказов
4. [Users API](#users-api) - Аутентификация и личный кабинет
5. [Common API](#common-api) - Общие утилиты и мониторинг

---

## Products API (apps/products/views.py)

### ProductViewSet

**Назначение:** Управление каталогом товаров с фильтрацией и ролевым ценообразованием

#### Методы:

**`get_queryset()`**

- **Цель:** Оптимизированная загрузка товаров с предзагрузкой связанных объектов
- **Логика:** Фильтрация только активных товаров, select_related для brand/category
- **Возврат:** QuerySet[Product] с оптимизацией запросов

**`get_serializer_class()`**

- **Цель:** Выбор serializer в зависимости от типа операции
- **Логика:** ProductDetailSerializer для retrieve, ProductListSerializer для list
- **Возврат:** Класс serializer

**`list()` - GET /products/**

- **Цель:** Получение списка товаров с фильтрацией и сортировкой
- **Логика:** Поддержка фильтров по категории, бренду, цене, наличию, поиску
- **Параметры:** category_id, brand, min_price, max_price, in_stock, is_featured, search, ordering
- **Ответ:** Пагинированный список товаров с ролевыми ценами

**`retrieve()` - GET /products/{id}/**

- **Цель:** Получение детальной информации о товаре
- **Логика:** Включает related_products, галерею изображений, спецификации
- **Ответ:** Полная информация о товаре с ролевым ценообразованием

### CategoryViewSet

**Назначение:** Управление категориями товаров с поддержкой иерархии

#### Методы:

**`get_queryset()`**

- **Цель:** Загрузка категорий с подсчетом товаров и предзагрузкой дочерних
- **Логика:** Аннотация products_count, prefetch дочерних категорий
- **Возврат:** QuerySet[Category] с оптимизацией

**`list()` - GET /categories/**

- **Цель:** Получение списка всех категорий с иерархией
- **Логика:** Включает children и products_count для каждой категории
- **Ответ:** Дерево категорий с количеством товаров

**`retrieve()` - GET /categories/{slug}/**

- **Цель:** Получение детальной информации о категории
- **Логика:** Включает навигационную цепочку (breadcrumbs)
- **Ответ:** Категория с полной иерархической информацией

### CategoryTreeViewSet

**Назначение:** Получение корневых категорий для навигации

#### Методы:

**`get_queryset()`**

- **Цель:** Загрузка только корневых категорий (parent__isnull=True)
- **Логика:** Рекурсивное включение всех дочерних категорий
- **Возврат:** QuerySet корневых категорий

**`list()` - GET /category-tree/**

- **Цель:** Получение полного дерева категорий для навигации
- **Логика:** Иерархическая структура для фронтенд меню
- **Ответ:** Дерево категорий от корневых до листьев

### BrandViewSet

**Назначение:** Управление брендами товаров

#### Методы:

**`get_queryset()`**

- **Цель:** Получение только активных брендов
- **Логика:** Фильтрация is_active=True, сортировка по name
- **Возврат:** QuerySet[Brand]

**`list()` - GET /brands/**

- **Цель:** Получение списка всех активных брендов
- **Ответ:** Список брендов для фильтрации

**`retrieve()` - GET /brands/{slug}/**

- **Цель:** Получение информации о конкретном бренде
- **Ответ:** Детали бренда с логотипом и описанием

---

## Cart API (apps/cart/views.py)

### CartViewSet

**Назначение:** Управление корзиной пользователя (создание, получение, очистка)

#### Методы:

**`get_queryset()`**

- **Цель:** Определить корзины доступные текущему пользователю
- **Логика:**
  - Авторизованные: корзина по `user` 
  - Гости: корзина по `session_key`
  - Если нет session - пустой QuerySet
- **Возврат:** QuerySet[Cart]

**`get_or_create_cart()`**

- **Цель:** Получить или создать корзину для текущего запроса
- **Логика:**
  - Авторизованные: `get_or_create(user=request.user)`
  - Гости: создает session, `get_or_create(session_key=session_key)`
- **Возврат:** Cart объект

**`list()` - GET /cart/**

- **Цель:** Получить содержимое корзины с totals
- **Логика:** Всегда создает корзину если её нет, сериализует через CartSerializer
- **Ответ:** JSON с items, total_items, total_amount

**`clear()` - DELETE /cart/clear/**

- **Цель:** Очистить все товары из корзины
- **Логика:** Вызывает `cart.clear()` из модели
- **Ответ:** 204 No Content

### CartItemViewSet

**Назначение:** CRUD операции с элементами корзины

#### Методы:

**`get_queryset()`**

- **Цель:** Получить элементы корзины текущего пользователя
- **Логика:** Находит корзину, фильтрует CartItem по ней
- **Возврат:** QuerySet[CartItem]

**`get_serializer_class()`**

- **Цель:** Выбрать подходящий serializer
- **Логика:**
  - `create`: CartItemCreateSerializer (валидация при добавлении)
  - `update/partial_update`: CartItemUpdateSerializer (валидация количества)
  - остальные: CartItemSerializer (отображение)
- **Возврат:** Класс serializer

**`perform_create()`**

- **Цель:** Реализация логики объединения товаров (FR6.1)
- **Логика:**
  - Проверяет существование товара в корзине
  - Если есть: увеличивает quantity
  - Если нет: создает новый CartItem
- **Сохраняет:** Результат в `self.cart_item`

**`create()` - POST /cart/items/**

- **Цель:** Добавить товар в корзину
- **Логика:** Валидация → perform_create() → возврат результата
- **Ответ:** 201 Created с CartItem данными

**`update()` - PATCH /cart/items/{id}/**

- **Цель:** Изменить количество товара
- **Логика:** Стандартная DRF логика с валидацией остатков
- **Ответ:** 200 OK с обновленными данными

**`destroy()` - DELETE /cart/items/{id}/**

- **Цель:** Удалить товар из корзины
- **Логика:** Стандартное DRF удаление
- **Ответ:** 204 No Content

---

## Схема документирования для остальных Views

### Структура документа:

```markdown
# API Views Документация

## [App Name] API (apps/[app]/views.py)

### [ViewSetName]

**Назначение:** [Краткое описание назначения ViewSet]

#### Методы:

**`method_name()` - [HTTP METHOD] /endpoint/**
- **Цель:** [Что делает метод]
- **Логика:** [Ключевые шаги алгоритма]
- **Параметры:** [Важные параметры если есть]
- **Возврат/Ответ:** [Что возвращает]
- **Особенности:** [Бизнес-правила, валидации]
```

### Файловая структура:

```
docs/
├── api-views-documentation.md          # Основной файл
├── views-docs/                         # Детальные описания
│   ├── cart-views.md                   # Подробно о корзине
│   ├── products-views.md               # Подробно о товарах
│   ├── users-views.md                  # Подробно о пользователях
│   └── orders-views.md                 # Подробно о заказах
└── api-business-rules.md               # Бизнес-правила API
```

### Принципы документирования:
1. **Цель метода** - зачем он нужен
2. **Ключевая логика** - основные шаги
3. **Бизнес-правила** - что важно знать
4. **Входы/выходы** - параметры и ответы
5. **Особенности** - валидации, ограничения

Документацию обновлять при изменении views, держать синхронизированной с кодом.

---

## Orders API (apps/orders/views.py)

### OrderViewSet

**Назначение:** Управление заказами с транзакционной логикой создания из корзины

#### Методы:

**`get_queryset()`**
- **Цель:** Получение заказов текущего пользователя с оптимизацией запросов
- **Логика:** Фильтрация по user=request.user, prefetch_related для items и связанных объектов
- **Возврат:** QuerySet[Order] с оптимизированными JOIN'ами
- **Особенности:** Анонимные пользователи получают пустой QuerySet

**`get_serializer_class()`**
- **Цель:** Выбор serializer в зависимости от типа операции
- **Логика:** 
  - `create`: OrderCreateSerializer (валидация и создание)
  - `list`: OrderListSerializer (краткая информация)
  - `retrieve/update`: OrderDetailSerializer (полная информация)
- **Возврат:** Класс serializer

**`retrieve()` - GET /orders/{id}/**
- **Цель:** Получение детальной информации о заказе
- **Логика:** Проверка прав доступа к заказу (owner или staff)
- **Ответ:** Полная информация о заказе с nested items
- **Особенности:** 403 Forbidden при попытке доступа к чужому заказу

**`create()` - POST /orders/**
- **Цель:** Создание заказа из текущей корзины
- **Логика:** 
  1. Валидация данных заказа
  2. Транзакционное создание заказа (@transaction.atomic)
  3. Перенос товаров из корзины в OrderItems
  4. Очистка корзины после успешного создания
- **Параметры:** delivery_address, delivery_method, payment_method, notes
- **Ответ:** 201 Created с детальной информацией о созданном заказе
- **Особенности:** 
  - Полная транзакционная целостность
  - Валидация остатков товаров
  - B2B валидация способов оплаты
  - Ролевое ценообразование

**`list()` - GET /orders/**
- **Цель:** Получение списка заказов пользователя
- **Логика:** Пагинированный список с сортировкой по дате создания (новые первыми)
- **Ответ:** Краткая информация о заказах для списка
- **Особенности:** Только собственные заказы пользователя

**`cancel()` - PATCH /orders/{id}/cancel/**
- **Цель:** Отмена заказа
- **Логика:** 
  1. Проверка прав доступа (owner или staff)
  2. Валидация возможности отмены (`can_be_cancelled`)
  3. Изменение статуса на 'cancelled'
- **Ответ:** Обновленная информация о заказе
- **Особенности:** Заказы можно отменить только в определенных статусах

---

## Users API (apps/users/views/)

### Authentication Views (authentication.py)

#### UserRegistrationView

**Назначение:** Регистрация новых пользователей с поддержкой ролей

**`post()` - POST /auth/register/**
- **Цель:** Создание нового пользователя в системе
- **Логика:** Валидация данных, создание User с указанной ролью, генерация JWT токенов
- **Параметры:** email, password, confirm_password, first_name, last_name, phone, role
- **Ответ:** 201 Created с данными пользователя и токенами
- **Особенности:** Поддержка всех ролей (retail, wholesale_level1-3, trainer, federation_rep)

#### UserLoginView

**Назначение:** Аутентификация существующих пользователей

**`post()` - POST /auth/login/**
- **Цель:** Авторизация пользователя в системе
- **Логика:** Проверка credentials, генерация JWT токенов
- **Параметры:** email, password
- **Ответ:** 200 OK с токенами и профилем пользователя
- **Особенности:** Интеграция с JWT authentication

### Personal Cabinet Views (personal_cabinet.py)

#### UserDashboardView

**Назначение:** Персональный дашборд пользователя

**`get()` - GET /personal-cabinet/dashboard/**
- **Цель:** Агрегированная информация для личного кабинета
- **Логика:** Сбор статистики заказов, адресов, избранного
- **Ответ:** Дашборд с кратким обзором активности пользователя
- **Особенности:** Требует аутентификации

#### AddressViewSet

**Назначение:** Управление адресами пользователя

**`get_queryset()`**
- **Цель:** Получение адресов текущего пользователя
- **Логика:** Фильтрация по user=request.user
- **Возврат:** QuerySet[Address]

**`list()` - GET /personal-cabinet/addresses/**
- **Цель:** Список всех адресов пользователя
- **Ответ:** Массив адресов с пометкой основного

**`create()` - POST /personal-cabinet/addresses/**
- **Цель:** Добавление нового адреса
- **Логика:** Автоматическая привязка к текущему пользователю
- **Особенности:** Валидация уникальности для типа адреса

**`update()` - PUT /personal-cabinet/addresses/{id}/**
- **Цель:** Обновление существующего адреса
- **Логика:** Проверка принадлежности адреса пользователю

**`destroy()` - DELETE /personal-cabinet/addresses/{id}/**
- **Цель:** Удаление адреса
- **Особенности:** Защита от удаления основного адреса

#### FavoriteViewSet

**Назначение:** Управление избранными товарами

**`get_queryset()`**
- **Цель:** Получение избранных товаров пользователя
- **Логика:** Фильтрация по user, предзагрузка product данных
- **Возврат:** QuerySet[Favorite] с select_related

**`list()` - GET /personal-cabinet/favorites/**
- **Цель:** Список избранных товаров
- **Ответ:** Товары с ролевыми ценами и доступностью

**`create()` - POST /personal-cabinet/favorites/**
- **Цель:** Добавление товара в избранное
- **Логика:** Проверка существования товара и предотвращение дублирования
- **Параметры:** product_id

**`destroy()` - DELETE /personal-cabinet/favorites/{id}/**
- **Цель:** Удаление из избранного
- **Логика:** Проверка принадлежности записи пользователю

### Profile Views (profile.py)

#### UserProfileView

**Назначение:** Управление профилем пользователя

**`get()` - GET /personal-cabinet/profile/**
- **Цель:** Получение полной информации профиля
- **Ответ:** Данные пользователя с адресами и статистикой

**`patch()` - PATCH /personal-cabinet/profile/**
- **Цель:** Обновление данных профиля
- **Логика:** Частичное обновление разрешенных полей
- **Особенности:** Защита от изменения роли и email

### Misc Views (misc.py)

#### HealthCheckView

**Назначение:** Проверка состояния API

**`get()` - GET /health/**
- **Цель:** Быстрая проверка доступности сервиса
- **Ответ:** Статус сервиса и время ответа

---

## Common API (apps/common/views.py)

### SyncLogViewSet

**Назначение:** Мониторинг синхронизации с внешними системами

**`get_queryset()`**
- **Цель:** Получение логов синхронизации
- **Логика:** Фильтрация по датам и типам синхронизации
- **Возврат:** QuerySet[SyncLog]

**`list()` - GET /sync-logs/**
- **Цель:** История операций синхронизации
- **Ответ:** Пагинированный список логов с деталями ошибок

## Pages API (apps/pages/views.py)

### PageViewSet

**Назначение:** Управление статическими страницами с кэшированием и SEO оптимизацией

#### Методы:

**`get_queryset()`**
- **Цель:** Получение только опубликованных страниц
- **Логика:** Фильтрация по is_published=True
- **Возврат:** QuerySet[Page] с активными страницами

**`list()` - GET /pages/**
- **Цель:** Получение списка всех статических страниц с кэшированием
- **Логика:** Проверка кэша pages_list, кэширование на 24 часа при отсутствии
- **Ответ:** Список страниц с основными полями
- **Особенности:** 
  - Кэширование на 24 часа через Django cache
  - Публичный доступ без аутентификации
  - drf-spectacular документация

**`retrieve()` - GET /pages/{slug}/**
- **Цель:** Получение содержимого конкретной страницы по slug
- **Логика:** Кэширование через @cache_page декоратор на 24 часа
- **Параметры:** slug - URL идентификатор страницы
- **Ответ:** Полное содержимое страницы с HTML контентом и SEO метаданными
- **Особенности:** 
  - HTML sanitization на уровне модели
  - SEO поля: seo_title, seo_description
  - Автогенерация SEO из title/content
  - Поддержка кириллических slug через transliterate

---

## Сводная таблица всех API Endpoints

### Products API

| Method | Endpoint | Описание | Аутентификация |
|--------|----------|----------|----------------|
| GET | `/api/v1/products/` | Список товаров с фильтрацией | Опционально |
| GET | `/api/v1/products/{id}/` | Детали товара | Опционально |
| GET | `/api/v1/categories/` | Список категорий | Нет |
| GET | `/api/v1/categories/{slug}/` | Детали категории | Нет |
| GET | `/api/v1/category-tree/` | Дерево категорий | Нет |
| GET | `/api/v1/brands/` | Список брендов | Нет |
| GET | `/api/v1/brands/{slug}/` | Детали бренда | Нет |

### Cart API

| Method | Endpoint | Описание | Аутентификация |
|--------|----------|----------|----------------|
| GET | `/api/v1/cart/` | Получить корзину | Опционально |
| DELETE | `/api/v1/cart/clear/` | Очистить корзину | Опционально |
| POST | `/api/v1/cart/items/` | Добавить товар | Опционально |
| GET | `/api/v1/cart/items/` | Список товаров в корзине | Опционально |
| GET | `/api/v1/cart/items/{id}/` | Детали товара в корзине | Опционально |
| PATCH | `/api/v1/cart/items/{id}/` | Обновить количество | Опционально |
| DELETE | `/api/v1/cart/items/{id}/` | Удалить товар | Опционально |

### Orders API

| Method | Endpoint | Описание | Аутентификация |
|--------|----------|----------|----------------|
| GET | `/api/v1/orders/` | Список заказов пользователя | Да |
| POST | `/api/v1/orders/` | Создать заказ из корзины | Да |
| GET | `/api/v1/orders/{id}/` | Детали заказа | Да |
| PATCH | `/api/v1/orders/{id}/cancel/` | Отменить заказ | Да |

### Users API

| Method | Endpoint | Описание | Аутентификация |
|--------|----------|----------|----------------|
| POST | `/api/v1/auth/register/` | Регистрация | Нет |
| POST | `/api/v1/auth/login/` | Авторизация | Нет |
| GET | `/api/v1/personal-cabinet/dashboard/` | Дашборд | Да |
| GET | `/api/v1/personal-cabinet/profile/` | Профиль | Да |
| PATCH | `/api/v1/personal-cabinet/profile/` | Обновить профиль | Да |
| GET | `/api/v1/personal-cabinet/addresses/` | Список адресов | Да |
| POST | `/api/v1/personal-cabinet/addresses/` | Добавить адрес | Да |
| PUT | `/api/v1/personal-cabinet/addresses/{id}/` | Обновить адрес | Да |
| DELETE | `/api/v1/personal-cabinet/addresses/{id}/` | Удалить адрес | Да |
| GET | `/api/v1/personal-cabinet/favorites/` | Избранное | Да |
| POST | `/api/v1/personal-cabinet/favorites/` | Добавить в избранное | Да |
| DELETE | `/api/v1/personal-cabinet/favorites/{id}/` | Удалить из избранного | Да |

### Pages API

| Method | Endpoint | Описание | Аутентификация |
|--------|----------|----------|----------------|
| GET | `/api/v1/pages/` | Список статических страниц | Нет |
| GET | `/api/v1/pages/{slug}/` | Содержимое страницы | Нет |

### Common API

| Method | Endpoint | Описание | Аутентификация |
|--------|----------|----------|----------------|
| GET | `/api/v1/health/` | Проверка состояния | Нет |
| GET | `/api/v1/sync-logs/` | Логи синхронизации | Да (админ) |

### Особенности аутентификации:

- **Опционально** - работает как для гостей, так и для авторизованных (разные цены/функции)
- **Да** - требует JWT токен в заголовке Authorization
- **Нет** - публичный доступ
- **Да (админ)** - требует права администратора

---

Документацию обновлять при изменении views, держать синхронизированной с кодом.
