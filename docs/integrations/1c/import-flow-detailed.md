# Подробное описание процесса импорта из 1С (CommerceML 3.1)

В данном документе описана техническая реализация обмена данными между 1С:Предприятие и платформой FREESPORT.

## 1. Общий рабочий процесс (Protocol Flow)

Обмен происходит по стандартному протоколу 1С-Битрикс, адаптированному под архитектуру Django. Основная точка входа — `apps.integrations.onec_exchange.views.ICExchangeView`.

### Шаги сессии:
1.  **`mode=checkauth`**: Авторизация 1С. Сервер создает сессию Django, возвращает `cookie_name` и `session_id`.
2.  **`mode=init`**: Согласование параметров. Сервер сообщает лимиты файлов и поддержку ZIP. На этом этапе происходит очистка временных файлов предыдущих неудачных попыток для этой сессии.
3.  **`mode=file`**: Передача файлов.
    *   Файлы передаются бинарным потоком (binary stream).
    *   Реализована дозапись (append mode) для передачи больших файлов по частям.
    *   Файлы временно сохраняются в `media/1c_temp/<session_id>/`.
    *   После загрузки каждого файла срабатывает `FileRoutingService`, который перемещает XML и изображения в целевую папку импорта `media/1c_import/`.
4.  **`mode=import`**: Сигнал о завершении передачи конкретного файла.
    *   **В нашей реализации**: Мы просто отвечаем `success`. Мы не запускаем обработку на этом этапе, чтобы избежать частичного обновления каталога (например, когда товары уже созданы, а цены еще не переданы).
5.  **`mode=complete`**: Технический сигнал завершения всей сессии обмена.
    *   Именно этот сигнал является триггером для запуска реального импорта.
    *   Запускается фоновая задача Celery: `process_1c_import_task`.
    *   **Отладка (Dry Run)**: Чтобы проверить передачу файлов без запуска самого импорта в базу (например, при тестировании с реальной 1С), можно использовать один из двух способов:
        1.  Создать пустой файл-флаг `.dry_run` в директории `/app/media/1c_import/` (рекомендуемый способ).
        2.  Передать параметр `&dry_run=1` в URL запроса `complete` (если 1С это позволяет).
        В этом режиме файлы будут приняты и разложены по папкам, но задача в Celery запущена не будет.

## 2. Архитектура фоновой обработки (Celery)

Задача `process_1c_import_task` выполняет следующие действия:
1.  **Распаковка**: Если были переданы ZIP-архивы, они распаковываются в общую директорию `media/1c_import/`.
2.  **Подготовка**: Проверяется наличие всех необходимых подпапок (`goods`, `offers`, `prices` и т.д.), чтобы избежать ошибок валидации.
3.  **Запуск команды**: Вызывается management-команда `python manage.py import_products_from_1c`.
4.  **Логирование**: Все этапы пишутся в `ImportSession.report`.

## 3. Логика импорта (Management Command)

Команда `import_products_from_1c` использует `VariantImportProcessor` для пакетной обработки данных.

### Очередность обработки:
1.  **Категории (`groups.xml`)**: Создание дерева категорий.
2.  **Бренды (`propertiesGoods.xml`)**: Извлечение брендов из справочников 1С.
3.  **Типы цен (`priceLists.xml`)**: Маппинг типов цен 1С на роли пользователей (Розничная, Опт, Тренер).
4.  **Товары (`goods.xml`)**: Создание базовых карточек `Product` и загрузка основных изображений.
5.  **Варианты (`offers.xml`)**: Создание `ProductVariant` (размеры, цвета). Если вариантов нет, создается `default variant`.
6.  **Цены (`prices.xml`)**: Привязка цен к конкретным вариантам.
7.  **Остатки (`rests.xml`)**: Обновление остатков по складам для вариантов.

## 4. Ключевые особенности реализации

*   **Variant-Centric**: Разделение на `Product` (картинка, описание) и `ProductVariant` (артикул, цена, остаток, характеристика).
*   **Идентификация по GUID**: Вся синхронизация идет по уникальным идентификаторам 1С.
*   **Пакетная атомарность**: Транзакции фиксируются пачками (по 500 объектов), что предотвращает блокировки базы и перерасход оперативной памяти.
*   **Lazy Expiration**: Сессии импорта, «зависшие» в статусе `IN_PROGRESS` более 2 часов, автоматически помечаются как `FAILED`.

## 5. Директории данных

*   `media/1c_temp/`: Временное хранилище для текущих загрузок (очищается при `mode=init`).
*   `media/1c_import/`: Рабочая директория, откуда парсер берет файлы.
*   `media/products/`: Конечная папка для хранения изображений товаров.
