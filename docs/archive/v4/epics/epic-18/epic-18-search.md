# Эпик 18: Поиск — Brownfield Enhancement

**Дата создания:** 2025-12-21  
**Статус:** Готов к разработке  
**Приоритет:** P1 (высокий)  
**Длительность:** 2 недели  
**Зависимости:** Эпик 12 (компоненты фильтрации), Эпик 13 (карточки товаров)

---

## 1. Цель эпика

Реализовать полнофункциональный поиск товаров с интеграцией в Header (главная страница, все страницы) и каталог. Обеспечить быстрый поиск с автодополнением, фильтрацией результатов и качественным UX.

---

## 2. Контекст существующей системы

### Готовые компоненты (можно переиспользовать)

| Компонент | Файл | Статус |
|-----------|------|--------|
| **SearchField** | `src/components/ui/SearchField/SearchField.tsx` | ✅ Готов: debounce, autocomplete dropdown, валидация minLength |
| **productsService.search()** | `src/services/productsService.ts` | ✅ Готов: GET `/products/search/?q=query` |
| **useDebounce** | `src/hooks/useDebounce.ts` | ✅ Готов |
| **Backend Full-Text Search** | `backend/apps/products/filters.py` | ✅ PostgreSQL FTS с русской конфигурацией |

### Текущие ограничения

| Проблема | Решение в рамках эпика |
|----------|------------------------|
| Иконка поиска в Header неактивна | Story 18.1: Интеграция SearchField в Header |
| Нет страницы `/search` | Story 18.2: Создание страницы результатов |
| Нет истории поиска | Story 18.3: localStorage для истории |

---

## 3. Scope эпика

### В scope

- ✅ Интеграция SearchField в Header (desktop + mobile)
- ✅ Страница результатов поиска `/search?q=...`
- ✅ Автодополнение с товарами (live search)
- ✅ История поиска (localStorage, последние 10 запросов)
- ✅ Интеграция поиска в каталог (`/catalog?search=...`)
- ✅ Подсветка найденных терминов в результатах
- ✅ Фильтрация на странице результатов
- ✅ SSR для SEO страницы `/search`
- ✅ Unit и integration тесты

### Вне scope (можно добавить позже)

- ❌ Поисковые подсказки от backend (популярные запросы)
- ❌ Голосовой поиск
- ❌ Поиск по изображению
- ❌ Расширенный синтаксис поиска

---

## 4. User Stories

### Story 18.1: Интеграция поиска в Header

**Как** пользователь,  
**Я хочу** видеть поле поиска в шапке сайта,  
**Чтобы** быстро находить товары с любой страницы.

**Acceptance Criteria:**

- [ ] SearchField отображается в Header (desktop: inline, mobile: dropdown)
- [ ] Ввод запроса показывает autocomplete dropdown с товарами
- [ ] Клик по товару в dropdown → переход на страницу товара
- [ ] Enter или клик по иконке → переход на `/search?q=...`
- [ ] Поле поиска доступно при прокрутке (sticky header)

**Задачи:**

1. Модифицировать `Header.tsx` — заменить иконку на SearchField
2. Создать `SearchAutocomplete.tsx` — обёртка для live search
3. Добавить состояние открытия/закрытия для mobile
4. Написать unit-тесты для нового функционала

---

### Story 18.2: Страница результатов поиска

**Как** пользователь,  
**Я хочу** видеть страницу с результатами поиска,  
**Чтобы** просматривать все найденные товары.

**Acceptance Criteria:**

- [ ] Страница `/search` отображает результаты по query param `q`
- [ ] Заголовок показывает: "Результаты поиска: «запрос»"
- [ ] Отображается количество найденных товаров
- [ ] Товары показаны в grid-формате (переиспользуем ProductCard)
- [ ] Пагинация результатов (24 товара на страницу)
- [ ] SSR/SSG для SEO (meta title: "Поиск: {query}")
- [ ] Состояние "Ничего не найдено" с рекомендациями

**Задачи:**

1. Создать `app/search/page.tsx` — серверный компонент
2. Создать `SearchPageClient.tsx` — клиентская обёртка
3. Создать `SearchResults.tsx` — компонент списка результатов
4. Создать `EmptySearchResults.tsx` — состояние без результатов
5. Написать integration-тесты с MSW

---

### Story 18.3: История и автодополнение поиска

**Как** пользователь,  
**Я хочу** видеть историю своих поисковых запросов,  
**Чтобы** быстро повторять предыдущие поиски.

**Acceptance Criteria:**

- [ ] История хранится в localStorage (последние 10 запросов)
- [ ] При фокусе на пустом поле показывается история
- [ ] Клик по истории → выполняется поиск
- [ ] Кнопка очистки истории
- [ ] История сохраняется между сессиями

**Задачи:**

1. Создать `useSearchHistory` hook
2. Интегрировать историю в SearchField dropdown
3. Добавить UI для очистки истории
4. Написать unit-тесты для хука

---

### Story 18.4: Интеграция поиска в Каталог

**Как** пользователь,  
**Я хочу** использовать поиск на странице каталога,  
**Чтобы** находить товары в текущей категории.

**Acceptance Criteria:**

- [ ] Поле поиска на странице каталога (под хлебными крошками)
- [ ] Поиск фильтрует товары текущей категории
- [ ] URL обновляется: `/catalog/shoes?search=nike`
- [ ] Совместимость с существующими фильтрами
- [ ] Очистка поиска сбрасывает фильтр

**Задачи:**

1. Добавить SearchField в `CatalogPage`
2. Интегрировать параметр `search` в ProductFilters
3. Обновить URL без перезагрузки страницы
4. Написать integration-тесты

---

## 5. Требования к совместимости

- [x] Существующие API остаются неизменными
- [x] UI следует Design System v2.0
- [x] Performance: autocomplete < 300ms
- [x] Accessibility: WCAG 2.1 AA (aria-labels, keyboard nav)
- [x] Mobile-first: responsive на всех breakpoints

---

## 6. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Производительность autocomplete | Средняя | Высокое | Debounce 300ms, лимит 5 товаров в dropdown |
| Конфликт с мобильной навигацией | Низкая | Среднее | Отдельный UI для mobile (fullscreen search) |
| SEO для страницы поиска | Низкая | Среднее | SSR + canonical URL + noindex для пагинации |

---

## 7. Rollback Plan

1. Удалить SearchField из Header (простой откат)
2. Удалить страницу `/search` (без влияния на другие страницы)
3. Удалить параметр `search` из каталога

---

## 8. Definition of Done

- [ ] Все 4 stories реализованы и прошли code review
- [ ] Unit-тесты: покрытие 80%+
- [ ] Integration-тесты с MSW для API
- [ ] E2E тест: поиск → результаты → клик на товар
- [ ] Адаптивность проверена на mobile/tablet/desktop
- [ ] Accessibility проверена (keyboard, screen reader)
- [ ] PageSpeed Score > 70

---

## 9. Документы для разработки

| Документ | Назначение |
|----------|------------|
| `docs/frontend/design-system.json` | Стили SearchField, Cards |
| `docs/api-spec.yaml` | Эндпоинт `/products/?search=` |
| `frontend/docs/testing-standards.md` | Рекомендации по тестам |
| `src/components/ui/SearchField/` | Существующий компонент |
| `src/services/productsService.ts` | API методы для поиска |

---

## 10. Story Manager Handoff

> **Для Scrum Master:**
>
> Эпик готов к декомпозиции на истории. Ключевые особенности:
>
> - **Технологии:** Next.js 15, React 19, Zustand, Tailwind CSS
> - **Существующие компоненты:** SearchField, productsService.search()
> - **Интеграции:** Header.tsx, CatalogPage, ProductCard
> - **Критические требования:** Performance (< 300ms), Accessibility (WCAG 2.1)
> - **Каждая story должна включать:** проверку регрессии существующего функционала
