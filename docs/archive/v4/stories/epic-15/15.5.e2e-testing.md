# Story 15.5: E2E тестирование упрощённого флоу

## Status

Ready for Review

## Story

**As a** разработчик платформы FREESPORT,
**I want** реализовать E2E тесты для критического пользовательского флоу checkout,
**so that** мы можем гарантировать, что процесс оформления заказа работает корректно от начала до конца.

## Acceptance Criteria

1. ✅ E2E тест: переход из корзины в checkout
2. ✅ E2E тест: заполнение контактных данных
3. ✅ E2E тест: заполнение адреса доставки
4. ✅ E2E тест: выбор способа доставки
5. ✅ E2E тест: оформление заказа
6. ✅ E2E тест: отображение страницы успеха с номером заказа
7. ✅ Playwright конфигурация настроена
8. ✅ CI/CD интеграция (опционально)

## Tasks / Subtasks

### Задача 1: Настройка Playwright (AC: 7)

- [x] Установить Playwright: `npm install -D @playwright/test`
- [x] Инициализировать конфиг: `npx playwright install`
- [x] Создать `playwright.config.ts`:

  ```typescript
  import { defineConfig, devices } from '@playwright/test'

  export default defineConfig({
    testDir: './tests/e2e',
    fullyParallel: true,
    forbidOnly: !!process.env.CI,
    retries: process.env.CI ? 2 : 0,
    workers: process.env.CI ? 1 : undefined,
    reporter: 'html',

    use: {
      baseURL: 'http://localhost:3000',
      trace: 'on-first-retry',
    },

    projects: [
      { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
      { name: 'firefox', use: { ...devices['Desktop Firefox'] } },
      { name: 'webkit', use: { ...devices['Desktop Safari'] } },
    ],

    webServer: {
      command: 'npm run dev',
      url: 'http://localhost:3000',
      reuseExistingServer: !process.env.CI,
    },
  })
  ```

### Задача 2: E2E тест - Базовый checkout флоу (AC: 1-6)

- [x] Создать `tests/e2e/checkout.spec.ts`
- [x] Тест: полный флоу от корзины до success

  ```typescript
  test('complete checkout flow from cart to success', async ({ page }) => {
    // 1. Добавить товар в корзину
    await page.goto('/catalog')
    await page.click('[data-testid="add-to-cart-button"]:first-child')
    await page.click('[data-testid="cart-icon"]')
    await expect(page.locator('[data-testid="cart-item"]')).toBeVisible()

    // 2. Перейти к checkout
    await page.click('[data-testid="checkout-button"]')
    await expect(page).toHaveURL(/\/checkout/)

    // 3. Заполнить контактные данные
    await page.fill('[name="email"]', 'test@example.com')
    await page.fill('[name="phone"]', '+79001234567')
    await page.fill('[name="firstName"]', 'Иван')
    await page.fill('[name="lastName"]', 'Петров')

    // 4. Заполнить адрес доставки
    await page.fill('[name="city"]', 'Москва')
    await page.fill('[name="street"]', 'Ленина')
    await page.fill('[name="house"]', '10')
    await page.fill('[name="apartment"]', '5')
    await page.fill('[name="postalCode"]', '123456')

    // 5. Выбрать способ доставки
    await page.click('[value="courier"]')

    // 6. Оформить заказ
    await page.click('[type="submit"]')

    // 7. Проверить success страницу
    await expect(page).toHaveURL(/\/checkout\/success/)
    await expect(page.locator('text=Заказ успешно оформлен')).toBeVisible()
    await expect(page.locator('[data-testid="order-number"]')).toBeVisible()
  })
  ```

### Задача 3: E2E тест - Валидация формы (AC: 2, 3)

- [x] Тест: пустые обязательные поля показывают ошибки

  ```typescript
  test('shows validation errors for empty required fields', async ({ page }) => {
    await page.goto('/checkout')
    await page.click('[type="submit"]')

    await expect(page.locator('text=Email обязателен')).toBeVisible()
    await expect(page.locator('text=Формат: +7XXXXXXXXXX')).toBeVisible()
    await expect(page.locator('text=Минимум 2 символа')).toBeVisible()
  })
  ```

### Задача 4: E2E тест - Автозаполнение для авторизованных (AC: 2, 3)

- [x] Тест: авторизованный пользователь видит автозаполненные поля

  ```typescript
  test('autofills fields for authenticated users', async ({ page }) => {
    // Логин
    await page.goto('/login')
    await page.fill('[name="email"]', 'user@example.com')
    await page.fill('[name="password"]', 'password123')
    await page.click('[type="submit"]')

    // Переход на checkout
    await page.goto('/checkout')

    // Проверка автозаполнения
    await expect(page.locator('[name="email"]')).toHaveValue('user@example.com')
    await expect(page.locator('[name="firstName"]')).toHaveValue(/\w+/)
  })
  ```

### Задача 5: E2E тест - Обработка ошибок (AC: 5)

- [x] Тест: ошибка API показывается пользователю

  ```typescript
  test('shows error message when order creation fails', async ({ page }) => {
    // Mock API error
    await page.route('**/api/v1/orders/', (route) =>
      route.fulfill({
        status: 500,
        body: JSON.stringify({ error: 'Server error' })
      })
    )

    // Заполнить и отправить форму
    // ...

    // Проверить ошибку
    await expect(page.locator('text=Ошибка создания заказа')).toBeVisible()
  })
  ```

### Задача 6: CI/CD интеграция (AC: 8 - опционально)

- [x] Создать `.github/workflows/e2e-tests.yml`:

  ```yaml
  name: E2E Tests

  on:
    push:
      branches: [develop, main]
    pull_request:
      branches: [develop, main]

  jobs:
    e2e-tests:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - uses: actions/setup-node@v3
          with:
            node-version: 18

        - name: Install dependencies
          run: npm ci

        - name: Install Playwright browsers
          run: npx playwright install --with-deps

        - name: Run E2E tests
          run: npm run test:e2e

        - uses: actions/upload-artifact@v3
          if: always()
          with:
            name: playwright-report
            path: playwright-report/
  ```

### Задача 7: Page Object Model (опционально)

- [x] Создать `tests/e2e/pages/CheckoutPage.ts`:

  ```typescript
  export class CheckoutPage {
    constructor(private page: Page) {}

    async fillContactInfo(data: ContactInfo) {
      await this.page.fill('[name="email"]', data.email)
      await this.page.fill('[name="phone"]', data.phone)
      await this.page.fill('[name="firstName"]', data.firstName)
      await this.page.fill('[name="lastName"]', data.lastName)
    }

    async fillAddress(data: Address) {
      await this.page.fill('[name="city"]', data.city)
      await this.page.fill('[name="street"]', data.street)
      await this.page.fill('[name="house"]', data.house)
      await this.page.fill('[name="postalCode"]', data.postalCode)
    }

    async selectDeliveryMethod(methodId: string) {
      await this.page.click(`[value="${methodId}"]`)
    }

    async submitOrder() {
      await this.page.click('[type="submit"]')
    }
  }
  ```

### Задача 8: Документация (AC: 7)

- [x] Обновить `frontend/README.md` с инструкциями по E2E тестам:

  ```markdown
  ## E2E Тестирование

  ### Запуск локально
  ```bash
  npm run test:e2e              # Запуск всех E2E тестов
  npm run test:e2e -- --headed  # С визуальным браузером
  npm run test:e2e -- --debug   # Режим отладки
  ```

  ### Отчёты

  ```bash
  npx playwright show-report    # Открыть HTML отчёт
  ```

  ```

## Dev Notes

### Playwright Best Practices

**Селекторы:**

- Использовать `data-testid` для стабильности
- Избегать селекторов по тексту (может меняться)
- Использовать `role` селекторы для accessibility

**Ожидания:**

- Всегда использовать `await expect()` вместо `toBe()`
- Playwright автоматически ожидает появления элементов

**Изоляция:**

- Каждый тест должен быть независимым
- Использовать `beforeEach` для сброса состояния

[Source: architecture/10-testing-strategy.md#E2E Tests]

### Структура файлов

```
frontend/
├── playwright.config.ts              # [NEW] Конфиг Playwright
├── tests/
│   └── e2e/
│       ├── checkout.spec.ts          # [NEW] E2E тесты checkout
│       └── pages/
│           └── CheckoutPage.ts       # [NEW] Page Object (опционально)
└── .github/
    └── workflows/
        └── e2e-tests.yml             # [NEW] CI/CD (опционально)
```

### Зависимости

- **Зависит от:** Story 15.1 (CheckoutForm)
- **Зависит от:** Story 15.2 (Orders API)
- **Зависит от:** Story 15.3a/b (Delivery)
- **Зависит от:** Story 15.4 (Success Page)
- **Блокирует:** Ничего (финальная история эпика)

### Конфигурация package.json

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug"
  },
  "devDependencies": {
    "@playwright/test": "^1.40.0"
  }
}
```

## Change Log

| Date       | Version | Description                          | Author         |
|------------|---------|--------------------------------------|----------------|
| 2025-12-14 | 1.0.0   | Создание story для E2E тестирования  | Bob (SM Agent) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (Cascade)

### Debug Log References

Нет debug логов - реализация прошла без проблем.

### Completion Notes

- **Задача 1**: Установлен Playwright, создан `playwright.config.ts` с настройками для Chromium
- **Задача 2**: Создан `checkout.spec.ts` с полным E2E тестом checkout флоу (AC1-6)
- **Задача 3**: Добавлены тесты валидации формы (пустые поля, email, телефон, индекс)
- **Задача 4**: Добавлен тест автозаполнения для авторизованных пользователей
- **Задача 5**: Добавлены тесты обработки ошибок API (500, 400, network error)
- **Задача 6**: Создан `.github/workflows/e2e-tests.yml` для CI/CD
- **Задача 7**: Создан `CheckoutPage.ts` с Page Object Model
- **Задача 8**: Обновлён `frontend/README.md` с документацией по E2E тестам

### File List

**Созданные файлы:**
- `frontend/playwright.config.ts` - конфигурация Playwright
- `frontend/tests/e2e/checkout.spec.ts` - E2E тесты checkout флоу
- `frontend/tests/e2e/pages/CheckoutPage.ts` - Page Object Model
- `.github/workflows/e2e-tests.yml` - CI/CD workflow

**Модифицированные файлы:**
- `frontend/package.json` - добавлены E2E скрипты
- `frontend/README.md` - добавлена документация E2E тестирования

## QA Results

_(Заполняется QA агентом после проверки)_
