# Story 27.2: Unify Image Path Normalization

## Status

ready to review

---

## Story

**As a** developer,  
**I want** all image import methods to use `normalize_image_path()`,  
**so that** paths are handled consistently across all import scenarios.

---

## Acceptance Criteria

1. Функция `normalize_image_path()` используется в `_import_base_images()`
2. Функция `normalize_image_path()` используется в `_import_variant_images()`
3. Legacy метод `_import_base_images_simple()` в processor.py помечен как deprecated или удалён
4. Тесты подтверждают корректную обработку путей вида `import_files/xx/file.jpg` и `xx/file.jpg`

---

## Tasks / Subtasks

- [x] **Task 1: Верификация текущего состояния** (AC: 1, 2)
  - [x] 1.1 Проверить что `_import_base_images()` в variant_import.py использует `normalize_image_path()` ✅ (L528)
  - [x] 1.2 Проверить что `_import_variant_images()` в variant_import.py использует `normalize_image_path()` ✅ (L795)
  - [x] 1.3 Документировать текущее состояние

- [x] **Task 2: Анализ legacy метода** (AC: 3)
  - [x] 2.1 Изучить `_import_base_images_simple()` в processor.py (L617-700)
  - [x] 2.2 Определить все места вызова этого метода (L167, L292)
  - [x] 2.3 Проверить что legacy метод НЕ использует `normalize_image_path()` ✅

- [x] **Task 3: Добавить deprecation warning в legacy метод** (AC: 3)
  - [x] 3.1 Добавить `warnings.warn()` с `PendingDeprecationWarning` в начало `_import_base_images_simple()`
  - [x] 3.2 Добавить docstring note о deprecated статусе
  - [x] 3.3 Указать альтернативу: `VariantImportProcessor._import_base_images()`

- [x] **Task 4: Unit-тесты для normalize_image_path()** (AC: 4)
  - [x] 4.1 Тест: путь с `import_files/` prefix → возвращает путь без prefix
  - [x] 4.2 Тест: путь без `import_files/` prefix → возвращает путь без изменений
  - [x] 4.3 Тест: edge cases (пустая строка, только файл, глубокий путь, кириллица, UUID)

- [x] **Task 5: Integration тесты импорта изображений** (AC: 4)
  - [x] 5.1 Тест: импорт изображения с путём `import_files/xx/file.jpg`
  - [x] 5.2 Тест: импорт изображения с путём `xx/file.jpg`
  - [x] 5.3 Тест: оба формата путей → одинаковый результат в media storage

---

## Dev Notes

### Existing System Integration

- **Primary file:** `backend/apps/products/services/variant_import.py`
- **Legacy file:** `backend/apps/products/services/processor.py`
- **Technology:** Django 4.2, default_storage (media files)

### Current State Analysis

#### `normalize_image_path()` Function (L182-197)

```python
def normalize_image_path(image_path: str) -> str:
    """
    Нормализация пути к изображению.
    
    Убирает префикс 'import_files/' если присутствует, чтобы обеспечить
    единый стандарт путей между XML-импортом и импортом через админку.
    """
    if image_path.startswith("import_files/"):
        return image_path[len("import_files/"):]
    return image_path
```

#### Usage in `_import_base_images()` (variant_import.py L505)

```python
# Нормализация пути (убираем import_files/ если есть)
normalized_path = normalize_image_path(image_path)  # ✅ ИСПОЛЬЗУЕТСЯ
source_path = Path(base_dir) / normalized_path
```

#### Usage in `_import_variant_images()` (variant_import.py L769)

```python
# Нормализация пути (убираем import_files/ если есть)
normalized_path = normalize_image_path(image_path)  # ✅ ИСПОЛЬЗУЕТСЯ
source_path = Path(base_dir) / normalized_path
```

#### Problem in Legacy `_import_base_images_simple()` (processor.py L649)

```python
source_path = Path(base_dir) / image_path  # ❌ НЕ нормализует путь!
```

**Проблема:** Если путь содержит `import_files/xx/file.jpg`, legacy метод ищет файл по пути `{base_dir}/import_files/xx/file.jpg` вместо `{base_dir}/xx/file.jpg`.

### Deprecation Warning Implementation

```python
import warnings

def _import_base_images_simple(
    self,
    product: Product,
    image_paths: list[str],
    base_dir: str,
) -> None:
    """
    DEPRECATED: Use VariantImportProcessor._import_base_images() instead.
    
    This method does not normalize image paths and may fail with paths
    containing 'import_files/' prefix.
    """
    warnings.warn(
        "_import_base_images_simple() is deprecated. "
        "Use VariantImportProcessor._import_base_images() instead.",
        DeprecationWarning,
        stacklevel=2,
    )
    # ... existing code ...
```

### Files Reference

| Файл | Роль | Статус |
|------|------|--------|
| `variant_import.py` L182-197 | `normalize_image_path()` | ✅ Готов |
| `variant_import.py` L479-523 | `_import_base_images()` | ✅ Использует normalize |
| `variant_import.py` L747-789 | `_import_variant_images()` | ✅ Использует normalize |
| `processor.py` L617-700 | `_import_base_images_simple()` | ⚠️ НЕ использует normalize |

---

## Testing

### Test Location

`backend/apps/products/tests/unit/test_image_normalization.py` (новый файл)

### Testing Standards

- **Framework:** pytest с markers `@pytest.mark.unit`
- **Coverage:** >= 90% для `normalize_image_path()`

### Test Cases

#### `normalize_image_path()` Tests

```python
import pytest
from apps.products.services.variant_import import normalize_image_path


@pytest.mark.unit
class TestNormalizeImagePath:
    """Тесты для normalize_image_path() (AC4)"""
    
    def test_removes_import_files_prefix(self):
        """Путь с import_files/ → возвращает путь без prefix"""
        assert normalize_image_path("import_files/xx/file.jpg") == "xx/file.jpg"
        
    def test_preserves_path_without_prefix(self):
        """Путь без import_files/ → возвращает путь без изменений"""
        assert normalize_image_path("xx/file.jpg") == "xx/file.jpg"
        
    def test_empty_string(self):
        """Пустая строка → пустая строка"""
        assert normalize_image_path("") == ""
        
    def test_only_filename(self):
        """Только имя файла без директорий"""
        assert normalize_image_path("file.jpg") == "file.jpg"
        
    def test_deep_path_with_prefix(self):
        """Глубокий путь с import_files/ prefix"""
        result = normalize_image_path("import_files/a/b/c/file.jpg")
        assert result == "a/b/c/file.jpg"
        
    def test_import_files_in_middle_not_removed(self):
        """import_files в середине пути НЕ удаляется"""
        result = normalize_image_path("xx/import_files/file.jpg")
        assert result == "xx/import_files/file.jpg"
```

#### Integration Tests for Image Import

```python
import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock
from apps.products.services.variant_import import VariantImportProcessor


@pytest.mark.integration
class TestImageImportWithNormalization:
    """Integration тесты импорта изображений с разными форматами путей"""
    
    @pytest.fixture
    def processor(self, import_session):
        return VariantImportProcessor(session_id=import_session.id)
    
    @pytest.fixture
    def temp_import_dir(self, tmp_path):
        """Создаёт временную структуру директорий импорта"""
        images_dir = tmp_path / "xx"
        images_dir.mkdir(parents=True)
        
        # Создаём тестовое изображение
        test_image = images_dir / "test.jpg"
        test_image.write_bytes(b"fake image data")
        
        return tmp_path
    
    def test_import_with_import_files_prefix(self, processor, product, temp_import_dir):
        """Импорт с путём import_files/xx/test.jpg"""
        image_paths = ["import_files/xx/test.jpg"]
        
        with patch("apps.products.services.variant_import.default_storage") as mock_storage:
            mock_storage.exists.return_value = False
            mock_storage.save.return_value = "base/xx/test.jpg"
            
            processor._import_base_images(product, image_paths, str(temp_import_dir))
            
            # Проверяем что файл был найден по нормализованному пути
            assert "xx/test.jpg" not in str(mock_storage.save.call_args)
    
    def test_import_without_prefix(self, processor, product, temp_import_dir):
        """Импорт с путём xx/test.jpg (без prefix)"""
        image_paths = ["xx/test.jpg"]
        
        with patch("apps.products.services.variant_import.default_storage") as mock_storage:
            mock_storage.exists.return_value = False
            mock_storage.save.return_value = "base/xx/test.jpg"
            
            processor._import_base_images(product, image_paths, str(temp_import_dir))
            
            # Проверяем что импорт прошёл успешно
            mock_storage.save.assert_called()
```

### Run Commands

```bash
# Unit-тесты для normalize_image_path
pytest backend/apps/products/tests/unit/test_image_normalization.py -v -m unit

# Integration тесты
pytest backend/apps/products/tests/integration/test_image_import.py -v -m integration

# С покрытием
pytest backend/apps/products/tests/ -k "image" --cov=apps.products.services.variant_import --cov-report=term-missing
```

---

## Risk Assessment

### Primary Risk

Изменение deprecation warning может вызвать warnings в production логах

### Mitigation

- Добавить warning только в development/test environments
- Или использовать `PendingDeprecationWarning` (не показывается по умолчанию)

### Rollback

Убрать deprecation warning из legacy метода

---

## Definition of Done

- [x] Подтверждено что `_import_base_images()` использует `normalize_image_path()` ✅
- [x] Подтверждено что `_import_variant_images()` использует `normalize_image_path()` ✅  
- [x] Legacy метод `_import_base_images_simple()` помечен как deprecated
- [x] Unit-тесты для `normalize_image_path()` написаны и проходят (14 тестов)
- [x] Integration тесты для обоих форматов путей написаны и проходят (7 тестов)
- [x] Все 21 тест проходят успешно
- [x] Код соответствует coding standards

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-09 | 1.0 | Initial story draft | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Gemini 2.5 Pro (James - Full Stack Developer)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes List

1. **Верификация**: Подтверждено использование `normalize_image_path()` в `variant_import.py` (L528, L795)
2. **Анализ legacy**: Legacy метод `_import_base_images_simple()` в `processor.py` НЕ использует нормализацию (вызывается на L167, L292)
3. **Deprecation**: Добавлен `PendingDeprecationWarning` (не показывается в production по умолчанию) + обновлён docstring
4. **Unit тесты**: 14 тестов покрывают все edge cases включая кириллицу и UUID
5. **Integration тесты**: 7 тестов проверяют оба формата путей

### File List

| File | Action | Description |
|------|--------|-------------|
| `backend/apps/products/services/processor.py` | MODIFIED | Added `import warnings`, deprecation warning and updated docstring for `_import_base_images_simple()` |
| `backend/apps/products/tests/unit/test_image_normalization.py` | NEW | 14 unit tests for `normalize_image_path()` |
| `backend/apps/products/tests/integration/__init__.py` | NEW | Init file for integration tests |
| `backend/apps/products/tests/integration/test_image_import.py` | NEW | 7 integration tests for image import with path normalization |

---

## QA Results

_To be filled by QA agent_
