# Story 14.4: Link Attributes to Products & Variants

## Status

Ready for Done

## Story

**As a** User,
**I want** products to have detailed specifications linked to them,
**so that** the data is structured and accurate.

## Dependencies

- [Story 14.2: Import Attributes from 1C](./14.2.import-attributes.md)
- [Story 14.3: Attribute Deduplication](./14.3.attribute-deduplication.md) (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ —ç—Ç–æ–π story)
- [PRD: 1C Properties Integration](../../prd/brownfield-1c-properties.md)

## Acceptance Criteria

1. –û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä—Å–µ—Ä `goods.xml`: –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `Product` —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–≤—è–∑–∏ —Å `AttributeValue`.
2. –û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä—Å–µ—Ä `offers.xml`: –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ `ProductVariant` —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–≤—è–∑–∏ —Å `AttributeValue`.
3. –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ –≤ —Ç–æ–≤–∞—Ä–µ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Å–æ–∑–¥–∞–Ω–∏–µ on-the-fly –∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏).

## Tasks / Subtasks

- [x] **Task 1: Parse product attributes from goods.xml**
  - [x] Add `PropertyValueData` TypedDict to `parser.py`
  - [x] Update `GoodsData` TypedDict with `property_values` field
  - [x] Implement parsing of `<–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤>` in `parse_goods_xml()`
  - [x] Filter out empty GUID values (`00000000-0000-0000-0000-000000000000`)
- [x] **Task 2: Link attributes to Product**
  - [x] Add imports for `Attribute1CMapping`, `AttributeValue1CMapping` in `processor.py`
  - [x] Implement `_link_product_attributes()` method
  - [x] Lookup `AttributeValue` via `AttributeValue1CMapping.onec_id`
  - [x] Use `select_related()` for query optimization
  - [x] Call `_link_product_attributes()` in `create_product_placeholder()`
  - [x] Update stats tracking (attributes_linked, attributes_missing_mapping)
- [x] **Task 3: Link attributes to ProductVariant**
  - [x] Implement `_link_variant_attributes()` method
  - [x] Search `Attribute` by `normalized_name` (NO is_active filter)
  - [x] Search `AttributeValue` by `attribute` + `normalized_value`
  - [x] Create `AttributeValue` on-the-fly if missing (AC3)
  - [x] Handle slug uniqueness for on-the-fly values
  - [x] Call `_link_variant_attributes()` in `process_variant_from_offer()`
- [x] **Task 4: Testing**
  - [x] Create `test_import_linking.py` with pytest integration tests
  - [x] Test: link attributes via onec_id mapping (goods.xml)
  - [x] Test: skip empty GUID values
  - [x] Test: link inactive attributes (Variant C - no filtering in import)
  - [x] Test: link variant attributes by normalized name/value
  - [x] Test: create AttributeValue on-the-fly
  - [x] Test: missing attribute logging
  - [x] Achieve >85% coverage for new methods

## Dev Notes

### Architecture Decision: Variant C (Hybrid Approach)

**Import Layer Strategy:**

- Import layer (processor.py) links **ALL** attributes to Product/ProductVariant (both active and inactive)
- NO filtering by `is_active` during import
- Create AttributeValue on-the-fly for offers.xml if needed

**API Layer Strategy (Story 14.5):**

- Filtering by `is_active=True` happens in Serializers
- Administrators control visibility through Django Admin

**Rationale:**

- ‚úÖ Full data completeness in database
- ‚úÖ Flexibility to activate/deactivate attributes without re-import
- ‚úÖ Aligns with Story 14.3.6 AC1-2: "ProductSerializer filters attributes with is_active=True"
- ‚úÖ Separation of concerns: Import = data integrity, API = business logic

### Integration Notes

- **Integration:** This story modifies the existing import logic in `ProductDataProcessor` and `XMLDataParser`.
- **Compatibility:** Ensure `specifications` JSON field is preserved if needed for backward compatibility (CR1 from PRD).
- **Data Mapping:**
  - goods.xml: Resolve IDs via `AttributeValue1CMapping.onec_id` lookup
  - offers.xml: Resolve by `Attribute.normalized_name` + `AttributeValue.normalized_value`
  - Story 14.2 must be completed (Attribute/AttributeValue models exist)
  - Story 14.3 models required: Attribute1CMapping, AttributeValue1CMapping

### Key Differences: goods.xml vs offers.xml

**goods.xml (Products):**

```xml
<–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤–∞>
  <–ò–¥>PROPERTY_GUID</–ò–¥>           <!-- Attribute onec_id -->
  <–ó–Ω–∞—á–µ–Ω–∏–µ>VALUE_GUID</–ó–Ω–∞—á–µ–Ω–∏–µ>   <!-- AttributeValue onec_id -->
</–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤–∞>
```

- Lookup: `AttributeValue1CMapping.objects.get(onec_id=VALUE_GUID)`
- If not found: Log warning, skip

**offers.xml (ProductVariants):**

```xml
<–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–¢–æ–≤–∞—Ä–∞>
  <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–†–∞–∑–º–µ—Ä</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>  <!-- Attribute name (text) -->
  <–ó–Ω–∞—á–µ–Ω–∏–µ>42</–ó–Ω–∞—á–µ–Ω–∏–µ>              <!-- AttributeValue value (text) -->
</–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–¢–æ–≤–∞—Ä–∞>
```

- Lookup: `Attribute.objects.get(normalized_name=normalize_attribute_name("–†–∞–∑–º–µ—Ä"))`
- Then: `AttributeValue.objects.get(attribute=attr, normalized_value=normalize_attribute_value("42"))`
- If not found: Create on-the-fly (AC3)

### XML Structure Examples

**goods.xml** (Product Attributes):

```xml
<–¢–æ–≤–∞—Ä>
  <–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤>
    <–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤–∞>
      <–ò–¥>PROPERTY_GUID_HERE</–ò–¥>
      <–ó–Ω–∞—á–µ–Ω–∏–µ>VALUE_GUID_HERE</–ó–Ω–∞—á–µ–Ω–∏–µ>
    </–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤–∞>
  </–ó–Ω–∞—á–µ–Ω–∏—è–°–≤–æ–π—Å—Ç–≤>
</–¢–æ–≤–∞—Ä>
```

**offers.xml** (Variant Attributes):

```xml
<–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
  <–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏–¢–æ–≤–∞—Ä–∞>
    <–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–¢–æ–≤–∞—Ä–∞>
      <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>Property Name</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
      <–ó–Ω–∞—á–µ–Ω–∏–µ>Property Value (or GUID)</–ó–Ω–∞—á–µ–Ω–∏–µ>
    </–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–¢–æ–≤–∞—Ä–∞>
  </–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏–¢–æ–≤–∞—Ä–∞>
</–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
```

## Testing

- **Location:** `backend/apps/products/tests/test_import_linking.py` (new file)
- **Standards:**
  - Use `pytest` with `@pytest.mark.integration` and `@pytest.mark.django_db`
  - Use `get_unique_suffix()` from `backend/tests/utils.py` for test data isolation
  - Use Factory Boy for creating test data
  - Coverage target: >85% for new methods
- **Test Cases:**
  1. **test_link_attributes_to_product_via_onec_mapping()** - Link attributes via goods.xml GUID mappings
  2. **test_skip_empty_guid_values()** - Skip `00000000-0000-0000-0000-000000000000` values
  3. **test_link_inactive_attribute_to_product()** - Verify inactive attributes ARE linked (Variant C)
  4. **test_link_variant_attributes_by_normalized_name()** - Link variant attributes by name/value
  5. **test_create_attribute_value_on_the_fly()** - Create missing AttributeValue for variants
  6. **test_missing_attribute_logging()** - Log warnings for missing attributes
  7. **test_attribute_linking_statistics()** - Verify stats tracking (attributes_linked, attributes_missing_mapping)

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Added dependencies, XML examples, and fixed file paths | Bob (SM) |
| 2025-12-05 | 2.0 | Detailed implementation plan, Variant C architecture, expanded tasks and testing | James (Dev) |

## Dev Agent Record

### Agent Model Used

- Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

- ‚úÖ All tasks completed successfully with comprehensive test coverage
- ‚úÖ Attribute linking implemented for both Product (via onec_id mapping) and ProductVariant (via normalized name/value)
- ‚úÖ Fixed legacy code issue: removed `retail_price` and `main_image` from Product creation (moved to ProductVariant)
- ‚úÖ All integration tests passing (9/9)
- ‚úÖ Statistics tracking added for attributes_linked and attributes_missing_mapping

### File List

- [backend/apps/products/services/parser.py](backend/apps/products/services/parser.py) - Modified (added PropertyValueData TypedDict, updated GoodsData, implemented property parsing)
- [backend/apps/products/services/processor.py](backend/apps/products/services/processor.py) - Modified (added _link_product_attributes method, updated stats, fixed Product creation)
- [backend/apps/products/services/variant_import.py](backend/apps/products/services/variant_import.py) - Modified (added _link_variant_attributes method, updated stats)
- [backend/apps/products/tests/test_import_linking.py](backend/apps/products/tests/test_import_linking.py) - Created (comprehensive integration tests)

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Score: 95/100 - EXCELLENT**

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è Story 14.4 –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å –ø–æ–ª–Ω—ã–º —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞. –ö–æ–¥ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:

‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥—Å—Ç–≤–æ:**
- –ò–¥–µ–∞–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ Variant C (Hybrid Approach) –∏–∑ Story 14.3
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏: Import Layer (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏) vs API Layer (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ batch lookups —á–µ—Ä–µ–∑ select_related() –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**
- –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è —Å `from __future__ import annotations` –∏ TYPE_CHECKING
- –ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ —Å Args/Returns/Behavior —Å–µ–∫—Ü–∏—è–º–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ edge cases (empty GUIDs, missing mappings, slug uniqueness)

‚úÖ **–¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:**
- 9 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç get_unique_suffix() –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∫ goods.xml (onec_id mapping), —Ç–∞–∫ –∏ offers.xml (normalized name/value)
- –í–∞–ª–∏–¥–∞—Ü–∏—è Variant C (NO is_active filtering –≤ Import Layer)

‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
- On-the-fly —Å–æ–∑–¥–∞–Ω–∏–µ AttributeValue –¥–ª—è offers.xml (AC3)
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ slug uniqueness —Å counter –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ (attributes_linked, attributes_missing_mapping)

### Requirements Traceability

**AC1: –û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä—Å–µ—Ä goods.xml** ‚úÖ
- **Given:** GoodsData —Å–æ–¥–µ—Ä–∂–∏—Ç property_values —Å property_id –∏ value_id
- **When:** create_product_placeholder() –≤—ã–∑—ã–≤–∞–µ—Ç _link_product_attributes()
- **Then:** AttributeValue —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AttributeValue1CMapping.onec_id
- **Tests:**
  - test_link_attributes_to_product_via_onec_mapping (parser.py:246-280, processor.py:377-427)
  - test_skip_empty_guid_values (parser.py:268-277)
  - test_attribute_linking_statistics (processor.py:377-427)

**AC2: –û–±–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä—Å–µ—Ä offers.xml** ‚úÖ
- **Given:** OfferData —Å–æ–¥–µ—Ä–∂–∏—Ç characteristics —Å name/value —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
- **When:** process_variant_from_offer() –≤—ã–∑—ã–≤–∞–µ—Ç _link_variant_attributes()
- **Then:** AttributeValue —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ normalized_name + normalized_value
- **Tests:**
  - test_link_variant_attributes_by_normalized_name (variant_import.py:982-1079)
  - test_missing_attribute_logging_variant (variant_import.py:1027-1032)

**AC3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π** ‚úÖ
- **Given:** –ê—Ç—Ä–∏–±—É—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ AttributeValue –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î
- **When:** _link_variant_attributes() –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ normalized_value
- **Then:** AttributeValue —Å–æ–∑–¥–∞–µ—Ç—Å—è on-the-fly —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º slug
- **Tests:**
  - test_create_attribute_value_on_the_fly (variant_import.py:1041-1073)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ slug uniqueness —Å counter –º–µ—Ö–∞–Ω–∏–∑–º–æ–º (variant_import.py:1055-1059)

**Variant C Architecture Validation** ‚úÖ
- **Given:** Attribute –∏–ª–∏ AttributeValue –∏–º–µ–µ—Ç is_active=False
- **When:** Import layer –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ XML
- **Then:** –ê—Ç—Ä–∏–±—É—Ç—ã —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ is_active
- **Tests:**
  - test_link_inactive_attribute_to_product (processor.py:377-427)
  - test_link_inactive_attribute_to_variant (variant_import.py:982-1079)

### Compliance Check

- ‚úÖ **Coding Standards:** –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è, docstrings, Black formatting
- ‚úÖ **Project Structure:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ services/ –∏ tests/
- ‚úÖ **Testing Strategy:** Integration tests —Å pytest-django, –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ get_unique_suffix()
- ‚úÖ **All ACs Met:** 3/3 AC –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏

### NFR Validation

**Security:** ‚úÖ PASS
- –ù–µ—Ç SQL injection —Ä–∏—Å–∫–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ORM)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø—É—Å—Ç—ã–µ GUID —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è)
- –ù–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –ª–æ–≥–∏–∫–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è

**Performance:** ‚úÖ PASS
- Batch lookup —á–µ—Ä–µ–∑ select_related() –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- Bulk operations —á–µ—Ä–µ–∑ .set() –≤–º–µ—Å—Ç–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö .add()
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (onec_id__in, normalized_name lookup)
- Stats tracking –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**Reliability:** ‚úÖ PASS
- Exception handling —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º (try/except –±–ª–æ–∫–∏)
- Graceful degradation –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –º–∞–ø–ø–∏–Ω–≥–æ–≤ (warning + skip)
- Idempotent –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∏–º–ø–æ—Ä—Ç –±–µ–∑–æ–ø–∞—Å–µ–Ω)

**Maintainability:** ‚úÖ PASS
- –û—Ç–ª–∏—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤
- –ß–∏—Ç–∞–µ–º—ã–π –∫–æ–¥ —Å –≥–æ–≤–æ—Ä—è—â–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- Separation of concerns (parser ‚Üí processor/variant_import)
- –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### Test Architecture Assessment

**Coverage:** –û—Ç–ª–∏—á–Ω–æ (9 integration tests)
- ‚úÖ Happy path scenarios (valid mappings, successful linking)
- ‚úÖ Edge cases (empty GUIDs, missing mappings, inactive attributes)
- ‚úÖ On-the-fly creation (AC3)
- ‚úÖ Statistics tracking validation

**Test Design:** –ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ get_unique_suffix() –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
- ‚úÖ Fixture setup –≤ setUp() –º–µ—Ç–æ–¥–∞—Ö
- ‚úÖ Clear Given-When-Then structure
- ‚úÖ Assertions –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è

**Test Data Management:** –û—Ç–ª–∏—á–Ω–æ
- ‚úÖ Factory pattern —á–µ—Ä–µ–∑ explicit —Å–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- ‚úÖ Realistic data (UUID –¥–ª—è onec_id, cyrillics –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏–π)
- ‚úÖ Proper cleanup —á–µ—Ä–µ–∑ pytest-django

### Improvements Checklist

- [x] ‚úÖ –í—Å–µ AC —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏
- [x] ‚úÖ Variant C –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [x] ‚úÖ –¢–∏–ø–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ –≤—Å–µ–º –º–µ—Ç–æ–¥–∞–º
- [x] ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è
- [x] ‚úÖ Performance –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (select_related, bulk operations)
- [ ] ‚ö†Ô∏è **Minor:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ E2E —Ç–µ—Å—Ç–∞ —Å –ø–æ–ª–Ω—ã–º —Ü–∏–∫–ª–æ–º –∏–º–ø–æ—Ä—Ç–∞ (goods ‚Üí offers ‚Üí prices ‚Üí rests) –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ end-to-end flow
- [ ] üìù **Future:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (time tracking –¥–ª—è batch operations)

### Security Review

‚úÖ **No security concerns found**
- ORM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–Ω–µ—Ç raw SQL)
- Input validation –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç (empty GUID filtering)
- No hardcoded credentials or secrets
- Proper error handling –±–µ–∑ —É—Ç–µ—á–∫–∏ sensitive information

### Performance Considerations

‚úÖ **Performance optimizations applied:**
- Batch lookups: `AttributeValue1CMapping.objects.filter(onec_id__in=value_ids).select_related()`
- Bulk linking: `product.attributes.set(attribute_values_to_link)` –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞ .add()
- Efficient filters: indexes –Ω–∞ onec_id, normalized_name –ø–æ–ª—è—Ö
- Memory-efficient: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ –æ–¥–Ω–æ–º—É product/variant –∑–∞ —Ä–∞–∑

**Potential optimization (non-blocking):**
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Attribute lookups –≤ _link_variant_attributes() –¥–ª—è –±–æ–ª—å—à–∏—Ö batch –æ–ø–µ—Ä–∞—Ü–∏–π

### Files Modified During Review

**No code changes required** - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.

–í—Å–µ —Ñ–∞–π–ª—ã –∏–∑ Dev Agent Record –∞–∫—Ç—É–∞–ª—å–Ω—ã:
- [backend/apps/products/services/parser.py](backend/apps/products/services/parser.py:17-34,246-302)
- [backend/apps/products/services/processor.py](backend/apps/products/services/processor.py:19-28,377-427)
- [backend/apps/products/services/variant_import.py](backend/apps/products/services/variant_import.py:982-1079)
- [backend/apps/products/tests/test_import_linking.py](backend/apps/products/tests/test_import_linking.py:1-437)

### Gate Status

**Gate: PASS** ‚Üí [docs/qa/gates/14.4-link-attributes.yml](docs/qa/gates/14.4-link-attributes.yml)

### Risk Assessment

- **Technical Risk:** LOW - –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞, –≤—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã
- **Integration Risk:** LOW - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Story 14.2 –∏ 14.3 –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç—ã
- **Data Quality Risk:** LOW - on-the-fly creation –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç data completeness

### Recommended Status

‚úÖ **Ready for Done**

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ production deployment. –í—Å–µ acceptance criteria –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–µ–∫—Ç–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º, —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–µ–µ.

**Kudos to Dev Team:** –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º Variant C –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º Import Layer vs API Layer concerns!
