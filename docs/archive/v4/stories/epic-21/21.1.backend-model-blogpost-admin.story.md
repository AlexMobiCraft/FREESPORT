# Story 21.1: Backend модель BlogPost и Django Admin

<!-- Powered by BMAD™ Core -->

## Status

Ready for Review

---

## Story

**As a** администратор контента,
**I want** создавать, редактировать и публиковать статьи блога через Django Admin,
**so that** посетители сайта могут читать полезный контент, связанный со спортом и продукцией.

---

## Acceptance Criteria

1. Модель `BlogPost` создана в `backend/apps/common/models.py` со всеми полями, указанными в эпике
2. Миграция создана и успешно применена к базе данных
3. Django Admin `BlogPostAdmin` настроен с fieldsets, prepopulated_fields и фильтрами
4. Slug генерируется автоматически из заголовка в Admin
5. Поле `category` позволяет выбирать из активных категорий или оставить пустым
6. Поле `published_at` отображается в date_hierarchy для удобной навигации
7. Unit-тесты покрывают модель и её методы

---

## Tasks / Subtasks

- [x] **Task 1: Создать модель BlogPost** (AC: 1)
  - [x] Добавить импорт `Category` в `backend/apps/common/models.py`
  - [x] Создать класс `BlogPost(models.Model)` по образцу `News`
  - [x] Добавить поля: `title`, `slug`, `subtitle`, `excerpt`, `content`, `image`, `author`
  - [x] Добавить поля: `category` (ForeignKey → Category, optional), `is_published`, `published_at`
  - [x] Добавить SEO-поля: `meta_title`, `meta_description`
  - [x] Добавить аудит-поля: `created_at`, `updated_at`
  - [x] Настроить `Meta` класс: `verbose_name`, `verbose_name_plural`, `ordering`
  - [x] Добавить составные индексы для оптимизации запросов
  - [x] Реализовать `__str__` и `get_absolute_url` методы

- [x] **Task 2: Создать и применить миграцию** (AC: 2)
  - [x] Выполнить `python manage.py makemigrations common`
  - [x] Проверить сгенерированную миграцию
  - [x] Применить миграцию: `python manage.py migrate`

- [x] **Task 3: Настроить BlogPostAdmin** (AC: 3, 4, 5, 6)
  - [x] Добавить импорт `BlogPost` в `backend/apps/common/admin.py`
  - [x] Создать класс `BlogPostAdmin(admin.ModelAdmin)` по образцу `NewsAdmin`
  - [x] Настроить `list_display`: title, category, is_published, published_at, created_at
  - [x] Настроить `list_filter`: is_published, category, published_at
  - [x] Настроить `search_fields`: title, excerpt, content, category__name
  - [x] Настроить `prepopulated_fields`: {"slug": ("title",)}
  - [x] Настроить `readonly_fields`: created_at, updated_at
  - [x] Настроить `date_hierarchy`: published_at
  - [x] Создать fieldsets: "Основная информация", "Контент", "SEO", "Публикация", "Метаданные"
  - [x] Переопределить `formfield_for_foreignkey` для фильтрации активных категорий
  - [x] Зарегистрировать Admin: `@admin.register(BlogPost)`

- [x] **Task 4: Написать unit-тесты** (AC: 7)
  - [x] Создать файл `backend/tests/unit/test_models/test_blog_post.py`
  - [x] Тест: создание BlogPost с минимальными полями
  - [x] Тест: `__str__` возвращает заголовок
  - [x] Тест: slug уникален
  - [x] Тест: category может быть NULL
  - [x] Тест: is_published по умолчанию False
  - [x] Тест: ordering по -published_at

---

## Dev Notes

### Референсная реализация

Модель `BlogPost` создаётся по образцу модели `News` для консистентности. [Source: epic-21.blog-management.md#Existing System Context]

### Поля модели BlogPost

Согласно эпику:

| Поле | Тип | Описание |
|------|-----|----------|
| title | CharField(200) | Заголовок статьи |
| slug | SlugField(200, unique) | URL-идентификатор |
| subtitle | CharField(200, blank) | Подзаголовок |
| excerpt | TextField(blank) | Краткое описание |
| content | TextField | Полное содержание |
| image | ImageField | Главное изображение |
| author | CharField(100, blank) | Имя автора |
| category | ForeignKey(Category, related_name="blog_posts") | Категория (nullable) |
| is_published | BooleanField | Флаг публикации |
| published_at | DateTimeField | Дата публикации |
| meta_title | CharField(200, blank) | SEO title |
| meta_description | TextField(blank) | SEO description |
| created_at | DateTimeField | Дата создания |
| updated_at | DateTimeField | Дата обновления |

[Source: epic-21.blog-management.md#Story 21.1]

### Паттерн модели News (референс)

```python
class News(models.Model):
    title = models.CharField("Заголовок", max_length=200, db_index=True, help_text="...")
    slug = models.SlugField("URL-идентификатор", max_length=200, unique=True, db_index=True, ...)
    excerpt = models.TextField("Краткое описание", blank=True, ...)
    content = models.TextField("Содержание", ...)
    image = models.ImageField("Изображение", upload_to="news/images/%Y/%m/%d/", blank=True, null=True, ...)
    author = models.CharField("Автор", max_length=100, blank=True, ...)
    category = models.ForeignKey(Category, on_delete=models.SET_NULL, related_name="blog_posts", null=True, blank=True, ...)
    is_published = models.BooleanField("Опубликовано", default=False, db_index=True, ...)
    published_at = models.DateTimeField("Дата публикации", null=True, blank=True, ...)
    created_at = models.DateTimeField("Дата создания", auto_now_add=True, ...)
    updated_at = models.DateTimeField("Дата обновления", auto_now=True, ...)

    class Meta:
        verbose_name = _("Новость")
        verbose_name_plural = _("Новости")
        ordering = ["-published_at"]
        indexes = [
            models.Index(fields=["is_published", "published_at"]),
            models.Index(fields=["category", "published_at"]),
        ]
```

[Source: backend/apps/common/models.py#News]

### Метод get_absolute_url

```python
def get_absolute_url(self):
    from django.urls import reverse
    return reverse('blog-detail', kwargs={'slug': self.slug})
```

> **Примечание:** Этот метод будет использоваться в Story 21.2, когда появятся URL маршруты для Blog API.

### Паттерн NewsAdmin (референс)

```python
@admin.register(News)
class NewsAdmin(admin.ModelAdmin):
    list_display = ["title", "category", "is_published", "published_at", "created_at"]
    list_filter = ["is_published", "category", "published_at"]
    search_fields = ["title", "excerpt", "content", "category__name"]
    prepopulated_fields = {"slug": ("title",)}
    readonly_fields = ["created_at", "updated_at"]
    date_hierarchy = "published_at"

    def formfield_for_foreignkey(self, db_field, request, **kwargs):
        if db_field.name == "category":
            kwargs["queryset"] = db_field.related_model.objects.filter(is_active=True)
            kwargs["empty_label"] = "Выберите категорию"
        return super().formfield_for_foreignkey(db_field, request, **kwargs)

    fieldsets = (
        ("Основная информация", {"fields": ("title", "slug", "category", "author")}),
        ("Контент", {"fields": ("excerpt", "content", "image")}),
        ("Публикация", {"fields": ("is_published", "published_at")}),
        ("Метаданные", {"fields": ("created_at", "updated_at"), "classes": ("collapse",)}),
    )
```

[Source: backend/apps/common/admin.py#NewsAdmin]

### Расположение файлов

- **Модель:** `backend/apps/common/models.py` — добавить класс `BlogPost`
- **Admin:** `backend/apps/common/admin.py` — добавить класс `BlogPostAdmin`
- **Тесты:** `backend/tests/unit/test_models/test_blog_post.py` — новый файл

[Source: docs/architecture/source-tree.md#backend]

### Дополнительные поля для BlogPost (отличия от News)

BlogPost имеет дополнительные поля по сравнению с News:

- `subtitle` — подзаголовок
- `meta_title` — SEO заголовок
- `meta_description` — SEO описание

### upload_to для изображений

Для BlogPost использовать паттерн: `blog/images/%Y/%m/%d/`

---

## Testing

### Стратегия тестирования

- **Тип тестов:** Unit-тесты (маркер `@pytest.mark.unit`)
- **Фреймворк:** pytest с pytest-django
- **Расположение:** `backend/tests/unit/test_models/test_blog_post.py`

[Source: docs/architecture/10-testing-strategy.md#Unit-тесты]

### Требования к покрытию

- Минимальное покрытие: 70%
- Критические модели (models.py): 90%

[Source: docs/architecture/10-testing-strategy.md#Требования к покрытию]

### Запуск тестов

```bash
# Через Docker (рекомендуется)
docker compose exec backend pytest tests/unit/test_models/test_blog_post.py -v

# Локально
pytest tests/unit/test_models/test_blog_post.py -v
```

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

- ✅ Модель BlogPost создана по образцу News с дополнительными полями (subtitle, meta_title, meta_description)
- ✅ Исправлена ошибка в модели News: updated_at должен использовать auto_now=True (исправлено в BlogPost)
- ✅ Миграция 0012_blogpost успешно создана и применена
- ✅ BlogPostAdmin настроен с 5 fieldsets (включая SEO раздел)
- ✅ 13 unit-тестов созданы и все успешно прошли
- ✅ Тесты покрывают все Acceptance Criteria

### File List

**Modified Files:**
- `backend/apps/common/models.py` - добавлена модель BlogPost (строки 623-731)
- `backend/apps/common/admin.py` - добавлен импорт BlogPost и класс BlogPostAdmin (строки 16, 381-472)

**New Files:**
- `backend/apps/common/migrations/0012_blogpost.py` - миграция для создания таблицы BlogPost
- `backend/tests/unit/test_models/test_blog_post.py` - 13 unit-тестов для модели BlogPost

---

## QA Results

_To be filled by QA agent_

---

## Change Log

| Date       | Version | Description                              | Author             |
|------------|---------|------------------------------------------|--------------------|
| 2025-12-27 | 1.0     | Initial story draft                      | Bob (Scrum Master) |
| 2025-12-27 | 1.1     | Validation fixes: related_name, updated_at, get_absolute_url | Sarah (PO) |
| 2025-12-27 | 1.2     | Implementation completed: model, admin, migration, tests (13/13 passed) | James (Dev) |
