# Story 29.1: Role Selection UI & Warnings

## Status

Done

---

## Story

**As a** Guest User,  
**I want** to select my role (Retail, Trainer, Wholesaler, Federation) during registration,  
**so that** I can access the platform with correct privileges and pricing.

---

## Acceptance Criteria

1. –ü–æ–ª–µ "–†–æ–ª—å" –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ñ–æ—Ä–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏–º–µ–µ—Ç 4 –æ–ø—Ü–∏–∏:
   - –†–æ–∑–Ω–∏—á–Ω—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å (retail) ‚Äî **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**
   - –¢—Ä–µ–Ω–µ—Ä / –°–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –∫–ª—É–± (trainer)
   - –û–ø—Ç–æ–≤–∏–∫ (wholesale_level1)
   - –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–π —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏ (federation_rep)

2. "–†–æ–∑–Ω–∏—á–Ω—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å" –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ä–º—ã

3. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–µ-—Ä–æ–∑–Ω–∏—á–Ω–æ–π —Ä–æ–ª–∏ (trainer, wholesale_level1, federation_rep) –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫ (InfoPanel) —Å —Ç–µ–∫—Å—Ç–æ–º:
   - "–í–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
   - "–î–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–ª—É –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"
   - "–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ email"

4. –§–æ—Ä–º–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ä–æ–ª—å –≤ backend API —á–µ—Ä–µ–∑ –ø–æ–ª–µ `role`

5. **Accessibility:** Role Selector –¥–æ—Å—Ç—É–ø–µ–Ω —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (Tab, Enter, Arrow keys)

6. **Accessibility:** InfoPanel –∏–º–µ–µ—Ç `role="alert"` –∏ `aria-live="polite"` –¥–ª—è screen readers

7. UI —Å–ª–µ–¥—É–µ—Ç Design System –∏–∑ `docs/frontend/design-system.json`

8. –£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è –¥–ª—è B2B —Ä–æ–ª–µ–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–µ-—Ä–æ–∑–Ω–∏—á–Ω–æ–π —Ä–æ–ª–∏:
   - `company_name` ‚Äî –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—Å–µ—Ö B2B)
   - `tax_id` ‚Äî –ò–ù–ù (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è wholesale –∏ federation_rep)

---

## Tasks / Subtasks

- [x] **Task 1: –û–±–Ω–æ–≤–∏—Ç—å RegisterForm –∫–æ–º–ø–æ–Ω–µ–Ω—Ç** (AC: 1, 2, 4)
  - [x] 1.1 –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –¥–ª—è role selector (Select –∏–ª–∏ custom Dropdown)
  - [x] 1.2 –î–æ–±–∞–≤–∏—Ç—å state –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏: `watch('role')` —á–µ—Ä–µ–∑ React Hook Form
  - [x] 1.3 –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `ROLE_OPTIONS` —Å 4-–º—è –æ–ø—Ü–∏—è–º–∏
  - [x] 1.4 –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –≤ —Ñ–æ—Ä–º—É (–ø–æ—Å–ª–µ email, –ø–µ—Ä–µ–¥ –ø–∞—Ä–æ–ª–µ–º)
  - [x] 1.5 –û–±–Ω–æ–≤–∏—Ç—å `registerData` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–æ–ª–∏ –≤ API

- [x] **Task 2: –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç RoleInfoPanel** (AC: 3, 6)
  - [x] 2.1 –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `frontend/src/components/auth/RoleInfoPanel.tsx`
  - [x] 2.2 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (visible –∫–æ–≥–¥–∞ role !== 'retail')
  - [x] 2.3 –î–æ–±–∞–≤–∏—Ç—å `role="alert"` –∏ `aria-live="polite"` –¥–ª—è accessibility
  - [x] 2.4 –°—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å —Å–æ–≥–ª–∞—Å–Ω–æ Design System (warning colors)

- [x] **Task 3: –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–Ω—ã–µ B2B –ø–æ–ª—è** (AC: 8)
  - [x] 3.1 –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `company_name` (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö B2B —Ä–æ–ª–µ–π)
  - [x] 3.2 –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `tax_id` (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥–ª—è wholesale_level1, federation_rep)
  - [x] 3.3 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ—Ä–µ–∑ Zod refinement
  - [x] 3.4 –†–∞—Å—à–∏—Ä–∏—Ç—å Zod-—Å—Ö–µ–º—É: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `role: z.enum(['retail', 'trainer', 'wholesale_level1', 'federation_rep'])` –≤ `registerSchema` –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø `RegisterFormData`

- [x] **Task 4: Accessibility —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (AC: 5, 6)
  - [x] 4.1 –î–æ–±–∞–≤–∏—Ç—å keyboard navigation –¥–ª—è Role Selector (native select - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞)
  - [x] 4.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å focus visible –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  - [x] 4.3 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å color contrast ‚â• 4.5:1 (WCAG AA) - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Design System

- [x] **Task 5: Unit —Ç–µ—Å—Ç—ã** (AC: 1-8)
  - [x] 5.1 –¢–µ—Å—Ç: —Ä–æ–ª—å "retail" –≤—ã–±—Ä–∞–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  - [x] 5.2 –¢–µ—Å—Ç: InfoPanel –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ B2B —Ä–æ–ª–∏
  - [x] 5.3 –¢–µ—Å—Ç: —É—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è company_name/tax_id –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–ª—è B2B
  - [x] 5.4 –¢–µ—Å—Ç: —Ñ–æ—Ä–º–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç role –≤ API
  - [x] 5.5 –¢–µ—Å—Ç: keyboard navigation —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## Dev Notes

### Existing Code Reference

> [!NOTE]
> **–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è RegisterForm.tsx —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç role='retail':**

```typescript
// frontend/src/components/auth/RegisterForm.tsx (L51-58)
const registerData: RegisterRequest = {
  email: data.email,
  password: data.password,
  password_confirm: data.confirmPassword,
  first_name: data.first_name,
  last_name: '',
  phone: '',
  role: 'retail',  // <-- –•–ê–†–î–ö–û–î! –ù—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ selected role
};
```

[Source: frontend/src/components/auth/RegisterForm.tsx#L51-L58]

### Data Models

**User.ROLE_CHOICES (backend/apps/users/models.py:72-80):**

```python
ROLE_CHOICES = [
    ("retail", "–†–æ–∑–Ω–∏—á–Ω—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å"),
    ("wholesale_level1", "–û–ø—Ç–æ–≤–∏–∫ —É—Ä–æ–≤–µ–Ω—å 1"),
    ("wholesale_level2", "–û–ø—Ç–æ–≤–∏–∫ —É—Ä–æ–≤–µ–Ω—å 2"),
    ("wholesale_level3", "–û–ø—Ç–æ–≤–∏–∫ —É—Ä–æ–≤–µ–Ω—å 3"),
    ("trainer", "–¢—Ä–µ–Ω–µ—Ä/–§–∏—Ç–Ω–µ—Å-–∫–ª—É–±"),
    ("federation_rep", "–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏"),
    ("admin", "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"),
]
```

[Source: backend/apps/users/models.py#L72-L80]

> [!IMPORTANT]
> –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ 4 —Ä–æ–ª–∏: `retail`, `trainer`, `wholesale_level1`, `federation_rep`.
> –†–æ–ª–∏ `wholesale_level2`, `wholesale_level3`, `admin` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.

### API Specifications

**POST /api/auth/register/** (docs/architecture/03-api-specification.md)

–¢–µ–∫—É—â–∏–π request body —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–µ `role`:

```typescript
interface RegisterRequest {
  email: string;
  password: string;
  password_confirm: string;
  first_name: string;
  last_name?: string;
  phone?: string;
  role?: 'retail' | 'trainer' | 'wholesale_level1' | 'federation_rep';  // default: 'retail'
  company_name?: string;  // required –¥–ª—è B2B
  tax_id?: string;        // required –¥–ª—è wholesale, federation_rep
}
```

### Component Specifications

**Role Selector –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **Native Select** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è accessibility):

```tsx
<select 
  value={selectedRole} 
  onChange={(e) => setSelectedRole(e.target.value as UserRole)}
  aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞"
>
  {ROLE_OPTIONS.map(opt => (
    <option key={opt.value} value={opt.value}>{opt.label}</option>
  ))}
</select>
```

2. **Custom Dropdown** (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏–∑–∞–π–Ω):
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `role="listbox"` + `aria-activedescendant`
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å keyboard navigation (Arrow Up/Down, Enter, Escape)

**InfoPanel –∫–æ–º–ø–æ–Ω–µ–Ω—Ç:**

```tsx
interface RoleInfoPanelProps {
  visible: boolean;
}

export const RoleInfoPanel: React.FC<RoleInfoPanelProps> = ({ visible }) => {
  if (!visible) return null;
  
  return (
    <div 
      role="alert" 
      aria-live="polite"
      className="p-4 rounded-lg bg-warning-50 border border-warning-300"
    >
      <ul className="space-y-2 text-body-s text-warning-700">
        <li>‚Ä¢ –í–∞–º –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</li>
        <li>‚Ä¢ –î–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–ª—É –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º</li>
        <li>‚Ä¢ –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ email</li>
      </ul>
    </div>
  );
};
```

### File Locations

| –§–∞–π–ª | –ü—É—Ç—å | –î–µ–π—Å—Ç–≤–∏–µ |
|------|------|----------|
| RegisterForm | `frontend/src/components/auth/RegisterForm.tsx` | MODIFY |
| RoleInfoPanel | `frontend/src/components/auth/RoleInfoPanel.tsx` | CREATE |
| authSchemas | `frontend/src/schemas/authSchemas.ts` | MODIFY |
| API types | `frontend/src/types/api.ts` | VERIFY: `RegisterRequest.role` —É–∂–µ –≤–∫–ª—é—á–∞–µ—Ç –Ω—É–∂–Ω—ã–µ —Ç–∏–ø—ã ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `company_name?` –∏ `tax_id?` |
| Tests | `frontend/src/components/auth/__tests__/RegisterForm.test.tsx` | MODIFY |
| RoleInfoPanel Tests | `frontend/src/components/auth/__tests__/RoleInfoPanel.test.tsx` | CREATE |

### Design System Reference

> [!NOTE]
> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–≤–µ—Ç–∞ –∏–∑ Design System –¥–ª—è InfoPanel:

- **Warning background:** `var(--color-warning-50)` –∏–ª–∏ `bg-warning-50`
- **Warning border:** `var(--color-warning-300)` –∏–ª–∏ `border-warning-300`
- **Warning text:** `var(--color-warning-700)` –∏–ª–∏ `text-warning-700`
- **Focus ring:** `focus:ring-2 focus:ring-primary-500 focus:ring-offset-2`

[Source: docs/frontend/design-system.json]

---

## Testing

### Test File Location

- `frontend/src/components/auth/__tests__/RegisterForm.test.tsx`
- `frontend/src/components/auth/__tests__/RoleInfoPanel.test.tsx`

### Test Standards

- **Framework:** Vitest + React Testing Library
- **Pattern:** Arrange-Act-Assert
- **Coverage:** –ú–∏–Ω–∏–º—É–º 80% –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### Test Cases

```typescript
// RegisterForm.test.tsx
describe('RegisterForm with Role Selection', () => {
  it('should have "retail" role selected by default', async () => {
    render(<RegisterForm />);
    const roleSelect = screen.getByLabelText(/—Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞/i);
    expect(roleSelect).toHaveValue('retail');
  });

  it('should show InfoPanel when B2B role is selected', async () => {
    render(<RegisterForm />);
    const roleSelect = screen.getByLabelText(/—Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞/i);
    await userEvent.selectOptions(roleSelect, 'trainer');
    
    expect(screen.getByRole('alert')).toBeInTheDocument();
    expect(screen.getByText(/–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º/i)).toBeInTheDocument();
  });

  it('should show company_name field for B2B roles', async () => {
    render(<RegisterForm />);
    await userEvent.selectOptions(screen.getByLabelText(/—Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞/i), 'wholesale_level1');
    
    expect(screen.getByLabelText(/–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏/i)).toBeInTheDocument();
  });

  it('should show tax_id field for wholesale and federation roles', async () => {
    render(<RegisterForm />);
    await userEvent.selectOptions(screen.getByLabelText(/—Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞/i), 'wholesale_level1');
    
    expect(screen.getByLabelText(/–∏–Ω–Ω/i)).toBeInTheDocument();
  });

  it('should submit form with selected role', async () => {
    const mockRegister = vi.spyOn(authService, 'register').mockResolvedValue({...});
    
    render(<RegisterForm />);
    await userEvent.selectOptions(screen.getByLabelText(/—Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞/i), 'trainer');
    // Fill other fields...
    await userEvent.click(screen.getByRole('button', { name: /–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è/i }));
    
    expect(mockRegister).toHaveBeenCalledWith(expect.objectContaining({
      role: 'trainer'
    }));
  });
});
```

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

N/A - –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

### Completion Notes List

1. **Role Selector**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ native `<select>` –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π accessibility (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è keyboard navigation)
2. **RoleInfoPanel**: –°–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ ARIA –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –¥–ª—è screen readers
3. **–£—Å–ª–æ–≤–Ω—ã–µ –ø–æ–ª—è**: company_name –∏ tax_id –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ä–æ–ª–∏ —á–µ—Ä–µ–∑ `watch('role')`
4. **Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è**: –†–∞—Å—à–∏—Ä–µ–Ω–∞ registerSchema —Å —É—Å–ª–æ–≤–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ `.refine()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å `.trim()`
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ 28 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ (5 –¥–ª—è RoleInfoPanel, 23 –¥–ª—è RegisterForm –≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–µ)
6. **Accessibility**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã semantic HTML, proper labels, aria-label –¥–ª—è select, aria-live="polite" –¥–ª—è InfoPanel

### File List

**–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- `frontend/src/components/auth/RoleInfoPanel.tsx`
- `frontend/src/components/auth/__tests__/RoleInfoPanel.test.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- `frontend/src/components/auth/RegisterForm.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω—ã role selector, —É—Å–ª–æ–≤–Ω—ã–µ B2B –ø–æ–ª—è, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RoleInfoPanel
- `frontend/src/schemas/authSchemas.ts` - —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ registerSchema —Å –ø–æ–ª—è–º–∏ role, company_name, tax_id –∏ —É—Å–ª–æ–≤–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
- `frontend/src/components/auth/__tests__/RegisterForm.test.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω—ã 7 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è Story 29.1

---

## QA Results

### Review Date: 2025-12-12

### Reviewed By: Quinn (Test Architect)

### Executive Summary

**Gate Decision: ‚úÖ PASS**

Story 29.1 demonstrates **excellent implementation quality** with comprehensive test coverage, proper accessibility, and clean architecture. All 8 acceptance criteria fully met with 28/28 tests passing.

---

### Requirements Traceability (Given-When-Then)

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|--------|
| **AC 1** | Role field with 4 options | ‚úÖ `should have role selector with retail selected by default` | **PASS** |
| **AC 2** | Retail selected by default | ‚úÖ `expect(roleSelect.value).toBe('retail')` | **PASS** |
| **AC 3** | InfoPanel for B2B roles | ‚úÖ `should show InfoPanel when B2B role is selected` (3 messages verified) | **PASS** |
| **AC 4** | Form submits selected role | ‚úÖ `should submit form with selected role` (trainer role verified) | **PASS** |
| **AC 5** | Keyboard navigation | ‚úÖ `should support keyboard navigation for role selector` | **PASS** |
| **AC 6** | Accessibility (role="alert", aria-live) | ‚úÖ `should have correct accessibility attributes` | **PASS** |
| **AC 7** | Design System compliance | ‚úÖ `should have warning color styles from design system` | **PASS** |
| **AC 8** | Conditional B2B fields | ‚úÖ `should show company_name field`, `should show tax_id field` | **PASS** |

**Traceability Summary:**

- **AC Coverage:** 8/8 (100%)
- **Tests Executed:** 28/28 passed
- **Test Categories:** Rendering (3), Validation (5), Submission (2), Error Handling (3), Loading (2), Accessibility (2), Role Selection (6), RoleInfoPanel (5)

---

### Code Quality Assessment

**Overall Grade: A (95/100)**

#### ‚úÖ Strengths

1. **Excellent Component Architecture**
   - Clean separation: `RoleInfoPanel` extracted as reusable component (SRP)
   - RegisterForm.tsx well-organized at 253 lines with clear sections
   - Proper use of React Hook Form with Zod validation

2. **Comprehensive Test Coverage**
   - **28 tests total:** 23 RegisterForm + 5 RoleInfoPanel
   - Edge cases covered: empty fields, mismatched passwords, API errors (409, 400, 500)
   - Accessibility tests included

3. **Outstanding Documentation**
   - Every component has JSDoc header with Story AC references
   - Inline comments map code to specific ACs (e.g., `// AC 2: Retail —Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é`)
   - Clear prop interfaces with TypeScript

4. **Proper Accessibility Implementation**
   - Semantic HTML: `<select>`, `<label>` with `htmlFor`
   - ARIA attributes: `role="alert"`, `aria-live="polite"`, `aria-label`
   - Native keyboard navigation through `<select>` element
   - Proper autocomplete attributes

#### üîç Minor Observations (Not Blocking)

1. **ROLE_OPTIONS Constant** (Line 38-43)
   - Currently defined in RegisterForm
   - **Future consideration:** Extract to `@/constants/roles.ts` if reused elsewhere
   - **Not blocking:** Single usage is fine for now

2. **Validation Message Localization**
   - Messages in Russian (correct for this project)
   - **Note:** Zod refine messages hardcoded (lines 60-84 in authSchemas.ts)
   - **Future:** Consider i18n if multilingual support needed

---

### Compliance Check

| Standard | Status | Notes |
|----------|--------|-------|
| **Coding Standards** | ‚úÖ PASS | TypeScript strict mode, ESLint compliant, proper naming conventions |
| **Project Structure** | ‚úÖ PASS | Files in correct locations (`components/auth/`, `__tests__/`) |
| **Testing Strategy** | ‚úÖ PASS | Vitest + RTL, Arrange-Act-Assert pattern, 28 tests cover all scenarios |
| **All ACs Met** | ‚úÖ PASS | 8/8 acceptance criteria validated with test evidence |

---

### Non-Functional Requirements (NFRs)

#### üîí Security: **‚úÖ PASS**

- **Input Sanitization:** Zod validation with `.trim()` checks prevents empty string bypass
- **XSS Protection:** No dangerouslySetInnerHTML, all user input properly escaped by React
- **Conditional Rendering:** No security issues in `isB2BRole` or `requiresTaxId` logic
- **API Error Handling:** Sensitive error details not exposed to client

#### ‚ö° Performance: **‚úÖ PASS**

- **Efficient Re-renders:** `watch('role')` minimizes unnecessary renders
- **Conditional Fields:** `isB2BRole && (...)` pattern avoids premature DOM creation
- **Test Execution Time:** 12.28s for 23 tests is acceptable (avg ~534ms/test)
- **No Performance Warnings:** Vitest reports no slowdowns

#### üõ°Ô∏è Reliability: **‚úÖ PASS**

- **Error Handling:** Comprehensive try-catch with specific HTTP status handling (409, 400, 500)
- **Form State Management:** React Hook Form handles edge cases (disabled state during submission)
- **Loading States:** Proper `isSubmitting` prevents double-submit
- **Test Evidence:** All error scenarios tested and passing

#### üîß Maintainability: **‚úÖ PASS**

- **Code Clarity:** Clear variable names (`selectedRole`, `isB2BRole`, `requiresTaxId`)
- **Component Size:** 253 lines for RegisterForm is reasonable, well-sectioned
- **Test Maintainability:** Test descriptions clearly map to ACs
- **Documentation:** Excellent inline documentation with AC references

#### ‚ôø Accessibility: **‚úÖ PASS** (Outstanding)

- **Semantic HTML:** `<select>`, `<label>`, `<button>` used correctly
- **ARIA:** `role="alert"`, `aria-live="polite"`, `aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞"`
- **Keyboard Navigation:** Native `<select>` provides Tab, Arrow keys, Enter support
- **Labels:** All inputs have associated `<label>` with `htmlFor`
- **Focus Management:** Proper focus styles, no focus traps
- **Screen Reader Support:** RoleInfoPanel announces changes via `aria-live="polite"`
- **Color Contrast:** Design System variables ensure WCAG AA compliance

---

### Test Architecture Assessment

#### Test Design Quality: **Excellent**

1. **Proper Test Organization**
   - Tests grouped by category (Rendering, Validation, Submission, Error Handling, etc.)
   - Clear `describe` blocks with meaningful names

2. **Test Level Appropriateness**
   - **Component tests** (Vitest + RTL) - ‚úÖ Correct choice for UI components
   - **No unnecessary E2E** - ‚úÖ Unit/component tests sufficient for this story
   - **Integration with mocked services** - ‚úÖ Proper use of `vi.mock()` for authService

3. **Edge Case Coverage**
   - Empty fields validation ‚úÖ
   - Password mismatch ‚úÖ
   - Invalid email (browser native validation) ‚úÖ
   - API errors (409, 400, 500) ‚úÖ
   - Loading states ‚úÖ
   - Conditional field display ‚úÖ

4. **Mock Strategy**
   - ‚úÖ `authService.register` properly mocked
   - ‚úÖ `next/navigation` useRouter mocked
   - ‚úÖ Mocks cleared in `beforeEach`

---

### Refactoring Performed

**No refactoring needed.** Code quality is excellent as-is.

---

### Improvements Checklist

**All items complete:**

- [x] Role selector implemented with 4 options
- [x] Retail default value set
- [x] RoleInfoPanel component created with accessibility
- [x] Conditional B2B fields (company_name, tax_id) implemented
- [x] Zod validation extended with conditional refinements
- [x] Comprehensive test suite (28/28 tests passing)
- [x] Accessibility attributes (ARIA, semantic HTML) implemented
- [x] Documentation with AC references added

**No outstanding items.**

---

### Security Review

**Status: ‚úÖ PASS**

- No XSS vulnerabilities detected
- Input validation through Zod with trim() sanitization
- No dangerouslySetInnerHTML usage
- API error messages properly sanitized
- Role enum prevents injection attacks

---

### Performance Considerations

**Status: ‚úÖ PASS**

- Efficient conditional rendering (`isB2BRole && ...`)
- Minimal re-renders through controlled `watch('role')`
- No performance bottlenecks identified
- Form submission time reasonable (tested with delays)

---

### Files Modified During Review

**None.** No refactoring or improvements needed during QA review.

---

### Gate Status

**Gate: ‚úÖ PASS** ‚Üí [docs/qa/gates/29.1-role-selection-ui.yml](file:///c:/Users/38670/DEV_WEB/FREESPORT/docs/qa/gates/29.1-role-selection-ui.yml)

**Quality Score: 95/100**

**Rationale:**

- All 8 acceptance criteria met with test evidence
- Zero critical, high, or medium issues
- Excellent code quality, accessibility, and test coverage
- Outstanding documentation and maintainability
- No security, performance, or reliability concerns

---

### Recommended Status

**‚úÖ Ready for Done**

Story fully meets all acceptance criteria with exceptional implementation quality. No changes required.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | Initial story draft | Bob (SM) |
| 2025-12-12 | 1.1 | PO Validation: —É—Ç–æ—á–Ω—ë–Ω Task 3.4 (Zod-—Å—Ö–µ–º–∞ + role), –ø—Ä–æ—è—Å–Ω–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ api.ts | Sarah (PO) |
