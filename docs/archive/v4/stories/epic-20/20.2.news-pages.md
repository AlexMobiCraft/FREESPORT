# Story 20.2: Frontend страницы новостей

<!-- Powered by BMAD™ Core -->

## Status

Done

---

## Story

**As a** посетитель сайта,
**I want** просматривать список новостей и детальные страницы новостей,
**so that** я могу быть в курсе актуальных событий и акций компании.

---

## Acceptance Criteria

1. **AC1:** Создана страница `/news` со списком опубликованных новостей
2. **AC2:** Создана страница `/news/[slug]` для детальной новости
3. **AC3:** Страница списка отображает карточки новостей (изображение, заголовок, дата, excerpt)
4. **AC4:** На странице списка реализована пагинация (12 новостей на страницу)
5. **AC5:** Страница детальной новости отображает полный контент, изображение, дату, автора
6. **AC6:** Breadcrumb навигация на обеих страницах
7. **AC7:** SEO метаданные для обеих страниц (title, description, OpenGraph)
8. **AC8:** Динамическое SEO для детальной страницы (generateMetadata)
9. **AC9:** Responsive дизайн (mobile, tablet, desktop)
10. **AC10:** Обработка ошибок (404 для несуществующей новости)
11. **AC11:** Unit-тесты с покрытием ≥70%

---

## Dependencies

> [!IMPORTANT]
> **Блокирующая зависимость:** Эта история требует завершения **Story 20.1** (Backend API для детальной новости).
> Endpoint `GET /api/v1/news/{slug}/` должен быть реализован.

---

## Tasks / Subtasks

### Task 1: Расширить newsService.ts (AC: 2, 4, 10)

- [x] 1.1 Добавить функцию `getNewsBySlug(slug: string): Promise<NewsItem>`
- [x] 1.2 Добавить обработку 404 ошибки (throw Error если не найдено)
- [x] 1.3 Обновить `getNews()` — изменить `page_size` по умолчанию на 12 для страницы списка
- [x] 1.4 Добавить параметр `getNewsList(params)` с полной пагинацией (count, next, previous)

### Task 2: Создать страницу /news (AC: 1, 3, 4, 6, 7, 9)

- [x] 2.1 Создать `frontend/src/app/news/page.tsx`
- [x] 2.2 Server Component с fetch данных через newsService
- [x] 2.3 SEO metadata: title="Новости | FREESPORT", description
- [x] 2.4 Breadcrumb: Главная → Новости
- [x] 2.5 Использовать существующий `NewsCard` из `@/components/home`
- [x] 2.6 Grid карточек новостей (3 колонки desktop, 2 tablet, 1 mobile)
- [x] 2.7 Пагинация через searchParams (page=1, 2, ...)
- [x] 2.8 Empty state если новостей нет

### Task 3: Создать страницу /news/[slug] (AC: 2, 5, 6, 8, 9, 10)

- [x] 3.1 Создать `frontend/src/app/news/[slug]/page.tsx`
- [x] 3.2 Server Component с fetch данных по slug
- [x] 3.3 Динамический SEO через `generateMetadata()`
- [x] 3.4 Breadcrumb: Главная → Новости → {Заголовок новости}
- [x] 3.5 Отображать: изображение, заголовок, дата, автор, content (HTML)
- [x] 3.6 Обработка notFound() если новость не существует
- [x] 3.7 Кнопка «Назад к новостям»

### Task 4: Unit-тесты для страниц (AC: 11)

- [x] 4.1 Создать `frontend/src/app/news/__tests__/page.test.tsx`
- [x] 4.2 Создать `frontend/src/app/news/[slug]/__tests__/page.test.tsx`
- [x] 4.3 Тесты: рендеринг списка новостей
- [x] 4.4 Тесты: breadcrumb навигация
- [x] 4.5 Тесты: пагинация
- [x] 4.6 Тесты: рендеринг детальной страницы
- [x] 4.7 Мокировать newsService

### Task 5: Верификация интеграции

- [x] 5.1 Проверить переходы между страницами
- [x] 5.2 Проверить responsive на всех breakpoints
- [x] 5.3 Запустить все тесты: `npm test -- news`
- [x] 5.4 Проверить ESLint: `npm run lint`

---

## Dev Notes

### Existing Code Context

**NewsCard** (`frontend/src/components/home/NewsCard.tsx`) — **УЖЕ СУЩЕСТВУЕТ:**

```typescript
import { NewsCard } from '@/components/home/NewsCard';

// Props:
interface NewsCardProps {
  title: string;
  excerpt: string;
  image: string;
  publishedAt: string;
}

// Использование:
<Link href={`/news/${news.slug}`}>
  <NewsCard
    title={news.title}
    excerpt={news.excerpt}
    image={news.image || '/images/placeholder.jpg'}
    publishedAt={news.published_at}
  />
</Link>
```

[Source: frontend/src/components/home/NewsCard.tsx]

---

**newsService.ts** (`frontend/src/services/newsService.ts`) — текущий код:

```typescript
export const newsService = {
  async getNews(params?: GetNewsParams): Promise<NewsItem[]> {
    const { data } = await apiClient.get<NewsList>('/news', {
      params: { page_size: 3, ...params },
    });
    return data.results;
  },
  
  // ДОБАВИТЬ:
  async getNewsBySlug(slug: string): Promise<NewsItem> {
    const { data } = await apiClient.get<NewsItem>(`/news/${slug}/`);
    return data;
  },
  
  // ДОБАВИТЬ для пагинации:
  async getNewsList(params?: GetNewsParams): Promise<NewsList> {
    const { data } = await apiClient.get<NewsList>('/news', {
      params: { page_size: 12, ...params },
    });
    return data;
  },
};
```

[Source: frontend/src/services/newsService.ts]

**NewsItem type** (`frontend/src/types/api.ts`, lines 229-241):

```typescript
export interface NewsItem {
  id: number;
  title: string;
  slug: string;
  excerpt: string;
  content?: string;
  image: string | null;
  published_at: string;
  created_at: string;
  updated_at: string;
  author?: string;
  category?: string;
}
```

[Source: frontend/src/types/api.ts#NewsItem]

### Reference: About Page Pattern

Использовать паттерн из Story 19.3 (`frontend/src/app/about/page.tsx`):

- Server Component с metadata export
- Breadcrumb в начале страницы
- Секции с `max-w-7xl mx-auto px-4 sm:px-6 lg:px-8`
- Responsive grid классы

[Source: Story 19.3, docs/stories/epic-19/19.3.about-page.md]

### File Locations

| Файл | Действие |
|------|----------|
| `frontend/src/services/newsService.ts` | Добавить `getNewsBySlug()`, `getNewsList()` |
| `frontend/src/components/home/NewsCard.tsx` | [EXISTS] Использовать существующий |
| `frontend/src/app/news/page.tsx` | [NEW] Страница списка |
| `frontend/src/app/news/[slug]/page.tsx` | [NEW] Детальная страница |
| `frontend/src/app/news/__tests__/page.test.tsx` | [NEW] Тесты |
| `frontend/src/app/news/[slug]/__tests__/page.test.tsx` | [NEW] Тесты |

### NewsCard Component (Existing)

> [!NOTE]
> Компонент `NewsCard` уже реализован. Использовать as-is, обернув в `<Link>`.

```typescript
// Существующий компонент в frontend/src/components/home/NewsCard.tsx
interface NewsCardProps {
  title: string;
  excerpt: string;
  image: string;
  publishedAt: string;
}

// Структура карточки (уже реализовано):
// ┌─────────────────────────┐
// │       [Image]           │  ← Next.js Image с hover scale
// ├─────────────────────────┤
// │ 26 декабря 2025         │  ← publishedAt (formatted via Intl)
// │ Заголовок новости       │  ← title (line-clamp-2)
// │ Краткое описание...     │  ← excerpt (line-clamp-2)
// └─────────────────────────┘
```

### Page /news Layout

```
┌─────────────────────────────────────────────────────────────┐
│ Главная / Новости                            [Breadcrumb]  │
├─────────────────────────────────────────────────────────────┤
│                       Новости                               │
│                                                             │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐                     │
│ │ NewsCard │ │ NewsCard │ │ NewsCard │                     │
│ └──────────┘ └──────────┘ └──────────┘                     │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐                     │
│ │ NewsCard │ │ NewsCard │ │ NewsCard │                     │
│ └──────────┘ └──────────┘ └──────────┘                     │
│                                                             │
│              [← Prev] [1] [2] [3] [Next →]                  │
└─────────────────────────────────────────────────────────────┘
```

### Page /news/[slug] Layout

```
┌─────────────────────────────────────────────────────────────┐
│ Главная / Новости / Заголовок               [Breadcrumb]   │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                    [Hero Image]                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 26.12.2025 • Автор                                         │
│                                                             │
│ # Заголовок новости                                        │
│                                                             │
│ Полный текст новости здесь. Может содержать HTML           │
│ контент с форматированием.                                  │
│                                                             │
│ [← Назад к новостям]                                        │
└─────────────────────────────────────────────────────────────┘
```

### SEO Metadata

**Страница /news:**

```typescript
export const metadata: Metadata = {
  title: 'Новости | FREESPORT',
  description: 'Новости компании FREESPORT. Акции, события, обновления каталога.',
  openGraph: {
    title: 'Новости | FREESPORT',
    description: 'Новости компании FREESPORT',
  },
};
```

**Страница /news/[slug] (динамический):**

```typescript
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const news = await newsService.getNewsBySlug(params.slug);
  return {
    title: `${news.title} | Новости FREESPORT`,
    description: news.excerpt,
    openGraph: {
      title: news.title,
      description: news.excerpt,
      images: news.image ? [news.image] : [],
    },
  };
}
```

### Date Formatting

```typescript
// Использовать Intl.DateTimeFormat для локализации
const formatDate = (dateString: string): string => {
  return new Intl.DateTimeFormat('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(new Date(dateString));
};
// Output: "26 декабря 2025"
```

### Pagination Component

**УЖЕ СУЩЕСТВУЕТ:** `@/components/ui/Pagination`

```typescript
import { Pagination } from '@/components/ui/Pagination';

// Props:
interface PaginationProps {
  currentPage: number;        // Текущая страница (начинается с 1)
  totalPages: number;         // Общее количество страниц
  onPageChange: (page: number) => void;
  showFirstLast?: boolean;    // Кнопки первая/последняя
  maxVisiblePages?: number;   // По умолчанию 5
}

// Использование в странице новостей:
'use client';
import { useRouter, useSearchParams } from 'next/navigation';

const NewsPageClient = ({ totalPages, currentPage }: Props) => {
  const router = useRouter();
  
  const handlePageChange = (page: number) => {
    router.push(`/news?page=${page}`);
  };
  
  return (
    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      onPageChange={handlePageChange}
      maxVisiblePages={5}
    />
  );
};
```

[Source: frontend/src/components/ui/Pagination/Pagination.tsx]

### Empty State Pattern

Использовать паттерн из `OrdersList` компонента:

```typescript
// Пример Empty State для страницы новостей
import { Newspaper } from 'lucide-react';

const EmptyNewsState = () => (
  <div className="flex flex-col items-center justify-center py-16 text-center">
    <div className="w-16 h-16 rounded-full bg-neutral-200 flex items-center justify-center mb-4">
      <Newspaper className="w-8 h-8 text-neutral-400" aria-hidden="true" />
    </div>
    <h3 className="text-title-m font-semibold text-text-primary mb-2">
      Новостей пока нет
    </h3>
    <p className="text-body-s text-text-muted max-w-sm">
      Скоро здесь появятся новости о наших акциях и событиях
    </p>
  </div>
);
```

[Source: frontend/src/components/business/OrdersList/OrdersList.tsx#L43-60]

### Loading State (Suspense)

Для Server Components использовать Suspense boundary:

```typescript
// frontend/src/app/news/loading.tsx (опционально)
export default function NewsLoading() {
  return (
    <div className="min-h-screen bg-[#F5F7FB] flex items-center justify-center">
      <div className="animate-pulse text-text-muted">Загрузка...</div>
    </div>
  );
}

// Или в page.tsx через Suspense
import { Suspense } from 'react';

export default async function NewsPage() {
  return (
    <Suspense fallback={<div className="animate-pulse">Загрузка...</div>}>
      <NewsContent />
    </Suspense>
  );
}
```

[Reference: frontend/src/app/catalog/page.tsx#L1000-1002]

---

## Testing

### Testing Standards

- **Framework:** Vitest + React Testing Library
- **Расположение:** рядом с компонентами в `__tests__/`
- **Mocking:** MSW или vi.mock для newsService

### Test Commands

```bash
# Запуск тестов для этой истории
npm test -- news

# С покрытием
npm run test:coverage -- --testPathPattern=news

# Watch mode
npm test -- news --watch
```

### Key Test Cases

```typescript
// news/page.test.tsx
describe('NewsListPage', () => {
  it('renders breadcrumb');
  it('renders news grid with NewsCard components');
  it('renders empty state when no news');
  it('renders pagination controls');
  it('passes correct props to NewsCard');
});

// news/[slug]/page.test.tsx
describe('NewsDetailPage', () => {
  it('renders breadcrumb with news title');
  it('renders news image');
  it('renders news content as HTML');
  it('renders back link to /news');
  it('calls notFound() for non-existent slug');
});

// news/[slug]/generateMetadata.test.tsx
describe('generateMetadata', () => {
  it('returns correct title with news title');
  it('returns excerpt as description');
  it('returns image in openGraph when present');
  it('handles missing news (404 case)');
});
```

> [!NOTE]
> `NewsCard` уже покрыт тестами (если есть) или тестируется интеграционно через страницы.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Initial story draft | Bob (SM) |
| 2025-12-26 | 1.1 | PO validation: исправлено использование существующего NewsCard, обновлены tasks | Sarah (PO) |
| 2025-12-27 | 1.2 | Добавлены: Pagination component, Empty State pattern, Loading State (Suspense), тест generateMetadata | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

- Все тесты прошли успешно (49/49 passed)
- ESLint проверка пройдена (только warnings для test моков)
- TypeScript типизация корректна

### Completion Notes List

- ✅ newsService.ts расширен: добавлены getNewsList() и getNewsBySlug()
- ✅ Страница /news создана с пагинацией и empty state
- ✅ Страница /news/[slug] создана с generateMetadata() и notFound()
- ✅ Все 49 unit-тестов успешно прошли
- ✅ ESLint проверка пройдена
- ✅ Используется существующий NewsCard компонент
- ✅ SEO metadata реализовано для обеих страниц
- ✅ Breadcrumb навигация добавлена
- ✅ Responsive дизайн (mobile, tablet, desktop)

### File List

**Modified:**
- `frontend/src/services/newsService.ts` - Добавлены getNewsList() и getNewsBySlug()

**Created:**
- `frontend/src/app/news/page.tsx` - Страница списка новостей
- `frontend/src/app/news/[slug]/page.tsx` - Детальная страница новости
- `frontend/src/app/news/__tests__/page.test.tsx` - Unit-тесты списка (23 теста)
- `frontend/src/app/news/[slug]/__tests__/page.test.tsx` - Unit-тесты детальной страницы (26 тестов)

---

## QA Results

### Review Date: 2025-12-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Реализация страниц новостей выполнена на высоком уровне с соблюдением стандартов Next.js и архитектурных паттернов проекта. Использование Server Components обеспечивает отличную производительность и SEO. Код хорошо структурирован, разделен на сервисную часть и компоненты представления.

### Refactoring Performed

Рефакторинг кода не проводился, так как текущая реализация полностью соответствует требованиям и стандартам качества. Все функции `newsService` реализованы эффективно, компоненты страниц корректно обрабатывают состояния загрузки и ошибок.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] 
- All ACs Met: [✓]

### Improvements Checklist

- [x] Реализована пагинация на странице списка (Task 2.7)
- [x] Добавлен Empty State для отсутствующих новостей (Task 2.8)
- [x] Реализована динамическая генерация метаданных (Task 3.3)
- [x] Добавлены комплексные unit-тесты (Task 4)
- [ ] Рекомендуется проверить санитизацию HTML на стороне Backend для поля `content`.

### Security Review

Основной риск связан с использованием `dangerouslySetInnerHTML` для отображения контента новости. Рекомендуется убедиться, что контент санитизируется на стороне сервера (Django) перед сохранением. На фронтенде других критических уязвимостей не обнаружено.

### Performance Considerations

Использование Server Components и оптимизация изображений через `next/image` с атрибутом `priority` для Hero-баннера обеспечивают быструю загрузку и хорошие показатели Core Web Vitals (LCP).

### Files Modified During Review

Файлы не изменялись.

### Gate Status

Gate: PASS → docs/qa/gates/20.2-news-pages.yml

### Recommended Status

[✓ Ready for Done]

---

## Checklist для Dev Agent

- [x] Убедиться что Story 20.1 завершена
- [x] Расширить `newsService.ts` (Task 1)
- [x] Создать `/news/page.tsx` (Task 2)
- [x] Создать `/news/[slug]/page.tsx` (Task 3)
- [x] Написать тесты (Task 4)
- [x] Верифицировать интеграцию (Task 5)
