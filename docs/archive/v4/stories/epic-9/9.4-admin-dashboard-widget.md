# Story 9.4: Admin Dashboard Widget with Key Metrics

**Epic:** Epic 9 - Advanced Admin Panel  
**Story ID:** 9.4  
**Status:** Draft

---

## Story

**As a** Platform Administrator,  
**I want** to see key platform metrics on the Django Admin home page,  
**so that** I can quickly assess platform health and identify issues without navigating through multiple sections.

---

## Acceptance Criteria

1. Custom template `admin/index.html` —Å–æ–∑–¥–∞–Ω (extends original)
2. –í–∏–¥–∂–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏:
   - **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:** –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ–≥–æ–¥–Ω—è, –Ω–æ–≤—ã–µ –∑–∞ –Ω–µ–¥–µ–ª—é, –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ B2B
   - **–ó–∞–∫–∞–∑—ã:** —Å–µ–≥–æ–¥–Ω—è, –∑–∞ –Ω–µ–¥–µ–ª—é, —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ (pending/processing/shipped)
   - **–ò–º–ø–æ—Ä—Ç 1–°:** —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞, –≤—Ä–µ–º—è, –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - **–ü—Ä–æ–±–ª–µ–º—ã:** –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã, –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
3. –ö–∞–∂–¥–∞—è –º–µ—Ç—Ä–∏–∫–∞ —è–≤–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–æ–π –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª –∞–¥–º–∏–Ω–∫–∏
4. –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (Redis, TTL 5 –º–∏–Ω—É—Ç)
6. Performance requirements –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
   - Load test: 10 concurrent admin users ‚Üí dashboard <500ms
   - Cache hit rate >90% –ø–æ—Å–ª–µ 5 –º–∏–Ω—É—Ç —Ä–∞–±–æ—Ç—ã
   - Query count <20 –¥–ª—è dashboard rendering
   - Memory usage <100MB –¥–ª—è dashboard cache
7. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
   - Django Debug Toolbar –¥–ª—è development –æ–∫—Ä—É–∂–µ–Ω–∏—è
   - Production-ready logging –¥–ª—è –º–µ—Ç—Ä–∏–∫ dashboard (response time, cache hits, errors)
   - Middleware –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è dashboard performance –≤ production
8. Performance regression tests –¥–æ–±–∞–≤–ª–µ–Ω—ã
9. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è `docs/admin-guide.md` —Å–æ–∑–¥–∞–Ω–∞:**
   - –†–∞–∑–¥–µ–ª 1: –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
   - –†–∞–∑–¥–µ–ª 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   - –†–∞–∑–¥–µ–ª 3: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
   - –†–∞–∑–¥–µ–ª 4: –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ 1–°
   - –†–∞–∑–¥–µ–ª 5: –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞
   - –†–∞–∑–¥–µ–ª 6: Troubleshooting
   - Screenshots –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - FAQ —Å–µ–∫—Ü–∏—è (–º–∏–Ω–∏–º—É–º 10 –≤–æ–ø—Ä–æ—Å–æ–≤)

---

## Tasks / Subtasks

- [ ] **Task 1: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫** (AC: 2, 5)
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/apps/common/admin_dashboard.py`
  - [ ] –§—É–Ω–∫—Ü–∏—è get_user_metrics():
    - active_today (login –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24—á)
    - new_this_week (created_at –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
    - pending_verification (is_verified_b2b=False, role='wholesale')
  - [ ] –§—É–Ω–∫—Ü–∏—è get_order_metrics():
    - orders_today, orders_week
    - status_breakdown (pending/processing/shipped counts)
  - [ ] –§—É–Ω–∫—Ü–∏—è get_import_metrics():
    - last_import (–ø–æ—Å–ª–µ–¥–Ω—è—è ImportSession)
    - last_import_status, last_import_time
    - active_imports (status='running')
  - [ ] –§—É–Ω–∫—Ü–∏—è get_problem_metrics():
    - incomplete_imports (failed ImportSessions –∑–∞ 24—á)
    - sync_conflicts (–º–æ–¥–µ–ª—å SyncConflict –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ Story 3.2.2)
  - [ ] –û–±–µ—Ä–Ω—É—Ç—å –∫–∞–∂–¥—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ cache decorator (@cache_page –∏–ª–∏ manual caching)

- [ ] **Task 2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫** (AC: 5, 6)
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Django cache framework
  - [ ] –°–æ–∑–¥–∞—Ç—å cache_key = 'admin_dashboard_metrics'
  - [ ] TTL = 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)
  - [ ] Cache invalidation –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ User/Order/ImportSession (signals)
  - [ ] Fallback –µ—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

- [ ] **Task 3: –°–æ–∑–¥–∞—Ç—å custom admin template** (AC: 1, 3, 4)
  - [ ] –°–æ–∑–¥–∞—Ç—å `backend/templates/admin/index.html`
  - [ ] Extend –±–∞–∑–æ–≤—ã–π admin/index.html
  - [ ] –î–æ–±–∞–≤–∏—Ç—å custom context processor –∏–ª–∏ override AdminSite.index
  - [ ] –°–æ–∑–¥–∞—Ç—å HTML –≤–∏–¥–∂–µ—Ç —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Bootstrap (—É–∂–µ –≤ Django Admin)
  - [ ] –î–æ–±–∞–≤–∏—Ç—å CSS –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –≤–µ—Ä—Å—Ç–∫–∏
  - [ ] –ö–∞–∂–¥–∞—è –º–µ—Ç—Ä–∏–∫–∞ - —Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ {% url 'admin:app_model_changelist' %}

- [ ] **Task 4: Customize AdminSite –¥–ª—è injection –º–µ—Ç—Ä–∏–∫** (AC: 2)
  - [ ] –û–±–Ω–æ–≤–∏—Ç—å `backend/apps/common/admin.py`
  - [ ] Override AdminSite.index() –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å custom context processor
  - [ ] –í—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ admin_dashboard.py
  - [ ] –ü–µ—Ä–µ–¥–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ template context

- [ ] **Task 5: Performance optimization** (AC: 6)
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å select_related/prefetch_related –≤ metric functions
  - [ ] Minimize database queries (<20)
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å aggregate/annotate –≤–º–µ—Å—Ç–æ Python loops
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å query count —á–µ—Ä–µ–∑ Django Debug Toolbar

- [ ] **Task 6: Performance & Load Testing** (AC: 6, 8)
  - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å locust –∏–ª–∏ artillery –¥–ª—è load testing
  - [ ] –°–æ–∑–¥–∞—Ç—å load test script: 10 concurrent admin users
  - [ ] –ò–∑–º–µ—Ä–∏—Ç—å response time (target: <500ms)
  - [ ] –ò–∑–º–µ—Ä–∏—Ç—å cache hit rate —á–µ—Ä–µ–∑ Redis monitoring
  - [ ] –ò–∑–º–µ—Ä–∏—Ç—å memory usage
  - [ ] –î–æ–±–∞–≤–∏—Ç—å performance regression test –≤ CI/CD

- [ ] **Task 7: Unit —Ç–µ—Å—Ç—ã** (AC: 2, 5)
  - [ ] –°–æ–∑–¥–∞—Ç—å `backend/apps/common/tests/test_admin_dashboard.py`
  - [ ] –¢–µ—Å—Ç: get_user_metrics() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  - [ ] –¢–µ—Å—Ç: get_order_metrics() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  - [ ] –¢–µ—Å—Ç: get_import_metrics() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  - [ ] –¢–µ—Å—Ç: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (cache hit)
  - [ ] –¢–µ—Å—Ç: cache invalidation —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

- [ ] **Task 8: Integration —Ç–µ—Å—Ç—ã** (AC: –≤—Å–µ)
  - [ ] –°–æ–∑–¥–∞—Ç—å `backend/tests/integration/test_admin_dashboard.py`
  - [ ] –¢–µ—Å—Ç: dashboard –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ /admin/
  - [ ] –¢–µ—Å—Ç: –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  - [ ] –¢–µ—Å—Ç: —Å—Å—ã–ª–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
  - [ ] –¢–µ—Å—Ç: –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ (headless browser test)

- [ ] **Task 9: –°–æ–∑–¥–∞—Ç—å admin-guide.md –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** (AC: 9)
  - [ ] –°–æ–∑–¥–∞—Ç—å `docs/admin-guide.md`
  - [x] –†–∞–∑–¥–µ–ª 1: –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, –∫–∞–∫–∏–µ Django permissions –Ω—É–∂–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞–∑–¥–µ–ª–æ–≤)
  - [ ] –†–∞–∑–¥–µ–ª 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ screenshots)
  - [ ] –†–∞–∑–¥–µ–ª 3: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
  - [ ] –†–∞–∑–¥–µ–ª 4: –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ 1–° (–ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
  - [ ] –†–∞–∑–¥–µ–ª 5: –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞ (—á—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –º–µ—Ç—Ä–∏–∫–∏)
  - [ ] –†–∞–∑–¥–µ–ª 6: Troubleshooting (10+ FAQ)
  - [ ] –î–æ–±–∞–≤–∏—Ç—å screenshots –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
  - [ ] Review –∏ proofread

- [ ] **Task 10: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤** (AC: –≤—Å–µ)
  - [ ] –û–±–Ω–æ–≤–∏—Ç—å docs/architecture/04-component-structure.md
  - [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª Django Admin —Å –¥–∏–∞–≥—Ä–∞–º–º–æ–π
  - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å security considerations

- [ ] **Task 11: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å production monitoring** (AC: 7)
  - [ ] –°–æ–∑–¥–∞—Ç—å custom middleware `DashboardPerformanceMiddleware`
  - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å response time –¥–ª—è /admin/ requests
  - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å cache hit/miss –¥–ª—è dashboard metrics
  - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å errors –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –º–µ—Ç—Ä–∏–∫
  - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Django logging –≤ settings (–æ—Ç–¥–µ–ª—å–Ω—ã–π logger –¥–ª—è dashboard)
  - [ ] –î–æ–±–∞–≤–∏—Ç—å structured logging (JSON format –¥–ª—è production)
  - [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Django Debug Toolbar –¥–ª—è development

---

## Dev Notes

### Architecture Context

**Source Tree:**

- Dashboard metrics: `backend/apps/common/admin_dashboard.py` (—Å–æ–∑–¥–∞—Ç—å)
- AdminSite customization: `backend/apps/common/admin.py` (–æ–±–Ω–æ–≤–∏—Ç—å)
- Performance middleware: `backend/apps/common/middleware.py` (—Å–æ–∑–¥–∞—Ç—å)
- Template: `backend/templates/admin/index.html` (—Å–æ–∑–¥–∞—Ç—å)
- Signals: `backend/apps/common/signals.py` (—Å–æ–∑–¥–∞—Ç—å)
- Tests: `backend/apps/common/tests/test_admin_dashboard.py` (—Å–æ–∑–¥–∞—Ç—å)
- Documentation: `docs/admin-guide.md` (—Å–æ–∑–¥–∞—Ç—å)

**Dependencies:**

- Django Admin (–≤—Å—Ç—Ä–æ–µ–Ω–æ)
- Redis (–¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)
- Bootstrap (—É–∂–µ –≤ Django Admin)
- Django Debug Toolbar (–¥–ª—è development)
- Django logging framework (–¥–ª—è production monitoring)

**Prerequisites from Stories 9.1-9.3:**

- **Story 9.1:** User admin interface (–¥–ª—è screenshots –≤ admin-guide.md)
- **Story 9.2:** Order admin interface (–¥–ª—è screenshots –≤ admin-guide.md)
- **Story 9.3:** Import management interface (–¥–ª—è screenshots –≤ admin-guide.md)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Screenshots –¥–ª—è `docs/admin-guide.md` –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Stories 9.1-9.3

### Dashboard Metrics Implementation

**–§–∞–π–ª:** `backend/apps/common/admin_dashboard.py`

```python
from django.core.cache import cache
from django.utils import timezone
from datetime import timedelta
from django.contrib.auth import get_user_model
from apps.orders.models import Order
from apps.products.models import ImportSession

User = get_user_model()

def get_dashboard_metrics():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è dashboard.
    –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç.
    """
    cache_key = 'admin_dashboard_metrics'
    metrics = cache.get(cache_key)
    
    if metrics is None:
        metrics = {
            'users': get_user_metrics(),
            'orders': get_order_metrics(),
            'imports': get_import_metrics(),
            'problems': get_problem_metrics(),
        }
        cache.set(cache_key, metrics, 300)  # 5 –º–∏–Ω—É—Ç TTL
    
    return metrics

def get_user_metrics():
    """–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    now = timezone.now()
    today = now.date()
    week_ago = now - timedelta(days=7)
    
    return {
        'active_today': User.objects.filter(
            last_login__date=today
        ).count(),
        'new_this_week': User.objects.filter(
            created_at__gte=week_ago
        ).count(),
        'pending_verification': User.objects.filter(
            role='wholesale',
            is_verified_b2b=False
        ).count(),
    }

def get_order_metrics():
    """–ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤"""
    now = timezone.now()
    today = now.date()
    week_ago = now - timedelta(days=7)
    
    return {
        'today': Order.objects.filter(created_at__date=today).count(),
        'week': Order.objects.filter(created_at__gte=week_ago).count(),
        'pending': Order.objects.filter(status='pending').count(),
        'processing': Order.objects.filter(status='processing').count(),
        'shipped': Order.objects.filter(status='shipped').count(),
    }

def get_import_metrics():
    """–ú–µ—Ç—Ä–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ 1–°"""
    last_import = ImportSession.objects.order_by('-started_at').first()
    
    metrics = {
        'last_import': last_import,
        'active_imports': ImportSession.objects.filter(
            status='running'
        ).count(),
    }
    
    if last_import:
        metrics.update({
            'last_status': last_import.status,
            'last_time': last_import.started_at,
            'last_error': last_import.error_message if last_import.status == 'failed' else None,
        })
    
    return metrics

def get_problem_metrics():
    """–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏"""
    now = timezone.now()
    day_ago = now - timedelta(hours=24)
    
    metrics = {
        'incomplete_imports': ImportSession.objects.filter(
            status='failed',
            started_at__gte=day_ago
        ).count(),
    }
    
    # SyncConflict –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ Story 3.2.2
    # –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ–±–∞–≤–∏—Ç—å:
    # try:
    #     from apps.common.models import SyncConflict
    #     metrics['sync_conflicts'] = SyncConflict.objects.filter(
    #         is_resolved=False
    #     ).count()
    # except ImportError:
    #     pass
    
    return metrics
```

### AdminSite Customization

**–§–∞–π–ª:** `backend/apps/common/admin.py`

```python
from django.contrib import admin
from django.contrib.admin import AdminSite
from .admin_dashboard import get_dashboard_metrics

class CustomAdminSite(AdminSite):
    site_header = 'FREESPORT Admin Panel'
    site_title = 'FREESPORT Admin'
    index_title = 'Platform Dashboard'
    
    def index(self, request, extra_context=None):
        """Override index –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫"""
        extra_context = extra_context or {}
        extra_context['dashboard_metrics'] = get_dashboard_metrics()
        return super().index(request, extra_context)

# –ó–∞–º–µ–Ω–∏—Ç—å default admin site
admin.site = CustomAdminSite()
admin.autodiscover()
```

### Custom Template

**–§–∞–π–ª:** `backend/templates/admin/index.html`

```django
{% extends "admin/index.html" %}
{% load static %}

{% block content %}
<div class="dashboard-metrics" style="margin-bottom: 30px;">
    <h2>üìä Platform Metrics</h2>
    
    <div class="row">
        <!-- Users Widget -->
        <div class="col-md-3">
            <div class="metric-card">
                <h3>üë• Users</h3>
                <ul>
                    <li><strong>Active Today:</strong> {{ dashboard_metrics.users.active_today }}</li>
                    <li><strong>New This Week:</strong> {{ dashboard_metrics.users.new_this_week }}</li>
                    <li><strong>Pending B2B:</strong> 
                        <a href="{% url 'admin:users_user_changelist' %}?is_verified_b2b__exact=0&role__exact=wholesale">
                            {{ dashboard_metrics.users.pending_verification }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Orders Widget -->
        <div class="col-md-3">
            <div class="metric-card">
                <h3>üì¶ Orders</h3>
                <ul>
                    <li><strong>Today:</strong> {{ dashboard_metrics.orders.today }}</li>
                    <li><strong>This Week:</strong> {{ dashboard_metrics.orders.week }}</li>
                    <li><strong>Pending:</strong> 
                        <a href="{% url 'admin:orders_order_changelist' %}?status__exact=pending">
                            {{ dashboard_metrics.orders.pending }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Import Widget -->
        <div class="col-md-3">
            <div class="metric-card">
                <h3>üîÑ 1C Import</h3>
                {% if dashboard_metrics.imports.last_import %}
                    <ul>
                        <li><strong>Last Status:</strong> 
                            <span class="status-{{ dashboard_metrics.imports.last_status }}">
                                {{ dashboard_metrics.imports.last_status }}
                            </span>
                        </li>
                        <li><strong>Last Run:</strong> {{ dashboard_metrics.imports.last_time|timesince }} ago</li>
                        <li><strong>Active Imports:</strong> {{ dashboard_metrics.imports.active_imports }}</li>
                    </ul>
                {% else %}
                    <p>No imports yet</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Problems Widget -->
        <div class="col-md-3">
            <div class="metric-card alert-warning">
                <h3>‚ö†Ô∏è Problems</h3>
                <ul>
                    <li><strong>Failed Imports (24h):</strong> 
                        <a href="{% url 'admin:products_importsession_changelist' %}?status__exact=failed">
                            {{ dashboard_metrics.problems.incomplete_imports }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{{ block.super }}

<style>
.metric-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.metric-card h3 {
    margin-top: 0;
    font-size: 16px;
}
.metric-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.metric-card li {
    padding: 5px 0;
}
.status-completed { color: green; }
.status-failed { color: red; }
.status-running { color: orange; }
.alert-warning {
    border-left: 4px solid #ff9800;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ */
@media (max-width: 768px) {
    .row { flex-direction: column; }
    .col-md-3 { width: 100%; }
}
</style>
{% endblock %}
```

### Cache Invalidation (Signals)

**–°–æ–∑–¥–∞—Ç—å:** `backend/apps/common/signals.py`

```python
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.core.cache import cache
from django.contrib.auth import get_user_model
from apps.orders.models import Order
from apps.products.models import ImportSession

User = get_user_model()

@receiver(post_save, sender=User)
@receiver(post_save, sender=Order)
@receiver(post_save, sender=ImportSession)
def invalidate_dashboard_cache(sender, instance, **kwargs):
    """Invalidate dashboard cache –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏"""
    cache.delete('admin_dashboard_metrics')
```

**–ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ apps.py:**

```python
# backend/apps/common/apps.py
from django.apps import AppConfig

class CommonConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.common'
    
    def ready(self):
        import apps.common.signals
```

### Performance Testing

**Load Test Script (locust):**

```python
# backend/tests/performance/locustfile.py
from locust import HttpUser, task, between

class AdminUser(HttpUser):
    wait_time = between(1, 3)
    
    def on_start(self):
        # Login as admin
        self.client.post('/admin/login/', {
            'username': 'admin@test.com',
            'password': 'testpass',
        })
    
    @task
    def view_dashboard(self):
        self.client.get('/admin/')
```

**–ó–∞–ø—É—Å–∫:**

```bash
cd backend
locust -f tests/performance/locustfile.py --users 10 --spawn-rate 2 --host http://localhost:8000
```

### Production Monitoring

**Middleware –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ dashboard:**

**–§–∞–π–ª:** `backend/apps/common/middleware.py`

```python
import time
import logging
from django.core.cache import cache
from django.utils.deprecation import MiddlewareMixin

logger = logging.getLogger('dashboard.performance')

class DashboardPerformanceMiddleware(MiddlewareMixin):
    """
    Middleware –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ admin dashboard –≤ production.
    –õ–æ–≥–∏—Ä—É–µ—Ç response time, cache hits/misses, errors.
    """
    
    def process_request(self, request):
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ admin dashboard
        if request.path == '/admin/' and request.user.is_authenticated:
            request._dashboard_start_time = time.time()
    
    def process_response(self, request, response):
        # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è admin dashboard
        if hasattr(request, '_dashboard_start_time'):
            duration = time.time() - request._dashboard_start_time
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º cache hit/miss
            cache_status = 'hit' if cache.get('admin_dashboard_metrics') else 'miss'
            
            # Structured logging –¥–ª—è production
            logger.info(
                'Dashboard request',
                extra={
                    'user': request.user.email,
                    'response_time_ms': round(duration * 1000, 2),
                    'cache_status': cache_status,
                    'status_code': response.status_code,
                    'path': request.path,
                }
            )
            
            # Warning –µ—Å–ª–∏ response time –ø—Ä–µ–≤—ã—à–∞–µ—Ç 500ms
            if duration > 0.5:
                logger.warning(
                    f'Slow dashboard response: {duration*1000:.2f}ms',
                    extra={
                        'user': request.user.email,
                        'response_time_ms': round(duration * 1000, 2),
                    }
                )
        
        return response
    
    def process_exception(self, request, exception):
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ dashboard
        if hasattr(request, '_dashboard_start_time'):
            logger.error(
                f'Dashboard error: {exception}',
                extra={
                    'user': request.user.email if request.user.is_authenticated else 'anonymous',
                    'exception_type': type(exception).__name__,
                    'path': request.path,
                },
                exc_info=True
            )
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ logging –≤ settings:**

**–§–∞–π–ª:** `backend/freesport/settings/base.py` (–∏–ª–∏ production.py)

```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'json': {
            '()': 'pythonjsonlogger.jsonlogger.JsonFormatter',
            'format': '%(asctime)s %(name)s %(levelname)s %(message)s',
        },
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'dashboard_file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/dashboard_performance.log',
            'maxBytes': 10485760,  # 10MB
            'backupCount': 5,
            'formatter': 'json' if not DEBUG else 'verbose',
        },
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'dashboard.performance': {
            'handlers': ['dashboard_file', 'console'],
            'level': 'INFO',
            'propagate': False,
        },
        'dashboard.metrics': {
            'handlers': ['dashboard_file', 'console'],
            'level': 'WARNING',
            'propagate': False,
        },
    },
}
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ admin_dashboard.py –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**

```python
import logging

logger = logging.getLogger('dashboard.metrics')

def get_dashboard_metrics():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è dashboard.
    –ö—ç—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç.
    """
    cache_key = 'admin_dashboard_metrics'
    metrics = cache.get(cache_key)
    
    if metrics is None:
        try:
            metrics = {
                'users': get_user_metrics(),
                'orders': get_order_metrics(),
                'imports': get_import_metrics(),
                'problems': get_problem_metrics(),
            }
            cache.set(cache_key, metrics, 300)  # 5 –º–∏–Ω—É—Ç TTL
            logger.info('Dashboard metrics calculated and cached')
        except Exception as e:
            logger.error(f'Error calculating dashboard metrics: {e}', exc_info=True)
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
            metrics = {
                'users': {},
                'orders': {},
                'imports': {},
                'problems': {},
            }
    
    return metrics
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware –≤ settings:**

```python
# backend/freesport/settings/base.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'apps.common.middleware.DashboardPerformanceMiddleware',  # –î–æ–±–∞–≤–∏—Ç—å
]
```

**Requirements –¥–ª—è production logging:**

```txt
# requirements/production.txt
python-json-logger==2.0.7  # –î–ª—è structured JSON logging
```

### Testing

**Test Location:** `backend/tests/unit/test_admin_dashboard.py`

**Testing Standards:**
- Framework: pytest-django
- Coverage target: >80%
- Mock external dependencies
- Test cache behavior

**Test Cases:**

```python
# backend/apps/common/tests/test_admin_dashboard.py
import pytest
from django.core.cache import cache
from apps.common.admin_dashboard import get_user_metrics, get_dashboard_metrics

@pytest.mark.django_db
class TestDashboardMetrics:
    
    def setup_method(self):
        cache.clear()
    
    def test_get_user_metrics(self):
        metrics = get_user_metrics()
        assert 'active_today' in metrics
        assert 'new_this_week' in metrics
        assert 'pending_verification' in metrics
    
    def test_dashboard_caching(self):
        # First call - should hit database
        metrics1 = get_dashboard_metrics()
        
        # Second call - should hit cache
        metrics2 = get_dashboard_metrics()
        
        assert metrics1 == metrics2
        assert cache.get('admin_dashboard_metrics') is not None
    
    def test_cache_invalidation(self, django_user_model):
        # Get metrics - populate cache
        get_dashboard_metrics()
        
        # Create user - should invalidate cache
        django_user_model.objects.create_user('test@test.com', 'pass')
        
        assert cache.get('admin_dashboard_metrics') is None
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation from Epic 9 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

### Debug Log References

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

### Completion Notes List

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

### File List

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

---

## QA Results

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è QA Agent)
