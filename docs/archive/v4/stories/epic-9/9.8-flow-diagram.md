# Flow Diagram - Для Story 9.8 Task 7.2

Этот файл содержит детальную flow диаграмму для Technical Documentation.

---

# Архитектура рефакторинга импорта

## Flow Диаграмма: Запуск импорта из 1С

```
┌─────────────────────────────────────────────────────────────┐
│                        ПОЛЬЗОВАТЕЛЬ                         │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  1. Открывает /admin/integrations/import_1c/                │
│     (ImportFrom1CAdmin.changelist_view GET)                 │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  2. Отображается форма с 4 типами импорта                   │
│     ┌─────────────────────────────────────────────────┐     │
│     │ ○ Полный каталог                                │     │
│     │ ○ Только остатки                                │     │
│     │ ○ Только цены                                   │     │
│     │ ○ Клиенты                                       │     │
│     └─────────────────────────────────────────────────┘     │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  3. Пользователь выбирает тип и нажимает "Запустить"        │
│     POST /admin/integrations/import_1c/                     │
│     import_type = 'catalog' | 'stocks' | 'prices' | 'customers' │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  4. Валидация зависимостей (_validate_dependencies)         │
│     if import_type in ['stocks', 'prices']:                 │
│         if not Product.objects.exists():                    │
│             return error                                    │
└──────────────────────────┬──────────────────────────────────┘
                           │
                    ┌──────┴──────┐
                    │             │
                    ▼             ▼
            ┌───────────┐   ┌─────────────┐
            │  ОШИБКА   │   │   УСПЕХ     │
            └─────┬─────┘   └──────┬──────┘
                  │                │
                  ▼                ▼
         ┌────────────────┐  ┌──────────────────────────────┐
         │ Показать       │  │ 5. Проверка Redis Lock       │
         │ сообщение      │  │    redis_conn = get_redis... │
         │ об ошибке      │  │    lock = redis_conn.lock(   │
         │ "Сначала       │  │        "import_catalog_lock",│
         │  импортируйте  │  │        timeout=3600)         │
         │  каталог"      │  └──────────┬───────────────────┘
         │                │             │
         │ Редирект       │      ┌──────┴──────┐
         │ обратно        │      │             │
         │ на форму       │      ▼             ▼
         └────────────────┘  ┌───────────┐   ┌─────────────┐
                             │  ЗАНЯТ    │   │  СВОБОДЕН   │
                             └─────┬─────┘   └──────┬──────┘
                                   │                │
                                   ▼                ▼
                          ┌────────────────┐  ┌──────────────────────────────┐
                          │ Предупреждение │  │ 6. Создание ImportSession    │
                          │ "Импорт уже    │  │    session = ImportSession(  │
                          │  запущен"      │  │        import_type=type,     │
                          │                │  │        status=STARTED)       │
                          │ Редирект       │  │    session.save()            │
                          │ обратно        │  └──────────┬───────────────────┘
                          └────────────────┘             │
                                                         ▼
                                              ┌──────────────────────────────┐
                                              │ 7. Запуск Celery задачи      │
                                              │    task = run_selective_...  │
                                              │        .delay(               │
                                              │            [import_type],    │
                                              │            data_dir)         │
                                              │    session.celery_task_id =  │
                                              │        task.id               │
                                              │    session.save()            │
                                              └──────────┬───────────────────┘
                                                         │
                                                         ▼
                                              ┌──────────────────────────────┐
                                              │ 8. Success message + редирект│
                                              │    messages.success(         │
                                              │        "Импорт запущен       │
                                              │         Task ID: {task.id}   │
                                              │         Session ID: {s.id}") │
                                              │                              │
                                              │    return redirect(          │
                                              │        '/admin/.../session/')│
                                              └──────────┬───────────────────┘
                                                         │
                                                         ▼
┌─────────────────────────────────────────────────────────────┐
│  9. Страница сессий (ImportSessionAdmin)                    │
│     URL: /admin/integrations/session/                       │
│     ┌───────────────────────────────────────────────────┐   │
│     │ ID │ Тип    │ Статус │ Celery Task │ Начало    │   │
│     │ 42 │ CATALOG│ STARTED│ ⏳ PENDING  │ 14:30:15  │   │
│     └───────────────────────────────────────────────────┘   │
│     - JavaScript автообновление активируется                │
│     - AJAX запрос каждые 5 секунд                           │
│     - Обновление статуса: ⏳ → ▶️ → ✅                      │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  CELERY WORKER (асинхронно, параллельно)                    │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 10. run_selective_import_task(import_types, data_dir) │  │
│  │                                                        │  │
│  │  try:                                                  │  │
│  │      # Обновляем статус                               │  │
│  │      session.status = STARTED                         │  │
│  │      session.save()                                   │  │
│  │                                                        │  │
│  │      # Вызываем management команду                    │  │
│  │      if 'catalog' in import_types:                    │  │
│  │          call_command(                                │  │
│  │              'import_catalog_from_1c',                │  │
│  │              file_type='all',                         │  │
│  │              data_dir=data_dir)                       │  │
│  │                                                        │  │
│  │      # Парсинг XML файлов                             │  │
│  │      parser = XMLDataParser()                         │  │
│  │      goods_data = parser.parse_goods_xml(...)         │  │
│  │      offers_data = parser.parse_offers_xml(...)       │  │
│  │                                                        │  │
│  │      # Обработка данных                               │  │
│  │      processor = ProductDataProcessor()               │  │
│  │      processor.process_products(goods_data)           │  │
│  │      processor.process_offers(offers_data)            │  │
│  │                                                        │  │
│  │      # Обновляем результат                            │  │
│  │      session.status = COMPLETED                       │  │
│  │      session.finished_at = now()                      │  │
│  │      session.report_details = {                       │  │
│  │          'products_created': 6200,                    │  │
│  │          'execution_time': '15m 23s'                  │  │
│  │      }                                                 │  │
│  │      session.save()                                   │  │
│  │                                                        │  │
│  │  except Exception as e:                               │  │
│  │      session.status = FAILED                          │  │
│  │      session.error_message = str(e)                   │  │
│  │      session.save()                                   │  │
│  │      raise                                            │  │
│  │                                                        │  │
│  │  finally:                                             │  │
│  │      # Освобождаем Redis lock                        │  │
│  │      lock.release()                                   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  11. Пользователь видит обновленный статус                  │
│      (автообновление JavaScript)                            │
│      ┌───────────────────────────────────────────────────┐  │
│      │ ID │ Тип    │ Статус    │ Celery Task │ Время  │  │
│      │ 42 │ CATALOG│ COMPLETED │ ✅ SUCCESS  │ 15m23s │  │
│      └───────────────────────────────────────────────────┘  │
│      - Автообновление останавливается                       │
│      - Можно кликнуть на ID для деталей                     │
└─────────────────────────────────────────────────────────────┘
```

---

## Компоненты системы

### Frontend (Django Admin)

**ImportFrom1CAdmin** - страница запуска импорта
- Файл: `backend/apps/integrations/admin.py`
- URL: `/admin/integrations/import_1c/`
- Методы:
  - `changelist_view(request)` - GET/POST обработка
  - `_validate_dependencies(import_type)` - валидация
  - `_check_redis_lock()` - проверка блокировки

**ImportSessionAdmin** - страница мониторинга
- Файл: `backend/apps/integrations/admin.py`
- URL: `/admin/integrations/session/`
- Методы:
  - `celery_task_status(obj)` - отображение статуса задачи
  - `colored_status(obj)` - цветной статус сессии
  - `duration(obj)` - длительность импорта

**JavaScript автообновление**
- Файл: `backend/static/admin/js/import_session_auto_refresh.js`
- Функции:
  - `startAutoRefresh()` - запуск polling
  - `updateTaskStatus()` - AJAX обновление
  - `stopAutoRefresh()` - остановка при завершении

---

### Backend (Django)

**Models:**
- `ImportSession` - основная модель сессий
  - Поля: import_type, status, celery_task_id, started_at, finished_at, report_details, error_message
- `IntegrationImportSession` - proxy модель для admin

**Celery Tasks:**
- `run_selective_import_task(import_types, data_dir)` - асинхронный импорт
  - Вызывает management команды
  - Обновляет статус сессии
  - Обрабатывает ошибки

---

### Management Commands (Epic 3)

**import_catalog_from_1c**
- Файл: `backend/apps/products/management/commands/import_catalog_from_1c.py`
- Параметры: `--file-type`, `--data-dir`, `--chunk-size`, `--dry-run`
- Функции:
  - Парсинг XML файлов (goods, offers, prices, rests)
  - Обработка категорий, брендов, свойств
  - Bulk создание/обновление записей

**import_customers_from_1c**
- Файл: `backend/apps/users/management/commands/import_customers_from_1c.py`
- Параметры: `--file`
- Функции:
  - Парсинг contragents.xml
  - Создание/обновление User записей
  - Логирование в CustomerSyncLog

**Parsers:**
- `XMLDataParser` - парсинг CommerceML 3.1
  - `parse_goods_xml()`, `parse_offers_xml()`, `parse_prices_xml()`, `parse_rests_xml()`

**Processors:**
- `ProductDataProcessor` - обработка товаров
  - `process_products()`, `process_categories()`, `process_brands()`
- `CustomerDataProcessor` - обработка клиентов
  - `process_customers()`

---

### Infrastructure

**Redis:**
- Distributed lock: `import_catalog_lock` (timeout: 3600 сек)
- Celery broker: очередь задач

**Celery Worker:**
- Асинхронное выполнение задач
- Retry механизм при ошибках
- Логирование в Celery logs

**PostgreSQL:**
- Хранение ImportSession, Product, User
- Транзакции для целостности данных

---

## Последовательность действий (Summary)

1. **Пользователь** открывает страницу импорта
2. **Django** отображает форму с типами импорта
3. **Пользователь** выбирает тип и запускает
4. **Django** валидирует зависимости
5. **Django** проверяет Redis lock
6. **Django** создает ImportSession
7. **Django** запускает Celery задачу
8. **Django** редиректит на страницу сессий
9. **JavaScript** активирует автообновление
10. **Celery Worker** выполняет импорт асинхронно
11. **JavaScript** показывает обновленный статус

---

## Ключевые особенности

### Разделение ответственности
- **Страница импорта** - только запуск
- **Страница сессий** - только мониторинг

### Асинхронность
- Импорт не блокирует UI
- Пользователь видит прогресс в реальном времени

### Надежность
- Redis lock предотвращает параллельные импорты
- Валидация зависимостей предотвращает ошибки
- Retry механизм в Celery

### Мониторинг
- Автообновление статуса каждые 5 секунд
- Детальные отчеты в report_details
- Логирование ошибок в error_message
