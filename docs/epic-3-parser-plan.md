# План разработки парсеров для данных из 1С (Epic 3) - Версия 3.0

Этот документ описывает пошаговый план разработки парсеров для обработки данных в формате CommerceML 3.1 на основе фактической структуры выгрузки и архитектурного ревью.

## Цели

1.  Разработать модульные и последовательные парсеры для каждой сущности.
2.  Обеспечить корректное создание и обновление моделей Django на основе данных из XML.
3.  Гарантировать целостность данных и заложить основу для будущего перехода на API.

## Архитектурные принципы

При разработке необходимо следовать следующим принципам, выработанным в ходе архитектурного ревью:

1.  **Использование "Сессий импорта"**:
    -   **Задача:** Для обеспечения целостности данных при сбоях, каждая операция импорта должна проходить в рамках сессии.
    -   **Реализация:** Создать модель `ImportSession`. Все создаваемые/обновляемые объекты должны быть привязаны к ID активной сессии. В случае сбоя это позволит легко откатить изменения.

2.  **Абстрагирование сервисного слоя**:
    -   **Задача:** Упростить будущий переход с файлового обмена на API.
    -   **Реализация:** Разделить логику на два слоя: `Парсер` (читает XML и приводит к внутреннему формату, например, dict) и `Процессор` (принимает внутренний формат и работает с моделями Django). В будущем нужно будет заменить только `Парсер`.

## Фазы разработки

Разработка будет вестись поэтапно, в порядке зависимости данных.

### Фаза 1: Парсинг справочников

На этом этапе создаются парсеры для всех базовых справочников.

1.  **Задача 1.1 - 1.3:** Парсинг `units.xml`, `storages.xml`, `priceLists.xml` (без изменений).

2.  **Задача 1.4: Справочники свойств (`propertiesGoods/`, `propertiesOffers/`)**
    -   (Без изменений) Создать модели `Property` и `PropertyValue`.
    -   (Без изменений) Реализовать парсер для директорий `propertiesGoods` и `propertiesOffers`.
    -   **[Дополнение]** В ходе парсинга, если встречается свойство с наименованием "Бренд" (или похожим), его значения (`<ВариантыЗначений>`) должны использоваться для создания/обновления записей в модели `Brand`.

### Фаза 2: Парсинг каталога

1.  **Задача 2.1: Парсинг категорий (`groups.xml`)** (без изменений).

2.  **Задача 2.2: Парсинг товаров (`goods/xml`)**
    -   (Без изменений) Парсер должен извлекать базовые поля, связывать с категорией и единицами измерения.
    -   **[Дополнение]** При обработке `<ЗначенияСвойств>`, парсер должен находить свойство "Бренд" и устанавливать связь `product.brand` с соответствующей записью в модели `Brand`.

### Фаза 3: Парсинг торговых предложений (SKU) и связанных данных

1.  **Задача 3.1: Парсинг предложений (`offers.xml`)** (без изменений).

2.  **Задача 3.2: Парсинг цен (`prices.xml`)**
    -   (Без изменений) Создать/обновить модель `Price`.
    -   (Без изменений) Реализовать парсер для `prices.xml`.
    -   **[Дополнение]** В логику парсера добавить правило: если для товара не найдена цена для роли `federation_rep`, использовать для этой роли значение розничной цены (`retail_price` / "РРЦ"). Этот случай должен быть залогирован.

3.  **Задача 3.3: Парсинг остатков (`rests.xml`)** (без изменений).

### Фаза 4: Финализация и тестирование

1.  **Задача 4.1: Создание главной management-команды.**
    -   (Без изменений) Создать команду `import_1c`.
    -   **[Дополнение]** Команда должна в начале своей работы создавать новую запись `ImportSession` и в конце, в случае успеха, помечать ее как `completed`.

2.  **Задача 4.2: Написание тестов.** (без изменений).

3.  **Задача 4.3: Логирование и обработка ошибок.** (без изменений).

## Согласование

После ознакомления с этим планом и документом `docs/epic-3-data-analysis.md` необходимо провести согласование для подтверждения подхода и начала разработки.