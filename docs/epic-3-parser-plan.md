# План разработки парсеров для данных из 1С (Epic 3) - Версия 2.0

Этот документ описывает пошаговый план разработки парсеров для обработки данных в формате CommerceML 3.1 на основе фактической структуры выгрузки.

## Цели

1.  Разработать модульные и последовательные парсеры для каждой сущности (справочники, категории, товары, SKU, цены, остатки).
2.  Обеспечить корректное создание и обновление моделей Django на основе данных из XML.
3.  Гарантировать целостность данных и правильное установление связей между моделями.

## Фазы разработки

Разработка будет вестись поэтапно, в порядке зависимости данных.

### Фаза 1: Парсинг справочников

На этом этапе создаются парсеры для всех базовых справочников. Это необходимо, так как все последующие сущности будут ссылаться на них.

1.  **Задача 1.1: Справочник единиц измерения (`units.xml`)**
    -   Создать/обновить модель `Unit`.
    -   Реализовать парсер для `units/units.xml`, который заполняет таблицу единиц измерения.

2.  **Задача 1.2: Справочник складов (`storages.xml`)**
    -   Создать/обновить модель `Storage`.
    -   Реализовать парсер для `storages/storages.xml` для заполнения таблицы складов.

3.  **Задача 1.3: Справочник типов цен (`priceLists.xml`)**
    -   Создать/обновить модель `PriceType`.
    -   Реализовать парсер для `priceLists/priceLists.xml` для заполнения таблицы типов цен.

4.  **Задача 1.4: Справочники свойств (`propertiesGoods/`, `propertiesOffers/`)**
    -   Создать/обновить модели `Property` и `PropertyValue`.
    -   Реализовать парсер, который итерируется по всем файлам в директориях `propertiesGoods` и `propertiesOffers`.
    -   Парсер должен извлекать как сами свойства (`<Свойство>`), так и их возможные значения (`<ВариантыЗначений>`).

### Фаза 2: Парсинг каталога

1.  **Задача 2.1: Парсинг категорий (`groups.xml`)**
    -   Создать/обновить модель `Category` с поддержкой вложенности (например, через `django-mptt`).
    -   Реализовать рекурсивный парсер для `groups/groups.xml`, который строит дерево категорий.

2.  **Задача 2.2: Парсинг товаров (`goods/goods.xml`)**
    -   Создать/обновить модель `Product`.
    -   Реализовать парсер для `goods/goods.xml`.
    -   Парсер должен:
        -   Извлекать базовые поля: `<Ид>`, `<Артикул>`, `<Наименование>`, `<Описание>`.
        -   Связывать товар с категорией по ID из узла `<Группы>`.
        -   Связывать товар с базовой единицей измерения по ID из `<БазоваяЕдиница>`.
        -   Обрабатывать блок `<ЗначенияРеквизитов>`.
        -   Обрабатывать блок `<ЗначенияСвойств>`, находя соответствующие значения в `PropertyValue`.
        -   Сохранять пути к изображениям.

### Фаза 3: Парсинг торговых предложений (SKU) и связанных данных

1.  **Задача 3.1: Парсинг предложений (`offers.xml`)**
    -   Создать/обновить модель `SKU` (или `Offer`), связанную с `Product`.
    -   Реализовать парсер для `offers/offers.xml`.
    -   Парсер должен:
        -   Извлекать составной `<Ид>` и по нему находить родительский `Product`.
        -   Извлекать `<Наименование>` и другие поля.
        -   Парсить `<ХарактеристикиТовара>` и сохранять их как атрибуты `SKU`.

2.  **Задача 3.2: Парсинг цен (`prices.xml`)**
    -   Создать/обновить модель `Price`, связанную с `SKU` (или `Product`) и `PriceType`.
    -   Реализовать парсер для `prices/prices.xml`.
    -   Парсер должен для каждого предложения находить соответствующий `SKU` по `<Ид>` и создавать/обновлять записи о ценах для разных типов цен.

3.  **Задача 3.3: Парсинг остатков (`rests.xml`)**
    -   Создать/обновить модель `Stock`, связанную с `SKU` (или `Product`) и `Storage`.
    -   Реализовать парсер для `rests/rests.xml`.
    -   Парсер должен для каждого предложения находить `SKU` по `<Ид>` и обновлять количество на соответствующем складе.

### Фаза 4: Финализация и тестирование

1.  **Задача 4.1: Создание главной management-команды.**
    -   Создать основную Django management-команду (`import_1c`), которая будет последовательно вызывать все созданные парсеры в правильном порядке.
    -   Добавить аргументы для команды (например, путь к директории с выгрузкой).

2.  **Задача 4.2: Написание тестов.**
    -   Написать unit-тесты для каждого парсера, проверяя корректность извлечения данных из тестовых XML.
    -   Написать интеграционные тесты, которые запускают полный цикл импорта и проверяют целостность данных в БД.

3.  **Задача 4.3: Логирование и обработка ошибок.**
    -   Убедиться, что все парсеры и главная команда подробно логируют свои действия, включая ошибки (например, ненайденные ID, неверный формат данных).

## Согласование

После ознакомления с этим планом и документом `docs/epic-3-data-analysis.md` необходимо провести согласование для подтверждения подхода и начала разработки.