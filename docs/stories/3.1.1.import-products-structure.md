# Story 3.1.1: import-products-structure

## Status
Ready for Development

## Story
**As a** разработчик,
**I want** создать систему импорта товаров из 1С,
**so that** каталог автоматически синхронизируется с ERP системой.

## Acceptance Criteria

1. Создана Django management команда `import_catalog_from_1c`
2. Реализован базовый парсер данных товаров (XML/JSON)
3. Добавлены поля интеграции в модель Product
4. Поддержано ролевое ценообразование для 7 ролей
5. Созданы валидаторы для данных товаров
6. Настроено логирование процесса импорта
7. Написаны unit и integration тесты

### Детальные задачи:

- [ ] Создать management команду `import_catalog_from_1c.py` (AC: 1)
  - [ ] Добавить параметры: --file, --dry-run, --chunk-size
  - [ ] Реализовать валидацию параметров
  - [ ] Настроить прогресс-бар для операции
  - [ ] Добавить подробный help text

- [ ] Реализовать базовый парсер данных (AC: 2)
  - [ ] Создать класс `DataParser` в `apps/products/services/`
  - [ ] Поддержать XML формат (CommerceML приоритет)
  - [ ] Добавить fallback для JSON формата
  - [ ] Реализовать валидацию структуры файла

- [ ] Обновить модель Product для интеграции (AC: 3)
  - [ ] Добавить поле `onec_id = CharField(max_length=100, unique=True)`
  - [ ] Добавить поле `sync_status = CharField(choices=SYNC_STATUSES)`
  - [ ] Добавить поле `last_sync_at = DateTimeField(null=True)`
  - [ ] Создать миграцию для новых полей

- [ ] Реализовать ролевое ценообразование (AC: 4)
  - [ ] Поддержать все 7 ролей: retail, wholesale_level1-3, trainer, federation_rep, admin
  - [ ] Добавить fallback к retail_price при отсутствии специальной цены
  - [ ] Валидировать положительные значения цен
  - [ ] Создать тесты для всех ролей ценообразования

- [ ] Создать валидаторы данных (AC: 5)
  - [ ] Валидатор корректности данных товара
  - [ ] Валидатор уникальности onec_id
  - [ ] Валидатор обязательных полей
  - [ ] Валидатор ценовых данных

- [ ] Настроить логирование (AC: 6)
  - [ ] Создать ImportLog модель для аудита
  - [ ] Логировать начало/конец операции импорта
  - [ ] Логировать ошибки валидации
  - [ ] Логировать статистику обработанных записей

- [ ] Создать тесты (AC: 7)
  - [ ] Unit тесты для парсера (`@pytest.mark.unit`)
  - [ ] Unit тесты для валидаторов
  - [ ] Integration тесты для команды (`@pytest.mark.integration`)
  - [ ] Использовать полную изоляцию БД в тестах

## Definition of Done
- [ ] Команда успешно импортирует тестовые данные товаров
- [ ] Все тесты проходят с покрытием ≥90%
- [ ] Логируются все операции импорта
- [ ] Код прошел code review
- [ ] Документация обновлена

## Dev Notes

### Story Context
**Epic Integration Points:**
- Интегрируется с: 1С:Управление торговлей
- Технология: Django Management Commands + XML/JSON parsing
- Следует паттерну: FREESPORT ролевое ценообразование
- Точки касания: Product model, User roles, sync logging

### Technical Architecture
```python
# apps/products/management/commands/import_catalog_from_1c.py
class Command(BaseCommand):
    def add_arguments(self, parser):
        parser.add_argument('--file', required=True)
        parser.add_argument('--dry-run', action='store_true')
    
    def handle(self, *args, **options):
        # Import logic with progress tracking
```

### Dependencies
- **Blocks:** Story 3.1.2 (скрипты загрузки)
- **Depends on:** Database design (Story 1.8)
- **Related:** 1С integration architecture

## Story Points
**8** (High complexity due to 1С integration setup)

## Priority
**High** - Критический путь для Epic 3

## Labels
`epic-3` `1c-integration` `product-management` `django-commands`