# История 28.3: Восстановление пароля (Password Reset)

**Эпик**: [28: Реализация системы аутентификации](../../epics/epic-28/epic-28-authentication.md)
**Статус**: Draft
**Приоритет**: Medium

## Пользовательская история (User Story)

**Как** пользователь,
**Я хочу** восстановить пароль, если я его забыл,
**Чтобы** получить обратно доступ к своему аккаунту.

## Контекст истории

**Интеграция с существующей системой:**

- **Интегрируется с**: `authService`, Backend Password Reset API
- **Технологии**: Next.js 15.4.6 App Router, TypeScript, Tailwind CSS, React Hook Form 7.62.0, Zod
- **Паттерны**: Паттерн Service-Repository для вызовов API, Zustand для глобального состояния
- **Точки взаимодействия**:
  - `src/app/(auth)/password-reset/page.tsx` (Запрос сброса)
  - `src/app/(auth)/password-reset/confirm/[uid]/[token]/page.tsx` (Подтверждение сброса)
  - `src/services/authService.ts` (Добавление новых методов)
  - `src/schemas/authSchemas.ts` (Добавление новых схем)

## Критерии приемки (Acceptance Criteria)

### Functional Requirements

1. **Password Reset Request**: Пользователь вводит Email на странице `/password-reset`. При отправке формы вызывается API `POST /auth/password-reset/`. UI показывает сообщение "Если аккаунт с таким email существует, ссылка для сброса пароля была отправлена" (security best practice - не раскрывать существование email).

2. **Password Reset Confirmation**: Страница `/password-reset/confirm/[uid]/[token]/` принимает параметры `uid` и `token` из URL. Пользователь вводит новый пароль и подтверждение пароля. При успехе происходит редирект на `/login` с toast-сообщением "Пароль успешно изменен".

3. **Token Validation**: При загрузке страницы подтверждения выполняется проверка валидности токена через `GET /auth/password-reset/validate-token/`. Если токен невалиден или истёк — показывается сообщение об ошибке с ссылкой "Запросить новую ссылку".

4. **Client-side Validation**: Password strength требования идентичны регистрации: минимум 8 символов, хотя бы 1 цифра, 1 заглавная буква. Проверка совпадения нового пароля и подтверждения.

5. **Error Handling**: Обработка ошибок API: 400 (невалидные данные), 404 (токен не найден), 410 (токен истёк), 500 (ошибка сервера). UI показывает понятные сообщения для пользователя.

### Integration Requirements

6. **authService Integration**: Добавить методы `requestPasswordReset(email)` и `confirmPasswordReset(uid, token, password)` в `authService.ts`.

7. **Backend Compatibility**: API endpoints должны соответствовать Django REST Framework стандартам или djoser-подобной структуре.

### Quality Requirements

8. **Unit Tests**: Unit-тесты для Zod схем валидации `passwordResetRequestSchema` и `passwordResetConfirmSchema`.

9. **Component Tests**: Компонентные тесты для форм `PasswordResetRequestForm` и `PasswordResetConfirmForm` проверяющие валидацию, loading states, error handling.

10. **Accessibility**: Поля форм имеют правильные `<label>`, сообщения об ошибках связаны через `aria-describedby`. Keyboard navigation работает корректно.

11. **Security**: Пароли отправляются только по HTTPS. Токены не логируются на клиенте. URL с токеном не сохраняется в history после успешного сброса.

## Tasks / Subtasks

### Phase 1: Backend API Endpoints (AC: 6, 7)

> [!IMPORTANT]
> Эта история предполагает, что Backend endpoints уже существуют или будут созданы параллельно. Dev Agent должен проверить наличие endpoints перед началом работы.

- [ ] **Task 1.0**: Проверить и при необходимости создать Backend endpoints
  - [ ] Проверить наличие `/auth/password-reset/` (POST - запрос сброса)
  - [ ] Проверить наличие `/auth/password-reset/confirm/` (POST - подтверждение)
  - [ ] Проверить наличие `/auth/password-reset/validate-token/` (POST - валидация токена)
  - [ ] Если endpoints отсутствуют — создать в `backend/apps/users/views/authentication.py`
  - [ ] Добавить маршруты в `backend/apps/users/urls.py`

### Phase 2: Schemas и Types (AC: 4, 8)

- [ ] **Task 2.1**: Добавить Zod схемы валидации в `src/schemas/authSchemas.ts`
  - [ ] Создать `passwordResetRequestSchema` (email)
  - [ ] Создать `passwordResetConfirmSchema` (password, confirmPassword с проверкой совпадения)
  - [ ] Добавить password strength валидацию (мин. 8 символов, 1 цифра, 1 заглавная)
  - [ ] Экспортировать типы `PasswordResetRequestFormData`, `PasswordResetConfirmFormData`

- [ ] **Task 2.2**: Добавить API типы в `src/types/api.ts`
  - [ ] Добавить `PasswordResetRequest`, `PasswordResetResponse`
  - [ ] Добавить `PasswordResetConfirmRequest`, `PasswordResetConfirmResponse`
  - [ ] Добавить `ValidateTokenRequest`, `ValidateTokenResponse`

### Phase 3: Service Layer (AC: 6)

- [ ] **Task 3.1**: Расширить authService
  - [ ] Добавить метод `requestPasswordReset(email: string): Promise<PasswordResetResponse>`
  - [ ] Добавить метод `confirmPasswordReset(uid: string, token: string, password: string): Promise<PasswordResetConfirmResponse>`
  - [ ] Добавить метод `validateResetToken(uid: string, token: string): Promise<ValidateTokenResponse>`

### Phase 4: Form Components (AC: 1, 2, 4, 5, 10)

- [ ] **Task 4.1**: Создать PasswordResetRequestForm компонент
  - [ ] Создать файл `src/components/auth/PasswordResetRequestForm.tsx`
  - [ ] Использовать React Hook Form с Zod resolver
  - [ ] Интегрировать с `authService.requestPasswordReset()`
  - [ ] Обработать loading state с блокировкой кнопки и спиннером
  - [ ] Показывать success message после отправки
  - [ ] Добавить accessibility attributes (aria-labels, aria-describedby)
  - [ ] Реализовать responsive layout (Tailwind CSS)

- [ ] **Task 4.2**: Создать PasswordResetConfirmForm компонент
  - [ ] Создать файл `src/components/auth/PasswordResetConfirmForm.tsx`
  - [ ] Принимать props: `uid: string`, `token: string`
  - [ ] Использовать React Hook Form с Zod resolver
  - [ ] Валидация token при монтировании компонента
  - [ ] Интегрировать с `authService.confirmPasswordReset()`
  - [ ] Обработать loading state
  - [ ] Обработать ошибки (400, 410 - expired token)
  - [ ] При успехе — redirect на `/login` с toast
  - [ ] Добавить accessibility attributes
  - [ ] Реализовать responsive layout

### Phase 5: Pages (AC: 1, 2, 3)

- [ ] **Task 5.1**: Создать Password Reset Request Page
  - [ ] Создать файл `src/app/(auth)/password-reset/page.tsx`
  - [ ] Использовать `PasswordResetRequestForm` компонент
  - [ ] Добавить ссылку "Вернуться на страницу входа"
  - [ ] Адаптивный layout для mobile/tablet/desktop

- [ ] **Task 5.2**: Создать Password Reset Confirm Page
  - [ ] Создать `src/app/(auth)/password-reset/confirm/[uid]/[token]/page.tsx`
  - [ ] Извлечь `uid` и `token` из URL params
  - [ ] Использовать `PasswordResetConfirmForm` компонент
  - [ ] Показывать loading state при проверке токена
  - [ ] Показывать ошибку если токен невалиден с ссылкой на новый запрос

### Phase 6: Testing (AC: 8, 9, 10)

- [ ] **Task 6.1**: Unit-тесты для schemas
  - [ ] Создать/обновить файл `src/schemas/__tests__/authSchemas.test.ts`
  - [ ] Тесты валидного/невалидного email для passwordResetRequestSchema
  - [ ] Тесты password strength для passwordResetConfirmSchema
  - [ ] Тесты несовпадения password и confirmPassword

- [ ] **Task 6.2**: Component тесты для PasswordResetRequestForm
  - [ ] Создать `src/components/auth/__tests__/PasswordResetRequestForm.test.tsx`
  - [ ] Тест рендера формы с полем email
  - [ ] Тест отображения client-side валидационных ошибок
  - [ ] Тест успешного submit с mock authService
  - [ ] Тест отображения success message после отправки
  - [ ] Тест loading state

- [ ] **Task 6.3**: Component тесты для PasswordResetConfirmForm
  - [ ] Создать `src/components/auth/__tests__/PasswordResetConfirmForm.test.tsx`
  - [ ] Тест рендера формы с полями password и confirmPassword
  - [ ] Тест валидации token при монтировании
  - [ ] Тест отображения ошибки при невалидном/истекшем токене
  - [ ] Тест успешного submit с редиректом
  - [ ] Тест accessibility

- [ ] **Task 6.4**: Добавить MSW моки
  - [ ] Добавить mock handlers в `src/__mocks__/handlers.ts`:
    - `POST /auth/password-reset/` (success 200)
    - `POST /auth/password-reset/confirm/` (success 200, error 410)
    - `POST /auth/password-reset/validate-token/` (success 200, error 404)

### Phase 7: Definition of Done Checklist

- [ ] Request Reset страница реализована и функционирует
- [ ] Confirm Reset страница реализована и функционирует
- [ ] Token validation работает корректно
- [ ] API integration проверена
- [ ] Error states (expired token) обрабатываются
- [ ] Unit/Component тесты пройдены (coverage >= 80%)
- [ ] Accessibility проверена

## Dev Notes

### Relevant Source Tree

**Frontend Password Reset Flow Structure:**

```plaintext
frontend/src/
├── app/(auth)/
│   ├── login/
│   │   └── page.tsx            # EXISTS - add link "Forgot password?"
│   ├── password-reset/
│   │   ├── page.tsx            # CREATE - Request reset page
│   │   └── confirm/
│   │       └── [uid]/
│   │           └── [token]/
│   │               └── page.tsx # CREATE - Confirm reset page
├── components/auth/
│   ├── PasswordResetRequestForm.tsx  # CREATE
│   ├── PasswordResetConfirmForm.tsx  # CREATE
│   └── __tests__/
│       ├── PasswordResetRequestForm.test.tsx  # CREATE
│       └── PasswordResetConfirmForm.test.tsx  # CREATE
├── schemas/
│   └── authSchemas.ts          # UPDATE - add password reset schemas
├── services/
│   └── authService.ts          # UPDATE - add password reset methods
├── types/
│   └── api.ts                  # UPDATE - add password reset types
└── __mocks__/
    └── handlers.ts             # UPDATE - add password reset handlers
```

**Backend Structure (for reference):**

```plaintext
backend/apps/users/
├── views/
│   └── authentication.py       # ADD password reset views
├── serializers.py              # ADD password reset serializers
└── urls.py                     # ADD password reset routes
```

### Existing Code Context

**authService.ts (EXISTING - UPDATE):**

Текущие методы:
- `authService.login(credentials)` - POST /auth/login/
- `authService.register(userData)` - POST /auth/register/
- `authService.logout()` - очистка состояния
- `authService.refreshToken()` - POST /auth/refresh/

Добавить методы:
- `authService.requestPasswordReset(email)` - POST /auth/password-reset/
- `authService.confirmPasswordReset(uid, token, password)` - POST /auth/password-reset/confirm/
- `authService.validateResetToken(uid, token)` - POST /auth/password-reset/validate-token/

**UI Components (EXISTING - REUSE):**

- `<Input label error success helper />` - из `src/components/ui/Input/Input.tsx`
- `<Button variant size loading />` - из `src/components/ui/Button/Button.tsx`
- `<Spinner size />` - из `src/components/ui/Spinner/Spinner.tsx`

### API Endpoints

#### POST /auth/password-reset/

Request:

```json
{
  "email": "user@example.com"
}
```

Success Response (200):

```json
{
  "detail": "Password reset email sent."
}
```

> [!NOTE]
> Всегда возвращает 200 OK даже если email не существует (security best practice - не раскрывать информацию о существующих аккаунтах).

#### POST /auth/password-reset/validate-token/

Request:

```json
{
  "uid": "MQ",
  "token": "c2abcd-123456789abcdef"
}
```

Success Response (200):

```json
{
  "valid": true
}
```

Error Responses:

- 404: `{ "detail": "Invalid token" }`
- 410: `{ "detail": "Token expired" }`

#### POST /auth/password-reset/confirm/

Request:

```json
{
  "uid": "MQ",
  "token": "c2abcd-123456789abcdef",
  "new_password": "NewSecurePass123"
}
```

Success Response (200):

```json
{
  "detail": "Password has been reset successfully."
}
```

Error Responses:

- 400: `{ "new_password": ["Password is too weak"] }`
- 404: `{ "detail": "Invalid token" }`
- 410: `{ "detail": "Token expired" }`

### Testing

**Testing Framework:** Vitest 2.1.5 + React Testing Library 16.3.0 + MSW 2.12.2

**Test File Locations:**

- Unit tests (schemas): `src/schemas/__tests__/authSchemas.test.ts`
- Component tests: `src/components/auth/__tests__/*.test.tsx`
- MSW handlers: `src/__mocks__/handlers.ts`

**Testing Standards (from docs/frontend/testing-standards.md):**

1. **Naming Convention**: `ComponentName.test.tsx`
2. **Structure**: `describe` блоки для группировки, `test` для каждого сценария
3. **Assertions**: Использовать `@testing-library/jest-dom` matchers
4. **User Interactions**: Использовать `@testing-library/user-event` вместо `fireEvent`
5. **Async Tests**: Использовать `waitFor`, `findBy*` queries
6. **Coverage Target**: >= 80%

**MSW Handlers для Password Reset:**

```typescript
// src/__mocks__/handlers.ts
import { http, HttpResponse } from 'msw';

export const passwordResetHandlers = [
  // Request password reset
  http.post('/api/v1/auth/password-reset/', async () => {
    return HttpResponse.json({
      detail: 'Password reset email sent.'
    });
  }),

  // Validate reset token
  http.post('/api/v1/auth/password-reset/validate-token/', async ({ request }) => {
    const { uid, token } = await request.json() as { uid: string; token: string };
    
    // Mock: token "expired-token" is invalid
    if (token === 'expired-token') {
      return HttpResponse.json({ detail: 'Token expired' }, { status: 410 });
    }
    
    return HttpResponse.json({ valid: true });
  }),

  // Confirm password reset
  http.post('/api/v1/auth/password-reset/confirm/', async ({ request }) => {
    const { uid, token } = await request.json() as { uid: string; token: string; new_password: string };
    
    if (token === 'expired-token') {
      return HttpResponse.json({ detail: 'Token expired' }, { status: 410 });
    }
    
    return HttpResponse.json({
      detail: 'Password has been reset successfully.'
    });
  }),
];
```

### Coding Standards (from docs/architecture/coding-standards.md)

**Zod Schema для Password Reset:**

```typescript
// src/schemas/authSchemas.ts
import { z } from 'zod';

export const passwordResetRequestSchema = z.object({
  email: z.string().email('Введите корректный email'),
});

export const passwordResetConfirmSchema = z.object({
  password: z.string()
    .min(8, 'Пароль должен содержать минимум 8 символов')
    .regex(/[0-9]/, 'Пароль должен содержать хотя бы 1 цифру')
    .regex(/[A-Z]/, 'Пароль должен содержать хотя бы 1 заглавную букву'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'Пароли не совпадают',
  path: ['confirmPassword'],
});

export type PasswordResetRequestFormData = z.infer<typeof passwordResetRequestSchema>;
export type PasswordResetConfirmFormData = z.infer<typeof passwordResetConfirmSchema>;
```

**Component Pattern:**

```tsx
// src/components/auth/PasswordResetRequestForm.tsx
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { passwordResetRequestSchema, type PasswordResetRequestFormData } from '@/schemas/authSchemas';
import authService from '@/services/authService';
import { Input } from '@/components/ui/Input/Input';
import { Button } from '@/components/ui/Button/Button';

export const PasswordResetRequestForm = () => {
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null);

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting }
  } = useForm<PasswordResetRequestFormData>({
    resolver: zodResolver(passwordResetRequestSchema)
  });

  const onSubmit = async (data: PasswordResetRequestFormData) => {
    try {
      setApiError(null);
      await authService.requestPasswordReset(data.email);
      setIsSubmitted(true);
    } catch (error) {
      setApiError('Произошла ошибка. Попробуйте позже.');
    }
  };

  if (isSubmitted) {
    return (
      <div className="text-center p-6">
        <h2 className="text-xl font-semibold mb-4">Проверьте вашу почту</h2>
        <p className="text-gray-600">
          Если аккаунт с указанным email существует, мы отправили ссылку для сброса пароля.
        </p>
      </div>
    );
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <Input
        label="Email"
        type="email"
        {...register('email')}
        error={errors.email?.message}
        aria-describedby={errors.email ? 'email-error' : undefined}
      />
      
      {apiError && (
        <div className="text-red-500 text-sm" role="alert">
          {apiError}
        </div>
      )}

      <Button
        type="submit"
        loading={isSubmitting}
        disabled={isSubmitting}
        className="w-full"
      >
        Отправить ссылку для сброса
      </Button>
    </form>
  );
};
```

### URL Format from Email

Email-сообщение с ссылкой для сброса пароля будет содержать URL в формате:

```
https://freesport.ru/password-reset/confirm/{uid}/{token}/
```

Где:
- `{uid}` - base64-encoded user ID (e.g., "MQ" для user ID 1)
- `{token}` - одноразовый токен, сгенерированный Django (e.g., "c2abcd-123456789abcdef")

**Пример:** `https://freesport.ru/password-reset/confirm/MQ/c2abcd-123456789abcdef/`

### Security Notes

- **Token Lifetime**: Токены для сброса пароля действительны 24 часа (настраивается в Django settings)
- **Single Use**: Токен становится невалидным после использования
- **HTTPS Only**: Все запросы должны идти по HTTPS
- **No Token Logging**: Токены не должны логироваться на клиенте
- **History Management**: После успешного сброса — заменить URL в history для предотвращения повторного использования (использовать `router.replace()`)

## Change Log

| Date       | Version | Description                                   | Author        |
|------------|---------|-----------------------------------------------|---------------|
| 2025-12-10 | 1.0 | Initial story draft from Epic 28 | John (PM) |
| 2025-12-10 | 2.0 | Complete rewrite by PO: Added Tasks/Subtasks, Dev Notes, Testing specs, API specifications, Security requirements, Full implementation guidance | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent during implementation_

### Debug Log References

_To be filled by Dev Agent during implementation_

### Completion Notes List

_To be filled by Dev Agent during implementation_

### File List

_To be filled by Dev Agent during implementation_

## QA Results

_To be filled by QA Agent after implementation review_
