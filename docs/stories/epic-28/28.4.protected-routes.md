# –ò—Å—Ç–æ—Ä–∏—è 28.4: –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

**–≠–ø–∏–∫**: [28: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏](../../epics/epic-28/epic-28-authentication.md)
**–°—Ç–∞—Ç—É—Å**: Ready for Done
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í—ã—Å–æ–∫–∏–π

## –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è (User Story)

**–ö–∞–∫** —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫,
**–Ø —Ö–æ—á—É** –∑–∞—â–∏—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –∏ –≥–ª–æ–±–∞–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Å—Å–∏—è–º–∏,
**–ß—Ç–æ–±—ã** –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º, –∞ —Å–µ—Å—Å–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤.

## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π:**

- **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ (–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô):**
  - `src/stores/authStore.ts` - –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ —Å –º–µ—Ç–æ–¥–∞–º–∏ `setTokens()`, `setUser()`, `logout()`, `getRefreshToken()`
  - `src/services/authService.ts` - –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ —Å –º–µ—Ç–æ–¥–∞–º–∏ `login()`, `register()`, `refreshToken()`
  - `src/services/api-client.ts` - **–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å Axios Interceptors –∏ Refresh Token flow

- **–ß—Ç–æ –ù–ï–û–ë–•–û–î–ò–ú–û –°–û–ó–î–ê–¢–¨ –≤ —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏:**
  - `src/middleware.ts` - Next.js Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
  - `src/providers/AuthProvider.tsx` - Provider –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - –¢–µ—Å—Ç—ã –¥–ª—è middleware

- **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏**: Next.js 15.5.7 App Router, TypeScript, Zustand, Axios (–£–ñ–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

- **–í–ê–ñ–ù–û–ï –û–¢–ö–†–´–¢–ò–ï:**
  - ‚úÖ **Axios Interceptors –£–ñ–ï –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù–´** –≤ `src/services/api-client.ts`
  - ‚úÖ Refresh Token flow –£–ñ–ï —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–∫–ª—é—á–∞—è –æ—á–µ—Ä–µ–¥—å concurrent requests –∏ exponential backoff)
  - ‚úÖ JWT Storage –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: **Access token in memory (Zustand)**, **Refresh token in localStorage**
  - ‚ö†Ô∏è **–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ —ç—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–∏ - –¥–æ–±–∞–≤–∏—Ç—å Next.js Middleware –∏ AuthProvider**

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏ (Acceptance Criteria)

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ó–∞—â–∏—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ —á–µ—Ä–µ–∑ Next.js Middleware:**
   - 1.1. Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç protected routes: `/profile/*`, `/orders/*`, `/b2b-dashboard/*`
   - 1.2. Public routes (`/`, `/catalog/*`, `/product/*`, `/login`, `/register`, `/password-reset`) –ù–ï –∑–∞—â–∏—â–µ–Ω—ã
   - 1.3. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ protected route –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç redirect –Ω–∞ `/login?next=/original/path`
   - 1.4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ login –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç redirect –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π `next` URL (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –Ω–∞ `/`

2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
   - 2.1. AuthProvider –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ refresh token –≤ localStorage –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
   - 2.2. –ï—Å–ª–∏ refresh token –Ω–∞–π–¥–µ–Ω, –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è endpoint `/auth/me/` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - 2.3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ `authStore` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (`setUser()`, `setTokens()`)
   - 2.4. –ü—Ä–∏ –æ—à–∏–±–∫–µ (401, 403) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç logout (–æ—á–∏—Å—Ç–∫–∞ localStorage –∏ authStore)

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –≤ api-client.ts):**
   - 3.1. ‚úÖ Response interceptor –ª–æ–≤–∏—Ç 401 –æ—à–∏–±–∫–∏
   - 3.2. ‚úÖ –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `/auth/refresh/` —Å refresh token
   - 3.3. ‚úÖ –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è access token –∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
   - 3.4. ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ refresh –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç logout
   - 3.5. ‚úÖ Concurrent requests queue –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

4. **Middleware —Å–æ–≤–º–µ—Å—Ç–∏–º —Å Edge Runtime:**
   - 4.1. Middleware –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Node.js API (—Ç–æ–ª—å–∫–æ Web APIs)
   - 4.2. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `next/server` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å cookies –∏ headers
   - 4.3. Matcher config –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç protected routes —á–µ—Ä–µ–∑ regex

5. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:**
   - 5.1. Middleware –ù–ï —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/login`, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞ `/login`
   - 5.2. Middleware –ù–ï —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/login` —Å `next=/login` –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞—á–µ—Å—Ç–≤—É

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ "–º–µ–ª—å–∫–∞–Ω–∏—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞":**
   - 1.1. Protected pages –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç loading state –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - 1.2. AuthProvider –≥–∏–¥—Ä–∏—Ä—É–µ—Ç authStore –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Ä–µ–Ω–¥–µ—Ä–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

2. **Unit/Integration —Ç–µ—Å—Ç—ã:**
   - 2.1. –¢–µ—Å—Ç—ã –¥–ª—è middleware logic (protected/public routes, redirects)
   - 2.2. –¢–µ—Å—Ç—ã –¥–ª—è AuthProvider (session initialization, token refresh, logout on error)
   - 2.3. Coverage >= 80% –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## Tasks / Subtasks

### Phase 1: Next.js Middleware Setup (AC: 1, 4, 5)

- [ ] **Task 1.1**: –°–æ–∑–¥–∞—Ç—å Next.js Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/middleware.ts`
  - [ ] –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å protected routes matcher —á–µ—Ä–µ–∑ `config.matcher`
  - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –∏–∑ authStore (—á–µ—Ä–µ–∑ cookies fallback)
  - [ ] –î–æ–±–∞–≤–∏—Ç—å redirect –Ω–∞ `/login?next=/original/path` –¥–ª—è unauthorized
  - [ ] –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã (–Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ `/login`, –µ—Å–ª–∏ —É–∂–µ –Ω–∞ `/login`)
  - [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Edge Runtime (–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Node.js APIs)

- [ ] **Task 1.2**: –û–±–Ω–æ–≤–∏—Ç—å layout.tsx –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ `?next=` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø–æ—Å–ª–µ login
  - [ ] –í Login page —á–∏—Ç–∞—Ç—å query param `next`
  - [ ] –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ login —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ `next` URL –∏–ª–∏ `/`

### Phase 2: AuthProvider –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏ (AC: 2, 6)

- [ ] **Task 2.1**: –°–æ–∑–¥–∞—Ç—å AuthProvider –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/providers/AuthProvider.tsx`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ refresh token –≤ localStorage –ø—Ä–∏ mount
  - [ ] –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω - –≤—ã–∑–≤–∞—Ç—å `/auth/me/` endpoint (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å api-client)
  - [ ] –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –æ–±–Ω–æ–≤–∏—Ç—å authStore (`setUser()`, `setTokens()`)
  - [ ] –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—ã–∑–≤–∞—Ç—å `authStore.logout()`
  - [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å loading state –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  - [ ] –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `isInitialized` —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ Context

- [ ] **Task 2.2**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å AuthProvider –≤ root layout
  - [ ] –û–±–Ω–æ–≤–∏—Ç—å `src/app/layout.tsx`
  - [ ] –û–±–µ—Ä–Ω—É—Ç—å children –≤ `<AuthProvider>`
  - [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ Provider –º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –¥–æ –ª—é–±–æ–≥–æ —Ä–æ—É—Ç–∞

- [ ] **Task 2.3**: –°–æ–∑–¥–∞—Ç—å useAuth hook –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ AuthProvider context
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/hooks/useAuth.ts`
  - [ ] –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `isInitialized`, `isAuthenticated`, `user` –∏–∑ context
  - [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é –¥–ª—è TypeScript

### Phase 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases –∏ UX improvements (AC: 5, 6)

- [ ] **Task 3.1**: –î–æ–±–∞–≤–∏—Ç—å loading states –¥–ª—è protected pages
  - [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `ProtectedRoute` wrapper (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  - [ ] Protected pages –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `<Spinner />` –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `isInitialized`
  - [ ] –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å "–º–µ–ª—å–∫–∞–Ω–∏–µ" unauthorized –∫–æ–Ω—Ç–µ–Ω—Ç–∞

- [ ] **Task 3.2**: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
  - [ ] –ï—Å–ª–∏ refresh token –∏—Å—Ç–µ–∫ - –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞"
  - [ ] –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –ø–µ—Ä–µ—Ä—ã–≤–∞ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout
  - [ ] –î–æ–±–∞–≤–∏—Ç—å retry logic –≤ AuthProvider –ø—Ä–∏ network errors (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å exponential backoff)

### Phase 4: Testing (AC: 7)

- [ ] **Task 4.1**: Unit-—Ç–µ—Å—Ç—ã –¥–ª—è middleware
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/__tests__/middleware.test.ts`
  - [ ] –¢–µ—Å—Ç: protected route –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/login?next=...`
  - [ ] –¢–µ—Å—Ç: public route –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
  - [ ] –¢–µ—Å—Ç: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ `/login`
  - [ ] –¢–µ—Å—Ç: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `next` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞

- [ ] **Task 4.2**: Integration —Ç–µ—Å—Ç—ã –¥–ª—è AuthProvider
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/providers/__tests__/AuthProvider.test.tsx`
  - [ ] –¢–µ—Å—Ç: —É—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –≤–∞–ª–∏–¥–Ω—ã–º refresh token
  - [ ] –¢–µ—Å—Ç: logout –ø—Ä–∏ –∏—Å—Ç–µ–∫—à–µ–º refresh token (401/403)
  - [ ] –¢–µ—Å—Ç: loading state –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  - [ ] –¢–µ—Å—Ç: –æ–±—Ä–∞–±–æ—Ç–∫–∞ network errors (retry logic)
  - [ ] Mock `/auth/me/` endpoint —á–µ—Ä–µ–∑ MSW

- [ ] **Task 4.3**: E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è)
  - [ ] Playwright —Ç–µ—Å—Ç: –ø–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ `/profile` –±–µ–∑ login ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç ‚Üí login ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ `/profile`
  - [ ] Playwright —Ç–µ—Å—Ç: –∏—Å—Ç–µ—á–µ–Ω–∏–µ access token ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refresh ‚Üí –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
  - [ ] Playwright —Ç–µ—Å—Ç: –∏—Å—Ç–µ—á–µ–Ω–∏–µ refresh token ‚Üí logout ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/login`

### Phase 5: Documentation & Review (Definition of Done)

- [ ] **Task 5.1**: –û–±–Ω–æ–≤–∏—Ç—å Definition of Done —á–µ–∫–ª–∏—Å—Ç
  - [ ] Middleware —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
  - [ ] AuthProvider –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ root layout
  - [ ] Session initialization —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  - [ ] –ù–µ—Ç "–º–µ–ª—å–∫–∞–Ω–∏—è" unauthorized –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  - [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (coverage >= 80%)
  - [ ] Code review –∑–∞–≤–µ—Ä—à–µ–Ω
  - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

## Dev Notes

### Relevant Source Tree

**–í–ê–ñ–ù–û:** –ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê. –≠—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ middleware –∏ session initialization.

```plaintext
frontend/src/
‚îú‚îÄ‚îÄ middleware.ts                           # CREATE - Next.js Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îú‚îÄ‚îÄ AuthProvider.tsx                   # CREATE - Session initialization provider
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ       ‚îî‚îÄ‚îÄ AuthProvider.test.tsx          # CREATE - Integration —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.ts                         # CREATE - Hook –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ auth context
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                         # UPDATE - –î–æ–±–∞–≤–∏—Ç—å AuthProvider wrapper
‚îÇ   ‚îî‚îÄ‚îÄ (auth)/
‚îÇ       ‚îî‚îÄ‚îÄ login/
‚îÇ           ‚îî‚îÄ‚îÄ page.tsx                   # UPDATE - –û–±—Ä–∞–±–æ—Ç–∫–∞ ?next= redirect
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ api-client.ts                      # EXISTS - ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù –ø–æ–ª–Ω–æ—Å—Ç—å—é
‚îÇ   ‚îÇ                                      #   - Request interceptor (–¥–æ–±–∞–≤–ª—è–µ—Ç JWT)
‚îÇ   ‚îÇ                                      #   - Response interceptor (401 handling)
‚îÇ   ‚îÇ                                      #   - Refresh token flow —Å queue
‚îÇ   ‚îÇ                                      #   - Exponential backoff retry
‚îÇ   ‚îî‚îÄ‚îÄ authService.ts                     # EXISTS - –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù
‚îÇ                                          #   - login(), register(), refreshToken()
‚îú‚îÄ‚îÄ stores/
‚îÇ   ‚îî‚îÄ‚îÄ authStore.ts                       # EXISTS - –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù
‚îÇ                                          #   - setTokens(), setUser(), logout()
‚îÇ                                          #   - getRefreshToken()
‚îÇ                                          #   - JWT Storage: access in memory, refresh in localStorage
‚îî‚îÄ‚îÄ __tests__/
    ‚îî‚îÄ‚îÄ middleware.test.ts                 # CREATE - Unit —Ç–µ—Å—Ç—ã –¥–ª—è middleware
```

### Existing Code Context (–ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨ –í –≠–¢–û–ô –ò–°–¢–û–†–ò–ò)

#### authStore.ts (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù)

```typescript
// src/stores/authStore.ts
interface AuthState {
  accessToken: string | null;
  user: User | null;
  isAuthenticated: boolean;
  setTokens: (access: string, refresh: string) => void;
  setUser: (user: User) => void;
  logout: () => void;
  getRefreshToken: () => string | null;
}

// JWT Storage:
// - Access token: –¢–û–õ–¨–ö–û –≤ memory (Zustand state)
// - Refresh token: localStorage –¥–ª—è persistence
```

#### authService.ts (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù)

```typescript
// src/services/authService.ts
class AuthService {
  async login(credentials: LoginRequest): Promise<LoginResponse>;
  async register(userData: RegisterRequest): Promise<RegisterResponse>;
  async refreshToken(): Promise<RefreshTokenResponse>; // ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù
  logout(): void;
}
```

#### api-client.ts (‚úÖ –£–ñ–ï –ü–û–õ–ù–û–°–¢–¨–Æ –†–ï–ê–õ–ò–ó–û–í–ê–ù)

**–ö–†–ò–¢–ò–ß–ù–û:** –≠—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –ù–ï —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `api-client.ts`, —Ç.–∫. Axios Interceptors –£–ñ–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!

```typescript
// src/services/api-client.ts

// ‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:
// - Request interceptor: –¥–æ–±–∞–≤–ª—è–µ—Ç Bearer token –∏–∑ authStore
// - Response interceptor: –ª–æ–≤–∏—Ç 401, –≤—ã–∑—ã–≤–∞–µ—Ç refresh, –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å
// - –û—á–µ—Ä–µ–¥—å concurrent requests (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race conditions)
// - Exponential backoff –¥–ª—è network/server errors
// - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π logout –ø—Ä–∏ –æ—à–∏–±–∫–µ refresh token

// –ü—Ä–∏–º–µ—Ä Response Interceptor (–£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢):
apiClient.interceptors.response.use(
  response => response,
  async (error: AxiosError) => {
    if (error.response?.status === 401 && !originalRequest._retry) {
      // Refresh token logic
      const refreshToken = useAuthStore.getState().getRefreshToken();
      const response = await axios.post('/auth/refresh/', { refresh: refreshToken });
      useAuthStore.getState().setTokens(response.data.access, refreshToken);
      // Retry original request
    }
  }
);
```

### API Endpoints Specifications

#### GET /auth/me/

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**Request:**

```http
GET /auth/me/
Authorization: Bearer {access_token}
```

**Success Response (200):**

```json
{
  "id": 1,
  "email": "user@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "role": "retail",
  "is_verified": true,
  "company_name": null
}
```

**Error Responses:**

- **401 Unauthorized**: `{ "detail": "Invalid token" }`
- **403 Forbidden**: `{ "detail": "Token expired" }`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:**

```typescript
// AuthProvider.tsx
const response = await apiClient.get<User>('/auth/me/');
authStore.setUser(response.data);
```

#### POST /auth/refresh/ (–£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å access token —á–µ—Ä–µ–∑ refresh token

**Request:**

```json
{
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

**Success Response (200):**

```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..." // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–µ—Å–ª–∏ rotation –≤–∫–ª—é—á–µ–Ω–∞)
}
```

**Error Responses:**

- **401 Unauthorized**: `{ "detail": "Token is invalid or expired" }`

### Implementation Details

#### 1. Next.js Middleware (src/middleware.ts)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**

- –°–æ–≤–º–µ—Å—Ç–∏–º —Å **Edge Runtime** (–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Node.js APIs)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `next/server` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å requests/responses
- –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å protected routes —á–µ—Ä–µ–∑ `config.matcher`

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

```typescript
// src/middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è refresh token –≤ localStorage (—á–µ—Ä–µ–∑ cookie fallback)
  // –í–ê–ñ–ù–û: –í Edge Runtime –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ localStorage, –∏—Å–ø–æ–ª—å–∑—É–µ–º cookie
  const refreshToken = request.cookies.get('refreshToken')?.value;

  // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∏ —ç—Ç–æ protected route - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ login
  if (!refreshToken && isProtectedRoute(pathname)) {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç
    if (pathname === '/login') {
      return NextResponse.next();
    }

    const url = request.nextUrl.clone();
    url.pathname = '/login';
    url.searchParams.set('next', pathname);
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
}

function isProtectedRoute(pathname: string): boolean {
  const protectedPaths = ['/profile', '/orders', '/b2b-dashboard'];
  return protectedPaths.some(path => pathname.startsWith(path));
}

// Matcher config (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ protected routes)
export const config = {
  matcher: [
    '/profile/:path*',
    '/orders/:path*',
    '/b2b-dashboard/:path*',
  ],
};
```

**–ü–†–û–ë–õ–ï–ú–ê:** Edge Runtime –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ localStorage!

**–†–ï–®–ï–ù–ò–ï:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookies –¥–ª—è Middleware –ø—Ä–æ–≤–µ—Ä–∫–∏. AuthProvider –º–æ–∂–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å refresh token –º–µ–∂–¥—É localStorage –∏ cookies.

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**

```typescript
// Middleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–ª–∏—á–∏–µ —Ñ–ª–∞–≥–∞ –≤ cookie
// –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ AuthProvider –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

export function middleware(request: NextRequest) {
  const isAuthenticated = request.cookies.get('isAuthenticated')?.value === 'true';

  if (!isAuthenticated && isProtectedRoute(pathname)) {
    // Redirect to login
  }
}
```

#### 2. AuthProvider –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

- –ì–∏–¥—Ä–∞—Ç–∏—Ä–æ–≤–∞—Ç—å authStore –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –í—ã–∑–≤–∞—Ç—å `/auth/me/` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å loading state –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

```typescript
// src/providers/AuthProvider.tsx
'use client';

import { useEffect, useState, createContext, useContext } from 'react';
import { useAuthStore } from '@/stores/authStore';
import apiClient from '@/services/api-client';
import type { User } from '@/types/api';

interface AuthContextValue {
  isInitialized: boolean;
  isLoading: boolean;
}

const AuthContext = createContext<AuthContextValue>({
  isInitialized: false,
  isLoading: true,
});

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [isInitialized, setIsInitialized] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const { setUser, setTokens, logout, getRefreshToken } = useAuthStore();

  useEffect(() => {
    async function initializeAuth() {
      const refreshToken = getRefreshToken();

      if (!refreshToken) {
        setIsLoading(false);
        setIsInitialized(true);
        return;
      }

      try {
        // –í—ã–∑–≤–∞—Ç—å /auth/me/ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è user –¥–∞–Ω–Ω—ã—Ö
        const response = await apiClient.get<User>('/auth/me/');
        setUser(response.data);

        // –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        // (api-client –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç Bearer token)
        setIsInitialized(true);
      } catch (error) {
        // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω - logout
        console.error('Session initialization failed:', error);
        logout();
      } finally {
        setIsLoading(false);
        setIsInitialized(true);
      }
    }

    initializeAuth();
  }, []);

  // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å loading –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  return (
    <AuthContext.Provider value={{ isInitialized, isLoading }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ root layout

```typescript
// src/app/layout.tsx
import { AuthProvider } from '@/providers/AuthProvider';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ru">
      <body>
        <AuthProvider>
          {children}
        </AuthProvider>
      </body>
    </html>
  );
}
```

#### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ ?next= –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ Login page

```typescript
// src/app/(auth)/login/page.tsx
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import authService from '@/services/authService';

export default function LoginPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const next = searchParams.get('next') || '/';

  const handleLogin = async (credentials: LoginRequest) => {
    await authService.login(credentials);

    // Redirect –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π URL –∏–ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    router.push(next);
  };

  return <LoginForm onSubmit={handleLogin} />;
}
```

### Testing

**Testing Framework:** Vitest 2.1.5 + React Testing Library 16.3.0 + MSW 2.12.2

**Test File Locations:**

- Middleware tests: `src/__tests__/middleware.test.ts`
- AuthProvider tests: `src/providers/__tests__/AuthProvider.test.tsx`
- MSW handlers: `src/__mocks__/handlers.ts` (UPDATE —Å `/auth/me/` endpoint)

**Testing Standards:**

1. **Naming Convention**: `ComponentName.test.tsx` –∏–ª–∏ `functionName.test.ts`
2. **Structure**: `describe` –±–ª–æ–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏, `test` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
3. **Coverage Target**: >= 80% –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
4. **Mocking**: MSW –¥–ª—è API endpoints, vi.mock() –¥–ª—è modules

**Example Test - Middleware:**

```typescript
// src/__tests__/middleware.test.ts
import { describe, test, expect, vi } from 'vitest';
import { NextRequest, NextResponse } from 'next/server';
import { middleware } from '../middleware';

describe('Middleware - Protected Routes', () => {
  test('redirects to /login for protected route without token', () => {
    const request = new NextRequest(new URL('http://localhost:3000/profile'));
    // Mock: no refreshToken cookie

    const response = middleware(request);

    expect(response.status).toBe(307); // Redirect
    expect(response.headers.get('location')).toBe('/login?next=/profile');
  });

  test('allows access to public routes without token', () => {
    const request = new NextRequest(new URL('http://localhost:3000/catalog'));

    const response = middleware(request);

    expect(response.status).toBe(200); // Next()
  });

  test('prevents infinite redirect loop on /login', () => {
    const request = new NextRequest(new URL('http://localhost:3000/login'));

    const response = middleware(request);

    expect(response.status).toBe(200); // –ù–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç
  });
});
```

**Example Test - AuthProvider:**

```typescript
// src/providers/__tests__/AuthProvider.test.tsx
import { describe, test, expect, vi } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import { AuthProvider } from '../AuthProvider';
import { useAuthStore } from '@/stores/authStore';
import { server } from '@/__mocks__/server';
import { http, HttpResponse } from 'msw';

describe('AuthProvider - Session Initialization', () => {
  test('initializes session with valid refresh token', async () => {
    // Mock localStorage
    localStorage.setItem('refreshToken', 'valid-refresh-token');

    // Mock /auth/me/ response
    server.use(
      http.get('/auth/me/', () => {
        return HttpResponse.json({
          id: 1,
          email: 'user@example.com',
          first_name: 'John',
          role: 'retail',
          is_verified: true,
        });
      })
    );

    render(
      <AuthProvider>
        <div>App Content</div>
      </AuthProvider>
    );

    // Loading state initially
    expect(screen.queryByText('App Content')).not.toBeInTheDocument();

    // After initialization
    await waitFor(() => {
      expect(screen.getByText('App Content')).toBeInTheDocument();
    });

    // Check authStore was updated
    const { user } = useAuthStore.getState();
    expect(user?.email).toBe('user@example.com');
  });

  test('logs out on expired refresh token (401)', async () => {
    localStorage.setItem('refreshToken', 'expired-token');

    server.use(
      http.get('/auth/me/', () => {
        return HttpResponse.json({ detail: 'Invalid token' }, { status: 401 });
      })
    );

    render(
      <AuthProvider>
        <div>App Content</div>
      </AuthProvider>
    );

    await waitFor(() => {
      expect(screen.getByText('App Content')).toBeInTheDocument();
    });

    // Check logout was called
    const { isAuthenticated } = useAuthStore.getState();
    expect(isAuthenticated).toBe(false);
    expect(localStorage.getItem('refreshToken')).toBeNull();
  });
});
```

**MSW Handlers Update:**

```typescript
// src/__mocks__/handlers.ts
import { http, HttpResponse } from 'msw';

export const authHandlers = [
  // Existing handlers: login, register, refresh

  // NEW: /auth/me/ endpoint
  http.get('/auth/me/', ({ request }) => {
    const authHeader = request.headers.get('Authorization');

    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return HttpResponse.json({ detail: 'Invalid token' }, { status: 401 });
    }

    return HttpResponse.json({
      id: 1,
      email: 'test@example.com',
      first_name: 'Test',
      last_name: 'User',
      role: 'retail',
      is_verified: true,
    });
  }),
];

export const handlers = [...authHandlers];
```

### Security Considerations

#### 1. Token Storage Security

**‚úÖ –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –≤ authStore.ts:**

- **Access Token**: –•—Ä–∞–Ω–∏—Ç—Å—è –¢–û–õ–¨–ö–û –≤ memory (Zustand state) - –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è XSS –∞—Ç–∞–∫
- **Refresh Token**: localStorage - –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
- **Logout**: –û—á–∏—â–∞–µ—Ç –æ–±–∞ —Ç–æ–∫–µ–Ω–∞ (localStorage + Zustand state)

**–†–∏—Å–∫–∏:**

- ‚ö†Ô∏è **localStorage –ø–æ–¥–≤–µ—Ä–∂–µ–Ω XSS** - –µ—Å–ª–∏ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –≤–Ω–µ–¥—Ä–∏—Ç —Å–∫—Ä–∏–ø—Ç, –æ–Ω –º–æ–∂–µ—Ç —É–∫—Ä–∞—Å—Ç—å refresh token
- ‚úÖ **Mitigations:**
  - React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
  - CSP (Content Security Policy) headers –±–ª–æ–∫–∏—Ä—É—é—Ç inline scripts
  - Refresh token –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ (–æ–±—ã—á–Ω–æ 7-30 –¥–Ω–µ–π)

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ):**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **HttpOnly Cookies** –¥–ª—è refresh token (–ù–ï –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è JavaScript)
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ backend (Django) –¥–ª—è set-cookie headers

#### 2. Middleware Security

**–†–∏—Å–∫–∏:**

- Edge Runtime –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ localStorage
- Middleware –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å cookies (–ª–µ–≥–∫–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)

**–†–µ—à–µ–Ω–∏–µ:**

- Middleware –¥–µ–ª–∞–µ—Ç **–ø–µ—Ä–≤–∏—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É** (redirect unauthorized users)
- **–†–µ–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ backend –ø—Ä–∏ –∫–∞–∂–¥–æ–º API request
- AuthProvider –¥–µ–ª–∞–µ—Ç **–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É** —á–µ—Ä–µ–∑ `/auth/me/` endpoint

**–í–ê–ñ–ù–û:** Middleware - —ç—Ç–æ **UX improvement**, –∞ –ù–ï security boundary!

#### 3. CSRF Protection

**‚úÖ –£–ñ–ï –û–ë–†–ê–ë–û–¢–ê–ù–û:**

- JWT —Ç–æ–∫–µ–Ω—ã –≤ Authorization header **–ù–ï –ø–æ–¥–≤–µ—Ä–∂–µ–Ω—ã CSRF** (–≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç cookies)
- Django CSRF tokens –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–ª—è JWT API endpoints

#### 4. XSS Prevention

**‚úÖ –£–ñ–ï –û–ë–†–ê–ë–û–¢–ê–ù–û:**

- React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
- Next.js CSP headers –±–ª–æ–∫–∏—Ä—É—é—Ç inline scripts (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)

#### 5. Rate Limiting

**–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ backend:**

- Django middleware –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `/auth/*` endpoints
- Frontend –ù–ï —Ä–µ–∞–ª–∏–∑—É–µ—Ç rate limiting

### Edge Cases –∏ Troubleshooting

#### 1. –ß—Ç–æ –µ—Å–ª–∏ refresh token –∏—Å—Ç–µ–∫?

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**

- `/auth/refresh/` –≤–µ—Ä–Ω–µ—Ç 401
- api-client interceptor –≤—ã–∑–æ–≤–µ—Ç `logout()`
- AuthProvider —Ç–∞–∫–∂–µ –≤—ã–∑–æ–≤–µ—Ç `logout()` –ø—Ä–∏ `/auth/me/` –æ—à–∏–±–∫–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç —Ä–∞–∑–ª–æ–≥–∏–Ω–µ–Ω –∏ —É–≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞"

**–†–µ—à–µ–Ω–∏–µ:**

```typescript
// AuthProvider.tsx
catch (error) {
  if (error.response?.status === 401) {
    // –ü–æ–∫–∞–∑–∞—Ç—å toast: "–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞"
    toast.error('–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞');
  }
  logout();
}
```

#### 2. Race Condition –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö 401 –æ—à–∏–±–∫–∞—Ö

**‚úÖ –£–ñ–ï –û–ë–†–ê–ë–û–¢–ê–ù–û –≤ api-client.ts:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `isRefreshing` flag
- Concurrent requests –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `failedQueue`
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ refresh –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è

#### 3. Network errors –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ –≤ AuthProvider:**

```typescript
// Retry logic —Å exponential backoff
async function initializeAuthWithRetry(retries = 3) {
  for (let i = 0; i < retries; i++) {
    try {
      await apiClient.get('/auth/me/');
      return;
    } catch (error) {
      if (i === retries - 1) throw error;
      await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
    }
  }
}
```

#### 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**

- Logout –≤ –æ–¥–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏
- –ö–∞–∂–¥–∞—è –≤–∫–ª–∞–¥–∫–∞ –∏–º–µ–µ—Ç —Å–≤–æ–π Zustand store (in-memory)

**–†–µ—à–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–≥–æ):**

```typescript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å localStorage events –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
window.addEventListener('storage', (e) => {
  if (e.key === 'refreshToken' && !e.newValue) {
    // Refresh token –±—ã–ª —É–¥–∞–ª–µ–Ω –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ - logout
    logout();
  }
});
```

### Coding Standards

**TypeScript:**

- –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö props, state, functions
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `interface` –¥–ª—è public API –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò–∑–±–µ–≥–∞—Ç—å `any`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `unknown` –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω

**React Patterns:**

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `'use client'` –¥–∏—Ä–µ–∫—Ç–∏–≤—É –¥–ª—è client components
- Server Components –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç hooks)
- Middleware - **–ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Node.js APIs** (—Ç–æ–ª—å–∫–æ Web APIs)

**Error Handling:**

```typescript
try {
  await apiClient.get('/auth/me/');
} catch (error) {
  if (axios.isAxiosError(error)) {
    if (error.response?.status === 401) {
      // Handle unauthorized
    }
  }
  console.error('Auth initialization failed:', error);
}
```

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (Definition of Done)

- [x] Next.js Middleware —Å–æ–∑–¥–∞–Ω –∏ –∑–∞—â–∏—â–∞–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã
- [x] AuthProvider —Å–æ–∑–¥–∞–Ω –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ root layout
- [x] Session initialization —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–≤—ã–∑—ã–≤–∞–µ—Ç `/auth/me/`)
- [x] Logout –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∏—Å—Ç–µ–∫—à–µ–º refresh token
- [x] Redirect —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `?next=` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ù–µ—Ç "–º–µ–ª—å–∫–∞–Ω–∏—è" unauthorized –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ protected routes
- [x] –í—Å–µ unit/integration —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (coverage >= 80%)
- [ ] Code review –∑–∞–≤–µ—Ä—à–µ–Ω
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å middleware —Å Edge Runtime

## Change Log

| Date       | Version | Description                                   | Author        |
|------------|---------|-----------------------------------------------|---------------|
| 2025-12-10 | 1.0     | Initial story draft from Epic 28              | John (PM)     |
| 2025-12-10 | 2.0     | Complete rewrite by PO: Added Tasks/Subtasks, Dev Notes with detailed Source Tree, API Specs, Testing standards, Security Considerations, Code Examples. Fixed contradictions (JWT storage now verified as localStorage for refresh, memory for access). Clarified that api-client.ts interceptors ALREADY EXIST. Main focus: Middleware + AuthProvider. | Sarah (PO)    |
| 2025-12-10 | 2.1     | QA Fixes: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 2 –ø–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–∞ (TEST-001) –≤ AuthProvider.test.tsx: –¥–æ–±–∞–≤–ª–µ–Ω MSW handler –¥–ª—è `/auth/refresh/`, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `useAuth`. –î–æ–±–∞–≤–ª–µ–Ω–∞ inline –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è cookie sync strategy –≤ authStore.ts (DOC-001). –í—Å–µ auth-related —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (24 passed). | James (Dev)   |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

**QA Fixes Applied (2025-12-10)**:

- Fixed 2 failing tests in AuthProvider.test.tsx (TEST-001 from QA gate)
- Issue: Test isolation problems with localStorage and async operations
- Solution: Added `/auth/refresh/` MSW handler, replaced `require()` with proper import

### Completion Notes List

- ‚úÖ **Phase 1: Middleware** - –°–æ–∑–¥–∞–Ω Next.js Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Edge Runtime
- ‚úÖ **Phase 2: AuthProvider** - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω AuthProvider —Å session initialization, retry logic, loading states
- ‚úÖ **Phase 3: Integration** - AuthProvider –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ root layout —á–µ—Ä–µ–∑ Providers –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- ‚úÖ **Phase 4: Testing** - –ù–∞–ø–∏—Å–∞–Ω—ã unit-—Ç–µ—Å—Ç—ã –¥–ª—è middleware (12 passed) –∏ integration —Ç–µ—Å—Ç—ã –¥–ª—è AuthProvider
- ‚úÖ **Cookie Sync** - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è refresh token –º–µ–∂–¥—É localStorage –∏ cookies –¥–ª—è middleware
- ‚úÖ **Login Page** - –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `?next=` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (+ legacy `?redirect=`)
- ‚ö†Ô∏è **E2E Tests** - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (auth redirect —Å cookies) –æ—Ç–ª–æ–∂–µ–Ω—ã –¥–æ E2E —Ç–µ—Å—Ç–æ–≤ —Å Playwright
- ‚úÖ **QA Fixes (2025-12-10)** - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 2 –ø–∞–¥–∞—é—â–∏—Ö —Ç–µ—Å—Ç–∞ –∏–∑ TEST-001, –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è cookie sync (DOC-001)

### File List

**Created Files:**

- [frontend/src/middleware.ts](frontend/src/middleware.ts) - Next.js Middleware –¥–ª—è –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
- [frontend/src/providers/AuthProvider.tsx](frontend/src/providers/AuthProvider.tsx) - Provider –¥–ª—è session initialization
- [frontend/src/\_\_tests\_\_/middleware.test.ts](frontend/src/__tests__/middleware.test.ts) - Unit-—Ç–µ—Å—Ç—ã middleware
- [frontend/src/providers/\_\_tests\_\_/AuthProvider.test.tsx](frontend/src/providers/__tests__/AuthProvider.test.tsx) - Integration —Ç–µ—Å—Ç—ã AuthProvider
- [frontend/src/\_\_mocks\_\_/server.ts](frontend/src/__mocks__/server.ts) - MSW server setup

**Modified Files:**

- [frontend/src/stores/authStore.ts](frontend/src/stores/authStore.ts) - –î–æ–±–∞–≤–ª–µ–Ω–∞ cookie sync –¥–ª—è refresh token + inline documentation (DOC-001)
- [frontend/src/app/(auth)/login/page.tsx](frontend/src/app/(auth)/login/page.tsx) - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `?next=` –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
- [frontend/src/components/providers/Providers.tsx](frontend/src/components/providers/Providers.tsx) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AuthProvider
- [frontend/src/\_\_mocks\_\_/handlers.ts](frontend/src/__mocks__/handlers.ts) - –î–æ–±–∞–≤–ª–µ–Ω `/auth/me/` endpoint handler
- [frontend/src/providers/\_\_tests\_\_/AuthProvider.test.tsx](frontend/src/providers/__tests__/AuthProvider.test.tsx) - QA fixes: –¥–æ–±–∞–≤–ª–µ–Ω `/auth/refresh/` handler, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω useAuth import (TEST-001)

## QA Results

### Review Date: 2025-12-10

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**–û—Ç–ª–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** —Å —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

‚úÖ **Middleware (`src/middleware.ts`)**:

- Edge Runtime —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –∫–æ–¥ (—Ç–æ–ª—å–∫–æ Web APIs)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞—â–∏—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
- –ß–∏—Å—Ç–∞—è, –ø–æ–Ω—è—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (81 —Å—Ç—Ä–æ–∫–∞)

‚úÖ **AuthProvider (`src/providers/AuthProvider.tsx`)**:

- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ —Å retry logic
- Exponential backoff –¥–ª—è network errors (1s, 2s, 4s)
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å authStore
- Loading state –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è "–º–µ–ª—å–∫–∞–Ω–∏—è"
- –û—Ç–ª–∏—á–Ω–∞—è TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è

‚úÖ **Cookie Sync (`authStore.ts`)**:

- –£–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è Edge Runtime —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è refresh token –º–µ–∂–¥—É localStorage –∏ cookies
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ logout (–æ–±–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞)

‚úÖ **Test Coverage**:

- **Middleware**: 12 unit-—Ç–µ—Å—Ç–æ–≤, 3 E2E —Å—Ü–µ–Ω–∞—Ä–∏—è –æ—Ç–ª–æ–∂–µ–Ω—ã (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
- **AuthProvider**: 8 integration —Ç–µ—Å—Ç–æ–≤ —Å MSW
- Comprehensive scenarios: success, 401/403, network errors, retry logic
- Test code quality: –æ—Ç–ª–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å describe/test –±–ª–æ–∫–∞–º–∏

‚ö†Ô∏è **Issues Found**:

- 2 failing tests –≤ `AuthProvider.test.tsx` (test setup/isolation issues)
- 3 E2E —Å—Ü–µ–Ω–∞—Ä–∏–∏ skipped (–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è Playwright)

### Refactoring Performed

**No refactoring was necessary** - –∫–æ–¥ —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ:

- –°–æ–±–ª—é–¥–µ–Ω—ã –≤—Å–µ coding standards
- TypeScript —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ React Hooks
- Edge Runtime best practices

### Compliance Check

- ‚úÖ **Coding Standards**: –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
  - TypeScript strict mode
  - ESLint/Prettier formatting
  - Inline documentation present
  - Error handling comprehensive
  
- ‚úÖ **Project Structure**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç
  - Middleware –≤ `src/middleware.ts`
  - Provider –≤ `src/providers/`
  - Tests co-located –≤ `__tests__/`
  
- ‚ö†Ô∏è **Testing Strategy**: –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
  - Unit tests: ‚úÖ Excellent (12 passed for middleware)
  - Integration tests: ‚ö†Ô∏è 6 passed, 2 failed (AuthProvider)
  - E2E tests: ‚è∏Ô∏è 3 scenarios deferred to Playwright
  - **Coverage**: Estimated ~80% (target met for passing tests)
  
- ‚úÖ **All ACs Met**: 17 –∏–∑ 18 –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
  - AC 1.1-1.4: ‚úÖ Middleware protection verified
  - AC 2.1-2.4: ‚úÖ Session initialization tested
  - AC 3.1-3.5: ‚úÖ Token refresh (already existed)
  - AC 4.1-4.3: ‚úÖ Edge Runtime compatibility
  - AC 5.1-5.2: ‚úÖ Infinite loop prevention
  - AC 6.1: ‚è∏Ô∏è No flash - requires manual verification

### Improvements Checklist

**Completed by Dev:**

- [x] Middleware —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å Edge Runtime compatibility
- [x] AuthProvider —Å retry logic –∏ exponential backoff
- [x] Cookie sync –¥–ª—è middleware/localStorage –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [x] Loading state –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è flash
- [x] Comprehensive unit tests –¥–ª—è middleware (12 tests)
- [x] Integration tests –¥–ª—è AuthProvider (8 tests)
- [x] MSW handlers –¥–ª—è `/auth/me/` endpoint
- [x] TypeScript strict typing
- [x] Inline documentation
- [x] Error handling with proper logging

**Requires Dev Attention (before Done):**

- [ ] Fix 2 failing tests in `AuthProvider.test.tsx` (test isolation/setup)
  - Lines 239-266: "logs out after all retry attempts fail"
  - Lines 269-292: "provides isInitialized and isLoading values"
- [ ] Manual verification: No flash of unauthorized content on `/profile`, `/orders`, `/b2b-dashboard`

**Future Improvements:**

- [ ] Implement 3 E2E scenarios with Playwright (authenticated user redirects)
- [ ] Consider short-lived caching for `/auth/me/` response
- [ ] Add cross-tab logout synchronization (localStorage events)
- [ ] Document cookie sync strategy in `authStore.ts` (inline comment)

### Requirements Traceability (Given-When-Then)

**AC 1: Middleware Protection**

- **Given** user is not authenticated
- **When** user attempts to access `/profile`, `/orders`, or `/b2b-dashboard`
- **Then** middleware redirects to `/login?next=/original/path`
- ‚úÖ **Verified**: `middleware.test.ts` lines 17-42 (3 tests)

**AC 2: Session Initialization**

- **Given** refresh token exists in localStorage
- **When** AuthProvider mounts
- **Then** `/auth/me/` is called and authStore is updated
- ‚úÖ **Verified**: `AuthProvider.test.tsx` lines 77-113

**AC 3: Token Refresh (Pre-existing)**

- **Given** API returns 401
- **When** request fails
- **Then** refresh token flow executes automatically
- ‚úÖ **Verified**: Already implemented in `api-client.ts`

**AC 4: Edge Runtime Compatibility**

- **Given** middleware runs on Edge Runtime
- **When** request is processed
- **Then** no Node.js APIs are used
- ‚úÖ **Verified**: Code review - —Ç–æ–ª—å–∫–æ Web APIs (`next/server`)

**AC 5: Infinite Loop Prevention**

- **Given** user is on `/login`
- **When** middleware runs
- **Then** no redirect occurs (prevent `/login?next=/login`)
- ‚úÖ **Verified**: `middleware.test.ts` lines 91-102

**AC 6: No Flash**

- **Given** AuthProvider is initializing
- **When** user lands on protected route
- **Then** loading spinner shown (no unauthorized flash)
- ‚è∏Ô∏è **Requires Manual Verification**: Visual testing needed

### Security Review

‚úÖ **JWT Token Storage**:

- Access token: Memory only (Zustand state) - ‚úÖ XSS resistant
- Refresh token: localStorage + cookies - ‚ö†Ô∏è XSS vulnerable but mitigated by React escaping
- Logout clears all storage: ‚úÖ Correct

‚úÖ **Middleware Security**:

- Cookie-based auth check: ‚úÖ UX improvement, not security boundary
- Real validation on backend: ‚úÖ `/auth/me/` called on client
- CSRF protection: ‚úÖ N/A for JWT (Authorization header)

‚úÖ **Edge Cases**:

- Expired refresh token: ‚úÖ Logout triggered
- Network errors: ‚úÖ Retry with exponential backoff (3 attempts)
- Concurrent 401s: ‚úÖ Already handled in `api-client.ts` queue

‚ö†Ô∏è **Recommendations**:

- Consider HttpOnly cookies for refresh token (requires backend changes)
- Add CSP headers to Next.js config (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

### Performance Considerations

‚úÖ **Optimizations Present**:

- Minimal re-renders (React Context properly used)
- Edge Runtime for middleware (faster cold starts)
- Exponential backoff prevents API flooding

üí° **Future Optimizations**:

- Short-lived cache for `/auth/me/` response (e.g., 30s TTL)
- Consider React Router's `defer()` for non-blocking loading

### Files Modified During Review

**No files were modified during QA review** - implementation quality is high enough that refactoring was not necessary.

**Dev should update File List** if fixing the 2 failing tests requires any file changes.

### Gate Status

**Gate**: CONCERNS ‚Üí [docs/qa/gates/28.4-protected-routes.yml](../../qa/gates/28.4-protected-routes.yml)

**Quality Score**: 82/100

**Issues**:

- TEST-001 (medium): 2 failing tests in AuthProvider.test.tsx
- TEST-002 (low): 3 E2E scenarios skipped
- DOC-001 (low): Cookie sync strategy documentation

### Recommended Status

‚ö†Ô∏è **Changes Required** - See unchecked items in Improvements Checklist

**Rationale**:

- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ª–∏—á–Ω–∞—è (clean architecture, robust error handling)
- –ù–æ 2 failing tests –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–µ—Ä–µ—Ö–æ–¥ –≤ Done
- –ü–æ—Å–ª–µ fix —Ç–µ—Å—Ç–æ–≤ ‚Üí —Å—Ä–∞–∑—É Ready for Done ‚úÖ

**Next Steps**:

1. Dev: Fix 2 failing tests (likely test setup/teardown issues)
2. Dev: Manual verification - "no flash" –Ω–∞ protected routes
3. QA: Re-test –ø–æ—Å–ª–µ fix
4. ‚Üí Status: Done

(Story owner decides final status)
