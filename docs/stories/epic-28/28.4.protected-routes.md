# История 28.4: Защищенные маршруты и управление сессиями

**Эпик**: [28: Реализация системы аутентификации](../../epics/epic-28/epic-28-authentication.md)
**Статус**: Черновик
**Приоритет**: Высокий

## Пользовательская история (User Story)

**Как** разработчик,
**Я хочу** защитить маршруты и глобально управлять сессиями,
**Чтобы** неавторизованные пользователи не могли получить доступ к ограниченным страницам, а сессии сохраняли ключевые действия.

## Контекст истории

**Интеграция с существующей системой:**

- **Интегрируется с**: Next.js Middleware, Axios Interceptors, `authStore`
- **Точки взаимодействия**:
  - `src/middleware.ts`
  - `src/lib/axios.ts` или `src/services/api.ts`
  - `src/providers/AuthProvider.tsx` (если применимо)

## Критерии приемки (Acceptance Criteria)

### Функциональные требования

1. **Защита маршрутов:**
   - Middleware перехватывает запросы к `/profile`, `/orders`, `/b2b-dashboard`.
   - Если нет валидного токена/сессии, редирект на `/login?next=/original/path`.
   - Публичные маршруты (`/`, `/catalog`, `/product/*`) остаются доступными.

2. **Обновление токена (Silent Refresh):**
   - Перехватчик Axios ловит ошибки 401.
   - Пытается вызвать эндпоинт `/auth/refresh/`.
   - Если успешно, повторяет оригинальный запрос.
   - Если обновление не удалось, очищает хранилище и редиректит на вход (Принудительный выход).

3. **Синхронизация сессии:**
   - Инициализация приложения проверяет наличие существующих валидных токенов (например, в HttpOnly cookie или через вызов `/auth/me`).
   - `authStore` гидрируется данными пользователя при загрузке.

### Требования к интеграции

4. Middleware должен быть легковесным (совместимым с Edge runtime, если возможно, или Nodejs).
5. Не должен создавать бесконечных циклов редиректа.

### Требования к качеству

7. E2E или интеграционный тест, симулирующий поток обновления истекшего токена (с моками).
8. Проверить отсутствие "мелькания неавторизованного контента" на защищенных маршрутах.

## Технические заметки

- **Подход к интеграции**: Использовать `middleware.ts` для охраны маршрутов. Использовать перехватчики `axios` для логики токенов.
- **Ключевые ограничения**:
  - Next.js Middleware обычно работает в Edge runtime, что ограничивает доступные Node API.
  - Решение по хранению JWT (Cookie vs LocalStorage) влияет на реализацию. Предполагаем Cookies для Refresh и общее хранилище для Access, основываясь на контексте Эпика.

## Критерии готовности (Definition of Done)

- [ ] Middleware настроен для защищенных маршрутов
- [ ] Перехватчики Axios для Refresh Token реализованы
- [ ] Авто-логаут при истечении сессии реализован
- [ ] Логика редиректа с параметром `?next=` работает
- [ ] Проверено, что ручное обновление страницы сохраняет состояние входа
