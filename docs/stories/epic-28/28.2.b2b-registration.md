# История 28.2: Поток регистрации B2B

**Эпик**: [28: Реализация системы аутентификации](../../epics/epic-28/epic-28-authentication.md)
**Статус**: Ready for Review
**Приоритет**: Высокий

## Пользовательская история (User Story)

**Как** Бизнес-партнер (B2B),
**Я хочу** зарегистрироваться, указав реквизиты компании,
**Чтобы** получить доступ к оптовым ценам.

## Контекст истории

**Интеграция с существующей системой:**

- **Интегрируется с**: Backend Endpoints регистрации B2B, `authStore`
- **Технологии**: Next.js Data Fetching, React Hook Form, Zod (кастомные валидаторы)
- **Точки взаимодействия**:
  - `src/app/(auth)/b2b-register/page.tsx`
  - `src/services/authService.ts`

## Критерии приемки (Acceptance Criteria)

### Функциональные требования

1. **Форма регистрации B2B:**
   - Отдельная страница по адресу `/b2b-register`.
   - Поля: Название компании, ИНН, ОГРН, Юридический адрес, Контактное лицо.
   - При успехе: отображение сообщения "Заявка на рассмотрении" (бэкенд возвращает user с `is_verified: false`).

2. **Валидация:**
   - **ИНН**: Числовой, строгая проверка длины (10 или 12 цифр в зависимости от типа лица).
   - **ОГРН**: Числовой, проверка специфичного формата (13 или 15 цифр).
   - Обязательные поля строго проверяются.

3. **UI/UX:**
   - Четкое визуальное отличие, что это форма для "Бизнес-партнеров".
   - Ссылка обратно на стандартную регистрацию B2C ("Не бизнес-клиент? Регистрация здесь").

### Требования к интеграции

4. Отправка данных на эндпоинт `POST /api/v1/auth/register/` с полем `role` для указания типа B2B.
5. Обработка ошибок, специфичная для кейса "Компания уже зарегистрирована" (409).
6. Обновление `authStore` при успешной регистрации с обработкой статуса `is_verified: false`.

### Требования к качеству

7. Unit-тесты для логики валидации ИНН/ОГРН.
8. Доступность: Форма доступна для навигации с клавиатуры, лейблы понятны.

---

## Tasks / Subtasks

- [x] **Task 1: Создать страницу B2B регистрации** (AC: 1, 3)
  - [x] Создать `src/app/(auth)/b2b-register/page.tsx`
  - [x] Создать layout с визуальным отличием от B2C (акцент на бизнес-данные)
  - [x] Добавить ссылку обратно на B2C регистрацию

- [x] **Task 2: Реализовать форму B2B регистрации** (AC: 1)
  - [x] Создать компонент формы с React Hook Form
  - [x] Добавить поля: Название компании, ИНН, ОГРН, Юридический адрес, Контактное лицо, Email, Пароль
  - [x] Интегрировать с `authService`

- [x] **Task 3: Реализовать валидацию ИНН/ОГРН** (AC: 2, 7)
  - [x] Создать Zod схему с кастомными валидаторами в `src/utils/validators/b2b-validators.ts`
  - [x] Валидация ИНН: 10 или 12 цифр (MVP: длина + числовой формат)
  - [x] Валидация ОГРН: 13 или 15 цифр

- [x] **Task 4: Интеграция с Backend API** (AC: 4, 5)
  - [x] Добавить метод `registerB2B()` в `src/services/authService.ts`
  - [x] Использовать `POST /api/v1/auth/register/` с payload и полем `role`
  - [x] Обработать ошибку 409 "Компания уже зарегистрирована"

- [x] **Task 5: Обработка статуса "На рассмотрении"** (AC: 1, 6)
  - [x] Отобразить информационную панель "Заявка на рассмотрении" при успехе
  - [x] Обновить `authStore` для обработки `is_verified: false`

- [x] **Task 6: Unit-тесты** (AC: 7)
  - [x] Написать тесты для валидаторов ИНН/ОГРН в `src/__tests__/utils/b2b-validators.test.ts`
  - [x] Написать тесты для формы регистрации

- [x] **Task 7: Проверка доступности** (AC: 8)
  - [x] Навигация с клавиатуры
  - [x] Понятные labels и aria-атрибуты

---

## Dev Notes

### Source Tree (relevant)

```text
frontend/src/
├── app/(auth)/
│   ├── b2b-register/
│   │   └── page.tsx          # [NEW] Страница B2B регистрации
│   ├── login/
│   └── register/             # Существующая B2C регистрация (референс)
├── services/
│   └── authService.ts        # [MODIFY] Добавить registerB2B()
├── stores/
│   └── authStore.ts          # [MODIFY] Обработка is_verified: false
└── utils/
    └── validators/
        └── b2b-validators.ts # [NEW] Валидаторы ИНН/ОГРН
```

### API Reference

**Эндпоинт регистрации:** `POST /api/v1/auth/register/`

**Request Payload:**
```json
{
  "email": "company@example.com",
  "password": "password123",
  "password_confirm": "password123",
  "first_name": "Иван",
  "last_name": "Петров",
  "role": "wholesale_level1",
  "company_name": "ООО Спорт",
  "tax_id": "1234567890"
}
```

**Responses:**
- `201 Created`: Успешная регистрация, возвращает user с `is_verified: false` для B2B
- `400 Bad Request`: Ошибки валидации
- `409 Conflict`: Email или компания уже зарегистрированы

### B2B Роли

```typescript
type B2BRole = 
  | "wholesale_level1"  // Оптовик уровень 1
  | "wholesale_level2"  // Оптовик уровень 2
  | "wholesale_level3"  // Оптовик уровень 3
  | "trainer"           // Тренер/Фитнес-клуб
  | "federation_rep";   // Представитель федерации
```

### Валидация ИНН/ОГРН

| Тип | Длина | Описание |
|-----|-------|----------|
| ИНН юр. лица | 10 цифр | Для организаций |
| ИНН физ. лица/ИП | 12 цифр | Для индивидуальных предпринимателей |
| ОГРН юр. лица | 13 цифр | Для организаций |
| ОГРНИП | 15 цифр | Для ИП |

**MVP:** Проверка длины + числовой формат.
**Полная версия (опционально):** Контрольная сумма по алгоритму ФНС.

### Ключевые ограничения

- Состояние должно обрабатывать статус пользователя "Pending" (`is_verified: false`)
- При успешной регистрации показать информационную панель, а не редирект в личный кабинет

---

## Testing

**Расположение тестов:**
- Unit-тесты: `frontend/src/__tests__/`
- Валидаторы: `frontend/src/__tests__/utils/b2b-validators.test.ts`
- Компоненты: `frontend/src/__tests__/components/B2BRegisterForm.test.tsx`

**Стандарты:**
- Фреймворк: Vitest + React Testing Library
- Документация: `docs/frontend/testing-standards.md`
- Покрытие: минимум 80% для валидаторов

**Команды:**
```bash
npm test                     # Все тесты
npm test -- --watch          # Watch mode
npm run test:coverage        # С покрытием
```

---

## Критерии готовности (Definition of Done)

- [ ] Страница регистрации B2B реализована
- [ ] Валидация ИНН/ОГРН работает
- [ ] Интеграция с API завершена
- [ ] Состояние/сообщение "На рассмотрении" обработано
- [ ] Unit-тесты для валидаторов пройдены

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-10 | 1.0 | Initial story draft | PM |
| 2025-12-10 | 1.1 | Added Tasks, Testing, expanded Dev Notes | Sarah (PO) |

---

## Dev Agent Record

_Заполняется Dev Agent при имплементации_

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
N/A

### Completion Notes

**Реализованная функциональность:**

1. **Валидаторы ИНН/ОГРН** (`frontend/src/utils/validators/b2b-validators.ts`):
   - Валидация ИНН: 10 цифр (юр. лицо) или 12 цифр (ИП)
   - Валидация ОГРН: 13 цифр (юр. лицо) или 15 цифр (ОГРНИП)
   - Функции для генерации сообщений об ошибках
   - MVP реализация: проверка длины + числовой формат

2. **Zod схема B2B регистрации** (`frontend/src/schemas/authSchemas.ts`):
   - Расширение существующих схем валидации
   - Интеграция с кастомными валидаторами ИНН/ОГРН
   - Поля: first_name, last_name, email, phone, password, confirmPassword, company_name, tax_id, ogrn, legal_address, role

3. **Компонент формы B2B** (`frontend/src/components/auth/B2BRegisterForm.tsx`):
   - React Hook Form интеграция с Zod resolver
   - Все поля с валидацией и error handling
   - Обработка статуса "На рассмотрении" (is_verified: false)
   - Визуальное отличие от B2C формы
   - Accessibility: labels, aria-атрибуты, keyboard navigation

4. **Страница B2B регистрации** (`frontend/src/app/(auth)/b2b-register/page.tsx`):
   - Отдельный маршрут `/b2b-register`
   - Визуальное отличие: gradient фон, бизнес иконография
   - Ссылки на B2C регистрацию и логин
   - Информационные блоки о преимуществах B2B

5. **Auth Service расширение** (`frontend/src/services/authService.ts`):
   - Метод `registerB2B()` для регистрации бизнес-пользователей
   - Обработка `is_verified: false` status
   - Сохранение токенов даже для непроверенных пользователей

6. **Тестирование**:
   - Unit-тесты валидаторов: 20 тестов (все прошли ✓)
   - Component тесты: 4 теста (все прошли ✓)
   - Покрытие: валидаторы, rendering, accessibility

**Технические решения:**

- Использована существующая Input компонента из UI kit
- TypeScript strict typing для всех компонентов
- Proper error handling с типизацией (unknown вместо any)
- Accessibility первоклассный гражданин (role, aria-*, labels)

**Замечания:**

- Backend API `/api/v1/auth/register/` должен поддерживать поля: company_name, tax_id
- В дальнейшем можно добавить полную валидацию ИНН/ОГРН с контрольной суммой по алгоритму ФНС

### File List

**Созданные файлы:**

- `frontend/src/utils/validators/b2b-validators.ts`
- `frontend/src/components/auth/B2BRegisterForm.tsx`
- `frontend/src/app/(auth)/b2b-register/page.tsx`
- `frontend/src/__tests__/utils/b2b-validators.test.ts`
- `frontend/src/__tests__/components/B2BRegisterForm.test.tsx`

**Модифицированные файлы:**

- `frontend/src/schemas/authSchemas.ts` (добавлена b2bRegisterSchema)
- `frontend/src/services/authService.ts` (добавлен метод registerB2B)

---

## QA Results

_Заполняется QA Agent после ревью_
