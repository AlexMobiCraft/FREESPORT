# Story 29.4: Email Notification System

## Status

Ready for development

---

## Story

**As an** Administrator,  
**I want** to receive an email when a new Partner registers,  
**so that** I can review and approve their request.

**As a** Business Partner,  
**I want** to receive confirmation that my application was received,  
**so that** I know my request is being processed.

---

> [!IMPORTANT]
> **DEPENDENCY:** –¢—Ä–µ–±—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Story 29.3 (Email Server Configuration)

---

## Acceptance Criteria

1. –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¢—Ä–µ–Ω–µ—Ä/–û–ø—Ç–æ–≤–∏–∫/–§–µ–¥–µ—Ä–∞—Ü–∏—è):
   - –ê–¥–º–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç email —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞—è–≤–∫–∏ (–§–ò–û, –∫–æ–º–ø–∞–Ω–∏—è, —Ä–æ–ª—å, email, –¥–∞—Ç–∞)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç email "–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏"

2. –î–ª—è —Ä–æ–∑–Ω–∏—á–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ email –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

3. Email –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ Celery tasks

4. Celery tasks –∏–º–µ—é—Ç retry –ª–æ–≥–∏–∫—É —Å exponential backoff (max 3 retries)

5. Email templates –∏—Å–ø–æ–ª—å–∑—É—é—Ç Django template system (HTML + plain text fallback)

6. –õ–æ–≥–∏—Ä—É—é—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –æ—à–∏–±–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

7. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: Celery Beat task –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ pending queue (alert –µ—Å–ª–∏ > 10 –∑–∞ 24—á)

---

## Tasks / Subtasks

- [ ] **Task 0: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SITE_URL –≤ settings** (Prerequisite)
  - [ ] 0.1 –î–æ–±–∞–≤–∏—Ç—å `SITE_URL` –≤ `backend/freesport/settings/base.py`
  - [ ] 0.2 –î–æ–±–∞–≤–∏—Ç—å `SITE_URL` –≤ `.env.example`

- [ ] **Task 1: –°–æ–∑–¥–∞—Ç—å Celery tasks –¥–ª—è email** (AC: 1, 3, 4)
  - [ ] 1.1 –°–æ–∑–¥–∞—Ç—å `apps/users/tasks.py`
  - [ ] 1.2 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `send_admin_verification_email(user_id)`
  - [ ] 1.3 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `send_user_pending_email(user_id)`
  - [ ] 1.4 –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É —Å exponential backoff

- [ ] **Task 2: –°–æ–∑–¥–∞—Ç—å email templates** (AC: 5)
  - [ ] 2.1 –°–æ–∑–¥–∞—Ç—å `templates/emails/admin_new_verification_request.html`
  - [ ] 2.2 –°–æ–∑–¥–∞—Ç—å `templates/emails/admin_new_verification_request.txt`
  - [ ] 2.3 –°–æ–∑–¥–∞—Ç—å `templates/emails/user_registration_pending.html`
  - [ ] 2.4 –°–æ–∑–¥–∞—Ç—å `templates/emails/user_registration_pending.txt`

- [ ] **Task 3: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å RegisterView** (AC: 1, 2)
  - [ ] 3.1 –û–±–Ω–æ–≤–∏—Ç—å `UserRegistrationSerializer.create()` –∏–ª–∏ `RegisterView`
  - [ ] 3.2 –í—ã–∑—ã–≤–∞—Ç—å Celery tasks —Ç–æ–ª—å–∫–æ –¥–ª—è B2B —Ä–æ–ª–µ–π
  - [ ] 3.3 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.delay()` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

- [ ] **Task 4: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** (AC: 6)
  - [ ] 4.1 –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ (INFO level)
  - [ ] 4.2 –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ —Å –¥–µ—Ç–∞–ª—è–º–∏ (ERROR level)
  - [ ] 4.3 –î–æ–±–∞–≤–∏—Ç—å structured logging —Å user_id, email, template

- [ ] **Task 5: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pending queue (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)** (AC: 7)
  - [ ] 5.1 –°–æ–∑–¥–∞—Ç—å Celery Beat task `monitor_pending_verification_queue`
  - [ ] 5.2 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (2 —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å: 9:00, 17:00)
  - [ ] 5.3 –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å alert –ø–∏—Å—å–º–æ –µ—Å–ª–∏ pending > threshold

- [ ] **Task 6: Unit —Ç–µ—Å—Ç—ã** (AC: 1-6)
  - [ ] 6.1 –¢–µ—Å—Ç: email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è B2B —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  - [ ] 6.2 –¢–µ—Å—Ç: email –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è retail
  - [ ] 6.3 –¢–µ—Å—Ç: retry –ø—Ä–∏ SMTP –æ—à–∏–±–∫–µ
  - [ ] 6.4 –¢–µ—Å—Ç: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ email template

---

## Dev Notes

### Existing Code Reference

**Celery configuration (backend/freesport/celery.py):**

```python
from celery import Celery

app = Celery('freesport')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()
```

[Source: backend/freesport/celery.py]

> [!NOTE]
> Celery —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ. –ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å tasks –≤ `apps/users/tasks.py`.

### Celery Tasks Implementation

```python
# backend/apps/users/tasks.py
import logging
from smtplib import SMTPException

from celery import shared_task
from django.conf import settings
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.utils import timezone

from apps.users.models import User

logger = logging.getLogger(__name__)


@shared_task(
    bind=True,
    max_retries=3,
    autoretry_for=(SMTPException, ConnectionError),
    retry_backoff=True,
    retry_backoff_max=600,  # 10 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
)
def send_admin_verification_email(self, user_id: int) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–¥–∞–≤—à–µ–≥–æ –∑–∞—è–≤–∫—É
        
    Returns:
        True –µ—Å–ª–∏ email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
    """
    try:
        user = User.objects.get(id=user_id)
        
        # –ü–æ–ª—É—á–∞–µ–º email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑ settings.ADMINS
        admin_emails = [email for name, email in settings.ADMINS]
        
        if not admin_emails:
            logger.warning(
                f"No admin emails configured. Skipping notification for user {user_id}"
            )
            return False
        
        # –†–µ–Ω–¥–µ—Ä–∏–º template
        context = {
            'user': user,
            'role_display': user.get_role_display(),
            'company_name': user.company_name,
            'tax_id': user.tax_id,
            'registration_date': user.created_at,
            'admin_url': f'{settings.SITE_URL}/admin/users/user/{user.id}/change/',
        }
        
        html_message = render_to_string(
            'emails/admin_new_verification_request.html',
            context
        )
        plain_message = render_to_string(
            'emails/admin_new_verification_request.txt',
            context
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email
        send_mail(
            subject=f'[FREESPORT] –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞: {user.get_role_display()} - {user.company_name}',
            message=plain_message,
            from_email=None,  # Uses DEFAULT_FROM_EMAIL
            recipient_list=admin_emails,
            html_message=html_message,
            fail_silently=False,
        )
        
        logger.info(
            f"‚úÖ Admin verification email sent successfully",
            extra={
                'user_id': user_id,
                'user_email': user.email,
                'role': user.role,
                'admin_emails': admin_emails,
                'timestamp': timezone.now().isoformat()
            }
        )
        return True
        
    except User.DoesNotExist:
        logger.error(f"User {user_id} not found for verification email")
        return False
        
    except SMTPException as exc:
        logger.error(
            f"‚ùå Failed to send admin verification email for user {user_id}",
            extra={
                'user_id': user_id,
                'exception': str(exc),
                'retry_count': self.request.retries
            }
        )
        raise self.retry(exc=exc)


@shared_task(
    bind=True,
    max_retries=3,
    autoretry_for=(SMTPException, ConnectionError),
    retry_backoff=True,
    retry_backoff_max=600,
)
def send_user_pending_email(self, user_id: int) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Ç–æ–º, —á—Ç–æ –µ–≥–æ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏.
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        True –µ—Å–ª–∏ email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
    """
    try:
        user = User.objects.get(id=user_id)
        
        context = {
            'user': user,
            'first_name': user.first_name,
            'role_display': user.get_role_display(),
            'company_name': user.company_name,
        }
        
        html_message = render_to_string(
            'emails/user_registration_pending.html',
            context
        )
        plain_message = render_to_string(
            'emails/user_registration_pending.txt',
            context
        )
        
        send_mail(
            subject='[FREESPORT] –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞',
            message=plain_message,
            from_email=None,
            recipient_list=[user.email],
            html_message=html_message,
            fail_silently=False,
        )
        
        logger.info(
            f"‚úÖ Pending email sent to user",
            extra={
                'user_id': user_id,
                'user_email': user.email,
                'timestamp': timezone.now().isoformat()
            }
        )
        return True
        
    except User.DoesNotExist:
        logger.error(f"User {user_id} not found for pending email")
        return False
        
    except SMTPException as exc:
        logger.error(
            f"‚ùå Failed to send pending email to user {user_id}: {exc}",
            extra={'user_id': user_id, 'retry_count': self.request.retries}
        )
        raise self.retry(exc=exc)
```

### Email Templates

**templates/emails/admin_new_verification_request.html:**

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #1a365d;">üèÉ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</h1>
        
        <p>–ü–æ–ª—É—á–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é B2B –ø–∞—Ä—Ç–Ω–µ—Ä–∞:</p>
        
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>–§–ò–û:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">{{ user.full_name }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>Email:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">{{ user.email }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>–†–æ–ª—å:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">{{ role_display }}</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>–ö–æ–º–ø–∞–Ω–∏—è:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">{{ company_name }}</td>
            </tr>
            {% if tax_id %}
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>–ò–ù–ù:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">{{ tax_id }}</td>
            </tr>
            {% endif %}
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee;"><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #eee;">{{ registration_date|date:"d.m.Y H:i" }}</td>
            </tr>
        </table>
        
        <p>
            <a href="{{ admin_url }}" 
               style="display: inline-block; padding: 12px 24px; background-color: #3182ce; color: white; text-decoration: none; border-radius: 4px;">
                –û—Ç–∫—Ä—ã—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
            </a>
        </p>
        
        <p style="color: #718096; font-size: 12px; margin-top: 30px;">
            –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã FREESPORT.
        </p>
    </div>
</body>
</html>
```

**templates/emails/user_registration_pending.html:**

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #1a365d;">üèÉ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FREESPORT!</h1>
        
        <p>–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {{ first_name }},</p>
        
        <p>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ –∫–∞—á–µ—Å—Ç–≤–µ <strong>{{ role_display }}</strong> 
        {% if company_name %}({{ company_name }}){% endif %} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞.</p>
        
        <div style="background-color: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 20px 0;">
            <p style="margin: 0; color: #92400e;">
                <strong>‚è≥ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</strong>
            </p>
            <p style="margin: 10px 0 0; color: #92400e;">
                –ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ 
                –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.
            </p>
        </div>
        
        <p>–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç email –∏ —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.</p>
        
        <p>–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:</p>
        <ul>
            <li>Email: support@freesport.ru</li>
            <li>–¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX</li>
        </ul>
        
        <p>–° —É–≤–∞–∂–µ–Ω–∏–µ–º,<br>–ö–æ–º–∞–Ω–¥–∞ FREESPORT</p>
        
        <p style="color: #718096; font-size: 12px; margin-top: 30px;">
            –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —ç—Ç–æ –ø–∏—Å—å–º–æ.
        </p>
    </div>
</body>
</html>
```

**templates/emails/admin_new_verification_request.txt:**

```text
–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é
============================

–ü–æ–ª—É—á–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é B2B –ø–∞—Ä—Ç–Ω–µ—Ä–∞:

–§–ò–û: {{ user.full_name }}
Email: {{ user.email }}
–†–æ–ª—å: {{ role_display }}
–ö–æ–º–ø–∞–Ω–∏—è: {{ company_name }}
{% if tax_id %}–ò–ù–ù: {{ tax_id }}
{% endif %}–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {{ registration_date|date:"d.m.Y H:i" }}

–û—Ç–∫—Ä—ã—Ç—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: {{ admin_url }}

--
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã FREESPORT.
```

**templates/emails/user_registration_pending.txt:**

```text
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FREESPORT!
==============================

–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {{ first_name }},

–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ –∫–∞—á–µ—Å—Ç–≤–µ {{ role_display }}{% if company_name %} ({{ company_name }}){% endif %} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞.

‚è≥ –í–ê–®–ê –ó–ê–Ø–í–ö–ê –ù–ê–•–û–î–ò–¢–°–Ø –ù–ê –†–ê–°–°–ú–û–¢–†–ï–ù–ò–ò

–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏
–≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç email –∏ —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:
- Email: support@freesport.ru
- –¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
–ö–æ–º–∞–Ω–¥–∞ FREESPORT

--
–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ —ç—Ç–æ –ø–∏—Å—å–º–æ.
```

### SITE_URL Configuration

**backend/freesport/settings/base.py (–¥–æ–±–∞–≤–∏—Ç—å):**

```python
# URL —Å–∞–π—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ email templates
SITE_URL = config('SITE_URL', default='http://localhost:3000')
```

**.env.example (–¥–æ–±–∞–≤–∏—Ç—å):**

```bash
# URL —Å–∞–π—Ç–∞ (–¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ email)
SITE_URL=https://freesport.ru
```

### Integration with RegisterView

**–û–±–Ω–æ–≤–∏—Ç—å UserRegistrationSerializer.create():**

```python
# backend/apps/users/serializers.py (MODIFY create method)
from apps.users.tasks import send_admin_verification_email, send_user_pending_email

def create(self, validated_data):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    validated_data.pop("password_confirm")
    password = validated_data.pop("password")
    user = User.objects.create_user(password=password, **validated_data)

    # B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
    if user.role != "retail":
        user.is_verified = False
        user.is_active = False
        user.verification_status = 'pending'
        user.save()
        
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        send_admin_verification_email.delay(user.id)
        send_user_pending_email.delay(user.id)
    else:
        # Retail –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã —Å—Ä–∞–∑—É
        user.is_active = True
        user.verification_status = 'verified'
        user.save()

    return user
```

### Monitoring Task (Optional)

```python
# backend/apps/users/tasks.py (–¥–æ–±–∞–≤–∏—Ç—å)
from datetime import timedelta
from celery.schedules import crontab

@shared_task
def monitor_pending_verification_queue():
    """
    –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–∏ pending –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–π.
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç alert –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞—è–≤–æ–∫ –≤ –æ—á–µ—Ä–µ–¥–∏.
    """
    threshold = 10
    time_window = timezone.now() - timedelta(hours=24)
    
    pending_count = User.objects.filter(
        verification_status='pending',
        created_at__gte=time_window
    ).count()
    
    if pending_count > threshold:
        logger.warning(
            f"‚ö†Ô∏è High pending verification queue: {pending_count} users",
            extra={'pending_count': pending_count, 'threshold': threshold}
        )
        
        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å alert –∞–¥–º–∏–Ω–∞–º
        admin_emails = [email for name, email in settings.ADMINS]
        if admin_emails:
            send_mail(
                subject=f'‚ö†Ô∏è [FREESPORT] Alert: {pending_count} –∑–∞—è–≤–æ–∫ –æ–∂–∏–¥–∞—é—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏',
                message=f'–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –ø–æ—Å—Ç—É–ø–∏–ª–æ {pending_count} –∑–∞—è–≤–æ–∫ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é B2B –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.\n\n'
                        f'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—á–µ—Ä–µ–¥—å –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.',
                from_email=None,
                recipient_list=admin_emails,
            )
    
    return {'pending_count': pending_count, 'alert_sent': pending_count > threshold}
```

**Celery Beat Schedule:**

```python
# backend/freesport/settings/base.py (–¥–æ–±–∞–≤–∏—Ç—å)
from celery.schedules import crontab

CELERY_BEAT_SCHEDULE = {
    'monitor-pending-verification-queue': {
        'task': 'apps.users.tasks.monitor_pending_verification_queue',
        'schedule': crontab(hour='9,17', minute=0),  # 9:00 –∏ 17:00
    },
}
```

### File Locations

| –§–∞–π–ª | –ü—É—Ç—å | –î–µ–π—Å—Ç–≤–∏–µ |
|------|------|----------|
| Settings (SITE_URL) | `backend/freesport/settings/base.py` | MODIFY |
| Env Example | `.env.example` | MODIFY |
| Celery Tasks | `backend/apps/users/tasks.py` | CREATE |
| Admin Email HTML | `backend/templates/emails/admin_new_verification_request.html` | CREATE |
| Admin Email TXT | `backend/templates/emails/admin_new_verification_request.txt` | CREATE |
| User Email HTML | `backend/templates/emails/user_registration_pending.html` | CREATE |
| User Email TXT | `backend/templates/emails/user_registration_pending.txt` | CREATE |
| Serializers | `backend/apps/users/serializers.py` | MODIFY |
| Settings (Celery Beat) | `backend/freesport/settings/base.py` | MODIFY |

---

## Testing

### Test File Location

- `backend/tests/unit/test_email_tasks.py`
- `backend/tests/integration/test_registration_emails.py`

### Test Standards

- **Framework:** Pytest + pytest-celery
- **Mocking:** `@patch('apps.users.tasks.send_mail')`
- **Markers:** `@pytest.mark.unit`, `@pytest.mark.integration`

### Test Cases

```python
# tests/unit/test_email_tasks.py
import pytest
from unittest.mock import patch, MagicMock
from apps.users.tasks import send_admin_verification_email, send_user_pending_email
from apps.users.factories import UserFactory


@pytest.mark.unit
@pytest.mark.django_db
class TestEmailTasks:
    """Unit —Ç–µ—Å—Ç—ã –¥–ª—è Celery email tasks"""
    
    @patch('apps.users.tasks.send_mail')
    def test_send_admin_verification_email_success(self, mock_send_mail):
        """–£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email –∞–¥–º–∏–Ω—É"""
        user = UserFactory(
            role='wholesale_level1',
            company_name='Test Company',
            email='b2b@example.com'
        )
        
        with patch('django.conf.settings.ADMINS', [('Admin', 'admin@example.com')]):
            result = send_admin_verification_email(user.id)
        
        assert result is True
        mock_send_mail.assert_called_once()
        call_kwargs = mock_send_mail.call_args
        assert 'Test Company' in call_kwargs.kwargs['subject']
    
    @patch('apps.users.tasks.send_mail')
    def test_send_user_pending_email_success(self, mock_send_mail):
        """–£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        user = UserFactory(
            first_name='–ò–≤–∞–Ω',
            email='user@example.com',
            role='trainer'
        )
        
        result = send_user_pending_email(user.id)
        
        assert result is True
        mock_send_mail.assert_called_once()
        assert user.email in mock_send_mail.call_args.kwargs['recipient_list']
    
    def test_send_email_user_not_found(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        result = send_admin_verification_email(99999)
        assert result is False


# tests/integration/test_registration_emails.py
@pytest.mark.integration
@pytest.mark.django_db
class TestRegistrationEmails:
    """Integration —Ç–µ—Å—Ç—ã –¥–ª—è email –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    
    @patch('apps.users.tasks.send_admin_verification_email.delay')
    @patch('apps.users.tasks.send_user_pending_email.delay')
    def test_b2b_registration_triggers_emails(
        self, mock_user_email, mock_admin_email
    ):
        """B2B —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É email"""
        client = APIClient()
        
        response = client.post('/api/auth/register/', {
            'email': 'newb2b@example.com',
            'password': 'SecurePass123!',
            'password_confirm': 'SecurePass123!',
            'first_name': 'Test',
            'role': 'trainer',
            'company_name': 'Test Club'
        })
        
        assert response.status_code == 201
        user = User.objects.get(email='newb2b@example.com')
        
        mock_admin_email.assert_called_once_with(user.id)
        mock_user_email.assert_called_once_with(user.id)
    
    @patch('apps.users.tasks.send_admin_verification_email.delay')
    @patch('apps.users.tasks.send_user_pending_email.delay')
    def test_retail_registration_does_not_trigger_emails(
        self, mock_user_email, mock_admin_email
    ):
        """Retail —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É verification emails"""
        client = APIClient()
        
        response = client.post('/api/auth/register/', {
            'email': 'retail@example.com',
            'password': 'SecurePass123!',
            'password_confirm': 'SecurePass123!',
            'first_name': 'Test',
            'role': 'retail'
        })
        
        assert response.status_code == 201
        mock_admin_email.assert_not_called()
        mock_user_email.assert_not_called()
```

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

### PO Validation Report (2025-12-12)

**Validator:** Sarah (PO)  
**Mode:** YOLO (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è)

---

#### 1. Template Compliance ‚úÖ

| Check | Status |
|-------|--------|
| Status section | ‚úÖ Present |
| Story section (As a/I want/So that) | ‚úÖ Present (2 user stories) |
| Acceptance Criteria | ‚úÖ Present (7 criteria) |
| Tasks/Subtasks | ‚úÖ Present (6 tasks, 17 subtasks) |
| Dev Notes | ‚úÖ Present (detailed code examples) |
| Testing section | ‚úÖ Present (unit + integration tests) |
| Dev Agent Record | ‚úÖ Present (placeholder) |
| QA Results | ‚úÖ Present (this section) |
| Change Log | ‚úÖ Present |

**Unfilled Placeholders:** None

---

#### 2. File Structure & Source Tree ‚úÖ

| Check | Status |
|-------|--------|
| File paths clearly specified | ‚úÖ Table in Dev Notes (L470-479) |
| Source tree relevance | ‚úÖ References to `apps/users/tasks.py`, `templates/emails/` |
| Directory structure correct | ‚úÖ Follows Django/Celery conventions |
| File creation sequence | ‚úÖ Logical order (Tasks ‚Üí Templates ‚Üí Integration) |
| Path accuracy | ‚úÖ Consistent with project structure |

---

#### 3. UI/Frontend Completeness ‚úÖ

**N/A** ‚Äî Story 29.4 is backend-only (Celery tasks, email templates). No UI components.

---

#### 4. Acceptance Criteria Coverage ‚úÖ

| AC | Description | Covered by Tasks |
|----|-------------|------------------|
| AC1 | B2B —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí admin + user emails | Task 1, Task 3 |
| AC2 | Retail ‚Üí NO verification emails | Task 3.2 (conditional call) |
| AC3 | Email —á–µ—Ä–µ–∑ Celery async | Task 1 (`@shared_task`) |
| AC4 | Retry —Å exponential backoff | Task 1.4 (`retry_backoff=True`) |
| AC5 | Django templates (HTML + TXT) | Task 2 (4 templates) |
| AC6 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ success/failure | Task 4 (structured logging) |
| AC7 | Celery Beat monitoring (optional) | Task 5 |

**Task-to-AC Mapping:** ‚úÖ Explicit in task headers

---

#### 5. Testing Instructions ‚úÖ

| Check | Status |
|-------|--------|
| Test approach clarity | ‚úÖ Pytest + `@patch` for email mocking |
| Test scenarios | ‚úÖ 5 test cases in code examples |
| Validation steps | ‚úÖ Integration tests verify task calls |
| Testing frameworks | ‚úÖ Pytest, pytest-celery, factory_boy |
| Test data | ‚úÖ UserFactory with role parameter |

---

#### 6. Security Considerations ‚úÖ

| Check | Status |
|-------|--------|
| Security requirements | ‚úÖ SMTP credentials in `.env` |
| Authentication | N/A (system tasks) |
| Data protection | ‚úÖ No PII beyond user email/name |
| Sensitive data | ‚úÖ Uses `settings.ADMINS` (configurable) |

---

#### 7. Tasks Sequence ‚úÖ

| Check | Status |
|-------|--------|
| Logical order | ‚úÖ Celery tasks ‚Üí Templates ‚Üí Integration ‚Üí Logging ‚Üí Tests |
| Dependencies | ‚úÖ Stories dependency noted (29.3 required) |
| Granularity | ‚úÖ Subtasks are atomic and actionable |
| Completeness | ‚úÖ All AC covered |

---

#### 8. Anti-Hallucination Verification ‚úÖ

| Claim | Source Verification |
|-------|---------------------|
| Celery configured in project | ‚úÖ Verified: `backend/freesport/celery.py` exists |
| `app.autodiscover_tasks()` | ‚úÖ Verified: Line 23 in celery.py |
| `User.role` field exists | ‚úÖ Verified: `apps/users/serializers.py` L37, 63 |
| `settings.ADMINS` available | ‚úÖ Django standard, documented in Epic 29.3 |
| `verification_status` field | ‚úÖ Verified: Epic 29 L150, L178 |
| `send_mail` from `django.core.mail` | ‚úÖ Django built-in |
| `@shared_task` from Celery | ‚úÖ Standard Celery decorator |

**Invented Details:** None found

---

#### 9. Dev Agent Implementation Readiness ‚úÖ

| Check | Status |
|-------|--------|
| Self-contained context | ‚úÖ Full code examples provided |
| Clear instructions | ‚úÖ Explicit file paths and code snippets |
| Complete technical context | ‚úÖ Celery config, template structure, retry logic |
| Missing information | None |
| Actionability | ‚úÖ All tasks are copy-paste ready |

---

### Final Assessment

| Metric | Value |
|--------|-------|
| **Decision** | **GO** ‚úÖ |
| **Implementation Readiness Score** | **10/10** |
| **Confidence Level** | **High** |

---

### Issues Summary

#### Critical Issues (Must Fix)
None

#### Should-Fix Issues
None

#### Nice-to-Have Improvements
~~1. **Plain text templates:** Templates `.txt` files should mirror HTML structure (currently only referenced, no code example)~~  
‚úÖ **FIXED** in v1.2 ‚Äî Added `.txt` template examples

~~2. **SITE_URL setting:** Dev Notes reference `settings.SITE_URL` but should confirm it exists or add a task to create it~~  
‚úÖ **FIXED** in v1.2 ‚Äî Added Task 0 and SITE_URL Configuration section

---

**Recommendation:** Story is ready for implementation. Dev Agent has full context to complete all tasks without reading external architecture documents.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | Initial story draft | Bob (SM) |
| 2025-12-12 | 1.1 | PO Validation: GO (9/10), –¥–æ–±–∞–≤–ª–µ–Ω QA Results | Sarah (PO) |
| 2025-12-12 | 1.2 | Nice-to-Have: Task 0 (SITE_URL), .txt templates, File Locations update | Sarah (PO) |
