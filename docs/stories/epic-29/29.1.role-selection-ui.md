# Story 29.1: Role Selection UI & Warnings

## Status

Draft

---

## Story

**As a** Guest User,  
**I want** to select my role (Retail, Trainer, Wholesaler, Federation) during registration,  
**so that** I can access the platform with correct privileges and pricing.

---

## Acceptance Criteria

1. Поле "Роль" присутствует в форме регистрации и имеет 4 опции:
   - Розничный покупатель (retail) — **по умолчанию**
   - Тренер / Спортивный клуб (trainer)
   - Оптовик (wholesale_level1)
   - Представитель спортивной федерации (federation_rep)

2. "Розничный покупатель" выбран по умолчанию при загрузке формы

3. При выборе не-розничной роли (trainer, wholesale_level1, federation_rep) появляется информационный блок (InfoPanel) с текстом:
   - "Вам потребуется заполнить дополнительные данные"
   - "Доступ к порталу будет открыт после проверки администратором"
   - "Вы получите уведомление на email"

4. Форма передает выбранную роль в backend API через поле `role`

5. **Accessibility:** Role Selector доступен с клавиатуры (Tab, Enter, Arrow keys)

6. **Accessibility:** InfoPanel имеет `role="alert"` и `aria-live="polite"` для screen readers

7. UI следует Design System из `docs/frontend/design-system.json`

8. Условные поля для B2B ролей отображаются при выборе не-розничной роли:
   - `company_name` — Название компании (обязательно для всех B2B)
   - `tax_id` — ИНН (обязательно для wholesale и federation_rep)

---

## Tasks / Subtasks

- [ ] **Task 1: Обновить RegisterForm компонент** (AC: 1, 2, 4)
  - [ ] 1.1 Добавить импорт для role selector (Select или custom Dropdown)
  - [ ] 1.2 Добавить state для выбранной роли: `useState<UserRole>('retail')`
  - [ ] 1.3 Создать константу `ROLE_OPTIONS` с 4-мя опциями
  - [ ] 1.4 Добавить поле выбора роли в форму (после email, перед паролем)
  - [ ] 1.5 Обновить `registerData` для передачи роли в API

- [ ] **Task 2: Создать компонент RoleInfoPanel** (AC: 3, 6)
  - [ ] 2.1 Создать файл `frontend/src/components/auth/RoleInfoPanel.tsx`
  - [ ] 2.2 Реализовать условное отображение (visible когда role !== 'retail')
  - [ ] 2.3 Добавить `role="alert"` и `aria-live="polite"` для accessibility
  - [ ] 2.4 Стилизовать панель согласно Design System (warning colors)

- [ ] **Task 3: Добавить условные B2B поля** (AC: 8)
  - [ ] 3.1 Добавить поле `company_name` (отображается для всех B2B ролей)
  - [ ] 3.2 Добавить поле `tax_id` (отображается для wholesale_level1, federation_rep)
  - [ ] 3.3 Реализовать условную валидацию через Zod refinement
  - [ ] 3.4 Обновить `RegisterFormData` типы

- [ ] **Task 4: Accessibility тестирование** (AC: 5, 6)
  - [ ] 4.1 Добавить keyboard navigation для Role Selector
  - [ ] 4.2 Проверить focus visible для всех интерактивных элементов
  - [ ] 4.3 Проверить color contrast ≥ 4.5:1 (WCAG AA)

- [ ] **Task 5: Unit тесты** (AC: 1-8)
  - [ ] 5.1 Тест: роль "retail" выбрана по умолчанию
  - [ ] 5.2 Тест: InfoPanel появляется при выборе B2B роли
  - [ ] 5.3 Тест: условные поля company_name/tax_id отображаются для B2B
  - [ ] 5.4 Тест: форма передает role в API
  - [ ] 5.5 Тест: keyboard navigation работает

---

## Dev Notes

### Existing Code Reference

> [!NOTE]
> **Текущая реализация RegisterForm.tsx хардкодит role='retail':**

```typescript
// frontend/src/components/auth/RegisterForm.tsx (L51-58)
const registerData: RegisterRequest = {
  email: data.email,
  password: data.password,
  password_confirm: data.confirmPassword,
  first_name: data.first_name,
  last_name: '',
  phone: '',
  role: 'retail',  // <-- ХАРДКОД! Нужно заменить на selected role
};
```

[Source: frontend/src/components/auth/RegisterForm.tsx#L51-L58]

### Data Models

**User.ROLE_CHOICES (backend/apps/users/models.py:72-80):**

```python
ROLE_CHOICES = [
    ("retail", "Розничный покупатель"),
    ("wholesale_level1", "Оптовик уровень 1"),
    ("wholesale_level2", "Оптовик уровень 2"),
    ("wholesale_level3", "Оптовик уровень 3"),
    ("trainer", "Тренер/Фитнес-клуб"),
    ("federation_rep", "Представитель федерации"),
    ("admin", "Администратор"),
]
```

[Source: backend/apps/users/models.py#L72-L80]

> [!IMPORTANT]
> Для регистрации доступны только 4 роли: `retail`, `trainer`, `wholesale_level1`, `federation_rep`.
> Роли `wholesale_level2`, `wholesale_level3`, `admin` устанавливаются только администратором.

### API Specifications

**POST /api/auth/register/** (docs/architecture/03-api-specification.md)

Текущий request body уже поддерживает поле `role`:

```typescript
interface RegisterRequest {
  email: string;
  password: string;
  password_confirm: string;
  first_name: string;
  last_name?: string;
  phone?: string;
  role?: 'retail' | 'trainer' | 'wholesale_level1' | 'federation_rep';  // default: 'retail'
  company_name?: string;  // required для B2B
  tax_id?: string;        // required для wholesale, federation_rep
}
```

### Component Specifications

**Role Selector варианты реализации:**

1. **Native Select** (рекомендуется для accessibility):
```tsx
<select 
  value={selectedRole} 
  onChange={(e) => setSelectedRole(e.target.value as UserRole)}
  aria-label="Выберите тип аккаунта"
>
  {ROLE_OPTIONS.map(opt => (
    <option key={opt.value} value={opt.value}>{opt.label}</option>
  ))}
</select>
```

2. **Custom Dropdown** (если требуется кастомный дизайн):
   - Использовать `role="listbox"` + `aria-activedescendant`
   - Реализовать keyboard navigation (Arrow Up/Down, Enter, Escape)

**InfoPanel компонент:**

```tsx
interface RoleInfoPanelProps {
  visible: boolean;
}

export const RoleInfoPanel: React.FC<RoleInfoPanelProps> = ({ visible }) => {
  if (!visible) return null;
  
  return (
    <div 
      role="alert" 
      aria-live="polite"
      className="p-4 rounded-lg bg-warning-50 border border-warning-300"
    >
      <ul className="space-y-2 text-body-s text-warning-700">
        <li>• Вам потребуется заполнить дополнительные данные</li>
        <li>• Доступ к порталу будет открыт после проверки администратором</li>
        <li>• Вы получите уведомление на email</li>
      </ul>
    </div>
  );
};
```

### File Locations

| Файл | Путь | Действие |
|------|------|----------|
| RegisterForm | `frontend/src/components/auth/RegisterForm.tsx` | MODIFY |
| RoleInfoPanel | `frontend/src/components/auth/RoleInfoPanel.tsx` | CREATE |
| authSchemas | `frontend/src/schemas/authSchemas.ts` | MODIFY |
| API types | `frontend/src/types/api.ts` | VERIFY |
| Tests | `frontend/src/components/auth/__tests__/RegisterForm.test.tsx` | MODIFY |
| RoleInfoPanel Tests | `frontend/src/components/auth/__tests__/RoleInfoPanel.test.tsx` | CREATE |

### Design System Reference

> [!NOTE]
> Использовать цвета из Design System для InfoPanel:

- **Warning background:** `var(--color-warning-50)` или `bg-warning-50`
- **Warning border:** `var(--color-warning-300)` или `border-warning-300`
- **Warning text:** `var(--color-warning-700)` или `text-warning-700`
- **Focus ring:** `focus:ring-2 focus:ring-primary-500 focus:ring-offset-2`

[Source: docs/frontend/design-system.json]

---

## Testing

### Test File Location

- `frontend/src/components/auth/__tests__/RegisterForm.test.tsx`
- `frontend/src/components/auth/__tests__/RoleInfoPanel.test.tsx`

### Test Standards

- **Framework:** Vitest + React Testing Library
- **Pattern:** Arrange-Act-Assert
- **Coverage:** Минимум 80% для новых компонентов

### Test Cases

```typescript
// RegisterForm.test.tsx
describe('RegisterForm with Role Selection', () => {
  it('should have "retail" role selected by default', async () => {
    render(<RegisterForm />);
    const roleSelect = screen.getByLabelText(/тип аккаунта/i);
    expect(roleSelect).toHaveValue('retail');
  });

  it('should show InfoPanel when B2B role is selected', async () => {
    render(<RegisterForm />);
    const roleSelect = screen.getByLabelText(/тип аккаунта/i);
    await userEvent.selectOptions(roleSelect, 'trainer');
    
    expect(screen.getByRole('alert')).toBeInTheDocument();
    expect(screen.getByText(/после проверки администратором/i)).toBeInTheDocument();
  });

  it('should show company_name field for B2B roles', async () => {
    render(<RegisterForm />);
    await userEvent.selectOptions(screen.getByLabelText(/тип аккаунта/i), 'wholesale_level1');
    
    expect(screen.getByLabelText(/название компании/i)).toBeInTheDocument();
  });

  it('should show tax_id field for wholesale and federation roles', async () => {
    render(<RegisterForm />);
    await userEvent.selectOptions(screen.getByLabelText(/тип аккаунта/i), 'wholesale_level1');
    
    expect(screen.getByLabelText(/инн/i)).toBeInTheDocument();
  });

  it('should submit form with selected role', async () => {
    const mockRegister = vi.spyOn(authService, 'register').mockResolvedValue({...});
    
    render(<RegisterForm />);
    await userEvent.selectOptions(screen.getByLabelText(/тип аккаунта/i), 'trainer');
    // Fill other fields...
    await userEvent.click(screen.getByRole('button', { name: /зарегистрироваться/i }));
    
    expect(mockRegister).toHaveBeenCalledWith(expect.objectContaining({
      role: 'trainer'
    }));
  });
});
```

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | Initial story draft | Bob (SM) |
