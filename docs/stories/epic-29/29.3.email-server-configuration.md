# Story 29.3: Email Server Configuration

## Status

Draft

---

## Story

**As a** Developer,  
**I want** to configure email server settings,  
**so that** the system can send notifications to admins and users.

---

> [!IMPORTANT]
> **BLOCKING DEPENDENCY:** Эта история должна быть завершена ПЕРЕД Story 29.4 (Email Notification System), так как Celery tasks требуют настроенного SMTP сервера.

---

## Acceptance Criteria

1. В `settings/base.py` или `settings/production.py` настроены email параметры:
   - `EMAIL_BACKEND`
   - `EMAIL_HOST`, `EMAIL_PORT`, `EMAIL_USE_TLS`
   - `EMAIL_HOST_USER`, `EMAIL_HOST_PASSWORD`
   - `DEFAULT_FROM_EMAIL`

2. Email credentials хранятся в `.env` файле (не захардкожены в коде)

3. В development режиме используется `console.EmailBackend` или Mailhog для тестирования

4. В production используется реальный SMTP (Yandex для freesport.ru или Gmail)

5. `settings.ADMINS` настроены через переменную окружения `ADMIN_EMAILS`

6. `.env.example` обновлен с новыми переменными

7. Тестовое письмо успешно отправляется через Django shell

---

## Tasks / Subtasks

- [ ] **Task 1: Обновить Django settings** (AC: 1, 3, 4)
  - [ ] 1.1 Добавить email настройки в `settings/base.py`
  - [ ] 1.2 Использовать `config()` из `python-decouple` для чтения из `.env`
  - [ ] 1.3 Настроить `EMAIL_BACKEND` (console для dev, smtp для prod)
  - [ ] 1.4 Настроить `DEFAULT_FROM_EMAIL`

- [ ] **Task 2: Настроить settings.ADMINS** (AC: 5)
  - [ ] 2.1 Парсить `ADMIN_EMAILS` из environment variable
  - [ ] 2.2 Создать list of tuples для `ADMINS` setting
  - [ ] 2.3 Добавить fallback на пустой список

- [ ] **Task 3: Обновить .env файлы** (AC: 2, 6)
  - [ ] 3.1 Добавить email переменные в `.env.example` (root: `/.env.example`)
  - [ ] 3.2 Добавить комментарии с примерами для Gmail и Yandex
  - [ ] 3.3 Обновить `.env.prod.example` (root: `/.env.prod.example`)

- [ ] **Task 4: Документация для DevOps** (AC: 1-7)
  - [ ] 4.1 Создать секцию в README или отдельный doc
  - [ ] 4.2 Документировать как получить App Password для Gmail
  - [ ] 4.3 Документировать rate limits провайдеров

- [ ] **Task 5: Тестирование** (AC: 7)
  - [ ] 5.1 Проверить отправку через Django shell
  - [ ] 5.2 Проверить доставку на реальный email (вручную)
  - [ ] 5.3 Создать management command для проверки email config

- [ ] **Task 6: Добавить Mailhog в docker-compose.yml** (AC: 3)
  - [ ] 6.1 Добавить сервис `mailhog` в `docker/docker-compose.yml`
  - [ ] 6.2 Добавить EMAIL_* переменные в backend и celery сервисы
  - [ ] 6.3 Документировать доступ к Mailhog UI (http://localhost:8025)

---

## Dev Notes

### Existing Code Reference

**settings/base.py structure:**

```python
# backend/freesport/settings/base.py
from decouple import config

# Email settings should be added here
```

[Source: backend/freesport/settings/base.py]

> [!NOTE]
> Проект уже использует `python-decouple` для environment variables.

### Email Configuration

**Development Configuration (Console Backend):**

```python
# backend/freesport/settings/development.py
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
```

**Production Configuration (SMTP):**

```python
# backend/freesport/settings/base.py (или production.py)
from decouple import config, Csv

# Email Configuration
EMAIL_BACKEND = config(
    'EMAIL_BACKEND',
    default='django.core.mail.backends.smtp.EmailBackend'
)
EMAIL_HOST = config('EMAIL_HOST', default='smtp.yandex.ru')
EMAIL_PORT = config('EMAIL_PORT', default=587, cast=int)
EMAIL_USE_TLS = config('EMAIL_USE_TLS', default=True, cast=bool)
EMAIL_HOST_USER = config('EMAIL_HOST_USER', default='')
EMAIL_HOST_PASSWORD = config('EMAIL_HOST_PASSWORD', default='')
DEFAULT_FROM_EMAIL = config(
    'DEFAULT_FROM_EMAIL',
    default='noreply@freesport.ru'
)

# Admin emails for notifications
ADMIN_EMAILS = config('ADMIN_EMAILS', default='', cast=Csv())
ADMINS = [
    ('Admin', email.strip())
    for email in ADMIN_EMAILS
    if email.strip()
]
```

### .env.example Updates

```bash
# === НАСТРОЙКИ EMAIL ===
# Development: используйте console backend
# EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend

# Production: SMTP настройки
# Для Gmail:
# EMAIL_HOST=smtp.gmail.com
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=your-email@gmail.com
# EMAIL_HOST_PASSWORD=your-16-digit-app-password
# (Создать App Password: https://support.google.com/accounts/answer/185833)

# Для Yandex (рекомендуется для freesport.ru):
EMAIL_HOST=smtp.yandex.ru
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=noreply@freesport.ru
EMAIL_HOST_PASSWORD=your-yandex-password
DEFAULT_FROM_EMAIL=noreply@freesport.ru

# Список email администраторов (через запятую)
# Получат уведомления о новых B2B заявках
ADMIN_EMAILS=admin1@freesport.ru,admin2@freesport.ru
```

### SMTP Provider Rate Limits

> [!WARNING]
> Учитывать лимиты SMTP провайдеров:

| Provider | Лимит | Рекомендация |
|----------|-------|--------------|
| Gmail | 500 emails/день | Только для development |
| Yandex Mail | 100-500/день* | Уточнить с провайдером |
| SendGrid Free | 100/день | Альтернатива для production |
| SendGrid Paid | 40,000+/месяц | Рекомендуется для scale |

*Для freesport.ru domain рекомендуется Yandex Mail для домена или SendGrid.

### Mailhog Configuration (Development)

> [!TIP]
> Mailhog — локальный SMTP сервер для тестирования email без реальной отправки

**Docker Compose сервис (добавить в `docker/docker-compose.yml`):**

```yaml
  # Mailhog - Email testing for development
  mailhog:
    image: mailhog/mailhog:latest
    container_name: freesport-mailhog
    ports:
      - "1025:1025"   # SMTP server
      - "8025:8025"   # Web UI
    networks:
      - freesport-network
    restart: unless-stopped
```

**Environment variables для backend и celery сервисов:**

```yaml
  backend:
    environment:
      # ... existing vars ...
      - EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
      - EMAIL_HOST=mailhog
      - EMAIL_PORT=1025
      - EMAIL_USE_TLS=False
      - DEFAULT_FROM_EMAIL=noreply@freesport.local
```

**Доступ:**
- **Mailhog UI:** http://localhost:8025
- **SMTP Server:** mailhog:1025 (внутри Docker network)

### File Locations

| Файл | Путь | Действие |
|------|------|----------|
| Base Settings | `backend/freesport/settings/base.py` | MODIFY |
| Dev Settings | `backend/freesport/settings/development.py` | MODIFY |
| Prod Settings | `backend/freesport/settings/production.py` | VERIFY |
| .env.example | `.env.example` (root) | MODIFY |
| .env.prod.example | `.env.prod.example` (root) | MODIFY |
| Docker Compose | `docker/docker-compose.yml` | MODIFY |
| Management Command | `backend/apps/common/management/commands/test_email.py` | CREATE |

### Testing Commands

**Manual test via Django shell:**

```python
python manage.py shell
>>> from django.core.mail import send_mail
>>> send_mail(
...     'Test Email from FREESPORT',
...     'This is a test message to verify email configuration.',
...     None,  # Uses DEFAULT_FROM_EMAIL
...     ['admin@freesport.ru'],
...     fail_silently=False,
... )
1  # Returns 1 if successful
```

**Management command for testing (CREATE):**

```python
# backend/apps/common/management/commands/test_email.py
from django.core.management.base import BaseCommand
from django.core.mail import send_mail
from django.conf import settings


class Command(BaseCommand):
    help = 'Test email configuration by sending a test email'

    def add_arguments(self, parser):
        parser.add_argument(
            '--to',
            type=str,
            help='Email address to send test to',
            required=True
        )

    def handle(self, *args, **options):
        to_email = options['to']
        
        self.stdout.write(f'Sending test email to {to_email}...')
        self.stdout.write(f'Using EMAIL_HOST: {settings.EMAIL_HOST}')
        self.stdout.write(f'Using DEFAULT_FROM_EMAIL: {settings.DEFAULT_FROM_EMAIL}')
        
        try:
            result = send_mail(
                subject='[FREESPORT] Test Email',
                message='Это тестовое письмо для проверки email конфигурации.',
                from_email=None,
                recipient_list=[to_email],
                fail_silently=False,
            )
            
            if result:
                self.stdout.write(
                    self.style.SUCCESS(f'✅ Email sent successfully to {to_email}')
                )
            else:
                self.stdout.write(
                    self.style.ERROR('❌ Email sending returned 0')
                )
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'❌ Failed to send email: {e}')
            )
```

**Usage:**

```bash
python manage.py test_email --to admin@freesport.ru
```

---

## Testing

### Test File Location

- `backend/tests/unit/test_email_config.py`

### Test Standards

- **Framework:** Pytest
- **Markers:** `@pytest.mark.unit`
- No integration tests needed (manual verification)

### Test Cases

```python
# tests/unit/test_email_config.py
import pytest
from django.conf import settings


@pytest.mark.unit
class TestEmailConfiguration:
    """Unit тесты для email конфигурации"""
    
    def test_email_backend_is_configured(self):
        """EMAIL_BACKEND настроен"""
        assert hasattr(settings, 'EMAIL_BACKEND')
        assert settings.EMAIL_BACKEND is not None
    
    def test_default_from_email_is_set(self):
        """DEFAULT_FROM_EMAIL настроен"""
        assert hasattr(settings, 'DEFAULT_FROM_EMAIL')
        assert settings.DEFAULT_FROM_EMAIL
        assert '@' in settings.DEFAULT_FROM_EMAIL
    
    def test_admins_list_format(self):
        """ADMINS имеет правильный формат"""
        assert hasattr(settings, 'ADMINS')
        assert isinstance(settings.ADMINS, list)
        for admin in settings.ADMINS:
            assert isinstance(admin, tuple)
            assert len(admin) == 2
            name, email = admin
            assert isinstance(name, str)
            assert '@' in email
```

---

## User Actions Required

> [!NOTE]
> Перед началом разработки, пользователь (или DevOps) должен:

1. **Выбрать SMTP provider:**
   - **Development:** Gmail (бесплатно, лимит 500 писем/день)
   - **Production:** Yandex Mail для домена freesport.ru

2. **Создать аккаунт и получить credentials:**
   
   **Gmail App Password:**
   - Перейти: https://support.google.com/accounts/answer/185833
   - Включить 2-Step Verification для аккаунта
   - Создать App Password для "Mail"
   - Скопировать 16-значный пароль (без пробелов)

   **Yandex Mail для домена:**
   - Перейти: https://connect.yandex.ru/portal/admin
   - Создать почтовый ящик для домена (например, `noreply@freesport.ru`)
   - SMTP параметры: `smtp.yandex.ru`, порт `587`, TLS

3. **Настроить .env файл** с полученными credentials

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-12 | 1.0 | Initial story draft | Bob (SM) |
| 2025-12-12 | 1.1 | PO Validation: уточнены пути .env файлов, добавлен Task 6 (Mailhog), секция Mailhog Configuration | Sarah (PO) |
