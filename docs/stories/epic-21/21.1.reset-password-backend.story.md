# Story 21.1: Backend реализации сброса пароля

## Status

Planned

## Story

**As a** зарегистрированный пользователь,
**I want** получить письмо со ссылкой на сброс пароля, если я его забыл,
**so that** я мог восстановить доступ к своему аккаунту.

## Acceptance Criteria

1. API `POST /api/v1/auth/password-reset/` принимает email.
2. Если пользователь с таким email существует и активен:
    - Генерируется уникальный токен сброса пароля.
    - Создается асинхронная задача Celery для отправки письма.
    - Письмо отправляется на указанный email.
3. Письмо содержит:
    - Приветствие.
    - Ссылку на сброс пароля вида: `http://localhost:3000/password-reset/confirm/{uid}/{token}/` (домен берется из настроек).
    - Инструкцию "Если вы не запрашивали сброс пароля, проигнорируйте это письмо".
4. API всегда возвращает 200 OK и сообщение "Если данный email зарегистрирован, вы получите инструкции по сбросу пароля", чтобы не раскрывать наличие пользователей в базе.
5. Повторные запросы ограничиваются (Rate Limiting - опционально, но желательно).
6. Unit-тесты проверяют вызов Celery задачи при валидном email.

## Tasks / Subtasks

- [ ] **Task 1: Email Template**
  - [ ] Создать HTML шаблон письма `password_reset_email.html`.
  - [ ] Создать текстовую версию `password_reset_email.txt`.
- [ ] **Task 2: Celery Task**
  - [ ] Создать задачу `send_password_reset_email` в `backend/apps/users/tasks.py`.
  - [ ] Задача должна принимать `user_id` и генерировать токен внутри (или принимать уже готовые параметры, но лучше генерировать ссылку внутри для актуальности, или передавать uid/token). *Уточнение: View уже генерирует token, проще передать uid, token и email в задачу.*
- [ ] **Task 3: Update View**
  - [ ] Модифицировать `PasswordResetRequestView` в `backend/apps/users/views/authentication.py`.
  - [ ] Заменить `print()` на вызов `send_password_reset_email.delay()`.
- [ ] **Task 4: Tests**
  - [ ] Проверить существующие тесты для `PasswordResetRequestView`.
  - [ ] Добавить тесты, мокающие celery задачу, чтобы проверить, что она вызывается.

## Technical Notes

- Существующий `PasswordResetRequestView` уже содержит логику генерации токена.
- `uid` кодируется как `urlsafe_base64_encode(force_bytes(user.pk))`.
- Url формируется с учетом `settings.SITE_URL` или переменной окружения `NEXT_PUBLIC_APP_URL`. В `CLAUDE.md` или `.env` нужно проверить наличие переменной для frontend URL. Обычно это `SITE_URL` или `FRONTEND_URL`. Будем использовать `settings.SITE_URL`.

## Dev Notes

- Файл views: `backend/apps/users/views/authentication.py`
- Файл tasks: `backend/apps/users/tasks.py`
