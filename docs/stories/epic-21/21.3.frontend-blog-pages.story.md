# Story 21.3: Frontend страницы блога

<!-- Powered by BMAD™ Core -->

## Status

Approved

---

## Story

**As a** посетитель сайта,
**I want** просматривать список статей блога и отдельные статьи,
**so that** я могу читать полезный контент и быть в курсе событий компании.

---

## Acceptance Criteria

1. Создана страница `/blog` (`frontend/src/app/blog/page.tsx`) со списком статей и пагинацией
2. Создана страница `/blog/[slug]` (`frontend/src/app/blog/[slug]/page.tsx`) с детальной статьёй
3. Создан сервис `frontend/src/services/blogService.ts` для работы с Blog API
4. Добавлены TypeScript типы `BlogItem` и `BlogList` в `frontend/src/types/api.ts`
5. SEO metadata настроена для обеих страниц (title, description, OpenGraph)
6. Добавлена ссылка "Блог" в Header navigation (после "Новости")
7. Responsive дизайн работает корректно (mobile, tablet, desktop)
8. Unit-тесты покрывают сервис и страницы (>=70% покрытие)

---

## Tasks / Subtasks

- [ ] **Task 1: Добавить TypeScript типы** (AC: 4)
  - [ ] Добавить интерфейс `BlogItem` в `frontend/src/types/api.ts`
    - Поля: `id`, `title`, `slug`, `subtitle`, `excerpt`, `content`, `image`, `author`, `category`, `published_at`, `created_at`, `updated_at`, `meta_title`, `meta_description`
  - [ ] Добавить интерфейс `BlogList` (PaginatedResponse для BlogItem)

- [ ] **Task 2: Создать blogService.ts** (AC: 3)
  - [ ] Создать файл `frontend/src/services/blogService.ts` по образцу `newsService.ts`
  - [ ] Реализовать метод `getBlogPosts(params)` — список статей для страницы /blog
  - [ ] Реализовать метод `getBlogPostBySlug(slug)` — детальная статья
  - [ ] Использовать endpoint `/blog/` (без `/api/v1/` — apiClient добавляет базовый URL)

- [ ] **Task 3: Создать страницу списка /blog** (AC: 1, 5, 7)
  - [ ] Создать директорию `frontend/src/app/blog/`
  - [ ] Создать файл `frontend/src/app/blog/page.tsx` по образцу `news/page.tsx`
  - [ ] Экспортировать `metadata` с SEO-данными (title, description, openGraph)
  - [ ] Реализовать Server Component с fetching через blogService
  - [ ] Добавить Breadcrumb: Главная → Блог
  - [ ] Добавить Hero Section с заголовком "Блог" и описанием
  - [ ] Реализовать grid с карточками статей (3 колонки desktop, 2 tablet, 1 mobile)
  - [ ] Реализовать пагинацию (prev/next + номера страниц)
  - [ ] Добавить Empty State с иконкой и сообщением "Статей пока нет"

- [ ] **Task 4: Создать страницу детальной статьи /blog/[slug]** (AC: 2, 5, 7)
  - [ ] Создать директорию `frontend/src/app/blog/[slug]/`
  - [ ] Создать файл `frontend/src/app/blog/[slug]/page.tsx` по образцу `news/[slug]/page.tsx`
  - [ ] Реализовать `generateMetadata()` для динамических SEO meta-тегов
    - Использовать `meta_title` и `meta_description` из API (если есть), иначе fallback на title/excerpt
  - [ ] Реализовать Server Component с fetching через blogService
  - [ ] Добавить Breadcrumb: Главная → Блог → {title}
  - [ ] Отобразить изображение статьи (aspect-video, rounded-xl)
  - [ ] Отобразить meta-информацию: дата публикации, автор (если есть), категория (если есть)
  - [ ] Отобразить subtitle (если есть)
  - [ ] Отобразить content через `dangerouslySetInnerHTML` с prose-классами
    - ⚠️ **Безопасность:** HTML-контент санитизируется на backend (Django Admin) — дополнительная санитизация на frontend не требуется
  - [ ] Добавить ссылку "Назад к блогу"
  - [ ] Обработать 404 через `notFound()` при отсутствии статьи

- [ ] **Task 5: Обновить Header navigation** (AC: 6)
  - [ ] В `frontend/src/components/layout/Header.tsx` добавить пункт меню в `navigationItems`
  - [ ] Добавить: `{ href: '/blog', label: 'Блог' }` после пункта "Новости"
  - [ ] Проверить что новый пункт отображается и на desktop, и в mobile menu

- [ ] **Task 6: Использовать NewsCard для карточек блога** (AC: 1, 7)
  - [ ] Импортировать `NewsCard` из `@/components/home/NewsCard`
  - [ ] Использовать его в grid на странице /blog (props: title, excerpt, image, publishedAt)
  - [ ] Убедиться что NewsCard корректно работает с данными BlogItem

- [ ] **Task 7: Добавить Loading/Skeleton States** (AC: 7)
  - [ ] Создать `frontend/src/app/blog/loading.tsx` — скелетон для страницы списка
  - [ ] Создать `frontend/src/app/blog/[slug]/loading.tsx` — скелетон для детальной страницы
  - [ ] Использовать Tailwind animate-pulse для skeleton-эффекта
  - [ ] Обеспечить консистентность с loading states новостей (если есть)

- [ ] **Task 8: Написать unit-тесты** (AC: 8)
  - [ ] Создать файл `frontend/src/services/__tests__/blogService.test.ts`
    - Тест: getBlogPosts возвращает корректные данные
    - Тест: getBlogPostBySlug возвращает статью по slug
    - Тест: getBlogPostBySlug бросает ошибку при 404
  - [ ] Создать файл `frontend/src/app/blog/__tests__/page.test.tsx`
    - Тест: рендер списка статей
    - Тест: рендер empty state при пустом списке
    - Тест: рендер пагинации при >1 страницы
  - [ ] Создать файл `frontend/src/app/blog/[slug]/__tests__/page.test.tsx`
    - Тест: рендер детальной страницы
    - Тест: корректный SEO metadata

---

## Dev Notes

### Референсная реализация

Страницы блога создаются по образцу страниц новостей (Epic 20) для консистентности UX. [Source: epic-21.blog-management.md#Existing System Context]

### Паттерн newsService.ts (референс)

```typescript
import apiClient from './api-client';
import type { NewsList, NewsItem } from '@/types/api';

interface GetNewsParams {
  page_size?: number;
  page?: number;
}

export const newsService = {
  async getNewsList(params?: GetNewsParams): Promise<NewsList> {
    const { data } = await apiClient.get<NewsList>('/news', {
      params: {
        page_size: 12,
        ...params,
      },
    });
    return data;
  },

  async getNewsBySlug(slug: string): Promise<NewsItem> {
    try {
      const { data } = await apiClient.get<NewsItem>(`/news/${slug}/`);
      return data;
    } catch (error: any) {
      if (error.response?.status === 404) {
        throw new Error('News not found');
      }
      throw error;
    }
  },
};
```

[Source: frontend/src/services/newsService.ts]

### Паттерн News List Page (референс)

```typescript
// frontend/src/app/news/page.tsx
import { newsService } from '@/services/newsService';

export const metadata: Metadata = {
  title: 'Новости | FREESPORT',
  description: 'Новости компании FREESPORT...',
};

interface NewsPageProps {
  searchParams: Promise<{ page?: string }>;
}

export default async function NewsPage({ searchParams }: NewsPageProps) {
  const params = await searchParams;
  const currentPage = Number(params.page) || 1;
  
  let newsData;
  try {
    newsData = await newsService.getNewsList({ page: currentPage });
  } catch (error) {
    newsData = { count: 0, next: null, previous: null, results: [] };
  }
  // ...render
}
```

[Source: frontend/src/app/news/page.tsx]

### Паттерн News Detail Page (референс)

```typescript
// frontend/src/app/news/[slug]/page.tsx
import { notFound } from 'next/navigation';

interface NewsDetailPageProps {
  params: Promise<{ slug: string }>;
}

export async function generateMetadata({ params }: NewsDetailPageProps): Promise<Metadata> {
  const { slug } = await params;
  try {
    const news = await newsService.getNewsBySlug(slug);
    return {
      title: `${news.title} | Новости FREESPORT`,
      description: news.excerpt,
    };
  } catch (error) {
    return { title: 'Новость не найдена | FREESPORT' };
  }
}

export default async function NewsDetailPage({ params }: NewsDetailPageProps) {
  const { slug } = await params;
  let news;
  try {
    news = await newsService.getNewsBySlug(slug);
  } catch (error) {
    notFound();
  }
  // ...render
}
```

[Source: frontend/src/app/news/[slug]/page.tsx]

### Header Navigation (референс)

```typescript
// frontend/src/components/layout/Header.tsx (строки 62-67)
const navigationItems = [
  { href: '/', label: 'Главная' },
  { href: '/catalog', label: 'Каталог' },
  { href: '/news', label: 'Новости' },
  { href: '/partners', label: 'Партнёрам' },
];
// Добавить: { href: '/blog', label: 'Блог' }
```

[Source: frontend/src/components/layout/Header.tsx#navigationItems]

### Типы для NewsItem (референс для BlogItem)

```typescript
// frontend/src/types/api.ts
export interface NewsItem {
  id: number;
  title: string;
  slug: string;
  excerpt: string;
  content?: string;
  image: string | null;
  published_at: string;
  created_at: string;
  updated_at: string;
  author?: string;
  category?: string;
}
```

[Source: frontend/src/types/api.ts#NewsItem]

### Дополнительные поля для BlogItem (отличия от NewsItem)

BlogItem имеет дополнительные поля по сравнению с NewsItem:

- `subtitle` — подзаголовок (опциональный)
- `meta_title` — SEO заголовок (опциональный)
- `meta_description` — SEO описание (опциональный)

Эти поля добавлены в модель BlogPost и сериализаторы (Story 21.1, 21.2).

### Расположение файлов

```text
frontend/src/
├── app/
│   └── blog/
│       ├── page.tsx              # Список статей (/blog)
│       ├── __tests__/
│       │   └── page.test.tsx     # Тесты для списка
│       └── [slug]/
│           ├── page.tsx          # Детальная страница (/blog/[slug])
│           └── __tests__/
│               └── page.test.tsx # Тесты для детальной страницы
├── services/
│   ├── blogService.ts            # Сервис для работы с Blog API
│   └── __tests__/
│       └── blogService.test.ts   # Тесты сервиса
├── types/
│   └── api.ts                    # Добавить BlogItem, BlogList
└── components/
    └── layout/
        └── Header.tsx            # Обновить navigationItems
```

[Source: docs/architecture/source-tree.md#frontend]

### API Endpoints

- **GET /api/v1/blog/** — список опубликованных статей с пагинацией
  - Query params: `page`, `page_size`
  - Response: `{ count, next, previous, results: BlogItem[] }`
- **GET /api/v1/blog/{slug}/** — детальная статья
  - Response: `BlogItem` (полный формат с content, meta_title, meta_description)

[Source: docs/stories/epic-21/21.2.backend-api-blogpost.story.md#Dev Notes]

### Компонент NewsCard (для переиспользования)

Компонент `NewsCard` из `frontend/src/components/home/NewsCard.tsx` уже используется для отображения карточек новостей. Он принимает props:

- `title: string`
- `excerpt: string`
- `image: string`
- `publishedAt: string`

Этот компонент можно переиспользовать для карточек блога.

[Source: frontend/src/app/news/page.tsx#NewsCard import]

### Responsive Grid

```typescript
// Сетка для карточек
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
```

[Source: frontend/src/app/news/page.tsx#grid]

---

## Testing

### Стратегия тестирования

- **Тип тестов:** Unit-тесты для сервиса, Integration-стиль тесты для страниц
- **Фреймворк:** Vitest + React Testing Library
- **Расположение:** co-located тесты в `__tests__/` директориях

[Source: docs/architecture/10-testing-strategy.md#Frontend Tests]

### Паттерн тестов сервиса

```typescript
// frontend/src/services/__tests__/blogService.test.ts
import { describe, it, expect, vi } from 'vitest';
import { blogService } from '../blogService';
import apiClient from '../api-client';

vi.mock('../api-client');

describe('blogService', () => {
  it('getBlogPosts returns paginated list', async () => {
    const mockData = { count: 1, results: [{ id: 1, title: 'Test' }] };
    vi.mocked(apiClient.get).mockResolvedValue({ data: mockData });
    
    const result = await blogService.getBlogPosts();
    
    expect(apiClient.get).toHaveBeenCalledWith('/blog', expect.any(Object));
    expect(result).toEqual(mockData);
  });
});
```

[Source: docs/architecture/10-testing-strategy.md#Frontend Component Test]

### Требования к покрытию

- Минимальное покрытие: 70%
- Критические модули: >= 85%

[Source: docs/architecture/10-testing-strategy.md#Требования к покрытию]

### Запуск тестов

```bash
# Все тесты
npm test

# Конкретный файл
npm test blogService.test.ts

# С покрытием
npm run test:coverage
```

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_

---

## Change Log

| Date       | Version | Description             | Author             |
|------------|---------|-------------------------|--------------------|
| 2025-12-27 | 1.0     | Initial story draft     | Bob (Scrum Master) |
| 2025-12-27 | 1.1     | Added sanitization notes, loading states, fixed nav | Sarah (PO) |
