# Story 3.1.2: loading-scripts

## Status

Ready for Development

## Story

**As a** системный администратор,
**I want** иметь простые команды для загрузки данных,
**so that** я могу управлять процессом импорта из 1С.

## Acceptance Criteria

1. Созданы management-команды `load_test_catalog` и `load_catalog` с параметрами управления.
2. Поддержана загрузка категорий с иерархией.
3. Созданы связи между товарами, категориями и брендами.
4. Реализована обработка дубликатов товаров.
5. Добавлен прогресс-бар для долгих операций.
6. Создан скрипт резервного копирования `backup_db`.

### Детальные задачи

- [x] **Создать команду-заглушку `load_test_catalog` (AC: 1)**
  - [x] Создать каркас команды с базовыми help-параметрами.
  - [ ] **Для генерации тестовых данных (AC: 1):**
    - [ ] Реализовать параметр `--count` для указания количества товаров.
    - [ ] Реализовать флаг `--with-brands` для создания тестовых брендов.
    - [ ] Реализовать флаг `--with-categories` для создания тестовых категорий.
    - [ ] Реализовать флаг `--clear-existing` для очистки старых тестовых данных.
    - [ ] Реализовать флаг `--dry-run` для тестового запуска без записи в БД.

- [ ] **Создать/дополнить команду `load_catalog` для импорта реальных данных из XML (AC: 1)**
  - [ ] Реализовать параметр `--file` для указания пути к файлу (`goods.xml`, `offers.xml` и т.д.).
  - [ ] Реализовать параметр `--chunk-size` для управления размером пакетов при импорте.
  - [ ] Реализовать флаг `--skip-validation` для ускорения импорта.
  - [ ] **Интегрировать сервисы `XMLDataParser` и `ProductDataProcessor`** для основной логики.
  - [ ] Реализовать создание `ImportSession` в начале и ее закрытие в конце импорта.

- [ ] **Реализовать загрузку категорий с иерархией (AC: 2) - для реальных данных**
  - [ ] Создать парсер для иерархии из `groups.xml`.
  - [ ] Обеспечить поддержку многоуровневой вложенности.
  - [x] ~~Создать/обновить модель `Category`~~ (Выполнено в рамках Task 3.1.1-A).
  - [ ] Реализовать валидацию циклических ссылок в категориях.

- [ ] **Настроить связи между сущностями (AC: 3) - для реальных данных**
  - [x] ~~Product ↔ Category/Brand связи (foreign key)~~ (Выполнено в рамках Task 3.1.1-A).
  - [ ] Реализовать логику автоматического создания `Brand` из файла свойств.
  - [ ] Реализовать логику обработки отсутствующих связанных объектов (например, логгирование).

- [ ] **Обработать дубликаты товаров (AC: 4) - для реальных данных**
  - [ ] Реализовать поиск дубликатов по `onec_id` (`get_or_create` или `update_or_create`).
  - [ ] Определить и реализовать стратегию `merge vs replace` для дубликатов.
    - **Решение Architect (22.09.2025):** Использовать стратегию `merge` (обновление по `onec_id`).
  - [ ] Обеспечить валидацию целостности после обработки дубликатов.

- [ ] **Добавить прогресс-бар (AC: 5)**
  - [ ] Использовать `tqdm` для визуального прогресса в обеих командах.
  - [ ] Логировать ключевые этапы обработки (начало/конец парсинга, записи в БД).
  - [ ] Показывать базовую статистику обработки (создано/обновлено/пропущено).

- [ ] **Создать backup скрипт (AC: 6)**
  - [ ] Создать команду `backup_db`.
    - **Решение Architect (22.09.2025):** Бэкапы сохраняются в `backend/backup_db/`. Директория добавлена в `.gitignore`.
  - [ ] Реализовать автоматический вызов бэкапа перед каждым полным импортом.
  - [ ] Настроить ротацию backup-файлов.
    - **Решение Architect (22.09.2025):** Хранить последние 3 копии.

## Definition of Done

- [ ] Команды работают без ошибок на тестовых данных
- [ ] Импорт 1000+ товаров завершается за <5 минут
- [ ] Сохраняется резервная копия перед каждым импортом
- [ ] Все edge cases обработаны корректно
- [ ] Создана документация по использованию команд

## Dev Notes

### Story Context

**Existing System Integration:**

- Интегрируется с: Story 3.1.1 (import structure)
- Технология: Django Management Commands + bulk operations
- Следует паттерну: FREESPORT data management
- Точки касания: Product, Category, Brand models

### Performance Requirements

```python
# Bulk operations для производительности
Product.objects.bulk_create(products_batch, batch_size=100)
Product.objects.bulk_update(products_batch, fields=['name', 'price'])

# Progress tracking
from tqdm import tqdm
for batch in tqdm(product_batches, desc="Loading products"):
    process_batch(batch)
```

### Command Usage Examples

```bash
# Генерация тестовых данных
python manage.py load_test_catalog --count=1000 --with-brands --with-categories --clear-existing

# Загрузка основного каталога товаров из реального файла
python manage.py load_catalog --file="backend/tests/legacy/Обмен с сайтом/goods/goods.xml"

# Загрузка торговых предложений (остатки, цены)
python manage.py load_catalog --file="backend/tests/legacy/Обмен с сайтом/offers/offers.xml" --chunk-size=500

# Тестовый запуск импорта без записи в БД
python manage.py load_catalog --file="backend/tests/legacy/Обмен с сайтом/goods/goods.xml" --dry-run
```

### Dependencies

- **Depends on:** Story 3.1.1 (import structure)
- **Blocks:** Story 3.1.3 (test catalog loading)
- **Related:** Database performance optimization

## Story Points

**5** (Medium complexity, mostly configuration)

## Priority

**High** - Необходимо для тестовой загрузки данных

## Labels

`epic-3` `data-management` `django-commands` `performance`
