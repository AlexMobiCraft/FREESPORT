# Story 3.1.2: loading-scripts

## Status
Ready for Development

## Story
**As a** системный администратор,
**I want** иметь простые команды для загрузки данных,
**so that** я могу управлять процессом импорта из 1С.

## Acceptance Criteria

1. Создана команда `python manage.py load_test_catalog --file=path/to/catalog.xml`
2. Добавлены параметры управления импортом
3. Поддержана загрузка категорий с иерархией
4. Созданы связи между товарами, категориями и брендами
5. Реализована обработка дубликатов товаров
6. Добавлен прогресс-бар для долгих операций
7. Создан скрипт резервного копирования

### Детальные задачи:

- [ ] Создать команду load_test_catalog (AC: 1)
  - [ ] Реализовать основную логику загрузки
  - [ ] Добавить валидацию пути к файлу
  - [ ] Создать подробный help и примеры использования
  - [ ] Настроить обработку различных форматов файлов

- [ ] Добавить параметры управления (AC: 2)
  - [ ] `--dry-run` - тестовый запуск без записи в БД
  - [ ] `--chunk-size` - размер пакета для bulk операций
  - [ ] `--skip-validation` - пропустить валидацию данных
  - [ ] `--force` - перезаписать существующие данные

- [ ] Реализовать загрузку категорий (AC: 3)
  - [ ] Создать парсер иерархии категорий
  - [ ] Поддержать многоуровневую вложенность
  - [ ] Создать/обновить Category модели
  - [ ] Валидировать циклические ссылки

- [ ] Настроить связи между сущностями (AC: 4)
  - [ ] Product ↔ Category связи (many-to-many)
  - [ ] Product ↔ Brand связи (foreign key)
  - [ ] Автоматическое создание Brand из данных
  - [ ] Обработка отсутствующих связанных объектов

- [ ] Обработать дубликаты товаров (AC: 5)
  - [ ] Поиск дубликатов по onec_id
  - [ ] Стратегия merge vs replace для дубликатов
  - [ ] Сохранение истории изменений
  - [ ] Валидация целостности после обработки дубликатов

- [ ] Добавить прогресс-бар (AC: 6)
  - [ ] Использовать tqdm для визуального прогресса
  - [ ] Показывать статистику обработки
  - [ ] Отображать оставшееся время
  - [ ] Логировать этапы обработки

- [ ] Создать backup скрипт (AC: 7)
  - [ ] Команда `backup_before_import`
  - [ ] Автоматический backup перед каждым импортом
  - [ ] Настроить ротацию backup файлов
  - [ ] Команда восстановления из backup

## Definition of Done
- [ ] Команды работают без ошибок на тестовых данных
- [ ] Импорт 1000+ товаров завершается за <5 минут
- [ ] Сохраняется резервная копия перед каждым импортом
- [ ] Все edge cases обработаны корректно
- [ ] Создана документация по использованию команд

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: Story 3.1.1 (import structure)
- Технология: Django Management Commands + bulk operations
- Следует паттерну: FREESPORT data management
- Точки касания: Product, Category, Brand models

### Performance Requirements
```python
# Bulk operations для производительности
Product.objects.bulk_create(products_batch, batch_size=100)
Product.objects.bulk_update(products_batch, fields=['name', 'price'])

# Progress tracking
from tqdm import tqdm
for batch in tqdm(product_batches, desc="Loading products"):
    process_batch(batch)
```

### Command Usage Examples
```bash
# Основная загрузка
python manage.py load_test_catalog --file=data/catalog.xml

# Тестовый запуск
python manage.py load_test_catalog --file=data/catalog.xml --dry-run

# Быстрая загрузка
python manage.py load_test_catalog --file=data/catalog.xml --skip-validation --chunk-size=500
```

### Dependencies
- **Depends on:** Story 3.1.1 (import structure)
- **Blocks:** Story 3.1.3 (test catalog loading)
- **Related:** Database performance optimization

## Story Points
**5** (Medium complexity, mostly configuration)

## Priority
**High** - Необходимо для тестовой загрузки данных

## Labels
`epic-3` `data-management` `django-commands` `performance`