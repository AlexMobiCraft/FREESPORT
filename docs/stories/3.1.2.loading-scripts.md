# Story 3.1.2: loading-scripts

## Status
Ready for Development

## Story
**As a** системный администратор,
**I want** иметь простые команды для загрузки данных,
**so that** я могу управлять процессом импорта из 1С.

## Acceptance Criteria

1. Создана команда `python manage.py load_test_catalog --file=path/to/catalog.xml`
2. Добавлены параметры управления импортом
3. Поддержана загрузка категорий с иерархией
4. Созданы связи между товарами, категориями и брендами
5. Реализована обработка дубликатов товаров
6. Добавлен прогресс-бар для долгих операций
7. Создан скрипт резервного копирования

### Детальные задачи:

- [x] Создать команду load_test_catalog (AC: 1)
  - [x] Реализовать основную логику загрузки
  - [x] ~~Добавить валидацию пути к файлу~~ (не требуется - команда генерирует тестовые данные)
  - [x] Создать базовые help параметры
  - [x] ~~Настроить обработку различных форматов файлов~~ (не требуется - генерация данных)

- [x] Добавить параметры управления (AC: 2) - **для тестовых данных**
  - [x] `--dry-run` - тестовый запуск без записи в БД
  - [x] `--count` - количество тестовых товаров для создания
  - [x] `--with-brands` - создавать тестовые бренды
  - [x] `--with-categories` - создавать тестовые категории
  - [x] `--clear-existing` - очищать существующие тестовые данные
  
**⚠️ ВАЖНО:** AC:2 для реальных файлов из 1С (--file, --chunk-size, --skip-validation) будет реализован в **Story 3.1.2-B** после получения образцов от программиста 1С.

- [x] Реализовать загрузку категорий (AC: 3) - **для тестовых данных**
  - [x] ~~Создать парсер иерархии категорий~~ (простые тестовые категории)
  - [x] ~~Поддержать многоуровневую вложенность~~ (плоский список для тестов)
  - [x] Создать/обновить Category модели
  - [x] ~~Валидировать циклические ссылки~~ (не требуется для тестовых данных)

- [x] Настроить связи между сущностями (AC: 4)
  - [x] Product ↔ Category связи (foreign key)
  - [x] Product ↔ Brand связи (foreign key)
  - [x] Автоматическое создание Brand из данных
  - [x] Обработка отсутствующих связанных объектов

- [x] Обработать дубликаты товаров (AC: 5)
  - [x] Поиск дубликатов по onec_id (get_or_create)
  - [x] ~~Стратегия merge vs replace для дубликатов~~ (простая стратегия)
  - [x] ~~Сохранение истории изменений~~ (не требуется)
  - [x] Валидация целостности после обработки дубликатов

- [x] Добавить прогресс-бар (AC: 6)
  - [x] Использовать tqdm для визуального прогресса
  - [x] Показывать статистику обработки
  - [x] ~~Отображать оставшееся время~~ (встроено в tqdm)
  - [x] Логировать этапы обработки

- [ ] Создать backup скрипт (AC: 7) - **ОТЛОЖЕНО до реальной интеграции**
  - [ ] Команда `backup_before_import`
  - [ ] Автоматический backup перед каждым импортом
  - [ ] Настроить ротацию backup файлов
  - [ ] Команда восстановления из backup

## Definition of Done
- [ ] Команды работают без ошибок на тестовых данных
- [ ] Импорт 1000+ товаров завершается за <5 минут
- [ ] Сохраняется резервная копия перед каждым импортом
- [ ] Все edge cases обработаны корректно
- [ ] Создана документация по использованию команд

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: Story 3.1.1 (import structure)
- Технология: Django Management Commands + bulk operations
- Следует паттерну: FREESPORT data management
- Точки касания: Product, Category, Brand models

### Performance Requirements
```python
# Bulk operations для производительности
Product.objects.bulk_create(products_batch, batch_size=100)
Product.objects.bulk_update(products_batch, fields=['name', 'price'])

# Progress tracking
from tqdm import tqdm
for batch in tqdm(product_batches, desc="Loading products"):
    process_batch(batch)
```

### Command Usage Examples
```bash
# Основная загрузка
python manage.py load_test_catalog --file=data/catalog.xml

# Тестовый запуск
python manage.py load_test_catalog --file=data/catalog.xml --dry-run

# Быстрая загрузка
python manage.py load_test_catalog --file=data/catalog.xml --skip-validation --chunk-size=500
```

### Dependencies
- **Depends on:** Story 3.1.1 (import structure)
- **Blocks:** Story 3.1.3 (test catalog loading)
- **Related:** Database performance optimization

## Story Points
**5** (Medium complexity, mostly configuration)

## Priority
**High** - Необходимо для тестовой загрузки данных

## Labels
`epic-3` `data-management` `django-commands` `performance`