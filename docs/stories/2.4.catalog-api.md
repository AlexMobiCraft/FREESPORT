# Story 2.4: catalog-api

## Status
Ready for Development

## Story
**As a** покупатель (B2B/B2C),
**I want** просматривать каталог товаров с фильтрацией и ролевыми ценами,
**so that** найти нужные товары по своей цене.

## Acceptance Criteria

1. GET `/products/` возвращает товары с pagination
2. GET `/categories/` отдает иерархическое дерево категорий
3. Фильтрация: category_id, brand, min_price, max_price, in_stock
4. Сортировка: name, price, created_at (ascending/descending)
5. Цены адаптируются к роли пользователя (retail/wholesale/trainer/federation)

- [ ] Реализовать Products API (AC: 1)
  - [ ] Создать ProductListSerializer с основными полями
  - [ ] Реализовать GET /products/ с DRF pagination
  - [ ] Настроить PageNumberPagination с лимитом 100
  - [ ] Добавить поля: name, sku, brand, price, stock_quantity
  - [ ] Оптимизировать QuerySet с select_related

- [ ] Создать Categories API (AC: 2)
  - [ ] Создать CategorySerializer с nested children
  - [ ] Реализовать GET /categories/ для дерева категорий
  - [ ] Реализовать GET /categories/{id}/ для деталей
  - [ ] Добавить breadcrumbs для навигации
  - [ ] Подсчитать products_count для каждой категории

- [ ] Настроить фильтрацию товаров (AC: 3)
  - [ ] Установить django-filter для Products ViewSet
  - [ ] Добавить фильтры: category_id, brand, min_price, max_price
  - [ ] Реализовать фильтр in_stock для наличия
  - [ ] Валидировать параметры фильтрации
  - [ ] Добавить фильтр по бренду через slug

- [ ] Реализовать сортировку (AC: 4)
  - [ ] Настроить OrderingFilter для Products
  - [ ] Добавить сортировку: name, -name, price, -price
  - [ ] Добавить сортировку: created_at, -created_at
  - [ ] Установить default ordering по -created_at
  - [ ] Валидировать ordering parameters

- [ ] Ролевое ценообразование (AC: 5)
  - [ ] Создать custom method в ProductSerializer для цен
  - [ ] Определить цену на основе user.role
  - [ ] Отображать RRP/MSRP для B2B пользователей
  - [ ] Скрывать оптовые цены от retail пользователей
  - [ ] Добавить поле current_price в response

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: Product, Category, Brand models
- Технология: DRF с custom serializers для ролевых цен
- Следует паттерну: Django QuerySet filtering и pagination
- Точки касания: Pricing logic, filtering system, category tree

### Technical Notes
- **Integration Approach:** Custom serializer method для ролевых цен и DjangoFilterBackend
- **Existing Pattern Reference:** Django-filter для query parameters
- **Key Constraints:** Performance для больших каталогов (>10k товаров)

### Role-based Pricing Logic
```python
def get_current_price(self, obj):
    user = self.context['request'].user
    if not user.is_authenticated:
        return obj.retail_price
    
    role_price_map = {
        'retail': obj.retail_price,
        'wholesale_level1': obj.opt1_price or obj.retail_price,
        'wholesale_level2': obj.opt2_price or obj.retail_price,
        'wholesale_level3': obj.opt3_price or obj.retail_price,
        'trainer': obj.trainer_price or obj.retail_price,
        'federation_rep': obj.federation_price or obj.retail_price,
    }
    return role_price_map.get(user.role, obj.retail_price)
```

### Category Tree Structure
```python
class CategorySerializer(serializers.ModelSerializer):
    children = serializers.SerializerMethodField()
    products_count = serializers.IntegerField(read_only=True)
    
    def get_children(self, obj):
        children = obj.children.filter(is_active=True)
        return CategorySerializer(children, many=True).data
```

### Testing
- Unit тесты для всех API endpoints
- Тестирование фильтрации и сортировки
- Проверка ролевого ценообразования
- Performance тесты для больших каталогов
- Валидация пагинации и query optimization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial brownfield story creation | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
_TBD - будет заполнено dev агентом_

### Completion Notes List
_TBD - будет заполнено dev агентом_

### File List
_TBD - будет заполнено dev агентом_

## QA Results
_TBD - будет заполнено QA агентом_