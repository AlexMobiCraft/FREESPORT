# Story 15.4: Страница подтверждения заказа

## Status

Ready for development

## Story

**As a** пользователь платформы FREESPORT,
**I want** видеть страницу подтверждения после успешного оформления заказа,
**so that** я могу убедиться, что заказ принят, и получить информацию о дальнейших шагах.

## Acceptance Criteria

1. ✅ Страница `/checkout/success/[orderId]` отображается
2. ✅ Детали заказа: номер, товары, адрес, способ доставки
3. ✅ Информационный блок: "Администратор свяжется с вами для уточнения оплаты и доставки"
4. ✅ Статус заказа: "Новый" (будет изменён администратором)
5. ✅ Кнопки: "Продолжить покупки", "Перейти в личный кабинет"
6. ✅ Email-уведомление клиенту отправляется автоматически (backend)
7. ✅ Unit-тесты для компонента

## Tasks / Subtasks

### Задача 1: Создание страницы success (AC: 1, 2, 3, 4, 5)

- [ ] Создать `src/app/checkout/success/[orderId]/page.tsx`
- [ ] Использовать SSR для загрузки деталей заказа:

  ```typescript
  export async function generateMetadata({ params }) {
    return { title: `Заказ ${params.orderId} успешно оформлен` }
  }

  export default async function SuccessPage({ params }) {
    const order = await ordersService.getOrderById(params.orderId)
    return <OrderSuccessView order={order} />
  }
  ```

- [ ] Компонент `OrderSuccessView` отображает:
  - Иконку успеха (зелёная галочка)
  - Номер заказа (крупным шрифтом)
  - Статус: "Новый" с объяснением
  - Список товаров
  - Адрес доставки
  - Способ доставки
  - Итоговая сумма
  - Информационный блок (InfoPanel)

### Задача 2: Информационный блок (AC: 3)

- [ ] Использовать `InfoPanel` из UI Kit:

  ```tsx
  <InfoPanel variant="info" className="mt-6">
    <h3 className="font-semibold">Что дальше?</h3>
    <p>Администратор свяжется с вами в течение 24 часов для уточнения:</p>
    <ul className="list-disc ml-5 mt-2">
      <li>Способа оплаты</li>
      <li>Точной стоимости доставки</li>
      <li>Времени доставки</li>
    </ul>
  </InfoPanel>
  ```

### Задача 3: Кнопки навигации (AC: 5)

- [ ] Кнопка "Продолжить покупки" → `/catalog`
- [ ] Кнопка "Личный кабинет" → `/profile/orders`
- [ ] Использовать `Button` из UI Kit и `Link` из Next.js

### Задача 4: Email-уведомление (AC: 6)

- [ ] **Backend автоматически отправляет email клиенту при создании заказа**
- [ ] Frontend НЕ отвечает за email
- [ ] Документация: "Email отправляется backend при создании заказа"

### Задача 5: Unit-тесты (AC: 7)

- [ ] Создать `src/app/checkout/success/__tests__/page.test.tsx`
- [ ] Тест-кейсы:
  - Страница отображает номер заказа
  - Статус "Новый" показывается
  - Список товаров отображается
  - Информационный блок показывается
  - Кнопки навигации работают

### Задача 6: Обработка edge cases

- [ ] Несуществующий orderId: показать 404
- [ ] Ошибка загрузки заказа: показать ошибку с retry кнопкой
- [ ] Пустой список товаров: показать предупреждение

## Dev Notes

### Компонент OrderSuccessView

```typescript
interface OrderSuccessViewProps {
  order: Order
}

export const OrderSuccessView: React.FC<OrderSuccessViewProps> = ({ order }) => {
  return (
    <div className="container mx-auto px-4 py-8 max-w-3xl">
      {/* Success Icon */}
      <div className="text-center mb-6">
        <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full">
          <svg className="w-10 h-10 text-green-600" /* ... */>✓</svg>
        </div>
        <h1 className="text-3xl font-bold mt-4">Заказ успешно оформлен!</h1>
        <p className="text-gray-600 mt-2">
          Номер заказа: <span className="font-semibold">{order.order_number}</span>
        </p>
      </div>

      {/* Order Details */}
      <div className="bg-white rounded-lg shadow p-6 mb-6">
        <div className="border-b pb-4 mb-4">
          <h2 className="text-xl font-semibold">Детали заказа</h2>
          <p className="text-sm text-gray-600">Статус: <span className="text-green-600">Новый</span></p>
        </div>

        {/* Items List */}
        <div className="mb-4">
          <h3 className="font-semibold mb-2">Товары:</h3>
          {order.items.map((item) => (
            <div key={item.product_id} className="flex justify-between py-2">
              <span>{item.product_name} × {item.quantity}</span>
              <span>{item.total} ₽</span>
            </div>
          ))}
        </div>

        {/* Delivery Address */}
        <div className="mb-4">
          <h3 className="font-semibold mb-2">Адрес доставки:</h3>
          <p>{order.delivery_address.city}, {order.delivery_address.street}, {order.delivery_address.house}</p>
        </div>

        {/* Delivery Method */}
        <div className="mb-4">
          <h3 className="font-semibold mb-2">Способ доставки:</h3>
          <p>{order.delivery_method.name}</p>
          <p className="text-sm text-gray-600">{order.delivery_method.description}</p>
          <p className="text-sm text-gray-500 mt-1">Стоимость: Уточняется администратором</p>
        </div>

        {/* Total */}
        <div className="border-t pt-4">
          <div className="flex justify-between text-lg font-bold">
            <span>Итого:</span>
            <span>{order.total_amount} ₽</span>
          </div>
        </div>
      </div>

      {/* Info Panel */}
      <InfoPanel variant="info" className="mb-6">
        <h3 className="font-semibold">Что дальше?</h3>
        <p>Администратор свяжется с вами в течение 24 часов для уточнения:</p>
        <ul className="list-disc ml-5 mt-2">
          <li>Способа оплаты</li>
          <li>Точной стоимости доставки</li>
          <li>Времени доставки</li>
        </ul>
      </InfoPanel>

      {/* Action Buttons */}
      <div className="flex gap-4 justify-center">
        <Link href="/catalog">
          <Button variant="secondary">Продолжить покупки</Button>
        </Link>
        <Link href="/profile/orders">
          <Button variant="primary">Личный кабинет</Button>
        </Link>
      </div>
    </div>
  )
}
```

[Source: Epic 15, architecture/coding-standards.md]

### Структура файлов

```
frontend/src/
├── app/
│   └── checkout/
│       └── success/
│           └── [orderId]/
│               ├── page.tsx              # [NEW] SSR страница
│               └── __tests__/
│                   └── page.test.tsx     # [NEW] Unit-тесты
└── components/
    └── checkout/
        └── OrderSuccessView.tsx          # [NEW] Компонент отображения
```

### Зависимости

- **Зависит от:** Story 15.2 (`ordersService.getOrderById()`)
- **Зависит от:** Epic 10 UI Kit (`Button`, `InfoPanel`)

### API Endpoint

**GET /api/v1/orders/{orderId}/** (реализован в backend OrderViewSet.retrieve)

Возвращает полные детали заказа включая items, delivery_address, delivery_method.

## Change Log

| Date       | Version | Description                     | Author         |
|------------|---------|--------------------------------|----------------|
| 2025-12-14 | 1.0.0   | Создание story для success page | Bob (SM Agent) |
| 2025-12-14 | 1.0.1   | Добавлены структура файлов и зависимости | Sarah (PO Agent) |

## Dev Agent Record

_(Заполняется разработчиком во время реализации)_

### Agent Model Used

_(Название и версия AI-модели)_

### Debug Log References

_(Ссылки на debug логи, если применимо)_

### Completion Notes

_(Заметки о завершении задач и проблемах)_

### File List

_(Список созданных/модифицированных файлов)_

## QA Results

_(Заполняется QA агентом после проверки)_
