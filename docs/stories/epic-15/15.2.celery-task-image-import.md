# Story 15.2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Celery –∑–∞–¥–∞—á–∏ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

> **Epic**: [Epic 15 - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å](../../epics/epic-15/epic-15.admin-image-update.md)
> **–°–æ–∑–¥–∞–Ω–æ**: 2025-11-26
> **–°—Ç–∞—Ç—É—Å**: üìã Approved
> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: Story 15.1 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞

---

## Status

**Current Status**: Draft

---

## Story

**As a** –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã,
**I want** —á—Ç–æ–±—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞ "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤" –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å Celery –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 1–°,
**so that** —è –º–æ–≥—É –º–∞—Å—Å–æ–≤–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —á–µ—Ä–µ–∑ ImportSession.

---

## Acceptance Criteria

1. –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
2. –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ `ImportSession.report_details`
3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç: `total_products`, `processed`, `copied`, `skipped`, `errors`
4. –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Å—Å–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `failed` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º `error_message`
5. –ó–∞–¥–∞—á–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `ProductDataProcessor.import_product_images()`
6. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è chunked processing (–ø–æ 100 —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é)
7. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `import_files/` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏
8. –ó–∞–¥–∞—á–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π `_execute_import_type()`

---

## Tasks / Subtasks

- [ ] **Task 1: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∏–ø–∞ "images" –≤ _execute_import_type()** (AC: 8)
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ç–∫—É `elif import_type == "images":` –≤ —Ñ—É–Ω–∫—Ü–∏—é `_execute_import_type()` ([tasks.py:96-136](../../../backend/apps/integrations/tasks.py#L96-L136))
  - [ ] –í—ã–∑–≤–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é `_run_image_import(task_id)` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - [ ] –í–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–∞—Ä—å `{"type": "images", "message": "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã"}`
  - [ ] –î–æ–±–∞–≤–∏—Ç—å "images" –≤ `import_order` —Å–ø–∏—Å–æ–∫ ([tasks.py:56](../../../backend/apps/integrations/tasks.py#L56))

- [ ] **Task 2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é _run_image_import()** (AC: 1, 5, 6, 7)
  - [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `_run_image_import(task_id: str) -> dict[str, str]`
  - [ ] –ü–æ–ª—É—á–∏—Ç—å `ONEC_DATA_DIR` –∏–∑ settings
  - [ ] –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: `base_dir / "goods" / "import_files"`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ `Path.exists()`
  - [ ] –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ—Ç - –ø–æ–¥–Ω—è—Ç—å `FileNotFoundError` —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
  - [ ] –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã: `Product.objects.filter(is_active=True)`
  - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å chunked processing —á–µ—Ä–µ–∑ `queryset.iterator(chunk_size=100)`
  - [ ] –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤—ã–∑–≤–∞—Ç—å `ProductDataProcessor.import_product_images()`
  - [ ] –ü–µ—Ä–µ–¥–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: `product`, `image_paths`, `base_dir`, `validate_images=False`
  - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 50 —Ç–æ–≤–∞—Ä–æ–≤

- [ ] **Task 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ImportSession –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞** (AC: 2, 3)
  - [ ] –ù–∞–π—Ç–∏ `ImportSession` –ø–æ `celery_task_id == task_id`
  - [ ] –û–±–Ω–æ–≤–ª—è—Ç—å `status = IN_PROGRESS` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  - [ ] –û–±–Ω–æ–≤–ª—è—Ç—å `report_details` —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π:
    ```python
    {
        "total_products": count,
        "processed": processed_count,
        "copied": total_copied,
        "skipped": total_skipped,
        "errors": total_errors,
        "last_updated": datetime.now().isoformat()
    }
    ```
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `session.save(update_fields=["status", "report_details"])` –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  - [ ] –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 50 —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î

- [ ] **Task 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏** (AC: 4)
  - [ ] –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:
    - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `status = COMPLETED`
    - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `finished_at = timezone.now()`
    - [ ] –ó–∞–ø–∏—Å–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ `report_details`
  - [ ] –ü—Ä–∏ –æ—à–∏–±–∫–µ (try/except –≤–æ–∫—Ä—É–≥ –≤—Å–µ–π –ª–æ–≥–∏–∫–∏):
    - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `status = FAILED`
    - [ ] –ó–∞–ø–∏—Å–∞—Ç—å traceback –≤ `error_message`
    - [ ] –ó–∞–ø–∏—Å–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ `report_details`
    - [ ] –ü–æ–¥–Ω—è—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è retry –º–µ—Ö–∞–Ω–∏–∑–º–∞ Celery
  - [ ] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ —á–µ—Ä–µ–∑ logger

- [ ] **Task 5: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** (AC: 6)
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `select_related()` –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
  - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `iterator(chunk_size=100)` –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
  - [ ] –û—Ç–∫–ª—é—á–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (`validate_images=False`) –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `--validate-images` –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
  - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å timeout –∑–∞–¥–∞—á–∏: 3600 —Å–µ–∫—É–Ω–¥ (1 —á–∞—Å) —á–µ—Ä–µ–∑ `@shared_task`

- [ ] **Task 6: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ç–æ–≤–∞—Ä–∞** (AC: 5)
  - [ ] –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç—å –∫ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞: `base_dir / first_two_chars(onec_id)`
  - [ ] –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (*.jpg, *.png, *.jpeg)
  - [ ] –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–µ—Ç –∏–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä (skipped++)
  - [ ] –ü–µ—Ä–µ–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π –≤ `import_product_images()`
  - [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å `copied`, `skipped`, `errors`

- [ ] **Task 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (AC: –≤—Å–µ)
  - [ ] **Unit-—Ç–µ—Å—Ç –¥–ª—è _run_image_import() (mock –æ–±—Ä–∞–±–æ—Ç–∫–∞)**:
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å `Product.objects.filter()` –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å `ProductDataProcessor.import_product_images()`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

  - [ ] **Integration —Ç–µ—Å—Ç (—Ä–µ–∞–ª—å–Ω–∞—è –ë–î + mock —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)**:
    - [ ] –°–æ–∑–¥–∞—Ç—å 5 —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ Factory
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `import_files/` —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
    - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `_run_image_import()`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `ImportSession` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

  - [ ] **Integration —Ç–µ—Å—Ç (–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files)**:
    - [ ] –£–¥–∞–ª–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `import_files/` (mock)
    - [ ] –í—ã–∑–≤–∞—Ç—å `_run_image_import()`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `FileNotFoundError` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º

  - [ ] **Integration —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ _execute_import_type()**:
    - [ ] –í—ã–∑–≤–∞—Ç—å `_execute_import_type("images", "test-task-id")`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `{"type": "images", "message": "..."}`

  - [ ] **Integration —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow (POST -> Celery -> ImportSession)**:
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=images`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ `ImportSession`
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Celery –∑–∞–¥–∞—á–∏
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Å—Å–∏–∏

- [ ] **Task 8: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é**
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ CLAUDE.md
  - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç `report_details` –¥–ª—è —Ç–∏–ø–∞ "images"
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –≤ Epic 15 –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ Story 15.2

---

## Dev Notes

### Relevant Source Tree

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```
backend/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks.py:96-136              # _execute_import_type() - –¥–æ–±–∞–≤–∏—Ç—å –≤–µ—Ç–∫—É "images"
‚îÇ   ‚îî‚îÄ‚îÄ products/
‚îÇ       ‚îî‚îÄ‚îÄ services/
‚îÇ           ‚îî‚îÄ‚îÄ processor.py:784-924     # import_product_images() - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
‚îî‚îÄ‚îÄ apps/integrations/tests/
    ‚îî‚îÄ‚îÄ test_tasks.py                    # –¢–µ—Å—Ç—ã Celery –∑–∞–¥–∞—á
```

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:**
- –§—É–Ω–∫—Ü–∏—è `_run_image_import()` –≤ `tasks.py`
- –¢–µ—Å—Ç—ã –≤ `test_tasks.py`

---

### Existing System Integration

**1. ProductDataProcessor.import_product_images()** ([processor.py:784-924](../../../backend/apps/products/services/processor.py#L784-L924)):

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞**:
```python
def import_product_images(
    self,
    product: Product,
    image_paths: list[str],
    base_dir: str,
    validate_images: bool = False,
) -> dict[str, int]:
    """
    Returns:
        dict —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º copied, skipped, errors
    """
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ `main_image`
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `gallery_images`
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∏–º–ø–æ—Ä—Ç–µ `main_image` –ù–ï –º–µ–Ω—è–µ—Ç—Å—è –µ—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –î—É–±–ª–∏–∫–∞—Ç—ã –≤ `gallery_images` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –∏–∑ 1–°

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:
```python
processor = ProductDataProcessor()
result = processor.import_product_images(
    product=product,
    image_paths=["00/001a16a4-b810-11ed-860f-fa163edba792_24062354.jpg"],
    base_dir="/app/data/import_1c/goods/import_files",
    validate_images=False  # –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
)
# result = {"copied": 1, "skipped": 0, "errors": 0}
```

---

**2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ 1–°**:

**–§–æ—Ä–º–∞—Ç**: `data/import_1c/goods/import_files/XX/onec_id_*.jpg`

**–ü—Ä–∏–º–µ—Ä**:
```
data/import_1c/goods/import_files/
‚îú‚îÄ‚îÄ 00/
‚îÇ   ‚îú‚îÄ‚îÄ 001a16a4-b810-11ed-860f-fa163edba792_24062354.jpg
‚îÇ   ‚îú‚îÄ‚îÄ 001a16a4-b810-11ed-860f-fa163edba792_24062355.jpg
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ 01/
‚îÇ   ‚îú‚îÄ‚îÄ 0123456-b810-11ed-860f-fa163edba792_image1.jpg
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ...
```

**–õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ç–æ–≤–∞—Ä–∞**:
```python
from pathlib import Path

def get_product_images(product: Product, base_dir: str) -> list[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 1–°.

    Args:
        product: Product instance —Å onec_id
        base_dir: –ü—É—Ç—å –∫ goods/import_files/

    Returns:
        –°–ø–∏—Å–æ–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ["00/001a16a4_image.jpg"])
    """
    # –ü–µ—Ä–≤—ã–µ 2 —Å–∏–º–≤–æ–ª–∞ onec_id –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    onec_id = product.onec_id
    subdir = onec_id[:2] if len(onec_id) >= 2 else "00"

    images_dir = Path(base_dir) / subdir

    if not images_dir.exists():
        return []

    # –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è —Å onec_id
    image_paths = []
    for ext in ["*.jpg", "*.jpeg", "*.png"]:
        for img_file in images_dir.glob(f"{onec_id}*{ext}"):
            # –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –æ—Ç base_dir
            relative_path = f"{subdir}/{img_file.name}"
            image_paths.append(relative_path)

    return image_paths
```

---

**3. –ü–∞—Ç—Ç–µ—Ä–Ω _execute_import_type()** ([tasks.py:96-136](../../../backend/apps/integrations/tasks.py#L96-L136)):

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥**:
```python
def _execute_import_type(import_type: str, task_id: str) -> dict[str, str]:
    """
    –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö.

    Returns:
        Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–º–ø–æ—Ä—Ç–∞
    """
    if import_type == "catalog":
        call_command("import_catalog_from_1c", "--file-type", "all")
        return {"type": "catalog", "message": "–ö–∞—Ç–∞–ª–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω"}

    elif import_type == "stocks":
        call_command("import_catalog_from_1c", "--file-type", "rests")
        return {"type": "stocks", "message": "–û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"}

    # ... –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã

    else:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∏–º–ø–æ—Ä—Ç–∞: {import_type}")
```

**–î–æ–±–∞–≤–∏—Ç—å –¥–ª—è "images"**:
```python
    elif import_type == "images":
        logger.info(f"[Task {task_id}] –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤")
        result = _run_image_import(task_id)
        return {"type": "images", "message": "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã"}
```

---

**4. –ü–∞—Ç—Ç–µ—Ä–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ImportSession**:

```python
from django.utils import timezone
from apps.products.models import ImportSession

def _run_image_import(task_id: str) -> dict[str, str]:
    """–ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ 1–°."""

    # –ù–∞–π—Ç–∏ —Å–µ—Å—Å–∏—é –ø–æ task_id
    try:
        session = ImportSession.objects.get(celery_task_id=task_id)
    except ImportSession.DoesNotExist:
        logger.warning(f"ImportSession –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è task_id: {task_id}")
        session = None

    # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ IN_PROGRESS
    if session:
        session.status = ImportSession.ImportStatus.IN_PROGRESS
        session.save(update_fields=["status"])

    try:
        # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∞
        total_products = Product.objects.filter(is_active=True).count()
        processed = 0
        total_copied = 0
        total_skipped = 0
        total_errors = 0

        # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ ...

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        if session and processed % 50 == 0:
            session.report_details = {
                "total_products": total_products,
                "processed": processed,
                "copied": total_copied,
                "skipped": total_skipped,
                "errors": total_errors,
                "last_updated": timezone.now().isoformat()
            }
            session.save(update_fields=["report_details"])

        # –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
        if session:
            session.status = ImportSession.ImportStatus.COMPLETED
            session.finished_at = timezone.now()
            session.report_details = {
                "total_products": total_products,
                "processed": processed,
                "copied": total_copied,
                "skipped": total_skipped,
                "errors": total_errors,
                "completed_at": timezone.now().isoformat()
            }
            session.save(update_fields=["status", "finished_at", "report_details"])

        return {"type": "images", "message": f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed} —Ç–æ–≤–∞—Ä–æ–≤"}

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {e}", exc_info=True)

        if session:
            session.status = ImportSession.ImportStatus.FAILED
            session.finished_at = timezone.now()
            session.error_message = str(e)
            session.save(update_fields=["status", "finished_at", "error_message"])

        raise
```

---

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

#### 1. Chunked Processing –¥–ª—è –±–æ–ª—å—à–∏—Ö QuerySet

**–ü–∞—Ç—Ç–µ—Ä–Ω**:
```python
from django.db.models import QuerySet

# –í–º–µ—Å—Ç–æ .all() - –∏—Å–ø–æ–ª—å–∑—É–µ–º iterator –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
products = Product.objects.filter(is_active=True).select_related('brand')

for product in products.iterator(chunk_size=100):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–∞
    process_product(product)

    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–∞–∂–¥—ã–µ 50 —Ç–æ–≤–∞—Ä–æ–≤
    if processed % 50 == 0:
        update_progress(session, processed)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- –≠–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏ (–Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ RAM)
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

#### 2. Celery Task Configuration

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω** ([tasks.py:18-23](../../../backend/apps/integrations/tasks.py#L18-L23)):
```python
@shared_task(
    name="apps.integrations.tasks.run_selective_import_task",
    bind=True,
    max_retries=3,
    default_retry_delay=60,
)
```

**–î–ª—è –∑–∞–¥–∞—á–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫—É—é –∂–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é**:
- `bind=True` - –¥–æ—Å—Ç—É–ø –∫ `self.request.id`
- `max_retries=3` - –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
- `default_retry_delay=60` - –ø–∞—É–∑–∞ 60 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –î–æ–±–∞–≤–∏—Ç—å `time_limit=3600` –¥–ª—è timeout 1 —á–∞—Å

---

#### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–ü–∞—Ç—Ç–µ—Ä–Ω**:
```python
import logging

logger = logging.getLogger(__name__)

def _run_image_import(task_id: str) -> dict[str, str]:
    logger.info(f"[Task {task_id}] –ù–∞—á–∞–ª–æ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")

    # –ö–∞–∂–¥—ã–µ N –∏—Ç–µ—Ä–∞—Ü–∏–π
    if processed % 50 == 0:
        logger.info(
            f"[Task {task_id}] –ü—Ä–æ–≥—Ä–µ—Å—Å: {processed}/{total_products} —Ç–æ–≤–∞—Ä–æ–≤. "
            f"Copied: {total_copied}, Skipped: {total_skipped}, Errors: {total_errors}"
        )

    logger.info(f"[Task {task_id}] –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {processed} —Ç–æ–≤–∞—Ä–æ–≤")
```

---

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Story 15.2 –ù–ï –≤–∫–ª—é—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ views.py**:
   - Story 15.1 —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥ –≤ `session_type_map`
   - Celery –∑–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑–æ–≤–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ "images"

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –î–ª—è 1000 —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–æ 3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ~5-10 –º–∏–Ω—É—Ç
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `validate_images=False` –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
   - Chunked processing –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç OOM
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∫–∞–∂–¥—ã–µ 50 —Ç–æ–≤–∞—Ä–æ–≤ —Å–Ω–∏–∂–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ edge cases**:
   - –¢–æ–≤–∞—Ä –±–µ–∑ `onec_id` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (skipped++)
   - –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (skipped++)
   - –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (skipped++)
   - –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ - –∑–∞–ø–∏—Å–∞—Ç—å –≤ errors++ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å

4. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏**:
   - –ù–æ–≤–∞—è –≤–µ—Ç–∫–∞ –≤ `_execute_import_type()` –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ catalog, stocks, prices, customers
   - –§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ `{"type": "images", "message": "..."}` —Å–æ–≤–º–µ—Å—Ç–∏–º —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º

5. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**:
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `validate_images=False` –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ —Ñ–æ—Ä–º–µ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

### Testing

#### Testing Standards

**Framework**: Pytest 7.4.3 + pytest-django 4.7.0

**Coverage target**: >= 80% –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞

**Test file location**: `backend/apps/integrations/tests/test_tasks.py`

**Mocking**:
- `@patch("apps.integrations.tasks.Product.objects")` –¥–ª—è –º–æ–∫–∞ QuerySet
- `@patch("apps.integrations.tasks.ProductDataProcessor")` –¥–ª—è –º–æ–∫–∞ processor
- `@patch("pathlib.Path.exists")` –¥–ª—è –º–æ–∫–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- `@patch("pathlib.Path.glob")` –¥–ª—è –º–æ–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤

---

#### Testing Patterns

**1. Unit-—Ç–µ—Å—Ç –¥–ª—è _run_image_import() —Å –º–æ–∫–∞–º–∏**

```python
import pytest
from unittest.mock import Mock, patch, MagicMock
from apps.integrations.tasks import _run_image_import
from apps.products.models import ImportSession


@pytest.mark.unit
class TestRunImageImport:
    """Unit-—Ç–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ _run_image_import."""

    @patch("apps.integrations.tasks.Product.objects")
    @patch("apps.integrations.tasks.ProductDataProcessor")
    @patch("pathlib.Path.exists", return_value=True)
    def test_run_image_import_success(
        self, mock_path_exists, mock_processor_class, mock_product_qs
    ):
        """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –º–æ–∫–∞–º–∏."""
        # Setup mocks
        mock_products = [
            Mock(id=1, onec_id="001a16a4-b810-11ed-860f"),
            Mock(id=2, onec_id="0023456-b810-11ed-860f"),
        ]
        mock_product_qs.filter.return_value.iterator.return_value = iter(mock_products)
        mock_product_qs.filter.return_value.count.return_value = 2

        mock_processor = mock_processor_class.return_value
        mock_processor.import_product_images.return_value = {
            "copied": 2,
            "skipped": 1,
            "errors": 0,
        }

        # Execute
        result = _run_image_import("test-task-id")

        # Assert
        assert result["type"] == "images"
        assert "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 2 —Ç–æ–≤–∞—Ä–æ–≤" in result["message"]
        assert mock_processor.import_product_images.call_count == 2

    @patch("pathlib.Path.exists", return_value=False)
    def test_run_image_import_missing_directory(self, mock_path_exists):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files."""
        with pytest.raises(FileNotFoundError) as exc_info:
            _run_image_import("test-task-id")

        assert "import_files" in str(exc_info.value)
```

---

**2. Integration —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –∏ mock —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã**

```python
import pytest
from django.test import TestCase
from unittest.mock import patch, MagicMock
from apps.products.models import Product, ImportSession
from apps.products.tests.factories import ProductFactory
from apps.integrations.tasks import _run_image_import


@pytest.mark.integration
class TestImageImportIntegration(TestCase):
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."""

    @patch("apps.integrations.tasks.ProductDataProcessor")
    @patch("pathlib.Path.exists", return_value=True)
    @patch("pathlib.Path.glob")
    def test_image_import_updates_session(
        self, mock_glob, mock_path_exists, mock_processor_class
    ):
        """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ImportSession –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ."""
        # –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
        products = [ProductFactory.create() for _ in range(5)]

        # –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é
        session = ImportSession.objects.create(
            import_type=ImportSession.ImportType.IMAGES,
            status=ImportSession.ImportStatus.STARTED,
            celery_task_id="test-task-id",
        )

        # Mock glob –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        mock_glob.return_value = [
            MagicMock(name="image1.jpg"),
            MagicMock(name="image2.jpg"),
        ]

        # Mock processor
        mock_processor = mock_processor_class.return_value
        mock_processor.import_product_images.return_value = {
            "copied": 2,
            "skipped": 0,
            "errors": 0,
        }

        # Execute
        result = _run_image_import("test-task-id")

        # Reload session
        session.refresh_from_db()

        # Assert
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.finished_at is not None
        assert session.report_details["total_products"] == 5
        assert session.report_details["processed"] == 5
        assert session.report_details["copied"] == 10  # 5 —Ç–æ–≤–∞—Ä–æ–≤ * 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```

---

**3. Integration —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ _execute_import_type()**

```python
@pytest.mark.integration
class TestExecuteImportTypeImages(TestCase):
    """–¢–µ—Å—Ç—ã _execute_import_type –¥–ª—è —Ç–∏–ø–∞ images."""

    @patch("apps.integrations.tasks._run_image_import")
    def test_execute_import_type_images(self, mock_run_import):
        """–¢–µ—Å—Ç –≤—ã–∑–æ–≤–∞ _run_image_import —á–µ—Ä–µ–∑ _execute_import_type."""
        from apps.integrations.tasks import _execute_import_type

        mock_run_import.return_value = {
            "type": "images",
            "message": "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 10 —Ç–æ–≤–∞—Ä–æ–≤",
        }

        result = _execute_import_type("images", "test-task-id")

        assert result["type"] == "images"
        assert "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã" in result["message"]
        mock_run_import.assert_called_once_with("test-task-id")
```

---

**4. Integration —Ç–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫**

```python
@pytest.mark.integration
class TestImageImportErrorHandling(TestCase):
    """–¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."""

    @patch("apps.integrations.tasks.ProductDataProcessor")
    @patch("pathlib.Path.exists", return_value=True)
    def test_image_import_handles_processor_error(
        self, mock_path_exists, mock_processor_class
    ):
        """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –≤ ProductDataProcessor."""
        # –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∏ —Å–µ—Å—Å–∏—é
        ProductFactory.create_batch(3)
        session = ImportSession.objects.create(
            import_type=ImportSession.ImportType.IMAGES,
            status=ImportSession.ImportStatus.STARTED,
            celery_task_id="test-task-id",
        )

        # Mock processor –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        mock_processor = mock_processor_class.return_value
        mock_processor.import_product_images.side_effect = Exception(
            "Test error"
        )

        # Execute
        with pytest.raises(Exception):
            _run_image_import("test-task-id")

        # Reload session
        session.refresh_from_db()

        # Assert
        assert session.status == ImportSession.ImportStatus.FAILED
        assert "Test error" in session.error_message
        assert session.finished_at is not None

    @patch("pathlib.Path.exists", return_value=False)
    def test_image_import_fails_missing_directory(self, mock_path_exists):
        """–¢–µ—Å—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏."""
        session = ImportSession.objects.create(
            import_type=ImportSession.ImportType.IMAGES,
            status=ImportSession.ImportStatus.STARTED,
            celery_task_id="test-task-id",
        )

        with pytest.raises(FileNotFoundError):
            _run_image_import("test-task-id")

        session.refresh_from_db()

        assert session.status == ImportSession.ImportStatus.FAILED
```

---

**5. Performance —Ç–µ—Å—Ç –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤**

```python
@pytest.mark.slow
@pytest.mark.integration
class TestImageImportPerformance(TestCase):
    """–¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."""

    @patch("apps.integrations.tasks.ProductDataProcessor")
    @patch("pathlib.Path.exists", return_value=True)
    @patch("pathlib.Path.glob")
    def test_import_1000_products_uses_chunking(
        self, mock_glob, mock_path_exists, mock_processor_class
    ):
        """–¢–µ—Å—Ç chunked processing –¥–ª—è 1000 —Ç–æ–≤–∞—Ä–æ–≤."""
        # –°–æ–∑–¥–∞—Ç—å 1000 —Ç–æ–≤–∞—Ä–æ–≤
        ProductFactory.create_batch(1000)

        session = ImportSession.objects.create(
            import_type=ImportSession.ImportType.IMAGES,
            status=ImportSession.ImportStatus.STARTED,
            celery_task_id="test-task-id",
        )

        mock_glob.return_value = [MagicMock(name="image.jpg")]
        mock_processor = mock_processor_class.return_value
        mock_processor.import_product_images.return_value = {
            "copied": 1,
            "skipped": 0,
            "errors": 0,
        }

        # Execute
        result = _run_image_import("test-task-id")

        session.refresh_from_db()

        # Assert
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.report_details["total_products"] == 1000
        assert session.report_details["processed"] == 1000
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ iterator –±—ã–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (–Ω–µ .all())
```

---

## Change Log

| Date       | Version | Description                                    | Author |
|------------|---------|------------------------------------------------|--------|
| 2025-11-26 | 1.0     | –°–æ–∑–¥–∞–Ω–∏–µ Story 15.2 –Ω–∞ –æ—Å–Ω–æ–≤–µ Epic 15          | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

### Debug Log References

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

### Completion Notes List

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

### File List

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

---

## QA Results

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ QA agent –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è_

---

## References

- [Epic 15: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å](../../epics/epic-15/epic-15.admin-image-update.md)
- [Story 15.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞ "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"](15.1.admin-images-import-type.md)
- [ProductDataProcessor.import_product_images()](../../../backend/apps/products/services/processor.py#L784-L924)
- [_execute_import_type()](../../../backend/apps/integrations/tasks.py#L96-L136)
- [run_selective_import_task](../../../backend/apps/integrations/tasks.py#L18-L93)
