# Story 9.3: 1C Import Admin Action & Monitoring

**Epic:** Epic 9 - Advanced Admin Panel  
**Story ID:** 9.3  
**Status:** Draft

---

## Story

**As a** Platform Administrator,  
**I want** to trigger 1C catalog import and monitor its progress through Django Admin,  
**so that** I can update the catalog on-demand and troubleshoot import issues without accessing the server terminal.

---

## Acceptance Criteria

1. Custom admin action –≤ `ImportSessionAdmin`: `trigger_catalog_import` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
2. Action –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ call_command
3. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ
4. Distributed Lock (Redis) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç concurrent imports
5. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ç–æ—Ä–æ–π –∏–º–ø–æ—Ä—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
6. ImportSessionAdmin —É–ª—É—á—à–µ–Ω:
   - –î–æ–±–∞–≤–ª–µ–Ω custom display `duration` (finished_at - started_at)
   - –î–æ–±–∞–≤–ª–µ–Ω custom display `progress_display` —Å progress bar (–µ—Å–ª–∏ status=running)
   - –î–æ–±–∞–≤–ª–µ–Ω colored status display (green/yellow/red)
7. –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É —Å —Ü–≤–µ—Ç–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
8. Auto-refresh –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ —Å–ø–∏—Å–∫–æ–º ImportSession (JavaScript, –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫)
9. Integration —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã:
   - –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ admin action
   - Concurrent import prevention (Redis lock)

---

## Tasks / Subtasks

- [ ] **Task 1: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Distributed Lock –º–µ—Ö–∞–Ω–∏–∑–º** (AC: 4, 5)
  - [ ] –î–æ–±–∞–≤–∏—Ç—å import –¥–ª—è django_redis: `from django_redis import get_redis_connection`
  - [ ] –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è Redis lock
  - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å lock_key = "import_catalog_lock"
  - [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å timeout = 3600 (1 —á–∞—Å TTL)
  - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å non-blocking acquire —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π

- [ ] **Task 2: –°–æ–∑–¥–∞—Ç—å trigger_catalog_import admin action** (AC: 1, 2, 3, 4, 5)
  - [ ] –û—Ç–∫—Ä—ã—Ç—å `backend/apps/products/admin.py`
  - [ ] –ù–∞–π—Ç–∏ ImportSessionAdmin –∫–ª–∞—Å—Å
  - [ ] –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ trigger_catalog_import —Å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º @admin.action
  - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫—É –∑–∞—Ö–≤–∞—Ç–∞ distributed lock
  - [ ] –ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å warning message
  - [ ] –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –∑–∞–ø—É—Å–∫–∞—Ç—å call_command('import_catalog_from_1c', '--data-dir', settings.ONEC_DATA_DIR)
  - [ ] –û–±–µ—Ä–Ω—É—Ç—å –≤ try/except –¥–ª—è error handling
  - [ ] –í finally –±–ª–æ–∫–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å lock
  - [ ] –î–æ–±–∞–≤–∏—Ç—å action –≤ ImportSessionAdmin.actions

- [ ] **Task 3: –£–ª—É—á—à–∏—Ç—å ImportSessionAdmin display methods** (AC: 6, 7)
  - [ ] –°–æ–∑–¥–∞—Ç—å duration display method (timedelta calculation)
  - [ ] –°–æ–∑–¥–∞—Ç—å progress_display —Å HTML progress bar (–µ—Å–ª–∏ status=running)
  - [ ] –°–æ–∑–¥–∞—Ç—å colored_status display —Å format_html:
    - üü¢ Green: success/completed
    - üü° Yellow: running/in_progress
    - üî¥ Red: failed/error
  - [ ] –û–±–Ω–æ–≤–∏—Ç—å list_display –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö displays
  - [ ] –°–æ–∑–¥–∞—Ç—å custom list_filter –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ —Å –∏–∫–æ–Ω–∫–∞–º–∏

- [ ] **Task 4: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Auto-refresh JavaScript** (AC: 8)
  - [ ] –°–æ–∑–¥–∞—Ç—å template: `backend/templates/admin/products/importsession/change_list.html`
  - [ ] Extend –±–∞–∑–æ–≤—ã–π admin change_list template
  - [ ] –î–æ–±–∞–≤–∏—Ç—å JavaScript –¥–ª—è auto-reload –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è running imports
  - [ ] Auto-refresh —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å running –∏–º–ø–æ—Ä—Ç

- [ ] **Task 5: Integration —Ç–µ—Å—Ç—ã** (AC: 9)
  - [ ] –°–æ–∑–¥–∞—Ç—å `backend/tests/integration/test_admin_import.py`
  - [ ] –¢–µ—Å—Ç: –∑–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ admin action (mock call_command)
  - [ ] –¢–µ—Å—Ç: concurrent import prevention (Redis lock)
  - [ ] –¢–µ—Å—Ç: lock –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  - [ ] –¢–µ—Å—Ç: lock –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ exception

- [ ] **Task 6: Unit —Ç–µ—Å—Ç—ã** (AC: –≤—Å–µ)
  - [ ] –°–æ–∑–¥–∞—Ç—å `backend/apps/products/tests/test_admin_actions.py`
  - [ ] –¢–µ—Å—Ç: trigger_catalog_import success path
  - [ ] –¢–µ—Å—Ç: trigger_catalog_import error handling
  - [ ] –¢–µ—Å—Ç: duration calculation
  - [ ] –¢–µ—Å—Ç: progress_display rendering
  - [ ] –¢–µ—Å—Ç: colored_status rendering

- [ ] **Task 7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞** (AC: –≤—Å–µ)
  - [ ] –û–±–Ω–æ–≤–∏—Ç—å docs/architecture/04-component-structure.md
  - [ ] –î–æ–±–∞–≤–∏—Ç—å screenshots –¥–ª—è admin-guide.md
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis –¥–æ—Å—Ç—É–ø–µ–Ω –≤ production
  - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—É

---

## Dev Notes

### Architecture Context

**Source Tree:**

- ImportSession –º–æ–¥–µ–ª—å: `backend/apps/products/models.py`
- Admin —Ñ–∞–π–ª (–æ–±–Ω–æ–≤–∏—Ç—å): `backend/apps/products/admin.py`
- Management command (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç): `backend/apps/products/management/commands/import_catalog_from_1c.py`
- Template (—Å–æ–∑–¥–∞—Ç—å): `backend/templates/admin/products/importsession/change_list.html`
- Tests: `backend/tests/integration/test_admin_import.py` (—Å–æ–∑–¥–∞—Ç—å)

**ImportSession Model Fields (reference):**

- session_id, status (choices: pending, running, completed, failed)
- started_at, finished_at
- total_items, processed_items, failed_items
- error_message (JSON –∏–ª–∏ Text)

**Dependencies:**

- Redis (–¥–ª—è distributed lock)
- Management command: `import_catalog_from_1c` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- django-redis package (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ requirements.txt)

### Distributed Lock Implementation

**Critical –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç data corruption:**

```python
# backend/apps/products/admin.py
from django_redis import get_redis_connection
from django.core.management import call_command
from django.conf import settings
from django.contrib import admin
from django.utils.html import format_html

@admin.register(ImportSession)
class ImportSessionAdmin(admin.ModelAdmin):
    list_display = ['session_id', 'colored_status', 'started_at', 'duration', 'progress_display']
    list_filter = ['status', 'started_at']
    readonly_fields = ['session_id', 'started_at', 'finished_at', 'total_items', 'processed_items']
    actions = ['trigger_catalog_import']
    
    @admin.action(description='üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–∑ 1–°')
    def trigger_catalog_import(self, request, queryset):
        """–ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç concurrent runs"""
        redis_conn = get_redis_connection("default")
        lock_key = "import_catalog_lock"
        lock = redis_conn.lock(lock_key, timeout=3600)  # 1 —á–∞—Å TTL
        
        # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        if not lock.acquire(blocking=False):
            self.message_user(
                request,
                "‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω! –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.",
                level='WARNING'
            )
            return
        
        try:
            data_dir = settings.ONEC_DATA_DIR
            call_command('import_catalog_from_1c', '--data-dir', data_dir)
            self.message_user(request, "‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
        except Exception as e:
            self.message_user(
                request,
                f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}",
                level='ERROR'
            )
        finally:
            lock.release()  # –í—Å–µ–≥–¥–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º lock
    
    @admin.display(description='Status')
    def colored_status(self, obj):
        colors = {
            'completed': 'green',
            'running': 'orange',
            'failed': 'red',
            'pending': 'gray'
        }
        icons = {
            'completed': '‚úÖ',
            'running': '‚è≥',
            'failed': '‚ùå',
            'pending': '‚è∏Ô∏è'
        }
        color = colors.get(obj.status, 'black')
        icon = icons.get(obj.status, '‚ùì')
        return format_html(
            '<span style="color: {};">{} {}</span>',
            color, icon, obj.get_status_display()
        )
    
    @admin.display(description='Duration')
    def duration(self, obj):
        if obj.finished_at and obj.started_at:
            delta = obj.finished_at - obj.started_at
            minutes = delta.total_seconds() / 60
            return f"{minutes:.1f} min"
        elif obj.started_at:
            return "In progress..."
        return "-"
    
    @admin.display(description='Progress')
    def progress_display(self, obj):
        if obj.status == 'running' and obj.total_items > 0:
            progress = (obj.processed_items / obj.total_items) * 100
            return format_html(
                '<progress value="{}" max="100" style="width: 100px;"></progress> {:.0f}%',
                progress, progress
            )
        return "-"
```

### Auto-Refresh Template

**–§–∞–π–ª:** `backend/templates/admin/products/importsession/change_list.html`

```django
{% extends "admin/change_list.html" %}

{% block extrahead %}
{{ block.super }}
<script>
(function() {
    // Auto-refresh –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –µ—Å—Ç—å running –∏–º–ø–æ—Ä—Ç
    function checkRunningImports() {
        const statusCells = document.querySelectorAll('td.field-colored_status');
        for (let cell of statusCells) {
            if (cell.textContent.includes('‚è≥') || cell.textContent.includes('running')) {
                // –ï—Å—Ç—å running –∏–º–ø–æ—Ä—Ç - –≤–∫–ª—é—á–∞–µ–º auto-refresh
                setTimeout(function() {
                    location.reload();
                }, 10000); // 10 —Å–µ–∫—É–Ω–¥
                return;
            }
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', checkRunningImports);
})();
</script>
{% endblock %}
```

### Settings Configuration

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ settings.py:**

```python
# backend/freesport/settings/base.py
ONEC_DATA_DIR = BASE_DIR.parent / 'data' / 'import_1c'

# Redis configuration (–¥–ª—è distributed lock)
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/0',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

### Why Synchronous Execution?

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏–∑ Epic 9:**

- –û–¥–∏–Ω –∞–¥–º–∏–Ω, —Ä–µ–¥–∫–∏–µ –∑–∞–ø—É—Å–∫–∏ (1-2/–¥–µ–Ω—å)
- –ü—Ä–∏–µ–º–ª–µ–º–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (2-5 –º–∏–Ω)
- –°—Ä–∞–∑—É –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (success/error)
- Post-MVP: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å Celery –¥–ª—è async, –µ—Å–ª–∏ –∏–º–ø–æ—Ä—Ç —Å—Ç–∞–Ω–µ—Ç >10 –º–∏–Ω—É—Ç

### Testing

**Test Location:**

- Integration: `backend/tests/integration/test_admin_import.py`
- Unit: `backend/apps/products/tests/test_admin_actions.py`

**Testing Standards:**

- Framework: pytest-django
- Coverage target: >80%
- Mock call_command –¥–ª—è unit —Ç–µ—Å—Ç–æ–≤
- Real Redis –¥–ª—è integration —Ç–µ—Å—Ç–æ–≤

**Integration Test Example:**

```python
# backend/tests/integration/test_admin_import.py
import pytest
from django.contrib.admin.sites import AdminSite
from django.contrib.auth import get_user_model
from django.test import RequestFactory
from django_redis import get_redis_connection
from apps.products.admin import ImportSessionAdmin
from apps.products.models import ImportSession

User = get_user_model()

@pytest.mark.django_db
class TestImportAdminAction:
    
    def setup_method(self):
        self.factory = RequestFactory()
        self.site = AdminSite()
        self.admin = ImportSessionAdmin(ImportSession, self.site)
        self.user = User.objects.create_superuser('admin@test.com', 'pass')
        
        # –û—á–∏—Å—Ç–∏—Ç—å Redis lock –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–æ–º
        redis_conn = get_redis_connection("default")
        redis_conn.delete("import_catalog_lock")
    
    def test_trigger_import_success(self, mocker):
        # Mock call_command
        mock_call = mocker.patch('apps.products.admin.call_command')
        
        request = self.factory.post('/admin/products/importsession/')
        request.user = self.user
        
        queryset = ImportSession.objects.none()
        self.admin.trigger_catalog_import(request, queryset)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ call_command –±—ã–ª –≤—ã–∑–≤–∞–Ω
        mock_call.assert_called_once()
    
    def test_concurrent_import_prevention(self):
        # –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º lock –≤—Ä—É—á–Ω—É—é
        redis_conn = get_redis_connection("default")
        lock = redis_conn.lock("import_catalog_lock", timeout=10)
        lock.acquire()
        
        try:
            request = self.factory.post('/admin/products/importsession/')
            request.user = self.user
            request._messages = []  # Mock messages framework
            
            queryset = ImportSession.objects.none()
            self.admin.trigger_catalog_import(request, queryset)
            
            # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å warning —Å–æ–æ–±—â–µ–Ω–∏–µ
            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ call_command –ù–ï –±—ã–ª –≤—ã–∑–≤–∞–Ω
        finally:
            lock.release()
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation from Epic 9 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

### Debug Log References

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

### Completion Notes List

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

### File List

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º)

---

## QA Results

(–ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è QA Agent)
