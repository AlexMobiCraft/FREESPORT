# Story 9.4: Admin Dashboard Widget with Key Metrics

**Epic:** Epic 9 - Advanced Admin Panel  
**Story ID:** 9.4  
**Status:** Draft

---

## Story

**As a** Platform Administrator,  
**I want** to see key platform metrics on the Django Admin home page,  
**so that** I can quickly assess platform health and identify issues without navigating through multiple sections.

---

## Acceptance Criteria

1. Custom template `admin/index.html` создан (extends original)
2. Виджет отображает метрики:
   - **Пользователи:** активные сегодня, новые за неделю, на верификации B2B
   - **Заказы:** сегодня, за неделю, со статусами (pending/processing/shipped)
   - **Импорт 1С:** статус последнего импорта, время, ошибки (если есть)
   - **Проблемы:** незавершенные импорты, неразрешенные конфликты синхронизации
3. Каждая метрика является ссылкой на соответствующий раздел админки
4. Адаптивная верстка работает на мобильных устройствах
5. Кэширование метрик реализовано (Redis, TTL 5 минут)
6. Performance requirements выполнены:
   - Load test: 10 concurrent admin users → dashboard <500ms
   - Cache hit rate >90% после 5 минут работы
   - Query count <20 для dashboard rendering
   - Memory usage <100MB для dashboard cache
7. Мониторинг производительности настроен:
   - Django Debug Toolbar для development окружения
   - Production-ready logging для метрик dashboard (response time, cache hits, errors)
   - Middleware для отслеживания dashboard performance в production
8. Performance regression tests добавлены
9. **Документация `docs/admin-guide.md` создана:**
   - Раздел 1: Вход в админ-панель
   - Раздел 2: Управление пользователями
   - Раздел 3: Управление заказами
   - Раздел 4: Запуск импорта 1С
   - Раздел 5: Интерпретация дашборда
   - Раздел 6: Troubleshooting
   - Screenshots для ключевых операций
   - FAQ секция (минимум 10 вопросов)

---

## Tasks / Subtasks

- [ ] **Task 1: Создать функции расчета метрик** (AC: 2, 5)
  - [ ] Создать файл `backend/apps/common/admin_dashboard.py`
  - [ ] Функция get_user_metrics():
    - active_today (login за последние 24ч)
    - new_this_week (created_at за последние 7 дней)
    - pending_verification (is_verified_b2b=False, role='wholesale')
  - [ ] Функция get_order_metrics():
    - orders_today, orders_week
    - status_breakdown (pending/processing/shipped counts)
  - [ ] Функция get_import_metrics():
    - last_import (последняя ImportSession)
    - last_import_status, last_import_time
    - active_imports (status='running')
  - [ ] Функция get_problem_metrics():
    - incomplete_imports (failed ImportSessions за 24ч)
    - sync_conflicts (модель SyncConflict будет реализована в Story 3.2.2)
  - [ ] Обернуть каждую функцию в cache decorator (@cache_page или manual caching)

- [ ] **Task 2: Реализовать кэширование метрик** (AC: 5, 6)
  - [ ] Использовать Django cache framework
  - [ ] Создать cache_key = 'admin_dashboard_metrics'
  - [ ] TTL = 300 секунд (5 минут)
  - [ ] Cache invalidation при создании User/Order/ImportSession (signals)
  - [ ] Fallback если Redis недоступен

- [ ] **Task 3: Создать custom admin template** (AC: 1, 3, 4)
  - [ ] Создать `backend/templates/admin/index.html`
  - [ ] Extend базовый admin/index.html
  - [ ] Добавить custom context processor или override AdminSite.index
  - [ ] Создать HTML виджет с метриками
  - [ ] Использовать Bootstrap (уже в Django Admin)
  - [ ] Добавить CSS для адаптивной верстки
  - [ ] Каждая метрика - ссылка через {% url 'admin:app_model_changelist' %}

- [ ] **Task 4: Customize AdminSite для injection метрик** (AC: 2)
  - [ ] Обновить `backend/apps/common/admin.py`
  - [ ] Override AdminSite.index() или создать custom context processor
  - [ ] Вызвать функции из admin_dashboard.py
  - [ ] Передать метрики в template context

- [ ] **Task 5: Performance optimization** (AC: 6)
  - [ ] Использовать select_related/prefetch_related в metric functions
  - [ ] Minimize database queries (<20)
  - [ ] Использовать aggregate/annotate вместо Python loops
  - [ ] Проверить query count через Django Debug Toolbar

- [ ] **Task 6: Performance & Load Testing** (AC: 6, 8)
  - [ ] Установить locust или artillery для load testing
  - [ ] Создать load test script: 10 concurrent admin users
  - [ ] Измерить response time (target: <500ms)
  - [ ] Измерить cache hit rate через Redis monitoring
  - [ ] Измерить memory usage
  - [ ] Добавить performance regression test в CI/CD

- [ ] **Task 7: Unit тесты** (AC: 2, 5)
  - [ ] Создать `backend/apps/common/tests/test_admin_dashboard.py`
  - [ ] Тест: get_user_metrics() возвращает корректные данные
  - [ ] Тест: get_order_metrics() возвращает корректные данные
  - [ ] Тест: get_import_metrics() возвращает корректные данные
  - [ ] Тест: кэширование работает (cache hit)
  - [ ] Тест: cache invalidation срабатывает

- [ ] **Task 8: Integration тесты** (AC: все)
  - [ ] Создать `backend/tests/integration/test_admin_dashboard.py`
  - [ ] Тест: dashboard отображается на /admin/
  - [ ] Тест: метрики рассчитываются корректно
  - [ ] Тест: ссылки работают
  - [ ] Тест: адаптивная верстка (headless browser test)

- [ ] **Task 9: Создать admin-guide.md документацию** (AC: 9)
  - [ ] Создать `docs/admin-guide.md`
  - [x] Раздел 1: Вход в админ-панель (как получить доступ, какие Django permissions нужны для просмотра разделов)
  - [ ] Раздел 2: Управление пользователями (с примерами и screenshots)
  - [ ] Раздел 3: Управление заказами
  - [ ] Раздел 4: Запуск импорта 1С (пошаговая инструкция)
  - [ ] Раздел 5: Интерпретация дашборда (что означают метрики)
  - [ ] Раздел 6: Troubleshooting (10+ FAQ)
  - [ ] Добавить screenshots для каждой операции
  - [ ] Review и proofread

- [ ] **Task 10: Документация для разработчиков** (AC: все)
  - [ ] Обновить docs/architecture/04-component-structure.md
  - [ ] Добавить раздел Django Admin с диаграммой
  - [ ] Документировать security considerations

- [ ] **Task 11: Настроить production monitoring** (AC: 7)
  - [ ] Создать custom middleware `DashboardPerformanceMiddleware`
  - [ ] Логировать response time для /admin/ requests
  - [ ] Логировать cache hit/miss для dashboard metrics
  - [ ] Логировать errors при расчете метрик
  - [ ] Настроить Django logging в settings (отдельный logger для dashboard)
  - [ ] Добавить structured logging (JSON format для production)
  - [ ] Интеграция с Django Debug Toolbar для development

---

## Dev Notes

### Architecture Context

**Source Tree:**

- Dashboard metrics: `backend/apps/common/admin_dashboard.py` (создать)
- AdminSite customization: `backend/apps/common/admin.py` (обновить)
- Performance middleware: `backend/apps/common/middleware.py` (создать)
- Template: `backend/templates/admin/index.html` (создать)
- Signals: `backend/apps/common/signals.py` (создать)
- Tests: `backend/apps/common/tests/test_admin_dashboard.py` (создать)
- Documentation: `docs/admin-guide.md` (создать)

**Dependencies:**

- Django Admin (встроено)
- Redis (для кэширования)
- Bootstrap (уже в Django Admin)
- Django Debug Toolbar (для development)
- Django logging framework (для production monitoring)

**Prerequisites from Stories 9.1-9.3:**

- **Story 9.1:** User admin interface (для screenshots в admin-guide.md)
- **Story 9.2:** Order admin interface (для screenshots в admin-guide.md)
- **Story 9.3:** Import management interface (для screenshots в admin-guide.md)

**Примечание:** Screenshots для `docs/admin-guide.md` могут быть созданы только после завершения Stories 9.1-9.3

### Dashboard Metrics Implementation

**Файл:** `backend/apps/common/admin_dashboard.py`

```python
from django.core.cache import cache
from django.utils import timezone
from datetime import timedelta
from django.contrib.auth import get_user_model
from apps.orders.models import Order
from apps.products.models import ImportSession

User = get_user_model()

def get_dashboard_metrics():
    """
    Возвращает все метрики для dashboard.
    Кэшируется на 5 минут.
    """
    cache_key = 'admin_dashboard_metrics'
    metrics = cache.get(cache_key)
    
    if metrics is None:
        metrics = {
            'users': get_user_metrics(),
            'orders': get_order_metrics(),
            'imports': get_import_metrics(),
            'problems': get_problem_metrics(),
        }
        cache.set(cache_key, metrics, 300)  # 5 минут TTL
    
    return metrics

def get_user_metrics():
    """Метрики пользователей"""
    now = timezone.now()
    today = now.date()
    week_ago = now - timedelta(days=7)
    
    return {
        'active_today': User.objects.filter(
            last_login__date=today
        ).count(),
        'new_this_week': User.objects.filter(
            created_at__gte=week_ago
        ).count(),
        'pending_verification': User.objects.filter(
            role='wholesale',
            is_verified_b2b=False
        ).count(),
    }

def get_order_metrics():
    """Метрики заказов"""
    now = timezone.now()
    today = now.date()
    week_ago = now - timedelta(days=7)
    
    return {
        'today': Order.objects.filter(created_at__date=today).count(),
        'week': Order.objects.filter(created_at__gte=week_ago).count(),
        'pending': Order.objects.filter(status='pending').count(),
        'processing': Order.objects.filter(status='processing').count(),
        'shipped': Order.objects.filter(status='shipped').count(),
    }

def get_import_metrics():
    """Метрики импорта 1С"""
    last_import = ImportSession.objects.order_by('-started_at').first()
    
    metrics = {
        'last_import': last_import,
        'active_imports': ImportSession.objects.filter(
            status='running'
        ).count(),
    }
    
    if last_import:
        metrics.update({
            'last_status': last_import.status,
            'last_time': last_import.started_at,
            'last_error': last_import.error_message if last_import.status == 'failed' else None,
        })
    
    return metrics

def get_problem_metrics():
    """Проблемные метрики"""
    now = timezone.now()
    day_ago = now - timedelta(hours=24)
    
    metrics = {
        'incomplete_imports': ImportSession.objects.filter(
            status='failed',
            started_at__gte=day_ago
        ).count(),
    }
    
    # SyncConflict будет реализован в Story 3.2.2
    # После реализации добавить:
    # try:
    #     from apps.common.models import SyncConflict
    #     metrics['sync_conflicts'] = SyncConflict.objects.filter(
    #         is_resolved=False
    #     ).count()
    # except ImportError:
    #     pass
    
    return metrics
```

### AdminSite Customization

**Файл:** `backend/apps/common/admin.py`

```python
from django.contrib import admin
from django.contrib.admin import AdminSite
from .admin_dashboard import get_dashboard_metrics

class CustomAdminSite(AdminSite):
    site_header = 'FREESPORT Admin Panel'
    site_title = 'FREESPORT Admin'
    index_title = 'Platform Dashboard'
    
    def index(self, request, extra_context=None):
        """Override index для добавления метрик"""
        extra_context = extra_context or {}
        extra_context['dashboard_metrics'] = get_dashboard_metrics()
        return super().index(request, extra_context)

# Заменить default admin site
admin.site = CustomAdminSite()
admin.autodiscover()
```

### Custom Template

**Файл:** `backend/templates/admin/index.html`

```django
{% extends "admin/index.html" %}
{% load static %}

{% block content %}
<div class="dashboard-metrics" style="margin-bottom: 30px;">
    <h2>📊 Platform Metrics</h2>
    
    <div class="row">
        <!-- Users Widget -->
        <div class="col-md-3">
            <div class="metric-card">
                <h3>👥 Users</h3>
                <ul>
                    <li><strong>Active Today:</strong> {{ dashboard_metrics.users.active_today }}</li>
                    <li><strong>New This Week:</strong> {{ dashboard_metrics.users.new_this_week }}</li>
                    <li><strong>Pending B2B:</strong> 
                        <a href="{% url 'admin:users_user_changelist' %}?is_verified_b2b__exact=0&role__exact=wholesale">
                            {{ dashboard_metrics.users.pending_verification }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Orders Widget -->
        <div class="col-md-3">
            <div class="metric-card">
                <h3>📦 Orders</h3>
                <ul>
                    <li><strong>Today:</strong> {{ dashboard_metrics.orders.today }}</li>
                    <li><strong>This Week:</strong> {{ dashboard_metrics.orders.week }}</li>
                    <li><strong>Pending:</strong> 
                        <a href="{% url 'admin:orders_order_changelist' %}?status__exact=pending">
                            {{ dashboard_metrics.orders.pending }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Import Widget -->
        <div class="col-md-3">
            <div class="metric-card">
                <h3>🔄 1C Import</h3>
                {% if dashboard_metrics.imports.last_import %}
                    <ul>
                        <li><strong>Last Status:</strong> 
                            <span class="status-{{ dashboard_metrics.imports.last_status }}">
                                {{ dashboard_metrics.imports.last_status }}
                            </span>
                        </li>
                        <li><strong>Last Run:</strong> {{ dashboard_metrics.imports.last_time|timesince }} ago</li>
                        <li><strong>Active Imports:</strong> {{ dashboard_metrics.imports.active_imports }}</li>
                    </ul>
                {% else %}
                    <p>No imports yet</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Problems Widget -->
        <div class="col-md-3">
            <div class="metric-card alert-warning">
                <h3>⚠️ Problems</h3>
                <ul>
                    <li><strong>Failed Imports (24h):</strong> 
                        <a href="{% url 'admin:products_importsession_changelist' %}?status__exact=failed">
                            {{ dashboard_metrics.problems.incomplete_imports }}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

{{ block.super }}

<style>
.metric-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.metric-card h3 {
    margin-top: 0;
    font-size: 16px;
}
.metric-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
.metric-card li {
    padding: 5px 0;
}
.status-completed { color: green; }
.status-failed { color: red; }
.status-running { color: orange; }
.alert-warning {
    border-left: 4px solid #ff9800;
}

/* Адаптивная верстка */
@media (max-width: 768px) {
    .row { flex-direction: column; }
    .col-md-3 { width: 100%; }
}
</style>
{% endblock %}
```

### Cache Invalidation (Signals)

**Создать:** `backend/apps/common/signals.py`

```python
from django.db.models.signals import post_save
from django.dispatch import receiver
from django.core.cache import cache
from django.contrib.auth import get_user_model
from apps.orders.models import Order
from apps.products.models import ImportSession

User = get_user_model()

@receiver(post_save, sender=User)
@receiver(post_save, sender=Order)
@receiver(post_save, sender=ImportSession)
def invalidate_dashboard_cache(sender, instance, **kwargs):
    """Invalidate dashboard cache при создании/изменении"""
    cache.delete('admin_dashboard_metrics')
```

**Подключить в apps.py:**

```python
# backend/apps/common/apps.py
from django.apps import AppConfig

class CommonConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.common'
    
    def ready(self):
        import apps.common.signals
```

### Performance Testing

**Load Test Script (locust):**

```python
# backend/tests/performance/locustfile.py
from locust import HttpUser, task, between

class AdminUser(HttpUser):
    wait_time = between(1, 3)
    
    def on_start(self):
        # Login as admin
        self.client.post('/admin/login/', {
            'username': 'admin@test.com',
            'password': 'testpass',
        })
    
    @task
    def view_dashboard(self):
        self.client.get('/admin/')
```

**Запуск:**

```bash
cd backend
locust -f tests/performance/locustfile.py --users 10 --spawn-rate 2 --host http://localhost:8000
```

### Production Monitoring

**Middleware для отслеживания производительности dashboard:**

**Файл:** `backend/apps/common/middleware.py`

```python
import time
import logging
from django.core.cache import cache
from django.utils.deprecation import MiddlewareMixin

logger = logging.getLogger('dashboard.performance')

class DashboardPerformanceMiddleware(MiddlewareMixin):
    """
    Middleware для мониторинга производительности admin dashboard в production.
    Логирует response time, cache hits/misses, errors.
    """
    
    def process_request(self, request):
        # Отслеживаем только admin dashboard
        if request.path == '/admin/' and request.user.is_authenticated:
            request._dashboard_start_time = time.time()
    
    def process_response(self, request, response):
        # Логируем только для admin dashboard
        if hasattr(request, '_dashboard_start_time'):
            duration = time.time() - request._dashboard_start_time
            
            # Проверяем cache hit/miss
            cache_status = 'hit' if cache.get('admin_dashboard_metrics') else 'miss'
            
            # Structured logging для production
            logger.info(
                'Dashboard request',
                extra={
                    'user': request.user.email,
                    'response_time_ms': round(duration * 1000, 2),
                    'cache_status': cache_status,
                    'status_code': response.status_code,
                    'path': request.path,
                }
            )
            
            # Warning если response time превышает 500ms
            if duration > 0.5:
                logger.warning(
                    f'Slow dashboard response: {duration*1000:.2f}ms',
                    extra={
                        'user': request.user.email,
                        'response_time_ms': round(duration * 1000, 2),
                    }
                )
        
        return response
    
    def process_exception(self, request, exception):
        # Логируем ошибки при рендеринге dashboard
        if hasattr(request, '_dashboard_start_time'):
            logger.error(
                f'Dashboard error: {exception}',
                extra={
                    'user': request.user.email if request.user.is_authenticated else 'anonymous',
                    'exception_type': type(exception).__name__,
                    'path': request.path,
                },
                exc_info=True
            )
```

**Настройка logging в settings:**

**Файл:** `backend/freesport/settings/base.py` (или production.py)

```python
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'json': {
            '()': 'pythonjsonlogger.jsonlogger.JsonFormatter',
            'format': '%(asctime)s %(name)s %(levelname)s %(message)s',
        },
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'dashboard_file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/dashboard_performance.log',
            'maxBytes': 10485760,  # 10MB
            'backupCount': 5,
            'formatter': 'json' if not DEBUG else 'verbose',
        },
        'console': {
            'level': 'INFO',
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'dashboard.performance': {
            'handlers': ['dashboard_file', 'console'],
            'level': 'INFO',
            'propagate': False,
        },
        'dashboard.metrics': {
            'handlers': ['dashboard_file', 'console'],
            'level': 'WARNING',
            'propagate': False,
        },
    },
}
```

**Обновление admin_dashboard.py для логирования:**

```python
import logging

logger = logging.getLogger('dashboard.metrics')

def get_dashboard_metrics():
    """
    Возвращает все метрики для dashboard.
    Кэшируется на 5 минут.
    """
    cache_key = 'admin_dashboard_metrics'
    metrics = cache.get(cache_key)
    
    if metrics is None:
        try:
            metrics = {
                'users': get_user_metrics(),
                'orders': get_order_metrics(),
                'imports': get_import_metrics(),
                'problems': get_problem_metrics(),
            }
            cache.set(cache_key, metrics, 300)  # 5 минут TTL
            logger.info('Dashboard metrics calculated and cached')
        except Exception as e:
            logger.error(f'Error calculating dashboard metrics: {e}', exc_info=True)
            # Возвращаем пустые метрики вместо ошибки
            metrics = {
                'users': {},
                'orders': {},
                'imports': {},
                'problems': {},
            }
    
    return metrics
```

**Подключение middleware в settings:**

```python
# backend/freesport/settings/base.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'apps.common.middleware.DashboardPerformanceMiddleware',  # Добавить
]
```

**Requirements для production logging:**

```txt
# requirements/production.txt
python-json-logger==2.0.7  # Для structured JSON logging
```

### Testing

**Test Location:** `backend/tests/unit/test_admin_dashboard.py`

**Testing Standards:**
- Framework: pytest-django
- Coverage target: >80%
- Mock external dependencies
- Test cache behavior

**Test Cases:**

```python
# backend/apps/common/tests/test_admin_dashboard.py
import pytest
from django.core.cache import cache
from apps.common.admin_dashboard import get_user_metrics, get_dashboard_metrics

@pytest.mark.django_db
class TestDashboardMetrics:
    
    def setup_method(self):
        cache.clear()
    
    def test_get_user_metrics(self):
        metrics = get_user_metrics()
        assert 'active_today' in metrics
        assert 'new_this_week' in metrics
        assert 'pending_verification' in metrics
    
    def test_dashboard_caching(self):
        # First call - should hit database
        metrics1 = get_dashboard_metrics()
        
        # Second call - should hit cache
        metrics2 = get_dashboard_metrics()
        
        assert metrics1 == metrics2
        assert cache.get('admin_dashboard_metrics') is not None
    
    def test_cache_invalidation(self, django_user_model):
        # Get metrics - populate cache
        get_dashboard_metrics()
        
        # Create user - should invalidate cache
        django_user_model.objects.create_user('test@test.com', 'pass')
        
        assert cache.get('admin_dashboard_metrics') is None
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation from Epic 9 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

(Заполняется разработчиком)

### Debug Log References

(Заполняется разработчиком)

### Completion Notes List

(Заполняется разработчиком)

### File List

(Заполняется разработчиком)

---

## QA Results

(Заполняется QA Agent)
