# Story 9.2: Order Management Admin Configuration

**Epic:** Epic 9 - Advanced Admin Panel  
**Story ID:** 9.2  
**Status:** Draft

---

## Story

**As a** Platform Administrator,  
**I want** to view and manage orders with 1C integration status through Django Admin,  
**so that** I can monitor order fulfillment, sync status, and troubleshoot integration issues without developer help.

---

## Acceptance Criteria

1. Order модель зарегистрирована в `backend/apps/orders/admin.py`
2. OrderItem настроен как inline в Order admin
3. Кастомный OrderAdmin с fieldsets:
   - Основная информация (order_number, user, status, created_at)
   - Суммы (subtotal, tax, shipping, discount, total)
   - Доставка и оплата (shipping_address, payment_method, payment_status)
   - Интеграция 1С (onec_id, exported_to_1c, sync timestamps)
4. Фильтры реализованы: status, payment_status, exported_to_1c, created_at
5. Поиск работает: order_number, user__email, onec_id
6. Custom display methods реализованы:
   - `customer_email` - email покупателя
   - `items_count` - количество позиций
   - `sync_status_display` - статус синхронизации с иконкой
7. Readonly fields настроены: order_number, onec_id, exported_to_1c, sync timestamps, totals
8. OrderItemInline отображает: product_name, quantity, unit_price, total_price
9. Производительность проверена: n+1 queries отсутствуют (через select_related/prefetch_related)

---

## Tasks / Subtasks

- [ ] **Task 1: Создать OrderAdmin класс** (AC: 1, 3)
  - [ ] Открыть существующий файл `backend/apps/orders/admin.py`
  - [ ] Импортировать необходимые зависимости (admin, Order, OrderItem models)
  - [ ] Создать класс OrderAdmin с декоратором `@admin.register(Order)`
  - [ ] Настроить fieldsets для всех секций (Основная, Суммы, Доставка, 1С)
  - [ ] Настроить readonly_fields для integration данных и totals

- [ ] **Task 2: Создать OrderItemInline** (AC: 2, 8)
  - [ ] Создать класс OrderItemInline(admin.TabularInline)
  - [ ] Настроить model = OrderItem
  - [ ] Настроить fields: product_name, quantity, unit_price, total_price
  - [ ] Настроить readonly_fields для price calculations
  - [ ] Добавить inline в OrderAdmin.inlines

- [ ] **Task 3: Настроить list_display и оптимизацию** (AC: 4, 5, 9)
  - [ ] Настроить list_display: order_number, customer_email, status, items_count, sync_status_display, created_at
  - [ ] Добавить list_select_related = ['user'] для оптимизации
  - [ ] Добавить prefetch_related = ['items'] для inline оптимизации
  - [ ] Настроить list_filter: status, payment_status, exported_to_1c, created_at
  - [ ] Настроить search_fields: order_number, user__email, onec_id

- [ ] **Task 4: Создать custom display methods** (AC: 6)
  - [ ] Создать customer_email display method
  - [ ] Создать items_count display method (через annotate или prefetch)
  - [ ] Создать sync_status_display с цветными иконками:
    - ✅ Зеленый: exported_to_1c = True
    - ⏳ Оранжевый: exported_to_1c = False
    - ❌ Красный: есть ошибки синхронизации
  - [ ] Использовать format_html для безопасного HTML рендеринга

- [ ] **Task 5: JSONField rendering для shipping_address** (AC: 3)
  - [ ] Проверить формат shipping_address (JSON?)
  - [ ] Создать custom display для formatted shipping address
  - [ ] Альтернатива: использовать django-jsoneditor widget (опционально)

- [ ] **Task 6: Тестирование** (AC: все)
  - [ ] Написать unit тесты для custom displays
  - [ ] Написать unit тесты для OrderItemInline
  - [ ] Протестировать с реальными заказами (минимум 10 заказов)
  - [ ] Проверить производительность: измерить количество queries
  - [ ] Убедиться что n+1 queries отсутствуют (Django Debug Toolbar)

- [ ] **Task 7: Документация** (AC: все)
  - [ ] Обновить docs/architecture/04-component-structure.md
  - [ ] Добавить комментарии к коду
  - [ ] Создать screenshots для admin-guide.md

---

## Dev Notes

### Architecture Context

**Source Tree:**
- Order модель: `backend/apps/orders/models.py`
- OrderItem модель: `backend/apps/orders/models.py`
- Admin файл (обновить): `backend/apps/orders/admin.py` (сейчас пустой)
- Tests: `backend/apps/orders/tests/test_admin.py` (создать)

**Order Model Fields (reference):**
- Identification: order_number, user (FK)
- Status: status, payment_status
- Amounts: subtotal, tax, shipping, discount, total
- Delivery: shipping_address (JSON?), delivery_method
- Payment: payment_method, payment_status
- 1C Integration: onec_id, exported_to_1c, synced_at
- Timestamps: created_at, updated_at

**OrderItem Model Fields:**
- product (FK), product_name (денормализация?)
- quantity, unit_price, total_price

**Dependencies:**
- Django Admin (встроено)
- Order и OrderItem модели (существуют)

### Admin Coding Standards

**Conventions (из Epic 9):**

1. Используйте `@admin.register()` декоратор
2. Readonly fields для integration данных (onec_id, timestamps)
3. `select_related()`/`prefetch_related()` для оптимизации N+1 queries
4. Custom display methods вместо lambda
5. TabularInline для OrderItem (компактное отображение)
6. JSONField rendering для structured data

**Example Pattern:**

```python
from django.contrib import admin
from django.utils.html import format_html
from .models import Order, OrderItem

class OrderItemInline(admin.TabularInline):
    model = OrderItem
    extra = 0
    fields = ['product', 'quantity', 'unit_price', 'total_price']
    readonly_fields = ['total_price']

@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = ['order_number', 'customer_email', 'status', 'items_count', 'sync_status_display', 'created_at']
    list_select_related = ['user']
    list_filter = ['status', 'payment_status', 'exported_to_1c', 'created_at']
    search_fields = ['order_number', 'user__email', 'onec_id']
    readonly_fields = ['order_number', 'onec_id', 'exported_to_1c', 'synced_at', 'total']
    inlines = [OrderItemInline]
    
    fieldsets = (
        ('Основная информация', {
            'fields': ('order_number', 'user', 'status', 'created_at')
        }),
        ('Суммы', {
            'fields': ('subtotal', 'tax', 'shipping', 'discount', 'total')
        }),
        ('Доставка и оплата', {
            'fields': ('shipping_address', 'payment_method', 'payment_status')
        }),
        ('Интеграция 1С', {
            'fields': ('onec_id', 'exported_to_1c', 'synced_at'),
            'classes': ('collapse',)
        }),
    )
    
    def get_queryset(self, request):
        # Оптимизация N+1
        qs = super().get_queryset(request)
        return qs.select_related('user').prefetch_related('items')
    
    @admin.display(description='Customer Email')
    def customer_email(self, obj):
        return obj.user.email if obj.user else '-'
    
    @admin.display(description='Items')
    def items_count(self, obj):
        # Используем prefetch для оптимизации
        return obj.items.count()
    
    @admin.display(description='1C Sync Status')
    def sync_status_display(self, obj):
        if obj.exported_to_1c:
            return format_html('<span style="color: green;">✅ Exported</span>')
        return format_html('<span style="color: orange;">⏳ Pending</span>')
```

### N+1 Query Optimization

**Критично для производительности:**

- `select_related('user')` - для ForeignKey к User
- `prefetch_related('items')` - для reverse FK к OrderItem
- Использовать `get_queryset()` override для применения оптимизаций
- Измерять количество queries через Django Debug Toolbar или django-silk

**Target Performance:**

- List view: максимум 3-5 queries (независимо от количества заказов)
- Detail view: максимум 5-7 queries

### Testing

**Test Location:** `backend/tests/unit/test_orders_admin.py`

**Testing Standards:**

- Framework: pytest-django
- Coverage target: >80%
- Use Django TestCase для admin tests

**Test Cases:**

```python
# backend/apps/orders/tests/test_admin.py
from django.test import TestCase
from django.contrib.admin.sites import AdminSite
from apps.orders.admin import OrderAdmin
from apps.orders.models import Order, OrderItem

class OrderAdminTest(TestCase):
    def setUp(self):
        self.site = AdminSite()
        self.admin = OrderAdmin(Order, self.site)
        
    def test_list_display_fields(self):
        # Тест list_display конфигурации
        pass
    
    def test_customer_email_display(self):
        # Тест custom display method
        pass
    
    def test_sync_status_display(self):
        # Тест статуса синхронизации
        pass
    
    def test_n_plus_one_queries(self):
        # Тест отсутствия N+1 queries
        # Создать 10 заказов, измерить количество queries
        pass
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | Initial story creation from Epic 9 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

(Заполняется разработчиком)

### Debug Log References

(Заполняется разработчиком)

### Completion Notes List

(Заполняется разработчиком)

### File List

(Заполняется разработчиком)

---

## QA Results

(Заполняется QA Agent)
