# Story 9.5: –í—ã–±–æ—Ä–æ—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ 1–° —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

**Epic:** Epic 9 - Advanced Admin Panel  
**Story ID:** 9.5  
**Status:** Ready for Implementation  
**Priority:** –¢–µ–∫—É—â–∏–π —Å–ø—Ä–∏–Ω—Ç

---

## Story

**As a** Platform Administrator,  
**I want** –≥–∏–±–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ 1–° (–∫–∞—Ç–∞–ª–æ–≥, –æ—Å—Ç–∞—Ç–∫–∏, —Ü–µ–Ω—ã, –∫–ª–∏–µ–Ω—Ç—ã) —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π,  
**so that** —è –º–æ–≥—É –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞.

---

## Business Context

**–ü—Ä–æ–±–ª–µ–º–∞:**  
–¢–µ–∫—É—â–∏–π action "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–∑ 1–°" –≤—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ (goods + offers + prices + rests), —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç 2-5 –º–∏–Ω—É—Ç. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏ –∏–ª–∏ —Ü–µ–Ω—ã –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**  
–î–æ–±–∞–≤–∏—Ç—å UI —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö (–∫–∞—Ç–∞–ª–æ–≥, –æ—Å—Ç–∞—Ç–∫–∏, —Ü–µ–Ω—ã, –∫–ª–∏–µ–Ω—Ç—ã) —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

**–¶–µ–Ω–Ω–æ—Å—Ç—å:**
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–æ—Å—Ç–∞—Ç–∫–∏: 30 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 5 –º–∏–Ω)
- –ì–∏–±–∫–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤

---

## Acceptance Criteria

### AC1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- [ ] –°—Ç–∞—Ä—ã–π action "trigger_catalog_import" –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ "trigger_selective_import"
- [ ] Action –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω: "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–∑ 1–°" ‚Üí "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°"
- [ ] –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ action –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è intermediate page —Å —Ñ–æ—Ä–º–æ–π –≤—ã–±–æ—Ä–∞
- [ ] –ü–æ–¥—Ä–∞–∑–¥–µ–ª "–°–µ—Å—Å–∏–∏ –∏–º–ø–æ—Ä—Ç–∞" –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (readonly)

### AC2: UI –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- [ ] Intermediate page —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ä–º—É —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏:
  - ‚òëÔ∏è –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–±—Ä–∞–Ω)
  - ‚òê –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
  - ‚òê –¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤  
  - ‚òê –ö–ª–∏–µ–Ω—Ç—ã
- [ ] –ü–æ–¥ –∫–∞–∂–¥—ã–º —á–µ–∫–±–æ–∫—Å–æ–º –ø–æ–∫–∞–∑–∞–Ω—ã –ø–æ–¥—Å–∫–∞–∑–∫–∏:
  - "–û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤" ‚Üí "(—Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞)"
  - "–¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤" ‚Üí "(—Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞)"
- [ ] –ö–Ω–æ–ø–∫–∏: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç" –∏ "–û—Ç–º–µ–Ω–∞"

### AC3: –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã "–û—Å—Ç–∞—Ç–∫–∏" –∏–ª–∏ "–¶–µ–Ω—ã" –ë–ï–ó "–ö–∞—Ç–∞–ª–æ–≥":
  - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `Product.objects.exists()`
  - –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç ‚Üí –æ—à–∏–±–∫–∞: "‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏/—Ü–µ–Ω—ã: –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ –ø—É—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥."
- [ ] –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–ö–∞—Ç–∞–ª–æ–≥" ‚Üí –æ—Å—Ç–∞—Ç–∫–∏ –∏ —Ü–µ–Ω—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
- [ ] "–ö–ª–∏–µ–Ω—Ç—ã" –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–∞—Ç–∞–ª–æ–≥–∞

### AC4: –ú–µ—Ö–∞–Ω–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–º–ø–æ—Ä—Ç–∞
- [ ] –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ:
  1. –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
  2. –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
  3. –¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
  4. –ö–ª–∏–µ–Ω—Ç—ã (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
- [ ] –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è `ImportSession` —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º `import_type`
- [ ] Distributed lock (Redis) –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç concurrent –∑–∞–ø—É—Å–∫–∏
- [ ] –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–≤–æ–¥–∫–∞:
  - "‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: –ö–∞—Ç–∞–ª–æ–≥ (1234 —Ç–æ–≤–∞—Ä–æ–≤), –û—Å—Ç–∞—Ç–∫–∏ (1234 SKU), –ö–ª–∏–µ–Ω—Ç—ã (56 –∫–ª–∏–µ–Ω—Ç–æ–≤)"

### AC5: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –ï—Å–ª–∏ –∏–º–ø–æ—Ä—Ç –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π ‚Üí —Å–ª–µ–¥—É—é—â–∏–π —Ç–∏–ø –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–∞: [–¥–µ—Ç–∞–ª–∏]. –û—Å—Ç–∞—Ç–∫–∏ –∏ —Ü–µ–Ω—ã –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã."
- [ ] –í—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ `ImportSession` –∏–º–µ—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å (`FAILED` –¥–ª—è –æ—à–∏–±–æ—á–Ω—ã—Ö)

---

## Technical Design

### Architecture Overview

**–ü–æ–¥—Ö–æ–¥:** Custom Admin Action —Å Intermediate Page (Django Admin –Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π
- ‚úÖ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ UI
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Redis lock –º–µ—Ö–∞–Ω–∏–∑–º

### Implementation Details

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `backend/apps/integrations/admin.py` - –æ–±–Ω–æ–≤–∏—Ç—å action
- `backend/templates/admin/integrations/import_selection.html` - —Å–æ–∑–¥–∞—Ç—å template

**Management Commands Mapping:**

| –¢–∏–ø –∏–º–ø–æ—Ä—Ç–∞ | ImportType | Management Command | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã |
|-------------|------------|-------------------|----------|
| –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ | `CATALOG` | `import_catalog_from_1c` | `--data-dir`, `--file-type=all` |
| –û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ | `STOCKS` | `load_product_stocks` | `--file` (rests.xml) |
| –¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ | `PRICES` | `import_catalog_from_1c` | `--data-dir`, `--file-type=prices` |
| –ö–ª–∏–µ–Ω—Ç—ã | `CUSTOMERS` | `import_customers_from_1c` | `--file` (contragents.xml) |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¶–µ–Ω—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ `import_catalog_from_1c` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `--file-type=prices`.

### Code Structure

```python
# backend/apps/integrations/admin.py

@admin.register(IntegrationImportSession)
class ImportSessionAdmin(admin.ModelAdmin):
    # ... existing code ...
    
    actions = ["trigger_selective_import"]
    
    @admin.action(description="üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°")
    def trigger_selective_import(self, request, queryset):
        """
        –ó–∞–ø—É—Å–∫ –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Å intermediate page –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–æ–≤.
        """
        if 'apply' in request.POST:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
            selected_types = request.POST.getlist('import_types')
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            is_valid, error_message = self._validate_dependencies(selected_types)
            if not is_valid:
                self.message_user(request, error_message, level='ERROR')
                return
            
            # –ó–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞
            self._run_sequential_import(request, selected_types)
            return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º intermediate page —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏
        context = {
            'title': '–í—ã–±–æ—Ä —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞',
            'import_types': [
                {'value': 'catalog', 'label': '–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤', 'checked': True},
                {'value': 'stocks', 'label': '–û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', 'hint': '(—Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞)'},
                {'value': 'prices', 'label': '–¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤', 'hint': '(—Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞)'},
                {'value': 'customers', 'label': '–ö–ª–∏–µ–Ω—Ç—ã'},
            ],
            'queryset': queryset,
            'action': 'trigger_selective_import',
        }
        return TemplateResponse(request, 'admin/integrations/import_selection.html', context)
    
    def _validate_dependencies(self, selected_types):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ –∏–º–ø–æ—Ä—Ç–∞"""
        if ('stocks' in selected_types or 'prices' in selected_types):
            if 'catalog' not in selected_types:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î
                if not Product.objects.exists():
                    return False, (
                        "‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏/—Ü–µ–Ω—ã: –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ –ø—É—Å—Ç. "
                        "–°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ '–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤' –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞."
                    )
        return True, ""
    
    def _run_sequential_import(self, request, selected_types):
        """–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–æ–≤"""
        redis_conn = get_redis_connection("default")
        lock_key = "import_catalog_lock"
        lock = redis_conn.lock(lock_key, timeout=3600)
        
        if not lock.acquire(blocking=False):
            self.message_user(
                request,
                "‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω! –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.",
                level='WARNING'
            )
            return
        
        results = []
        try:
            data_dir = getattr(settings, 'ONEC_DATA_DIR', None)
            if not data_dir:
                raise ValueError("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ONEC_DATA_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ settings.")
            
            # –ü–æ—Ä—è–¥–æ–∫ –∏–º–ø–æ—Ä—Ç–∞: catalog ‚Üí stocks ‚Üí prices ‚Üí customers
            import_order = ['catalog', 'stocks', 'prices', 'customers']
            
            for import_type in import_order:
                if import_type not in selected_types:
                    continue
                
                try:
                    result = self._execute_import(import_type, data_dir)
                    results.append(result)
                except Exception as e:
                    # –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–µ–ø–æ—á–∫—É
                    self.message_user(
                        request,
                        f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ {import_type}: {e}. "
                        f"–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç–º–µ–Ω–µ–Ω—ã.",
                        level='ERROR'
                    )
                    return
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            summary = self._format_import_summary(results)
            self.message_user(request, f"‚úÖ {summary}", level='SUCCESS')
            
        except Exception as e:
            self.message_user(request, f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", level='ERROR')
        finally:
            lock.release()
    
    def _execute_import(self, import_type, data_dir):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞"""
        if import_type == 'catalog':
            call_command('import_catalog_from_1c', '--data-dir', str(data_dir), '--file-type', 'all')
            return {'type': 'catalog', 'message': '–ö–∞—Ç–∞–ª–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω'}
        
        elif import_type == 'stocks':
            file_path = Path(data_dir) / 'rests' / 'rests.xml'
            call_command('load_product_stocks', '--file', str(file_path))
            return {'type': 'stocks', 'message': '–û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'}
        
        elif import_type == 'prices':
            call_command('import_catalog_from_1c', '--data-dir', str(data_dir), '--file-type', 'prices')
            return {'type': 'prices', 'message': '–¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã'}
        
        elif import_type == 'customers':
            file_path = Path(data_dir) / 'contragents' / 'contragents.xml'
            call_command('import_customers_from_1c', '--file', str(file_path))
            return {'type': 'customers', 'message': '–ö–ª–∏–µ–Ω—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã'}
    
    def _format_import_summary(self, results):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        messages = [r['message'] for r in results]
        return f"–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω: {', '.join(messages)}"
```

---

## Tasks / Subtasks

### Task 1: –°–æ–∑–¥–∞—Ç—å intermediate page template
- [ ] –°–æ–∑–¥–∞—Ç—å `backend/templates/admin/integrations/import_selection.html`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É —Å 4 —á–µ–∫–±–æ–∫—Å–∞–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [ ] –°—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Django Admin Bootstrap
- [ ] –î–æ–±–∞–≤–∏—Ç—å CSRF token

### Task 2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π  
- [ ] –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_validate_dependencies(selected_types)` –≤ `ImportSessionAdmin`
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ `stocks` –∏–ª–∏ `prices` –±–µ–∑ `catalog` ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `Product.objects.exists()`
- [ ] –í–æ–∑–≤—Ä–∞—â–∞—Ç—å `(is_valid: bool, error_message: str)`

### Task 3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–æ–≤
- [ ] –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_run_sequential_import(request, selected_types)`
- [ ] –ó–∞—Ö–≤–∞—Ç–∏—Ç—å Redis lock –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
- [ ] –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞:
  - –°–æ–∑–¥–∞—Ç—å `ImportSession` —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º `import_type`
  - –í—ã–∑–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π management command
  - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å `ImportSession`
  - –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí –ø—Ä–µ—Ä–≤–∞—Ç—å —Ü–µ–ø–æ—á–∫—É
- [ ] –û—Å–≤–æ–±–æ–¥–∏—Ç—å lock –≤ finally –±–ª–æ–∫–µ
- [ ] –°–æ–±—Ä–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### Task 4: –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π action
- [ ] –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å action: "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°"
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É intermediate page:
  - –ï—Å–ª–∏ `'apply'` –Ω–µ –≤ POST ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É
  - –ï—Å–ª–∏ `'apply'` –≤ POST ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è + –∑–∞–ø—É—Å–∫
- [ ] –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–º–µ–Ω—É (redirect –Ω–∞ changelist)

### Task 5: –°–æ–∑–¥–∞—Ç—å helper –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
- [ ] –°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `_get_import_file_path(import_type)` 
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `settings.ONEC_DATA_DIR` –∫–∞–∫ –±–∞–∑–æ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
- [ ] –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏:
  - `STOCKS` ‚Üí `{ONEC_DATA_DIR}/rests/rests.xml`
  - `CUSTOMERS` ‚Üí `{ONEC_DATA_DIR}/contragents/contragents.xml`
- [ ] –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –∫–æ–º–∞–Ω–¥
- [ ] –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É —Å –ø—É—Ç–µ–º –∫ –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–∞–π–ª—É

### Task 6: Unit –∏ Integration —Ç–µ—Å—Ç—ã
- [ ] `test_validate_dependencies_stocks_without_catalog_empty_db()` ‚Üí –æ—à–∏–±–∫–∞
- [ ] `test_validate_dependencies_stocks_without_catalog_with_products()` ‚Üí OK
- [ ] `test_sequential_import_catalog_and_stocks()` ‚Üí 2 ImportSession
- [ ] `test_sequential_import_catalog_failed_stocks_not_started()` ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] `test_concurrent_import_prevention()` ‚Üí Redis lock
- [ ] `test_intermediate_page_renders_correctly()` ‚Üí UI —Ç–µ—Å—Ç

### Task 7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `docs/admin-guide.md`:
  - –†–∞–∑–¥–µ–ª "–í—ã–±–æ—Ä–æ—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
  - Screenshots intermediate page
  - –ü—Ä–∏–º–µ—Ä—ã use cases (—Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏, –∫–∞—Ç–∞–ª–æ–≥ + –æ—Å—Ç–∞—Ç–∫–∏)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `docs/architecture/20-1c-integration.md`:
  - –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ UI –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
  - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

---

## Dependencies

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ management commands:**
- ‚úÖ `import_catalog_from_1c` - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `--file-type` –ø–∞—Ä–∞–º–µ—Ç—Ä
- ‚úÖ `load_product_stocks` - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å rests.xml
- ‚úÖ `import_customers_from_1c` - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å contragents.xml

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- Story 9.3 (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞) - –±–∞–∑–æ–≤—ã–π action –∏ Redis lock
- Redis –¥–ª—è distributed lock
- Django Admin intermediate pages

---

## Estimated Effort

**Total: 2-3 –¥–Ω—è (14-18 —á–∞—Å–æ–≤)**

- Task 1 (Template): 2 —á–∞—Å–∞
- Task 2 (Validation): 3 —á–∞—Å–∞
- Task 3 (Sequential import): 4 —á–∞—Å–∞
- Task 4 (Update action): 1 —á–∞—Å
- Task 5 (File paths helper): 1 —á–∞—Å
- Task 6 (Tests): 5 —á–∞—Å–æ–≤
- Task 7 (Docs): 2 —á–∞—Å–∞

---

## Risks & Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ >10 –º–∏–Ω—É—Ç | Medium | –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å —á–µ—Ä–µ–∑ auto-refresh, —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å async –¥–ª—è Post-MVP |
| –°–ª–æ–∂–Ω–æ—Å—Ç—å UI –¥–ª—è intermediate page | Low | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ Django Admin —Å—Ç–∏–ª–∏ |
| –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º | Medium | –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∫–æ–º–∞–Ω–¥ |

---

## Definition of Done

- [ ] –í—Å–µ AC –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (AC1-AC5)
- [ ] Intermediate page —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏
- [ ] –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ ImportSession
- [ ] Redis lock –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç concurrent –∑–∞–ø—É—Å–∫–∏
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ (unit + integration, coverage >80%)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] Code review –ø—Ä–æ–π–¥–µ–Ω
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä—É—á–Ω—É—é –≤ Docker –æ–∫—Ä—É–∂–µ–Ω–∏–∏

---

## Dev Notes

### Architecture Context

**Epic & Architecture References:**
- Epic –∫–æ–Ω—Ç–µ–∫—Å—Ç: `docs/epics/epic-9-admin-panel.md` ‚Äî –±–∏–∑–Ω–µ—Å-—Ü–µ–ª–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: `docs/architecture/20-1c-integration.md` ‚Äî –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°
- Story 9.3: `docs/stories/epic-9/9.3-import-action-monitoring.md` ‚Äî –±–∞–∑–æ–≤—ã–π action –∏ Redis lock

**–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `backend/apps/integrations/admin.py` - ImportSessionAdmin —Å action
- `backend/apps/integrations/models.py` - IntegrationImportSession (proxy)
- `backend/apps/products/models.py` - ImportSession —Å —Ç–∏–ø–∞–º–∏ –∏–º–ø–æ—Ä—Ç–∞

**Management Commands:**
- `backend/apps/products/management/commands/import_catalog_from_1c.py`
- `backend/apps/products/management/commands/load_product_stocks.py`
- `backend/apps/users/management/commands/import_customers_from_1c.py`

### File Validation Example

```python
# backend/apps/integrations/admin.py

def _execute_import(self, import_type, data_dir):
    """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤"""
    if import_type == 'catalog':
        # –î–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        if not Path(data_dir).exists():
            raise FileNotFoundError(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {data_dir}")
        call_command('import_catalog_from_1c', '--data-dir', str(data_dir), '--file-type', 'all')
        return {'type': 'catalog', 'message': '–ö–∞—Ç–∞–ª–æ–≥ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω'}
    
    elif import_type == 'stocks':
        file_path = Path(data_dir) / 'rests' / 'rests.xml'
        if not file_path.exists():
            raise FileNotFoundError(
                f"–§–∞–π–ª –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}. "
                f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ 1–° –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ {data_dir}"
            )
        call_command('load_product_stocks', '--file', str(file_path))
        return {'type': 'stocks', 'message': '–û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã'}
    
    elif import_type == 'prices':
        if not Path(data_dir).exists():
            raise FileNotFoundError(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {data_dir}")
        call_command('import_catalog_from_1c', '--data-dir', str(data_dir), '--file-type', 'prices')
        return {'type': 'prices', 'message': '–¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã'}
    
    elif import_type == 'customers':
        file_path = Path(data_dir) / 'contragents' / 'contragents.xml'
        if not file_path.exists():
            raise FileNotFoundError(
                f"–§–∞–π–ª –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}. "
                f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ 1–° –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ {data_dir}"
            )
        call_command('import_customers_from_1c', '--file', str(file_path))
        return {'type': 'customers', 'message': '–ö–ª–∏–µ–Ω—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã'}
```

### Template Example

```django
{% extends "admin/base_site.html" %}

{% block content %}
<form method="post">
  {% csrf_token %}
  
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:</h2>
  
  <div style="margin: 20px 0;">
    <label style="display: block; margin-bottom: 10px;">
      <input type="checkbox" name="import_types" value="catalog" checked>
      <strong>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</strong>
    </label>
    
    <label style="display: block; margin-bottom: 10px;">
      <input type="checkbox" name="import_types" value="stocks">
      <strong>–û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</strong>
      <span style="color: gray; font-size: 0.9em;">(—Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞)</span>
    </label>
    
    <label style="display: block; margin-bottom: 10px;">
      <input type="checkbox" name="import_types" value="prices">
      <strong>–¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤</strong>
      <span style="color: gray; font-size: 0.9em;">(—Ç—Ä–µ–±—É–µ—Ç –Ω–∞–ª–∏—á–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞)</span>
    </label>
    
    <label style="display: block; margin-bottom: 10px;">
      <input type="checkbox" name="import_types" value="customers">
      <strong>–ö–ª–∏–µ–Ω—Ç—ã</strong>
    </label>
  </div>
  
  <div style="margin-top: 20px;">
    <input type="hidden" name="action" value="trigger_selective_import">
    <input type="submit" name="apply" value="–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç" class="button default">
    <a href="{% url 'admin:integrations_integrationimportsession_changelist' %}" class="button">–û—Ç–º–µ–Ω–∞</a>
  </div>
</form>
{% endblock %}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-03 | 1.0 | Initial story creation | Sarah (PO) |
