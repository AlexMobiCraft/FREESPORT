# Story 9.8: End-to-end тестирование и документация рефакторинга импорта

**Epic:** Epic 9 - Advanced Admin Panel  
**Story ID:** 9.8  
**Status:** Draft  
**Priority:** Высокий (финализация рефакторинга)

---

## Story

**As a** QA Engineer and Platform Administrator,  
**I want** комплексное тестирование нового flow импорта и актуальную документацию,  
**so that** я уверен в корректности работы системы и знаю как использовать новый интерфейс.

---

## Business Context

**Проблема:**  
После рефакторинга интерфейса импорта (Stories 9.6, 9.7) необходимо убедиться, что:
- Весь новый flow работает корректно end-to-end
- Нет регрессий в существующей функциональности
- Администраторы понимают как использовать новый интерфейс

**Решение:**  
Провести комплексное тестирование всех типов импорта с реальными данными из 1С и создать детальную документацию по использованию.

**Ценность:**
- Уверенность в качестве рефакторинга
- Предотвращение проблем на продакшене
- Быстрое onboarding новых администраторов
- Troubleshooting guide для решения проблем

---

## Acceptance Criteria

1. **Все 4 типа импорта протестированы end-to-end**
   - Полный каталог (goods, offers, prices, rests, properties, groups)
   - Только остатки (сегментированные rests_*.xml)
   - Только цены (сегментированные prices_*.xml)
   - Клиенты (contragents.xml)
   - Каждый тип запускается через новую страницу `/admin/integrations/import_1c/`

2. **Валидация зависимостей работает корректно**
   - Попытка импорта остатков без каталога отклоняется
   - Попытка импорта цен без каталога отклоняется
   - Отображается понятное сообщение об ошибке
   - После импорта каталога остатки/цены импортируются успешно

3. **Redis lock предотвращает параллельные импорты**
   - Запуск второго импорта во время первого отклоняется
   - Отображается предупреждение "Импорт уже запущен"
   - После завершения первого импорта второй можно запустить
   - Lock автоматически освобождается через timeout (3600 сек)

4. **Celery задачи выполняются корректно**
   - Задача запускается асинхронно
   - ImportSession создается с правильным типом
   - celery_task_id сохраняется в сессии
   - Статус сессии обновляется (STARTED → COMPLETED/FAILED)
   - report_details содержит детальную информацию

5. **Автообновление статуса работает на странице сессий**
   - JavaScript автообновление активируется при наличии активных задач
   - Статус Celery задачи обновляется каждые 5 секунд
   - Иконки и цвета отображаются корректно (⏳ PENDING, ▶️ STARTED, ✅ SUCCESS, ❌ FAILURE)
   - Автообновление останавливается когда нет активных задач

6. **Документация обновлена с примерами использования**
   - User guide: как запустить импорт
   - Описание каждого типа импорта
   - Troubleshooting guide для типичных проблем
   - Screenshots или описание UI

7. **Нет регрессий в существующей функциональности импорта**
   - Management команды работают как раньше
   - Парсеры и процессоры из Epic 3 работают корректно
   - Сегментированные файлы обрабатываются правильно
   - CustomerSyncLog создается для импорта клиентов

---

## Dev Notes

### Previous Story Context

**Story 9.6 (import-page-creation):**
- Создана новая страница `/admin/integrations/import_1c/`
- Форма с 4 типами импорта
- Валидация зависимостей
- Redis lock механизм
- Запуск Celery задач

**Story 9.7 (sessions-page-refactor):**
- Страница сессий стала read-only
- URL изменен на `/admin/integrations/session/`
- Сохранен функционал мониторинга
- Автообновление JavaScript

### Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**E2E тестирование:**
- Использовать реальные данные из `data/import_1c/`
- Тестировать в Docker окружении
- Проверять всю цепочку: UI → Celery → Management команды → БД

**Regression тестирование:**
- Запустить существующие тесты Epic 3
- Проверить что парсеры работают
- Проверить что процессоры работают

**Performance тестирование:**
- Импорт ~6200 товаров должен завершаться за разумное время
- Автообновление не должно создавать чрезмерную нагрузку

### Test Data

**Реальные данные из 1С** [Source: data/import_1c/]
```
data/import_1c/
├── goods/
│   ├── goods_1_*.xml (сегментированные файлы)
│   └── import_files/ (изображения)
├── offers/
│   └── offers_*.xml
├── prices/
│   └── prices_1_*.xml (сегментированные файлы)
├── rests/
│   └── rests_1_*.xml (сегментированные файлы)
├── groups/
│   └── groups_1_1_*.xml
├── contragents/
│   └── contragents.xml
├── units.xml
├── storages.xml
├── priceLists.xml
├── propertiesGoods/
└── propertiesOffers/
```

### Documentation Structure

**User Guide** (для администраторов):
1. Как запустить импорт данных из 1С
2. Типы импорта и когда их использовать
3. Как отслеживать прогресс импорта
4. Что делать если импорт завис

**Technical Documentation** (для разработчиков):
1. Архитектура нового flow
2. Изменения в admin.py
3. Integration с Epic 3
4. Troubleshooting guide

### File Locations

**Новые файлы:**
- `docs/admin-guides/import-from-1c-guide.md` - user guide
- `docs/architecture/import-refactor-architecture.md` - technical docs
- `backend/tests/e2e/test_import_flow.py` - E2E тесты

**Обновляемые файлы:**
- `README.md` - добавить секцию об импорте
- `docs/epics/epic-import-refactor.md` - обновить статус Stories

### Testing Requirements

**E2E тесты (новые):**
- test_full_catalog_import_flow()
- test_stocks_only_import_flow()
- test_prices_only_import_flow()
- test_customers_import_flow()
- test_validation_prevents_stocks_without_catalog()
- test_validation_prevents_prices_without_catalog()
- test_redis_lock_prevents_concurrent_imports()
- test_celery_task_creates_session_with_correct_type()
- test_auto_refresh_updates_task_status()

**Regression тесты (существующие):**
- Запустить все тесты Epic 3
- Проверить покрытие ≥90%

**Manual тесты:**
- UI тестирование в браузере
- Проверка автообновления
- Проверка сообщений об ошибках

### Technical Constraints

**Docker окружение:** [Source: user preferences]
- Все тесты запускать через Docker Compose
- Использовать `docker-compose -f docker/docker-compose.yml`

**Реальные данные:**
- Использовать данные из `data/import_1c/`
- Не генерировать синтетические данные

**Celery:**
- Тесты должны работать с реальным Celery worker
- Или использовать `CELERY_TASK_ALWAYS_EAGER=True` для синхронного выполнения

### Integration Points

**С Epic 3:**
- XMLDataParser, ProductDataProcessor
- CustomerDataParser, CustomerDataProcessor
- Management команды: import_catalog_from_1c, import_customers_from_1c

**С Stories 9.6, 9.7:**
- Новая страница импорта
- Read-only страница сессий
- Celery задача run_selective_import_task

---

## Tasks / Subtasks

### Task 1: E2E тестирование всех типов импорта (AC: 1)

**Расположение:** `backend/tests/e2e/test_import_flow.py`

- [ ] **1.1** Тест полного каталога
  ```python
  def test_full_catalog_import_flow():
      # 1. Открыть /admin/integrations/import_1c/
      # 2. Выбрать "Полный каталог"
      # 3. Нажать "Запустить импорт"
      # 4. Проверить создание ImportSession с типом CATALOG
      # 5. Проверить запуск Celery задачи
      # 6. Дождаться завершения
      # 7. Проверить что товары импортированы
  ```

- [ ] **1.2** Тест импорта только остатков
  ```python
  def test_stocks_only_import_flow():
      # Предусловие: каталог уже импортирован
      # 1. Выбрать "Только остатки"
      # 2. Проверить создание ImportSession с типом STOCKS
      # 3. Проверить обновление остатков
  ```

- [ ] **1.3** Тест импорта только цен
  ```python
  def test_prices_only_import_flow():
      # Предусловие: каталог уже импортирован
      # 1. Выбрать "Только цены"
      # 2. Проверить создание ImportSession с типом PRICES
      # 3. Проверить обновление цен
  ```

- [ ] **1.4** Тест импорта клиентов
  ```python
  def test_customers_import_flow():
      # 1. Выбрать "Клиенты"
      # 2. Проверить создание ImportSession с типом CUSTOMERS
      # 3. Проверить создание User записей
      # 4. Проверить создание CustomerSyncLog записей
  ```

**E2E тесты:**
- test_full_catalog_import_flow()
- test_stocks_only_import_flow()
- test_prices_only_import_flow()
- test_customers_import_flow()

### Task 2: Тестирование валидации зависимостей (AC: 2)

**Расположение:** `backend/tests/e2e/test_import_flow.py`

- [ ] **2.1** Тест отклонения импорта остатков без каталога
  ```python
  def test_validation_prevents_stocks_without_catalog():
      # Предусловие: БД пустая, нет товаров
      # 1. Попытаться импортировать остатки
      # 2. Проверить что отображается ошибка
      # 3. Проверить что ImportSession не создана
  ```

- [ ] **2.2** Тест отклонения импорта цен без каталога
  ```python
  def test_validation_prevents_prices_without_catalog():
      # Аналогично для цен
  ```

- [ ] **2.3** Тест успешного импорта после каталога
  ```python
  def test_stocks_import_succeeds_after_catalog():
      # 1. Импортировать каталог
      # 2. Импортировать остатки - должно пройти успешно
  ```

**E2E тесты:**
- test_validation_prevents_stocks_without_catalog()
- test_validation_prevents_prices_without_catalog()
- test_stocks_import_succeeds_after_catalog()

### Task 3: Тестирование Redis lock (AC: 3)

**Расположение:** `backend/tests/e2e/test_import_flow.py`

- [ ] **3.1** Тест предотвращения параллельных импортов
  ```python
  def test_redis_lock_prevents_concurrent_imports():
      # 1. Запустить первый импорт (долгий)
      # 2. Попытаться запустить второй импорт
      # 3. Проверить что отображается предупреждение
      # 4. Проверить что второй импорт не запущен
  ```

- [ ] **3.2** Тест освобождения lock после завершения
  ```python
  def test_redis_lock_released_after_completion():
      # 1. Запустить импорт
      # 2. Дождаться завершения
      # 3. Проверить что lock освобожден
      # 4. Запустить второй импорт - должен пройти
  ```

**E2E тесты:**
- test_redis_lock_prevents_concurrent_imports()
- test_redis_lock_released_after_completion()

### Task 4: Тестирование Celery задач (AC: 4)

**Расположение:** `backend/tests/integration/test_celery_tasks.py`

- [ ] **4.1** Тест создания ImportSession с правильным типом
  ```python
  def test_celery_task_creates_session_with_correct_type():
      # Для каждого типа импорта проверить:
      # 1. ImportSession создана
      # 2. import_type соответствует выбранному
      # 3. celery_task_id сохранен
  ```

- [ ] **4.2** Тест обновления статуса сессии
  ```python
  def test_celery_task_updates_session_status():
      # 1. Запустить задачу
      # 2. Проверить status = STARTED
      # 3. Дождаться завершения
      # 4. Проверить status = COMPLETED
      # 5. Проверить finished_at заполнен
  ```

- [ ] **4.3** Тест заполнения report_details
  ```python
  def test_celery_task_fills_report_details():
      # Проверить что report_details содержит:
      # - Количество обработанных записей
      # - Время выполнения
      # - Детали операций
  ```

**Integration тесты:**
- test_celery_task_creates_session_with_correct_type()
- test_celery_task_updates_session_status()
- test_celery_task_fills_report_details()

### Task 5: Тестирование автообновления (AC: 5)

**Расположение:** `backend/tests/e2e/test_auto_refresh.py`

- [ ] **5.1** Тест активации автообновления
  ```python
  def test_auto_refresh_activates_for_active_tasks():
      # 1. Запустить импорт
      # 2. Открыть страницу сессий
      # 3. Проверить что JavaScript автообновление активно
      # 4. Проверить AJAX запросы каждые 5 секунд
  ```

- [ ] **5.2** Тест обновления статуса задачи
  ```python
  def test_auto_refresh_updates_task_status():
      # 1. Запустить импорт
      # 2. Проверить что статус меняется: PENDING → STARTED → SUCCESS
      # 3. Проверить что иконки обновляются
  ```

- [ ] **5.3** Тест остановки автообновления
  ```python
  def test_auto_refresh_stops_when_no_active_tasks():
      # 1. Дождаться завершения всех импортов
      # 2. Проверить что автообновление остановлено
  ```

**E2E тесты:**
- test_auto_refresh_activates_for_active_tasks()
- test_auto_refresh_updates_task_status()
- test_auto_refresh_stops_when_no_active_tasks()

### Task 6: Regression тестирование (AC: 7)

**Расположение:** Существующие тесты Epic 3

- [ ] **6.1** Запустить все тесты Epic 3
  ```bash
  docker-compose -f docker/docker-compose.yml exec backend pytest backend/tests/integration/test_management_commands/
  ```

- [ ] **6.2** Проверить парсеры
  - test_xml_data_parser_parses_goods()
  - test_xml_data_parser_parses_offers()
  - test_xml_data_parser_parses_prices()
  - test_xml_data_parser_parses_rests()

- [ ] **6.3** Проверить процессоры
  - test_product_data_processor_creates_products()
  - test_customer_data_processor_creates_users()

- [ ] **6.4** Проверить management команды
  - test_import_catalog_from_1c_command()
  - test_import_customers_from_1c_command()

**Regression тесты:**
- Все существующие тесты Epic 3 должны проходить

### Task 7: Создание документации (AC: 6)

**Расположение:** `docs/admin-guides/` и `docs/architecture/`

- [ ] **7.1** Создать User Guide для администраторов
  ```markdown
  # Руководство по импорту данных из 1С
  
  ## Как запустить импорт
  1. Откройте Django Admin
  2. Перейдите в раздел ИНТЕГРАЦИИ → Импорт из 1С
  3. Выберите тип импорта
  4. Нажмите "Запустить импорт"
  
  ## Типы импорта
  - Полный каталог: импорт всех данных (товары, категории, цены, остатки)
  - Только остатки: обновление остатков товаров
  - Только цены: обновление цен товаров
  - Клиенты: импорт контрагентов из 1С
  
  ## Отслеживание прогресса
  1. Перейдите в ИНТЕГРАЦИИ → Сессии
  2. Найдите свою сессию по времени запуска
  3. Статус Celery Task показывает текущее состояние
  4. Страница автоматически обновляется каждые 5 секунд
  
  ## Troubleshooting
  - "Сначала импортируйте каталог" - нужно сначала импортировать полный каталог
  - "Импорт уже запущен" - дождитесь завершения текущего импорта
  - Статус "Ошибка" - проверьте детали в колонке Error Message
  ```

- [ ] **7.2** Создать Technical Documentation
  ```markdown
  # Архитектура рефакторинга импорта
  
  ## Обзор изменений
  - Разделение UI на две страницы
  - Сохранение всей логики импорта из Epic 3
  
  ## Компоненты
  - ImportFrom1CAdmin - страница запуска
  - ImportSessionAdmin - страница мониторинга
  - run_selective_import_task - Celery задача
  
  ## Flow диаграмма
  [Описание flow]
  ```

- [ ] **7.3** Обновить README.md
  - Добавить секцию "Импорт данных из 1С"
  - Ссылки на user guide и technical docs

- [ ] **7.4** Создать Troubleshooting Guide
  - Типичные проблемы и решения
  - FAQ

**Документация:**
- docs/admin-guides/import-from-1c-guide.md
- docs/architecture/import-refactor-architecture.md
- README.md (обновлен)
- docs/troubleshooting/import-issues.md

### Task 8: Финализация и проверка

- [ ] **8.1** Запустить все тесты
  ```bash
  docker-compose -f docker/docker-compose.yml exec backend pytest
  ```

- [ ] **8.2** Проверить покрытие кода
  ```bash
  docker-compose -f docker/docker-compose.yml exec backend pytest --cov
  ```
  - Покрытие ≥90% для нового кода

- [ ] **8.3** Manual UI тестирование
  - Проверить все 4 типа импорта в браузере
  - Проверить автообновление
  - Проверить сообщения об ошибках

- [ ] **8.4** Обновить статус Stories
  - Story 9.6 → Done
  - Story 9.7 → Done
  - Story 9.8 → Done
  - Epic import-refactor → Done

---

## Definition of Done

- [ ] Все 4 типа импорта протестированы end-to-end с реальными данными
- [ ] Валидация зависимостей работает (остатки/цены требуют каталог)
- [ ] Redis lock предотвращает параллельные импорты
- [ ] Celery задачи создают ImportSession с правильным типом
- [ ] celery_task_id сохраняется и статус обновляется
- [ ] Автообновление JavaScript работает каждые 5 секунд
- [ ] Иконки и цвета Celery task status отображаются корректно
- [ ] Все regression тесты Epic 3 проходят
- [ ] Покрытие кода тестами ≥90%
- [ ] User Guide создан с примерами и screenshots
- [ ] Technical Documentation описывает архитектуру
- [ ] Troubleshooting Guide содержит типичные проблемы
- [ ] README.md обновлен
- [ ] Manual UI тестирование пройдено
- [ ] Нет регрессий в существующей функциональности
- [ ] Все тесты проходят в Docker окружении

---

## Dependencies

**Блокирующие зависимости:**
- ⏳ Story 9.6 (import-page-creation) - Draft (должна быть Done)
- ⏳ Story 9.7 (sessions-page-refactor) - Draft (должна быть Done)

**Порядок реализации:**
1. Story 9.6 → Done
2. Story 9.7 → Done
3. Story 9.8 → Testing & Documentation

---

## Notes

- Эта история завершает весь Epic рефакторинга импорта
- Использовать реальные данные из `data/import_1c/` (~6200 товаров)
- Все тесты запускать через Docker Compose
- Manual тестирование обязательно для UI компонентов
- Документация критична для onboarding администраторов

---

## Dev Agent Record

_Эта секция будет заполнена Dev Agent после реализации._

### Implementation Notes
<!-- Dev Agent: Опишите ключевые технические решения -->

### Challenges Encountered
<!-- Dev Agent: Опишите проблемы и их решения -->

### Debug Log References
<!-- Dev Agent: Ссылки на записи в debug log -->

### Completion Notes
<!-- Dev Agent: Финальные заметки о реализации -->
