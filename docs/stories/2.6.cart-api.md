# Story 2.6: cart-api

## Status
Ready for Development

## Story
**As a** покупатель,
**I want** управлять товарами в корзине через API,
**so that** подготовить заказ для оформления.

## Acceptance Criteria

1. GET `/cart/` возвращает содержимое корзины пользователя
2. POST `/cart/items/` добавляет товар (объединяет одинаковые)
3. PATCH `/cart/items/{id}/` обновляет количество
4. DELETE `/cart/items/{id}/` удаляет товар
5. Поддержка гостевых корзин через session

- [ ] Реализовать Cart model и API (AC: 1)
  - [ ] Создать Cart model с связью на User
  - [ ] Создать CartSerializer с подсчетом totals
  - [ ] Реализовать GET /cart/ endpoint
  - [ ] Добавить total_items и total_price поля
  - [ ] Настроить OneToOne relationship с User

- [ ] Добавление товаров в корзину (AC: 2)
  - [ ] Создать CartItem model с unique_together constraint
  - [ ] Создать CartItemCreateSerializer
  - [ ] Реализовать POST /cart/items/ endpoint
  - [ ] Логика объединения одинаковых товаров (FR6.1)
  - [ ] Валидация существования товара и наличия

- [ ] Обновление количества (AC: 3)
  - [ ] Создать CartItemUpdateSerializer
  - [ ] Реализовать PATCH /cart/items/{id}/ endpoint
  - [ ] Валидация минимального количества (≥1)
  - [ ] Проверка максимального количества по остаткам
  - [ ] Пересчет total_price при изменении

- [ ] Удаление товаров (AC: 4)
  - [ ] Реализовать DELETE /cart/items/{id}/ endpoint
  - [ ] Проверка принадлежности item пользователю
  - [ ] Добавить DELETE /cart/clear/ для очистки корзины
  - [ ] Обновление totals после удаления
  - [ ] Возврат 204 No Content при успехе

- [ ] Поддержка гостевых корзин (AC: 5)
  - [ ] Добавить session_key поле в Cart model
  - [ ] Логика создания корзины для неавторизованных
  - [ ] Перенос гостевой корзины при авторизации
  - [ ] Очистка старых гостевых корзин
  - [ ] Валидация session management

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: User model, Product model, session framework
- Технология: DRF ViewSets с custom actions
- Следует паттерну: Django related models для User.cart
- Точки касания: Cart/CartItem models, session handling для гостей

### Technical Notes
- **Integration Approach:** Cart/CartItem models с DRF nested serialization
- **Existing Pattern Reference:** Django session framework для anonymous users
- **Key Constraints:** Логика объединения товаров в одной позиции

### Cart Models Structure
```python
class Cart(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, null=True, blank=True)
    session_key = models.CharField(max_length=100, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    @property
    def total_items(self):
        return sum(item.quantity for item in self.items.all())
    
    @property
    def total_price(self):
        return sum(item.total_price for item in self.items.all())

class CartItem(models.Model):
    cart = models.ForeignKey(Cart, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField(default=1)
    added_at = models.DateTimeField(auto_now_add=True)
    
    @property
    def unit_price(self):
        # Получаем цену на основе роли пользователя корзины
        return self.product.get_price_for_user(self.cart.user)
    
    @property
    def total_price(self):
        return self.unit_price * self.quantity
    
    class Meta:
        unique_together = ('cart', 'product')  # Предотвращает дублирование
```

### Cart Item Merging Logic
```python
def add_to_cart(self, product, quantity):
    cart_item, created = CartItem.objects.get_or_create(
        cart=self.cart,
        product=product,
        defaults={'quantity': quantity}
    )
    
    if not created:
        # Объединяем количество если товар уже в корзине
        cart_item.quantity += quantity
        cart_item.save()
    
    return cart_item
```

### Testing
- Unit тесты для Cart/CartItem models
- Тестирование CRUD операций корзины
- Проверка логики объединения товаров
- Валидация гостевых корзин
- Интеграционные тесты с Product model

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial brownfield story creation | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
_TBD - будет заполнено dev агентом_

### Completion Notes List
_TBD - будет заполнено dev агентом_

### File List
_TBD - будет заполнено dev агентом_

## QA Results
_TBD - будет заполнено QA агентом_