# Story 16.1: Layout личного кабинета и страница профиля

## Status
**Approved** ✅
_Validated: 2025-12-15 by Sarah (PO Agent)_
_Implementation Readiness Score: 9.5/10_

## Story

**As a** зарегистрированный пользователь FREESPORT (B2B или B2C),
**I want** иметь доступ к защищённой области личного кабинета с навигацией и возможностью редактировать свой профиль,
**so that** я могу управлять своими личными данными, видеть свою роль и статус верификации

## Acceptance Criteria

1. Layout отображается корректно на desktop, tablet, mobile
2. Форма профиля загружает текущие данные пользователя
3. Успешное сохранение отображает toast уведомление
4. B2B пользователи видят поля компании (company_name, tax_id, verification_status)
5. Неавторизованные пользователи перенаправляются на `/login`
6. Покрытие unit-тестами 80%+

## Tasks / Subtasks

### Task 1: Создать защищённый Layout личного кабинета (AC: 1, 5)
- [ ] Создать `frontend/src/app/(profile)/layout.tsx`
  - [ ] **ВАЖНО:** Middleware (`frontend/src/middleware.ts`) УЖЕ защищает `/profile/*` маршруты
  - [ ] Layout не требует дополнительной auth проверки - middleware автоматически редиректит на `/login?next=/profile`
- [ ] Создать `ProfileLayout` компонент с боковой навигацией (desktop) и табами (mobile)
  - [ ] Desktop: боковое меню шириной 280px с навигацией (Профиль, Заказы, Адреса, Избранное)
  - [ ] Mobile/Tablet: горизонтальные Tabs (компонент из design-system.json)
  - [ ] Использовать Tailwind breakpoints: mobile (640px), tablet (1024px), desktop (1440px)
- [ ] Добавить responsive поведение с использованием Tailwind classes
  - [ ] Desktop: `grid grid-cols-[280px_1fr] gap-6`
  - [ ] Mobile: `flex flex-col`, Tabs с scroll-snap

### Task 2: Реализовать страницу `/profile` с формой профиля (AC: 2, 3, 4)
- [ ] Создать `frontend/src/app/(profile)/profile/page.tsx`
  - [ ] Использовать Next.js App Router и SSR для первичной загрузки данных
  - [ ] Использовать `authSelectors.useUser()` для получения текущего пользователя
- [ ] Создать `ProfileForm` компонент с React Hook Form + Zod валидацией
  - [ ] Базовые поля: email (readonly), first_name, last_name, phone
  - [ ] B2B поля (условно для ролей wholesale_*, trainer, federation_rep):
    - company_name
    - tax_id (ИНН)
    - verification_status (readonly, бейдж)
  - [ ] Валидация через Zod schema:
    - email: format validation
    - phone: формат +79001234567
    - tax_id: 10 или 12 цифр (для B2B)
- [ ] Интегрировать с API `/api/v1/users/profile/`
  - [ ] GET запрос при монтировании компонента через `axios`
  - [ ] PUT запрос при submit формы с обработкой ошибок
  - [ ] Использовать axios interceptors для JWT токенов
- [ ] Реализовать Toast уведомления через существующий `useToast()` хук
  - [ ] Импорт: `import { useToast } from '@/components/ui/Toast/ToastProvider'`
  - [ ] Success: `success('Профиль успешно обновлён')`
  - [ ] Error: `error('Ошибка при сохранении профиля')`
  - [ ] **ВАЖНО:** Toast компонент УЖЕ существует, НЕ создавайте его заново

### Task 3: Проверка существующей защиты маршрутов (AC: 5)
- [ ] **MIDDLEWARE УЖЕ СУЩЕСТВУЕТ** - `frontend/src/middleware.ts`
  - [ ] `/profile` УЖЕ защищён через `isProtectedRoute()` функцию
  - [ ] Автоматический редирект на `/login?next=/profile` работает
  - [ ] Проверка `refreshToken` из cookies уже реализована
- [ ] **НЕ ТРЕБУЕТСЯ:** Создание или изменение middleware
- [ ] **ПРОВЕРКА:** Убедиться, что `/profile` маршрут защищён (уже есть в protectedPaths)

### Task 4: Стилизация согласно Design System (AC: 1)
- [ ] Применить компоненты из design-system.json:
  - [ ] Input: высота 40px, radius 6px, border neutral-400
  - [ ] Button primary: bg #0060FF, hover #0047CC
  - [ ] Card: radius 16px, padding 24px, shadow default
  - [ ] Toast: варианты success/error с соответствующими цветами
  - [ ] Badge для verification_status: success (верифицирован), warning (на проверке)
- [ ] Использовать Tailwind tokens из design-system:
  - [ ] Colors: primary, neutral, accent
  - [ ] Typography: body-m для основного текста, body-s для helpers
  - [ ] Spacing: section spacing 48px, form vertical 16px

### Task 5: Unit-тестирование компонентов (AC: 6)
- [ ] Создать `frontend/src/app/(profile)/layout.test.tsx`
  - [ ] Тест: отображение навигации на desktop
  - [ ] Тест: отображение табов на mobile
  - [ ] Тест: redirect при отсутствии аутентификации
- [ ] Создать `frontend/src/app/(profile)/profile/page.test.tsx`
  - [ ] Тест: загрузка текущих данных пользователя (mock GET /profile)
  - [ ] Тест: успешное сохранение и отображение toast (mock PUT /profile)
  - [ ] Тест: отображение B2B полей для B2B пользователей
  - [ ] Тест: валидация формы (email, phone, tax_id)
  - [ ] Тест: обработка ошибок API
- [ ] Использовать MSW для мокирования API запросов
  - [ ] Setup handlers в `frontend/src/__mocks__/handlers.ts`
  - [ ] Mock responses для GET/PUT `/api/v1/users/profile/`
- [ ] Проверить покрытие тестами >= 80%
  - [ ] Команда: `npm run test:coverage`

### Task 6: E2E тест критического флоу (дополнительно)
- [ ] Создать `frontend/e2e/profile/edit-profile.spec.ts` (Playwright)
  - [ ] Тест: авторизация → переход в профиль → редактирование → сохранение
  - [ ] Проверка отображения toast уведомления
  - [ ] Проверка B2B полей для B2B пользователя

## Dev Notes

### Existing Files (Critical Integration Points)

**ВАЖНО:** Следующие файлы УЖЕ СУЩЕСТВУЮТ и должны использоваться как есть. НЕ создавайте их заново.

#### authStore.ts - СУЩЕСТВУЕТ ✅
**Путь:** `frontend/src/stores/authStore.ts`

**Фактическая структура:**
```typescript
interface AuthState {
  accessToken: string | null;
  user: User | null;
  isAuthenticated: boolean;

  // Methods
  setTokens: (access: string, refresh: string) => void;
  setUser: (user: User) => void;
  logout: () => Promise<void>;
  getRefreshToken: () => string | null;
}

// Селекторы для использования
export const authSelectors = {
  useIsAuthenticated: () => useAuthStore(state => state.isAuthenticated),
  useUser: () => useAuthStore(state => state.user),
  useIsB2BUser: () => boolean  // Проверяет B2B роли
};
```

**Использование:**
```typescript
import { useAuthStore, authSelectors } from '@/stores/authStore';

// Получить пользователя
const user = authSelectors.useUser();
const isB2B = authSelectors.useIsB2BUser();

// Обновить пользователя
const setUser = useAuthStore(state => state.setUser);
setUser(updatedUser);
```

#### Toast Component - СУЩЕСТВУЕТ ✅
**Путь:** `frontend/src/components/ui/Toast/`

**Файлы:**
- `Toast.tsx` - компонент
- `ToastProvider.tsx` - провайдер и useToast хук
- `__tests__/Toast.test.tsx` - тесты

**Использование:**
```typescript
import { useToast } from '@/components/ui/Toast/ToastProvider';

const { success, error } = useToast();

// Success
success('Профиль успешно обновлён');

// Error
error('Ошибка при сохранении профиля');
```

**КРИТИЧНО:** Toast уже полностью реализован согласно design-system.json. НЕ создавайте его заново.

#### middleware.ts - СУЩЕСТВУЕТ ✅
**Путь:** `frontend/src/middleware.ts`

**Текущая конфигурация:**
```typescript
function isProtectedRoute(pathname: string): boolean {
  const protectedPaths = ['/profile', '/orders', '/b2b-dashboard'];
  return protectedPaths.some(path => pathname.startsWith(path));
}
```

**Статус:** `/profile` УЖЕ защищён. Middleware автоматически редиректит неавторизованных на `/login?next=/profile`.

**НЕ ТРЕБУЕТСЯ:** Создание нового middleware или изменение существующего для этой story.

### Previous Story Insights
Нет предыдущих stories для Epic 16 - это первая story.

### API Specifications

**Endpoints:** [Source: docs/architecture/03-api-specification.md]

`GET /api/v1/users/profile/`
- Аутентификация: JWT Bearer Token (обязательна)
- Response 200: User объект (см. Data Models ниже)
- Response 401: Unauthorized

`PUT /api/v1/users/profile/`
- Аутентификация: JWT Bearer Token (обязательна)
- Request Body: Partial User объект с обновляемыми полями
- Response 200: Обновлённый User объект
- Response 400: Validation errors
- Response 401: Unauthorized

### Data Models

**User Model:** [Source: docs/architecture/02-data-models.md]

```typescript
interface User {
  id: number;
  email: string;           // PRIMARY IDENTIFIER, USERNAME_FIELD
  first_name: string;
  last_name: string;
  phone: string;           // Формат: +79001234567

  // B2B поля
  company_name?: string;   // Для B2B ролей
  tax_id?: string;         // ИНН (10 или 12 цифр)

  // Роль и верификация
  role: 'retail' | 'wholesale_level1' | 'wholesale_level2' | 'wholesale_level3'
        | 'trainer' | 'federation_rep' | 'admin';
  is_verified: boolean;
  verification_status: 'unverified' | 'verified' | 'pending';

  // Timestamps
  created_at: string;      // ISO datetime
  updated_at: string;      // ISO datetime
}
```

**Роли пользователей:** [Source: docs/architecture/02-data-models.md#user-model]
- `retail`: B2C розничный покупатель
- `wholesale_level1`, `wholesale_level2`, `wholesale_level3`: B2B оптовики (разные уровни цен)
- `trainer`: Тренер/фитнес-клуб
- `federation_rep`: Представитель федерации
- `admin`: Администратор

**B2B Пользователи определяются как:** `['wholesale_level1', 'wholesale_level2', 'wholesale_level3', 'trainer', 'federation_rep']`

### Component Specifications

**ProfileLayout Component:** [Source: docs/architecture/04-component-structure.md]

Файл: `frontend/src/components/layout/ProfileLayout.tsx`

```typescript
interface ProfileLayoutProps {
  children: React.ReactNode;
}

const ProfileLayout: React.FC<ProfileLayoutProps> = ({ children }) => {
  // Desktop: боковая навигация (280px)
  // Mobile: Tabs с scroll-snap
  // Использовать компонент Tabs из design-system
}
```

**Navigation Items:**
```typescript
const navigationItems = [
  { label: 'Профиль', href: '/profile', icon: 'User' },
  { label: 'Заказы', href: '/profile/orders', icon: 'ShoppingBag' },
  { label: 'Адреса', href: '/profile/addresses', icon: 'MapPin' },
  { label: 'Избранное', href: '/profile/favorites', icon: 'Heart' }
];
```

**ProfileForm Component:** [Source: design-system.json]

Использовать компоненты из Design System:
- `Input` для текстовых полей (height: 40px, radius: 6px)
- `Button` primary для сохранения (bg: #0060FF, hover: #0047CC)
- `Badge` для verification_status (success: зелёный, warning: жёлтый)
- `Toast` для уведомлений (success/error варианты)

### File Locations

**Новые файлы:** [Source: docs/architecture/source-tree.md]

```
frontend/src/
├── app/
│   └── (profile)/                    # Route group для защищённых маршрутов
│       ├── layout.tsx                # ProfileLayout с навигацией
│       └── profile/
│           ├── page.tsx              # Страница профиля
│           └── __tests__/
│               └── page.test.tsx     # Unit тесты
├── components/
│   ├── layout/
│   │   ├── ProfileLayout.tsx         # Layout компонент (СОЗДАТЬ)
│   │   └── ProfileLayout.test.tsx    # Тесты layout (СОЗДАТЬ)
│   ├── business/
│   │   ├── ProfileForm/
│   │   │   ├── ProfileForm.tsx       # Форма профиля (СОЗДАТЬ)
│   │   │   ├── ProfileForm.test.tsx  # Тесты формы (СОЗДАТЬ)
│   │   │   └── schema.ts             # Zod validation schema (СОЗДАТЬ)
│   └── ui/
│       └── Toast/                    # ✅ УЖЕ СУЩЕСТВУЕТ - использовать как есть
│           ├── Toast.tsx
│           ├── ToastProvider.tsx
│           └── __tests__/Toast.test.tsx
├── middleware.ts                     # ✅ УЖЕ СУЩЕСТВУЕТ - /profile уже защищён
├── stores/
│   └── authStore.ts                  # Zustand store (уже существует)
└── __mocks__/
    └── handlers.ts                   # MSW handlers для API mocking
```

### Testing Requirements

**Framework:** [Source: docs/architecture/10-testing-strategy.md]

- **Vitest 2.1.5** - тестовый раннер
- **@testing-library/react 16.3.0** - тестирование React компонентов
- **@testing-library/user-event 14.5.1** - симуляция действий пользователя
- **MSW 2.12.2** - мокирование API запросов
- **@vitest/coverage-v8 2.1.5** - отчёты о покрытии

**Структура тестов:** [Source: docs/architecture/10-testing-strategy.md#frontend-tests]

Тесты располагаются рядом с компонентами:
```
component.tsx
component.test.tsx
```

**AAA Pattern (обязательная структура):**
```typescript
describe('ProfileForm', () => {
  it('loads current user data on mount', async () => {
    // ARRANGE - подготовка данных
    const mockUser = { ... };
    server.use(
      rest.get('/api/v1/users/profile/', (req, res, ctx) =>
        res(ctx.json(mockUser))
      )
    );

    // ACT - выполнение действия
    render(<ProfileForm />);

    // ASSERT - проверка результата
    await waitFor(() => {
      expect(screen.getByDisplayValue('test@example.com')).toBeInTheDocument();
    });
  });
});
```

**Минимальные требования к покрытию:**
- Общее покрытие: >= 80%
- Критические компоненты (ProfileForm, ProfileLayout): >= 90%

**Команды тестирования:**
```bash
npm run test               # Запуск всех тестов
npm run test:watch         # Watch mode
npm run test:coverage      # С отчётом о покрытии
npm run test:ui            # UI интерфейс Vitest
```

### Technical Constraints

**Next.js App Router:** [Source: docs/architecture/tech-stack.md]
- Версия: 15.4.6
- Используется App Router (не Pages Router)
- SSR для первичной загрузки данных
- CSR для динамических обновлений

**State Management:** [Source: docs/architecture/tech-stack.md]
- Zustand 4.5.7 для глобального состояния
- `authStore` уже существует для аутентификации
- Структура store:
```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  checkAuth: () => Promise<boolean>;
  refreshToken: () => Promise<void>;
  logout: () => void;
}
```

**Form Validation:** [Source: docs/architecture/tech-stack.md]
- React Hook Form 7.62.0
- Zod для schema validation
- Пример schema:
```typescript
const profileSchema = z.object({
  email: z.string().email(),
  first_name: z.string().min(1),
  last_name: z.string().min(1),
  phone: z.string().regex(/^\+7\d{10}$/),
  company_name: z.string().optional(),
  tax_id: z.string().regex(/^\d{10}$|^\d{12}$/).optional(),
});
```

**Styling:** [Source: docs/architecture/tech-stack.md]
- Tailwind CSS 4.0
- Design tokens из design-system.json
- Mobile-first responsive дизайн
- Breakpoints: mobile (640px), tablet (1024px), desktop (1440px)

**Axios Configuration:** [Source: docs/architecture/coding-standards.md]
- Axios 1.11.0 для API запросов
- Interceptors для автоматической обработки JWT токенов
- Timeout: 10 секунд
- Base URL: `/api/v1/`

### Project Structure Notes

**Middleware для Next.js:** [Source: frontend/src/middleware.ts - проверено 2025-12-15]

✅ **Middleware УЖЕ СУЩЕСТВУЕТ** в `frontend/src/middleware.ts`

**Текущая реализация:**
- Защищает маршруты: `/profile`, `/orders`, `/b2b-dashboard`
- Проверяет `refreshToken` из cookies (НЕ localStorage, так как Edge Runtime)
- Автоматически редиректит на `/login?next=/profile` при отсутствии токена
- **НЕ ТРЕБУЕТСЯ:** Создание или изменение middleware для этой story

**Как работает защита:**
```typescript
function isProtectedRoute(pathname: string): boolean {
  const protectedPaths = ['/profile', '/orders', '/b2b-dashboard'];
  return protectedPaths.some(path => pathname.startsWith(path));
}
```

Маршрут `/profile/*` УЖЕ защищён.

**authStore интеграция:** [Source: frontend/src/stores/authStore.ts - проверено 2025-12-15]

Store существует в `frontend/src/stores/authStore.ts`. Использовать ФАКТИЧЕСКИЕ методы и селекторы:

**Селекторы (рекомендуемый способ):**
```typescript
import { authSelectors } from '@/stores/authStore';

const user = authSelectors.useUser();              // Получить user
const isAuthenticated = authSelectors.useIsAuthenticated();  // Проверить auth
const isB2B = authSelectors.useIsB2BUser();         // Проверить B2B роль
```

**Прямой доступ к store:**
```typescript
import { useAuthStore } from '@/stores/authStore';

const setUser = useAuthStore(state => state.setUser);
const logout = useAuthStore(state => state.logout);
const getRefreshToken = useAuthStore(state => state.getRefreshToken);
```

**ВАЖНО:** Методов `checkAuth()` и `refreshToken()` НЕ существует в authStore.

### Design System Tokens

**Из `design-system.json`:** [Source: docs/frontend/design-system.json]

**Colors:**
```javascript
primary: {
  default: '#0060FF',
  hover: '#0047CC',
  active: '#0037A6',
  subtle: '#E7F3FF'
}

accent: {
  success: '#00AA5B',
  successBg: '#E0F5E8',
  warning: '#F5A623',
  warningBg: '#FFF1CC',
  danger: '#E53935',
  dangerBg: '#FFE1E8'
}

neutral: {
  100: '#FFFFFF',
  200: '#F5F7FB',
  400: '#B9C3D6',
  700: '#4B5C7A',
  900: '#1F2A44'
}
```

**Typography:**
```javascript
body-m: { size: 16px, lineHeight: 24px, weight: 500 }
body-s: { size: 14px, lineHeight: 20px, weight: 500 }
title-m: { size: 20px, lineHeight: 28px, weight: 600 }
```

**Component Specs:**

Input:
- Height: 40px
- Radius: 6px
- Border: 1px solid #B9C3D6
- Error state: border-accent-danger

Button Primary:
- Background: #0060FF
- Hover: #0047CC
- Height: 40px
- Radius: 6px
- Padding: 24px horizontal

Toast:
- Success: bg #E0F5E8, border #00AA5B, icon CheckCircle
- Error: bg #FFE1E8, border #E53935, icon XCircle
- Radius: 12px
- Shadow: 0 8px 24px rgba(15, 23, 42, 0.12)
- Auto-dismiss: 5000ms

Badge (verification_status):
- Verified: bg #E0F5E8, text #00AA5B
- Pending: bg #FFF1CC, text #F5A623
- Unverified: bg neutral-200, text neutral-700

### Security Considerations

**JWT Handling:** [Source: docs/architecture/11-security-performance.md]

- Токены хранятся в httpOnly cookies (предпочтительно) или localStorage
- Автоматический refresh при истечении через interceptor
- Logout должен очищать токены и перенаправлять на /login

**CSRF Protection:** [Source: docs/architecture/11-security-performance.md]

- Next.js автоматически добавляет CSRF токены
- Axios interceptors должны включать CSRF токен в PUT запросы

**Input Validation:** [Source: docs/architecture/coding-standards.md]

- Валидация на клиенте через Zod
- Валидация на сервере через DRF serializers
- Sanitization пользовательского ввода

### Performance Considerations

**SSR для первичной загрузки:** [Source: docs/architecture/tech-stack.md]

Next.js App Router:
- Использовать Server Components где возможно
- Fetch данных профиля на сервере при первичном рендере
- CSR только для интерактивных обновлений

**Optimistic UI:** [Source: Epic 16 handoff]

При сохранении формы профиля:
- Показывать loading состояние кнопки
- После успешного PUT обновить `authStore` локально
- Только потом показать toast

**Кэширование:** [Source: docs/architecture/tech-stack.md]

- Next.js ISR не применяется к защищённым маршрутам
- Данные профиля кэшируются в `authStore`
- Инвалидация кэша при logout

## Testing

### Testing Standards

[Source: docs/architecture/10-testing-strategy.md]

**Test File Location:**
- Component tests: рядом с компонентом (`component.test.tsx`)
- Page tests: в `__tests__` директории (`app/profile/__tests__/page.test.tsx`)

**Test Frameworks:**
- Vitest 2.1.5 (test runner)
- React Testing Library 16.3.0 (component testing)
- MSW 2.12.2 (API mocking)
- @vitest/coverage-v8 2.1.5 (coverage reports)

**Test Patterns:**
- AAA Pattern (Arrange, Act, Assert)
- Meaningful test names: `test_[action]_[expected_result]()`
- Mock external dependencies (API calls via MSW)

**Coverage Requirements:**
- Overall: >= 80%
- Critical components (ProfileForm, ProfileLayout): >= 90%

**Commands:**
```bash
npm run test               # Run all tests
npm run test:watch         # Watch mode
npm run test:coverage      # With coverage report
npm run test:ui            # Vitest UI interface
```

**Example Test Structure:**
```typescript
describe('ProfileForm', () => {
  beforeEach(() => {
    // Setup MSW handlers
    server.use(
      rest.get('/api/v1/users/profile/', (req, res, ctx) => {
        return res(ctx.json(mockUser));
      })
    );
  });

  it('loads and displays current user data', async () => {
    // ARRANGE
    const mockUser = {
      id: 1,
      email: 'test@example.com',
      first_name: 'Test',
      last_name: 'User',
      phone: '+79001234567',
      role: 'retail'
    };

    // ACT
    render(<ProfileForm />);

    // ASSERT
    await waitFor(() => {
      expect(screen.getByDisplayValue('test@example.com')).toBeInTheDocument();
      expect(screen.getByDisplayValue('Test')).toBeInTheDocument();
    });
  });
});
```

## Change Log

| Date       | Version | Description                              | Author          |
|------------|---------|------------------------------------------|-----------------|
| 2025-12-15 | 1.0     | Initial story creation from Epic 16.1    | Bob (SM Agent)  |
| 2025-12-15 | 1.1     | Validation & update: verified existing files (authStore, Toast, middleware), corrected integration points, added Existing Files section | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

## QA Results
*To be filled by QA Agent*
