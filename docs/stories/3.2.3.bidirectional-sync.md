# Story 3.2.3: bidirectional-sync

## Status
Ready for Development

## Story
**As a** новый клиент,
**I want** чтобы моя регистрация на сайте автоматически попадала в 1С,
**so that** я получаю персональные условия и специальные цены.

## Acceptance Criteria

1. Создана команда `sync_customers_with_1c` для полной синхронизации
2. При регистрации устанавливается `needs_1c_export=True`
3. Реализован сервис `export_customer_to_1c()` для отправки данных
4. После успешного экспорта устанавливается `onec_id` от 1С
5. Поддержана синхронизация изменений профиля
6. Реализован класс `CustomerDataMapper` для преобразования форматов
7. Настроена обработка ошибок экспорта с retry механизмом

### Детальные задачи:

- [ ] Создать команду полной синхронизации (AC: 1)
  - [ ] Команда `sync_customers_with_1c` в `apps/users/management/commands/`
  - [ ] Параметры: --direction (import/export/both), --chunk-size
  - [ ] Интеграция с Celery для асинхронного выполнения
  - [ ] Мониторинг прогресса и возможность прерывания

- [ ] Настроить флаг экспорта при регистрации (AC: 2)
  - [ ] Модификация User model signal `post_save`
  - [ ] Установка `needs_1c_export=True` для новых пользователей
  - [ ] Исключение пользователей, созданных из 1С (`created_in_1c=True`)
  - [ ] Очередь экспорта с приоритизацией

- [ ] Реализовать сервис экспорта (AC: 3)
  - [ ] Класс `CustomerExportService` в `apps/users/services/`
  - [ ] Метод `export_customer_to_1c(customer)`
  - [ ] Поддержка различных форматов: XML, JSON, HTTP API
  - [ ] Валидация данных перед экспортом

- [ ] Обработать ответ от 1С (AC: 4)
  - [ ] Парсинг ответа с `onec_id`
  - [ ] Обновление статуса `sync_status = 'synced'`
  - [ ] Сброс флага `needs_1c_export = False`
  - [ ] Установка `last_sync_at = timezone.now()`

- [ ] Синхронизировать изменения профиля (AC: 5)
  - [ ] Signal `post_save` для отслеживания изменений
  - [ ] Определение значимых полей для синхронизации
  - [ ] Batch обновления для производительности
  - [ ] Деactivация экспорта для незначительных изменений

- [ ] Создать маппер данных (AC: 6)
  - [ ] Класс `CustomerDataMapper` 
  - [ ] Метод `map_platform_to_1c(customer)` 
  - [ ] Метод `map_1c_to_platform(customer_data)`
  - [ ] Обработка различий в форматах дат, телефонов
  - [ ] Поддержка кастомных полей для разных внедрений 1С

- [ ] Настроить retry и error handling (AC: 7)
  - [ ] Exponential backoff для retry попыток
  - [ ] Максимальное количество попыток (3-5)
  - [ ] Сохранение ошибок в `sync_error_message`
  - [ ] Dead letter queue для критических ошибок

## Definition of Done
- [ ] Новые регистрации попадают в 1С в течение 15 минут
- [ ] Изменения профиля синхронизируются автоматически
- [ ] Ошибки экспорта не блокируют работу платформы
- [ ] Success rate синхронизации >95%
- [ ] Созданы monitoring dashboards

## Dev Notes

### Story Context
**Bidirectional Sync Flow:**
1. **Platform → 1C:** Новые регистрации и изменения профилей
2. **1C → Platform:** Обновления статуса клиента, изменения ролей
3. **Conflict Resolution:** Автоматическое разрешение конфликтов данных

### CustomerExportService Architecture
```python
class CustomerExportService:
    """Сервис экспорта клиентов в 1С"""
    
    def export_customer_to_1c(self, customer):
        """Экспорт клиента с платформы в 1С"""
        try:
            # Подготовка данных для экспорта  
            export_data = self.prepare_export_data(customer)
            
            # Отправка в 1С
            response = self.send_to_1c(export_data)
            
            # Обработка ответа
            if response.success:
                self.handle_successful_export(customer, response)
            else:
                self.handle_export_error(customer, response)
                
        except Exception as e:
            self.handle_export_exception(customer, e)
    
    def prepare_export_data(self, customer):
        """Подготовка данных клиента для экспорта"""
        mapper = CustomerDataMapper()
        return mapper.map_platform_to_1c(customer)
    
    def handle_successful_export(self, customer, response):
        """Обработка успешного экспорта"""
        customer.onec_id = response.onec_id
        customer.sync_status = 'synced'
        customer.needs_1c_export = False
        customer.last_sync_at = timezone.now()
        customer.sync_error_message = ''
        customer.save()
        
        # Логирование успеха
        CustomerSyncLog.objects.create(
            operation_type='export_to_1c',
            customer=customer,
            status='success',
            details={'onec_id': response.onec_id}
        )
```

### Data Mapping Examples
```python
class CustomerDataMapper:
    """Маппинг данных между форматами платформы и 1С"""
    
    def map_platform_to_1c(self, customer):
        """Преобразование данных клиента в формат 1С"""
        customer_type = 'individual' if not customer.company_name else 'legal_entity'
        
        base_data = {
            'platform_id': customer.id,
            'email': customer.email,
            'phone': self.normalize_phone(customer.phone),
            'customer_type': customer_type,
            'role': self.map_platform_role_to_1c(customer.role),
        }
        
        if customer_type == 'individual':
            base_data.update({
                'first_name': customer.first_name,
                'last_name': customer.last_name,
            })
        else:
            base_data.update({
                'company_name': customer.company_name,
                'tax_id': customer.tax_id,
                'contact_person': f"{customer.first_name} {customer.last_name}",
            })
        
        return base_data
    
    def map_1c_to_platform(self, onec_data):
        """Преобразование данных из 1С в формат платформы"""
        return {
            'email': onec_data.get('email'),
            'first_name': onec_data.get('first_name'),
            'last_name': onec_data.get('last_name'),
            'phone': onec_data.get('phone'),
            'company_name': onec_data.get('company_name'),
            'tax_id': onec_data.get('tax_id'),
            'role': self.map_1c_role_to_platform(onec_data.get('customer_type')),
            'onec_id': onec_data.get('id'),
            'created_in_1c': True,
            'sync_status': 'synced',
        }
```

### Celery Task Integration
```python
@celery_app.task(bind=True, max_retries=3)
def export_customer_task(self, customer_id):
    """Асинхронный экспорт клиента в 1С"""
    try:
        customer = User.objects.get(id=customer_id)
        export_service = CustomerExportService()
        export_service.export_customer_to_1c(customer)
    except User.DoesNotExist:
        logger.error(f"Customer {customer_id} not found for export")
    except Exception as exc:
        logger.error(f"Export failed for customer {customer_id}: {exc}")
        # Retry with exponential backoff
        raise self.retry(exc=exc, countdown=60 * (2 ** self.request.retries))

# Trigger export on user registration
@receiver(post_save, sender=User)
def trigger_customer_export(sender, instance, created, **kwargs):
    """Триггер экспорта при создании/изменении пользователя"""
    if instance.needs_1c_export and not instance.created_in_1c:
        export_customer_task.delay(instance.id)
```

### Monitoring & Metrics
```python
# Метрики для мониторинга синхронизации
SYNC_METRICS = {
    'customers_exported_today': lambda: get_customers_exported_today(),
    'export_success_rate': lambda: calculate_export_success_rate(),
    'pending_exports_count': lambda: get_pending_exports_count(),
    'avg_sync_time': lambda: get_average_sync_time(),
}
```

### Dependencies
- **Depends on:** Story 3.2.1, 3.2.2 (import and conflicts)
- **Integrates with:** Celery, 1C API, monitoring system
- **Related:** Real-time sync, webhook handlers

## Story Points
**8** (High complexity due to bidirectional sync and API integration)

## Priority
**High** - Ключевая функциональность для B2B клиентов

## Labels
`epic-3` `bidirectional-sync` `1c-integration` `celery` `api-integration`