# Story 3.2.3: bidirectional-sync

## Status

Blocked

## Story

> **Примечание Architect (22.09.2025):** Реализация заблокирована до получения спецификации API для экспорта данных в 1С. Начать работу после предоставления спецификации.

**As a** новый клиент,
**I want** чтобы моя регистрация на сайте автоматически попадала в 1С,
**so that** я получаю персональные условия и специальные цены.

## Acceptance Criteria

1. Создана команда `sync_customers` для полной двусторонней синхронизации.
2. Новые регистрации и изменения профиля автоматически отправляются на экспорт в 1С.
3. Реализован сервис `export_customer_to_1c`, который обрабатывает ответ от 1С и обновляет данные клиента.
4. Создан `CustomerDataMapper` для преобразования данных между платформой и 1С.
5. Настроена обработка ошибок экспорта с механизмом повторных попыток (retry).

### Детальные задачи

- [ ] **Создать команду полной синхронизации `sync_customers` (AC: 1)**
  - [ ] Расположить в `apps/users/management/commands/`.
  - [ ] Реализовать параметры: `--direction` (import/export/both), `--chunk-size`.
  - [ ] Команда должна оркестрировать вызов `CustomerDataProcessor` для импорта и экспорта.
  - [ ] Интегрировать с Celery для выполнения тяжелых операций в фоне.

- [ ] **Настроить флаг экспорта при регистрации (AC: 2)**
  - [ ] Использовать сигнал `post_save` для модели `User`.
  - [ ] При создании нового пользователя (если `created=True` и `created_in_1c=False`) устанавливать флаг `needs_1c_export=True`.
  - [ ] Сигнал должен ставить асинхронную задачу в Celery для экспорта, а не выполнять его напрямую.

- [ ] **Реализовать логику экспорта в `CustomerDataProcessor` (AC: 3)**
  - [ ] Добавить метод `export_customer(customer)` в `CustomerDataProcessor`.
  - [ ] Этот метод должен использовать `CustomerDataMapper` для преобразования данных.
  - [ ] Реализовать отправку данных во внешнюю систему (1С).
  - [ ] Проводить валидацию данных перед экспортом.

- [ ] **Обработать ответ от 1С (AC: 3)**
  - [ ] Парсинг ответа с `onec_id`
  - [ ] Обновление статуса `sync_status = 'synced'`
  - [ ] Сброс флага `needs_1c_export = False`
  - [ ] Установка `last_sync_at = timezone.now()`

- [ ] **Синхронизировать изменения профиля (AC: 2)**
  - [ ] Signal `post_save` для отслеживания изменений
  - [ ] Определение значимых полей для синхронизации
  - [ ] Batch обновления для производительности
  - [ ] Деactivация экспорта для незначительных изменений

- [ ] **Создать `CustomerDataMapper` (AC: 4)**
  - [ ] Расположить класс в `apps/users/services/`.
  - [ ] Реализовать метод `map_platform_to_1c(customer)`.
  - [ ] Реализовать метод `map_1c_to_platform(customer_data)`.
  - [ ] Добавить логику нормализации данных (например, форматы дат и телефонов).

- [ ] **Настроить retry и error handling (AC: 5)**
  - [ ] Exponential backoff для retry попыток
  - [ ] Максимальное количество попыток (3-5)
  - [ ] Сохранение ошибок в `sync_error_message`

## Definition of Done

- [ ] Новые регистрации попадают в 1С в течение 15 минут
- [ ] Изменения профиля синхронизируются автоматически
- [ ] Ошибки экспорта не блокируют работу платформы
- [ ] Success rate синхронизации >95%
- [ ] Созданы monitoring dashboards

## Dev Notes

### Story Context

**Bidirectional Sync Flow:**

1. **Platform → 1C:** Новые регистрации и изменения профилей
2. **1C → Platform:** Обновления статуса клиента, изменения ролей
3. **Conflict Resolution:** Автоматическое разрешение конфликтов данных

### CustomerExportService Architecture

```python
class CustomerExportService:
    """Сервис экспорта клиентов в 1С"""
    
    def export_customer_to_1c(self, customer):
        """Экспорт клиента с платформы в 1С"""
        try:
            # Подготовка данных для экспорта
            export_data = self.prepare_export_data(customer)
            
            # Отправка в 1С
            response = self.send_to_1c(export_data)
            
            # Обработка ответа
            if response.success:
                self.handle_successful_export(customer, response)
            else:
                self.handle_export_error(customer, response)
                
        except Exception as e:
            self.handle_export_exception(customer, e)
    
    def prepare_export_data(self, customer):
        """Подготовка данных клиента для экспорта"""
        mapper = CustomerDataMapper()
        return mapper.map_platform_to_1c(customer)
    
    def handle_successful_export(self, customer, response):
        """Обработка успешного экспорта"""
        customer.onec_id = response.onec_id
        customer.sync_status = 'synced'
        customer.needs_1c_export = False
        customer.last_sync_at = timezone.now()
        customer.sync_error_message = ''
        customer.save()
        
        # Логирование успеха
        CustomerSyncLog.objects.create(
            operation_type='export_to_1c',
            customer=customer,
            status='success',
            details={'onec_id': response.onec_id}
        )
```

### Data Mapping Examples

```python
class CustomerDataMapper:
    """Маппинг данных между форматами платформы и 1С"""
    
    def map_platform_to_1c(self, customer):
        """Преобразование данных клиента в формат 1С"""
        customer_type = 'individual' if not customer.company_name else 'legal_entity'
        
        base_data = {
            'platform_id': customer.id,
            'email': customer.email,
            'phone': self.normalize_phone(customer.phone),
            'customer_type': customer_type,
            'role': self.map_platform_role_to_1c(customer.role),
        }
        
        if customer_type == 'individual':
            base_data.update({
                'first_name': customer.first_name,
                'last_name': customer.last_name,
            })
        else:
            base_data.update({
                'company_name': customer.company_name,
                'tax_id': customer.tax_id,
                'contact_person': f"{customer.first_name} {customer.last_name}",
            })
        
        return base_data
    
    def map_1c_to_platform(self, onec_data):
        """Преобразование данных из 1С в формат платформы"""
        return {
            'email': onec_data.get('email'),
            'first_name': onec_data.get('first_name'),
            'last_name': onec_data.get('last_name'),
            'phone': onec_data.get('phone'),
            'company_name': onec_data.get('company_name'),
            'tax_id': onec_data.get('tax_id'),
            'role': self.map_1c_role_to_platform(onec_data.get('customer_type')),
            'onec_id': onec_data.get('id'),
            'created_in_1c': True,
            'sync_status': 'synced',
        }
```

### Celery Task Integration

```python
@celery_app.task(bind=True, max_retries=3)
def export_customer_task(self, customer_id):
    """Асинхронный экспорт клиента в 1С"""
    try:
        customer = User.objects.get(id=customer_id)
        export_service = CustomerExportService()
        export_service.export_customer_to_1c(customer)
    except User.DoesNotExist:
        logger.error(f"Customer {customer_id} not found for export")
    except Exception as exc:
        logger.error(f"Export failed for customer {customer_id}: {exc}")
        # Retry with exponential backoff
        raise self.retry(exc=exc, countdown=60 * (2 ** self.request.retries))

# Trigger export on user registration
@receiver(post_save, sender=User)
def trigger_customer_export(sender, instance, created, **kwargs):
    """Триггер экспорта при создании/изменении пользователя"""
    if instance.needs_1c_export and not instance.created_in_1c:
        export_customer_task.delay(instance.id)
```

### Monitoring & Metrics

```python
# Метрики для мониторинга синхронизации
SYNC_METRICS = {
    'customers_exported_today': lambda: get_customers_exported_today(),
    'export_success_rate': lambda: calculate_export_success_rate(),
    'pending_exports_count': lambda: get_pending_exports_count(),
    'avg_sync_time': lambda: get_average_sync_time(),
}
```

### Dependencies

- **Depends on:** Story 3.2.1, 3.2.2 (import and conflicts)
- **Integrates with:** Celery, 1C API, monitoring system
- **Related:** Real-time sync, webhook handlers

## Story Points

**8** (High complexity due to bidirectional sync and API integration)

## Priority

**High** - Ключевая функциональность для B2B клиентов

## Labels

`epic-3` `bidirectional-sync` `1c-integration` `celery` `api-integration`
