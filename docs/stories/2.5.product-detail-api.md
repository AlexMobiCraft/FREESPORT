# Story 2.5: product-detail-api

## Status
Ready for Review

## Story
**As a** покупатель,
**I want** видеть детальную информацию о товаре с ролевыми ценами,
**so that** принять решение о покупке.

## Acceptance Criteria

1. GET `/products/{id}/` возвращает полную информацию о товаре
2. RRP/MSRP отображается для B2B пользователей
3. Галерея изображений включена в ответ
4. Связанные товары добавлены в response
5. Спецификации и детали товара отображаются корректно

- [x] Создать Product Detail API (AC: 1)
  - [x] Создать ProductDetailSerializer с расширенными полями
  - [x] Реализовать GET /products/{id}/ endpoint
  - [x] Добавить specifications поле (использую существующее description)
  - [x] Включить все данные о товаре в один запрос
  - [x] Обработать 404 для несуществующих товаров

- [x] Ролевое ценообразование (AC: 2)
  - [x] Отображать current_price на основе роли пользователя
  - [x] Показывать RRP/MSRP для B2B пользователей
  - [x] Скрывать оптовые цены от retail покупателей
  - [x] Добавить поле discount_percent если есть скидка
  - [x] Валидировать доступ к ценам по ролям

- [x] Галерея изображений (AC: 3)
  - [x] Создать ProductImageSerializer
  - [x] Включить main_image и gallery_images в response
  - [x] Добавить alt_text и is_primary поля
  - [x] Оптимизировать загрузку изображений
  - [x] Обработать отсутствующие изображения

- [x] Связанные товары (AC: 4)
  - [x] Добавить related_products в serializer
  - [x] Фильтровать по категории или бренду
  - [x] Ограничить количество связанных товаров (5)
  - [x] Исключить текущий товар из списка
  - [x] Применить ролевое ценообразование к связанным

- [x] Спецификации и детали (AC: 5)
  - [x] Отобразить specifications JSON field
  - [x] Добавить информацию о наличии и минимальном заказе
  - [x] Включить SEO метаданные
  - [x] Добавить информацию о бренде и категории

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: Product model, ProductImage, related products
- Технология: DRF DetailView с расширенным serializer
- Следует паттерну: Django related field lookups
- Точки касания: Product detail view, image gallery, recommendations

### Technical Notes
- **Integration Approach:** Расширенный ProductSerializer с nested relationships
- **Existing Pattern Reference:** DRF nested serialization для related fields
- **Key Constraints:** Избежать N+1 queries для связанных данных

### ProductDetailSerializer Structure
```python
class ProductDetailSerializer(serializers.ModelSerializer):
    current_price = serializers.SerializerMethodField()
    images = ProductImageSerializer(many=True, read_only=True)
    related_products = serializers.SerializerMethodField()
    category_breadcrumbs = serializers.SerializerMethodField()
    
    class Meta:
        model = Product
        fields = [
            'id', 'name', 'slug', 'sku', 'description', 'full_description',
            'brand', 'category', 'current_price', 'specifications',
            'stock_quantity', 'min_order_quantity', 'images',
            'related_products', 'category_breadcrumbs', 'is_available'
        ]
```

### B2B Price Display Logic
```python
def get_price_info(self, obj):
    user = self.context['request'].user
    price_info = {
        'current': self.get_current_price(obj),
        'currency': 'RUB'
    }
    
    # Добавляем RRP/MSRP для B2B пользователей
    if user.is_authenticated and user.role != 'retail':
        if obj.recommended_retail_price:
            price_info['rrp'] = obj.recommended_retail_price
        if obj.max_suggested_retail_price:
            price_info['msrp'] = obj.max_suggested_retail_price
    
    return price_info
```

### Testing
- Unit тесты для Product detail endpoint
- Тестирование ролевого ценообразования
- Проверка nested serialization для images
- Валидация related products логики
- Performance тесты для query optimization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial brownfield story creation | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- Исправлена логика расчета скидки от retail_price вместо RRP
- Унифицирован формат цен с 2 десятичными знаками
- Убрано избыточное поле is_in_stock из API response

### Completion Notes List
- Добавлено поле specifications в модель Product
- Создан ProductDetailSerializer с расширенными полями
- Реализованы images, related_products, category_breadcrumbs, discount_percent
- Все тесты проходят успешно
- RRP/MSRP отображаются только для B2B пользователей

### File List
- backend/apps/products/models.py - добавлено поле specifications
- backend/apps/products/serializers.py - создан ProductDetailSerializer
- backend/apps/products/tests.py - добавлены тесты для Product Detail API
- backend/apps/products/migrations/0005_product_specifications.py - миграция

## QA Results
_TBD - будет заполнено QA агентом_