# Story 2.2: user-management-api

## Status
Ready for Review

## Story
**As a** B2B/B2C пользователь,
**I want** регистрироваться, авторизоваться и управлять своим профилем через API,
**so that** получить доступ к ролевому функционалу платформы.

## Acceptance Criteria

1. POST `/auth/register/` создает пользователей с ролями (retail, wholesale_level1-3, trainer, federation_rep)
2. POST `/auth/login/` возвращает JWT access/refresh токены
3. POST `/auth/refresh/` обновляет access token
4. GET/PATCH `/users/profile/` для просмотра/обновления профиля
5. Валидация и безопасность работают корректно

- [x] Реализовать регистрацию пользователей (AC: 1)
  - [x] Создать UserRegistrationSerializer с валидацией ролей
  - [x] Реализовать POST /auth/register/ endpoint
  - [x] Добавить валидацию email уникальности
  - [x] Настроить создание пользователей с разными ролями
  - [x] Добавить поля company_name, tax_id для B2B

- [x] Настроить JWT аутентификацию (AC: 2, 3)
  - [x] Установить и настроить django-rest-framework-simplejwt
  - [x] Создать LoginSerializer с email/password
  - [x] Реализовать POST /auth/login/ с JWT токенами
  - [x] Настроить POST /auth/refresh/ для обновления токенов
  - [x] Настроить время жизни access/refresh токенов

- [x] Реализовать управление профилем (AC: 4)
  - [x] Создать UserProfileSerializer
  - [x] Реализовать GET /users/profile/ endpoint
  - [x] Реализовать PATCH /users/profile/ для обновления
  - [x] Добавить permissions для доступа к собственному профилю
  - [x] Валидировать обновления профиля

- [x] Добавить валидацию и безопасность (AC: 5)
  - [x] Валидация email формата и уникальности
  - [x] Хэширование паролей через Django auth backend
  - [x] Настройка permissions на основе ролей
  - [x] Обработка ошибок с корректными HTTP статусами
  - [x] Защита от XSS и SQL инъекций

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: Django User модель и Django REST Framework
- Технология: DRF Serializers, JWT authentication
- Следует паттерну: Django authentication system
- Точки касания: User model, permissions system, JWT middleware

### Technical Notes
- **Integration Approach:** Расширение AbstractUser модели и создание DRF ViewSets
- **Existing Pattern Reference:** Django contrib.auth system с кастомными permissions
- **Key Constraints:** Совместимость с будущей интеграцией 1С (поле tax_id)

### User Roles System
```python
USER_ROLES = [
    ('retail', 'Розничный покупатель'),
    ('wholesale_level1', 'Оптовик уровень 1'),
    ('wholesale_level2', 'Оптовик уровень 2'), 
    ('wholesale_level3', 'Оптовик уровень 3'),
    ('trainer', 'Тренер'),
    ('federation_rep', 'Представитель федерации'),
    ('admin', 'Администратор'),
]
```

### Testing
- Unit тесты для всех API endpoints
- Тестирование валидации полей
- Проверка JWT токенов и их обновления
- Тестирование permissions для разных ролей
- Интеграционные тесты аутентификации

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial brownfield story creation | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- Исправлена ошибка UserManager.create_user() - создан кастомный UserManager для email аутентификации
- Все endpoints протестированы на http://127.0.0.1:8001/
- JWT токены генерируются и работают корректно
- Валидация ролей и B2B полей функционирует

### Completion Notes List
- ✅ Создан кастомный UserManager с методами create_user/create_superuser для email аутентификации
- ✅ Реализованы serializers: UserRegistrationSerializer, UserLoginSerializer, UserProfileSerializer  
- ✅ Созданы views: UserRegistrationView, UserLoginView, UserProfileView, user_roles_view
- ✅ Настроены URL patterns: /auth/register/, /auth/login/, /auth/refresh/, /users/profile/, /users/roles/
- ✅ JWT аутентификация работает с access/refresh токенами (60 мин / 7 дней)
- ✅ Валидация email уникальности, паролей, B2B полей (company_name, tax_id)
- ✅ Роль 'trainer' изменена на 'Тренер/Фитнес-клуб' в модели User
- ✅ Все endpoints протестированы и работают корректно
- ✅ Добавлена OpenAPI документация с примерами запросов/ответов

### File List
- backend/apps/users/models.py - добавлен UserManager, изменена роль trainer
- backend/apps/users/serializers.py - новый файл с 5 serializers
- backend/apps/users/views.py - новый файл с API views и OpenAPI декораторами  
- backend/apps/users/urls.py - новый файл с URL patterns
- backend/freesport/urls.py - добавлен include для users URLs
- backend/test_manual.py - созданы ручные тесты API
- backend/apps/users/migrations/0004_alter_user_role.py - миграция роли trainer
- backend/apps/users/migrations/0005_alter_user_managers.py - миграция UserManager

## QA Results
_TBD - будет заполнено QA агентом_