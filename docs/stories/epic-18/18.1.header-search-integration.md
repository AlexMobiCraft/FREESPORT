# Story 18.1: Интеграция поиска в Header

## Status

Done

## Story

**As a** пользователь,  
**I want** видеть поле поиска в шапке сайта,  
**so that** быстро находить товары с любой страницы.

## Acceptance Criteria

1. - [x] SearchField отображается в Header (desktop: inline, mobile: dropdown)
2. - [x] Ввод запроса показывает autocomplete dropdown с товарами
3. - [x] Клик по товару в dropdown → переход на страницу товара
4. - [x] Enter или клик по иконке → переход на `/search?q=...`
5. - [x] Поле поиска доступно при прокрутке (sticky header)

## Tasks / Subtasks

- [x] **Task 1: Интеграция SearchField в Header (Desktop)** (AC: 1, 5)
  - [x] 1.1. Заменить неактивную кнопку `<button aria-label="Поиск">` на компонент `SearchAutocomplete` в `Header.tsx` (строки 117-124)
  - [x] 1.2. Обеспечить корректное позиционирование SearchField в sticky header
  - [x] 1.3. Ограничить ширину поля поиска на desktop (max-width: 300px) для гармоничного UI

- [x] **Task 2: Создание SearchAutocomplete компонента** (AC: 2, 3, 4)
  - [x] 2.1. Создать `src/components/business/SearchAutocomplete/SearchAutocomplete.tsx`
  - [x] 2.2. Интегрировать `SearchField` из `src/components/ui/SearchField/SearchField.tsx`
  - [x] 2.3. Подключить `productsService.search()` для live-поиска товаров
  - [x] 2.4. Реализовать навигацию на страницу товара при клике (используя `next/navigation` → `router.push`)
  - [x] 2.5. Реализовать навигацию на `/search?q={query}` при Enter или клике по иконке
  - [x] 2.6. Создать файл индекса `src/components/business/SearchAutocomplete/index.ts` для экспорта

- [x] **Task 3: Интеграция SearchField в Header (Mobile)** (AC: 1)
  - [x] 3.1. Заменить неактивную кнопку поиска в мобильном меню (строки 225-230) на `SearchAutocomplete`
  - [x] 3.2. Обеспечить полноэкранный/dropdown режим поиска на мобильных устройствах
  - [x] 3.3. Закрывать мобильное меню после выбора результата поиска

- [x] **Task 4: Типизация** (AC: 1-5)
  - [x] 4.1. Добавить TypeScript интерфейс `SearchAutocompleteProps`
  - [x] 4.2. Убедиться что все props корректно типизированы

- [x] **Task 5: Unit-тесты** (AC: 1-5)
  - [x] 5.1. Создать `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx`
  - [x] 5.2. Тест: отображение SearchField в Header (desktop)
  - [x] 5.3. Тест: отображение SearchField в Header (mobile)
  - [x] 5.4. Тест: вызов `productsService.search()` при вводе (с MSW)
  - [x] 5.5. Тест: навигация на страницу товара при клике
  - [x] 5.6. Тест: навигация на `/search?q=...` при Enter
  - [x] 5.7. Тест: Header имеет sticky позиционирование (`sticky top-0` класс)
  - [x] 5.8. Обновить `Header.test.tsx` для проверки интеграции SearchAutocomplete

---

## Dev Notes

### Существующие компоненты для переиспользования

**SearchField** — `src/components/ui/SearchField/SearchField.tsx`
[Source: epic-18-search.md, docs/architecture/04-component-structure.md]

Готовый компонент с:

- `debounceMs` — debounce 300ms (по умолчанию)
- `minLength` — минимальная длина для поиска (по умолчанию 2)
- `suggestions` — массив строковых подсказок
- `products` — массив товаров `{ id, name, price }`
- `onSearch` — callback при изменении debounced значения
- Autocomplete dropdown с секциями "Подсказки" и "Товары"
- Clear button для очистки
- ARIA-атрибуты для accessibility (`role="listbox"`, `aria-label`)

**productsService.search()** — `src/services/productsService.ts`
[Source: epic-18-search.md]

```typescript
// Поиск товаров
ProductsService.search(query: string): Promise<{ results: Product[] }>
// GET /api/v1/products/search/?q={query}
```

### Header.tsx — Ключевые места для изменений

[Source: src/components/layout/Header.tsx]

**Desktop поиск (строки 119-124):**

```tsx
{/* Поиск */}
<button
  aria-label="Поиск"
  className="p-2 text-text-primary hover:text-text-secondary ..."
>
  <Search className="w-6 h-6" />
</button>
```

→ Заменить на `<SearchAutocomplete />`

**Mobile поиск (строки 225-230):**

```tsx
<button
  aria-label="Поиск"
  className="p-2 text-text-primary hover:text-text-secondary ..."
>
  <Search className="w-6 h-6" />
</button>
```

→ Заменить на `<SearchAutocomplete isMobile />`

### Архитектура компонента SearchAutocomplete

```
src/components/business/SearchAutocomplete/
├── SearchAutocomplete.tsx    # Основной компонент
├── index.ts                  # Экспорт
└── __tests__/
    └── SearchAutocomplete.test.tsx
```

### Интерфейс компонента

```typescript
interface SearchAutocompleteProps {
  className?: string;
  isMobile?: boolean;
  onNavigate?: () => void; // Callback для закрытия мобильного меню
}
```

### Логика навигации

1. **При клике на товар в dropdown:**

   ```typescript
   router.push(`/product/${product.slug}`);
   ```

2. **При Enter или клике по иконке поиска:**

   ```typescript
   // Обработчик клавиши Enter в SearchField
   const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
     if (e.key === 'Enter' && query.trim().length >= minLength) {
       router.push(`/search?q=${encodeURIComponent(query)}`);
       onNavigate?.(); // Закрыть мобильное меню если открыто
     }
   };
   ```

3. **Лимит товаров в dropdown (Performance):**

   ```typescript
   // Ограничить до 5 товаров для оптимизации
   const displayProducts = products.slice(0, 5);
   ```

### Требования к Performance

[Source: epic-18-search.md#requirements]

- Autocomplete < 300ms (debounce 300ms обеспечивает это)
- Лимит 5 товаров в dropdown для оптимизации

### Требования к Accessibility

[Source: epic-18-search.md#requirements, coding-standards.md]

- WCAG 2.1 AA
- Keyboard navigation (`Tab`, `Arrow Up/Down`, `Enter`, `Escape`)
- `aria-label` для всех интерактивных элементов
- `role="listbox"` для dropdown (уже реализовано в SearchField)

### Файловая структура проекта

[Source: docs/architecture/source-tree.md]

```
frontend/src/
├── components/
│   ├── business/           # Бизнес-компоненты
│   │   └── SearchAutocomplete/  # НОВЫЙ КОМПОНЕНТ
│   ├── layout/
│   │   └── Header.tsx      # МОДИФИКАЦИЯ
│   └── ui/
│       └── SearchField/    # СУЩЕСТВУЮЩИЙ
├── services/
│   └── productsService.ts  # СУЩЕСТВУЮЩИЙ API
└── hooks/
    └── useDebounce.ts      # СУЩЕСТВУЮЩИЙ
```

---

## Testing

### Файлы тестов

- `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx` — **НОВЫЙ**
- `src/components/layout/__tests__/Header.test.tsx` — **ОБНОВЛЕНИЕ**

### Технологический стек тестирования

[Source: docs/architecture/10-testing-strategy.md, docs/architecture/tech-stack.md]

- **Framework:** Vitest 2.1.5
- **Testing Library:** @testing-library/react 16.3.0
- **User Events:** @testing-library/user-event 14.5.1
- **API Mocking:** MSW 2.12.2
- **DOM Environment:** happy-dom 15.11.3
- **Accessibility:** vitest-axe

### Паттерны тестирования

[Source: coding-standards.md#frontend-testing]

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { http, HttpResponse } from 'msw';
import { setupServer } from 'msw/node';
```

### Команды для запуска тестов

```bash
# Запуск всех тестов frontend
cd frontend && npm run test

# Запуск конкретного теста
npm run test -- SearchAutocomplete

# Запуск тестов с покрытием
npm run test:coverage
```

### Требования к покрытию

[Source: docs/architecture/10-testing-strategy.md]

- Overall: >= 70%
- Новые компоненты: >= 80%

---

## Change Log

| Date       | Version | Description           | Author       |
|------------|---------|-----------------------|--------------|
| 2025-12-21 | 1.0     | Initial story draft   | Scrum Master |
| 2025-12-21 | 1.1     | PO Validation: исправлены номера строк, добавлен тест 5.7 для sticky header, добавлены примеры onKeyDown и products.slice(0, 5) | Product Owner |
| 2025-12-21 | 1.2     | Implementation complete: SearchAutocomplete component, Header integration, 14 unit tests | Dev Agent |
| 2025-12-21 | 1.3     | QA Future Recommendations: implemented loading skeleton and keyboard navigation (Arrow Up/Down), 6 new tests (total 20) | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Gemini Antigravity (2025-12-21)

### Debug Log References

N/A - Реализация прошла без критических ошибок.

### Completion Notes List

1. **SearchAutocomplete компонент** создан в `src/components/business/SearchAutocomplete/`:
   - Интегрирует `SearchField` с `productsService.search()` для live-поиска
   - Ограничение до 5 товаров в dropdown для performance
   - Навигация на страницу товара при клике (`/product/{slug}`)
   - Навигация на страницу поиска при Enter (`/search?q=...`)
   - Поддержка desktop (max-width: 300px) и mobile режимов
   - Callback `onNavigate` для закрытия мобильного меню

2. **SearchField обновлён** — добавлен `onProductClick` callback для обработки кликов по товарам в dropdown.

3. **Header.tsx обновлён**:
   - Desktop: заменена кнопка поиска на `<SearchAutocomplete />` с классом `hidden lg:block`
   - Mobile: добавлен `<SearchAutocomplete isMobile onNavigate={...} />` в мобильное меню

4. **20 unit-тестов** созданы и успешно проходят:
   - Rendering (4 теста)
   - Search Functionality (3 теста)
   - Navigation (3 теста)
   - Product Click (1 тест)
   - Accessibility (2 теста)
   - Mobile Mode (1 тест)
   - Loading Skeleton (2 теста) — **NEW**
   - Keyboard Navigation (4 теста) — **NEW**

5. **QA Future Recommendations реализованы (v1.3):**
   - **Loading Skeleton**: добавлен `isLoading` prop в `SearchField`, показывает анимированный скелетон во время загрузки
   - **Keyboard Navigation**: реализована навигация Arrow Up/Down для dropdown, Enter для выбора, Escape для закрытия

### File List

| File | Action | Description |
|------|--------|-------------|
| `frontend/src/components/business/SearchAutocomplete/SearchAutocomplete.tsx` | MODIFIED | Передача `isLoading` в SearchField |
| `frontend/src/components/business/SearchAutocomplete/index.ts` | - | Экспорт компонента |
| `frontend/src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx` | MODIFIED | Unit-тесты (20 тестов, +6 новых) |
| `frontend/src/components/business/index.ts` | - | Добавлен экспорт SearchAutocomplete |
| `frontend/src/components/ui/SearchField/SearchField.tsx` | MODIFIED | Добавлены `isLoading` prop, keyboard navigation (Arrow Up/Down, Enter, Escape), loading skeleton |
| `frontend/src/components/layout/Header.tsx` | - | Интегрирован SearchAutocomplete (desktop/mobile) |

---

## QA Results

### Review Date: 2025-12-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Отличная реализация.** Код чистый, хорошо структурированный и соответствует стандартам проекта. Компонент `SearchAutocomplete` корректно использует существующий `SearchField` и `productsService`, что обеспечивает переиспользование и снижает дублирование кода.

**Сильные стороны:**

- ✓ JSDoc комментарии для всех функций и интерфейсов
- ✓ Корректная типизация TypeScript (SearchAutocompleteProps, SearchFieldProduct)
- ✓ Разделение ответственности: UI-логика в SearchField, бизнес-логика в SearchAutocomplete
- ✓ Правильное использование useCallback для мемоизации обработчиков
- ✓ Лимит 5 товаров для оптимизации производительности

### Refactoring Performed

Рефакторинг не требовался — код уже соответствует best practices.

### Compliance Check

- Coding Standards: ✓ Соответствует `coding-standards.md`
- Project Structure: ✓ Файлы размещены в `/components/business/SearchAutocomplete/`
- Testing Strategy: ✓ 14 тестов покрывают все AC, используется MSW для моков API
- All ACs Met: ✓ Все 5 критериев приёмки выполнены

### Improvements Checklist

- [x] Компонент SearchAutocomplete создан и интегрирован
- [x] Тесты написаны и проходят (20/20)
- [x] Экспорты настроены корректно
- [x] Header обновлён для desktop и mobile
- [x] ~~*Future:*~~ Добавить скелетон загрузки в dropdown — **DONE v1.3**
- [x] ~~*Future:*~~ Добавить keyboard navigation (Arrow Up/Down) для dropdown — **DONE v1.3**

### Security Review

✓ **Безопасно.** Используется `encodeURIComponent` для параметров URL, что предотвращает XSS через query string.

### Performance Considerations

✓ **Оптимально:**

- Debounce 300ms предотвращает избыточные API-запросы
- Лимит 5 товаров в dropdown снижает рендеринг
- Используется `useCallback` для предотвращения ненужных ре-рендеров

### Files Modified During Review

Файлы не модифицировались во время ревью.

### Gate Status

**Gate: PASS** → `docs/qa/gates/18.1-header-search-integration.yml`

### Recommended Status

**✓ Ready for Done** — История готова к закрытию.
