# Story 18.1: Интеграция поиска в Header

## Status

Approved

## Story

**As a** пользователь,  
**I want** видеть поле поиска в шапке сайта,  
**so that** быстро находить товары с любой страницы.

## Acceptance Criteria

1. - [ ] SearchField отображается в Header (desktop: inline, mobile: dropdown)
2. - [ ] Ввод запроса показывает autocomplete dropdown с товарами
3. - [ ] Клик по товару в dropdown → переход на страницу товара
4. - [ ] Enter или клик по иконке → переход на `/search?q=...`
5. - [ ] Поле поиска доступно при прокрутке (sticky header)

## Tasks / Subtasks

- [ ] **Task 1: Интеграция SearchField в Header (Desktop)** (AC: 1, 5)
  - [ ] 1.1. Заменить неактивную кнопку `<button aria-label="Поиск">` на компонент `SearchAutocomplete` в `Header.tsx` (строки 117-124)
  - [ ] 1.2. Обеспечить корректное позиционирование SearchField в sticky header
  - [ ] 1.3. Ограничить ширину поля поиска на desktop (max-width: 300px) для гармоничного UI

- [ ] **Task 2: Создание SearchAutocomplete компонента** (AC: 2, 3, 4)
  - [ ] 2.1. Создать `src/components/business/SearchAutocomplete/SearchAutocomplete.tsx`
  - [ ] 2.2. Интегрировать `SearchField` из `src/components/ui/SearchField/SearchField.tsx`
  - [ ] 2.3. Подключить `productsService.search()` для live-поиска товаров
  - [ ] 2.4. Реализовать навигацию на страницу товара при клике (используя `next/navigation` → `router.push`)
  - [ ] 2.5. Реализовать навигацию на `/search?q={query}` при Enter или клике по иконке
  - [ ] 2.6. Создать файл индекса `src/components/business/SearchAutocomplete/index.ts` для экспорта

- [ ] **Task 3: Интеграция SearchField в Header (Mobile)** (AC: 1)
  - [ ] 3.1. Заменить неактивную кнопку поиска в мобильном меню (строки 225-230) на `SearchAutocomplete`
  - [ ] 3.2. Обеспечить полноэкранный/dropdown режим поиска на мобильных устройствах
  - [ ] 3.3. Закрывать мобильное меню после выбора результата поиска

- [ ] **Task 4: Типизация** (AC: 1-5)
  - [ ] 4.1. Добавить TypeScript интерфейс `SearchAutocompleteProps`
  - [ ] 4.2. Убедиться что все props корректно типизированы

- [ ] **Task 5: Unit-тесты** (AC: 1-5)
  - [ ] 5.1. Создать `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx`
  - [ ] 5.2. Тест: отображение SearchField в Header (desktop)
  - [ ] 5.3. Тест: отображение SearchField в Header (mobile)
  - [ ] 5.4. Тест: вызов `productsService.search()` при вводе (с MSW)
  - [ ] 5.5. Тест: навигация на страницу товара при клике
  - [ ] 5.6. Тест: навигация на `/search?q=...` при Enter
  - [ ] 5.7. Тест: Header имеет sticky позиционирование (`sticky top-0` класс)
  - [ ] 5.8. Обновить `Header.test.tsx` для проверки интеграции SearchAutocomplete

---

## Dev Notes

### Существующие компоненты для переиспользования

**SearchField** — `src/components/ui/SearchField/SearchField.tsx`
[Source: epic-18-search.md, docs/architecture/04-component-structure.md]

Готовый компонент с:

- `debounceMs` — debounce 300ms (по умолчанию)
- `minLength` — минимальная длина для поиска (по умолчанию 2)
- `suggestions` — массив строковых подсказок
- `products` — массив товаров `{ id, name, price }`
- `onSearch` — callback при изменении debounced значения
- Autocomplete dropdown с секциями "Подсказки" и "Товары"
- Clear button для очистки
- ARIA-атрибуты для accessibility (`role="listbox"`, `aria-label`)

**productsService.search()** — `src/services/productsService.ts`
[Source: epic-18-search.md]

```typescript
// Поиск товаров
ProductsService.search(query: string): Promise<{ results: Product[] }>
// GET /api/v1/products/search/?q={query}
```

### Header.tsx — Ключевые места для изменений

[Source: src/components/layout/Header.tsx]

**Desktop поиск (строки 119-124):**

```tsx
{/* Поиск */}
<button
  aria-label="Поиск"
  className="p-2 text-text-primary hover:text-text-secondary ..."
>
  <Search className="w-6 h-6" />
</button>
```

→ Заменить на `<SearchAutocomplete />`

**Mobile поиск (строки 225-230):**

```tsx
<button
  aria-label="Поиск"
  className="p-2 text-text-primary hover:text-text-secondary ..."
>
  <Search className="w-6 h-6" />
</button>
```

→ Заменить на `<SearchAutocomplete isMobile />`

### Архитектура компонента SearchAutocomplete

```
src/components/business/SearchAutocomplete/
├── SearchAutocomplete.tsx    # Основной компонент
├── index.ts                  # Экспорт
└── __tests__/
    └── SearchAutocomplete.test.tsx
```

### Интерфейс компонента

```typescript
interface SearchAutocompleteProps {
  className?: string;
  isMobile?: boolean;
  onNavigate?: () => void; // Callback для закрытия мобильного меню
}
```

### Логика навигации

1. **При клике на товар в dropdown:**

   ```typescript
   router.push(`/product/${product.slug}`);
   ```

2. **При Enter или клике по иконке поиска:**

   ```typescript
   // Обработчик клавиши Enter в SearchField
   const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
     if (e.key === 'Enter' && query.trim().length >= minLength) {
       router.push(`/search?q=${encodeURIComponent(query)}`);
       onNavigate?.(); // Закрыть мобильное меню если открыто
     }
   };
   ```

3. **Лимит товаров в dropdown (Performance):**

   ```typescript
   // Ограничить до 5 товаров для оптимизации
   const displayProducts = products.slice(0, 5);
   ```

### Требования к Performance

[Source: epic-18-search.md#requirements]

- Autocomplete < 300ms (debounce 300ms обеспечивает это)
- Лимит 5 товаров в dropdown для оптимизации

### Требования к Accessibility

[Source: epic-18-search.md#requirements, coding-standards.md]

- WCAG 2.1 AA
- Keyboard navigation (`Tab`, `Arrow Up/Down`, `Enter`, `Escape`)
- `aria-label` для всех интерактивных элементов
- `role="listbox"` для dropdown (уже реализовано в SearchField)

### Файловая структура проекта

[Source: docs/architecture/source-tree.md]

```
frontend/src/
├── components/
│   ├── business/           # Бизнес-компоненты
│   │   └── SearchAutocomplete/  # НОВЫЙ КОМПОНЕНТ
│   ├── layout/
│   │   └── Header.tsx      # МОДИФИКАЦИЯ
│   └── ui/
│       └── SearchField/    # СУЩЕСТВУЮЩИЙ
├── services/
│   └── productsService.ts  # СУЩЕСТВУЮЩИЙ API
└── hooks/
    └── useDebounce.ts      # СУЩЕСТВУЮЩИЙ
```

---

## Testing

### Файлы тестов

- `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx` — **НОВЫЙ**
- `src/components/layout/__tests__/Header.test.tsx` — **ОБНОВЛЕНИЕ**

### Технологический стек тестирования

[Source: docs/architecture/10-testing-strategy.md, docs/architecture/tech-stack.md]

- **Framework:** Vitest 2.1.5
- **Testing Library:** @testing-library/react 16.3.0
- **User Events:** @testing-library/user-event 14.5.1
- **API Mocking:** MSW 2.12.2
- **DOM Environment:** happy-dom 15.11.3
- **Accessibility:** vitest-axe

### Паттерны тестирования

[Source: coding-standards.md#frontend-testing]

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { http, HttpResponse } from 'msw';
import { setupServer } from 'msw/node';
```

### Команды для запуска тестов

```bash
# Запуск всех тестов frontend
cd frontend && npm run test

# Запуск конкретного теста
npm run test -- SearchAutocomplete

# Запуск тестов с покрытием
npm run test:coverage
```

### Требования к покрытию

[Source: docs/architecture/10-testing-strategy.md]

- Overall: >= 70%
- Новые компоненты: >= 80%

---

## Change Log

| Date       | Version | Description           | Author       |
|------------|---------|-----------------------|--------------|
| 2025-12-21 | 1.0     | Initial story draft   | Scrum Master |
| 2025-12-21 | 1.1     | PO Validation: исправлены номера строк, добавлен тест 5.7 для sticky header, добавлены примеры onKeyDown и products.slice(0, 5) | Product Owner |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
