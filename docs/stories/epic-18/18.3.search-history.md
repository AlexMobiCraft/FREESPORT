# Story 18.3: История и автодополнение поиска

## Status

Done

## Story

**As a** пользователь,  
**I want** видеть историю своих поисковых запросов,  
**so that** быстро повторять предыдущие поиски.

## Acceptance Criteria

1. - [x] История хранится в localStorage (последние 10 запросов)
2. - [x] При фокусе на пустом поле показывается история
3. - [x] Клик по истории → выполняется поиск
4. - [x] Кнопка очистки истории
5. - [x] История сохраняется между сессиями

## Tasks / Subtasks

- [x] **Task 1: Создание хука useSearchHistory** (AC: 1, 5)
  - [x] 1.1. Создать `src/hooks/useSearchHistory.ts`
  - [x] 1.2. Реализовать хранение в localStorage с ключом `search_history`
  - [x] 1.3. Реализовать лимит в 10 последних запросов
  - [x] 1.4. Реализовать функцию `addSearch(query: string)` — добавление запроса в историю
  - [x] 1.5. Реализовать функцию `clearHistory()` — очистка истории
  - [x] 1.6. Реализовать функцию `removeSearch(query: string)` — удаление конкретного запроса
  - [x] 1.7. Обработать SSR (проверка `typeof window !== 'undefined'`)
  - [x] 1.8. Обновить файл индекса `src/hooks/index.ts` — добавить экспорт useSearchHistory

- [x] **Task 2: Создание компонента SearchHistory** (AC: 2, 3, 4)
  - [x] 2.1. Создать `src/components/business/SearchHistory/SearchHistory.tsx`
  - [x] 2.2. Реализовать отображение списка последних запросов
  - [x] 2.3. Реализовать клик по элементу истории → вызов `onSelect(query)`
  - [x] 2.4. Реализовать кнопку очистки всей истории с подтверждением
  - [x] 2.5. Реализовать кнопку удаления конкретного элемента (иконка X)
  - [x] 2.6. Добавить иконку `Clock` (lucide-react) для визуального индикатора истории
  - [x] 2.7. Создать файл индекса `src/components/business/SearchHistory/index.ts`

- [x] **Task 3: Интеграция SearchHistory в SearchAutocomplete** (AC: 2, 3)
  - [x] 3.1. Импортировать хук `useSearchHistory` в `SearchAutocomplete.tsx`
  - [x] 3.2. Показывать `SearchHistory` при фокусе на пустом поле поиска
  - [x] 3.3. Скрывать историю при наличии текста в поле
  - [x] 3.4. Добавлять запрос в историю при успешном поиске (Enter или навигация)
  - [x] 3.5. При клике на элемент истории заполнять поле и выполнять поиск

- [x] **Task 4: Стилизация компонента SearchHistory** (AC: 2, 4)
  - [x] 4.1. Применить стили Design System v2.0 (bg-white, border, shadow-lg)
  - [x] 4.2. Реализовать hover-эффекты для элементов списка
  - [x] 4.3. Обеспечить консистентность со стилями autocomplete dropdown из SearchField

- [x] **Task 5: Unit-тесты для useSearchHistory** (AC: 1, 5)
  - [x] 5.1. Создать `src/hooks/__tests__/useSearchHistory.test.ts`
  - [x] 5.2. Тест: добавление запроса в историю
  - [x] 5.3. Тест: лимит 10 запросов (удаление старых при переполнении)
  - [x] 5.4. Тест: очистка истории
  - [x] 5.5. Тест: удаление конкретного запроса
  - [x] 5.6. Тест: история сохраняется в localStorage
  - [x] 5.7. Тест: дубликаты перемещаются в начало списка

- [x] **Task 6: Unit-тесты для SearchHistory** (AC: 2, 3, 4)
  - [x] 6.1. Создать `src/components/business/SearchHistory/__tests__/SearchHistory.test.tsx`
  - [x] 6.2. Тест: рендеринг списка истории
  - [x] 6.3. Тест: клик по элементу → вызов onSelect
  - [x] 6.4. Тест: кнопка очистки истории
  - [x] 6.5. Тест: удаление отдельного элемента

- [x] **Task 7: Обновление SearchAutocomplete тестов** (AC: 2, 3)
  - [x] 7.1. Обновить `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx`
  - [x] 7.2. Тест: показ истории при фокусе на пустом поле
  - [x] 7.3. Тест: скрытие истории при вводе текста
  - [x] 7.4. Тест: добавление запроса в историю при поиске

---

## Dev Notes

> [!CAUTION]
> **BLOCKED**: Эта история ЗАБЛОКИРОВАНА до завершения Story 18.1.
> Файл: [18.1.header-search-integration.md](file:///c:/Users/38670/DEV_WEB/FREESPORT/docs/stories/epic-18/18.1.header-search-integration.md)

### Существующие компоненты для переиспользования

**SearchField** — `src/components/ui/SearchField/SearchField.tsx`
[Source: epic-18-search.md, 18.1.header-search-integration.md]

Компонент поля поиска с:

- `debounceMs` — debounce 300ms (по умолчанию)
- `minLength` — минимальная длина для поиска (по умолчанию 2)
- `onSearch` — callback при изменении debounced значения
- Autocomplete dropdown с секциями "Подсказки" и "Товары"
- `role="listbox"` для accessibility

**SearchAutocomplete** — `src/components/business/SearchAutocomplete/SearchAutocomplete.tsx`
[Source: 18.1.header-search-integration.md]

Компонент из Story 18.1 (должен быть реализован до этой истории):

```typescript
interface SearchAutocompleteProps {
  className?: string;
  isMobile?: boolean;
  onNavigate?: () => void;
}
```

---

### useDebounce hook — `src/hooks/useDebounce.ts`

[Source: src/hooks/useDebounce.ts]

Существующий хук для debounce:

```typescript
export function useDebounce<T>(value: T, delay: number): T;
// Использование: const debouncedQuery = useDebounce(searchQuery, 300);
```

---

### Архитектура useSearchHistory hook

```typescript
// src/hooks/useSearchHistory.ts

const STORAGE_KEY = 'search_history';
const MAX_HISTORY_ITEMS = 10;

interface UseSearchHistoryReturn {
  history: string[];           // Массив последних запросов
  addSearch: (query: string) => void;   // Добавить запрос
  removeSearch: (query: string) => void; // Удалить конкретный запрос
  clearHistory: () => void;    // Очистить всю историю
}

export function useSearchHistory(): UseSearchHistoryReturn {
  const [history, setHistory] = useState<string[]>([]);

  // Загрузка из localStorage при монтировании
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          setHistory(JSON.parse(stored));
        } catch (e) {
          console.error('Failed to parse search history');
        }
      }
    }
  }, []);

  // Сохранение в localStorage при изменении
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }
  }, [history]);

  const addSearch = (query: string) => {
    const trimmedQuery = query.trim();
    if (!trimmedQuery) return;
    
    setHistory(prev => {
      // Удаляем дубликат если существует
      const filtered = prev.filter(item => item !== trimmedQuery);
      // Добавляем в начало и ограничиваем до MAX_HISTORY_ITEMS
      return [trimmedQuery, ...filtered].slice(0, MAX_HISTORY_ITEMS);
    });
  };

  const removeSearch = (query: string) => {
    setHistory(prev => prev.filter(item => item !== query));
  };

  const clearHistory = () => {
    setHistory([]);
  };

  return { history, addSearch, removeSearch, clearHistory };
}
```

---

### Интерфейс SearchHistory компонента

```typescript
// src/components/business/SearchHistory/SearchHistory.tsx

interface SearchHistoryProps {
  history: string[];
  onSelect: (query: string) => void;
  onRemove: (query: string) => void;
  onClear: () => void;
  className?: string;
}
```

---

### Интеграция в SearchAutocomplete

[Source: 18.1.header-search-integration.md]

В компоненте `SearchAutocomplete` добавить логику:

```typescript
import { useSearchHistory } from '@/hooks/useSearchHistory';
import { SearchHistory } from '../SearchHistory';

// В компоненте:
const { history, addSearch, removeSearch, clearHistory } = useSearchHistory();
const [isFocused, setIsFocused] = useState(false);
const query = /* текущий запрос */;

// Показ истории при фокусе на пустом поле
const showHistory = isFocused && query.trim().length === 0 && history.length > 0;

// При успешном поиске (Enter или клик на товар):
const handleSearch = (searchQuery: string) => {
  addSearch(searchQuery);
  router.push(`/search?q=${encodeURIComponent(searchQuery)}`);
};

// В рендере:
{showHistory && (
  <SearchHistory
    history={history}
    onSelect={handleSearch}
    onRemove={removeSearch}
    onClear={clearHistory}
  />
)}
```

---

### Стилизация SearchHistory

[Source: docs/architecture/coding-standards.md, 18.1.header-search-integration.md]

Стили должны соответствовать Design System v2.0 и autocomplete dropdown из SearchField:

```typescript
// Контейнер dropdown (как в SearchField)
className={cn(
  'absolute top-full left-0 right-0 mt-1 z-50',
  'bg-white rounded-lg',
  'border border-[#E3E8F2]',
  'shadow-lg',
  'max-h-80 overflow-y-auto',
  'animate-in fade-in-0 zoom-in-95 duration-100'
)}

// Заголовок секции
<div className="px-4 py-1 text-caption text-text-muted font-medium">
  История поиска
</div>

// Элемент истории
<button
  className={cn(
    'w-full px-4 py-2',
    'flex items-center justify-between gap-2',
    'text-left text-body text-text-primary',
    'hover:bg-[#F5F7FA]',
    'transition-colors'
  )}
  role="option"
  aria-label={`Выбрать запрос: ${query}`}
>
  <div className="flex items-center gap-2">
    <Clock className="w-4 h-4 text-[#7A7A7A]" />
    {query}
  </div>
  <button 
    onClick={(e) => { e.stopPropagation(); onRemove(query); }} 
    aria-label={`Удалить запрос: ${query}`}
  >
    <X className="w-4 h-4 text-text-muted hover:text-text-primary" />
  </button>
</button>

// Кнопка очистки истории
<button 
  className="w-full px-4 py-2 text-caption text-text-muted hover:text-text-primary text-center border-t border-[#E3E8F2]"
  aria-label="Очистить историю поиска"
>
  Очистить историю
</button>
```

---

### Файловая структура проекта

[Source: docs/architecture/source-tree.md]

```
frontend/src/
├── hooks/
│   ├── useDebounce.ts           # СУЩЕСТВУЮЩИЙ
│   ├── useSearchHistory.ts      # НОВЫЙ
│   ├── index.ts                 # ОБНОВИТЬ (добавить экспорт)
│   └── __tests__/
│       └── useSearchHistory.test.ts  # НОВЫЙ
├── components/
│   └── business/
│       ├── SearchAutocomplete/  # МОДИФИКАЦИЯ (из Story 18.1)
│       └── SearchHistory/       # НОВАЯ ДИРЕКТОРИЯ
│           ├── SearchHistory.tsx
│           ├── index.ts
│           └── __tests__/
│               └── SearchHistory.test.tsx
```

---

### Зависимость от Story 18.1

> [!IMPORTANT]
> Эта история зависит от Story 18.1 "Интеграция поиска в Header".
> Компонент `SearchAutocomplete` должен быть реализован до начала работы над этой историей.
>
> **Статус 18.1:** Approved (ожидает реализации)

---

### Требования к Accessibility

[Source: epic-18-search.md#requirements, coding-standards.md]

- WCAG 2.1 AA
- Keyboard navigation (`Tab`, `Arrow Up/Down`, `Enter`, `Escape`)
- `aria-label` для кнопок удаления и очистки
- `role="listbox"` для списка истории
- `role="option"` для элементов списка

---

### localStorage API Safety

[Source: coding-standards.md]

Обязательно проверять наличие `window` для SSR совместимости:

```typescript
if (typeof window !== 'undefined') {
  localStorage.getItem(STORAGE_KEY);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
```

Обрабатывать ошибки JSON.parse в try/catch.

---

## Testing

### Файлы тестов

- `src/hooks/__tests__/useSearchHistory.test.ts` — **НОВЫЙ**
- `src/components/business/SearchHistory/__tests__/SearchHistory.test.tsx` — **НОВЫЙ**
- `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx` — **ОБНОВЛЕНИЕ**

### Технологический стек тестирования

[Source: docs/architecture/10-testing-strategy.md, docs/architecture/tech-stack.md]

- **Framework:** Vitest 2.1.5
- **Testing Library:** @testing-library/react 16.3.0
- **User Events:** @testing-library/user-event 14.5.1
- **DOM Environment:** happy-dom 15.11.3
- **Accessibility:** vitest-axe

### Паттерны тестирования

[Source: coding-standards.md#frontend-testing]

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { renderHook, act } from '@testing-library/react';
```

### Мокирование localStorage

```typescript
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
};

beforeEach(() => {
  Object.defineProperty(window, 'localStorage', {
    value: localStorageMock,
  });
});
```

### Тестовые сценарии useSearchHistory

1. **Инициализация:**
   - Загрузка пустой истории
   - Загрузка существующей истории из localStorage

2. **addSearch:**
   - Добавление нового запроса
   - Лимит 10 элементов
   - Дубликат перемещается в начало

3. **removeSearch:**
   - Удаление конкретного запроса

4. **clearHistory:**
   - Очистка всей истории

### Тестовые сценарии SearchHistory компонента

1. **Рендеринг:**
   - Отображение списка истории
   - Отображение пустого состояния

2. **Интерактивность:**
   - Клик по элементу → onSelect
   - Клик на X → onRemove
   - Клик "Очистить историю" → onClear

### Команды для запуска тестов

```bash
# Запуск всех тестов frontend
cd frontend && npm run test

# Запуск конкретного теста
npm run test -- useSearchHistory
npm run test -- SearchHistory

# Запуск тестов с покрытием
npm run test:coverage
```

### Требования к покрытию

[Source: docs/architecture/10-testing-strategy.md]

- Overall: >= 70%
- Новые компоненты/хуки: >= 80%

---

## Change Log

| Date       | Version | Description           | Author       |
|------------|---------|----------------------|--------------|
| 2025-12-21 | 1.0     | Initial story draft   | Scrum Master |
| 2025-12-21 | 1.1     | PO Validation: добавлен CAUTION блок, исправлен Task 1.8, добавлены aria-label примеры | Product Owner |
| 2025-12-21 | 1.2     | QA Fix: Добавлены E2E тесты Playwright для search history flow (12 тестов) | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

N/A - No blocking issues encountered

### Completion Notes List

1. **useSearchHistory Hook**: Реализован с полной поддержкой localStorage, лимитом 10 запросов, обработкой дубликатов и SSR совместимостью
2. **SearchHistory Component**: Создан с Design System v2.0 стилями, включая confirmation dialog для очистки истории
3. **Integration**: Успешно интегрирован в SearchAutocomplete с обработчиками фокуса и автоматическим добавлением запросов в историю
4. **Testing**: Все тесты пройдены успешно (32 теста: 16 для useSearchHistory, 16 для SearchHistory, 5 дополнительных для SearchAutocomplete)
5. **Code Quality**: Следованы все стандарты проекта (TypeScript типизация, документация, accessibility)
6. **E2E Testing (QA Fix)**: Добавлены 12 Playwright E2E тестов покрывающих все AC: localStorage, показ при фокусе, клик для поиска, очистка, persistence между сессиями, accessibility

### File List

**Новые файлы:**

- `frontend/src/hooks/useSearchHistory.ts` - хук для управления историей поиска
- `frontend/src/hooks/__tests__/useSearchHistory.test.ts` - тесты для хука (16 тестов)
- `frontend/src/components/business/SearchHistory/SearchHistory.tsx` - компонент истории поиска
- `frontend/src/components/business/SearchHistory/index.ts` - индексный файл компонента
- `frontend/src/components/business/SearchHistory/__tests__/SearchHistory.test.tsx` - тесты компонента (16 тестов)

- `frontend/tests/e2e/search-history.spec.ts` - E2E тесты Playwright для search history flow (12 тестов)

**Модифицированные файлы:**

- `frontend/src/hooks/index.ts` - добавлен экспорт useSearchHistory
- `frontend/src/components/business/index.ts` - добавлен экспорт SearchHistory
- `frontend/src/components/business/SearchAutocomplete/SearchAutocomplete.tsx` - интеграция истории поиска
- `frontend/src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx` - добавлены тесты для истории (+5 тестов)
- `frontend/src/components/business/SearchHistory/SearchHistory.tsx` - добавлен data-testid для E2E тестов

---

## QA Results

### Review Date: 2025-12-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Rating: Excellent** ⭐⭐⭐⭐⭐

Реализация Story 18.3 выполнена на высоком уровне качества:

1. **useSearchHistory Hook** — чистая, хорошо документированная реализация с:
   - Корректной SSR совместимостью (`typeof window !== 'undefined'`)
   - Валидацией данных из localStorage (проверка `Array.isArray`)
   - Обработкой ошибок JSON.parse в try/catch
   - Лимитом 10 элементов и дедупликацией

2. **SearchHistory Component** — production-ready компонент с:
   - Confirmation dialog для очистки (3 сек таймаут)
   - Полной accessibility поддержкой (`role="listbox"`, `role="option"`, `aria-label`)
   - Консистентными Design System v2.0 стилями
   - Корректной обработкой e.stopPropagation() для кнопки удаления

3. **SearchAutocomplete Integration** — seamless интеграция с:
   - Корректным показом/скрытием истории при фокусе
   - Автоматическим добавлением запросов в историю при поиске
   - Keyboard support (Escape для закрытия)

### Refactoring Performed

Рефакторинг не требуется — код соответствует всем стандартам проекта.

### Compliance Check

- Coding Standards: ✓ Полное соответствие TypeScript strict mode, JSDoc документация
- Project Structure: ✓ Файлы размещены корректно согласно source-tree.md
- Testing Strategy: ✓ Unit-тесты покрывают все acceptance criteria
- All ACs Met: ✓ Все 5 acceptance criteria реализованы и протестированы

### Test Coverage Analysis

| Компонент | Тестов | Статус |
|-----------|--------|--------|
| useSearchHistory | 16 | ✅ PASS |
| SearchHistory | 16 | ✅ PASS |
| SearchAutocomplete | 25 (5 для 18.3) | ✅ PASS |
| **Всего** | **57** | **✅ PASS** |

**Покрытие Acceptance Criteria:**

| AC | Описание | Тесты |
|----|----------|-------|
| 1 | localStorage (10 запросов) | 5+ тестов (лимит, сохранение) |
| 2 | Показ при фокусе на пустом поле | 2 теста |
| 3 | Клик по истории → поиск | 2 теста |
| 4 | Кнопка очистки | 3 теста (confirm dialog) |
| 5 | Сохранение между сессиями | 3 теста |

### Improvements Checklist

- [x] SSR compatibility проверена в коде
- [x] localStorage error handling реализован
- [x] Accessibility соответствует WCAG 2.1 AA
- [x] Design System v2.0 стили применены корректно
- [x] Все экспорты добавлены в index.ts файлы
- [x] E2E тесты (добавлены в `frontend/tests/e2e/search-history.spec.ts`)

### Security Review

✅ **Нет проблем безопасности**

- localStorage используется только для хранения поисковых запросов (не sensitive data)
- Нет XSS-уязвимостей — query рендерится через React (auto-escaped)
- Нет доступа к приватным данным пользователя

### Performance Considerations

✅ **Нет проблем производительности**

- История ограничена 10 элементами — O(1) рендеринг
- localStorage sync происходит только при изменении state
- Компонент возвращает `null` при пустой истории (zero render cost)

### Files Modified During Review

Никаких модификаций не потребовалось.

### Gate Status

- **Gate**: PASS → `docs/qa/gates/18.3-search-history.yml`
- **Quality Score**: 95/100

### Recommended Status

✅ **Ready for Done**

Все acceptance criteria выполнены, тесты проходят, код соответствует стандартам проекта.
