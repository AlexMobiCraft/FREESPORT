# Story 18.3: История и автодополнение поиска

## Status

Available

## Story

**As a** пользователь,  
**I want** видеть историю своих поисковых запросов,  
**so that** быстро повторять предыдущие поиски.

## Acceptance Criteria

1. - [ ] История хранится в localStorage (последние 10 запросов)
2. - [ ] При фокусе на пустом поле показывается история
3. - [ ] Клик по истории → выполняется поиск
4. - [ ] Кнопка очистки истории
5. - [ ] История сохраняется между сессиями

## Tasks / Subtasks

- [ ] **Task 1: Создание хука useSearchHistory** (AC: 1, 5)
  - [ ] 1.1. Создать `src/hooks/useSearchHistory.ts`
  - [ ] 1.2. Реализовать хранение в localStorage с ключом `search_history`
  - [ ] 1.3. Реализовать лимит в 10 последних запросов
  - [ ] 1.4. Реализовать функцию `addSearch(query: string)` — добавление запроса в историю
  - [ ] 1.5. Реализовать функцию `clearHistory()` — очистка истории
  - [ ] 1.6. Реализовать функцию `removeSearch(query: string)` — удаление конкретного запроса
  - [ ] 1.7. Обработать SSR (проверка `typeof window !== 'undefined'`)
  - [ ] 1.8. Обновить файл индекса `src/hooks/index.ts` — добавить экспорт useSearchHistory

- [ ] **Task 2: Создание компонента SearchHistory** (AC: 2, 3, 4)
  - [ ] 2.1. Создать `src/components/business/SearchHistory/SearchHistory.tsx`
  - [ ] 2.2. Реализовать отображение списка последних запросов
  - [ ] 2.3. Реализовать клик по элементу истории → вызов `onSelect(query)`
  - [ ] 2.4. Реализовать кнопку очистки всей истории с подтверждением
  - [ ] 2.5. Реализовать кнопку удаления конкретного элемента (иконка X)
  - [ ] 2.6. Добавить иконку `Clock` (lucide-react) для визуального индикатора истории
  - [ ] 2.7. Создать файл индекса `src/components/business/SearchHistory/index.ts`

- [ ] **Task 3: Интеграция SearchHistory в SearchAutocomplete** (AC: 2, 3)
  - [ ] 3.1. Импортировать хук `useSearchHistory` в `SearchAutocomplete.tsx`
  - [ ] 3.2. Показывать `SearchHistory` при фокусе на пустом поле поиска
  - [ ] 3.3. Скрывать историю при наличии текста в поле
  - [ ] 3.4. Добавлять запрос в историю при успешном поиске (Enter или навигация)
  - [ ] 3.5. При клике на элемент истории заполнять поле и выполнять поиск

- [ ] **Task 4: Стилизация компонента SearchHistory** (AC: 2, 4)
  - [ ] 4.1. Применить стили Design System v2.0 (bg-white, border, shadow-lg)
  - [ ] 4.2. Реализовать hover-эффекты для элементов списка
  - [ ] 4.3. Обеспечить консистентность со стилями autocomplete dropdown из SearchField

- [ ] **Task 5: Unit-тесты для useSearchHistory** (AC: 1, 5)
  - [ ] 5.1. Создать `src/hooks/__tests__/useSearchHistory.test.ts`
  - [ ] 5.2. Тест: добавление запроса в историю
  - [ ] 5.3. Тест: лимит 10 запросов (удаление старых при переполнении)
  - [ ] 5.4. Тест: очистка истории
  - [ ] 5.5. Тест: удаление конкретного запроса
  - [ ] 5.6. Тест: история сохраняется в localStorage
  - [ ] 5.7. Тест: дубликаты перемещаются в начало списка

- [ ] **Task 6: Unit-тесты для SearchHistory** (AC: 2, 3, 4)
  - [ ] 6.1. Создать `src/components/business/SearchHistory/__tests__/SearchHistory.test.tsx`
  - [ ] 6.2. Тест: рендеринг списка истории
  - [ ] 6.3. Тест: клик по элементу → вызов onSelect
  - [ ] 6.4. Тест: кнопка очистки истории
  - [ ] 6.5. Тест: удаление отдельного элемента

- [ ] **Task 7: Обновление SearchAutocomplete тестов** (AC: 2, 3)
  - [ ] 7.1. Обновить `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx`
  - [ ] 7.2. Тест: показ истории при фокусе на пустом поле
  - [ ] 7.3. Тест: скрытие истории при вводе текста
  - [ ] 7.4. Тест: добавление запроса в историю при поиске

---

## Dev Notes

> [!CAUTION]
> **BLOCKED**: Эта история ЗАБЛОКИРОВАНА до завершения Story 18.1.
> Файл: [18.1.header-search-integration.md](file:///c:/Users/38670/DEV_WEB/FREESPORT/docs/stories/epic-18/18.1.header-search-integration.md)

### Существующие компоненты для переиспользования

**SearchField** — `src/components/ui/SearchField/SearchField.tsx`
[Source: epic-18-search.md, 18.1.header-search-integration.md]

Компонент поля поиска с:

- `debounceMs` — debounce 300ms (по умолчанию)
- `minLength` — минимальная длина для поиска (по умолчанию 2)
- `onSearch` — callback при изменении debounced значения
- Autocomplete dropdown с секциями "Подсказки" и "Товары"
- `role="listbox"` для accessibility

**SearchAutocomplete** — `src/components/business/SearchAutocomplete/SearchAutocomplete.tsx`
[Source: 18.1.header-search-integration.md]

Компонент из Story 18.1 (должен быть реализован до этой истории):

```typescript
interface SearchAutocompleteProps {
  className?: string;
  isMobile?: boolean;
  onNavigate?: () => void;
}
```

---

### useDebounce hook — `src/hooks/useDebounce.ts`

[Source: src/hooks/useDebounce.ts]

Существующий хук для debounce:

```typescript
export function useDebounce<T>(value: T, delay: number): T;
// Использование: const debouncedQuery = useDebounce(searchQuery, 300);
```

---

### Архитектура useSearchHistory hook

```typescript
// src/hooks/useSearchHistory.ts

const STORAGE_KEY = 'search_history';
const MAX_HISTORY_ITEMS = 10;

interface UseSearchHistoryReturn {
  history: string[];           // Массив последних запросов
  addSearch: (query: string) => void;   // Добавить запрос
  removeSearch: (query: string) => void; // Удалить конкретный запрос
  clearHistory: () => void;    // Очистить всю историю
}

export function useSearchHistory(): UseSearchHistoryReturn {
  const [history, setHistory] = useState<string[]>([]);

  // Загрузка из localStorage при монтировании
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          setHistory(JSON.parse(stored));
        } catch (e) {
          console.error('Failed to parse search history');
        }
      }
    }
  }, []);

  // Сохранение в localStorage при изменении
  useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }
  }, [history]);

  const addSearch = (query: string) => {
    const trimmedQuery = query.trim();
    if (!trimmedQuery) return;
    
    setHistory(prev => {
      // Удаляем дубликат если существует
      const filtered = prev.filter(item => item !== trimmedQuery);
      // Добавляем в начало и ограничиваем до MAX_HISTORY_ITEMS
      return [trimmedQuery, ...filtered].slice(0, MAX_HISTORY_ITEMS);
    });
  };

  const removeSearch = (query: string) => {
    setHistory(prev => prev.filter(item => item !== query));
  };

  const clearHistory = () => {
    setHistory([]);
  };

  return { history, addSearch, removeSearch, clearHistory };
}
```

---

### Интерфейс SearchHistory компонента

```typescript
// src/components/business/SearchHistory/SearchHistory.tsx

interface SearchHistoryProps {
  history: string[];
  onSelect: (query: string) => void;
  onRemove: (query: string) => void;
  onClear: () => void;
  className?: string;
}
```

---

### Интеграция в SearchAutocomplete

[Source: 18.1.header-search-integration.md]

В компоненте `SearchAutocomplete` добавить логику:

```typescript
import { useSearchHistory } from '@/hooks/useSearchHistory';
import { SearchHistory } from '../SearchHistory';

// В компоненте:
const { history, addSearch, removeSearch, clearHistory } = useSearchHistory();
const [isFocused, setIsFocused] = useState(false);
const query = /* текущий запрос */;

// Показ истории при фокусе на пустом поле
const showHistory = isFocused && query.trim().length === 0 && history.length > 0;

// При успешном поиске (Enter или клик на товар):
const handleSearch = (searchQuery: string) => {
  addSearch(searchQuery);
  router.push(`/search?q=${encodeURIComponent(searchQuery)}`);
};

// В рендере:
{showHistory && (
  <SearchHistory
    history={history}
    onSelect={handleSearch}
    onRemove={removeSearch}
    onClear={clearHistory}
  />
)}
```

---

### Стилизация SearchHistory

[Source: docs/architecture/coding-standards.md, 18.1.header-search-integration.md]

Стили должны соответствовать Design System v2.0 и autocomplete dropdown из SearchField:

```typescript
// Контейнер dropdown (как в SearchField)
className={cn(
  'absolute top-full left-0 right-0 mt-1 z-50',
  'bg-white rounded-lg',
  'border border-[#E3E8F2]',
  'shadow-lg',
  'max-h-80 overflow-y-auto',
  'animate-in fade-in-0 zoom-in-95 duration-100'
)}

// Заголовок секции
<div className="px-4 py-1 text-caption text-text-muted font-medium">
  История поиска
</div>

// Элемент истории
<button
  className={cn(
    'w-full px-4 py-2',
    'flex items-center justify-between gap-2',
    'text-left text-body text-text-primary',
    'hover:bg-[#F5F7FA]',
    'transition-colors'
  )}
  role="option"
  aria-label={`Выбрать запрос: ${query}`}
>
  <div className="flex items-center gap-2">
    <Clock className="w-4 h-4 text-[#7A7A7A]" />
    {query}
  </div>
  <button 
    onClick={(e) => { e.stopPropagation(); onRemove(query); }} 
    aria-label={`Удалить запрос: ${query}`}
  >
    <X className="w-4 h-4 text-text-muted hover:text-text-primary" />
  </button>
</button>

// Кнопка очистки истории
<button 
  className="w-full px-4 py-2 text-caption text-text-muted hover:text-text-primary text-center border-t border-[#E3E8F2]"
  aria-label="Очистить историю поиска"
>
  Очистить историю
</button>
```

---

### Файловая структура проекта

[Source: docs/architecture/source-tree.md]

```
frontend/src/
├── hooks/
│   ├── useDebounce.ts           # СУЩЕСТВУЮЩИЙ
│   ├── useSearchHistory.ts      # НОВЫЙ
│   ├── index.ts                 # ОБНОВИТЬ (добавить экспорт)
│   └── __tests__/
│       └── useSearchHistory.test.ts  # НОВЫЙ
├── components/
│   └── business/
│       ├── SearchAutocomplete/  # МОДИФИКАЦИЯ (из Story 18.1)
│       └── SearchHistory/       # НОВАЯ ДИРЕКТОРИЯ
│           ├── SearchHistory.tsx
│           ├── index.ts
│           └── __tests__/
│               └── SearchHistory.test.tsx
```

---

### Зависимость от Story 18.1

> [!IMPORTANT]
> Эта история зависит от Story 18.1 "Интеграция поиска в Header".
> Компонент `SearchAutocomplete` должен быть реализован до начала работы над этой историей.
>
> **Статус 18.1:** Approved (ожидает реализации)

---

### Требования к Accessibility

[Source: epic-18-search.md#requirements, coding-standards.md]

- WCAG 2.1 AA
- Keyboard navigation (`Tab`, `Arrow Up/Down`, `Enter`, `Escape`)
- `aria-label` для кнопок удаления и очистки
- `role="listbox"` для списка истории
- `role="option"` для элементов списка

---

### localStorage API Safety

[Source: coding-standards.md]

Обязательно проверять наличие `window` для SSR совместимости:

```typescript
if (typeof window !== 'undefined') {
  localStorage.getItem(STORAGE_KEY);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
```

Обрабатывать ошибки JSON.parse в try/catch.

---

## Testing

### Файлы тестов

- `src/hooks/__tests__/useSearchHistory.test.ts` — **НОВЫЙ**
- `src/components/business/SearchHistory/__tests__/SearchHistory.test.tsx` — **НОВЫЙ**
- `src/components/business/SearchAutocomplete/__tests__/SearchAutocomplete.test.tsx` — **ОБНОВЛЕНИЕ**

### Технологический стек тестирования

[Source: docs/architecture/10-testing-strategy.md, docs/architecture/tech-stack.md]

- **Framework:** Vitest 2.1.5
- **Testing Library:** @testing-library/react 16.3.0
- **User Events:** @testing-library/user-event 14.5.1
- **DOM Environment:** happy-dom 15.11.3
- **Accessibility:** vitest-axe

### Паттерны тестирования

[Source: coding-standards.md#frontend-testing]

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { renderHook, act } from '@testing-library/react';
```

### Мокирование localStorage

```typescript
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
};

beforeEach(() => {
  Object.defineProperty(window, 'localStorage', {
    value: localStorageMock,
  });
});
```

### Тестовые сценарии useSearchHistory

1. **Инициализация:**
   - Загрузка пустой истории
   - Загрузка существующей истории из localStorage

2. **addSearch:**
   - Добавление нового запроса
   - Лимит 10 элементов
   - Дубликат перемещается в начало

3. **removeSearch:**
   - Удаление конкретного запроса

4. **clearHistory:**
   - Очистка всей истории

### Тестовые сценарии SearchHistory компонента

1. **Рендеринг:**
   - Отображение списка истории
   - Отображение пустого состояния

2. **Интерактивность:**
   - Клик по элементу → onSelect
   - Клик на X → onRemove
   - Клик "Очистить историю" → onClear

### Команды для запуска тестов

```bash
# Запуск всех тестов frontend
cd frontend && npm run test

# Запуск конкретного теста
npm run test -- useSearchHistory
npm run test -- SearchHistory

# Запуск тестов с покрытием
npm run test:coverage
```

### Требования к покрытию

[Source: docs/architecture/10-testing-strategy.md]

- Overall: >= 70%
- Новые компоненты/хуки: >= 80%

---

## Change Log

| Date       | Version | Description           | Author       |
|------------|---------|----------------------|--------------|
| 2025-12-21 | 1.0     | Initial story draft   | Scrum Master |
| 2025-12-21 | 1.1     | PO Validation: добавлен CAUTION блок, исправлен Task 1.8, добавлены aria-label примеры | Product Owner |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
