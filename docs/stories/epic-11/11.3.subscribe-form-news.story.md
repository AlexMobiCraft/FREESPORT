# Story 11.3: Форма подписки на рассылку и блок новостей

## Status
**Draft**

## Story

**As a** посетитель платформы FREESPORT,
**I want** подписаться на email-рассылку о новинках и акциях, а также видеть актуальные новости на главной странице,
**so that** я буду в курсе последних предложений и новостей компании без необходимости каждый раз заходить на сайт.

## Acceptance Criteria

1. **Форма подписки на рассылку:**
   - Форма с валидацией email (React Hook Form)
   - Интеграция с `POST /api/v1/subscribe` для отправки email
   - Success toast при успешной подписке
   - Error handling для сетевых ошибок и валидации
   - Компонент использует `Input` и `Button` из UI Kit

2. **Success/Error обработка:**
   - Success toast: "Вы успешно подписались на рассылку"
   - Error states:
     - Ошибка валидации: "Введите корректный email"
     - Email уже подписан: "Этот email уже подписан на рассылку"
     - Сетевая ошибка: "Не удалось подписаться. Попробуйте позже"

3. **Блок "Новости и акции":**
   - Загружает данные из `GET /api/v1/news?page_size=3`
   - Отображает 3 последние новости
   - Каждая новость содержит: заголовок, краткое описание, дату, изображение
   - Карточки новостей используют `Card` компонент из UI Kit
   - Изображения оптимизированы через `next/image`

4. **Адаптивная вёрстка:**
   - Desktop: форма подписки слева, новости справа (2 колонки)
   - Tablet: вертикальный stack (форма сверху, новости снизу)
   - Mobile: вертикальный stack

5. **Loading и Error states:**
   - Skeleton loaders для блока новостей во время загрузки
   - Error state для блока новостей с fallback контентом
   - Disabled state кнопки подписки во время отправки

6. **Unit-тесты:**
   - Тесты для формы подписки (валидация email, submit)
   - Тесты для блока новостей с MSW моками
   - Тестирование success/error toast'ов
   - Integration-тесты для API вызовов
   - Покрытие кода 80%+

## Tasks / Subtasks

- [ ] **Task 1: Создать API сервисы для подписки и новостей** (AC: 1, 3)
  - [ ] Создать `src/services/subscribeService.ts`:
    - `subscribe(email: string)` → POST /api/v1/subscribe
  - [ ] Создать `src/services/newsService.ts`:
    - `getNews(params)` → GET /api/v1/news?page_size=3
  - [ ] Добавить TypeScript типы для NewsItem в types/api.ts
  - [ ] Настроить error handling и валидацию responses

- [ ] **Task 2: Реализовать форму подписки SubscribeForm** (AC: 1, 2, 5)
  - [ ] Создать `src/components/home/SubscribeForm.tsx`
  - [ ] Интегрировать React Hook Form для валидации
  - [ ] Добавить email валидацию (regex pattern)
  - [ ] Использовать `Input` и `Button` из UI Kit
  - [ ] Реализовать submit handler с subscribeService.subscribe()
  - [ ] Добавить success toast через toast library (react-hot-toast)
  - [ ] Обработать error states (валидация, already subscribed, network)
  - [ ] Disabled state кнопки во время отправки
  - [ ] Применить design tokens

- [ ] **Task 3: Реализовать блок новостей NewsSection** (AC: 3, 5)
  - [ ] Создать `src/components/home/NewsSection.tsx`
  - [ ] Использовать `newsService.getNews({page_size: 3})`
  - [ ] Реализовать карточки новостей с `Card` компонентом
  - [ ] Оптимизировать изображения через `next/image`
  - [ ] Отображать: title, excerpt, date, image для каждой новости
  - [ ] Реализовать Skeleton loader для loading state
  - [ ] Error state с fallback контентом
  - [ ] Применить design tokens (spacing, typography)

- [ ] **Task 4: Создать адаптивный layout для формы и новостей** (AC: 4)
  - [ ] Создать `src/components/home/SubscribeNewsSection.tsx` (обертка)
  - [ ] Desktop: grid с 2 колонками (форма 1/3, новости 2/3)
  - [ ] Tablet/Mobile: vertical stack
  - [ ] Применить breakpoints из design-system (640px, 1024px)
  - [ ] Протестировать адаптивность на всех viewport размерах

- [ ] **Task 5: Интегрировать в главную страницу** (AC: Все)
  - [ ] Обновить `src/app/page.tsx`
  - [ ] Добавить `<SubscribeNewsSection />` после динамических блоков
  - [ ] Применить section spacing (48px)
  - [ ] Убедиться в корректности SSG/ISR

- [ ] **Task 6: Unit-тесты для компонентов** (AC: 6)
  - [ ] Создать `src/components/home/__tests__/SubscribeForm.test.tsx`
    - Тест 1: Валидация email (невалидный email показывает ошибку)
    - Тест 2: Success submit показывает toast
    - Тест 3: Error submit показывает error message
    - Тест 4: Disabled state кнопки во время submit
  - [ ] Создать `src/components/home/__tests__/NewsSection.test.tsx`
    - Тест 1: Загрузка и отображение 3 новостей
    - Тест 2: Loading state с skeleton loaders
    - Тест 3: Error state с fallback
  - [ ] Достичь покрытия 80%+

- [ ] **Task 7: MSW моки для API эндпоинтов** (AC: 6)
  - [ ] Обновить `src/__mocks__/api/handlers.ts`
  - [ ] Настроить MSW моки для:
    - `POST /api/v1/subscribe` (success, already_subscribed, validation_error)
    - `GET /api/v1/news` (success, error)
  - [ ] Добавить mock данные для новостей
  - [ ] Настроить различные error responses

## Dev Notes

### Предыдущие Story Insights

**Story 11.1 и 11.2 завершены:**
- ✅ Главная страница с Hero и динамическими блоками реализована
- ✅ UI Kit компоненты (`Input`, `Button`, `Card`) доступны
- ✅ API client с интерцепторами настроен
- ✅ MSW setup существует в `src/__mocks__/api/`

**Интеграция с предыдущими stories:**
- Форма подписки и новости добавляются ПОСЛЕ блоков HitsSection, NewArrivalsSection, CategoriesSection
- Используем те же UI Kit компоненты и design tokens
- Сохраняем адаптивность и SSG/ISR конфигурацию

### API Specifications

**ВАЖНО:** API endpoints `/subscribe` и `/news` **НЕ** полностью специфицированы в `docs/api-spec.yaml`. Спецификация ниже основана на Epic requirements и стандартах проекта.

**1. POST /subscribe - Подписка на рассылку**

**Предполагаемая спецификация:**
```yaml
Endpoint: POST /api/v1/subscribe
Request Body:
  email: string (required, format: email)
Response 201 (Created):
  {
    "message": "Successfully subscribed",
    "email": "user@example.com"
  }
Response 400 (Validation Error):
  {
    "error": "Invalid email format",
    "field": "email"
  }
Response 409 (Already Subscribed):
  {
    "error": "This email is already subscribed",
    "email": "user@example.com"
  }
```

**TypeScript Types:**
```typescript
// src/types/api.ts
interface SubscribeRequest {
  email: string;
}

interface SubscribeResponse {
  message: string;
  email: string;
}

interface SubscribeError {
  error: string;
  field?: string;
  email?: string;
}
```

**2. GET /news - Список новостей**

**Предполагаемая спецификация:**
```yaml
Endpoint: GET /api/v1/news
Parameters:
  - page_size: integer (default: 10, max: 100)
  - page: integer (default: 1)
Response 200:
  {
    "count": integer,
    "next": string | null,
    "previous": string | null,
    "results": NewsItem[]
  }
```

**NewsItem Schema:**
```typescript
interface NewsItem {
  id: number;
  title: string;
  slug: string;
  excerpt: string; // Краткое описание
  content?: string; // Полный текст (опционально)
  image: string | null; // URL изображения
  published_at: string; // ISO date
  created_at: string;
  updated_at: string;
  author?: string;
  category?: string;
}

interface NewsList {
  count: number;
  next: string | null;
  previous: string | null;
  results: NewsItem[];
}
```

### API Service Implementation

**Subscribe Service:**

```typescript
// src/services/subscribeService.ts
import { apiClient } from './api-client';
import type { SubscribeRequest, SubscribeResponse, SubscribeError } from '@/types/api';

export const subscribeService = {
  /**
   * Подписаться на email-рассылку
   */
  async subscribe(email: string): Promise<SubscribeResponse> {
    try {
      const { data } = await apiClient.post<SubscribeResponse>('/subscribe', {
        email,
      });
      return data;
    } catch (error: any) {
      // Проброс ошибки для обработки в компоненте
      if (error.response?.status === 409) {
        throw new Error('already_subscribed');
      }
      if (error.response?.status === 400) {
        throw new Error('validation_error');
      }
      throw new Error('network_error');
    }
  },
};
```

**News Service:**

```typescript
// src/services/newsService.ts
import { apiClient } from './api-client';
import type { NewsList, NewsItem } from '@/types/api';

interface GetNewsParams {
  page_size?: number;
  page?: number;
}

export const newsService = {
  /**
   * Получить список новостей
   */
  async getNews(params?: GetNewsParams): Promise<NewsItem[]> {
    const { data } = await apiClient.get<NewsList>('/news', {
      params: {
        page_size: 3,
        ...params,
      },
    });
    return data.results;
  },
};
```

### Component Specifications

**Input Component:** [Source: frontend/docs/design-system.json#components.Input]
```typescript
// Из Epic 10 - использовать как есть
interface InputProps {
  label?: string;
  helper?: string;
  error?: string;
  type?: 'text' | 'email' | 'password';
  placeholder?: string;
  value: string;
  onChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
}

// Design tokens:
// - Height: 40px
// - Radius: 4px (radius.sm)
// - Border: 1px solid #D0D7E6 (neutral-400)
// - Error state: border-accent-danger, bg danger с opacity 8%
// - Font: body-m (16px, 24px line-height)
```

**Button Component:** [Source: frontend/docs/design-system.json#components.Button]
```typescript
// Из Epic 10
interface ButtonProps {
  variant?: 'primary' | 'secondary' | 'tertiary' | 'subtle';
  size?: 'small' | 'medium' | 'large';
  disabled?: boolean;
  loading?: boolean; // Добавить для loading state
  onClick?: () => void;
  children: React.ReactNode;
}

// Primary variant:
// - bg-primary (#1F1F1F), text-inverse (#FFFFFF)
// - shadow: primary (0 10px 24px rgba(0, 96, 255, 0.28))
// - hover: bg-primary-hover (#3A3A3A), translateY(-2px)
```

**Card Component:** [Source: frontend/docs/design-system.json#components.Card]
```typescript
// Из Epic 10
interface CardProps {
  hover?: boolean;
  className?: string;
  children: React.ReactNode;
}

// Design tokens:
// - Padding: 24px
// - Radius: 12px (radius.default)
// - Shadow: shadows.default (0 8px 24px rgba(15, 23, 42, 0.08))
```

### React Hook Form Integration

**Form Validation:** [Source: docs/architecture/tech-stack.md#React Hook Form]

```typescript
// src/components/home/SubscribeForm.tsx
import { useForm } from 'react-hook-form';
import { subscribeService } from '@/services/subscribeService';
import { toast } from 'react-hot-toast';
import { Input } from '@/components/ui/Input';
import { Button } from '@/components/ui/Button';

interface SubscribeFormData {
  email: string;
}

export const SubscribeForm: React.FC = () => {
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    reset,
  } = useForm<SubscribeFormData>();

  const onSubmit = async (data: SubscribeFormData) => {
    try {
      await subscribeService.subscribe(data.email);
      toast.success('Вы успешно подписались на рассылку');
      reset(); // Очистить форму после успеха
    } catch (error: any) {
      if (error.message === 'already_subscribed') {
        toast.error('Этот email уже подписан на рассылку');
      } else if (error.message === 'validation_error') {
        toast.error('Введите корректный email');
      } else {
        toast.error('Не удалось подписаться. Попробуйте позже');
      }
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
      <h3 className="text-title-m font-semibold text-text-primary">
        Подписаться на рассылку
      </h3>
      <Input
        label="Email"
        type="email"
        placeholder="your@email.com"
        error={errors.email?.message}
        {...register('email', {
          required: 'Email обязателен',
          pattern: {
            value: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,
            message: 'Введите корректный email',
          },
        })}
      />
      <Button
        type="submit"
        variant="primary"
        disabled={isSubmitting}
        loading={isSubmitting}
        className="w-full"
      >
        {isSubmitting ? 'Отправка...' : 'Подписаться'}
      </Button>
    </form>
  );
};
```

### Toast Notifications Setup

**React Hot Toast:** [Source: docs/architecture/tech-stack.md#Frontend]

```bash
# Установка (если еще не установлена)
npm install react-hot-toast
```

```typescript
// src/app/layout.tsx - добавить Toaster provider
import { Toaster } from 'react-hot-toast';

export default function RootLayout({ children }) {
  return (
    <html lang="ru">
      <body>
        {children}
        <Toaster
          position="top-right"
          toastOptions={{
            duration: 4000,
            style: {
              background: '#FFFFFF',
              color: '#1B1B1B',
              border: '1px solid #E0E0E0',
              borderRadius: '12px',
              fontSize: '16px',
            },
            success: {
              iconTheme: {
                primary: '#1F7A1F',
                secondary: '#E0F5E0',
              },
            },
            error: {
              iconTheme: {
                primary: '#C23B3B',
                secondary: '#FFE1E1',
              },
            },
          }}
        />
      </body>
    </html>
  );
}
```

### News Component Implementation

**NewsSection Component:**

```typescript
// src/components/home/NewsSection.tsx
'use client';

import { useEffect, useState } from 'react';
import Image from 'next/image';
import { Card } from '@/components/ui/Card';
import { newsService } from '@/services/newsService';
import type { NewsItem } from '@/types/api';

export const NewsSection: React.FC = () => {
  const [news, setNews] = useState<NewsItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(false);

  useEffect(() => {
    const fetchNews = async () => {
      try {
        const data = await newsService.getNews({ page_size: 3 });
        setNews(data);
      } catch (err) {
        setError(true);
      } finally {
        setLoading(false);
      }
    };

    fetchNews();
  }, []);

  if (loading) {
    return <NewsSkeletonLoader />;
  }

  if (error || news.length === 0) {
    return <NewsFallback />;
  }

  return (
    <div className="space-y-4">
      <h3 className="text-title-m font-semibold text-text-primary">
        Новости и акции
      </h3>
      <div className="grid gap-4">
        {news.map((item) => (
          <Card key={item.id} hover className="p-4">
            <div className="flex gap-4">
              {item.image && (
                <div className="relative w-24 h-24 shrink-0">
                  <Image
                    src={item.image}
                    alt={item.title}
                    fill
                    className="object-cover rounded-lg"
                  />
                </div>
              )}
              <div className="flex-1">
                <h4 className="text-body-l font-semibold text-text-primary mb-1">
                  {item.title}
                </h4>
                <p className="text-body-s text-text-secondary mb-2 line-clamp-2">
                  {item.excerpt}
                </p>
                <time className="text-caption text-text-muted">
                  {new Date(item.published_at).toLocaleDateString('ru-RU')}
                </time>
              </div>
            </div>
          </Card>
        ))}
      </div>
    </div>
  );
};
```

### Adaptive Layout Implementation

**SubscribeNewsSection Wrapper:**

```typescript
// src/components/home/SubscribeNewsSection.tsx
import { SubscribeForm } from './SubscribeForm';
import { NewsSection } from './NewsSection';

export const SubscribeNewsSection: React.FC = () => {
  return (
    <section className="py-12">
      <div className="max-w-[1280px] mx-auto px-6">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Desktop: 1/3 ширины, Tablet/Mobile: full width */}
          <div className="lg:col-span-1">
            <SubscribeForm />
          </div>

          {/* Desktop: 2/3 ширины, Tablet/Mobile: full width */}
          <div className="lg:col-span-2">
            <NewsSection />
          </div>
        </div>
      </div>
    </section>
  );
};
```

**Breakpoints:** [Source: frontend/docs/design-system.json#foundations.grid]
```typescript
// Tailwind breakpoints
mobile: 640px    // < 640px: 1 column stack
tablet: 1024px   // 640-1024px: 1 column stack
desktop: 1440px  // > 1024px: 2 columns (lg:col-span-1, lg:col-span-2)
```

### Testing

**MSW Handlers:** [Source: frontend/docs/testing-standards.md#Integration тесты]

```typescript
// src/__mocks__/api/handlers.ts (обновить)
import { rest } from 'msw';

export const handlers = [
  // ... существующие handlers

  // Subscribe endpoint
  rest.post('/api/v1/subscribe', async (req, res, ctx) => {
    const { email } = await req.json();

    // Simulate already subscribed
    if (email === 'existing@example.com') {
      return res(
        ctx.status(409),
        ctx.json({
          error: 'This email is already subscribed',
          email,
        })
      );
    }

    // Simulate validation error
    if (!email || !email.includes('@')) {
      return res(
        ctx.status(400),
        ctx.json({
          error: 'Invalid email format',
          field: 'email',
        })
      );
    }

    // Success
    return res(
      ctx.status(201),
      ctx.json({
        message: 'Successfully subscribed',
        email,
      })
    );
  }),

  // News endpoint
  rest.get('/api/v1/news', (req, res, ctx) => {
    return res(
      ctx.status(200),
      ctx.json({
        count: 3,
        next: null,
        previous: null,
        results: [
          {
            id: 1,
            title: 'Новая коллекция 2025',
            slug: 'new-collection-2025',
            excerpt: 'Представляем новую коллекцию спортивной одежды...',
            image: '/images/news/collection-2025.jpg',
            published_at: new Date().toISOString(),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
          {
            id: 2,
            title: 'Скидки на зимнюю экипировку',
            slug: 'winter-sale',
            excerpt: 'До конца месяца скидки до 30% на зимнюю экипировку...',
            image: '/images/news/winter-sale.jpg',
            published_at: new Date().toISOString(),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
          {
            id: 3,
            title: 'Открытие нового склада',
            slug: 'new-warehouse',
            excerpt: 'Мы рады сообщить об открытии нового склада в Москве...',
            image: '/images/news/warehouse.jpg',
            published_at: new Date().toISOString(),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
        ],
      })
    );
  }),
];
```

**Unit Test Examples:**

```typescript
// src/components/home/__tests__/SubscribeForm.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { SubscribeForm } from '../SubscribeForm';
import { toast } from 'react-hot-toast';

jest.mock('react-hot-toast');

describe('SubscribeForm', () => {
  it('shows validation error for invalid email', async () => {
    const user = userEvent.setup();
    render(<SubscribeForm />);

    const input = screen.getByLabelText(/email/i);
    const button = screen.getByRole('button', { name: /подписаться/i });

    await user.type(input, 'invalid-email');
    await user.click(button);

    await waitFor(() => {
      expect(screen.getByText(/введите корректный email/i)).toBeInTheDocument();
    });
  });

  it('shows success toast on successful subscription', async () => {
    const user = userEvent.setup();
    render(<SubscribeForm />);

    const input = screen.getByLabelText(/email/i);
    const button = screen.getByRole('button', { name: /подписаться/i });

    await user.type(input, 'new@example.com');
    await user.click(button);

    await waitFor(() => {
      expect(toast.success).toHaveBeenCalledWith('Вы успешно подписались на рассылку');
    });

    // Форма очищена
    expect(input).toHaveValue('');
  });

  it('disables button during submission', async () => {
    const user = userEvent.setup();
    render(<SubscribeForm />);

    const input = screen.getByLabelText(/email/i);
    const button = screen.getByRole('button', { name: /подписаться/i });

    await user.type(input, 'test@example.com');
    await user.click(button);

    expect(button).toBeDisabled();
    expect(screen.getByText(/отправка/i)).toBeInTheDocument();
  });
});
```

### Design Tokens Application

**Spacing:** [Source: frontend/docs/design-system.json#foundations.spacing]
```typescript
sectionSpacing.default: 48px  // Между секциями
formVertical: 16px            // Между полями формы
cardGap: 16px                 // Между карточками новостей
```

**Typography:** [Source: frontend/docs/design-system.json#foundations.typography]
```typescript
title-m: 20px / 28px / 600    // Заголовки секций
body-l: 18px / 28px / 500     // Заголовки новостей
body-s: 14px / 20px / 500     // Описания новостей
caption: 12px / 16px / 500    // Даты
```

### Technical Constraints

1. **Email Validation:**
   - Client-side: React Hook Form regex pattern
   - Server-side: Backend должен также валидировать
   - Защита от spam: rate limiting на Backend (не в scope этой story)

2. **Image Optimization:**
   - Используем `next/image` для автоматической оптимизации
   - Lazy loading для изображений новостей
   - Fallback placeholder если image === null

3. **Accessibility:**
   - Label для email input
   - Error messages доступны screen readers
   - Toast notifications с proper ARIA attributes
   - Keyboard navigation для формы

4. **Performance:**
   - News data можно кэшировать на клиенте (SWR или React Query)
   - Debounce для email input (опционально)
   - Optimistic UI для subscribe (показать success до ответа сервера)

### File Structure

```
src/
├── app/
│   ├── page.tsx                      # Обновить: добавить SubscribeNewsSection
│   └── layout.tsx                    # Обновить: добавить Toaster provider
├── components/
│   ├── ui/                           # Из Epic 10
│   │   ├── Input.tsx
│   │   ├── Button.tsx
│   │   └── Card.tsx
│   └── home/
│       ├── HeroSection.tsx           # Из Story 11.1
│       ├── HitsSection.tsx           # Из Story 11.2
│       ├── NewArrivalsSection.tsx    # Из Story 11.2
│       ├── CategoriesSection.tsx     # Из Story 11.2
│       ├── SubscribeForm.tsx         # ← СОЗДАТЬ
│       ├── NewsSection.tsx           # ← СОЗДАТЬ
│       └── SubscribeNewsSection.tsx  # ← СОЗДАТЬ (wrapper)
├── services/
│   ├── api-client.ts                 # Из Epic 10
│   ├── subscribeService.ts           # ← СОЗДАТЬ
│   └── newsService.ts                # ← СОЗДАТЬ
├── types/
│   └── api.ts                        # Обновить: NewsItem, Subscribe типы
└── __mocks__/
    └── api/
        └── handlers.ts               # Обновить: subscribe, news handlers
```

## Change Log

| Date       | Version | Description                              | Author        |
|------------|---------|------------------------------------------|---------------|
| 2025-11-16 | 1.0     | Initial story creation                   | Bob (SM)      |

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
