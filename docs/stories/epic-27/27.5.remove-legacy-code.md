# Story 27.5: Remove Legacy Code

## Status

Ready for Review

---

## Story

**As a** developer,  
**I want** to remove deprecated code after verification period,  
**so that** codebase is clean and maintainable.

---

## Acceptance Criteria

1. Файл `processor.py` удалён (после подтверждения от DevOps что production использует новый код)
2. Файл `import_catalog_from_1c.py` удалён
3. Все импорты и ссылки на удалённые модули очищены
4. CI/CD pipeline успешно проходит без legacy кода
5. Документация обновлена — удалены упоминания legacy команд

---

## Tasks / Subtasks

- [ ] **Task 1: Pre-flight проверка** (AC: 1, 2)
  - [ ] 1.1 Убедиться что Stories 27.1-27.4 завершены
  - [ ] 1.2 Получить подтверждение от DevOps что production использует `import_products_from_1c`
  - [ ] 1.3 Проверить что все Celery tasks используют новую команду
  - [ ] 1.4 Проверить что Admin Panel использует новую архитектуру

- [ ] **Task 2: Удалить ProcessorDataProcessor** (AC: 1)
  - [ ] 2.1 Удалить файл `backend/apps/products/services/processor.py` (~1135 строк)
  - [ ] 2.2 Удалить импорты `ProductDataProcessor` во всех файлах
  - [ ] 2.3 Проверить что нет broken imports

- [ ] **Task 3: Удалить import_catalog_from_1c** (AC: 2)
  - [ ] 3.1 Удалить файл `backend/apps/products/management/commands/import_catalog_from_1c.py` (~595 строк)
  - [ ] 3.2 Удалить импорты из `import_products_from_1c.py` (L715-716)
  - [ ] 3.3 Удалить метод `_run_legacy_import()` из `import_products_from_1c.py`

- [ ] **Task 4: Очистить все ссылки** (AC: 3)
  - [ ] 4.1 Поиск всех упоминаний `processor.py` в коде
  - [ ] 4.2 Поиск всех упоминаний `import_catalog_from_1c` в коде
  - [ ] 4.3 Обновить или удалить найденные ссылки
  - [ ] 4.4 Обновить `__init__.py` файлы если нужно

- [ ] **Task 5: Удалить deprecated тесты** (AC: 3, 4)
  - [ ] 5.1 Удалить `tests/integration/test_management_commands/test_import_catalog_from_1c.py`
  - [ ] 5.2 Удалить или обновить тесты в `tests/integration/test_1c_import.py`
  - [ ] 5.3 Удалить или обновить тесты в `tests/integration/test_real_catalog_import.py`
  - [ ] 5.4 Удалить или обновить тесты в `tests/performance/test_import_performance.py`

- [ ] **Task 6: Проверить CI/CD** (AC: 4)
  - [ ] 6.1 Запустить `pytest backend/` локально
  - [ ] 6.2 Запустить `flake8` и `mypy` для проверки импортов
  - [ ] 6.3 Проверить Docker build
  - [ ] 6.4 Дождаться успешного CI/CD pipeline

- [ ] **Task 7: Финальная очистка документации** (AC: 5)
  - [ ] 7.1 Удалить упоминания `processor.py` из документации
  - [ ] 7.2 Удалить упоминания `import_catalog_from_1c` из документации
  - [ ] 7.3 Обновить CLAUDE.md и GEMINI.md
  - [ ] 7.4 Архивировать migration guide (переместить в docs/archive/)

---

## Dev Notes

### Existing System Integration

- **Files to delete:**
  - `backend/apps/products/services/processor.py` (~1135 lines)
  - `backend/apps/products/management/commands/import_catalog_from_1c.py` (~595 lines)
- **Total lines removed:** ~1730 lines

### Files Reference with Import Analysis

#### Files importing from `processor.py`

```bash
# Найти все импорты
grep -r "from apps.products.services.processor import" backend/
grep -r "from apps.products.services import.*processor" backend/
```

**Known imports:**

- `import_catalog_from_1c.py` L15: `from apps.products.services.processor import ProductDataProcessor`

#### Files importing from `import_catalog_from_1c`

```bash
grep -r "import_catalog_from_1c" backend/
```

**Known imports:**

- `import_products_from_1c.py` L715-716: conditional import for legacy fallback
- `apps/integrations/tasks.py` L114-147: Celery task calls (should be updated in Story 27.3)
- Multiple test files

### Pre-requisites Check

Before executing this story, verify:

1. **Story 27.1 Complete**: All methods migrated to `VariantImportProcessor`
2. **Story 27.2 Complete**: Image path normalization unified
3. **Story 27.3 Complete**: Celery tasks updated to use new command
4. **Story 27.4 Complete**: Deprecation warnings added

### DevOps Confirmation Template

```markdown
## Production Verification Request

Before removing legacy import code, please confirm:

- [ ] `import_products_from_1c` is used in production scripts
- [ ] `full_import.sh` uses new command
- [ ] Admin Panel triggers new command via Celery
- [ ] No external systems call `import_catalog_from_1c` directly

Signed off by: _______________
Date: _______________
```

### Deletion Commands

```bash
# Remove legacy processor
rm backend/apps/products/services/processor.py

# Remove legacy command
rm backend/apps/products/management/commands/import_catalog_from_1c.py

# Remove deprecated tests
rm backend/tests/integration/test_management_commands/test_import_catalog_from_1c.py

# Verify no broken imports
python -c "from apps.products.services.variant_import import VariantImportProcessor"
python -c "from apps.products.management.commands.import_products_from_1c import Command"
```

---

## Testing

### Verification Commands

```bash
# Check no broken imports
python manage.py check

# Run all tests
pytest backend/ -v

# Check for remaining references
grep -r "processor.py" backend/ --include="*.py"
grep -r "import_catalog_from_1c" backend/ --include="*.py"
grep -r "ProductDataProcessor" backend/ --include="*.py"

# Lint check
flake8 backend/apps/products/
mypy backend/apps/products/

# Docker build test
docker-compose build backend
```

---

## Risk Assessment

### Primary Risk

Удаление кода может сломать production если не все зависимости перенесены

### Mitigation

- Выполнять только после завершения Stories 27.1-27.4
- Получить явное подтверждение от DevOps
- Иметь git revert готовым к выполнению

### Rollback

```bash
# Revert deletion commits
git revert HEAD~N  # где N = количество коммитов для отката
```

---

## Definition of Done

- [ ] DevOps подтвердил использование нового кода в production
- [ ] `processor.py` удалён
- [ ] `import_catalog_from_1c.py` удалён
- [ ] Все broken imports исправлены
- [ ] Deprecated тесты удалены
- [ ] `pytest backend/` проходит без ошибок
- [ ] `flake8` и `mypy` проходят
- [ ] CI/CD pipeline успешен
- [ ] Документация очищена от legacy упоминаний

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-09 | 1.0 | Initial story draft | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
