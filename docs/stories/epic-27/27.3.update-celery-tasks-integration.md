# Story 27.3: Update Celery Tasks Integration

## Status

Draft

---

## Story

**As a** system administrator,  
**I want** Admin Panel to use the new import command,  
**so that** all import methods work through unified architecture.

---

## Acceptance Criteria

1. Функция `_execute_import_type()` в tasks.py вызывает `import_products_from_1c` для типа "catalog"
2. Параметры `--celery-task-id` передаются корректно для трекинга сессий
3. Все типы импорта (catalog, stocks, prices, images) работают через Admin UI
4. Интеграционный тест подтверждает работу всех типов импорта

---

## Tasks / Subtasks

- [ ] **Task 1: Анализ текущего состояния `_execute_import_type()`** (AC: 1, 2)
  - [ ] 1.1 Изучить файл `backend/apps/integrations/tasks.py`
  - [ ] 1.2 Документировать текущие вызовы legacy команды
  - [ ] 1.3 Проверить параметры передаваемые в команды

- [ ] **Task 2: Обновить вызов для типа "catalog"** (AC: 1, 2)
  - [ ] 2.1 Заменить `import_catalog_from_1c` на `import_products_from_1c` (L115-119)
  - [ ] 2.2 Убедиться что `--file-type=all` поддерживается новой командой
  - [ ] 2.3 Сохранить передачу `--celery-task-id` параметра
  - [ ] 2.4 Обновить log сообщение (L114)

- [ ] **Task 3: Обновить вызов для типа "stocks"** (AC: 1, 2)
  - [ ] 3.1 Заменить `import_catalog_from_1c` на `import_products_from_1c` (L132-136)
  - [ ] 3.2 Изменить `--file-type=rests` на соответствующий параметр новой команды
  - [ ] 3.3 Обновить log сообщение (L131)

- [ ] **Task 4: Обновить вызов для типа "prices"** (AC: 1, 2)
  - [ ] 4.1 Заменить `import_catalog_from_1c` на `import_products_from_1c` (L143-147)
  - [ ] 4.2 Изменить `--file-type=prices` на соответствующий параметр новой команды
  - [ ] 4.3 Обновить log сообщение (L140-141)

- [ ] **Task 5: Проверить совместимость параметров** (AC: 2)
  - [ ] 5.1 Изучить `import_products_from_1c.py` для проверки поддерживаемых параметров
  - [ ] 5.2 Убедиться что `--celery-task-id` работает в новой команде
  - [ ] 5.3 Проверить поддержку `--file-type` или альтернативных параметров

- [ ] **Task 6: Интеграционный тест через Admin UI** (AC: 3, 4)
  - [ ] 6.1 Создать/обновить тест `test_admin_import_catalog_type`
  - [ ] 6.2 Создать/обновить тест `test_admin_import_stocks_type`
  - [ ] 6.3 Создать/обновить тест `test_admin_import_prices_type`
  - [ ] 6.4 Создать/обновить тест `test_admin_import_images_type`

---

## Dev Notes

### Existing System Integration

- **Primary file:** `backend/apps/integrations/tasks.py`
- **Management commands:**
  - Legacy: `backend/apps/products/management/commands/import_catalog_from_1c.py`
  - New: `backend/apps/products/management/commands/import_products_from_1c.py`
- **Technology:** Django Celery, Django management commands

### Current State Analysis

#### File: `backend/apps/integrations/tasks.py`

**Функция `_execute_import_type()` (L98-170)** — точка входа для всех типов импорта.

| Тип импорта | Текущая команда | Новая команда | Строки |
|-------------|-----------------|---------------|--------|
| `catalog` | `import_catalog_from_1c --file-type=all` | `import_products_from_1c --file-type=all` | L114-119 |
| `stocks` | `import_catalog_from_1c --file-type=rests` | `import_products_from_1c --mode=stocks` (?) | L131-136 |
| `prices` | `import_catalog_from_1c --file-type=prices` | `import_products_from_1c --mode=prices` (?) | L140-147 |
| `images` | `_run_image_import()` (уже использует `VariantImportProcessor`) | ✅ OK | L155-158 |
| `variants` | `import_products_from_1c --variants-only` | ✅ OK | L160-167 |

### Code to Modify

#### Current (L113-148)

```python
if import_type == "catalog":
    logger.info(f"[Task {task_id}] Запуск import_catalog_from_1c --file-type=all")
    call_command(
        "import_catalog_from_1c",  # ← LEGACY
        "--file-type", "all",
        "--celery-task-id", task_id,
    )
    return {"type": "catalog", "message": "Каталог импортирован"}

# ... lines 121-129 ...

elif import_type == "stocks":
    logger.info(f"[Task {task_id}] Запуск import_catalog_from_1c --file-type=rests")
    call_command(
        "import_catalog_from_1c",  # ← LEGACY
        "--file-type", "rests",
        "--celery-task-id", task_id,
    )
    return {"type": "stocks", "message": "Остатки обновлены"}

elif import_type == "prices":
    logger.info(
        f"[Task {task_id}] Запуск import_catalog_from_1c --file-type=prices"
    )
    call_command(
        "import_catalog_from_1c",  # ← LEGACY
        "--file-type", "prices",
        "--celery-task-id", task_id,
    )
    return {"type": "prices", "message": "Цены обновлены"}
```

#### Target (after changes)

```python
if import_type == "catalog":
    logger.info(f"[Task {task_id}] Запуск import_products_from_1c --file-type=all")
    call_command(
        "import_products_from_1c",  # ← NEW
        "--file-type", "all",
        "--celery-task-id", task_id,
    )
    return {"type": "catalog", "message": "Каталог импортирован"}

# ... lines 121-129 ...

elif import_type == "stocks":
    logger.info(f"[Task {task_id}] Запуск import_products_from_1c --file-type=rests")
    call_command(
        "import_products_from_1c",  # ← NEW
        "--file-type", "rests",
        "--celery-task-id", task_id,
    )
    return {"type": "stocks", "message": "Остатки обновлены"}

elif import_type == "prices":
    logger.info(
        f"[Task {task_id}] Запуск import_products_from_1c --file-type=prices"
    )
    call_command(
        "import_products_from_1c",  # ← NEW
        "--file-type", "prices",
        "--celery-task-id", task_id,
    )
    return {"type": "prices", "message": "Цены обновлены"}
```

### Pre-requisite Check

Перед изменениями убедиться что `import_products_from_1c` поддерживает:

- `--file-type=all` — полный импорт каталога
- `--file-type=rests` — только остатки
- `--file-type=prices` — только цены
- `--celery-task-id` — ID задачи для трекинга

### Files to Update

| Файл | Изменение |
|------|-----------|
| `apps/integrations/tasks.py` | Заменить вызовы `import_catalog_from_1c` на `import_products_from_1c` |
| `tests/integration/test_async_import_tasks.py` | Обновить assertions |

---

## Testing

### Test Location

`backend/tests/integration/test_async_import_tasks.py`

### Testing Standards

- **Framework:** pytest с markers `@pytest.mark.integration`
- **Celery:** Использовать `celery_eager` mode для синхронного выполнения

### Test Cases

```python
import pytest
from unittest.mock import patch, MagicMock
from apps.integrations.tasks import _execute_import_type


@pytest.mark.integration
class TestExecuteImportType:
    """Интеграционные тесты для _execute_import_type() после миграции на новую команду"""
    
    @patch("apps.integrations.tasks.call_command")
    def test_catalog_import_uses_new_command(self, mock_call_command):
        """AC1: catalog тип вызывает import_products_from_1c"""
        result = _execute_import_type("catalog", "test-task-id")
        
        mock_call_command.assert_called_once_with(
            "import_products_from_1c",
            "--file-type", "all",
            "--celery-task-id", "test-task-id",
        )
        assert result["type"] == "catalog"
    
    @patch("apps.integrations.tasks.call_command")
    def test_stocks_import_uses_new_command(self, mock_call_command):
        """AC1: stocks тип вызывает import_products_from_1c"""
        result = _execute_import_type("stocks", "test-task-id")
        
        mock_call_command.assert_called_once_with(
            "import_products_from_1c",
            "--file-type", "rests",
            "--celery-task-id", "test-task-id",
        )
        assert result["type"] == "stocks"
    
    @patch("apps.integrations.tasks.call_command")
    def test_prices_import_uses_new_command(self, mock_call_command):
        """AC1: prices тип вызывает import_products_from_1c"""
        result = _execute_import_type("prices", "test-task-id")
        
        mock_call_command.assert_called_once_with(
            "import_products_from_1c",
            "--file-type", "prices",
            "--celery-task-id", "test-task-id",
        )
        assert result["type"] == "prices"
    
    @patch("apps.integrations.tasks.call_command")
    def test_celery_task_id_passed_correctly(self, mock_call_command):
        """AC2: celery-task-id передаётся корректно"""
        task_id = "abc-123-def-456"
        _execute_import_type("catalog", task_id)
        
        call_args = mock_call_command.call_args
        assert "--celery-task-id" in call_args[0] or "--celery-task-id" in call_args[1]
        assert task_id in str(call_args)
```

### Admin UI E2E Test (AC3)

```python
@pytest.mark.integration
class TestAdminImportUI:
    """Тесты через Admin UI (требуют running Celery worker в eager mode)"""
    
    @pytest.fixture
    def admin_client(self, admin_user, client):
        client.force_login(admin_user)
        return client
    
    def test_admin_trigger_catalog_import(self, admin_client, celery_eager):
        """AC3: Импорт catalog работает через Admin UI"""
        response = admin_client.post(
            "/admin/integrations/import/",
            {"import_types": ["catalog"]},
        )
        assert response.status_code in [200, 302]
        # Проверить что ImportSession создана
```

### Run Commands

```bash
# Интеграционные тесты для Celery tasks
pytest backend/tests/integration/test_async_import_tasks.py -v -m integration

# С mock'ами для call_command
pytest backend/tests/integration/test_async_import_tasks.py -v -k "execute_import"
```

---

## Risk Assessment

### Primary Risk

Несовместимость параметров между legacy и новой командой может привести к ошибкам импорта

### Mitigation

- Проверить поддержку всех параметров в `import_products_from_1c --help`
- Добавить fallback к legacy команде при ошибках (временно)
- Провести smoke test на staging перед production

### Rollback

Откатить изменения в `tasks.py` — вернуть вызовы `import_catalog_from_1c`

---

## Definition of Done

- [ ] `_execute_import_type("catalog")` вызывает `import_products_from_1c`
- [ ] `_execute_import_type("stocks")` вызывает `import_products_from_1c`
- [ ] `_execute_import_type("prices")` вызывает `import_products_from_1c`
- [ ] `--celery-task-id` передаётся корректно во всех вызовах
- [ ] Интеграционные тесты написаны и проходят
- [ ] Admin UI позволяет запускать все типы импорта
- [ ] Production smoke test пройден

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-09 | 1.0 | Initial story draft | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_To be filled by QA agent_
