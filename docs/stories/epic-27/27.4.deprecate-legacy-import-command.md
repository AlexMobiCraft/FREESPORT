# Story 27.4: Deprecate Legacy Import Command

## Status

Ready for Review

---

## Story

**As a** developer,  
**I want** to mark `import_catalog_from_1c` as deprecated,  
**so that** codebase has clear migration path.

---

## Acceptance Criteria

1. Команда `import_catalog_from_1c` выводит deprecation warning при запуске
2. Документация CLAUDE.md обновлена: указано использовать `import_products_from_1c`
3. Тесты для legacy команды помечены как `@pytest.mark.skip(reason="deprecated")`
4. README или CONTRIBUTING содержит инструкцию по миграции

---

## Tasks / Subtasks

- [x] **Task 1: Добавить deprecation warning в команду** (AC: 1)
  - [x] 1.1 Добавить `warnings.warn()` в начало метода `handle()` (L95)
  - [x] 1.2 Использовать `DeprecationWarning` с сообщением о миграции
  - [x] 1.3 Добавить вывод warning через `self.style.WARNING()`
  - [x] 1.4 Обновить docstring класса Command (L18-28)

- [x] **Task 2: Обновить CLAUDE.md** (AC: 2)
  - [x] 2.1 Найти раздел "1C Integration" в CLAUDE.md
  - [x] 2.2 Добавить note о deprecated статусе `import_catalog_from_1c`
  - [x] 2.3 Указать `import_products_from_1c` как рекомендуемую команду
  - [x] 2.4 Добавить примеры миграции

- [x] **Task 3: Обновить GEMINI.md** (AC: 2)
  - [x] 3.1 Синхронизировать изменения с CLAUDE.md
  - [x] 3.2 Обновить раздел импорта

- [x] **Task 4: Пометить тесты как deprecated** (AC: 3)
  - [x] 4.1 Найти все тесты для `import_catalog_from_1c`
  - [x] 4.2 Добавить `@pytest.mark.skip(reason="deprecated - use import_products_from_1c")`
  - [x] 4.3 Оставить комментарий о планируемом удалении в Story 27.5

- [x] **Task 5: Создать MIGRATION.md** (AC: 4)
  - [x] 5.1 Создать файл `docs/migration/import-commands-migration.md`
  - [x] 5.2 Документировать различия между командами
  - [x] 5.3 Добавить примеры миграции скриптов
  - [x] 5.4 Добавить ссылку в README.md

---

## Dev Notes

### Existing System Integration

- **Legacy command:** `backend/apps/products/management/commands/import_catalog_from_1c.py`
- **New command:** `backend/apps/products/management/commands/import_products_from_1c.py`
- **Documentation:** `CLAUDE.md`, `GEMINI.md`
- **Tests:** `backend/tests/integration/test_management_commands/test_import_catalog_from_1c.py`

### Code to Add

#### Deprecation Warning in `handle()` (L95-96)

```python
def handle(self, *args, **options):
    """Основная логика команды"""
    import warnings
    
    # Deprecation warning
    warnings.warn(
        "import_catalog_from_1c is deprecated and will be removed in Epic 27.5. "
        "Use 'import_products_from_1c' instead.",
        DeprecationWarning,
        stacklevel=2,
    )
    
    self.stdout.write(
        self.style.WARNING(
            "\n⚠️  DEPRECATED: Эта команда устарела и будет удалена.\n"
            "   Используйте 'python manage.py import_products_from_1c' вместо неё.\n"
            "   См. docs/migration/import-commands-migration.md для деталей.\n"
        )
    )
    
    from django.conf import settings
    # ... existing code ...
```

#### Updated Docstring (L18-28)

```python
class Command(BaseCommand):
    """
    DEPRECATED: Используйте `import_products_from_1c` вместо этой команды.
    
    Эта команда будет удалена в Story 27.5.
    
    Импорт каталога товаров из XML файлов 1С (CommerceML 3.1)

    Использование (DEPRECATED):
        python manage.py import_catalog_from_1c --data-dir /path/to/1c/data
        
    Рекомендуется (NEW):
        python manage.py import_products_from_1c --data-dir /path/to/1c/data
    """
```

### Test Files to Update

| Файл | Изменение |
|------|-----------|
| `tests/integration/test_management_commands/test_import_catalog_from_1c.py` | Add `@pytest.mark.skip` |
| `tests/integration/test_1c_import.py` | Add `@pytest.mark.skip` for legacy tests |
| `tests/integration/test_async_import_tasks.py` | Add `@pytest.mark.skip` for legacy calls |
| `tests/integration/test_real_catalog_import.py` | Add `@pytest.mark.skip` |
| `tests/performance/test_import_performance.py` | Add `@pytest.mark.skip` |

### Example Skip Decorator

```python
@pytest.mark.skip(reason="deprecated - command import_catalog_from_1c will be removed in Story 27.5")
class TestImportCatalogFrom1C:
    """Tests for legacy import_catalog_from_1c command"""
    ...
```

### Migration Documentation Template

```markdown
# Import Commands Migration Guide

## Overview

Starting from Epic 27, the legacy `import_catalog_from_1c` command is deprecated
in favor of the new `import_products_from_1c` command.

## Timeline

- **Current**: `import_catalog_from_1c` shows deprecation warning
- **Story 27.5**: `import_catalog_from_1c` will be removed

## Command Mapping

| Old Command | New Command |
|------------|-------------|
| `import_catalog_from_1c --file-type=all` | `import_products_from_1c --file-type=all` |
| `import_catalog_from_1c --file-type=rests` | `import_products_from_1c --file-type=rests` |
| `import_catalog_from_1c --file-type=prices` | `import_products_from_1c --file-type=prices` |

## Parameter Compatibility

All parameters from the legacy command are supported in the new command:
- `--data-dir`
- `--file-type`
- `--celery-task-id`
- `--skip-validation`
- `--skip-images`
- `--chunk-size`
- `--dry-run`
- `--clear-existing`
- `--skip-backup`

## Migration Steps

1. Replace all calls to `import_catalog_from_1c` with `import_products_from_1c`
2. Update any scripts or cron jobs
3. Update Celery tasks (done in Story 27.3)
4. Test thoroughly before removing legacy command
```

---

## Testing

### Test Location

No new tests required. This story focuses on marking existing tests as skipped.

### Verification

```bash
# Verify deprecation warning is shown
python manage.py import_catalog_from_1c --help 2>&1 | grep -i deprecated

# Verify tests are skipped
pytest backend/tests/integration/test_management_commands/test_import_catalog_from_1c.py -v
# Expected: all tests show SKIPPED

# Count skipped tests
pytest backend/tests/ -k "import_catalog" --collect-only | grep -c "skip"
```

---

## Risk Assessment

### Primary Risk

Пользователи могут не заметить deprecation warning и продолжить использовать legacy команду

### Mitigation

- Вывод яркого warning в stdout при каждом запуске
- Обновление документации
- Создание отдельного migration guide

### Rollback

Убрать deprecation warning — команда продолжит работать как раньше

---

## Definition of Done

- [x] Команда `import_catalog_from_1c` выводит deprecation warning
- [x] Docstring класса Command обновлён
- [x] CLAUDE.md обновлён
- [x] GEMINI.md синхронизирован
- [x] Все тесты legacy команды помечены как `@pytest.mark.skip`
- [x] Migration guide создан в `docs/migration/`
- [x] README.md содержит ссылку на migration guide

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-09 | 1.0 | Initial story draft | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Gemini 2.5 Pro (Antigravity)

### Debug Log References

Нет проблем, требующих отладки.

### Completion Notes List

- Добавлен Python `warnings.warn(DeprecationWarning)` в метод `handle()`
- Добавлен визуальный warning через `self.style.WARNING()` в stdout
- Обновлён docstring класса Command с указанием DEPRECATED статуса
- Помечены 4 тестовых класса как `@pytest.mark.skip`:
  - `TestImportCatalogCommand`
  - `TestOnecBrandIdImport`
  - `TestRealCatalogImport`
  - `TestImportPerformance`
- Создан migration guide в `docs/migration/import-commands-migration.md`
- Обновлены CLAUDE.md, GEMINI.md и README.md с ссылками на migration guide

### File List

| Файл | Изменение |
|------|--------|
| `backend/apps/products/management/commands/import_catalog_from_1c.py` | Добавлен deprecation warning и обновлён docstring |
| `backend/tests/integration/test_management_commands/test_import_catalog_from_1c.py` | Добавлен `@pytest.mark.skip` |
| `backend/tests/integration/test_1c_import.py` | Добавлен `@pytest.mark.skip` |
| `backend/tests/integration/test_real_catalog_import.py` | Добавлен `@pytest.mark.skip` |
| `backend/tests/performance/test_import_performance.py` | Добавлен `@pytest.mark.skip` |
| `docs/migration/import-commands-migration.md` | [NEW] Migration guide |
| `CLAUDE.md` | Обновлена секция 1С интеграции |
| `GEMINI.md` | Обновлена секция Integrations |
| `README.md` | Добавлена ссылка на migration guide |

---

## QA Results

_To be filled by QA agent_
