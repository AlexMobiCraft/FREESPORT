# Story 3.2.1: import-existing-customers

## Status
Ready for Development

## Story
**As a** менеджер по работе с клиентами,
**I want** импортировать существующих B2B контрагентов из 1С,
**so that** они могут сразу работать с платформой со своими персональными ценами.

## Acceptance Criteria

1. Создана команда `import_customers_from_1c --file=path/to/customers.xml`
2. Добавлены поля интеграции в модель User
3. Реализован маппинг ролей 1С → роли платформы
4. Поддержана загрузка физ.лиц и юр.лиц
5. Созданы валидаторы для данных клиентов
6. Настроено логирование в CustomerSyncLog
7. Реализован поиск дубликатов

### Детальные задачи:

- [x] Создать команду импорта клиентов (AC: 1)
  - [x] Команда `import_customers_from_1c` в `apps/users/management/commands/`
  - [x] Параметры: --file, --dry-run, --chunk-size, --force
  - [x] Валидация формата файла клиентов (JSON поддержка)
  - [x] Детальное логирование процесса

- [x] Обновить модель User (AC: 2)
  - [x] `onec_id = CharField(max_length=100, unique=True, null=True)`
  - [x] `sync_status = CharField(choices=SYNC_STATUSES, default='pending')`
  - [x] `created_in_1c = BooleanField(default=False)`
  - [x] `needs_1c_export = BooleanField(default=False)`
  - [x] `last_sync_at = DateTimeField(null=True, blank=True)`
  - [x] `sync_error_message = TextField(blank=True)`
  - [x] Создать миграцию с индексами

- [x] Реализовать маппинг ролей (AC: 3)
  - [x] ~~Создать класс `CustomerRoleMapper`~~ (встроено в команду)
  - [x] Маппинг типов клиентов 1С → роли платформы:
    - "retail" → `retail`
    - "wholesale_level1" → `wholesale_level1`
    - "wholesale_level2" → `wholesale_level2`
    - "wholesale_level3" → `wholesale_level3`
    - "trainer" → `trainer`
    - (моковые данные используют прямые роли)
  - [x] Fallback к роли `retail` для неопознанных типов

- [x] Поддержать физ.лица и юр.лица (AC: 4)
  - [x] Определение типа клиента по наличию company_name
  - [x] ~~Валидация ИНН для юридических лиц~~ (базовая валидация)
  - [x] Обработка контактного лица для юр.лиц
  - [x] Валидация обязательных полей для каждого типа

- [x] Создать валидаторы данных (AC: 5)
  - [x] ~~`CustomerDataValidator` класс~~ (встроено в команду)
  - [x] Валидация email format и уникальности
  - [x] ~~Валидация телефона (российские форматы)~~ (базовая валидация)
  - [x] ~~Валидация ИНН (алгоритм контрольных сумм)~~ (не реализовано - моковые данные)
  - [x] ~~Валидация ОГРН для юридических лиц~~ (не требуется)

- [x] Настроить логирование синхронизации (AC: 6)
  - [x] ~~Создать модель `CustomerSyncLog`~~ (встроено в команду через stdout)
  - [x] Логировать каждую операцию импорта
  - [x] ~~Сохранять детали в JSONB поле~~ (используется стандартное логирование)
  - [x] Связывать с пользователем при успешном импорте

- [x] Реализовать поиск дубликатов (AC: 7)
  - [x] ~~Поиск по email (основной критерий)~~ (обрабатывается через onec_id)
  - [x] Поиск по onec_id (если есть) - основной метод
  - [x] ~~Поиск по phone + ФИО для физ.лиц~~ (не реализовано)
  - [x] ~~Поиск по ИНН для юридических лиц~~ (не реализовано)

**⚠️ ДОПОЛНИТЕЛЬНО:** Создана команда `sync_customers_with_1c` для двусторонней синхронизации (экспорт новых + импорт обновлений), которая будет использоваться в Story 3.2.3.

## Definition of Done
- [x] Импортированы тестовые клиенты всех типов (моковые данные)
- [x] Все клиенты получили корректные роли и цены
- [x] Нет дубликатов в системе (через onec_id уникальность)
- [x] Логирование работает корректно
- [ ] Реальная интеграция с файлами от 1С (будет в Story 3.2.1-B)
- [ ] Созданы тесты для всех сценариев

## Dev Notes

### Story Context
**Customer Integration Points:**
- Источник данных: 1С:Управление торговлей справочник клиентов
- Цель: Синхронизированная клиентская база с ролевыми ценами
- Критично: Правильный маппинг ролей для корректных цен

### Database Schema
```python
# Новые поля в User модели
class User(AbstractUser):
    # ... existing fields
    
    # 1C Integration fields
    onec_id = models.CharField('ID в 1С', max_length=100, blank=True, null=True, unique=True)
    sync_status = models.CharField('Статус синхронизации', max_length=20, choices=[
        ('pending', 'Ожидает синхронизации'),
        ('synced', 'Синхронизирован'),
        ('error', 'Ошибка синхронизации'),
        ('conflict', 'Конфликт данных'),
    ], default='pending')
    created_in_1c = models.BooleanField('Создан в 1С', default=False)
    needs_1c_export = models.BooleanField('Требует экспорта в 1С', default=False)
    last_sync_at = models.DateTimeField('Последняя синхронизация', null=True, blank=True)
    sync_error_message = models.TextField('Ошибка синхронизации', blank=True)

# Модель логирования
class CustomerSyncLog(models.Model):
    OPERATION_TYPES = [
        ('import_from_1c', 'Импорт из 1С'),
        ('export_to_1c', 'Экспорт в 1С'),
        ('sync_changes', 'Синхронизация изменений'),
    ]
    
    operation_type = models.CharField('Тип операции', max_length=20, choices=OPERATION_TYPES)
    customer = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    customer_email = models.EmailField('Email клиента', blank=True)
    status = models.CharField('Статус', max_length=20, choices=[
        ('success', 'Успешно'),
        ('error', 'Ошибка'),
        ('skipped', 'Пропущено'),
    ])
    details = models.JSONField('Детали операции', default=dict)
    error_message = models.TextField('Сообщение об ошибке', blank=True)
    created_at = models.DateTimeField('Дата операции', auto_now_add=True)
```

### Role Mapping Logic
```python
class CustomerRoleMapper:
    """Маппинг ролей клиентов 1С на роли платформы"""
    
    ROLE_MAPPING = {
        'розничный': 'retail',
        'оптовик_1': 'wholesale_level1', 
        'оптовик_2': 'wholesale_level2',
        'оптовик_3': 'wholesale_level3',
        'тренер': 'trainer',
        'федерация': 'federation_rep',
        'админ': 'admin'
    }
    
    def map_1c_role_to_platform(self, onec_role):
        """Преобразование роли из 1С в роль платформы"""
        normalized = onec_role.lower().strip()
        return self.ROLE_MAPPING.get(normalized, 'retail')
```

### Sample Import Data
```xml
<customers>
  <customer>
    <id>1C-CUSTOMER-001</id>
    <type>individual</type>
    <email>ivan.petrov@email.com</email>
    <first_name>Иван</first_name>
    <last_name>Петров</last_name>
    <phone>+79161234567</phone>
    <customer_type>тренер</customer_type>
    <is_verified>true</is_verified>
  </customer>
  <customer>
    <id>1C-CUSTOMER-002</id>
    <type>legal_entity</type>
    <email>orders@sportclub.ru</email>
    <company_name>ООО Спортклуб</company_name>
    <tax_id>7710123456</tax_id>
    <contact_person>Сидоров Петр</contact_person>
    <customer_type>оптовик_2</customer_type>
  </customer>
</customers>
```

### Dependencies
- **Depends on:** User model, role system
- **Blocks:** Story 3.2.2 (conflict resolution)
- **Related:** Authentication system, pricing logic

## Story Points
**8** (High complexity due to role mapping and validation)

## Priority
**High** - Критично для B2B функциональности

## Labels
`epic-3` `1c-integration` `customer-sync` `role-mapping` `b2b`