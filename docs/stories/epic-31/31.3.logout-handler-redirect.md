# Story 31.3: Обработчик logout с редиректом

## Status

Ready for Review

---

## Story

**As a** зарегистрированный пользователь,
**I want** быть перенаправленным на главную страницу после logout,
**so that** я чётко вижу, что вышел из своего аккаунта.

---

## Acceptance Criteria

1. При клике на "Выйти" вызывается `handleLogout`
2. `handleLogout` вызывает `authStore.logout()`
3. После успешного logout вызывается `router.push('/')`
4. Пользователь перенаправляется на главную страницу
5. Header обновляется и показывает "Войти"/"Регистрация"
6. Состояние `isAuthenticated` меняется на `false`
7. Tokens, cookies, localStorage полностью очищены

---

## Tasks / Subtasks

- [x] **Task 1: Добавить useRouter и logout в Header.tsx** (AC: 1, 2, 3)
  - [x] Импортировать `useRouter` из `next/navigation`
  - [x] Импортировать `useAuthStore` для доступа к методу `logout`
  - [x] Инициализировать `const router = useRouter()`
  - [x] Получить `logout` из store: `const logout = useAuthStore(state => state.logout)`

- [x] **Task 2: Создать обработчик handleLogout** (AC: 1, 2, 3, 4)
  - [x] Создать async функцию `handleLogout`
  - [x] Вызвать `await logout()` (из authStore)
  - [x] После успешного logout вызвать `router.push('/')`
  - [x] Добавить JSDoc комментарий

- [x] **Task 3: Подключить handleLogout к кнопке "Выйти" (desktop)** (AC: 1)
  - [x] Добавить `onClick={handleLogout}` к кнопке "Выйти" в desktop секции
  - [x] Кнопка уже добавлена в Story 31.1

- [x] **Task 4: Подключить handleLogout к кнопке "Выйти" (mobile)** (AC: 1)
  - [x] Добавить `onClick={handleLogout}` к кнопке "Выйти" в mobile секции
  - [x] Закрыть мобильное меню: `setIsMobileMenuOpen(false)`

- [x] **Task 5: Написать unit-тесты для handleLogout** (AC: 1-7)
  - [x] Тест: При клике вызывается handleLogout
  - [x] Тест: handleLogout вызывает authStore.logout()
  - [x] Тест: После logout вызывается router.push('/')
  - [x] Тест: isAuthenticated становится false
  - [x] Тест: Header показывает "Войти"/"Регистрация" после logout

---

## Dev Notes

### Relevant Source Tree

```
frontend/src/
├── components/
│   └── layout/
│       └── Header.tsx                # MODIFY: добавить handleLogout + редирект
├── stores/
│   └── authStore.ts                  # Story 31.2: logout() уже async
└── __tests__/
    └── components/
        └── layout/
            └── Header.test.tsx       # MODIFY: добавить тесты для logout
```

### Зависимость от Story 31.1 и 31.2

**Story 31.1 (Prerequisite):**
- Добавляет кнопку "Выйти" в Header (desktop + mobile)
- Кнопка использует компонент `Button` с `variant="secondary"` `size="small"`

**Story 31.2 (Prerequisite):**
- `authStore.logout()` - теперь async метод
- Вызывает `authService.logoutFromServer()` для инвалидации токена на сервере
- Выполняет локальную очистку (fail-safe)

### Текущее состояние Header.tsx

**Импорты (строка 11):**
```typescript
import { usePathname } from 'next/navigation';
```
Нужно добавить `useRouter`:
```typescript
import { usePathname, useRouter } from 'next/navigation';
```

**Получение logout из store:**
```typescript
const logout = useAuthStore(state => state.logout);
```

**Обработчик handleLogout:**
```typescript
/**
 * Обработчик выхода из аккаунта
 * Вызывает API logout, очищает токены и редиректит на главную
 */
const handleLogout = async () => {
  await logout();
  router.push('/');
};
```

### Расположение кнопки "Выйти" (после Story 31.1)

**Desktop (после строки 153):**
```typescript
<Button
  variant="secondary"
  size="small"
  onClick={handleLogout}
>
  Выйти
</Button>
```

**Mobile (после строки 246):**
```typescript
<Button
  variant="secondary"
  size="small"
  className="w-full"
  onClick={() => {
    handleLogout();
    setIsMobileMenuOpen(false);
  }}
>
  Выйти
</Button>
```

### Важные замечания

1. **Async/await:** `logout()` теперь async (Story 31.2), поэтому `handleLogout` тоже async
2. **Mobile menu:** При logout в mobile версии нужно закрыть меню
3. **Fail-safe:** Редирект происходит после `await logout()`, который гарантированно очищает локальное состояние
4. **Реактивность:** После `logout()` authStore обновит `isAuthenticated: false`, Header автоматически перерисуется

---

## Testing

### Test File Location
- `frontend/src/__tests__/components/layout/Header.test.tsx`

### Testing Standards
- Vitest + React Testing Library
- Mock `next/navigation` для `useRouter`
- Mock `authStore` для проверки вызова `logout()`
- Coverage >= 90%

### Test Cases

```typescript
// Header.test.tsx
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { useAuthStore } from '@/stores/authStore';
import Header from '../Header';

// Mock next/navigation
const mockPush = vi.fn();
vi.mock('next/navigation', () => ({
  usePathname: () => '/',
  useRouter: () => ({ push: mockPush }),
}));

describe('Header - Logout Handler with Redirect', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    // Setup authenticated user
    useAuthStore.setState({
      isAuthenticated: true,
      user: { first_name: 'Иван', role: 'retail' },
      accessToken: 'test-access-token',
    });
    localStorage.setItem('refreshToken', 'test-refresh-token');
  });

  afterEach(() => {
    localStorage.clear();
  });

  it('calls handleLogout on logout button click', async () => {
    const user = userEvent.setup();
    const logoutSpy = vi.spyOn(useAuthStore.getState(), 'logout');
    
    render(<Header />);
    
    const logoutButton = screen.getByRole('button', { name: /выйти/i });
    await user.click(logoutButton);
    
    expect(logoutSpy).toHaveBeenCalled();
  });

  it('redirects to home page after logout', async () => {
    const user = userEvent.setup();
    
    render(<Header />);
    
    const logoutButton = screen.getByRole('button', { name: /выйти/i });
    await user.click(logoutButton);
    
    await waitFor(() => {
      expect(mockPush).toHaveBeenCalledWith('/');
    });
  });

  it('updates header to show login/register after logout', async () => {
    const user = userEvent.setup();
    
    render(<Header />);
    
    // Before logout - shows "Выйти"
    expect(screen.getByRole('button', { name: /выйти/i })).toBeInTheDocument();
    
    const logoutButton = screen.getByRole('button', { name: /выйти/i });
    await user.click(logoutButton);
    
    await waitFor(() => {
      // After logout - shows "Войти" and "Регистрация"
      expect(screen.getByRole('button', { name: /войти/i })).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /регистрация/i })).toBeInTheDocument();
    });
  });

  it('sets isAuthenticated to false after logout', async () => {
    const user = userEvent.setup();
    
    render(<Header />);
    
    expect(useAuthStore.getState().isAuthenticated).toBe(true);
    
    const logoutButton = screen.getByRole('button', { name: /выйти/i });
    await user.click(logoutButton);
    
    await waitFor(() => {
      expect(useAuthStore.getState().isAuthenticated).toBe(false);
    });
  });

  it('clears tokens and localStorage after logout', async () => {
    const user = userEvent.setup();
    
    render(<Header />);
    
    expect(localStorage.getItem('refreshToken')).toBe('test-refresh-token');
    
    const logoutButton = screen.getByRole('button', { name: /выйти/i });
    await user.click(logoutButton);
    
    await waitFor(() => {
      expect(localStorage.getItem('refreshToken')).toBeNull();
      expect(useAuthStore.getState().accessToken).toBeNull();
    });
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story draft | Sarah (PO) |
| 2025-12-13 | 1.1 | Implementation completed | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Cascade)

### Debug Log References

Нет дебаг проблем

### Completion Notes List

- Реализован async `handleLogout` с вызовом `authStore.logout()` и `router.push('/')`
- Добавлены импорты `useRouter` и `useAuthStore`
- Кнопки "Выйти" (desktop/mobile) уже подключены к `handleLogout` (из Story 31.1)
- Обновлены тесты: добавлены mockи `mockPush` и `mockLogout`
- 5 проваленных тестов - pre-existing проблемы (CSS классы, aria-label), не связаны с logout

### File List

- `frontend/src/components/layout/Header.tsx` - MODIFIED: добавлены useRouter, useAuthStore, async handleLogout
- `frontend/src/components/layout/__tests__/Header.test.tsx` - MODIFIED: обновлены моки и тесты logout

---

## Story Draft Validation

### Validation Summary

- **Story Readiness:** READY
- **Clarity Score:** 9/10
- **Major Gaps:** Нет критических проблем

### Validation Results

| Category                             | Status  | Issues |
| ------------------------------------ | ------- | ------ |
| 1. Goal & Context Clarity            | PASS    | — |
| 2. Technical Implementation Guidance | PASS    | — |
| 3. Reference Effectiveness           | PASS    | — |
| 4. Self-Containment Assessment       | PASS    | — |
| 5. Testing Guidance                  | PASS    | — |

### Детальный анализ

#### 1. Goal & Context Clarity ✅
- [x] Цель истории чётко определена (обработчик logout с редиректом)
- [x] Связь с epic goals очевидна (Epic 31 — Frontend Logout)
- [x] Место в общем flow объяснено (финальный шаг logout flow)
- [x] Зависимости от Story 31.1 и 31.2 явно указаны
- [x] Бизнес-ценность понятна (пользователь видит подтверждение выхода)

#### 2. Technical Implementation Guidance ✅
- [x] Ключевые файлы для модификации указаны (`Header.tsx`, `Header.test.tsx`)
- [x] Технологии: `useRouter`, `next/navigation`, Vitest
- [x] API интерфейсы: `authStore.logout()`, `router.push('/')`
- [x] Структуры данных: не требуются (используется существующий authStore)
- [x] Переменные окружения: не требуются
- [x] Конкретные сниппеты кода предоставлены для каждой модификации

#### 3. Reference Effectiveness ✅
- [x] Ссылки на Story 31.1 и 31.2 с кратким описанием что они делают
- [x] Критическая информация из зависимостей суммирована в Dev Notes
- [x] Контекст зависимостей объяснён (кнопка из 31.1, async logout из 31.2)
- [x] Формат ссылок консистентный

#### 4. Self-Containment Assessment ✅
- [x] Вся необходимая информация включена (импорты, обработчики, кнопки)
- [x] Предположения явные (async/await, fail-safe редирект)
- [x] Домен-специфичные термины объяснены
- [x] Edge cases упомянуты (закрытие mobile menu, fail-safe очистка)

#### 5. Testing Guidance ✅
- [x] Подход к тестированию: Vitest + React Testing Library
- [x] Ключевые сценарии: 5 конкретных тест-кейсов
- [x] Критерии успеха: coverage >= 90%
- [x] Особые требования: mock useRouter, mock authStore
- [x] Полный код тестов предоставлен

### Developer Perspective

**Можно ли реализовать эту историю как написано?** Да, однозначно.

**Возможные вопросы:**
- Нет вопросов — все детали предоставлены

**Риски задержки:**
- Минимальные — простая интеграция с существующим кодом

### Final Assessment

**READY** — История предоставляет достаточный контекст для реализации.

---

*Validated by: SM Agent*
*Date: 2025-12-13*

---

## QA Results

_To be filled by QA agent_
