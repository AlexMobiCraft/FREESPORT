# Story 31.1: Добавление кнопки "Выйти" в Header компонент

## Status

Ready for Review

---

## Story

**As a** зарегистрированный пользователь,
**I want** видеть кнопку "Выйти" в header,
**so that** я могу выйти из своего аккаунта.

---

## Acceptance Criteria

1. Кнопка "Выйти" видна только для авторизованных пользователей (`isAuthenticated === true`)
2. Кнопка НЕ видна для неавторизованных пользователей
3. Desktop версия: кнопка расположена после кнопки "Профиль" в правой части Header
4. Mobile версия: кнопка расположена в мобильном меню после кнопки "Профиль"
5. Использован компонент `Button` с `variant="secondary"` и `size="small"`
6. При клике вызывается обработчик `handleLogout`

---

## Tasks / Subtasks

- [x] **Task 1: Добавить кнопку "Выйти" в desktop версию Header** (AC: 1, 2, 3, 5)
  - [x] Добавить кнопку `Button` с `variant="secondary"` и `size="small"` после кнопки "Профиль"
  - [x] Добавить `data-testid="logout-button"` для тестирования
  - [x] Добавить `aria-label="Выйти из аккаунта"` для accessibility
  - [x] Визуально отделить кнопку от "Профиль" (gap)
  - [x] Кнопка отображается только при `isAuthenticated && user`

- [x] **Task 2: Добавить кнопку "Выйти" в mobile версию Header** (AC: 1, 2, 4, 5)
  - [x] Добавить кнопку `Button` в мобильное меню после кнопки "Профиль"
  - [x] Добавить `data-testid="logout-button-mobile"` для тестирования
  - [x] Добавить `aria-label="Выйти из аккаунта"` для accessibility
  - [x] Использовать `className="w-full"` для full-width стиля
  - [x] Добавить `onClick={() => setIsMobileMenuOpen(false)}` для закрытия меню

- [x] **Task 3: Создать обработчик handleLogout** (AC: 6)
  - [x] Создать функцию `handleLogout` в компоненте Header
  - [x] Пока функция - placeholder (`console.log('Logout clicked')`)
  - [x] В Story 31.3 будет добавлена реальная логика с `authStore.logout()` и редиректом

- [x] **Task 4: Написать unit-тесты для кнопки "Выйти"** (AC: 1-6)
  - [x] Тест: кнопка "Выйти" отображается для авторизованных пользователей (desktop)
  - [x] Тест: кнопка "Выйти" отображается для авторизованных пользователей (mobile)
  - [x] Тест: кнопка "Выйти" НЕ отображается для неавторизованных пользователей
  - [x] Тест: при клике вызывается `handleLogout`
  - [x] Тест: при клике на mobile кнопку закрывается мобильное меню

---

## Dev Notes

### Relevant Source Tree

```
frontend/src/
├── components/
│   └── layout/
│       ├── Header.tsx                 # MODIFY: добавить кнопку "Выйти"
│       └── __tests__/
│           └── Header.test.tsx        # MODIFY: добавить тесты для logout button
├── stores/
│   └── authStore.ts                   # READ: использует authSelectors.useIsAuthenticated()
└── components/ui/
    └── Button/                        # USE: Button component
```

### Integration Context

**Существующий код Header.tsx:**
- Уже использует `authSelectors.useIsAuthenticated()` и `authSelectors.useUser()`
- Кнопка "Профиль" уже отображается для авторизованных пользователей
- Мобильное меню уже поддерживает аутентификацию

**Точки интеграции:**
- Desktop секция: строки 142-169 (`{/* Авторизация/Профиль (desktop) */}`)
- Mobile секция: строки 236-262 (`{/* Авторизация (mobile) */}`)

**Компонент Button props:**
- `variant="secondary"` - вторичный стиль кнопки
- `size="small"` - маленький размер
- `onClick` - обработчик клика

**Важно:**
- Кнопка "Выйти" должна быть после кнопки "Профиль"
- Использовать `gap-2` для визуального отделения кнопок (уже есть в коде)
- `handleLogout` пока placeholder - реальная логика в Story 31.3

---

## Testing

### Test File Location
`frontend/src/components/layout/__tests__/Header.test.tsx`

### Testing Standards
- Vitest + React Testing Library
- MSW для API mocking (не нужен для этой story)
- Coverage >= 80%

### Test IDs
- `data-testid="logout-button"` - desktop кнопка
- `data-testid="logout-button-mobile"` - mobile кнопка

### Test Cases

```typescript
// Пример тестов для добавления в Header.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { vi } from 'vitest';
import { useAuthStore } from '@/stores/authStore';
import Header from '../Header';

describe('Header - Logout Button', () => {
  it('shows logout button for authenticated users (desktop)', () => {
    // Setup authenticated state
    useAuthStore.setState({
      isAuthenticated: true,
      user: { first_name: 'Иван', role: 'retail' },
    });
    
    render(<Header />);
    expect(screen.getByTestId('logout-button')).toBeInTheDocument();
  });

  it('shows logout button for authenticated users (mobile)', () => {
    // Setup authenticated state + open mobile menu
    useAuthStore.setState({
      isAuthenticated: true,
      user: { first_name: 'Иван', role: 'retail' },
    });
    
    render(<Header />);
    // Open mobile menu
    fireEvent.click(screen.getByLabelText('Открыть меню'));
    
    expect(screen.getByTestId('logout-button-mobile')).toBeInTheDocument();
  });

  it('does NOT show logout button for unauthenticated users', () => {
    useAuthStore.setState({
      isAuthenticated: false,
      user: null,
    });
    
    render(<Header />);
    expect(screen.queryByTestId('logout-button')).not.toBeInTheDocument();
  });

  it('calls handleLogout on button click', async () => {
    useAuthStore.setState({
      isAuthenticated: true,
      user: { first_name: 'Иван', role: 'retail' },
    });
    
    const consoleSpy = vi.spyOn(console, 'log');
    render(<Header />);
    
    await userEvent.click(screen.getByTestId('logout-button'));
    expect(consoleSpy).toHaveBeenCalledWith('Logout clicked');
    consoleSpy.mockRestore();
  });

  it('closes mobile menu when logout button is clicked', async () => {
    useAuthStore.setState({
      isAuthenticated: true,
      user: { first_name: 'Иван', role: 'retail' },
    });
    
    render(<Header />);
    
    // Открыть мобильное меню
    fireEvent.click(screen.getByLabelText('Открыть меню'));
    expect(screen.getByTestId('logout-button-mobile')).toBeInTheDocument();
    
    // Кликнуть на кнопку выхода
    await userEvent.click(screen.getByTestId('logout-button-mobile'));
    
    // Меню должно закрыться
    expect(screen.queryByTestId('logout-button-mobile')).not.toBeInTheDocument();
  });
});
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-13 | 1.0 | Initial story draft | Sarah (PO) |
| 2025-12-13 | 1.1 | Added aria-label, test imports, mobile menu close test | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Cascade)

### Debug Log References

Нет ошибок или проблем при реализации.

### Completion Notes List

- Добавлена кнопка "Выйти" в desktop версию Header (после кнопки "Профиль")
- Добавлена кнопка "Выйти" в mobile версию Header (с закрытием меню при клике)
- Создан placeholder handleLogout с console.log (реальная логика в Story 31.3)
- Добавлены 5 unit-тестов для кнопки "Выйти" - все тесты проходят
- ESLint проверка пройдена без ошибок
- Примечание: 5 предсуществующих тестов в секциях Styling/Cart Badge провалены (не связаны с этой story)

### File List

| File | Action |
|------|--------|
| `frontend/src/components/layout/Header.tsx` | MODIFIED |
| `frontend/src/components/layout/__tests__/Header.test.tsx` | MODIFIED |

---

## QA Results

_To be filled by QA agent_
