# Story 14.2: Import Attributes from 1C (Reference Data) & Admin UI

## Status

Ready for development

## Story

**As a** Content Manager,
**I want** attributes to be automatically imported from 1C and visible in the Admin UI,
**so that** I can verify the data quality and manage attributes.

## Acceptance Criteria

1. Реализован парсер файлов `propertiesGoods/*.xml` и `propertiesOffers/*.xml`.
2. Скрипт импорта создает/обновляет записи в `Attribute` и `AttributeValue`.
3. Реализована дедупликация по `onec_id`.
4. В Django Admin реализован удобный интерфейс для просмотра загруженных атрибутов (списки, фильтры, поиск).
5. В админке отображается статистика по количеству значений для каждого атрибута.

## Tasks / Subtasks

- [ ] Create `AttributeImportService` in `apps/products/services/attribute_import.py`
- [ ] Create management command `import_attributes` to trigger the service manually
- [ ] Implement XML parsing logic for `propertiesGoods/*.xml`
- [ ] Implement XML parsing logic for `propertiesOffers/*.xml`
- [ ] Implement `update_or_create` logic using `onec_id` for Attributes
- [ ] Implement `update_or_create` logic using `onec_id` for AttributeValues
- [ ] Add admin list views and filters in `apps/products/admin.py`
- [ ] Add computed field/method in Admin to show value count per attribute

## Dev Notes

- **Dependencies:** This story depends on the completion of **Story 14.1 (Attribute Models)**.
- **File Structure:** `apps/products/services/attribute_import.py`
- **Input:** XML files located in `propertiesGoods/` and `propertiesOffers/` directories (relative to import root).
- **Logic:**
  - **Security:** Use `defusedxml` or configure the XML parser to forbid entity expansion to prevent XXE attacks.
  - Parse XML to extract property definitions and their allowed values.
  - Map XML fields to Model fields.
  - Ensure idempotency: running the import multiple times should not create duplicates.
- **Admin UI:**
  - Use `list_display`, `list_filter`, `search_fields`.

## XML Examples

**Structure of `propertiesGoods/*.xml` and `propertiesOffers/*.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<КоммерческаяИнформация xmlns="urn:1C.ru:commerceml_3" ...>
    <Классификатор>
        <Свойства>
            <!-- Example of a Directory (List) Type Property -->
            <Свойство>
                <Ид>511f0999-7fbe-11ea-81c1-00155d3cae02</Ид>
                <Наименование>Цвет</Наименование>
                <ТипЗначений>Справочник</ТипЗначений>
                <ВариантыЗначений>
                    <Справочник>
                        <ИдЗначения>8d71abe5-8f3b-11ea-81c1-00155d3cae02</ИдЗначения>
                        <Значение>Белый</Значение>
                    </Справочник>
                    <Справочник>
                        <ИдЗначения>8d71abe4-8f3b-11ea-81c1-00155d3cae02</ИдЗначения>
                        <Значение>Желтый</Значение>
                    </Справочник>
                </ВариантыЗначений>
            </Свойство>
            
            <!-- Example of a Number Type Property -->
            <Свойство>
                <Ид>ea034d96-b7aa-11ed-9805-fa163edba792</Ид>
                <Наименование>Высота (см)</Наименование>
                <ТипЗначений>Число</ТипЗначений>
            </Свойство>
        </Свойства>
    </Классификатор>
</КоммерческаяИнформация>
```

## Testing

- **Location:** `backend/apps/products/tests/test_attribute_import.py`
- **Standards:**
  - Use `pytest` with `pytest-django`.
  - Use `Factory Boy` for test data generation.
  - **Markers:**
    - Use `@pytest.mark.unit` for isolated parser logic tests (mocking XML).
    - Use `@pytest.mark.integration` and `@pytest.mark.django_db` for database interaction tests (create/update models).
  - **Mocking:** Use `unittest.mock` or `pytest-mock` to simulate file reading if needed.
  - **Coverage:** Aim for >90% coverage for this critical import logic.
- **Test Cases:**
  1. **XML Parsing (Unit)**:
      - Parse sample `propertiesGoods.xml` -> verify extracted data structure.
      - Parse sample `propertiesOffers.xml` -> verify extracted data structure.
      - Test handling of malformed XML (should raise appropriate error).
  2. **Attribute Creation (Integration)**:
      - Run import with new attributes -> verify `Attribute` and `AttributeValue` records created.
      - Verify `onec_id` mapping is correct.
      - Verify `slug` generation works as expected.
  3. **Deduplication (Integration)**:
      - Run import twice with same data -> verify count of records remains same (idempotency).
      - Run import with updated value -> verify value is updated, not duplicated.
  4. **Admin UI (Integration)**:
      - Verify `AttributeAdmin` list view loads correctly.
      - Verify filters in admin work.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Added dependency on Story 14.1 and XML examples | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-
