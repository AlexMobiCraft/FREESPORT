# Story 14.1: Attribute Models & Infrastructure

## Status

Ready for development

## Story

**As a** Developer,
**I want** to create database models for storing product attributes,
**so that** we can store structured data from 1C.

## Acceptance Criteria

1. **Attribute Model**:
   - Model `Attribute` exists with fields: `name`, `slug`, `onec_id`, `type`.
   - `slug` is automatically generated from `name` using transliteration (Cyrillic support).
   - `onec_id` is unique.

2. **AttributeValue Model**:
   - Model `AttributeValue` exists with fields: `attribute` (FK), `value`, `slug`, `onec_id`.
   - `slug` is automatically generated from `value` using transliteration.
   - `onec_id` is unique.

3. **Relationships**:
   - `Product` has a Many-to-Many field `attributes` linking to `AttributeValue`.
   - `ProductVariant` has a Many-to-Many field `attributes` linking to `AttributeValue`.

4. **Admin Interface**:
   - `Attribute` and `AttributeValue` are registered in Django Admin.
   - Search by `name` and `onec_id` is enabled.
   - Filters by `attribute` (for values) are enabled.

5. **Migrations**:
   - Database migrations are created and applied without errors.

## Tasks / Subtasks

- [ ] Define `Attribute` model in `apps/products/models.py`
  - [ ] Fields: `name` (CharField), `slug` (SlugField), `onec_id` (CharField, unique), `type` (CharField/ChoiceField)
  - [ ] Implement `save()` method for slug generation (translit + slugify)
- [ ] Define `AttributeValue` model in `apps/products/models.py`
  - [ ] Fields: `attribute` (ForeignKey), `value` (CharField/TextField), `slug` (SlugField), `onec_id` (CharField, unique)
  - [ ] Implement `save()` method for slug generation
- [ ] Add M2M fields to `Product` and `ProductVariant`
  - [ ] `Product.attributes` -> `AttributeValue`
  - [ ] `ProductVariant.attributes` -> `AttributeValue`
- [ ] Register models in `apps/products/admin.py`
  - [ ] `AttributeAdmin` with search/list_display
  - [ ] `AttributeValueAdmin` with search/list_display/filters
- [ ] Create and run migrations

## Dev Notes

- **File Structure:** `apps/products/models.py`
- **Slug Generation:**
  - Do NOT use `django-autoslug`.
  - Use the project standard pattern: `transliterate` + `django.utils.text.slugify` in the `save()` method.
  - Refer to `Brand` or `Category` models in `apps/products/models.py` for the exact implementation.
- **Models:**
  - `Attribute`: Represents a property type (e.g., "Color", "Material").
  - `AttributeValue`: Represents a specific value for a property (e.g., "Red", "Cotton").
- **Relations:**
  - `Product` has a Many-to-Many relationship with `AttributeValue`.
  - `ProductVariant` has a Many-to-Many relationship with `AttributeValue`.
- **Constraints:**
  - `onec_id` should be unique to allow reliable syncing and deduplication.

## Testing

- **Location:** `backend/tests/products/test_models.py`
- **Standards:**
  - Use `pytest` and `factory_boy`.
- **Test Cases:**
  1. **Attribute Creation**:
     - Create `Attribute` with Cyrillic name.
     - Verify `slug` is correctly transliterated and slugified.
     - Verify `str()` representation.
  2. **AttributeValue Creation**:
     - Create `AttributeValue` with Cyrillic value.
     - Verify `slug` is generated correctly.
  3. **Uniqueness**:
     - Attempt to create two Attributes with same `onec_id` -> expect IntegrityError.
  4. **Relationships**:
     - Create `Product` and `AttributeValue`.
     - Add value to `product.attributes`.
     - Verify `product.attributes.all()` contains the value.
     - Repeat for `ProductVariant`.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Updated slug generation specs and testing plan | Bob (SM) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-
