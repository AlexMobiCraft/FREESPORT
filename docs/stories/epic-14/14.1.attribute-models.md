# Story 14.1: Attribute Models & Infrastructure

## Status

Done

## Story

**As a** Developer,
**I want** to create database models for storing product attributes,
**so that** we can store structured data from 1C.

## Acceptance Criteria

1. **Attribute Model**:
   - Model `Attribute` exists with fields: `name`, `slug`, `onec_id`, `type`.
   - `slug` is automatically generated from `name` using transliteration (Cyrillic support).
   - `onec_id` is unique.

2. **AttributeValue Model**:
   - Model `AttributeValue` exists with fields: `attribute` (FK), `value`, `slug`, `onec_id`.
   - `slug` is automatically generated from `value` using transliteration.
   - `onec_id` is unique.

3. **Relationships**:
   - `Product` has a Many-to-Many field `attributes` linking to `AttributeValue`.
   - `ProductVariant` has a Many-to-Many field `attributes` linking to `AttributeValue`.

4. **Admin Interface**:
   - `Attribute` and `AttributeValue` are registered in Django Admin.
   - Search by `name` and `onec_id` is enabled.
   - Filters by `attribute` (for values) are enabled.

5. **Migrations**:
   - Database migrations are created and applied without errors.

## Tasks / Subtasks

- [ ] Define `Attribute` model in `apps/products/models.py`
  - [ ] Fields:
    - `name` (CharField, max_length=255)
    - `slug` (SlugField, unique=True, db_index=True)
    - `onec_id` (CharField, max_length=255, unique=True, db_index=True)
    - `type` (CharField, max_length=50, blank=True) - тип атрибута для будущей логики фильтрации
  - [ ] Implement `save()` method for slug generation (translit + slugify)
- [ ] Define `AttributeValue` model in `apps/products/models.py`
  - [ ] Fields:
    - `attribute` (ForeignKey to Attribute, on_delete=CASCADE, related_name='values')
    - `value` (CharField, max_length=255)
    - `slug` (SlugField, db_index=True)
    - `onec_id` (CharField, max_length=255, unique=True, db_index=True)
  - [ ] Implement `save()` method for slug generation (translit + slugify)
- [ ] Add M2M fields to `Product` and `ProductVariant`
  - [ ] `Product.attributes` -> `AttributeValue` (direct M2M, no through table)
  - [ ] `ProductVariant.attributes` -> `AttributeValue` (direct M2M, no through table)
- [ ] Register models in `apps/products/admin.py`
  - [ ] `AttributeAdmin` with search/list_display
  - [ ] `AttributeValueAdmin` with search/list_display/filters
- [ ] Create and run migrations

## Dev Notes

- **File Structure:** `apps/products/models.py`
- **Slug Generation:**
  - Use the project standard pattern: `transliterate` + `django.utils.text.slugify` in the `save()` method.
  - Refer to `Brand` or `Category` models in `apps/products/models.py` for the exact implementation.
- **Type Hints:**
  - Все методы моделей должны быть полностью типизированы согласно `docs/architecture/coding-standards.md`.
  - Используйте `from __future__ import annotations` и `from typing import TYPE_CHECKING, Any`
  - Пример: `def save(self, *args: Any, **kwargs: Any) -> None:`
  - `def __str__(self) -> str:`
- **Models:**
  - `Attribute`: Represents a property type (e.g., "Цвет", "Материал", "Размер").
  - `AttributeValue`: Represents a specific value for a property (e.g., "Красный", "Хлопок", "XL").
  - **Examples:**
    - Attribute "Цвет" → AttributeValue ["Красный", "Синий", "Зелёный"]
    - Attribute "Размер" → AttributeValue ["S", "M", "L", "XL"]
    - Attribute "Материал" → AttributeValue ["Хлопок", "Полиэстер", "Нейлон"]
- **Relations:**
  - `Product` has a Many-to-Many relationship with `AttributeValue` (direct M2M, no through table).
  - `ProductVariant` has a Many-to-Many relationship with `AttributeValue` (direct M2M, no through table).
- **Constraints:**
  - `onec_id` should be unique to allow reliable syncing and deduplication.
- **Performance:**
  - Add `db_index=True` to frequently filtered fields: `onec_id`, `slug`.

## Testing

- **Location:** `backend/tests/unit/test_products/test_attribute_models.py`
- **Standards:**
  - Use `pytest` and `factory_boy` (см. `docs/architecture/coding-standards.md`).
- **Isolation:**
  - Использовать `get_unique_suffix()` из `backend/tests/utils.py` для уникальных значений.
  - Полагаться на autouse фикстуру `db_cleanup` из `backend/tests/conftest.py`.
  - Маркировать тесты: `@pytest.mark.unit`.
- **Test Cases:**
  1. **Attribute Creation**:
     - Create `Attribute` with Cyrillic name using unique suffix.
     - Verify `slug` is correctly transliterated and slugified.
     - Verify `str()` representation.
  2. **AttributeValue Creation**:
     - Create `AttributeValue` with Cyrillic value using unique suffix.
     - Verify `slug` is generated correctly.
     - Verify FK relationship to `Attribute`.
  3. **Uniqueness**:
     - Attempt to create two Attributes with same `onec_id` -> expect IntegrityError.
     - Attempt to create two AttributeValues with same `onec_id` -> expect IntegrityError.
  4. **Relationships**:
     - Create `Product` and `AttributeValue`.
     - Add value to `product.attributes`.
     - Verify `product.attributes.all()` contains the value.
     - Repeat for `ProductVariant`.
  5. **Type Hints Validation**:
     - Verify all model methods have proper type annotations.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Updated slug generation specs and testing plan | Bob (SM) |
| 2025-12-03 | 1.2 | Fixed test paths, added type hints requirements, clarified M2M structure, added isolation standards | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-

## Dev Agent Record Update (2025-12-03)

### Agent Model Used

- Claude Sonnet 4.5 (model ID: claude-sonnet-4-5-20250929)

### Completion Notes List

- ✅ Created Attribute model with full typization and slug auto-generation
- ✅ Created AttributeValue model with FK to Attribute
- ✅ Added M2M fields to Product and ProductVariant models
- ✅ Registered both models in Django Admin with search/filter functionality
- ✅ Wrote comprehensive unit tests (test_attribute_models.py)
- ⚠️ Migrations require Docker environment to be started

### File List

- `backend/apps/products/models.py` - Added Attribute and AttributeValue models (lines 978-1127)
- `backend/apps/products/models.py` - Added attributes M2M to Product (lines 388-394)
- `backend/apps/products/models.py` - Added attributes M2M to ProductVariant (lines 906-912)
- `backend/apps/products/admin.py` - Added AttributeAdmin and AttributeValueAdmin (lines 491-513)
- `backend/tests/unit/test_models/test_attribute_models.py` - New file with comprehensive tests

### Debug Log

- Flake8 linting passed after fixing line length issue
- Python syntax validation passed for all modified files
- Migrations creation blocked - requires Docker to be running

### Next Steps

1. Start Docker environment: `cd docker && docker compose up -d`
2. Create migrations: `docker compose exec backend python manage.py makemigrations products`
3. Apply migrations: `docker compose exec backend python manage.py migrate`
4. Run unit tests: `docker compose -f docker/docker-compose.test.yml run --rm backend pytest tests/unit/test_models/test_attribute_models.py -v`

## QA Results

### Review Date: 2025-12-04 (Обновлено: 2025-12-04 05:05 UTC)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Реализация высокого качества с полным соответствием стандартам проекта. Модели корректно определены с полной типизацией и документацией. Логика генерации slug обрабатывает edge cases (кириллица, дубликаты) через fallback механизмы. Admin интерфейсы хорошо сконфигурированы.

**Тестовое покрытие:** 79% (превышает минимум 70%)
**Тесты:** 13/13 passed ✅
**Линтинг:** Flake8 PASS ✅
**Типизация:** mypy PASS (после рефакторинга) ✅

### Refactoring Performed

Во время обзора проведён рефакторинг для устранения проблем качества кода:

- **File**: `apps/products/models.py:388`
  - **Change**: Добавлена явная типизация `attributes: models.ManyToManyField`
  - **Why**: Устранение mypy ошибки "Need type annotation for 'attributes'"
  - **How**: Явная аннотация типа для M2M поля повышает статическую проверку типов

- **File**: `apps/products/models.py:906`
  - **Change**: Добавлена типизация `attributes: models.ManyToManyField` для ProductVariant
  - **Why**: Консистентность типизации и устранение mypy ошибки
  - **How**: Консистентная типизация M2M полей во всех моделях проекта

- **File**: `apps/products/models.py:255-258, 371-374, 911-914, 948-952`
  - **Change**: Разбиты длинные строки (E501) в help_text и docstrings
  - **Why**: Flake8 E501 - строки превышали лимит 89 символов (Black standard)
  - **How**: Многострочные tuple для help_text, переформатированные docstrings

### Compliance Check

- Coding Standards: [✓] Полное соответствие Black, Flake8, isort
- Project Structure: [✓] Модели в правильном месте, тесты структурированы
- Testing Strategy: [✓] pytest + factory_boy + изоляция через get_unique_suffix()
- All ACs Met: [✓] Все 5 acceptance criteria покрыты тестами

### Improvements Checklist

- [x] Добавлена типизация M2M полей (apps/products/models.py:388, 906)
- [x] Исправлены длинные строки для соответствия Flake8 E501
- [x] Проверена генерация slug для кириллических имён
- [x] Проверены M2M relationships (Product/ProductVariant ↔ AttributeValue)
- [x] Проверены uniqueness constraints (onec_id)
- [x] Все тесты проходят после рефакторинга (13/13)
- [ ] Рассмотреть добавление choices для поля Attribute.type (future)
- [ ] Добавить интеграционные тесты импорта из 1С (следующие stories)

### Security Review

Специфических угроз безопасности не обнаружено. Применяются стандартные Django защиты:
- Уникальность `onec_id` предотвращает дубликаты и коллизии
- Валидация на уровне модели через `clean()` методы
- Автоматическая транслитерация для безопасных URL-slug

### Performance Considerations

**Оптимизация запросов:**
- `db_index=True` корректно применен к `slug` и `onec_id` для быстрого поиска
- Composite index на `(attribute, value)` для AttributeValue (line 1125-1127)
- Ordering в Meta классах для предсказуемых результатов запросов

**Покрытие тестами:** 79% - превышает минимальный порог 70%

### Files Modified During Review

- `apps/products/models.py` - добавлена типизация M2M полей, исправлены длинные строки

**ПРИМЕЧАНИЕ:** Разработчику следует обновить File List в Dev Agent Record с информацией о рефакторинге.

### Gate Status

**Gate:** PASS ✅ → [docs/qa/gates/epic-14.14.1-attribute-models.yml](../../qa/gates/epic-14.14.1-attribute-models.yml)

**Quality Score:** 95/100 (высокое качество с минорным рефакторингом)

**Evidence:**
- ✅ Все 5 acceptance criteria покрыты тестами
- ✅ 13 unit-тестов проходят успешно
- ✅ 79% покрытие кода (> 70% минимум)
- ✅ Полная типизация согласно mypy
- ✅ Соответствие Flake8 и Black стандартам

**NFR Validation:**
- Security: PASS
- Performance: PASS
- Reliability: PASS
- Maintainability: PASS

### Recommended Status

[✓ Ready for Done]

История готова к переводу в Done после обновления Dev Agent Record с информацией о проведённом рефакторинге.
