# Story 14.5: Filtering & Facets API

## Status

Draft

## Story

**As a** User,
**I want** to filter products by attributes (e.g., Size, Color),
**so that** I can find exactly what I need.

## Acceptance Criteria

1. `ProductFilter` supports dynamic filtering by attributes using the format `?attr_<slug>=<value>`.
2. API response includes a `meta` (or `facets`) section listing available attributes and their values with counts for the current result set.
3. Multiple values are supported (e.g., `?attr_color=red,blue` means Red OR Blue).
4. Filtering by multiple attributes works as AND (e.g., `?attr_color=red&attr_size=xl` means Red AND XL).

## Tasks / Subtasks

- [ ] Update `ProductFilter` in `apps/products/filters.py`
  - [ ] Override `__init__` to dynamically add filters for all `Attribute` records.
  - [ ] Use `django_filters.CharFilter` with a custom method for each attribute.
  - [ ] Implement logic: `queryset.filter(attributes__slug='color', attributes__value__in=['red', 'blue'])`.
- [ ] Implement Facet Generation Service
  - [ ] Create `AttributeFacetService` in `apps/products/services/facets.py`.
  - [ ] Method `get_facets(queryset)`:
    - [ ] Aggregate counts: `AttributeValue.objects.filter(product__in=queryset).values('attribute__slug', 'value').annotate(count=Count('id'))`.
    - [ ] Group by attribute.
- [ ] Update `ProductViewSet` in `apps/products/views.py`
  - [ ] In `list` method, call `AttributeFacetService.get_facets(queryset)`.
  - [ ] Inject facets into the response.

## Dev Notes

- **Dependencies:**
  - **Story 14.1:** `Attribute` and `AttributeValue` models.
  - **Story 14.4:** API enhancements (optional, but good to have).
- **Dynamic Filters:**
  - In `ProductFilter.__init__`:

    ```python
    attributes = Attribute.objects.all()
    for attr in attributes:
        self.filters[f'attr_{attr.slug}'] = django_filters.CharFilter(method='filter_attribute', label=attr.name)
    ```

  - `filter_attribute` method needs to handle the specific attribute slug (passed via name or bound field).
- **Facets Performance:**
  - Aggregating over a large queryset can be slow.
  - **Optimization:** Use `distinct()` carefully.
  - **Structure:**

    ```json
    "facets": {
      "color": [
        { "value": "Red", "count": 10, "slug": "red" },
        { "value": "Blue", "count": 5, "slug": "blue" }
      ]
    }
    ```

## Testing

- **Location:** `backend/tests/products/test_filters.py`
- **Standards:**
  - Create `Attribute` (Color) and `AttributeValue` (Red, Blue).
  - Assign to products.
  - Test URL: `?attr_color=red`.
  - Verify only "Red" products are returned.
  - Test Facets: Verify counts match the filtered result.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Detailed dynamic filter implementation and facet structure | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-
