# Story 14.4: Link Attributes to Products & Variants

## Status

Draft

## Story

**As a** User,
**I want** products to have detailed specifications linked to them,
**so that** the data is structured and accurate.

## Dependencies

- [Story 14.2: Import Attributes from 1C](./14.2.import-attributes.md)
- [Story 14.3: Attribute Deduplication](./14.3.attribute-deduplication.md) (рекомендуется выполнить до этой story)
- [PRD: 1C Properties Integration](../../prd/brownfield-1c-properties.md)

## Acceptance Criteria

1. Обновлен парсер `goods.xml`: при создании/обновлении `Product` создаются связи с `AttributeValue`.
2. Обновлен парсер `offers.xml`: при создании/обновлении `ProductVariant` создаются связи с `AttributeValue`.
3. Обработаны случаи, когда значение атрибута в товаре ссылается на несуществующее значение (создание on-the-fly или логирование ошибки).

## Tasks / Subtasks

- [ ] Modify product import parsing in `backend/apps/products/services/parser.py`
  - [ ] Extract property IDs and Value IDs from `goods.xml`
- [ ] Modify product processing in `backend/apps/products/services/processor.py`
  - [ ] Lookup `AttributeValue` by `onec_id`
  - [ ] Add to `Product.attributes`
- [ ] Modify variant import parsing and processing
  - [ ] Parse property values from `offers.xml`
  - [ ] Lookup `AttributeValue` by `onec_id` (or name/value if ID missing)
  - [ ] Add to `ProductVariant.attributes`
- [ ] Implement error handling/logging for missing attributes

## Dev Notes

- **Integration:** This story modifies the existing import logic in `ProductDataProcessor` and `XMLDataParser`.
- **Compatibility:** Ensure `specifications` JSON field is preserved if needed for backward compatibility (CR1 from PRD).
- **Data Mapping:**
  - Need to resolve IDs from XML to the `Attribute` and `AttributeValue` records created in Story 14.2.

### XML Structure Examples

**goods.xml** (Product Attributes):

```xml
<Товар>
  <ЗначенияСвойств>
    <ЗначенияСвойства>
      <Ид>PROPERTY_GUID_HERE</Ид>
      <Значение>VALUE_GUID_HERE</Значение>
    </ЗначенияСвойства>
  </ЗначенияСвойств>
</Товар>
```

**offers.xml** (Variant Attributes):

```xml
<Предложение>
  <ХарактеристикиТовара>
    <ХарактеристикаТовара>
      <Наименование>Property Name</Наименование>
      <Значение>Property Value (or GUID)</Значение>
    </ХарактеристикаТовара>
  </ХарактеристикиТовара>
</Предложение>
```

## Testing

- **Location:** `backend/tests/products/test_import_linking.py`
- **Standards:**
  - Create a test case with a product and its attributes in XML.
  - Verify that after import, `product.attributes.all()` returns the expected values.
  - Verify similar logic for variants.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Added dependencies, XML examples, and fixed file paths | Bob (SM) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-
