# Story 14.4: Link Attributes to Products & Variants

## Status

Ready for Development

## Story

**As a** User,
**I want** products to have detailed specifications linked to them,
**so that** the data is structured and accurate.

## Dependencies

- [Story 14.2: Import Attributes from 1C](./14.2.import-attributes.md)
- [Story 14.3: Attribute Deduplication](./14.3.attribute-deduplication.md) (рекомендуется выполнить до этой story)
- [PRD: 1C Properties Integration](../../prd/brownfield-1c-properties.md)

## Acceptance Criteria

1. Обновлен парсер `goods.xml`: при создании/обновлении `Product` создаются связи с `AttributeValue`.
2. Обновлен парсер `offers.xml`: при создании/обновлении `ProductVariant` создаются связи с `AttributeValue`.
3. Обработаны случаи, когда значение атрибута в товаре ссылается на несуществующее значение (создание on-the-fly или логирование ошибки).

## Tasks / Subtasks

- [ ] **Task 1: Parse product attributes from goods.xml**
  - [ ] Add `PropertyValueData` TypedDict to `parser.py`
  - [ ] Update `GoodsData` TypedDict with `property_values` field
  - [ ] Implement parsing of `<ЗначенияСвойств>` in `parse_goods_xml()`
  - [ ] Filter out empty GUID values (`00000000-0000-0000-0000-000000000000`)
- [ ] **Task 2: Link attributes to Product**
  - [ ] Add imports for `Attribute1CMapping`, `AttributeValue1CMapping` in `processor.py`
  - [ ] Implement `_link_product_attributes()` method
  - [ ] Lookup `AttributeValue` via `AttributeValue1CMapping.onec_id`
  - [ ] Use `select_related()` for query optimization
  - [ ] Call `_link_product_attributes()` in `create_product_placeholder()`
  - [ ] Update stats tracking (attributes_linked, attributes_missing_mapping)
- [ ] **Task 3: Link attributes to ProductVariant**
  - [ ] Implement `_link_variant_attributes()` method
  - [ ] Search `Attribute` by `normalized_name` (NO is_active filter)
  - [ ] Search `AttributeValue` by `attribute` + `normalized_value`
  - [ ] Create `AttributeValue` on-the-fly if missing (AC3)
  - [ ] Handle slug uniqueness for on-the-fly values
  - [ ] Call `_link_variant_attributes()` in `enrich_product_from_offer()`
- [ ] **Task 4: Testing**
  - [ ] Create `test_import_linking.py` with pytest integration tests
  - [ ] Test: link attributes via onec_id mapping (goods.xml)
  - [ ] Test: skip empty GUID values
  - [ ] Test: link inactive attributes (Variant C - no filtering in import)
  - [ ] Test: link variant attributes by normalized name/value
  - [ ] Test: create AttributeValue on-the-fly
  - [ ] Test: missing attribute logging
  - [ ] Achieve >85% coverage for new methods

## Dev Notes

### Architecture Decision: Variant C (Hybrid Approach)

**Import Layer Strategy:**

- Import layer (processor.py) links **ALL** attributes to Product/ProductVariant (both active and inactive)
- NO filtering by `is_active` during import
- Create AttributeValue on-the-fly for offers.xml if needed

**API Layer Strategy (Story 14.5):**

- Filtering by `is_active=True` happens in Serializers
- Administrators control visibility through Django Admin

**Rationale:**

- ✅ Full data completeness in database
- ✅ Flexibility to activate/deactivate attributes without re-import
- ✅ Aligns with Story 14.3.6 AC1-2: "ProductSerializer filters attributes with is_active=True"
- ✅ Separation of concerns: Import = data integrity, API = business logic

### Integration Notes

- **Integration:** This story modifies the existing import logic in `ProductDataProcessor` and `XMLDataParser`.
- **Compatibility:** Ensure `specifications` JSON field is preserved if needed for backward compatibility (CR1 from PRD).
- **Data Mapping:**
  - goods.xml: Resolve IDs via `AttributeValue1CMapping.onec_id` lookup
  - offers.xml: Resolve by `Attribute.normalized_name` + `AttributeValue.normalized_value`
  - Story 14.2 must be completed (Attribute/AttributeValue models exist)
  - Story 14.3 models required: Attribute1CMapping, AttributeValue1CMapping

### Key Differences: goods.xml vs offers.xml

**goods.xml (Products):**

```xml
<ЗначенияСвойства>
  <Ид>PROPERTY_GUID</Ид>           <!-- Attribute onec_id -->
  <Значение>VALUE_GUID</Значение>   <!-- AttributeValue onec_id -->
</ЗначенияСвойства>
```

- Lookup: `AttributeValue1CMapping.objects.get(onec_id=VALUE_GUID)`
- If not found: Log warning, skip

**offers.xml (ProductVariants):**

```xml
<ХарактеристикаТовара>
  <Наименование>Размер</Наименование>  <!-- Attribute name (text) -->
  <Значение>42</Значение>              <!-- AttributeValue value (text) -->
</ХарактеристикаТовара>
```

- Lookup: `Attribute.objects.get(normalized_name=normalize_attribute_name("Размер"))`
- Then: `AttributeValue.objects.get(attribute=attr, normalized_value=normalize_attribute_value("42"))`
- If not found: Create on-the-fly (AC3)

### XML Structure Examples

**goods.xml** (Product Attributes):

```xml
<Товар>
  <ЗначенияСвойств>
    <ЗначенияСвойства>
      <Ид>PROPERTY_GUID_HERE</Ид>
      <Значение>VALUE_GUID_HERE</Значение>
    </ЗначенияСвойства>
  </ЗначенияСвойств>
</Товар>
```

**offers.xml** (Variant Attributes):

```xml
<Предложение>
  <ХарактеристикиТовара>
    <ХарактеристикаТовара>
      <Наименование>Property Name</Наименование>
      <Значение>Property Value (or GUID)</Значение>
    </ХарактеристикаТовара>
  </ХарактеристикиТовара>
</Предложение>
```

## Testing

- **Location:** `backend/apps/products/tests/test_import_linking.py` (new file)
- **Standards:**
  - Use `pytest` with `@pytest.mark.integration` and `@pytest.mark.django_db`
  - Use `get_unique_suffix()` from `backend/tests/utils.py` for test data isolation
  - Use Factory Boy for creating test data
  - Coverage target: >85% for new methods
- **Test Cases:**
  1. **test_link_attributes_to_product_via_onec_mapping()** - Link attributes via goods.xml GUID mappings
  2. **test_skip_empty_guid_values()** - Skip `00000000-0000-0000-0000-000000000000` values
  3. **test_link_inactive_attribute_to_product()** - Verify inactive attributes ARE linked (Variant C)
  4. **test_link_variant_attributes_by_normalized_name()** - Link variant attributes by name/value
  5. **test_create_attribute_value_on_the_fly()** - Create missing AttributeValue for variants
  6. **test_missing_attribute_logging()** - Log warnings for missing attributes
  7. **test_attribute_linking_statistics()** - Verify stats tracking (attributes_linked, attributes_missing_mapping)

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Added dependencies, XML examples, and fixed file paths | Bob (SM) |
| 2025-12-05 | 2.0 | Detailed implementation plan, Variant C architecture, expanded tasks and testing | James (Dev) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-
