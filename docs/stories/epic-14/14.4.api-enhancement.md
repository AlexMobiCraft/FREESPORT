# Story 14.4: API Enhancement for Attributes

## Status

Draft

## Story

**As a** Frontend Developer,
**I want** to receive structured attributes in the Product API,
**so that** I can display them on the product page.

## Acceptance Criteria

1. `ProductSerializer` includes an `attributes` field returning a list of attribute objects.
2. `ProductVariantSerializer` includes an `attributes` field.
   - This list must merge product-level attributes with variant-specific attributes.
   - If a variant has a specific value for an attribute (e.g., "Color: Red"), it overrides the product's value (e.g., "Color: Generic").
   - If a variant does not have a value, it inherits the product's value.
3. SQL queries are optimized using `prefetch_related` to prevent N+1 problems when fetching lists of products/variants.
4. The API response format for attributes is consistent and includes: `name`, `value`, `slug`, and `type`.

## Tasks / Subtasks

- [ ] Update `ProductSerializer` in `apps/products/serializers.py`
  - [ ] Add `attributes` field using a nested `AttributeValueSerializer`.
  - [ ] Ensure the response follows the defined contract.
- [ ] Update `ProductVariantSerializer` in `apps/products/serializers.py`
  - [ ] Implement a `get_attributes` method (or SerializerMethodField) to handle inheritance logic.
  - [ ] Logic: Fetch Product attributes + Variant attributes -> Merge by Attribute ID -> Return combined list.
- [ ] Optimize Views in `apps/products/views.py`
  - [ ] Add `prefetch_related('attributes__attribute', 'variants__attributes__attribute')` to `ProductViewSet`.
- [ ] Verify API Response Contract
  - [ ] Ensure output matches: `[{ "name": "Color", "value": "Red", "slug": "color", "type": "text" }, ...]`

## Dev Notes

- **Dependencies:**
  - **Story 14.1:** Requires `Attribute` and `AttributeValue` models to be implemented.
- **Performance:**
  - Critical: Fetching attributes for 20 products can cause massive N+1.
  - Use `prefetch_related` on the M2M fields (`attributes` on Product and Variant).
  - Also prefetch the related `Attribute` model (FK inside AttributeValue) to get the name/slug/type.
- **Inheritance Logic:**
  - Variants often override specific attributes (e.g., Size) but share others (e.g., Material).
  - The serializer needs to construct a union of attributes, prioritizing the variant's values.
- **API Contract:**
  - Proposed structure:

    ```json
    "attributes": [
      {
        "name": "Material",
        "slug": "material",
        "value": "Cotton",
        "type": "text"
      },
      {
        "name": "Size",
        "slug": "size",
        "value": "XL",
        "type": "text"
      }
    ]
    ```

## Testing

- **Location:** `backend/tests/products/test_api.py`
- **Standards:**
  - Use `APIClient` to call the endpoints.
  - Verify the JSON response structure against the contract.
  - **Crucial:** Check query count using `django_assert_num_queries` to ensure `prefetch_related` is working.
  - Test Inheritance: Create a product with "Material: Cotton" and a variant with "Size: XL". Ensure variant API returns BOTH "Material: Cotton" and "Size: XL".

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Added dependencies, inheritance logic, and API contract | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

-

### Debug Log References

-

### Completion Notes List

-

### File List

-

## QA Results

-
