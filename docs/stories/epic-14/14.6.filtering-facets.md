# Story 14.6: Filtering & Facets API

## Status

Ready for Testing

## Story

**As a** User,
**I want** to filter products by attributes (e.g., Size, Color),
**so that** I can find exactly what I need.

## Acceptance Criteria

1. `ProductFilter` supports dynamic filtering by attributes using the format `?attr_<slug>=<value>`.
2. API response includes a `meta` (or `facets`) section listing available attributes and their values with counts for the current result set.
3. Multiple values are supported (e.g., `?attr_color=red,blue` means Red OR Blue).
4. Filtering by multiple attributes works as AND (e.g., `?attr_color=red&attr_size=xl` means Red AND XL).

## Tasks / Subtasks

- [x] Update `ProductFilter` in `apps/products/filters.py`
  - [x] Override `__init__` to dynamically add filters for all `Attribute` records.
  - [x] Use `django_filters.CharFilter` with a custom method for each attribute.
  - [x] Implement logic: `queryset.filter(attributes__slug='color', attributes__value__in=['red', 'blue'])`.
- [x] Implement Facet Generation Service
  - [x] Create `AttributeFacetService` in `apps/products/services/facets.py`.
  - [x] Method `get_facets(queryset)`:
    - [x] Aggregate counts: `AttributeValue.objects.filter(product__in=queryset).values('attribute__slug', 'value').annotate(count=Count('id'))`.
    - [x] Group by attribute.
- [x] Update `ProductViewSet` in `apps/products/views.py`
  - [x] In `list` method, call `AttributeFacetService.get_facets(queryset)`.
  - [x] Inject facets into the response.

## Dev Notes

- **Dependencies:**
  - **Story 14.1:** `Attribute` and `AttributeValue` models.
  - **Story 14.4:** API enhancements (optional, but good to have).
- **Dynamic Filters:**
  - In `ProductFilter.__init__`:

    ```python
    attributes = Attribute.objects.all()
    for attr in attributes:
        self.filters[f'attr_{attr.slug}'] = django_filters.CharFilter(method='filter_attribute', label=attr.name)
    ```

  - `filter_attribute` method needs to handle the specific attribute slug (passed via name or bound field).
- **Facets Performance:**
  - Aggregating over a large queryset can be slow.
  - **Optimization:** Use `distinct()` carefully.
  - **Structure:**

    ```json
    "facets": {
      "color": [
        { "value": "Red", "count": 10, "slug": "red" },
        { "value": "Blue", "count": 5, "slug": "blue" }
      ]
    }
    ```

## Testing

- **Location:** `backend/tests/products/test_filters.py`
- **Standards:**
  - Create `Attribute` (Color) and `AttributeValue` (Red, Blue).
  - Assign to products.
  - Test URL: `?attr_color=red`.
  - Verify only "Red" products are returned.
  - Test Facets: Verify counts match the filtered result.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-12-03 | 1.0 | Initial Draft from PRD | Sarah (PO) |
| 2025-12-03 | 1.1 | Detailed dynamic filter implementation and facet structure | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

- Claude Sonnet 4.5 (model ID: claude-sonnet-4-5-20250929)

### Debug Log References

- Flake8: PASS ✅
- Black: PASS ✅ (auto-formatted 2 files)
- Python syntax validation: PASS ✅

### Completion Notes List

- ✅ Implemented dynamic attribute filters in ProductFilter.**init**()
- ✅ Created filter_attribute() method with OR/AND logic support
- ✅ Created AttributeFacetService with get_facets() aggregation
- ✅ Updated ProductViewSet.list() to inject facets into response
- ✅ Created comprehensive unit tests (10 test cases covering all ACs)
- ✅ Added AttributeFactory, AttributeValueFactory, ProductVariantFactory
- ✅ Full type hints for all new code (from **future** import annotations)

### File List

- `backend/apps/products/filters.py` - Added dynamic attr_* filters (lines 34-109)
- `backend/apps/products/services/facets.py` - New AttributeFacetService (149 lines)
- `backend/apps/products/views.py` - Updated list() method with facets (lines 164-198)
- `backend/tests/unit/test_products/test_attribute_filters.py` - New comprehensive tests (10 test cases)
- `backend/tests/factories.py` - Added AttributeFactory, AttributeValueFactory, ProductVariantFactory

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Реализация Story 14.6 выполнена качественно и соответствует всем acceptance criteria:

**AC1 ✅** — Динамические фильтры `attr_<slug>=<value>` реализованы в `ProductFilter.__init__()` с автоматическим созданием фильтров для всех активных атрибутов.

**AC2 ✅** — Facets генерируются через `AttributeFacetService.get_facets()` с правильной структурой: `{slug: [{value, slug, count}]}`. Интегрированы в API response в `ProductViewSet.list()`.

**AC3 ✅** — OR-логика для множественных значений (`?attr_color=red,blue`) реализована через split по запятой и `__in` lookup.

**AC4 ✅** — AND-логика для множественных атрибутов (`?attr_color=red&attr_size=xl`) работает через sequential filtering в django-filter.

### Refactoring Performed

Рефакторинг не требуется. Код чистый и следует best practices.

### Compliance Check

- Coding Standards: ✅ Black formatted, isort sorted, type hints присутствуют
- Project Structure: ✅ Services в `services/`, фильтры в `filters.py`
- Testing Strategy: ✅ 10 unit-тестов покрывают все AC
- All ACs Met: ✅ Все 4 acceptance criteria выполнены

### Improvements Checklist

- [x] Динамические фильтры корректно фильтруют только по активным атрибутам
- [x] Facets исключают неактивные атрибуты
- [x] Тесты используют unique suffix для изоляции
- [ ] Рассмотреть кеширование facets для крупных каталогов (future optimization)
- [ ] Добавить индекс на `Attribute.is_active` если performance станет проблемой

### Security Review

Без замечаний. Фильтрация безопасна, user input парсится и валидируется.

### Performance Considerations

- `AttributeFacetService.get_facets()` использует single aggregation query с GROUP BY
- `ProductFilter.__init__()` делает один запрос к `Attribute.objects.filter(is_active=True)`
- Для крупных каталогов рекомендуется кеширование facets (Redis)

### Files Modified During Review

Нет изменений. Код не требует рефакторинга.

### Gate Status

Gate: PASS → docs/qa/gates/14.6-filtering-facets.yml

### Recommended Status

✅ Ready for Done — все acceptance criteria выполнены, тесты написаны, код соответствует стандартам.
