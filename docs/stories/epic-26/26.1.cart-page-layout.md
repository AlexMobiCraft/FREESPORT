# Story 26.1: Cart Page Component & Layout

## Status

Ready for Done

## Story

**Как** пользователь сайта,  
**Я хочу** видеть страницу корзины со списком добавленных товаров,  
**Чтобы** оценить свой заказ перед оформлением.

## Dependencies

> [!NOTE]
> **Зависимости от предыдущих эпиков:**
>
> - [Story 2.6](../epic-2/2.6.cart-api.md#api-endpoint): Cart API (backend) — CRUD endpoints ✅ Done
> - [Story 12.3](../epic-12/12.3.add-to-cart.md#zustand-cartstore): cartStore с async операциями и Optimistic Updates ✅ Done
> - [Story 12.3](../epic-12/12.3.add-to-cart.md#typescript-types-cartts): TypeScript типы CartItem, CartState ✅ Done

## Acceptance Criteria

1. Страница `/cart` рендерится корректно при переходе по URL
2. Список товаров отображается слева, блок итогов справа (desktop)
3. Пустая корзина показывает компонент `EmptyCart`:
   - Иконка пустой корзины
   - Текст "Ваша корзина пуста"
   - CTA кнопка "В каталог" → `/catalog`
4. Responsive дизайн:
   - Desktop (>1024px): двухколоночный layout
   - Tablet/Mobile (<1024px): одноколоночный layout, итоги внизу
5. Данные загружаются из cartStore при монтировании страницы
6. Breadcrumb: "Главная / Корзина"
7. Заголовок страницы: "Ваша корзина"
8. Loading state: Skeleton loader во время загрузки данных
9. Error state: Сообщение об ошибке с кнопкой "Повторить"
10. Accessibility: Semantic HTML, aria-атрибуты, корректный tab order

## Tasks / Subtasks

- [x] Создать страницу /cart (AC: 1)
  - [x] Создать `frontend/src/app/cart/page.tsx`
  - [x] Настроить metadata (title, description)
  - [x] Импортировать и рендерить `CartPage` компонент

- [x] Создать компонент CartPage (AC: 2, 5)
  - [x] Создать `frontend/src/components/cart/CartPage.tsx`
  - [x] Добавить директиву `'use client'` (требуется для useCartStore хука)
  - [x] Интегрировать с cartStore через `useCartStore()`
  - [x] Layout: `grid grid-cols-1 lg:grid-cols-3 gap-6`
  - [x] Левая колонка (2/3): список товаров
  - [x] Правая колонка (1/3): CartSummary (placeholder для Story 26.3)
  - [x] Обработка hydration: использовать паттерн `mounted` state для Zustand persist
  - [x] Добавить экспорт в `frontend/src/components/cart/index.ts` (barrel export)

- [x] Создать Skeleton компонент (AC: 8)
  - [x] Создать `frontend/src/components/ui/Skeleton/Skeleton.tsx`
  - [x] Props: `className`, `width`, `height`, `rounded` (опционально)
  - [x] Анимация: `animate-pulse` (Tailwind) или CSS keyframe shimmer
  - [x] Добавить экспорт в `frontend/src/components/ui/Skeleton/index.ts` (barrel export)
  - [x] Добавить экспорт в `frontend/src/components/ui/index.ts`

- [x] Реализовать Loading State
  - [x] Skeleton loader во время `isLoading === true`
  - [x] Использовать созданный `@/components/ui/Skeleton`
  - [x] Создать `CartSkeleton` композицию из базового Skeleton (имитация layout: 3 карточки + summary блок)
  - [x] Показывать индикатор загрузки при первом рендере
  - [x] Использовать `cartStore.fetchCart()` при монтировании (если items пустые)

- [x] Реализовать Error State
  - [x] Показывать сообщение об ошибке при `error !== null`
  - [x] Добавить кнопку "Повторить" для retry fetchCart
  - [x] data-testid: `cart-error`, `cart-retry-button`

- [x] Создать компонент EmptyCart (AC: 3)
  - [x] Создать `frontend/src/components/cart/EmptyCart.tsx`
  - [x] Добавить директиву `'use client'`
  - [x] Иконка ShoppingCart из lucide-react (size: 64px, color: `var(--color-neutral-500)` / text-neutral-500)
  - [x] Текст "Ваша корзина пуста" (text-title-l, text-text-primary)
  - [x] Подзаголовок "Добавьте товары из каталога" (text-body-m, text-text-secondary)
  - [x] Кнопка "В каталог" (bg-primary, text-text-inverse, h-12, rounded-[var(--radius-sm)]) → Link to `/catalog`
  - [x] Добавить экспорт в `frontend/src/components/cart/index.ts`

- [x] Реализовать Breadcrumb (AC: 6)
  - [x] Использовать существующий Breadcrumb компонент из `@/components/ui/Breadcrumb`
  - [x] Items: `[{ label: 'Главная', href: '/' }, { label: 'Корзина' }]` (последний без href)
  - [x] ⚠️ ВАЖНО: Интерфейс BreadcrumbItem использует `label`, не `name`

- [x] Реализовать responsive дизайн (AC: 4)
  - [x] Breakpoint lg (1024px) для переключения layout
  - [x] Mobile: товары сверху, итоги внизу (sticky)
  - [x] Desktop: товары слева, итоги справа (sticky)

- [x] Реализовать Accessibility (AC: 7)
  - [x] `<main>` wrapper с role="main"
  - [x] `<h1>` для заголовка страницы
  - [x] `aria-live="polite"` для блока итогов (обновляется динамически)
  - [x] Semantic `<section>` для списка товаров и итогов
  - [x] Корректный tab order

- [x] Написать unit тесты
  - [x] Тест рендеринга страницы
  - [x] Тест пустой корзины
  - [x] Тест с товарами в корзине
  - [x] Тест loading state
  - [x] Тест error state с retry
  - [x] Тест responsive layout

## Dev Notes

### Relevant Source Tree

```
frontend/src/
├── app/
│   └── cart/
│       └── page.tsx                    (NEW)
├── components/
│   └── cart/
│       ├── CartPage.tsx                (NEW)
│       ├── EmptyCart.tsx               (NEW)
│       └── __tests__/
│           └── CartPage.test.tsx       (NEW)
└── stores/
    └── cartStore.ts                    (EXISTS)
```

### Hydration Паттерн (Zustand Persist + SSR)

> [!IMPORTANT]
> Zustand persist хранит данные в localStorage, что вызывает hydration mismatch.
> Используйте паттерн `mounted` state для корректной работы с SSR.

```tsx
// CartPage.tsx - Hydration safe pattern
'use client';

import { useEffect, useState } from 'react';
import { useCartStore } from '@/stores/cartStore';

export const CartPage = () => {
  const [mounted, setMounted] = useState(false);
  const { items, isLoading, error, fetchCart } = useCartStore();

  // Hydration: ждём монтирования на клиенте
  useEffect(() => {
    setMounted(true);
  }, []);

  // Загружаем корзину при монтировании
  useEffect(() => {
    if (mounted && items.length === 0) {
      fetchCart();
    }
  }, [mounted, items.length, fetchCart]);

  // SSR: показываем skeleton до hydration
  if (!mounted) {
    return <CartSkeleton />;
  }

  // Loading state
  if (isLoading && items.length === 0) {
    return <CartSkeleton />;
  }

  // Error state
  if (error) {
    return <CartError error={error} onRetry={fetchCart} />;
  }

  // Empty state
  if (items.length === 0) {
    return <EmptyCart />;
  }

  // Main content
  return (
    <main data-testid="cart-page">
      {/* ... */}
    </main>
  );
};
```

### Layout Structure

```tsx
// CartPage.tsx layout
<main className="max-w-[1280px] mx-auto px-4 lg:px-6" data-testid="cart-page">
  <Breadcrumb 
    items={[{ label: 'Главная', href: '/' }, { label: 'Корзина' }]} 
    data-testid="cart-breadcrumb"
  />
  
  <h1 className="text-display-m font-bold text-text-primary mb-8">
    Ваша корзина
  </h1>
  
  {items.length === 0 ? (
    <EmptyCart />
  ) : (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Список товаров - 2 колонки */}
      <section className="lg:col-span-2 space-y-4" aria-label="Товары в корзине">
        {items.map(item => (
          <CartItemCard key={item.id} item={item} />
        ))}
      </section>
      
      {/* Итоги - 1 колонка */}
      <aside className="lg:col-span-1" aria-live="polite">
        <CartSummary />
      </aside>
    </div>
  )}
</main>
```

### Data Test IDs

| Элемент | data-testid | Описание |
|---------|-------------|----------|
| Страница корзины | `cart-page` | Контейнер страницы |
| Пустая корзина | `empty-cart` | Компонент пустой корзины |
| Кнопка "В каталог" | `go-to-catalog-button` | CTA в пустой корзине |
| Список товаров | `cart-items-list` | Контейнер списка товаров |
| Breadcrumb | `cart-breadcrumb` | Навигационная цепочка |
| Loading skeleton | `cart-skeleton` | Skeleton при загрузке |
| Error container | `cart-error` | Контейнер ошибки |
| Retry button | `cart-retry-button` | Кнопка повторной загрузки |

### Design System References

```json
// Из design-system.json - используйте CSS переменные из globals.css
{
  "layout": {
    "containers": {
      "surface": "var(--bg-panel)     → #FFFFFF",
      "canvas": "var(--bg-canvas)    → #F5F7FB",
      "radius": "var(--radius-md)    → 16px",
      "innerSpacing": "var(--spacing-6) → 24px"
    }
  },
  "colors": {
    "primary": "var(--color-primary)         → #0060FF",
    "primary-hover": "var(--color-primary-hover) → #0047CC",
    "text-primary": "var(--color-text-primary)   → #1F2A44",
    "text-secondary": "var(--color-text-secondary) → #4B5C7A",
    "text-inverse": "var(--color-text-inverse)   → #FFFFFF",
    "neutral-500": "var(--color-neutral-500)    → #8F9BB3"
  },
  "typography": {
    "display-m": "text-display-m → size: 40px, lineHeight: 48px, weight: 700",
    "title-l": "text-title-l   → size: 24px, lineHeight: 32px, weight: 600",
    "body-m": "text-body-m    → size: 16px, lineHeight: 24px, weight: 500"
  },
  "shadows": {
    "default": "var(--shadow-default) → 0 8px 24px rgba(15, 23, 42, 0.08)",
    "hover": "var(--shadow-hover)   → 0 10px 32px rgba(15, 23, 42, 0.12)"
  },
  "components": {
    "Button": {
      "primary": {
        "bg": "var(--color-primary)",
        "bgHover": "var(--color-primary-hover)",
        "text": "var(--color-text-inverse)",
        "radius": "var(--radius-sm) → 6px"
      },
      "sizes": {
        "large": "h-12 (48px), text-body-l"
      }
    }
  }
}
```

## Testing

**Framework:** Vitest + React Testing Library

**Тестовые сценарии:**

1. **Empty cart:** Рендеринг EmptyCart когда `items.length === 0`
2. **With items:** Рендеринг списка CartItemCard когда есть товары
3. **Responsive:** Проверка CSS классов для разных breakpoints
4. **Navigation:** Клик на "В каталог" → redirect to `/catalog`
5. **Hydration:** Проверка корректной работы SSR → Client hydration:
   - До монтирования: показывается `CartSkeleton`
   - После монтирования: показывается реальный контент
   - Нет console warnings о hydration mismatch
6. **Loading state:** Skeleton отображается при `isLoading === true`
7. **Error state:** Сообщение об ошибке + кнопка retry при `error !== null`

## Definition of Done

- [ ] Страница /cart рендерится без ошибок
- [ ] Layout соответствует макету из front-end-spec.md
- [ ] EmptyCart отображается корректно
- [ ] Loading state (skeleton) отображается корректно
- [ ] Error state с кнопкой retry работает
- [ ] Hydration работает без mismatch warnings
- [ ] Responsive дизайн работает на всех breakpoints
- [ ] Unit тесты написаны и проходят (включая loading/error states)
- [ ] Code review пройден
- [ ] Доступность (a11y): семантическая разметка, aria-атрибуты

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-07 | 1.1 | Добавлены таски: hydration, loading/error states, accessibility, barrel exports | Bob (SM) |
| 2025-12-07 | 1.2 | Story-checklist fixes: уточнены ссылки на зависимости, CartSkeleton → UI-kit Skeleton, добавлен hydration тест-кейс | Bob (SM) |
| 2025-12-07 | 1.3 | Validation fixes: добавлена задача создания Skeleton компонента, исправлен закрывающий тег, добавлен data-testid для Breadcrumb | Sarah (PO) |
| 2025-12-07 | 2.0 | Implementation complete: all tasks done, 77 tests passing | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Cascade)

### File List

| File | Status | Description |
|------|--------|-------------|
| `frontend/src/app/cart/page.tsx` | NEW | Страница корзины с metadata |
| `frontend/src/components/cart/index.ts` | NEW | Barrel export для cart компонентов |
| `frontend/src/components/cart/CartPage.tsx` | NEW | Главный компонент страницы корзины |
| `frontend/src/components/cart/EmptyCart.tsx` | NEW | Компонент пустой корзины |
| `frontend/src/components/cart/CartSkeleton.tsx` | NEW | Skeleton loader для корзины |
| `frontend/src/components/cart/CartError.tsx` | NEW | Компонент ошибки загрузки |
| `frontend/src/components/cart/__tests__/CartPage.test.tsx` | NEW | Тесты CartPage (22 теста) |
| `frontend/src/components/cart/__tests__/EmptyCart.test.tsx` | NEW | Тесты EmptyCart (14 тестов) |
| `frontend/src/components/cart/__tests__/CartSkeleton.test.tsx` | NEW | Тесты CartSkeleton (9 тестов) |
| `frontend/src/components/cart/__tests__/CartError.test.tsx` | NEW | Тесты CartError (14 тестов) |
| `frontend/src/components/ui/Skeleton/Skeleton.tsx` | NEW | Универсальный Skeleton компонент |
| `frontend/src/components/ui/Skeleton/index.ts` | NEW | Barrel export для Skeleton |
| `frontend/src/components/ui/Skeleton/__tests__/Skeleton.test.tsx` | NEW | Тесты Skeleton (18 тестов) |
| `frontend/src/components/ui/index.ts` | MODIFIED | Добавлен экспорт Skeleton |

### Debug Log References

Нет ошибок.

### Completion Notes

- Реализован паттерн hydration-safe для Zustand persist + SSR
- CartPage включает временный placeholder для CartItemCard и CartSummary (будут реализованы в Stories 26.2 и 26.3)
- Skeleton компонент добавлен в UI Kit как переиспользуемый компонент
- Все 77 unit тестов проходят успешно
- Accessibility: semantic HTML, aria-атрибуты, role="main", aria-live для динамических обновлений

## QA Results

### Review Date: 2025-12-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Архитектура страницы корзины соответствует AC: есть SSR-safe hydration-паттерн, состояния loading/error/empty, двухколоночный layout на desktop и одноколоночный на mobile.
- Компоненты использует семантические роли и aria-атрибуты (main, aria-live, aria-busy); тесты покрывают accessibility и responsive классы.
- Загрузчик и ошибки реализованы отдельными компонентами; данные загружаются из cartStore при монтировании, повторный fetchCart доступен.
- Placeholder CartItemCard/CartSummary задокументирован как временный до историй 26.2/26.3, но удовлетворяет текущим AC (структура и sticky summary).

### Refactoring Performed

- Не производилось. Код соответствует требованиям; изменений не вносил.

### Compliance Check

- Coding Standards: ✓ (следует описанным паттернам, нейминг и классы согласованы с design-system)
- Project Structure: ✓ (файлы и barrel-экспорт в ожидаемых директориях)
- Testing Strategy: ✓ (Vitest + RTL, состояния загрузки/ошибки/hydration/responsive покрыты)
- All ACs Met: ✓ (1–10 покрыты реализованной логикой и тестами)

### Improvements Checklist

- [ ] Вынести временные placeholder CartItemCard/CartSummary в итоговые реализации после историй 26.2/26.3 и добавить интеграционные тесты для итогов
- [ ] Добавить e2e-навигацию к checkout, когда он появится

### Security Review

- PASS — данных чувствительных нет; локальное состояние, без ввода пользователя.

### Performance Considerations

- PASS — простая отрисовка списка, Skeleton лёгкий; доп. кэш не требуется.

### Files Modified During Review

- Нет (только добавлен QA Results в story).

### Gate Status

Gate: PASS → docs/qa/gates/26.1-cart-page-component-layout.yml
Risk profile: (не создавался)
NFR assessment: (не создавался)

### Recommended Status

[✓ Ready for Done]
