# Story 26.4: Promo Code Integration (MSW Mock)

## Status

Approved

## Story

**Как** пользователь,  
**Я хочу** применить промокод к своему заказу,  
**Чтобы** получить скидку на покупку.

## Dependencies

> [!NOTE]
> **Зависимости:**
>
> - [Story 26.3](26.3.cart-summary.md): Cart Summary с placeholder для промокода

> [!WARNING]
> **Backend API для промокодов ещё не согласован.**
> Данная story реализует frontend логику с MSW mock.
> Используйте feature flag `NEXT_PUBLIC_PROMO_ENABLED` для отключения в production.

## Acceptance Criteria

1. POST `/api/v1/cart/apply-promo/` API endpoint эмулируется через MSW mock
2. Валидация формата промокода на frontend (минимум 4 символа, буквы и цифры)
3. Success: промокод применяется, скидка отображается, Toast "Промокод применён"
4. Error: Toast "Промокод недействителен" или "Промокод истёк"
5. Возможность удалить примененный промокод (clear button)
6. Loading state при проверке промокода
7. Промокод и скидка сохраняются в cartStore (`promoCode`, `promoDiscount`)
8. Feature flag: функционал отключается если `NEXT_PUBLIC_PROMO_ENABLED !== 'true'`
9. Accessibility: aria-labels, focus management

## Tasks / Subtasks

- [ ] Создать MSW mock для promo API (AC: 1)
  - [ ] Обновить `frontend/src/__mocks__/api/handlers.ts`
  - [ ] Добавить handler: `POST /api/v1/cart/apply-promo/`
  - [ ] Request body: `{ code: string }`
  - [ ] Success response: `{ success: true, code: string, discount_type: 'percent' | 'fixed', discount_value: number }`
  - [ ] Error response: `{ success: false, error: string }`
  - [ ] Реализовать тестовые коды: `SAVE10`, `SAVE20`, `EXPIRED`, `INVALID`

- [ ] Создать promoService (AC: 1)
  - [ ] Создать `frontend/src/services/promoService.ts`
  - [ ] Метод `applyPromo(code: string, cartTotal: number): Promise<PromoResponse>`
  - [ ] Метод `clearPromo(): Promise<void>`
  - [ ] Обработка ошибок с user-friendly сообщениями
  - [ ] Передавать `cartTotal` из `cartStore.totalPrice` для проверки минимальной суммы

- [ ] Создать типы для Promo API
  - [ ] Добавить в `frontend/src/types/cart.ts`:

    ```typescript
    interface PromoResponse {
      success: boolean;
      code?: string;
      discount_type?: 'percent' | 'fixed';
      discount_value?: number;
      error?: string;
    }
    ```

- [ ] Обновить cartStore - добавить promo state (AC: 7)
  - [ ] Добавить поля в state: `promoCode: string | null`, `discountType: 'percent' | 'fixed' | null`, `discountValue: number`
  - [ ] Добавить getter: `getPromoDiscount()` — вычисляет скидку динамически на основе `totalPrice`
  - [ ] Добавить action: `applyPromo(code: string, discountType: 'percent' | 'fixed', discountValue: number)`
  - [ ] Добавить action: `clearPromo()`
  - [ ] `finalTotal = totalPrice - getPromoDiscount()` (скидка пересчитывается при каждом изменении корзины)
  - [ ] Добавить `promoCode`, `discountType`, `discountValue` в `partialize` для сохранения в localStorage

- [ ] Обновить PromoCodeInput компонент (AC: 2-6, 9)
  - [ ] Обновить `frontend/src/components/cart/PromoCodeInput.tsx`
  - [ ] Валидация: минимум 4 символа, `/^[A-Z0-9]+$/i`
  - [ ] Loading state: spinner на кнопке, disabled input
  - [ ] Applied state: показать код и "X" кнопку для удаления
  - [ ] Toast уведомления через `react-hot-toast`
  - [ ] Focus management: фокус на input после ошибки
  - [ ] `aria-describedby` для error messages

- [ ] Добавить feature flag (AC: 8)
  - [ ] Проверка `process.env.NEXT_PUBLIC_PROMO_ENABLED === 'true'`
  - [ ] Если disabled: скрывать PromoCodeInput
  - [ ] Добавить в `.env.example`: `NEXT_PUBLIC_PROMO_ENABLED=false`

- [ ] Обновить CartSummary - интегрировать promo (AC: 3)
  - [ ] Получать `promoDiscount` из cartStore
  - [ ] Показывать строку скидки если `promoDiscount > 0`
  - [ ] Пересчитывать finalTotal

- [ ] Написать unit тесты
  - [ ] Создать `frontend/src/components/cart/__tests__/PromoCodeInput.test.tsx`
  - [ ] Тест успешного применения промокода
  - [ ] Тест ошибки (невалидный код)
  - [ ] Тест удаления промокода
  - [ ] Тест валидации формата
  - [ ] Тест loading state
  - [ ] Тест feature flag (disabled)
  - [ ] Тест минимальной суммы заказа для SAVE20

## Dev Notes

### Тестовые промокоды (MSW)

| Код | Результат | Тип скидки | Значение | Описание |
|-----|-----------|------------|----------|----------|
| `SAVE10` | ✅ Success | percent | 10 | Скидка 10%, без мин. суммы |
| `SAVE20` | ✅ Success | percent | 20 | Скидка 20%, мин. сумма 5000₽ |
| `FLAT500` | ✅ Success | fixed | 500 | Скидка 500₽ |
| `EXPIRED` | ❌ Error | — | — | "Срок действия промокода истёк" |
| `INVALID` | ❌ Error | — | — | "Промокод недействителен" |

### Relevant Source Tree

```
frontend/src/
├── components/
│   └── cart/
│       └── PromoCodeInput.tsx          (UPDATE)
├── services/
│   └── promoService.ts                 (NEW)
├── stores/
│   └── cartStore.ts                    (UPDATE - add promo state)
├── types/
│   └── cart.ts                         (UPDATE - add PromoResponse)
└── __mocks__/
    └── api/
        └── handlers.ts                 (UPDATE - add promo handlers)
```

### MSW Handler Example

```typescript
// handlers.ts
import { http, HttpResponse } from 'msw';

// Promo code mock handler
// ВАЖНО: Handler принимает cartTotal для проверки минимальной суммы
http.post('/api/v1/cart/apply-promo/', async ({ request }) => {
  const { code, cartTotal } = await request.json() as { code: string; cartTotal?: number };
  
  const promos: Record<string, { 
    discount_type: 'percent' | 'fixed', 
    discount_value: number,
    min_order?: number  // минимальная сумма заказа
  }> = {
    'SAVE10': { discount_type: 'percent', discount_value: 10 },
    'SAVE20': { discount_type: 'percent', discount_value: 20, min_order: 5000 },
    'FLAT500': { discount_type: 'fixed', discount_value: 500 },
  };
  
  if (code === 'EXPIRED') {
    return HttpResponse.json({ success: false, error: 'Срок действия промокода истёк' }, { status: 400 });
  }
  
  const promo = promos[code.toUpperCase()];
  if (!promo) {
    return HttpResponse.json({ success: false, error: 'Промокод недействителен' }, { status: 400 });
  }
  
  // Проверка минимальной суммы заказа
  if (promo.min_order && cartTotal && cartTotal < promo.min_order) {
    return HttpResponse.json({ 
      success: false, 
      error: `Минимальная сумма заказа для этого промокода: ${promo.min_order}₽` 
    }, { status: 400 });
  }
  
  return HttpResponse.json({
    success: true,
    code: code.toUpperCase(),
    discount_type: promo.discount_type,
    discount_value: promo.discount_value,
  });
}),
```

### CartStore Promo State Example

```typescript
// cartStore.ts - добавить в interface и state
// ВАЖНО: храним discountType+discountValue, вычисляем скидку динамически
interface CartStore extends CartStateType {
  // ... existing
  promoCode: string | null;
  discountType: 'percent' | 'fixed' | null;
  discountValue: number;
  getPromoDiscount: () => number;  // динамический пересчёт!
  applyPromo: (code: string, discountType: 'percent' | 'fixed', discountValue: number) => void;
  clearPromo: () => void;
}

// В state:
promoCode: null,
discountType: null,
discountValue: 0,

// Динамический расчёт скидки (пересчитывается при изменении корзины!)
getPromoDiscount: () => {
  const { totalPrice, discountType, discountValue } = get();
  if (!discountType) return 0;
  const discount = discountType === 'percent' 
    ? totalPrice * (discountValue / 100)
    : discountValue;
  return Math.min(discount, totalPrice);
},

applyPromo: (code, discountType, discountValue) => {
  set({ promoCode: code, discountType, discountValue });
},

clearPromo: () => set({ promoCode: null, discountType: null, discountValue: 0 }),

// В partialize (строка 226-229):
partialize: state => ({
  items: state.items,
  promoCode: state.promoCode,
  discountType: state.discountType,
  discountValue: state.discountValue,
}),
```

### PromoCodeInput Applied State

```tsx
// При применённом промокоде
// ✅ VERIFIED: CSS переменная --color-accent-success-bg: #e0f5e8 существует в globals.css (строка 29)
{promoCode && (
  <div className="flex items-center justify-between p-3 bg-[var(--color-accent-success-bg)] 
                  rounded-[var(--radius-sm)] text-[var(--color-accent-success)]">
    <span className="text-body-m font-medium">
      ✓ Промокод {promoCode} применён
    </span>
    <button 
      onClick={handleClearPromo}
      className="text-body-s hover:underline"
      aria-label="Удалить промокод"
    >
      Удалить
    </button>
  </div>
)}
```

## Testing

**Framework:** Vitest + React Testing Library + MSW

**Тестовые сценарии:**

1. **Apply valid promo:** Ввод SAVE10 → промокод применён, скидка отображается
2. **Apply invalid promo:** Ввод WRONG → Toast с ошибкой
3. **Clear promo:** Клик "Удалить" → промокод убран
4. **Validation:** Код < 4 символов → кнопка disabled
5. **Loading state:** Во время запроса → spinner, input disabled
6. **Feature flag disabled:** Promo section скрыта

## Definition of Done

- [ ] MSW mock для promo API работает
- [ ] PromoCodeInput компонент полностью функционален
- [ ] cartStore хранит promo state (`promoCode`, `promoDiscount`)
- [ ] CartSummary отображает скидку при применённом промокоде
- [ ] Toast уведомления показываются (success/error)
- [ ] Feature flag работает
- [ ] Unit тесты написаны (>= 80% coverage)
- [ ] Accessibility: aria-labels, focus management

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-07 | 1.1 | Детализированы Tasks, добавлены: типы, примеры кода, MSW handler, cartStore update, feature flag | Bob (SM) |
| 2025-12-07 | 1.2 | Исправлено: архитектура promo state (храним discountType+discountValue, вычисляем скидку динамически), CSS переменная --color-accent-success-bg, persist partialize | Sarah (PO) |
| 2025-12-07 | 1.3 | Validation fixes: добавлен путь к тесту, верифицирована CSS переменная, добавлена логика min_order для SAVE20 | Sarah (PO) |
