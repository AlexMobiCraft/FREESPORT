# Story 26.5: Cart Page Unit & Integration Tests

## Status

Draft

## Story

**Как** разработчик,  
**Я хочу** иметь комплексное покрытие тестами страницы корзины,  
**Чтобы** обеспечить качество и стабильность функционала.

## Dependencies

> [!NOTE]
> **Зависимости:**
>
> - [Story 26.1](26.1.cart-page-layout.md): Cart Page Layout
> - [Story 26.2](26.2.cart-item-card.md): Cart Item Card
> - [Story 26.3](26.3.cart-summary.md): Cart Summary
> - [Story 26.4](26.4.promo-code-integration.md): Promo Code Integration

## Acceptance Criteria

1. Unit тесты для CartItemCard (render, quantity change, delete) — >= 80% coverage
2. Unit тесты для CartSummary (totals, promo, checkout button) — >= 80% coverage
3. Unit тесты для EmptyCart (render, CTA click)
4. Unit тесты для PromoCodeInput (apply, validate, loading states)
5. Integration тест: добавление товара → отображение → изменение quantity → удаление
6. MSW моки для всех Cart API endpoints
7. Общее покрытие >= 80% для cart компонентов
8. Accessibility tests (axe-core) для всех компонентов

## Tasks / Subtasks

- [ ] Настроить test environment для cart (AC: 6)
  - [ ] Создать `frontend/src/components/cart/__tests__/setup.ts`
  - [ ] Настроить MSW server для тестов
  - [ ] Создать mock для cartStore (Zustand)
  - [ ] Создать test utilities: `renderWithStore()`, `mockCartItems()`

- [ ] Написать unit тесты для CartItemCard (AC: 1)
  - [ ] Создать `frontend/src/components/cart/__tests__/CartItemCard.test.tsx`
  - [ ] Тест рендеринга всех полей (image, name, SKU, color, size, price)
  - [ ] Тест image placeholder при image === null
  - [ ] Тест кнопок +/- quantity
  - [ ] Тест disabled states (min=1, max=99)
  - [ ] Тест debounce на input
  - [ ] Тест удаления товара с Toast
  - [ ] Тест Optimistic Update и rollback

- [ ] Написать unit тесты для CartSummary (AC: 2)
  - [ ] Создать `frontend/src/components/cart/__tests__/CartSummary.test.tsx`
  - [ ] Тест отображения итогов (subtotal, total)
  - [ ] Тест hydration (mounted state pattern)
  - [ ] Тест с промокодом (promoDiscount > 0)
  - [ ] Тест disabled button (условный рендеринг Link/button)
  - [ ] Тест sticky positioning classes

- [ ] Написать unit тесты для EmptyCart (AC: 3)
  - [ ] Создать `frontend/src/components/cart/__tests__/EmptyCart.test.tsx`
  - [ ] Тест рендеринга icon, text, button
  - [ ] Тест клика на "В каталог" → navigation

- [ ] Написать unit тесты для PromoCodeInput (AC: 4)
  - [ ] Создать `frontend/src/components/cart/__tests__/PromoCodeInput.test.tsx`
  - [ ] Тест валидации (min 4 символа, alphanumeric)
  - [ ] Тест apply promo → success
  - [ ] Тест apply promo → error
  - [ ] Тест loading state
  - [ ] Тест clear promo
  - [ ] Тест feature flag disabled

- [ ] Написать integration тесты (AC: 5)
  - [ ] Создать `frontend/src/components/cart/__tests__/CartPage.integration.test.tsx`
  - [ ] Full flow: render → items displayed → update quantity → totals recalculated
  - [ ] Remove item → list updated → totals recalculated
  - [ ] Promo code: apply → discount shown → remove → discount gone
  - [ ] Empty cart → add item → cart shown

- [ ] Написать accessibility тесты (AC: 8)
  - [ ] Установить `@axe-core/react` (если не установлено)
  - [ ] Тест CartPage с axe (no violations)
  - [ ] Тест keyboard navigation
  - [ ] Тест focus management в PromoCodeInput

- [ ] Проверить coverage (AC: 7)
  - [ ] Запустить `npm run test:coverage`
  - [ ] Проверить coverage report для `components/cart/`
  - [ ] Достичь >= 80% для cart компонентов

## Dev Notes

### Relevant Source Tree

```
frontend/src/components/cart/__tests__/
├── setup.ts                      (NEW - test utilities)
├── CartPage.test.tsx             (NEW)
├── CartItemCard.test.tsx         (NEW)
├── CartSummary.test.tsx          (NEW)
├── EmptyCart.test.tsx            (NEW)
├── PromoCodeInput.test.tsx       (NEW)
├── QuantitySelector.test.tsx     (NEW)
└── CartPage.integration.test.tsx (NEW)
```

### Test Setup with MSW and Zustand Mock

```typescript
// setup.ts
import { beforeAll, afterAll, afterEach } from 'vitest';
import { setupServer } from 'msw/node';
import { http, HttpResponse } from 'msw';
import { useCartStore } from '@/stores/cartStore';

// Mock CartItem for tests
export const mockCartItem = (overrides = {}) => ({
  id: 1,
  variant_id: 100,
  product: {
    id: 10,
    name: 'Test Product',
    slug: 'test-product',
    image: '/images/test.jpg',
  },
  variant: {
    sku: 'TEST-001',
    color_name: 'Красный',
    size_value: 'M',
  },
  quantity: 2,
  unit_price: '1500.00',
  total_price: '3000.00',
  added_at: new Date().toISOString(),
  ...overrides,
});

// MSW handlers for tests
export const handlers = [
  http.get('/api/v1/cart/', () => {
    return HttpResponse.json({
      id: 1,
      items: [mockCartItem()],
      total_items: 2,
      total_amount: '3000.00',
    });
  }),
  http.patch('/api/v1/cart/items/:id/', async ({ request }) => {
    const { quantity } = await request.json() as { quantity: number };
    return HttpResponse.json(mockCartItem({ quantity, total_price: String(1500 * quantity) }));
  }),
  http.delete('/api/v1/cart/items/:id/', () => {
    return new HttpResponse(null, { status: 204 });
  }),
];

export const server = setupServer(...handlers);

// Setup for all tests
beforeAll(() => server.listen());
afterEach(() => {
  server.resetHandlers();
  // Reset Zustand store
  useCartStore.setState({
    items: [],
    totalItems: 0,
    totalPrice: 0,
    isLoading: false,
    error: null,
    promoCode: null,
    promoDiscount: 0,
  });
});
afterAll(() => server.close());
```

### Render with Store Utility

```typescript
// setup.ts - renderWithStore
import { render } from '@testing-library/react';
import { useCartStore } from '@/stores/cartStore';

export const renderWithStore = (ui: React.ReactElement, initialState = {}) => {
  // Set initial state before render
  useCartStore.setState({
    items: [],
    totalItems: 0,
    totalPrice: 0,
    isLoading: false,
    error: null,
    ...initialState,
  });
  
  return render(ui);
};

// Usage:
// renderWithStore(<CartSummary />, { items: [mockCartItem()], totalPrice: 3000 });
```

### CartItemCard Test Example

```typescript
// CartItemCard.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { screen, fireEvent, waitFor } from '@testing-library/react';
import { renderWithStore, mockCartItem } from './setup';
import { CartItemCard } from '../CartItemCard';

describe('CartItemCard', () => {
  it('renders all product information', () => {
    const item = mockCartItem();
    renderWithStore(<CartItemCard item={item} />);
    
    expect(screen.getByText('Test Product')).toBeInTheDocument();
    expect(screen.getByText(/TEST-001/)).toBeInTheDocument();
    expect(screen.getByText(/Красный/)).toBeInTheDocument();
    expect(screen.getByText(/M/)).toBeInTheDocument();
  });
  
  it('handles quantity increment', async () => {
    const item = mockCartItem();
    const onQuantityChange = vi.fn();
    renderWithStore(<CartItemCard item={item} onQuantityChange={onQuantityChange} />);
    
    fireEvent.click(screen.getByTestId('quantity-increment'));
    
    await waitFor(() => {
      expect(onQuantityChange).toHaveBeenCalledWith(item.id, 3);
    });
  });
  
  it('disables decrement button at min quantity', () => {
    const item = mockCartItem({ quantity: 1 });
    renderWithStore(<CartItemCard item={item} />);
    
    expect(screen.getByTestId('quantity-decrement')).toBeDisabled();
  });
  
  it('shows placeholder when image is null', () => {
    const item = mockCartItem({ product: { ...mockCartItem().product, image: null } });
    renderWithStore(<CartItemCard item={item} />);
    
    expect(screen.getByTestId('image-placeholder')).toBeInTheDocument();
  });
});
```

### Accessibility Test Example

```typescript
// CartPage.test.tsx
import { describe, it, expect } from 'vitest';
import { axe, toHaveNoViolations } from 'jest-axe';
import { renderWithStore, mockCartItem } from './setup';
import { CartPage } from '../CartPage';

expect.extend(toHaveNoViolations);

describe('CartPage Accessibility', () => {
  it('has no accessibility violations', async () => {
    const { container } = renderWithStore(<CartPage />, {
      items: [mockCartItem()],
      totalPrice: 3000,
      totalItems: 2,
    });
    
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});
```

## Testing Commands

```bash
# Запуск всех тестов cart (Vitest)
npm test -- src/components/cart

# Запуск конкретного файла
npm test -- CartItemCard.test.tsx

# Запуск с покрытием
npm run test:coverage -- --coverage.include="src/components/cart/**"

# Watch mode
npm test -- --watch src/components/cart

# Запуск только integration тестов
npm test -- CartPage.integration.test.tsx
```

## Definition of Done

- [ ] Все unit тесты написаны и проходят
- [ ] Integration тесты написаны и проходят
- [ ] Accessibility тесты написаны и проходят
- [ ] Coverage >= 80% для cart компонентов
- [ ] MSW handlers покрывают все API endpoints
- [ ] Тесты корректно мокируют Zustand store
- [ ] CI/CD pipeline проходит
- [ ] Тесты документированы в JSDoc

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-07 | 1.0 | Initial story creation | Sarah (PO) |
| 2025-12-07 | 1.1 | Детализированы Tasks, добавлены: test setup, MSW config, mock utilities, примеры тестов, accessibility tests | Bob (SM) |
