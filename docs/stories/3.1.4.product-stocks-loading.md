# Story 3.1.4: product-stocks-loading

## Status
Ready for Development

## Story
**As a** менеджер по продажам,
**I want** видеть актуальные остатки товаров,
**so that** клиенты не заказывают недоступные позиции.

## Acceptance Criteria

1. Создана команда `load_product_stocks --file=path/to/stocks.xml`
2. Добавлены поля остатков в модель Product
3. Реализована логика `is_in_stock` (остаток > 0)
4. Реализована логика `can_be_ordered` (учитывает резерв)
5. Загружены остатки для всех товаров каталога
6. Настроена обработка отрицательных остатков
7. API возвращает корректный статус наличия товара

### Детальные задачи:

- [ ] Создать команду загрузки остатков (AC: 1)
  - [ ] Команда `load_product_stocks` в `apps/products/management/commands/`
  - [ ] Параметры: --file, --dry-run, --force-update
  - [ ] Валидация формата файла остатков
  - [ ] Прогресс-бар и логирование операций

- [ ] Обновить модель Product (AC: 2)
  - [ ] Добавить `stock_quantity = PositiveIntegerField(default=0)`
  - [ ] Добавить `reserved_quantity = PositiveIntegerField(default=0)`
  - [ ] Добавить `minimum_stock = PositiveIntegerField(default=1)`
  - [ ] Создать миграцию для новых полей

- [ ] Реализовать логику is_in_stock (AC: 3)
  - [ ] Property `is_in_stock` в модели Product
  - [ ] Логика: `stock_quantity > 0`
  - [ ] Учитывать зарезервированные остатки
  - [ ] Кэширование результата для производительности

- [ ] Реализовать логику can_be_ordered (AC: 4)
  - [ ] Property `can_be_ordered` в модели Product
  - [ ] Логика: `(stock_quantity - reserved_quantity) >= minimum_stock`
  - [ ] Поддержка предзаказа для out-of-stock товаров
  - [ ] Интеграция с корзиной покупок

- [ ] Загрузить остатки товаров (AC: 5)
  - [ ] Подготовить файл остатков для всех 500+ товаров
  - [ ] Различные уровни остатков: high, medium, low, out-of-stock
  - [ ] Реалистичные данные для тестирования
  - [ ] Валидация соответствия товаров в каталоге

- [ ] Обработать отрицательные остатки (AC: 6)
  - [ ] Логика обработки overselling ситуаций
  - [ ] Автоматическое создание backorder записей
  - [ ] Уведомления менеджеров о критических остатках
  - [ ] Блокировка заказов при недостаточных остатках

- [ ] Обновить API остатков (AC: 7)
  - [ ] Добавить поля `is_in_stock`, `can_be_ordered` в Product serializer
  - [ ] Эндпоинт проверки остатков `/api/products/{id}/stock/`
  - [ ] Bulk проверка остатков для корзины
  - [ ] Real-time обновления остатков

## Definition of Done
- [ ] Все товары имеют корректные остатки
- [ ] API правильно отображает статус наличия
- [ ] Логика заказа работает согласно остаткам
- [ ] Корзина блокирует недоступные товары
- [ ] Менеджеры получают уведомления о критических остатках

## Dev Notes

### Story Context
**Stock Management Logic:**
- Товар "в наличии" если stock_quantity > 0
- Товар "доступен для заказа" если available_quantity >= minimum_stock
- available_quantity = stock_quantity - reserved_quantity
- Резервирование происходит при добавлении в корзину

### Database Schema
```python
class Product(models.Model):
    # ... existing fields
    stock_quantity = models.PositiveIntegerField('Остаток', default=0)
    reserved_quantity = models.PositiveIntegerField('Зарезервировано', default=0)
    minimum_stock = models.PositiveIntegerField('Минимальный остаток', default=1)
    
    @property
    def is_in_stock(self):
        return self.stock_quantity > 0
    
    @property 
    def can_be_ordered(self):
        available = self.stock_quantity - self.reserved_quantity
        return available >= self.minimum_stock
        
    @property
    def available_quantity(self):
        return max(0, self.stock_quantity - self.reserved_quantity)
```

### API Response Example
```json
{
  "id": 1,
  "name": "Nike Air Max",
  "stock_quantity": 15,
  "reserved_quantity": 3,
  "available_quantity": 12,
  "is_in_stock": true,
  "can_be_ordered": true,
  "minimum_stock": 1
}
```

### Stock Levels Testing
```python
# Test data scenarios
STOCK_SCENARIOS = {
    'high_stock': {'stock': 100, 'reserved': 5},      # Много в наличии
    'medium_stock': {'stock': 10, 'reserved': 2},     # Средний остаток  
    'low_stock': {'stock': 3, 'reserved': 1},         # Мало остатков
    'critical_stock': {'stock': 1, 'reserved': 0},    # Критичный остаток
    'out_of_stock': {'stock': 0, 'reserved': 0},      # Нет в наличии
    'oversold': {'stock': 5, 'reserved': 10},         # Перепродано
}
```

### Dependencies
- **Depends on:** Story 3.1.3 (test catalog)
- **Integrates with:** Cart API, Order processing
- **Related:** Real-time inventory updates, 1C synchronization

## Story Points
**5** (Medium complexity, business logic + API integration)

## Priority
**Medium** - Важно для функциональности заказов

## Labels
`epic-3` `inventory` `stock-management` `api` `business-logic`