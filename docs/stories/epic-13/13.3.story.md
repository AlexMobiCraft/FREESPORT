# Story 13.3: Обновление логики импорта брендов

## Status

Draft  
> Story может стартовать только после перевода Stories 13.1 и 13.2 в состояние **Done**, чтобы мастер-бренды и поле `Product.onec_brand_id` уже существовали.

## Story

**As a** интеграционный инженер 1С,
**I want** чтобы импорт брендов объединял дубликаты по нормализованным названиям и создавал записи сопоставления,
**so that** каталог на сайте оставался чистым, а связь с исходными 1С ID не терялась.

## Acceptance Criteria

1. Метод `process_brands()` ищет существующий бренд по `normalized_name`.
2. Если бренд найден — создаётся только `Brand1CMapping`.
3. Если бренд не найден — создаётся новый `Brand` + `Brand1CMapping`.
4. Статистика импорта включает `brands_created`, `mappings_created`, `mappings_updated`.
5. Логирование: какие бренды были объединены.

## Tasks / Subtasks

- [ ] **Task 1: Рефакторинг `process_brands()` для дедупликации** (AC: 1, 2, 3)
  - [ ] Использовать `normalize_brand_name()` при обработке каждого `BrandData`, искать бренд через `Brand.objects.filter(normalized_name=...)` и учитывать уникальность slug при создании новых брендов. [Source: epics/epic-13/epic-13.brand-deduplication.md#story-133]
  - [ ] При наличии бренда создавать/обновлять `Brand1CMapping` с `onec_id`, `onec_name`; при отсутствии — создавать `Brand` + связанную запись, наследуя текущую slug-логику. [Source: architecture/02-data-models.md#модели-каталога-товаров]
  - [ ] Гарантировать идемпотентность: повторный импорт не должен дублировать бренды или маппинги; при конфликте `Brand1CMapping.onec_id` фиксировать обновление. [Source: architecture/20-1c-integration.md#2-архитектурные-принципы]

- [ ] **Task 2: Обновление статистики и логирования импорта брендов** (AC: 4, 5)
  - [ ] Расширить `process_brands()` и связанные отчёты (`ProductDataProcessor.process_brands` и CLI команда `import_catalog_from_1c`) новыми счетчиками `brands_created`, `mappings_created`, `mappings_updated`, сохранив существующие `created/updated/skipped` для обратной совместимости. [Source: architecture/20-1c-integration.md#6-воркфлоу-импорта-каталога]
  - [ ] Добавить структурированное логирование объединений: фиксировать, какой `onec_id` был привязан к какому `Brand` (id, `normalized_name`, `slug`). [Source: architecture/12-error-handling.md#structured-logging]
  - [ ] Обновить итоговый отчёт management-команды, чтобы новые показатели отображались в консоли и (при наличии) в `ImportLog.summary_report`. [Source: architecture/source-tree.md#backend]

- [ ] **Task 3: Интеграционные тесты импорта брендов** (AC: 1-5)
  - [ ] Добавить тест `test_process_brands_merges_duplicates` (например, в `backend/tests/integration/import/test_brand_import.py`), который импортирует «BoyBo» и «BOYBO» и подтверждает создание одного `Brand` и двух `Brand1CMapping`, проверяя лог статистики. [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
  - [ ] Добавить тест `test_process_brands_idempotent_reimport`, который повторно импортирует те же данные и ожидает `mappings_updated` без роста количества брендов. [Source: architecture/20-1c-integration.md#6-воркфлоу-импорта-каталога]
  - [ ] Использовать factories и фикстуры из `backend/tests/factories.py`, маркировать тесты `@pytest.mark.integration`, запускать через Docker (`docker compose run --rm backend pytest ...`). [Source: architecture/10-testing-strategy.md#требования-к-покрытию]

## Dev Notes

### Previous Story Insights

- Story 13.1 создала `Brand1CMapping`, `Brand.normalized_name` и функцию `normalize_brand_name`, а также убрала `Brand.onec_id`, поэтому текущий импорт должен работать только через нормализованное имя и таблицу маппингов. [Source: epics/epic-13/epic-13.brand-deduplication.md#story-131]
- Story 13.2 добавила поле `Product.onec_brand_id`, поэтому новые статистики и логи должны быть согласованы с уже существующими отчётами каталога (не нарушая связь SKU ↔ 1С бренд). [Source: docs/stories/epic-13/13.2.story.md]

### Data Models & Entities

- `Brand` теперь использует `normalized_name` как уникальный ключ дедупликации; `Brand1CMapping` хранит `onec_id`, `onec_name`, `brand` (CASCADE). [Source: epics/epic-13/epic-13.brand-deduplication.md#technical-notes]
- Все продукты ссылаются на `Brand` через FK `brand` с `PROTECT`, поэтому удаление бренда невозможно, что упрощает объединение при импорте. [Source: architecture/02-data-models.md#модели-каталога-товаров]

### Import Workflow & File Locations

- Импорт брендов является частью шага 0.6 команды `backend/apps/products/management/commands/import_catalog_from_1c.py`, где parser читает `propertiesGoods.xml`, а `ProductDataProcessor.process_brands()` создаёт/обновляет бренды. [Source: architecture/20-1c-integration.md#6-процессы-синхронизации]
- Код находится в `backend/apps/products/services/processor.py`; вспомогательные типы `BrandData` определены в `services/parser.py`. [Source: architecture/source-tree.md#backend]

### Logging & Metrics

- Импорт должен вести структурированные логи (уровни INFO/DEBUG) и поддерживать атрибуты `ImportSession`, чтобы отследить, какие бренды были слиты. [Source: architecture/12-error-handling.md#structured-logging]
- Статистика импорта хранится в `ImportLog`/CLI отчётах, поэтому необходимо синхронизировать новые счётчики и убедиться, что они отображаются в итоговых сообщениях. [Source: architecture/20-1c-integration.md#6-воркфлоу-импорта-каталога]

### Testing Requirements

- Следовать `pytest` + `pytest-django`, помечать интеграционные тесты `@pytest.mark.integration`, использовать Factory Boy и AAA-подход. [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
- Объём покрытия для критичных модулей импорта должен оставаться ≥90%; новые тесты должны проверять идемпотентность и корректность логов/статистики. [Source: architecture/10-testing-strategy.md#требования-к-покрытию]

### Technical Constraints

- Соблюдать стандарты кодирования (типизация, `from __future__ import annotations`, `black`, `isort`) и не нарушать идемпотентность импорта (повторный запуск не меняет существующие данные). [Source: architecture/coding-standards.md#backend-django]
- Не допускается выполнение команд на продакшн-сервере; локальные проверки — через Docker compose окружение, как описано в `docs/architecture/19-development-environment.md`. [Source: architecture/19-development-environment.md#docker-compose-workflow]

## Testing

- `backend/tests/integration/import/test_brand_import.py::test_process_brands_merges_duplicates`
- `backend/tests/integration/import/test_brand_import.py::test_process_brands_idempotent_reimport`
- `docker compose run --rm backend pytest backend/tests/integration/import/test_brand_import.py -k brand_import`

## Dev Agent Record

> Будет заполнено Dev Agent после реализации истории.

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-23 | 0.1 | Initial draft for Story 13.3 (brand import dedup) | SM Agent |
