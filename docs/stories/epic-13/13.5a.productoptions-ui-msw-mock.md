# Story 13.5a: ProductOptions UI component с MSW mock

## Status
Done

## Story
**Как** Frontend разработчик,
**Я хочу** создать компонент ProductOptions с mock-данными из MSW,
**Чтобы** начать разработку UI параллельно с backend и протестировать UX.

## Acceptance Criteria

1. Компонент `ProductOptions.tsx` создан в `src/components/product/`
2. Отображаются селекторы размеров (Size) как группа Chip компонентов
3. Отображаются селекторы цветов (Color) как группа Chip с цветовыми индикаторами
4. Недоступные опции (is_available: false) визуально отключены (opacity 0.5, disabled)
5. При клике на опцию обновляется состояние `selectedOptions`
6. Компонент использует дизайн-систему: Chip styles из front-end-spec.md
7. MSW mock настроен для `/products/{slug}/` с variants данными
8. Написаны unit тесты (Vitest + RTL) для отображения и взаимодействия

## Integration Verification
- IV1: Компонент корректно рендерится на странице `/catalog/[category]/[slug]`
- IV2: Стили соответствуют существующей дизайн-системе
- IV3: MSW mock возвращает данные в формате согласованного API контракта

## Tasks / Subtasks

- [x] Создать компонент ProductOptions.tsx (AC: 1, 2, 3)
  - [x] Создать файл `src/components/product/ProductOptions.tsx`
  - [x] Импортировать Chip компонент из UI kit
  - [x] Определить интерфейс `ProductOptionsProps`:
    ```typescript
    interface ProductOptionsProps {
      variants: ProductVariant[];
      selectedOptions: SelectedOptions;
      onSelectionChange: (options: SelectedOptions) => void;
    }
    ```
  - [x] Создать state для `selectedOptions` через useState
  - [x] Отобразить группу Size селекторов (Chip компоненты)
  - [x] Отобразить группу Color селекторов (Chip с цветовыми индикаторами)

- [x] Реализовать логику выбора опций (AC: 4, 5)
  - [x] Обработчик `handleSizeClick(size: string)`
  - [x] Обработчик `handleColorClick(color: string)`
  - [x] Обновление state `selectedOptions` при клике
  - [x] Вызов callback `onSelectionChange(newOptions)`
  - [x] Disabled state для недоступных опций (is_available: false)

- [x] Применить стили дизайн-системы (AC: 6, IV2)
  - [x] Chip Default: `bg-neutral-100`, `border-neutral-400`
  - [x] Chip Selected: `bg-primary`, `text-inverse`
  - [x] Chip Disabled: `opacity-50`, `cursor-not-allowed`
  - [x] Spacing: 24px между группами, 8px между Chip
  - [x] Typography: Montserrat 600 14px для заголовков групп
  - [x] Цветовые индикаторы: круглый 16px с border 2px

- [x] Настроить MSW mock для API (AC: 7, IV3)
  - [x] Создать файл `src/__mocks__/handlers/products.ts`
  - [x] Добавить handler для `GET /api/products/:slug/`
  - [x] Mock response с массивом `variants`:
    ```typescript
    {
      id: 1,
      name: "Кроссовки Nike Air Max",
      slug: "nike-air-max",
      variants: [
        {
          id: 1,
          sku: "NIKE-AM-RED-42",
          color_name: "Красный",
          color_hex: "#FF0000",
          size_value: "42",
          current_price: "5990.00",
          stock_quantity: 15,
          is_in_stock: true,
          available_quantity: 15,
        },
        // ... другие варианты
      ]
    }
    ```
  - [x] Зарегистрировать handler в MSW server

- [x] Интеграция с ProductSummary (AC: 5, IV1)
  - [x] Передать callback `onSelectionChange` из ProductSummary в ProductOptions
  - [x] Обновлять `selectedVariant` в ProductSummary при изменении выбора
  - [x] Отобразить ProductOptions внутри ProductSummary (согласно Story 12.2)

- [x] Написать unit тесты Vitest + RTL (AC: 8)
  - [x] Тест: компонент рендерится с селекторами размеров
  - [x] Тест: компонент рендерится с селекторами цветов
  - [x] Тест: недоступные опции визуально отключены (opacity-50)
  - [x] Тест: клик на размер обновляет selectedOptions
  - [x] Тест: клик на цвет обновляет selectedOptions
  - [x] Тест: callback onSelectionChange вызывается при выборе
  - [x] Тест: disabled опции не реагируют на клик
  - [x] Тест: применены корректные стили дизайн-системы

- [x] Accessibility проверка (AC: 6)
  - [x] role="radio" для Chip компонентов
  - [x] aria-checked для выбранных опций
  - [x] aria-disabled для недоступных опций
  - [x] Keyboard navigation (Tab, Enter, Space)

- [x] Проверка Integration Verification (IV1, IV2, IV3)
  - [x] IV1: ProductOptions рендерится на странице товара без ошибок
  - [x] IV2: Стили соответствуют Chip компоненту из дизайн-системы
  - [x] IV3: MSW mock возвращает структуру согласно ProductVariantSchema

## Dev Notes

### Relevant Source Tree
```
frontend/src/
├── components/
│   └── product/
│       ├── ProductOptions.tsx       (NEW)
│       ├── ProductSummary.tsx       (UPDATE - интеграция)
│       └── __tests__/
│           └── ProductOptions.test.tsx  (NEW)
├── __mocks__/
│   └── handlers/
│       └── products.ts              (UPDATE - MSW mock)
└── types/
    └── product.ts                   (NEW - локальные типы до api.generated.ts)
```

### ProductOptions Component Implementation

**Базовая структура компонента:**

```typescript
// src/components/product/ProductOptions.tsx
'use client';

import React, { useState } from 'react';
import { Chip } from '@/components/ui/Chip';

export interface ProductVariant {
  id: number;
  sku: string;
  color_name?: string;
  color_hex?: string | null;
  size_value?: string;
  current_price: string;
  stock_quantity: number;
  is_in_stock: boolean;
  available_quantity: number;
}

export interface SelectedOptions {
  size?: string;
  color?: string;
}

export interface ProductOptionsProps {
  variants: ProductVariant[];
  selectedOptions: SelectedOptions;
  onSelectionChange: (options: SelectedOptions) => void;
}

export const ProductOptions: React.FC<ProductOptionsProps> = ({
  variants,
  selectedOptions,
  onSelectionChange,
}) => {
  // Извлечь уникальные размеры и цвета
  const sizes = [...new Set(variants.map(v => v.size_value).filter(Boolean))];
  const colors = [...new Set(variants.map(v => v.color_name).filter(Boolean))];

  const handleSizeClick = (size: string) => {
    const newOptions = { ...selectedOptions, size };
    onSelectionChange(newOptions);
  };

  const handleColorClick = (color: string) => {
    const newOptions = { ...selectedOptions, color };
    onSelectionChange(newOptions);
  };

  // Проверить доступность опции
  const isSizeAvailable = (size: string) => {
    return variants.some(
      v => v.size_value === size && v.is_in_stock
    );
  };

  const isColorAvailable = (color: string) => {
    return variants.some(
      v => v.color_name === color && v.is_in_stock
    );
  };

  return (
    <div className="space-y-6">
      {/* Селектор размеров */}
      {sizes.length > 0 && (
        <div className="space-y-2">
          <h3 className="text-sm font-semibold font-montserrat">Размер</h3>
          <div className="flex flex-wrap gap-2">
            {sizes.map((size) => {
              const available = isSizeAvailable(size);
              const selected = selectedOptions.size === size;

              return (
                <Chip
                  key={size}
                  label={size}
                  selected={selected}
                  disabled={!available}
                  onClick={() => available && handleSizeClick(size)}
                  role="radio"
                  aria-checked={selected}
                  aria-disabled={!available}
                />
              );
            })}
          </div>
        </div>
      )}

      {/* Селектор цветов */}
      {colors.length > 0 && (
        <div className="space-y-2">
          <h3 className="text-sm font-semibold font-montserrat">Цвет</h3>
          <div className="flex flex-wrap gap-2">
            {colors.map((color) => {
              const variant = variants.find(v => v.color_name === color);
              const available = isColorAvailable(color);
              const selected = selectedOptions.color === color;

              return (
                <Chip
                  key={color}
                  label={color}
                  selected={selected}
                  disabled={!available}
                  onClick={() => available && handleColorClick(color)}
                  colorHex={variant?.color_hex || undefined}
                  role="radio"
                  aria-checked={selected}
                  aria-disabled={!available}
                />
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};
```

### MSW Mock Handler

**src/__mocks__/handlers/products.ts:**

```typescript
import { http, HttpResponse } from 'msw';

export const productHandlers = [
  http.get('/api/products/:slug/', ({ params }) => {
    const { slug } = params;

    // Mock data с вариантами
    const mockProduct = {
      id: 1,
      name: 'Кроссовки Nike Air Max',
      slug: slug,
      description: 'Описание товара',
      variants: [
        {
          id: 1,
          sku: 'NIKE-AM-RED-42',
          color_name: 'Красный',
          color_hex: '#FF0000',
          size_value: '42',
          current_price: '5990.00',
          stock_quantity: 15,
          is_in_stock: true,
          available_quantity: 15,
        },
        {
          id: 2,
          sku: 'NIKE-AM-RED-43',
          color_name: 'Красный',
          color_hex: '#FF0000',
          size_value: '43',
          current_price: '5990.00',
          stock_quantity: 0,
          is_in_stock: false,
          available_quantity: 0,
        },
        {
          id: 3,
          sku: 'NIKE-AM-BLUE-42',
          color_name: 'Синий',
          color_hex: '#0000FF',
          size_value: '42',
          current_price: '5990.00',
          stock_quantity: 10,
          is_in_stock: true,
          available_quantity: 10,
        },
      ],
    };

    return HttpResponse.json(mockProduct);
  }),
];
```

### Chip Component Props

**На основе дизайн-системы front-end-spec.md:**

```typescript
interface ChipProps {
  label: string;
  selected?: boolean;
  disabled?: boolean;
  onClick?: () => void;
  colorHex?: string;  // Для цветового индикатора
  role?: string;
  'aria-checked'?: boolean;
  'aria-disabled'?: boolean;
}
```

**Chip CSS (Tailwind):**

```css
/* Default state */
.chip-default {
  @apply bg-neutral-100 border border-neutral-400 rounded-2xl px-4 py-2;
}

/* Selected state */
.chip-selected {
  @apply bg-primary text-inverse border-primary;
}

/* Disabled state */
.chip-disabled {
  @apply opacity-50 cursor-not-allowed;
}
```

### Vitest + RTL Tests

**src/components/product/__tests__/ProductOptions.test.tsx:**

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { ProductOptions, ProductVariant, SelectedOptions } from '../ProductOptions';

const mockVariants: ProductVariant[] = [
  {
    id: 1,
    sku: 'TEST-RED-42',
    color_name: 'Красный',
    color_hex: '#FF0000',
    size_value: '42',
    current_price: '5990.00',
    stock_quantity: 15,
    is_in_stock: true,
    available_quantity: 15,
  },
  {
    id: 2,
    sku: 'TEST-RED-43',
    color_name: 'Красный',
    color_hex: '#FF0000',
    size_value: '43',
    current_price: '5990.00',
    stock_quantity: 0,
    is_in_stock: false,
    available_quantity: 0,
  },
];

describe('ProductOptions', () => {
  it('renders size selectors', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    expect(screen.getByText('42')).toBeInTheDocument();
    expect(screen.getByText('43')).toBeInTheDocument();
  });

  it('renders color selectors', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    expect(screen.getAllByText('Красный')).toHaveLength(1);
  });

  it('disables unavailable options', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    const size43Chip = screen.getByText('43');
    expect(size43Chip).toHaveClass('opacity-50');
    expect(size43Chip).toHaveAttribute('aria-disabled', 'true');
  });

  it('updates selected options on size click', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    const size42Chip = screen.getByText('42');
    fireEvent.click(size42Chip);

    expect(onSelectionChange).toHaveBeenCalledWith({ size: '42' });
  });

  it('does not call callback for disabled options', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    const size43Chip = screen.getByText('43');
    fireEvent.click(size43Chip);

    expect(onSelectionChange).not.toHaveBeenCalled();
  });
});
```

### Design System Reference

**Из front-end-spec.md:**

#### Chip Component Specs

- **Border radius:** 16px
- **Padding:** 8px 16px
- **Typography:** Open Sans 400 14px
- **Default:** bg-neutral-100, border-neutral-400
- **Selected:** bg-primary (#004DFF), text-inverse (#FFFFFF)
- **Disabled:** opacity 0.5, cursor not-allowed
- **Hover:** border-color: primary
- **Active:** scale(0.95)

#### Color Indicator Specs

- **Size:** 16px круглый индикатор
- **Border:** 2px solid (border-neutral-400)
- **Position:** Inline слева от текста

#### Spacing

- **Between groups:** 24px (space-y-6)
- **Between chips:** 8px (gap-2)
- **From gallery:** 32px margin-top

### Testing Standards

**Из CLAUDE.md Section: Frontend тестирование:**

#### Test file location
- `frontend/src/components/product/__tests__/ProductOptions.test.tsx`

#### Test frameworks
- **Framework:** Vitest 2.1.5
- **UI Testing:** React Testing Library 16.3.0
- **Mocking:** MSW 2.12.2

#### Coverage requirements
- **Minimum coverage:** >= 80% для нового компонента
- **Command:** `npm run test:coverage`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание Story 13.5a на основе Epic 13 PRD | Sarah (PO) |

## Dev Agent Record
(Заполняется dev-агентом)

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Review Type: Pre-Implementation Architecture Review

**Примечание:** Story находится в статусе Draft. Данный review является архитектурным pre-review для оценки готовности спецификации и существующей реализации.

### Обнаружено: Реализация уже выполнена

При проверке обнаружено, что компонент **уже полностью реализован**:

| Артефакт | Статус | Путь |
|----------|--------|------|
| ProductOptions.tsx | ✅ Создан | `frontend/src/components/product/ProductOptions.tsx` |
| ProductOptions.test.tsx | ✅ Создан | `frontend/src/components/product/__tests__/ProductOptions.test.tsx` |
| MSW handlers | ✅ Настроены | `frontend/src/__mocks__/api/handlers.ts` |
| ProductSummary интеграция | ✅ Выполнена | `frontend/src/components/product/ProductSummary.tsx` |
| Mock данные | ✅ Созданы | `frontend/src/__mocks__/productDetail.ts` |

### Code Quality Assessment

**Оценка: Отлично (A)**

Реализация демонстрирует высокое качество кода:

- **Архитектура:** Компонент правильно разделен на `OptionChip` (внутренний) и `ProductOptions` (публичный)
- **Типизация:** Полная TypeScript типизация с экспортируемыми интерфейсами
- **Оптимизация:** Корректное использование `useMemo` и `useCallback` для предотвращения лишних ре-рендеров
- **Документация:** JSDoc комментарии на уровне функций и компонентов

### Refactoring Performed

Рефакторинг не требуется — код соответствует стандартам проекта.

### Compliance Check

- **Coding Standards:** ✅ Соответствует `docs/architecture/coding-standards.md`
- **Project Structure:** ✅ Файлы размещены согласно `docs/architecture/source-tree.md`
- **Testing Strategy:** ✅ 37 unit тестов покрывают все AC
- **All ACs Met:** ✅ Все 8 Acceptance Criteria выполнены

### Acceptance Criteria Validation

| AC | Описание | Статус | Доказательство |
|----|----------|--------|----------------|
| 1 | Компонент создан в `src/components/product/` | ✅ | `ProductOptions.tsx` (291 строка) |
| 2 | Селекторы размеров как Chip | ✅ | `sizes.map()` с `OptionChip` |
| 3 | Селекторы цветов с индикаторами | ✅ | `colorHex` prop + цветовой круг 16px |
| 4 | Disabled state (opacity 0.5) | ✅ | `disabled && 'opacity-50 cursor-not-allowed'` |
| 5 | Обновление selectedOptions | ✅ | `handleSizeClick`, `handleColorClick` |
| 6 | Дизайн-система Chip | ✅ | `rounded-2xl`, `px-4 py-2`, `space-y-6`, `gap-2` |
| 7 | MSW mock настроен | ✅ | Handler для `nike-air-max` с `MOCK_PRODUCT_WITH_VARIANTS` |
| 8 | Unit тесты написаны | ✅ | 37 тестов в `ProductOptions.test.tsx` |

### Test Results

```
✓ ProductOptions (37 tests) - 517ms
  ✓ Рендеринг (7)
  ✓ Disabled state (AC: 4) (4)
  ✓ Взаимодействие (AC: 5) (5)
  ✓ Selected state (3)
  ✓ Accessibility (AC: 6) (9)
  ✓ Стили дизайн-системы (AC: 6, IV2) (6)
  ✓ Edge cases (3)
```

### Accessibility Review

✅ **Полное соответствие WCAG 2.1 AA:**

- `role="radiogroup"` для групп опций
- `role="radio"` для каждой опции
- `aria-checked` для выбранных
- `aria-disabled` для недоступных
- `aria-label` для групп ("Выбор размера", "Выбор цвета")
- Keyboard navigation (Enter, Space)
- `tabIndex=-1` для disabled опций

### Security Review

✅ Нет security concerns — компонент только отображает данные, не обрабатывает пользовательский ввод.

### Performance Considerations

✅ Оптимизации применены корректно:
- `useMemo` для извлечения уникальных sizes/colors
- `useCallback` для обработчиков событий
- Условный рендеринг при пустых вариантах

### Improvements Checklist

- [x] Компонент ProductOptions реализован
- [x] Внутренний OptionChip с accessibility
- [x] MSW mock для /api/products/:slug/
- [x] Интеграция с ProductSummary
- [x] 37 unit тестов
- [ ] Рассмотреть интеграционные тесты ProductSummary + ProductOptions
- [ ] Добавить тесты для MSW handlers в изоляции

### Files Modified During Review

Нет — код соответствует стандартам, рефакторинг не требовался.

### Gate Status

**Gate: PASS** → `docs/qa/gates/13.5a-productoptions-ui-msw-mock.yml`

### Recommended Status

**✅ Ready for Done**

Story полностью реализована и протестирована. Рекомендуется обновить статус с "Draft" на "Done".
