# Story 13.5a: ProductOptions UI component с MSW mock

## Status
Draft

## Story
**Как** Frontend разработчик,
**Я хочу** создать компонент ProductOptions с mock-данными из MSW,
**Чтобы** начать разработку UI параллельно с backend и протестировать UX.

## Acceptance Criteria

1. Компонент `ProductOptions.tsx` создан в `src/components/product/`
2. Отображаются селекторы размеров (Size) как группа Chip компонентов
3. Отображаются селекторы цветов (Color) как группа Chip с цветовыми индикаторами
4. Недоступные опции (is_available: false) визуально отключены (opacity 0.5, disabled)
5. При клике на опцию обновляется состояние `selectedOptions`
6. Компонент использует дизайн-систему: Chip styles из front-end-spec.md
7. MSW mock настроен для `/products/{slug}/` с variants данными
8. Написаны unit тесты (Vitest + RTL) для отображения и взаимодействия

## Integration Verification
- IV1: Компонент корректно рендерится на странице `/catalog/[category]/[slug]`
- IV2: Стили соответствуют существующей дизайн-системе
- IV3: MSW mock возвращает данные в формате согласованного API контракта

## Tasks / Subtasks

- [ ] Создать компонент ProductOptions.tsx (AC: 1, 2, 3)
  - [ ] Создать файл `src/components/product/ProductOptions.tsx`
  - [ ] Импортировать Chip компонент из UI kit
  - [ ] Определить интерфейс `ProductOptionsProps`:
    ```typescript
    interface ProductOptionsProps {
      variants: ProductVariant[];
      selectedOptions: SelectedOptions;
      onSelectionChange: (options: SelectedOptions) => void;
    }
    ```
  - [ ] Создать state для `selectedOptions` через useState
  - [ ] Отобразить группу Size селекторов (Chip компоненты)
  - [ ] Отобразить группу Color селекторов (Chip с цветовыми индикаторами)

- [ ] Реализовать логику выбора опций (AC: 4, 5)
  - [ ] Обработчик `handleSizeClick(size: string)`
  - [ ] Обработчик `handleColorClick(color: string)`
  - [ ] Обновление state `selectedOptions` при клике
  - [ ] Вызов callback `onSelectionChange(newOptions)`
  - [ ] Disabled state для недоступных опций (is_available: false)

- [ ] Применить стили дизайн-системы (AC: 6, IV2)
  - [ ] Chip Default: `bg-neutral-100`, `border-neutral-400`
  - [ ] Chip Selected: `bg-primary`, `text-inverse`
  - [ ] Chip Disabled: `opacity-50`, `cursor-not-allowed`
  - [ ] Spacing: 24px между группами, 8px между Chip
  - [ ] Typography: Montserrat 600 14px для заголовков групп
  - [ ] Цветовые индикаторы: круглый 16px с border 2px

- [ ] Настроить MSW mock для API (AC: 7, IV3)
  - [ ] Создать файл `src/__mocks__/handlers/products.ts`
  - [ ] Добавить handler для `GET /api/products/:slug/`
  - [ ] Mock response с массивом `variants`:
    ```typescript
    {
      id: 1,
      name: "Кроссовки Nike Air Max",
      slug: "nike-air-max",
      variants: [
        {
          id: 1,
          sku: "NIKE-AM-RED-42",
          color_name: "Красный",
          color_hex: "#FF0000",
          size_value: "42",
          current_price: "5990.00",
          stock_quantity: 15,
          is_in_stock: true,
          available_quantity: 15,
        },
        // ... другие варианты
      ]
    }
    ```
  - [ ] Зарегистрировать handler в MSW server

- [ ] Интеграция с ProductSummary (AC: 5, IV1)
  - [ ] Передать callback `onSelectionChange` из ProductSummary в ProductOptions
  - [ ] Обновлять `selectedVariant` в ProductSummary при изменении выбора
  - [ ] Отобразить ProductOptions внутри ProductSummary (согласно Story 12.2)

- [ ] Написать unit тесты Vitest + RTL (AC: 8)
  - [ ] Тест: компонент рендерится с селекторами размеров
  - [ ] Тест: компонент рендерится с селекторами цветов
  - [ ] Тест: недоступные опции визуально отключены (opacity-50)
  - [ ] Тест: клик на размер обновляет selectedOptions
  - [ ] Тест: клик на цвет обновляет selectedOptions
  - [ ] Тест: callback onSelectionChange вызывается при выборе
  - [ ] Тест: disabled опции не реагируют на клик
  - [ ] Тест: применены корректные стили дизайн-системы

- [ ] Accessibility проверка (AC: 6)
  - [ ] role="radio" для Chip компонентов
  - [ ] aria-checked для выбранных опций
  - [ ] aria-disabled для недоступных опций
  - [ ] Keyboard navigation (Tab, Enter, Space)

- [ ] Проверка Integration Verification (IV1, IV2, IV3)
  - [ ] IV1: ProductOptions рендерится на странице товара без ошибок
  - [ ] IV2: Стили соответствуют Chip компоненту из дизайн-системы
  - [ ] IV3: MSW mock возвращает структуру согласно ProductVariantSchema

## Dev Notes

### Relevant Source Tree
```
frontend/src/
├── components/
│   └── product/
│       ├── ProductOptions.tsx       (NEW)
│       ├── ProductSummary.tsx       (UPDATE - интеграция)
│       └── __tests__/
│           └── ProductOptions.test.tsx  (NEW)
├── __mocks__/
│   └── handlers/
│       └── products.ts              (UPDATE - MSW mock)
└── types/
    └── product.ts                   (NEW - локальные типы до api.generated.ts)
```

### ProductOptions Component Implementation

**Базовая структура компонента:**

```typescript
// src/components/product/ProductOptions.tsx
'use client';

import React, { useState } from 'react';
import { Chip } from '@/components/ui/Chip';

export interface ProductVariant {
  id: number;
  sku: string;
  color_name?: string;
  color_hex?: string | null;
  size_value?: string;
  current_price: string;
  stock_quantity: number;
  is_in_stock: boolean;
  available_quantity: number;
}

export interface SelectedOptions {
  size?: string;
  color?: string;
}

export interface ProductOptionsProps {
  variants: ProductVariant[];
  selectedOptions: SelectedOptions;
  onSelectionChange: (options: SelectedOptions) => void;
}

export const ProductOptions: React.FC<ProductOptionsProps> = ({
  variants,
  selectedOptions,
  onSelectionChange,
}) => {
  // Извлечь уникальные размеры и цвета
  const sizes = [...new Set(variants.map(v => v.size_value).filter(Boolean))];
  const colors = [...new Set(variants.map(v => v.color_name).filter(Boolean))];

  const handleSizeClick = (size: string) => {
    const newOptions = { ...selectedOptions, size };
    onSelectionChange(newOptions);
  };

  const handleColorClick = (color: string) => {
    const newOptions = { ...selectedOptions, color };
    onSelectionChange(newOptions);
  };

  // Проверить доступность опции
  const isSizeAvailable = (size: string) => {
    return variants.some(
      v => v.size_value === size && v.is_in_stock
    );
  };

  const isColorAvailable = (color: string) => {
    return variants.some(
      v => v.color_name === color && v.is_in_stock
    );
  };

  return (
    <div className="space-y-6">
      {/* Селектор размеров */}
      {sizes.length > 0 && (
        <div className="space-y-2">
          <h3 className="text-sm font-semibold font-montserrat">Размер</h3>
          <div className="flex flex-wrap gap-2">
            {sizes.map((size) => {
              const available = isSizeAvailable(size);
              const selected = selectedOptions.size === size;

              return (
                <Chip
                  key={size}
                  label={size}
                  selected={selected}
                  disabled={!available}
                  onClick={() => available && handleSizeClick(size)}
                  role="radio"
                  aria-checked={selected}
                  aria-disabled={!available}
                />
              );
            })}
          </div>
        </div>
      )}

      {/* Селектор цветов */}
      {colors.length > 0 && (
        <div className="space-y-2">
          <h3 className="text-sm font-semibold font-montserrat">Цвет</h3>
          <div className="flex flex-wrap gap-2">
            {colors.map((color) => {
              const variant = variants.find(v => v.color_name === color);
              const available = isColorAvailable(color);
              const selected = selectedOptions.color === color;

              return (
                <Chip
                  key={color}
                  label={color}
                  selected={selected}
                  disabled={!available}
                  onClick={() => available && handleColorClick(color)}
                  colorHex={variant?.color_hex || undefined}
                  role="radio"
                  aria-checked={selected}
                  aria-disabled={!available}
                />
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};
```

### MSW Mock Handler

**src/__mocks__/handlers/products.ts:**

```typescript
import { http, HttpResponse } from 'msw';

export const productHandlers = [
  http.get('/api/products/:slug/', ({ params }) => {
    const { slug } = params;

    // Mock data с вариантами
    const mockProduct = {
      id: 1,
      name: 'Кроссовки Nike Air Max',
      slug: slug,
      description: 'Описание товара',
      variants: [
        {
          id: 1,
          sku: 'NIKE-AM-RED-42',
          color_name: 'Красный',
          color_hex: '#FF0000',
          size_value: '42',
          current_price: '5990.00',
          stock_quantity: 15,
          is_in_stock: true,
          available_quantity: 15,
        },
        {
          id: 2,
          sku: 'NIKE-AM-RED-43',
          color_name: 'Красный',
          color_hex: '#FF0000',
          size_value: '43',
          current_price: '5990.00',
          stock_quantity: 0,
          is_in_stock: false,
          available_quantity: 0,
        },
        {
          id: 3,
          sku: 'NIKE-AM-BLUE-42',
          color_name: 'Синий',
          color_hex: '#0000FF',
          size_value: '42',
          current_price: '5990.00',
          stock_quantity: 10,
          is_in_stock: true,
          available_quantity: 10,
        },
      ],
    };

    return HttpResponse.json(mockProduct);
  }),
];
```

### Chip Component Props

**На основе дизайн-системы front-end-spec.md:**

```typescript
interface ChipProps {
  label: string;
  selected?: boolean;
  disabled?: boolean;
  onClick?: () => void;
  colorHex?: string;  // Для цветового индикатора
  role?: string;
  'aria-checked'?: boolean;
  'aria-disabled'?: boolean;
}
```

**Chip CSS (Tailwind):**

```css
/* Default state */
.chip-default {
  @apply bg-neutral-100 border border-neutral-400 rounded-2xl px-4 py-2;
}

/* Selected state */
.chip-selected {
  @apply bg-primary text-inverse border-primary;
}

/* Disabled state */
.chip-disabled {
  @apply opacity-50 cursor-not-allowed;
}
```

### Vitest + RTL Tests

**src/components/product/__tests__/ProductOptions.test.tsx:**

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { ProductOptions, ProductVariant, SelectedOptions } from '../ProductOptions';

const mockVariants: ProductVariant[] = [
  {
    id: 1,
    sku: 'TEST-RED-42',
    color_name: 'Красный',
    color_hex: '#FF0000',
    size_value: '42',
    current_price: '5990.00',
    stock_quantity: 15,
    is_in_stock: true,
    available_quantity: 15,
  },
  {
    id: 2,
    sku: 'TEST-RED-43',
    color_name: 'Красный',
    color_hex: '#FF0000',
    size_value: '43',
    current_price: '5990.00',
    stock_quantity: 0,
    is_in_stock: false,
    available_quantity: 0,
  },
];

describe('ProductOptions', () => {
  it('renders size selectors', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    expect(screen.getByText('42')).toBeInTheDocument();
    expect(screen.getByText('43')).toBeInTheDocument();
  });

  it('renders color selectors', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    expect(screen.getAllByText('Красный')).toHaveLength(1);
  });

  it('disables unavailable options', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    const size43Chip = screen.getByText('43');
    expect(size43Chip).toHaveClass('opacity-50');
    expect(size43Chip).toHaveAttribute('aria-disabled', 'true');
  });

  it('updates selected options on size click', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    const size42Chip = screen.getByText('42');
    fireEvent.click(size42Chip);

    expect(onSelectionChange).toHaveBeenCalledWith({ size: '42' });
  });

  it('does not call callback for disabled options', () => {
    const onSelectionChange = vi.fn();
    render(
      <ProductOptions
        variants={mockVariants}
        selectedOptions={{}}
        onSelectionChange={onSelectionChange}
      />
    );

    const size43Chip = screen.getByText('43');
    fireEvent.click(size43Chip);

    expect(onSelectionChange).not.toHaveBeenCalled();
  });
});
```

### Design System Reference

**Из front-end-spec.md:**

#### Chip Component Specs

- **Border radius:** 16px
- **Padding:** 8px 16px
- **Typography:** Open Sans 400 14px
- **Default:** bg-neutral-100, border-neutral-400
- **Selected:** bg-primary (#004DFF), text-inverse (#FFFFFF)
- **Disabled:** opacity 0.5, cursor not-allowed
- **Hover:** border-color: primary
- **Active:** scale(0.95)

#### Color Indicator Specs

- **Size:** 16px круглый индикатор
- **Border:** 2px solid (border-neutral-400)
- **Position:** Inline слева от текста

#### Spacing

- **Between groups:** 24px (space-y-6)
- **Between chips:** 8px (gap-2)
- **From gallery:** 32px margin-top

### Testing Standards

**Из CLAUDE.md Section: Frontend тестирование:**

#### Test file location
- `frontend/src/components/product/__tests__/ProductOptions.test.tsx`

#### Test frameworks
- **Framework:** Vitest 2.1.5
- **UI Testing:** React Testing Library 16.3.0
- **Mocking:** MSW 2.12.2

#### Coverage requirements
- **Minimum coverage:** >= 80% для нового компонента
- **Command:** `npm run test:coverage`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание Story 13.5a на основе Epic 13 PRD | Sarah (PO) |

## Dev Agent Record
(Заполняется dev-агентом)

## QA Results
(Заполняется QA-агентом)
