# Story 13.5: Django Admin для управления брендами

## Status

Draft  
> Story может стартовать только после перевода Stories 13.1–13.4 в состояние **Done**, чтобы модель `Brand1CMapping`, поле `Product.onec_brand_id` и обновлённый импорт брендов/товаров уже работали. [Source: epics/epic-13/epic-13.brand-deduplication.md#stories]

## Story

**As a** администратор каталога,
**I want** управлять master-брендами и их маппингами 1С из Django Admin,
**so that** можно вручную объединять/разъединять бренды после дедупликации и поддерживать корректную связь с исходными 1С идентификаторами.

## Acceptance Criteria

1. В `BrandAdmin` отображается inline `Brand1CMappingInline` со всеми маппингами.
2. В `BrandAdmin.list_display` отображается количество маппингов (`mappings_count`).
3. Доступно массовое действие "Объединить выбранные бренды" (`merge_brands`).
4. После объединения: все маппинги переносятся на целевой бренд, исходные бренды удаляются.
5. Создан `Brand1CMappingAdmin` для управления отдельными маппингами.
6. В `Brand1CMappingAdmin` доступно действие "Перенести на другой бренд".

## Tasks / Subtasks

- [ ] **Task 1: Инлайн маппингов и счётчик в BrandAdmin** (AC: 1, 2)  
  - [ ] Создать `Brand1CMappingInline(admin.TabularInline)` в `backend/apps/products/admin.py`, привязанный к `Brand1CMapping`, чтобы администраторы видели все сопоставления прямо на карточке бренда. [Source: architecture/source-tree.md#backend]
  - [ ] Добавить в `BrandAdmin` поле `mappings_count`, вычисляемое через `annotate(Count('onec_mappings'))` в `get_queryset` и отображаемое в `list_display`, обеспечив `short_description` и сортировку. [Source: architecture/02-data-models.md#модели-каталога-товаров]
  - [ ] Включить inline в `BrandAdmin.inlines`, а также добавить `search_fields`/`list_filter` по `normalized_name`, чтобы упростить поиск целевых брендов. [Source: architecture/coding-standards.md#backend-django]

- [ ] **Task 2: Массовое действие `merge_brands`** (AC: 3, 4)  
  - [ ] Реализовать `merge_brands` в `BrandAdmin`, добавив форму выбора целевого бренда на основе отдельного класса `forms.Form` (например, `MergeBrandsActionForm`) из `backend/apps/products/forms.py` для расширенной валидации. [Source: epics/epic-13/epic-13.brand-deduplication.md#story-135]
  - [ ] Внутри действия переносить все связанные `Brand1CMapping` и объекты `Product` на целевой бренд, учитывая `Product.brand` c `on_delete=PROTECT`, после чего удалять исходные бренды. [Source: architecture/02-data-models.md#модели-каталога-товаров]
  - [ ] Логировать результат операции через Django logger (INFO/WARNING) для трассировки ручных объединений и обновлять админские сообщения пользователю. [Source: architecture/12-error-handling.md#structured-logging]

- [ ] **Task 3: Brand1CMappingAdmin и перенос отдельных маппингов** (AC: 5, 6)  
  - [ ] Зарегистрировать `Brand1CMappingAdmin` с `list_display = ('onec_id', 'onec_name', 'brand', 'created_at')`, фильтрами по бренду и поиском по `onec_id/onec_name`. [Source: epics/epic-13/epic-13.brand-deduplication.md#technical-notes]
  - [ ] Добавить действие `transfer_to_brand`, которое позволяет выбрать целевой бренд и обновить поле `brand` у выбранных маппингов без удаления брендов. [Source: architecture/02-data-models.md#модели-каталога-товаров]
  - [ ] Обеспечить валидацию формы действия (нельзя переносить без выбора бренда) и вывод статуса в UI. [Source: architecture/coding-standards.md#backend-django]

- [ ] **Task 4: Admin-тесты и QA сценарии** (AC: 1-6)  
  - [ ] Расширить `backend/tests/unit/test_admin/test_products_admin.py` интеграционными тестами Django Admin, покрывающими inline, счётчик, действия `merge_brands` и `transfer_to_brand` (использовать `admin_client`, factory Boy). [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
  - [ ] Добавить smoke-тесты для сообщений об ошибках (например, отсутствие выбранного целевого бренда) и для корректного удаления исходных брендов при наличии привязанных товаров. [Source: architecture/12-error-handling.md#structured-logging]
  - [ ] Обновить документацию QA (если требуется) ссылкой на новые ручные сценарии проверки объединения брендов. [Source: docs/qa]

## Dev Notes

### Previous Story Insights
- Story 13.1 ввела `Brand1CMapping`, убрала `Brand.onec_id` и добавила `normalized_name`, поэтому админка должна работать с новыми сущностями и избегать прямых обращений к удалённому полю. [Source: docs/stories/epic-13/13.1.story.md]
- Story 13.2 добавила `Product.onec_brand_id`, поэтому при объединении брендов необходимо сохранять связь товаров с исходным `onec_brand_id`, не затрагивая поле. [Source: docs/stories/epic-13/13.2.story.md]
- Story 13.3/13.4 обеспечивают дедупликацию и импорт брендов, значит админские действия должны быть идемпотентны и учитывать, что бренды уже могут иметь множество маппингов. [Source: docs/stories/epic-13/13.4.story.md]

### Data Models & Entities
- `Brand` хранит мастер-бренд, защищён связями `Product.brand = PROTECT`, поэтому перед удалением бренд необходимо освободить от связей. [Source: architecture/02-data-models.md#модели-каталога-товаров]
- `Brand1CMapping` содержит `onec_id`, `onec_name` и FK на `Brand` (CASCADE), что упрощает перенос маппингов при объединении. [Source: epics/epic-13/epic-13.brand-deduplication.md#technical-notes]

### Admin Workflows & Component Specs
- Django Admin используется как системный инструмент управления каталогом, поэтому все действия должны работать через стандартные admin actions/forms и соблюдать RBAC, описанный в архитектуре. [Source: architecture/06-system-architecture.md#стратегия-админ-панели-гибридный-подход]
- Для действий `merge_brands` и `transfer_to_brand` используем отдельные формы (`forms.Form`) в `backend/apps/products/forms.py`, чтобы гарантировать строгую валидацию входных данных и переиспользование логики. [Source: architecture/coding-standards.md#backend-django]

### File Locations
- Все изменения размещаются в `backend/apps/products/admin.py`, `backend/apps/products/forms.py` (если понадобится отдельная форма), а тесты — в `backend/tests/unit/test_admin/`. [Source: architecture/source-tree.md#backend]

### Testing Requirements
- Тестовые файлы: `backend/tests/unit/test_admin/test_products_admin.py` (unit/integration подход для Django Admin). [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
- Frameworks: `pytest`, `pytest-django`, factory boy; обязательно использовать `admin_client` для действий и `@pytest.mark.django_db`. [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
- Покрытие: критичные admin операции ≥90%; включить smoke-тесты ошибок (нет выбранного бренда, попытка переноса без формы). [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
- Логирование: проверять, что structured logging фиксирует результаты объединения и переноса (`INFO`/`WARNING`). [Source: architecture/12-error-handling.md#structured-logging]
- Маркировка тестов: `@pytest.mark.integration` для сценариев, охватывающих перенос маппингов и удаление брендов. [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]

### Technical Constraints
- Соблюдать стандарты кодирования: `from __future__ import annotations`, типизация методов, `black`/`isort` порядок импортов. [Source: architecture/coding-standards.md#backend-django]
- Логирование ручных операций обязано следовать формату structured logging для дальнейшего аудита. [Source: architecture/12-error-handling.md#structured-logging]

### Project Structure Notes
- Реализация должна сохранять текущую организацию файлов и не добавлять новые приложения; расширения админки и форм выполняются внутри `apps/products`. [Source: architecture/source-tree.md#backend]

## Dev Agent Record

### Agent Model Used
Заполняется Dev Agent при реализации

### Debug Log References
Заполняется Dev Agent: ссылки на debug-логи, если возникали проблемы

### Completion Notes List
- [ ] Все задачи выполнены
- [ ] Код изменён согласно спецификации
- [ ] Тесты проходят (admin actions + линтеры)
- [ ] Журналы логов отражают ручные операции
- [ ] Code review пройден

### File List (to be maintained by Dev Agent)
| File | Change Type | Description |
| --- | --- | --- |
| `backend/apps/products/admin.py` | Modified | Добавлены inline, действия, счётчик маппингов |
| `backend/apps/products/forms.py` | Added/Modified | Форма для выбора целевого бренда в admin actions |
| `backend/tests/unit/test_admin/test_products_admin.py` | Modified | Покрытие inline и действий тестами |
| ... | ... | ... |

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-24 | v0.2 | Добавлены уточнения по тестированию, формам и Change Log | PO |

## QA Results
Заполняется QA Agent после тестирования
