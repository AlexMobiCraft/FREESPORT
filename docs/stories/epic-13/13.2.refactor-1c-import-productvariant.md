# Story 13.2: Рефакторинг импорта из 1С для ProductVariant

## Status
Draft

## Story
**Как** Backend разработчик,
**Я хочу** обновить импорт из 1С для создания Product + ProductVariant,
**Чтобы** корректно импортировать товары с вариантами из CommerceML 3.1.

## Acceptance Criteria

1. Парсер `goods.xml` создаёт один `Product` из `<Товар>` с базовой информацией
2. Парсер `offers.xml` создаёт `ProductVariant` из каждого `<Предложение>` с маппингом parent_id#variant_id (FR4)
3. Обрабатываются некорректные данные: пропуск `<Предложение>` без parent с логированием warning (FR4a)
4. Характеристики (цвет, размер) из `<ХарактеристикиТовара>` записываются в `color_name`, `size_value`
5. Товары без вариантов автоматически создают один ProductVariant (FR10a)
6. Изображения из `<Картинка>` записываются в `ProductVariant.main_image` и `gallery_images`
7. Цены из `prices.xml` обновляют соответствующие поля ProductVariant
8. Остатки из `rests.xml` обновляют `ProductVariant.stock_quantity`
9. Batch processing по 500 записей для контроля памяти (NFR4)

## Integration Verification
- IV1: Существующий импорт брендов и категорий остался без изменений
- IV2: Интеграция с 1С остаётся совместимой с CommerceML 3.1 (CR4)
- IV3: Логи импорта содержат информацию о пропущенных записях и ошибках (NFR8)

## Tasks / Subtasks

- [ ] Рефакторинг парсера goods.xml (AC: 1)
  - [ ] Обновить `parse_goods_xml()` для создания только базовой информации Product
  - [ ] Удалить логику записи цен/остатков в Product
  - [ ] Сохранить импорт полей: name, slug, brand, category, description, short_description, specifications
  - [ ] Сохранить импорт SEO полей: meta_title, meta_description, meta_keywords
  - [ ] Убедиться что onec_id сохраняется в Product для маппинга с variants

- [ ] Создать парсер offers.xml для ProductVariant (AC: 2, 3, 4)
  - [ ] Создать функцию `parse_offers_xml()`
  - [ ] Парсить `<Предложение>` элементы из offers.xml
  - [ ] Извлекать `<Ид>` в формате `parent_id#variant_id` и разделять на parts
  - [ ] Найти parent Product по `onec_id = parent_id`
  - [ ] Если parent не найден: логировать warning и пропустить `<Предложение>` (AC3)
  - [ ] Извлекать `<Артикул>` в `ProductVariant.sku`
  - [ ] Парсить `<ХарактеристикиТовара>` для извлечения color_name, size_value (AC4)
  - [ ] Создать ProductVariant с полями: product, sku, onec_id, color_name, size_value

- [ ] Обработка товаров без вариантов (AC: 5)
  - [ ] После парсинга offers.xml проверить Products без variants
  - [ ] Для каждого Product без variants создать один ProductVariant:
    - sku = Product.onec_id (fallback)
    - onec_id = Product.onec_id
    - color_name = '', size_value = ''
    - Все цены = 0 (будут обновлены из prices.xml)
  - [ ] Логировать создание default variants: INFO level

- [ ] Импорт изображений в ProductVariant (AC: 6)
  - [ ] Обновить парсер `<Картинка>` для записи в ProductVariant вместо Product
  - [ ] Маппинг: первое `<Картинка>` → ProductVariant.main_image
  - [ ] Остальные `<Картинка>` → ProductVariant.gallery_images (JSONField array)
  - [ ] Обработка путей: `goods/import_files/XY/filename.jpg`
  - [ ] Копирование файлов в `media/products/variants/`

- [ ] Рефакторинг парсера prices.xml (AC: 7)
  - [ ] Обновить `parse_prices_xml()` для обновления ProductVariant вместо Product
  - [ ] Найти ProductVariant по `onec_id`
  - [ ] Обновить поля: retail_price, opt1_price, opt2_price, opt3_price, trainer_price, federation_price
  - [ ] Логировать отсутствие ProductVariant по onec_id: WARNING level

- [ ] Рефакторинг парсера rests.xml (AC: 8)
  - [ ] Обновить `parse_rests_xml()` для обновления ProductVariant.stock_quantity
  - [ ] Найти ProductVariant по `onec_id`
  - [ ] Обновить `stock_quantity` из `<Количество>`
  - [ ] Логировать отсутствие ProductVariant: WARNING level

- [ ] Реализация batch processing (AC: 9, NFR4)
  - [ ] Разделить импорт на batch'и по 500 записей
  - [ ] Использовать `bulk_create()` для создания ProductVariant (оптимизация)
  - [ ] Использовать `bulk_update()` для обновления цен/остатков
  - [ ] Коммитить транзакцию после каждого batch'а
  - [ ] Логировать progress: "Processed 500/10000 variants"

- [ ] Обновление management команд (AC: 1-9)
  - [ ] Обновить `import_products_from_1c` команду для нового workflow
  - [ ] Последовательность: goods.xml → offers.xml → default variants → prices.xml → rests.xml
  - [ ] Добавить опцию `--batch-size` (default 500)
  - [ ] Добавить опцию `--dry-run` для тестирования без сохранения

- [ ] Настройка логирования (IV3, NFR8)
  - [ ] Создать отдельный logger для импорта: `import_products`
  - [ ] Логировать в файл: `logs/import_products.log`
  - [ ] WARNING level: пропущенные <Предложение> без parent
  - [ ] WARNING level: отсутствие ProductVariant при обновлении цен/остатков
  - [ ] INFO level: статистика импорта (количество Product, ProductVariant)
  - [ ] ERROR level: критические ошибки парсинга XML

- [ ] Написать integration тесты с реальными XML (Coverage >= 90%)
  - [ ] Тест импорта goods.xml → создание Product без цен/остатков
  - [ ] Тест импорта offers.xml → создание ProductVariant с характеристиками
  - [ ] Тест обработки <Предложение> без parent (пропуск + warning)
  - [ ] Тест создания default ProductVariant для товаров без вариантов
  - [ ] Тест импорта изображений в ProductVariant
  - [ ] Тест обновления цен из prices.xml
  - [ ] Тест обновления остатков из rests.xml
  - [ ] Тест batch processing (проверка 500 записей/batch)
  - [ ] Использовать реальные XML из `data/import_1c/` для тестов

- [ ] Проверка Integration Verification (IV1, IV2, IV3)
  - [ ] IV1: Импорт брендов/категорий работает без изменений
  - [ ] IV2: Проверить совместимость с CommerceML 3.1 (структура XML не изменена)
  - [ ] IV3: Проверить логи содержат warnings для пропущенных записей

## Dev Notes

### Relevant Source Tree
```
backend/apps/integrations/
├── management/commands/
│   └── import_products_from_1c.py  (UPDATE - новый workflow)
├── services/
│   ├── commerceml_parser.py        (UPDATE - рефакторинг парсеров)
│   └── import_processor.py         (UPDATE - batch processing)
└── tests/
    └── test_import_products.py     (UPDATE - integration тесты)

data/import_1c/
├── goods/
│   ├── goods.xml                   (READ - базовая информация Product)
│   └── import_files/               (READ - изображения)
├── offers/
│   └── offers.xml                  (READ - варианты ProductVariant)
├── prices/
│   └── prices.xml                  (READ - цены ProductVariant)
└── rests/
    └── rests.xml                   (READ - остатки ProductVariant)
```

### CommerceML 3.1 Structure Reference

**Из product-variant-proposal.md и docs/architecture/20-1c-integration.md:**

#### goods.xml - Базовый товар (Product)
```xml
<Товар>
  <Ид>12345678-abcd-1234-5678-1234567890ab</Ид>
  <Наименование>Кроссовки Nike Air Max</Наименование>
  <БазоваяЕдиница>шт</БазоваяЕдиница>
  <Описание>Описание товара</Описание>
  <Группы>
    <Ид>category-uuid</Ид>
  </Группы>
  <Картинка>goods/import_files/12/front.jpg</Картинка>
  <Картинка>goods/import_files/12/back.jpg</Картинка>
</Товар>
```

#### offers.xml - Варианты товара (ProductVariant)
```xml
<Предложение>
  <Ид>parent-uuid#variant-uuid</Ид>
  <Наименование>Кроссовки Nike Air Max (Красный, 42)</Наименование>
  <Артикул>NIKE-AM-RED-42</Артикул>
  <ХарактеристикиТовара>
    <Характеристика>
      <Наименование>Цвет</Наименование>
      <Значение>Красный</Значение>
    </Характеристика>
    <Характеристика>
      <Наименование>Размер</Наименование>
      <Значение>42</Значение>
    </Характеристика>
  </ХарактеристикиТовара>
</Предложение>
```

#### prices.xml - Цены вариантов
```xml
<Предложение>
  <Ид>parent-uuid#variant-uuid</Ид>
  <Цены>
    <Цена>
      <ИдТипаЦены>retail</ИдТипаЦены>
      <ЦенаЗаЕдиницу>5990</ЦенаЗаЕдиницу>
    </Цена>
    <Цена>
      <ИдТипаЦены>opt1</ИдТипаЦены>
      <ЦенаЗаЕдиницу>4990</ЦенаЗаЕдиницу>
    </Цена>
  </Цены>
</Предложение>
```

#### rests.xml - Остатки вариантов
```xml
<Предложение>
  <Ид>parent-uuid#variant-uuid</Ид>
  <Остатки>
    <Остаток>
      <Склад>Основной склад</Склад>
      <Количество>15</Количество>
    </Остаток>
  </Остатки>
</Предложение>
```

### Import Workflow Sequence

**КРИТИЧНО: Последовательность импорта:**

1. **goods.xml** → Создание базовых Product (name, description, category, brand)
2. **offers.xml** → Создание ProductVariant из <Предложение> (sku, color, size)
3. **Default Variants** → Создание дефолтных ProductVariant для товаров без вариантов
4. **prices.xml** → Обновление цен ProductVariant
5. **rests.xml** → Обновление остатков ProductVariant

**Зависимости:**
- offers.xml требует готовые Product из goods.xml
- prices.xml/rests.xml требуют готовые ProductVariant из offers.xml

### Parsing onec_id Format

**parent_id#variant_id** формат:

```python
def parse_onec_id(onec_id: str) -> tuple[str, str]:
    """
    Парсинг составного onec_id из offers.xml

    Args:
        onec_id: Строка вида "parent-uuid#variant-uuid"

    Returns:
        Tuple (parent_id, variant_id)

    Example:
        >>> parse_onec_id("12345678-abcd#87654321-dcba")
        ("12345678-abcd", "87654321-dcba")
    """
    parts = onec_id.split('#')
    if len(parts) != 2:
        raise ValueError(f"Invalid onec_id format: {onec_id}")
    return parts[0], parts[1]
```

### Характеристики Товара (ХарактеристикиТовара)

**Извлечение color_name и size_value:**

```python
def parse_characteristics(xml_element) -> dict[str, str]:
    """
    Парсинг <ХарактеристикиТовара> из offers.xml

    Returns:
        Dict с ключами 'color_name', 'size_value'
    """
    characteristics = {}
    for char in xml_element.findall('.//Характеристика'):
        name = char.find('Наименование').text
        value = char.find('Значение').text

        if name == 'Цвет':
            characteristics['color_name'] = value
        elif name == 'Размер':
            characteristics['size_value'] = value

    return {
        'color_name': characteristics.get('color_name', ''),
        'size_value': characteristics.get('size_value', ''),
    }
```

### Batch Processing Implementation

**На основе NFR4 (до 10,000 SKU без превышения памяти):**

```python
from django.db import transaction
from typing import List

def import_variants_batch(variants_data: List[dict], batch_size: int = 500) -> None:
    """
    Импорт ProductVariant с batch processing

    Args:
        variants_data: Список словарей с данными вариантов
        batch_size: Размер batch (default 500)
    """
    total = len(variants_data)

    for i in range(0, total, batch_size):
        batch = variants_data[i:i+batch_size]

        with transaction.atomic():
            # Создание объектов без сохранения
            variants_to_create = [
                ProductVariant(**data) for data in batch
            ]

            # Bulk create для оптимизации
            ProductVariant.objects.bulk_create(variants_to_create)

        logger.info(f"Processed {min(i+batch_size, total)}/{total} variants")
```

### Logging Configuration

**Из NFR8 (логирование ошибок импорта):**

```python
import logging

# settings.py
LOGGING = {
    'version': 1,
    'handlers': {
        'import_file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/import_products.log',
            'formatter': 'detailed',
        },
    },
    'loggers': {
        'import_products': {
            'handlers': ['import_file', 'console'],
            'level': 'INFO',
            'propagate': False,
        },
    },
    'formatters': {
        'detailed': {
            'format': '[{asctime}] {levelname} {name} {message}',
            'style': '{',
        },
    },
}

# Использование в коде
logger = logging.getLogger('import_products')

# WARNING: пропущенные записи
logger.warning(f"Skipping <Предложение> {onec_id}: parent Product not found")

# INFO: статистика
logger.info(f"Imported {products_count} Products, {variants_count} ProductVariants")

# ERROR: критические ошибки
logger.error(f"Failed to parse offers.xml: {error}")
```

### Testing with Real XML Data

**Из CLAUDE.md: Реальные данные из 1С для тестирования**

**КРИТИЧНО:** Для тестирования используются ТОЛЬКО реальные данные из `data/import_1c/`

```python
# test_import_products.py
import pytest
from pathlib import Path

BASE_PATH = Path(__file__).parent.parent.parent.parent / 'data' / 'import_1c'

@pytest.mark.django_db
class TestImportProductsFrom1C:
    def test_import_goods_xml_creates_products(self):
        """Импорт goods.xml создает Products без цен/остатков"""
        goods_xml = BASE_PATH / 'goods' / 'goods_1_1_27c08306-a0aa-453b-b436-f9b494ceb889.xml'

        # Импорт
        parse_goods_xml(goods_xml)

        # Проверка: Product создан, нет полей цен/остатков
        assert Product.objects.count() > 0
        product = Product.objects.first()
        assert hasattr(product, 'name')
        assert not hasattr(product, 'retail_price')  # Удалено в рефакторинге

    def test_import_offers_xml_creates_variants(self):
        """Импорт offers.xml создает ProductVariant с характеристиками"""
        # Prerequisites: import goods.xml first
        goods_xml = BASE_PATH / 'goods' / 'goods_1_1_27c08306-a0aa-453b-b436-f9b494ceb889.xml'
        parse_goods_xml(goods_xml)

        offers_xml = BASE_PATH / 'offers' / 'offers.xml'
        parse_offers_xml(offers_xml)

        # Проверка: ProductVariant создан с color_name, size_value
        assert ProductVariant.objects.count() > 0
        variant = ProductVariant.objects.first()
        assert variant.sku
        assert variant.product  # ForeignKey связь

    def test_skip_offer_without_parent_product(self):
        """<Предложение> без parent Product пропускается с warning"""
        # Создать offers.xml с невалидным parent_id
        # Проверить: variant не создан, warning в логах
        pass
```

### Testing Standards

**Из CLAUDE.md Section: Стратегия тестирования:**

#### Test file location
- `backend/apps/integrations/tests/test_import_products.py`

#### Test frameworks
- **Framework:** Pytest 7.4.3 + pytest-django 4.7.0
- **Factory:** Factory Boy 3.3.0
- **Real Data:** XML файлы из `data/import_1c/`

#### Coverage requirements
- **Minimum coverage:** >= 90% для рефакторированных парсеров
- **Command:** `pytest --cov=apps.integrations.services --cov-report=html`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание Story 13.2 на основе Epic 13 PRD | Sarah (PO) |

## Dev Agent Record
(Заполняется dev-агентом)

## QA Results
(Заполняется QA-агентом)
