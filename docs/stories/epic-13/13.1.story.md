# Story 13.1: Модели Brand1CMapping и обновление Brand

## Status

Ready for Dev

## Story

**As a** менеджер по продукту,
**I want** чтобы бренды из 1С с разными ID, но одинаковым названием, объединялись в один "master-бренд" на сайте,
**so that** я могу избежать дубликатов в каталоге и обеспечить корректную синхронизацию данных о товарах.

## Acceptance Criteria

1. Создана модель `Brand1CMapping` с полями:
   - `brand` (ForeignKey to Brand, CASCADE)
   - `onec_id` (CharField, unique, db_index)
   - `onec_name` (CharField) — оригинальное название из 1С
   - `created_at` (DateTimeField, auto_now_add)
2. В модель `Brand` добавлено поле `normalized_name` (CharField, unique, db_index)
3. Удалено поле `Brand.onec_id` (заменено на Brand1CMapping)
4. Создана функция `normalize_brand_name(name: str) -> str`
5. При сохранении Brand автоматически вычисляется `normalized_name`
6. Создана миграция с корректной обработкой существующих данных

## Tasks / Subtasks

- [ ] **Task 1: Создать функцию нормализации и тесты для нее** (AC: 4)
  - [ ] Создать директорию `backend/apps/products/utils/` и `__init__.py`, если не существуют.
  - [ ] Создать файл `backend/apps/products/utils/brands.py` и реализовать в нем функцию `normalize_brand_name(name: str) -> str`.
  - [ ] Создать директорию `backend/tests/unit/test_utils/` и `__init__.py`, если не существуют.
  - [ ] Создать файл `backend/tests/unit/test_utils/test_brand_utils.py` для тестов.
  - [ ] Написать unit-тесты для `normalize_brand_name()`, покрывающие следующие случаи:
    - `test_normalize_brand_name_lowercase`: "BOYBO" -> "boybo"
    - `test_normalize_brand_name_removes_spaces`: "Boy Bo" -> "boybo"
    - `test_normalize_brand_name_removes_special_chars`: "Under-Armour" -> "underarmour"
    - `test_normalize_brand_name_handles_cyrillic`: "Рокки" -> "рокки"
    - `test_normalize_brand_name_handles_accents`: "Beyoncé" -> "beyonce"
    - `test_normalize_brand_name_with_numbers`: "Nike2024" -> "nike2024"
    - `test_normalize_brand_name_empty_string`: "" -> ""
    - `test_normalize_brand_name_none_input`: None -> ""

- [ ] **Task 2: Обновить модель Brand** (AC: 2, 5)
  - [ ] **Важно:** Поле `normalized_name` будет добавлено в несколько этапов в рамках миграции (Task 5). На этом шаге изменяется только логика модели.
  - [ ] В `apps/products/models.py` импортировать `normalize_brand_name` из `apps.products.utils.brands`.
  - [ ] Переопределить метод `Brand.save()`:
    - Он должен вычислять `self.normalized_name = normalize_brand_name(self.name)`.
    - Добавить проверку: `if not self.name: self.normalized_name = None` чтобы пустое имя не создавало пустое нормализованное имя, которое нарушит `unique` constraint.

- [ ] **Task 3: Создать модель Brand1CMapping** (AC: 1)
  - [ ] В файле `apps/products/models.py` создать модель `Brand1CMapping` с указанными полями.
  - [ ] Убедиться, что `onec_id` имеет тип `CharField(max_length=100, unique=True, db_index=True)`.
  - [ ] Добавить `related_name='onec_mappings'` для `ForeignKey` на `Brand`.
  - [ ] Реализовать `__str__` метод, возвращающий, например, `f"{self.onec_name} ({self.onec_id}) -> {self.brand}"`.
  - [ ] Добавить `class Meta` с `verbose_name`, `verbose_name_plural` и `db_table = 'products_brand_1c_mapping'`.

- [ ] **Task 4: Проверить зависимости от Brand.onec_id** (AC: 3)
  - [ ] **Цель:** Найти все места в коде, где используется поле `Brand.onec_id`, чтобы подготовиться к его удалению. Удаление поля произойдет в рамках миграции (Task 5).
  - [ ] Выполнить поиск по кодовой базе: `grep -r "onec_id" --include="*.py" backend/apps/`
  - [ ] Проверить следующие файлы и модули на предмет использования `Brand.onec_id`:
    - `apps/integrations/` (логика импорта из 1С)
    - `apps/products/admin.py`
    - Сериализаторы в `apps/products/serializers.py`
    - Любые другие API endpoints или management-команды.
  - [ ] Составить список файлов, требующих рефакторинга (замены `brand.onec_id` на логику с `Brand1CMapping`).

- [ ] **Task 5: Создать и применить миграции (поэтапно)** (AC: 6)
  - [ ] **5.1. Добавить поле `normalized_name` (nullable)**
    - [ ] В `Brand` добавить `normalized_name = models.CharField(..., unique=False, null=True, blank=True)`.
    - [ ] Создать миграцию: `makemigrations products -n add_normalized_name_to_brand`.
  - [ ] **5.2. Заполнить `normalized_name` и разрешить коллизии**
    - [ ] Создать пустую миграцию данных: `makemigrations products --empty -n populate_normalized_name`.
    - [ ] В миграции написать скрипт, который:
      - Итерирует по всем `Brand.objects.all()`.
      - Вычисляет `normalized_name`.
      - Проверяет на дубликаты. Если найден дубликат, к `normalized_name` добавляется суффикс (например, `_brand_{brand.id}`).
      - Сохраняет `brand.save()`.
      - **Важно:** Логировать все найденные и исправленные коллизии.
  - [ ] **5.3. Перенести `onec_id` в `Brand1CMapping`**
    - [ ] Создать пустую миграцию данных: `makemigrations products --empty -n migrate_onec_id_to_mapping`.
    - [ ] В миграции написать скрипт:
      - Итерирует по `Brand.objects.filter(onec_id__isnull=False)`.
      - Для каждого бренда создает запись `Brand1CMapping(brand=brand, onec_id=brand.onec_id, onec_name=brand.name)`.
  - [ ] **5.4. Удалить поле `Brand.onec_id`**
    - [ ] Удалить поле `onec_id` из модели `Brand`.
    - [ ] Создать миграцию: `makemigrations products -n remove_onec_id_from_brand`.
  - [ ] **5.5. Сделать `normalized_name` уникальным и обязательным**
    - [ ] Изменить поле в модели: `normalized_name = models.CharField(..., unique=True, blank=False, null=False)`.
    - [ ] Создать миграцию: `makemigrations products -n make_normalized_name_unique_not_null`.
  - [ ] **5.6. Применить все миграции**
    - [ ] Запустить `python manage.py migrate products`.

- [ ] **Task 6: Написать unit-тесты для моделей** (AC: 1, 2, 5)
  - [ ] Создать файл `backend/tests/unit/test_models/test_brand_model.py`.
  - [ ] **Тесты для `Brand`:**
    - [ ] `test_brand_save_calculates_normalized_name`: Проверяет, что `normalized_name` вычисляется при сохранении.
    - [ ] `test_brand_save_handles_empty_name`: Проверяет, что `normalized_name` становится `None`, если `name` пустой.
    - [ ] `test_brand_save_uniqueness_violation`: Попытка сохранить два бренда с одинаковым `normalized_name` должна вызывать `IntegrityError` (после финальной миграции).
  - [ ] Создать файл `backend/tests/unit/test_models/test_brand1c_mapping_model.py`.
  - [ ] **Тесты для `Brand1CMapping`:**
    - [ ] `test_brand1c_mapping_creation`: Проверка создания.
    - [ ] `test_brand1c_mapping_unique_onec_id`: Проверка уникальности `onec_id`.
    - [ ] `test_brand1c_mapping_cascade_delete`: Проверка, что маппинги удаляются при удалении бренда.
  - [ ] **(Опционально) Тесты для миграций.**

- [ ] **Task 7: Обновить Django Admin** (AC: 1, 2)
  - [ ] В `BrandAdmin` (`apps/products/admin.py`):
    - [ ] Добавить `normalized_name` в `list_display`.
    - [ ] Сделать `normalized_name` полем `readonly_fields`.
  - [ ] Создать `Brand1CMappingAdmin`:
    - [ ] Зарегистрировать модель `Brand1CMapping`.
    - [ ] `list_display = ['brand', 'onec_id', 'onec_name', 'created_at']`
    - [ ] `list_filter = ['brand']`
    - [ ] `search_fields = ['onec_id', 'onec_name']`
    - [ ] `autocomplete_fields = ['brand']`

## Dev Notes

### Relevant Source Tree

```
backend/
├── apps/
│   └── products/
│       ├── models.py        # Модели Brand, Product (изменение)
│       ├── utils.py         # Утилиты (создание)
│       ├── admin.py         # Django Admin (изменение)
│       └── migrations/      # Миграции (создание)
├── tests/
│   └── unit/
│       ├── test_models/     # Unit-тесты моделей
│       └── test_utils/      # Unit-тесты утилит
```

### Data Models

**Текущая модель Brand** [Source: backend/apps/products/models.py]:
```python
class Brand(models.Model):
    name = models.CharField("Название бренда", max_length=100, unique=False)
    slug = models.SlugField("Slug", max_length=255, unique=False)
    logo = models.ImageField("Логотип", upload_to="brands/", blank=True)
    description = models.TextField("Описание", blank=True)
    website = models.URLField("Веб-сайт", blank=True)
    is_active = models.BooleanField("Активный", default=True)
    onec_id = models.CharField("ID в 1С", max_length=100, unique=True, null=True, blank=True, db_index=True)
    created_at = models.DateTimeField("Дата создания", auto_now_add=True)
    updated_at = models.DateTimeField("Дата обновления", auto_now=True)
```

**Новая архитектура** [Source: docs/epics/epic-13/epic-13.brand-deduplication.md]:
- Brand получает поле `normalized_name` (уникальное) для дедупликации
- Brand1CMapping связывает множество ID из 1С с одним master-брендом
- Поле `Brand.onec_id` удаляется (заменяется на Brand1CMapping)

### Функция нормализации

**Реализация** [Source: docs/epics/epic-13/epic-13.brand-deduplication.md#Technical Notes]:
```python
import re
import unicodedata

def normalize_brand_name(name: str) -> str:
    """
    Нормализует название бренда для сравнения.

    "BoyBo" → "boybo"
    "BOYBO" → "boybo"
    "Boy Bo" → "boybo"
    " boybo " → "boybo"
    """
    if not name:
        return ""
    # Удаляем акценты и диакритики (é → e)
    name = unicodedata.normalize('NFKD', name)
    name = ''.join(c for c in name if not unicodedata.combining(c))
    # Lowercase
    name = name.lower()
    # Удаляем все пробелы
    name = re.sub(r'\s+', '', name)
    # Удаляем спецсимволы (оставляем только буквы и цифры)
    name = re.sub(r'[^\w]', '', name, flags=re.UNICODE)
    return name
```

### Ограничения модели

[Source: docs/epics/epic-13/epic-13.brand-deduplication.md#Важные ограничения]:
- `Brand.name` остаётся **не уникальным** (legacy, для безопасности)
- `Brand.normalized_name` — **уникальный** (новый механизм дедупликации)
- `Brand1CMapping.onec_id` — **уникальный** (один 1С ID = один маппинг)
- `Brand1CMapping.brand` — **CASCADE** (при удалении бренда удаляются маппинги)

### Coding Standards

[Source: docs/architecture/coding-standards.md]:
- **Типизация**: Обязательная типизация для всех методов (-> None, -> str, и т.д.)
- **Импорты**: `from __future__ import annotations` в начале файла
- **Форматирование**: Black, 88 символов
- **Линтинг**: Flake8, isort для сортировки импортов

### Migration Strategy

Процесс миграции разделен на несколько шагов для обеспечения безопасности данных и избежания блокировок.

1.  **Добавление `normalized_name` (nullable):** Сначала поле добавляется как необязательное, чтобы не нарушать существующую схему.
2.  **Заполнение данных и разрешение коллизий:** Специальная миграция данных вычисляет `normalized_name` для всех существующих брендов. Если находятся дубликаты (например, "BoyBo" и "boybo"), они разрешаются путем добавления суффикса к `normalized_name` (например, `boybo_brand_123`). Все коллизии должны быть залогированы для последующего ручного разбора.
3.  **Перенос `onec_id`:** Вторая миграция данных переносит существующие `Brand.onec_id` в новую таблицу `Brand1CMapping`.
4.  **Удаление старого поля:** После успешного переноса данных поле `Brand.onec_id` удаляется.
5.  **Установка `UNIQUE` constraint:** На последнем шаге, когда все данные корректны, на поле `normalized_name` устанавливается ограничение `UNIQUE` и `NOT NULL`.

### Testing

[Source: docs/architecture/10-testing-strategy.md]:

**Структура тестов:**
- Unit тесты: `backend/tests/unit/`
- Маркировка: `@pytest.mark.unit`, `@pytest.mark.django_db`

**Требования к покрытию:**
- Общее покрытие: >= 70%
- Критические модули: >= 90%

**Паттерн AAA (Arrange-Act-Assert):**
```python
def test_brand_save_calculates_normalized_name():
    # ARRANGE
    brand = Brand(name="BoyBo")

    # ACT
    brand.save()

    # ASSERT
    assert brand.normalized_name == "boybo"
```

**Изоляция тестов** [Source: docs/architecture/10-testing-strategy.md#10.4]:
- Для создания тестовых данных следует использовать `Factory Boy`.
- Создать `BrandFactory` и `Brand1CMappingFactory` в файле `backend/tests/factories.py`.
- Использовать `factory.LazyFunction` вместо статических значений.
- Каждый тест должен быть полностью изолирован.

**Команды запуска:**
```bash
# Unit тесты
pytest -m unit tests/unit/

# Конкретный файл
pytest tests/unit/test_models/test_brand.py -v

# С покрытием
pytest --cov=apps tests/unit/
```

### Миграции

**ВАЖНО**: Поскольку данные будут очищены и загружены заново (согласно Epic), сложная data migration не требуется. Однако миграция должна:
1. Создать `Brand1CMapping` таблицу
2. Добавить `normalized_name` в `Brand`
3. Удалить `onec_id` из `Brand`

**Проверка миграции:**
```bash
cd backend
python manage.py makemigrations products --dry-run
python manage.py makemigrations products
python manage.py migrate products
```

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-23 | 0.4 | Updated Epic 13 to match Story (onec_id CharField) | PO Agent |
| 2025-11-23 | 0.3 | Reworked based on validation report | PO Agent |
| 2025-11-23 | 0.2 | Validated and refined story | PO Agent |
| 2025-11-23 | 0.1 | Initial draft | SM Agent |
