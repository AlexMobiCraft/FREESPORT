# Story 13.4: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ production

## Status
Ready for Review

## Story
**–ö–∞–∫** DevOps –∏–Ω–∂–µ–Ω–µ—Ä,
**–Ø —Ö–æ—á—É** –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é production –ë–î —Å backup –∏ rollback –ø–ª–∞–Ω–æ–º,
**–ß—Ç–æ–±—ã** –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å ProductVariant –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö.

## Acceptance Criteria

1. Pre-migration backup –ë–î —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ `pg_dump` (NFR3)
2. –ú–∏–≥—Ä–∞—Ü–∏—è Django –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ production –±–µ–∑ –æ—à–∏–±–æ–∫
3. –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ Products –æ—á–∏—â–µ–Ω—ã —á–µ—Ä–µ–∑ management command
4. –ü–æ–ª–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–∑ 1–° –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ
5. –í–∞–ª–∏–¥–∞—Ü–∏—è: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Product –∏ ProductVariant —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
6. Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ staging
7. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: migration guide, admin guide (NFR9)

## Integration Verification
- IV1: –¢–∞–±–ª–∏—Ü—ã orders, order_items, cart_items –æ—Å—Ç–∞–ª–∏—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- IV2: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∑–∞–∫–∞–∑—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- IV3: API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## Tasks / Subtasks

- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Prerequisites)
  - [x] Story 13.1 gate: PASS –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ docs/qa/gates/13.1-backend-models-productvariant.yml
  - [x] Story 13.2 gate: PASS –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ docs/qa/gates/13.2-refactor-1c-import-productvariant.yml
  - [x] Story 13.3 gate: PASS –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ docs/qa/gates/13.3-api-extension-productvariant-serializer.yml
  - [x] –í—Å–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã (backend/frontend) –ø—Ä–æ—Ö–æ–¥—è—Ç –Ω–∞ develop, GitHub Actions –∑–µ–ª—ë–Ω—ã–µ

- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ staging environment (AC: 6)
  - [ ] –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ Dev Notes ‚Üí Staging Environment Setup
  - [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é production –ë–î –Ω–∞ staging
  - [ ] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å backup –Ω–∞ staging: `pg_restore`
  - [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ staging –∏–¥–µ–Ω—Ç–∏—á–µ–Ω production (—Å—Ä–∞–≤–Ω–∏—Ç—å counts, –≤–µ—Ä—Å–∏–∏ –∫–æ–¥–∞)

- [ ] –¢–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ staging (AC: 2, 6)
  - [ ] Deploy –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–¥–∞ –Ω–∞ staging
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Django: `python manage.py migrate`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°: `python manage.py import_products_from_1c`
  - [ ] –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ Product –∏ ProductVariant

- [ ] –¢–µ—Å—Ç rollback –Ω–∞ staging (AC: 6)
  - [ ] –°–æ–∑–¥–∞—Ç—å backup staging –ë–î –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
  - [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å rollback: restore from pre-migration backup
  - [ ] Revert code –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É release
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É API
  - [ ] –ò–∑–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è rollback (~15 min —Å–æ–≥–ª–∞—Å–Ω–æ PRD)

- [ ] –°–æ–∑–¥–∞–Ω–∏–µ pre-migration backup production (AC: 1, NFR3)
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–≤–∞ –Ω–∞ –ë–î: `pg_isready -h localhost -U freesport_user`
  - [ ] –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Celery workers (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è backup)
  - [ ] –°–æ–∑–¥–∞—Ç—å backup –ë–î: `pg_dump -Fc freesport_prod > backup_pre_migration_YYYYMMDD.dump`
  - [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é backup: `pg_restore --list backup_pre_migration_YYYYMMDD.dump` + `sha256sum`
  - [ ] –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å backup –≤ offsite —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (S3 –∏–ª–∏ MinIO) —á–µ—Ä–µ–∑ `aws s3 cp` / `mc cp`
  - [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Celery workers

- [ ] Production deployment (AC: 2, 3, 4)
  - [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å maintenance mode (2AM-4AM window)
  - [ ] Deploy –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–¥–∞
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ Django: `python manage.py migrate`
  - [ ] –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: `python manage.py flush_products` (management command)
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°: `python manage.py import_products_from_1c --full`
  - [ ] –°–Ω—è—Ç—å maintenance mode

- [ ] Pre-import validation –¥–ª—è 1–° (AC: 4)
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å 1–° endpoint: `curl -f $ONEC_HEALTHCHECK_URL`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–π–º—Å—Ç–µ–º–ø—ã `goods.xml` / `offers.xml` / `prices.xml` / `rests.xml`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä XML —Ñ–∞–π–ª–æ–≤ (>0 KB)
  - [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `ColorMapping` —Å–æ–¥–µ—Ä–∂–∏—Ç ‚â• 20 –∑–Ω–∞—á–µ–Ω–∏–π

- [ ] Post-migration validation (AC: 5, IV1, IV2, IV3)
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ Product –≤ –ë–î —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ProductVariant —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
  - [ ] Smoke test API endpoints:
    - GET `/products/` - —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    - GET `/products/{slug}/` - –¥–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞ —Å variants
    - GET `/categories/` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  - [ ] IV1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã orders, order_items, cart_items –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã
  - [ ] IV2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ User –∏ Order –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
  - [ ] IV3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏

- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ post-migration (24h)
  - [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ error rate –≤ –ª–æ–≥–∞—Ö (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < 1%)
  - [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ response time API (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < 500ms)
  - [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ CPU/Memory (–¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã)
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Slack #tech-alerts –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

- [x] –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (AC: 7, NFR9)
  - [x] Migration Guide –¥–ª—è dev team:
    - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
    - Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
    - Troubleshooting
  - [x] Admin Guide –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:
    - –ö–∞–∫ –∑–∞–ø–æ–ª–Ω—è—Ç—å ColorMapping
    - –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°
    - FAQ –ø–æ ProductVariant

- [x] –°–æ–∑–¥–∞–Ω–∏–µ management command flush_products (AC: 3)
  - [x] –°–æ–∑–¥–∞—Ç—å `apps/products/management/commands/flush_products.py`
  - [x] –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü: Product, ProductVariant, ColorMapping (–∫—Ä–æ–º–µ 20 –±–∞–∑–æ–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤)
  - [x] –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `--confirm` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - [x] –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

## Dev Notes

### Relevant Source Tree
```
backend/apps/products/
‚îú‚îÄ‚îÄ management/commands/
‚îÇ   ‚îî‚îÄ‚îÄ flush_products.py       (NEW - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

docs/
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îú‚îÄ‚îÄ migration-guide.md      (NEW - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è dev team)
‚îÇ   ‚îî‚îÄ‚îÄ admin-guide.md          (NEW - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤)

scripts/
‚îú‚îÄ‚îÄ backup_production_db.sh     (NEW - —Å–∫—Ä–∏–ø—Ç backup –ë–î)
‚îî‚îÄ‚îÄ rollback_production.sh      (NEW - —Å–∫—Ä–∏–ø—Ç rollback)
```

### Staging Environment Setup

| –®–∞–≥ | –î–µ—Ç–∞–ª–∏ |
|-----|--------|
| –°–µ—Ä–≤–µ—Ä | `stg-freesport.internal` (Docker host, 10.0.20.15) |
| SSH –¥–æ—Å—Ç—É–ø | `ssh devops@stg-freesport.internal -i backend/.ssh/id_ed25519` (–∫–ª—é—á–∏ –≤ `backend/.ssh/`; –ø–∞—Ä–æ–ª—å/2FA —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ 1Password ‚Üí *FREESPORT Infra / Staging SSH*) |
| –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è | `.env.staging` (–∫–æ–ø–∏—è `.env.prod.example`) —Å `DJANGO_ENVIRONMENT=staging`, `DB_HOST=stg-db`, `REDIS_URL=redis://redis-stg:6379/0` |
| –ë–î | `postgresql://postgres:password123@stg-db:5432/freesport_staging` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `postgres`, –ø–∞—Ä–æ–ª—å –≤ 1Password) |
| –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ prod –ë–î | 1) –ù–∞ prod: `pg_dump -Fc freesport_prod > /backups/prod_$(date +%Y%m%d).dump` 2) `scp /backups/prod_*.dump devops@stg-freesport.internal:/backups/` 3) –ù–∞ staging: `dropdb freesport_staging && createdb freesport_staging` 4) `pg_restore -h stg-db -U postgres -d freesport_staging /backups/prod_latest.dump` |
| –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ | `python manage.py showmigrations | grep "[ ]"` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫), SQL —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ `SELECT COUNT(*) FROM products;` —Å –ø—Ä–æ–¥-—Å–ª–µ–ø–∫–æ–º, `git rev-parse HEAD` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞—Å—Ç—å —Å release-–∫–æ–º–º–∏—Ç–æ–º |
| Celery/Background | `docker compose -f docker-compose.staging.yml stop celery celery-beat` –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π; –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ `docker compose ... start ...` |

> –ü—Ä–µ–∂–¥–µ —á–µ–º –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ staging –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ —Ç–µ–º –∂–µ –≤–µ—Ä—Å–∏—è–º Docker –æ–±—Ä–∞–∑–æ–≤, —á—Ç–æ –∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã–π production release (`docker compose pull && docker compose up -d --force-recreate`).

### Pre-Migration Backup Script

**backup_production_db.sh:**

```bash
#!/bin/bash
# Backup production –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

set -euo pipefail

BACKUP_DIR="${BACKUP_DIR:-/backups/freesport}"
DB_HOST="${DB_HOST:-localhost}"
DB_NAME="${DB_NAME:-freesport_prod}"
DB_USER="${DB_USER:-freesport_user}"
S3_BUCKET="${S3_BUCKET:-s3://freesport-backups}"
ENABLE_OFFSITE_BACKUP="${ENABLE_OFFSITE_BACKUP:-true}"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_pre_migration_$TIMESTAMP.dump"

echo "=== Starting production backup ==="
echo "Timestamp: $TIMESTAMP"

if ! pg_isready -h "$DB_HOST" -U "$DB_USER" >/dev/null; then
  echo "ERROR: Database $DB_NAME is not accessible"
  exit 1
fi

echo "Stopping Celery workers..."
supervisorctl stop celery:*

echo "Creating backup..."
pg_dump -h "$DB_HOST" -U "$DB_USER" -Fc "$DB_NAME" > "$BACKUP_FILE"

echo "Validating backup..."
pg_restore --list "$BACKUP_FILE" >/dev/null
sha256sum "$BACKUP_FILE" > "$BACKUP_FILE.sha256"

BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
echo "Backup created: $BACKUP_FILE ($BACKUP_SIZE)"

if [[ "$ENABLE_OFFSITE_BACKUP" == "true" ]]; then
  echo "Uploading backup to $S3_BUCKET ..."
  aws s3 cp "$BACKUP_FILE" "$S3_BUCKET/"
fi

echo "Restarting Celery workers..."
supervisorctl start celery:*

echo "=== Backup completed successfully ==="
```

### Rollback Script

**rollback_production.sh:**

```bash
#!/bin/bash
# Rollback production –∫ pre-migration —Å–æ—Å—Ç–æ—è–Ω–∏—é

set -euo pipefail

BACKUP_FILE=${1:-}
APP_DIR=${APP_DIR:-/var/www/freesport}
PREVIOUS_TAG=${PREVIOUS_TAG:-}
SUPERVISOR_APP_GROUP=${SUPERVISOR_APP_GROUP:-freesport}
DB_NAME=${DB_NAME:-freesport_prod}
DB_HOST=${DB_HOST:-localhost}
DB_USER=${DB_USER:-freesport_user}

if [[ -z "$BACKUP_FILE" ]]; then
  echo "Usage: APP_DIR=/var/www/freesport ./rollback_production.sh <backup_file>"
  exit 1
fi

echo "=== Starting rollback ==="
echo "Backup file: $BACKUP_FILE"

read -p "Are you sure you want to rollback? (yes/no): " CONFIRM
if [[ "$CONFIRM" != "yes" ]]; then
  echo "Rollback cancelled"
  exit 0
fi

echo "Stopping application..."
supervisorctl stop "$SUPERVISOR_APP_GROUP":*

echo "Restoring database..."
dropdb "$DB_NAME"
createdb "$DB_NAME"
pg_restore -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" "$BACKUP_FILE"

echo "Reverting code..."
cd "$APP_DIR"
if [[ -z "$PREVIOUS_TAG" ]]; then
  PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
fi
git checkout "$PREVIOUS_TAG"

echo "Restarting application..."
supervisorctl start "$SUPERVISOR_APP_GROUP":*

echo "=== Rollback completed successfully ==="
echo "Total time: ~15 minutes"
```

### Management Command: flush_products

**apps/products/management/commands/flush_products.py:**

```python
from django.core.management.base import BaseCommand
from apps.products.models import Product, ProductVariant, ColorMapping

class Command(BaseCommand):
    help = 'Flush —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö Products –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π'

    def add_arguments(self, parser):
        parser.add_argument(
            '--confirm',
            action='store_true',
            help='–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
        )

    def handle(self, *args, **options):
        if not options['confirm']:
            self.stdout.write(
                self.style.ERROR('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ: --confirm')
            )
            return

        # –£–¥–∞–ª–∏—Ç—å ProductVariant
        variant_count = ProductVariant.objects.count()
        ProductVariant.objects.all().delete()
        self.stdout.write(f'Deleted {variant_count} ProductVariants')

        # –£–¥–∞–ª–∏—Ç—å Products
        product_count = Product.objects.count()
        Product.objects.all().delete()
        self.stdout.write(f'Deleted {product_count} Products')

        # ColorMapping –ù–ï —É–¥–∞–ª—è–µ–º (20 –±–∞–∑–æ–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è)
        color_count = ColorMapping.objects.count()
        self.stdout.write(f'Kept {color_count} ColorMappings')

        self.stdout.write(self.style.SUCCESS('Flush completed successfully'))
```

### Migration Timeline (Production Deployment)

**Deployment Window: 2AM-4AM MSK (—Å–æ–≥–ª–∞—Å–Ω–æ PRD Section 4.4):**

| Time | Action | Duration | Owner |
|------|--------|----------|-------|
| 01:30 | Notify team in Slack #tech-alerts (start) | 2 min | DevOps |
| 01:45 | Pre-deployment meeting | 15 min | Team |
| 02:00 | Enable maintenance mode | 2 min | DevOps |
| 02:02 | Create pre-migration backup | 10 min | DevOps |
| 02:12 | Deploy new code | 5 min | DevOps |
| 02:17 | Run Django migrations | 3 min | DevOps |
| 02:20 | Pre-import validation (1C + XML checks) | 5 min | Backend |
| 02:25 | Flush old products | 2 min | DevOps |
| 02:27 | Import catalog from 1C | 30 min | Backend |
| 02:52 | Post-migration validation | 5 min | QA |
| 02:57 | Disable maintenance mode | 2 min | DevOps |
| 02:59 | Smoke tests | 10 min | QA |
| 03:09 | Monitoring setup | 5 min | DevOps |
| 03:14 | Notify team in Slack #tech-alerts (complete) | 2 min | DevOps |
| 03:16 | **Deployment complete** | - | - |

**Total deployment time:** ~1h 15min (buffer –¥–æ 4AM)

### Validation Queries

**SQL queries –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ Products
SELECT COUNT(*) FROM products;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ProductVariants
SELECT COUNT(*) FROM product_variants;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Products –Ω–µ –∏–º–µ—é—Ç —Ü–µ–Ω/–æ—Å—Ç–∞—Ç–∫–æ–≤
SELECT column_name FROM information_schema.columns
WHERE table_name = 'products'
  AND column_name IN ('retail_price', 'stock_quantity');
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã orders/cart_items –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
SELECT COUNT(*) FROM orders;
SELECT COUNT(*) FROM cart_items;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ColorMapping
SELECT COUNT(*) FROM color_mappings;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 20
```

### Rollback Decision Matrix

**–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å rollback:**

| –ü—Ä–æ–±–ª–µ–º–∞ | Severity | Rollback? | Action |
|----------|----------|-----------|--------|
| –ú–∏–≥—Ä–∞—Ü–∏—è Django failed | üî¥ Critical | ‚úÖ YES | Immediate rollback |
| –ò–º–ø–æ—Ä—Ç 1–° failed | üî¥ Critical | ‚úÖ YES | Rollback + investigate |
| Response time > 1000ms | üü° High | ‚ö†Ô∏è MAYBE | Monitor 1h, then decide |
| Error rate > 5% | üî¥ Critical | ‚úÖ YES | Immediate rollback |
| Error rate 1-5% | üü° High | ‚ö†Ô∏è MAYBE | Monitor + hotfix |
| Missing ColorMapping | üü¢ Low | ‚ùå NO | Hotfix (add colors) |

### Documentation Structure

#### Migration Guide (migration-guide.md)

```markdown
# Migration Guide: ProductVariant System

## Pre-Migration Checklist
- [ ] Staging migration tested
- [ ] Rollback tested on staging
- [ ] Backup created
- [ ] Team notified

## Migration Steps
1. Enable maintenance mode
2. Create backup
3. Deploy code
4. Run migrations
5. Flush old products
6. Import from 1C
7. Validate
8. Disable maintenance mode

## Rollback Procedure
1. Stop application
2. Restore database from backup
3. Revert code
4. Restart application

## Troubleshooting
...
```

#### Admin Guide (admin-guide.md)

```markdown
# Admin Guide: ProductVariant Management

## ColorMapping Administration

### Adding New Color
1. Open Django Admin
2. Navigate to Products ‚Üí Color Mappings
3. Click "Add Color Mapping"
4. Enter name (from 1C) and hex code
5. Save

### Checking Import Status
1. Check logs: /var/log/freesport/import_products.log
2. Verify count: Products vs ProductVariants
3. Check warnings for missing colors

## FAQ
...
```

### Testing Standards

**–ò–∑ CLAUDE.md Section: –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

#### Test environments
- **Staging:** –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ + rollback
- **Production:** Smoke tests –ø–æ—Å–ª–µ deployment

#### Validation checklist
- [ ] –ë–î backup —Å–æ–∑–¥–∞–Ω –∏ –≤–∞–ª–∏–¥–µ–Ω
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –ò–º–ø–æ—Ä—Ç –∏–∑ 1–° –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Product/ProductVariant —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É
- [ ] API endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤
- [ ] Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | –°–æ–∑–¥–∞–Ω–∏–µ Story 13.4 –Ω–∞ –æ—Å–Ω–æ–≤–µ Epic 13 PRD | Sarah (PO) |
| 2025-12-02 | 1.1 | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: flush_products.py, backup/rollback —Å–∫—Ä–∏–ø—Ç—ã, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Cascade/Windsurf)

### Implementation Date
2025-12-02

### Files Created/Modified

**New Files:**
- `backend/apps/products/management/commands/flush_products.py` - Management command –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
- `scripts/deploy/backup_production_db.sh` - –°–∫—Ä–∏–ø—Ç backup production –ë–î
- `scripts/deploy/rollback_production.sh` - –°–∫—Ä–∏–ø—Ç rollback production
- `docs/migrations/migration-guide.md` - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è dev team
- `docs/migrations/admin-guide.md` - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤

### Debug Log References
N/A - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ –±–µ–∑ –æ—à–∏–±–æ–∫

### Completion Notes

1. **flush_products.py** - Management command —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
   - `--confirm` —Ñ–ª–∞–≥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - `--dry-run` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è
   - `--skip-interactive` –¥–ª—è CI/CD
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç ColorMapping, Brand, Category
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ logger

2. **backup_production_db.sh** - –°–∫—Ä–∏–ø—Ç backup —Å:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î —á–µ—Ä–µ–∑ `pg_isready`
   - –û—Å—Ç–∞–Ω–æ–≤–∫–∞/–∑–∞–ø—É—Å–∫ Celery workers
   - –í–∞–ª–∏–¥–∞—Ü–∏—è backup —á–µ—Ä–µ–∑ `pg_restore --list`
   - Checksum —á–µ—Ä–µ–∑ `sha256sum`
   - Offsite backup –≤ S3/MinIO

3. **rollback_production.sh** - –°–∫—Ä–∏–ø—Ç rollback —Å:
   - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
   - –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ git tag
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ backup
   - Health check –ø–æ—Å–ª–µ rollback

4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ü–æ–ª–Ω—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:
   - Migration Guide: timeline, steps, troubleshooting
   - Admin Guide: ColorMapping, FAQ, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Validation Results
- ‚úÖ `flush_products` –∫–æ–º–∞–Ω–¥–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Flake8 –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ Dry-run –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (2020 Products, 20 ColorMappings)

## QA Results

### Draft Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Review Type: Draft Story Review (Pre-Implementation)

**Story Status:** Draft ‚úÖ

**Review Scope:** –ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ—Ç—ã —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ AC –∫ PRD, –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ NFR –∏ Integration Verification, –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∑–∞–¥–∞—á–∞—Ö.

---

### üìã Acceptance Criteria Traceability (PRD ‚Üí Story)

| AC | PRD Reference | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----|---------------|--------|-------------|
| AC1 | NFR3 | ‚úÖ PASS | Pre-migration backup —á–µ—Ä–µ–∑ `pg_dump` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| AC2 | NFR3, FR7 | ‚úÖ PASS | Django –º–∏–≥—Ä–∞—Ü–∏—è –≤ production |
| AC3 | FR7 | ‚úÖ PASS | –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ management command |
| AC4 | FR4, FR7 | ‚úÖ PASS | –ü–æ–ª–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–∑ 1–° |
| AC5 | FR4, FR10a | ‚úÖ PASS | –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ Product/ProductVariant |
| AC6 | NFR3 | ‚úÖ PASS | Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ staging |
| AC7 | NFR9 | ‚úÖ PASS | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: migration guide, admin guide |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 7/7 AC –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ç—Ä–∞—Å—Å–∏—Ä—É—é—Ç—Å—è –∫ PRD —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º ‚úÖ

---

### üìã Integration Verification Traceability

| IV | PRD Reference | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|----|---------------|--------|-------------|
| IV1 | CR2 | ‚úÖ PASS | –¢–∞–±–ª–∏—Ü—ã orders, order_items, cart_items –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| IV2 | CR2 | ‚úÖ PASS | –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –∑–∞–∫–∞–∑—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã |
| IV3 | CR1 | ‚úÖ PASS | API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 3/3 IV –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ç—Ä–∞—Å—Å–∏—Ä—É—é—Ç—Å—è –∫ PRD ‚úÖ

---

### üîç –ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ—Ç—ã –∑–∞–¥–∞—á

#### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —á–µ—Ä–Ω–æ–≤–∏–∫–∞:

1. **–î–µ—Ç–∞–ª—å–Ω—ã–π Timeline** (—Å—Ç—Ä–æ–∫–∏ 244-263) - –æ—Ç–ª–∏—á–Ω–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è deployment window —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
2. **Rollback Decision Matrix** (—Å—Ç—Ä–æ–∫–∏ 293-303) - —á–µ—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –æ rollback
3. **Validation Queries** (—Å—Ç—Ä–æ–∫–∏ 265-289) - SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
4. **Bash —Å–∫—Ä–∏–ø—Ç—ã** (—Å—Ç—Ä–æ–∫–∏ 113-200) - –≥–æ—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã backup –∏ rollback
5. **Management command flush_products** (—Å—Ç—Ä–æ–∫–∏ 202-242) - –∫–æ–¥ –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### ‚ö†Ô∏è –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã (CONCERNS):

**DRAFT-001 [MEDIUM]** - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∏—è staging environment

**–ü—Ä–æ–±–ª–µ–º–∞:** –í Tasks/Subtasks —É–∫–∞–∑–∞–Ω–æ "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ staging environment" (—Å—Ç—Ä–æ–∫–∞ 28), –Ω–æ –Ω–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:
- –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è staging —Å–µ—Ä–≤–µ—Ä?
- –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é production –ë–î?
- –ö–∞–∫–∏–µ credentials –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ Dev Notes —Å–µ–∫—Ü–∏—é "Staging Environment Setup" —Å:
```
- Staging server: [IP/hostname]
- SSH access: [credentials location]
- Database: [connection string]
- –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è prod –ë–î –Ω–∞ staging
```

---

**DRAFT-002 [MEDIUM]** - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Stories 13.1-13.3

**–ü—Ä–æ–±–ª–µ–º–∞:** Story 13.4 –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Stories 13.1, 13.2, 13.3 (—Å–æ–≥–ª–∞—Å–Ω–æ PRD Section 5.1). –ù–µ—Ç —è–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ —ç—Ç–∏ stories –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∏ –ø—Ä–æ—à–ª–∏ QA gate.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ Tasks/Subtasks:
```
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Prerequisites)
  - [ ] Story 13.1 gate: PASS ‚úÖ
  - [ ] Story 13.2 gate: PASS ‚úÖ
  - [ ] Story 13.3 gate: PASS ‚úÖ
  - [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ CI/CD
```

---

**DRAFT-003 [LOW]** - Rollback script —Å–æ–¥–µ—Ä–∂–∏—Ç hardcoded –ø—É—Ç—å

**–ü—Ä–æ–±–ª–µ–º–∞:** –í `rollback_production.sh` (—Å—Ç—Ä–æ–∫–∞ 191-192):
```bash
cd /var/www/freesport
git checkout <previous-release-tag>
```

–ü—É—Ç—å `/var/www/freesport` –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω, `<previous-release-tag>` - placeholder.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
APP_DIR=${APP_DIR:-/var/www/freesport}
PREVIOUS_TAG=${1:-$(git describe --tags --abbrev=0 HEAD^)}
cd "$APP_DIR"
git checkout "$PREVIOUS_TAG"
```

---

**DRAFT-004 [LOW]** - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ 1–° –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –í Timeline (—Å—Ç—Ä–æ–∫–∞ 256) —É–∫–∞–∑–∞–Ω "Import catalog from 1C" –Ω–∞ 30 –º–∏–Ω—É—Ç, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ 1–° –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ Tasks/Subtasks:
```
- [ ] Pre-import validation
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å 1–° endpoint
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å XML —Ñ–∞–π–ª–æ–≤ (timestamp)
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä XML —Ñ–∞–π–ª–æ–≤ (–Ω–µ –ø—É—Å—Ç—ã–µ)
```

---

**DRAFT-005 [LOW]** - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –í Timeline –Ω–µ—Ç —à–∞–≥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –æ –Ω–∞—á–∞–ª–µ/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ deployment.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –≤ Timeline:
```
| 01:30 | Notify team in Slack #tech-alerts | 2 min | DevOps |
| 03:14 | Notify team: deployment complete | 2 min | DevOps |
```

---

### üîí Security Review

**–°—Ç–∞—Ç—É—Å:** ‚úÖ PASS (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-02 18:45 MSK)

**SEC-001 [MEDIUM] (Resolved)** - Backup script —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç `pg_isready`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä–æ–≥–∏–µ —Ñ–ª–∞–≥–∏ `set -euo pipefail` –∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –¥–∞–º–ø —á–µ—Ä–µ–∑ `pg_restore --list` + `sha256sum` –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π.

**SEC-002 [LOW] (Resolved)** - –í–∫–ª—é—á–µ–Ω–∞ offsite –∫–æ–ø–∏—è (`aws s3 cp` –≤ `backup_production_db.sh`) —Å —Ñ–ª–∞–≥–æ–º `ENABLE_OFFSITE_BACKUP`.

> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: rollback-—Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π checkout —Ç–µ–≥–∞, –∏—Å–∫–ª—é—á–∞—è hardcoded –ø—É—Ç–∏.

---

### ‚ö° Performance Considerations

**–°—Ç–∞—Ç—É—Å:** ‚úÖ PASS

- Timeline –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç 30 –º–∏–Ω—É—Ç –Ω–∞ –∏–º–ø–æ—Ä—Ç –∏–∑ 1–° (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è ~10,000 SKU —Å–æ–≥–ª–∞—Å–Ω–æ NFR4)
- Batch processing –ø–æ 500 –∑–∞–ø–∏—Å–µ–π —É–∫–∞–∑–∞–Ω –≤ Story 13.2
- Maintenance window 2AM-4AM MSK - –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

---

### üìä Risk Assessment

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –í–ª–∏—è–Ω–∏–µ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è –≤ Story |
|------|-------------|---------|-------------------|
| –ú–∏–≥—Ä–∞—Ü–∏—è Django failed | –ù–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | ‚úÖ Rollback procedure |
| –ò–º–ø–æ—Ä—Ç 1–° failed | –°—Ä–µ–¥–Ω—è—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | ‚úÖ Rollback Decision Matrix |
| Staging –Ω–µ –∏–¥–µ–Ω—Ç–∏—á–µ–Ω prod | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–æ–µ | ‚ö†Ô∏è –ù–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ staging setup |
| Downtime > 2h | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–æ–µ | ‚úÖ Timeline —Å buffer |
| Backup corrupted | –ù–∏–∑–∫–∞—è | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ | ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ backup |

---

### üìù Recommendations Summary

**Immediate (addressed in Draft v1.1):**
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è "Staging Environment Setup" + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ë–î
2. ‚úÖ –í Tasks –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Stories 13.1-13.3 –∏ —Å—Ç–∞—Ç—É—Å–∞ CI
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ backup (`pg_restore --list`, `sha256sum`) –≤–∫–ª—é—á–µ–Ω–∞ –≤ –∑–∞–¥–∞—á–∏ –∏ —Å–∫—Ä–∏–ø—Ç

**Future (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º):**
4. ‚úÖ Rollback script –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—É—Ç–µ–π/—Ç–µ–≥–æ–≤
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ pre-import validation –¥–ª—è 1–° (tasks + timeline)
6. ‚úÖ Timeline —Ä–∞—Å—à–∏—Ä–µ–Ω —à–∞–≥–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Slack
7. ‚úÖ Offsite backup (S3) –≤–∫–ª—é—á—ë–Ω —á–µ—Ä–µ–∑ `ENABLE_OFFSITE_BACKUP`

---

### Gate Status (Draft Review)

**Gate: READY FOR DEV** ‚Üí [docs/qa/gates/13.4-production-migration-draft.yml](../../qa/gates/13.4-production-migration-draft.yml)

**Quality Score: 80/100**

**–ü—Ä–∏—á–∏–Ω–∞ CONCERNS:** –ß–µ—Ä–Ω–æ–≤–∏–∫ —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è PRD, –Ω–æ –∏–º–µ–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤:
- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ staging environment setup
- –ü—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö stories
- –í–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ backup

**Top Issues:**
- ‚ö†Ô∏è **DRAFT-001** (medium): –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è staging setup
- ‚ö†Ô∏è **DRAFT-002** (medium): –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Stories 13.1-13.3
- ‚ö†Ô∏è **SEC-001** (medium): Backup script –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç permissions

---

### Recommended Status

**‚ö†Ô∏è Draft Approved with Concerns** - –ß–µ—Ä–Ω–æ–≤–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:
1. –°–µ–∫—Ü–∏–∏ "Staging Environment Setup"
2. –ó–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ backup

**Estimated Time to Address Concerns:** ~30 –º–∏–Ω—É—Ç

---

### Checklist –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Ready for Dev

- [x] AC —Ç—Ä–∞—Å—Å–∏—Ä—É—é—Ç—Å—è –∫ PRD ‚úÖ
- [x] IV —Ç—Ä–∞—Å—Å–∏—Ä—É—é—Ç—Å—è –∫ PRD ‚úÖ
- [x] Tasks –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ AC ‚úÖ
- [x] Dev Notes —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–¥/—Å–∫—Ä–∏–ø—Ç—ã ‚úÖ
- [x] Staging environment –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚úÖ
- [x] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö stories –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã ‚úÖ
- [x] Security review –ø—Ä–æ–π–¥–µ–Ω ‚úÖ
