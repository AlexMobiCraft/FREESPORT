# Story 3.1.3: Руководство по запуску тестов

## Проблема с UnicodeDecodeError

При запуске тестов локально может возникать ошибка:

```text
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xc2 in position 61
```

Это происходит из-за проблем с кодировкой при подключении к PostgreSQL в локальном окружении Windows.

## Решения

### Вариант 1: Запуск через Docker (РЕКОМЕНДУЕТСЯ)

```powershell
# Запустить backend с PostgreSQL
docker-compose up -d backend

# Запустить тесты в Docker контейнере с реальными данными
# ВАЖНО: флаг --migrations необходим для создания таблицы ImportSession
docker-compose exec backend pytest tests/integration/test_real_catalog_import.py -v --migrations

# Примечание: директория data/ автоматически монтируется в контейнер
# Если данные находятся в data/import_1c/, тесты выполнятся полностью
# Если данных нет, тесты будут пропущены (skipped)
```

### Вариант 2: Использование PowerShell скрипта (РЕКОМЕНДУЕТСЯ для Windows)

```powershell
cd backend
.\run_integration_tests.ps1
```

Скрипт автоматически:
- Проверяет и запускает PostgreSQL в Docker
- Устанавливает правильные переменные окружения
- Активирует venv
- Запускает тесты

### Вариант 3: Настройка локального PostgreSQL вручную

1. Убедитесь что PostgreSQL запущен в Docker:
```powershell
docker-compose up -d db
```

2. Установите переменные окружения:
```powershell
$env:DB_NAME="freesport_test"
$env:DB_USER="postgres"
$env:DB_PASSWORD="postgres"
$env:DB_HOST="127.0.0.1"
$env:DB_PORT="5432"
$env:DJANGO_SETTINGS_MODULE="freesport.settings.test"
```

3. Запустите тесты из venv:
```powershell
cd backend
..\venv\Scripts\Activate.ps1
python -m pytest tests/integration/test_real_catalog_import.py -v --create-db
```

### Вариант 3: Пропустить интеграционные тесты локально

Если не нужно запускать интеграционные тесты локально, используйте:

```powershell
# Запустить только unit тесты
pytest tests/unit/ -v

# Пропустить интеграционные тесты
pytest tests/ -v -m "not integration"
```

## Проверка в CI/CD

Интеграционные тесты автоматически запускаются в GitHub Actions с правильно настроенным PostgreSQL окружением. 

Проверьте статус CI/CD после push:
```powershell
git push origin feature/story-3.1.3
```

## Требования к данным

Тесты требуют наличия реальных данных 1С в:
```
c:\Users\38670\DEV_WEB\FREESPORT\data\import_1c\
```

Структура:
- `goods/` - 4 файла `goods_1_*.xml`
- `groups/` - 1 файл `groups_1_*.xml`
- `prices/` - 5 файлов `prices_1_*.xml`
- `offers/` - 10 файлов `offers_1_*.xml`
- `propertiesGoods/` - 9 файлов `propertiesGoods_1_*.xml`

Если данные отсутствуют, тесты будут пропущены (skipped).

## Ожидаемое время выполнения

- Полный набор тестов: ~30-60 секунд (зависит от размера данных)
- Каждый тест: ~5-10 секунд

## Покрытие тестами

8 тестовых функций покрывают:
- AC1: Импорт товаров (≥5000)
- AC2: Ценообразование (7 ролей + fallback)
- AC3: Технические характеристики
- AC4: Целостность данных
- AC5: API и админка
