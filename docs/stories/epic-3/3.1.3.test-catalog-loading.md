# Story 3.1.3: test-catalog-loading

## Status

Backlog

## Story

**As a** Product Owner,
**I want** загрузить полный каталог товаров с корректными ценами,
**so that** фронтенд может отображать актуальные данные для всех типов пользователей.

## Acceptance Criteria

1. Загружен полный каталог тестовых данных (≥500 товаров, ≥50 категорий, ≥20 брендов).
2. Корректно установлены цены для всех 7 ролей, включая fallback-логику.
3. Заполнены технические характеристики товаров.
4. Обеспечена целостность данных и связей между сущностями.

### Детальные задачи

#### Доработка команды `load_test_catalog` (AC: 1, 2, 3, 4)

- [ ] **Обновить минимальные значения для соответствия AC1**
  - [ ] Изменить default для `--count` с 50 на 500
  - [ ] Увеличить количество генерируемых категорий с 8 до ≥50
  - [ ] Увеличить количество генерируемых брендов с 10 до ≥20
  - [ ] Добавить иерархию категорий (3-4 уровня) на основе `docs/Структура категорий товара.md`
    - Пример: "СПОРТ" → "Единоборства" → "Перчатки и накладки на руки" → "Боксерские"

- [ ] **Добавить генерацию изображений (AC: 1, 3)**
  - [ ] Интегрировать `https://placehold.co/600x400` для main_image
  - [ ] Генерировать 2-4 дополнительных изображения через ProductImage модель
  - [ ] Использовать разные размеры: 600x400, 800x600, 1200x800

- [ ] **Проверить ценообразование (AC: 2)**
  - [ ] ✅ Цены для всех 7 ролей уже генерируются корректно
  - [ ] ✅ Fallback логика реализована в `Product.get_price_for_user()`
  - [ ] Добавить валидацию: все цены должны быть ≤ retail_price

- [ ] **Улучшить specifications (AC: 3)**
  - [ ] ✅ JSON структура уже генерируется
  - [ ] Добавить больше реалистичных характеристик в зависимости от типа товара
  - [ ] Добавить массивы для размеров и цветов (как в примере из story)

#### Тестирование (DoD requirement)

- [ ] **Создать integration тесты в `backend/tests/integration/test_catalog_loading.py`**
  - [ ] `test_command_generates_minimum_products()` - проверка ≥500 товаров
  - [ ] `test_command_generates_categories()` - проверка ≥50 категорий с иерархией
  - [ ] `test_command_generates_brands()` - проверка ≥20 брендов
  - [ ] `test_all_products_have_prices_for_all_roles()` - проверка цен для 7 ролей
  - [ ] `test_price_fallback_logic()` - проверка fallback на retail_price
  - [ ] `test_specifications_json_structure()` - валидация JSON specifications
  - [ ] `test_data_integrity()` - проверка связей товары-категории-бренды
  - [ ] `test_images_generated()` - проверка генерации изображений

## Definition of Done

- [ ] Реализована команда `load_test_catalog` с параметрами `--count`, `--with-categories`, `--with-brands`
- [ ] Команда генерирует ≥500 товаров, ≥50 категорий, ≥20 брендов
- [ ] Все товары имеют цены для всех 7 ролей с fallback-логикой
- [ ] Товары имеют заполненные `specifications` (JSON)
- [ ] Написаны integration тесты для валидации всех AC
- [ ] API `/products/` возвращает корректные данные для всех ролей
- [ ] Каталог отображается в админке Django
- [ ] Все тесты проходят успешно
- [ ] Code review пройден (flake8, black)

## Dev Notes

### ⚠️ Текущее состояние реализации

**Команда `load_test_catalog.py` уже существует**, но требует доработки для соответствия AC:

**Что уже работает:**

- ✅ Базовая генерация товаров с параметром `--count`
- ✅ Генерация цен для всех 7 ролей (retail, opt1-3, trainer, federation)
- ✅ Генерация JSON specifications (material, color, size, weight, country, gender)
- ✅ Fallback логика в `Product.get_price_for_user()` (строка 412-426 models.py)
- ✅ Параметры `--with-categories`, `--with-brands`, `--clear-existing`, `--dry-run`
- ✅ Progress bar с tqdm

**Что нужно доработать:**

- ❌ Default `--count=50` → нужно `500` (AC1)
- ❌ Генерируется 8 категорий → нужно ≥50 с иерархией 3 уровня (AC1)
- ❌ Генерируется 10 брендов → нужно ≥20 (AC1)
- ❌ Изображения не генерируются → нужно добавить placehold.co (AC1, AC3)
- ❌ Нет integration тестов → нужно создать (DoD)

### Story Context

**Data Volume Requirements:**

- Минимум 500 товаров для реалистичного тестирования
- 50+ категорий для проверки иерархии и навигации
- 20+ брендов для тестирования фильтрации
- Все 7 ролей должны получать корректные цены

**Структура категорий:**

Реальная иерархия категорий находится в `docs/Структура категорий товара.md`. Основные разделы:

1. **СПОРТ** (корневая категория)
   - Туризм (2 уровень)
   - Фитнес и атлетика (2 уровень)
     - Тяжелая атлетика (3 уровень)
       - Грифы, Гантели, Гири (4 уровень)
     - Фитнес (3 уровень)
       - Мячи для фитнеса, Обручи, Скакалки (4 уровень)
   - Плавание (2 уровень)
   - Спортивные игры (2 уровень)
     - Баскетбол, Футбол, Волейбол (3 уровень)
   - Единоборства (2 уровень)
     - Одежда для единоборств, Перчатки и накладки (3 уровень)
   - Гимнастика и танцы (2 уровень)

2. **ДЕТСКИЙ ТРАНСПОРТ** (корневая категория)
   - Велосипеды, Ролики, Самокаты, Скейты (2 уровень)

3. **ОБОРУДОВАНИЕ** (корневая категория)

4. **СУВЕНИРНАЯ ПРОДУКЦИЯ** (корневая категория)

#### Итого

Всего в файле: ~80 категорий с иерархией до 4 уровней.

Для генерации тестовых данных рекомендуется использовать подмножество этой структуры (≥50 категорий).

### Ролевое ценообразование

```python
# Пример структуры цен в БД
product = {
    'name': 'Nike Air Max',
    'retail_price': 15000.00,      # Розница
    'opt1_price': 13500.00,        # Опт 1 (-10%)
    'opt2_price': 12750.00,        # Опт 2 (-15%)
    'opt3_price': 12000.00,        # Опт 3 (-20%)
    'trainer_price': 11250.00,     # Тренеры (-25%)
    'federation_price': 10500.00,  # Федерации (-30%)
    'admin_price': 9000.00,        # Админ (себестоимость)
}
```

### Sample Data Structure

```json
{
  "specifications": {
    "size": ["40", "41", "42", "43", "44"],
    "color": ["black", "white", "red"],
    "material": "synthetic leather",
    "weight": "350g",
    "sport": "football"
  }
}
```

### Примеры тестов для реализации

```python
# backend/tests/integration/test_catalog_loading.py
import pytest
from django.core.management import call_command
from apps.products.models import Product, Category, Brand

@pytest.mark.django_db
class TestLoadTestCatalog:
    """Integration тесты для команды load_test_catalog"""
    
    def test_command_generates_minimum_products(self):
        """AC1: Проверка генерации ≥500 товаров"""
        call_command('load_test_catalog', '--count=500', '--with-categories', '--with-brands')
        
        products_count = Product.objects.filter(onec_id__startswith='TEST-PRODUCT-').count()
        assert products_count >= 500, f"Expected ≥500 products, got {products_count}"
    
    def test_command_generates_categories_with_hierarchy(self):
        """AC1: Проверка генерации ≥50 категорий с иерархией"""
        call_command('load_test_catalog', '--with-categories')
        
        categories_count = Category.objects.count()
        assert categories_count >= 50, f"Expected ≥50 categories, got {categories_count}"
        
        # Проверка иерархии (до 4 уровней как в docs/Структура категорий товара.md)
        root_categories = Category.objects.filter(parent__isnull=True)
        assert root_categories.exists(), "No root categories found"
        assert root_categories.count() >= 3, "Expected at least 3 root categories (СПОРТ, ДЕТСКИЙ ТРАНСПОРТ, ОБОРУДОВАНИЕ)"
        
        # Проверка уровней вложенности
        level_2_exists = Category.objects.filter(parent__isnull=False, parent__parent__isnull=True).exists()
        level_3_exists = Category.objects.filter(parent__parent__isnull=False, parent__parent__parent__isnull=True).exists()
        level_4_exists = Category.objects.filter(parent__parent__parent__isnull=False).exists()
        
        assert level_2_exists, "No level 2 categories found"
        assert level_3_exists, "No level 3 categories found"
        # Level 4 опционально, но желательно
        if level_4_exists:
            print("✓ Level 4 categories found (excellent!)")
    
    def test_all_products_have_prices_for_all_roles(self):
        """AC2: Проверка цен для всех 7 ролей"""
        call_command('load_test_catalog', '--count=10')
        
        products = Product.objects.filter(onec_id__startswith='TEST-PRODUCT-')
        
        for product in products:
            assert product.retail_price > 0, f"Product {product.id} has no retail_price"
            assert product.opt1_price > 0, f"Product {product.id} has no opt1_price"
            assert product.opt2_price > 0, f"Product {product.id} has no opt2_price"
            assert product.opt3_price > 0, f"Product {product.id} has no opt3_price"
            assert product.trainer_price > 0, f"Product {product.id} has no trainer_price"
            assert product.federation_price > 0, f"Product {product.id} has no federation_price"
    
    def test_specifications_json_structure(self):
        """AC3: Проверка структуры JSON specifications"""
        call_command('load_test_catalog', '--count=10')
        
        products = Product.objects.filter(onec_id__startswith='TEST-PRODUCT-')
        
        for product in products:
            specs = product.specifications
            assert isinstance(specs, dict), f"Product {product.id} specifications is not dict"
            
            # Проверяем обязательные поля
            required_fields = ['material', 'color', 'size', 'weight', 'country', 'gender']
            for field in required_fields:
                assert field in specs, f"Product {product.id} missing {field} in specifications"
```

### API Testing

```bash
# Тестирование API для разных ролей
curl -H "Authorization: Bearer <retail_token>" /api/products/1/
curl -H "Authorization: Bearer <trainer_token>" /api/products/1/
curl -H "Authorization: Bearer <federation_token>" /api/products/1/
```

### Команды для тестирования

```bash
# Генерация минимального набора данных (500 товаров, 50 категорий, 20 брендов)
python manage.py load_test_catalog --count=500 --with-categories --with-brands

# Очистка и повторная генерация
python manage.py load_test_catalog --count=500 --with-categories --with-brands --clear-existing

# Dry-run для проверки без сохранения
python manage.py load_test_catalog --count=500 --with-categories --with-brands --dry-run

# Запуск integration тестов
pytest backend/tests/integration/test_catalog_loading.py -v
```

### Dependencies

- **Depends on:** Story 3.1.1, 3.1.2 (import infrastructure)
- **Blocks:** Frontend integration, Story 3.1.4 (stocks)
- **Related:** User role management, pricing logic

## Story Points

**3** (Low complexity, mostly data preparation)

## Priority

**High** - Критично для начала frontend разработки

## Labels

`epic-3` `test-data` `catalog` `role-pricing` `frontend-ready`

## PO Review Notes

### ✅ Story готова к разработке после refinement

**Проведенный анализ:**

1. **Существующая реализация**: Команда `load_test_catalog.py` уже существует (338 строк)
2. **Покрытие AC**: Базовая функциональность покрывает все AC, но требует доработки
3. **Тестирование**: Отсутствуют integration тесты - критичный gap
4. **Структура категорий**: Найдена реальная иерархия в `docs/Структура категорий товара.md` (~80 категорий, 4 уровня)

**Ключевые изменения в story:**

- ✅ Обновлена секция "Детальные задачи" с четким разделением на доработку и тестирование
- ✅ Добавлена секция "Текущее состояние реализации" для прозрачности
- ✅ Добавлены примеры тестов для разработчика
- ✅ Добавлены команды для тестирования
- ✅ Добавлена детальная структура категорий из реального файла
- ✅ Обновлены тесты для проверки иерархии до 4 уровней

**Оценка сложности:**

- Story Points остается **3** - большая часть кода уже написана
- Основная работа: увеличение объемов данных, добавление изображений, написание тестов
- Риски: минимальные, т.к. базовая инфраструктура работает

**Рекомендации для Developer:**

1. Начать с написания тестов (TDD approach)
2. Использовать реальную структуру категорий из `docs/Структура категорий товара.md`
   - Можно парсить файл или создать подмножество вручную
   - Рекомендуется взять основные разделы: СПОРТ, ДЕТСКИЙ ТРАНСПОРТ, ОБОРУДОВАНИЕ
3. Затем доработать команду для прохождения тестов
4. Проверить работу через `--dry-run` перед финальным запуском
5. Убедиться что API `/products/` корректно отдает данные для всех ролей

**Блокеры:** Отсутствуют

**Готовность к спринту:** ✅ Ready
