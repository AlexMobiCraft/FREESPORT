# Story 3.2.1: import-existing-customers

## Status

Ready for Development

## Story

**As a** менеджер по работе с клиентами,
**I want** импортировать существующих B2B контрагентов из 1С,
**so that** они могут сразу работать с платформой со своими персональными ценами.

## Acceptance Criteria

1. Создана команда `load_customers` с необходимой логикой и параметрами.
2. Логика импорта разделена на архитектуру Парсер/Процессор.
3. Модель `User` обновлена для интеграции с 1С.
4. Реализован маппинг ролей и типов клиентов (физ./юр. лица).
5. Созданы валидаторы данных и механизм поиска дубликатов.
6. Создана модель `CustomerSyncLog` и настроено двухуровневое логирование через `ImportSession`.

### Детальные задачи

- [ ] **Создать команду `load_customers` (AC: 1)**
  - [ ] Расположить в `apps/users/management/commands/`.
  - [ ] Реализовать параметры: `--file`, `--dry-run`, `--chunk-size`.
  - [ ] Команда должна использовать `CustomerDataParser` и `CustomerDataProcessor`.
  - [ ] Команда должна создавать и управлять `ImportSession` (тип `customers`).

- [ ] **Реализовать архитектуру Парсер/Процессор (AC: 2)**
  - [ ] Создать `CustomerDataParser` в `apps/users/services/`.
  - [ ] Создать `CustomerDataProcessor` в `apps/users/services/`.

- [x] **Обновить модель User (AC: 3)**
  - [x] `onec_id = CharField(max_length=100, unique=True, null=True)`
  - [x] `sync_status = CharField(choices=SYNC_STATUSES, default='pending')`
  - [x] `created_in_1c = BooleanField(default=False)`
  - [x] `needs_1c_export = BooleanField(default=False)`
  - [x] `last_sync_at = DateTimeField(null=True, blank=True)`
  - [x] `sync_error_message = TextField(blank=True)`
  - [x] Создать миграцию с индексами

- [ ] **Реализовать маппинг ролей (AC: 4)**
  - [ ] Логика маппинга должна быть частью `CustomerDataProcessor`.
  - [ ] Маппинг типов клиентов 1С → роли платформы.
    - **Решение PO (22.09.2025):** Использовать следующий маппинг:
      - `"Опт 1"` -> `wholesale_level1`
      - `"Опт 2"` -> `wholesale_level2`
      - `"Опт 3"` -> `wholesale_level3`
      - `"Тренерская"` -> `trainer`
      - `"РРЦ"` -> `retail`
      - `"МРЦ"` -> `retail`
  - [ ] Fallback к роли `retail` для неопознанных типов.
    - **Решение PO (22.09.2025):** Утверждено.

- [ ] **Поддержать физ.лица и юр.лица (AC: 4)**
  - [ ] Логика должна быть в `CustomerDataProcessor`.
  - [ ] Определение типа клиента по наличию company_name.
  - [ ] Валидация обязательных полей для каждого типа.

- [ ] **Создать валидаторы данных (AC: 5)**
  - [ ] Логика валидации должна быть в `CustomerDataProcessor`.
  - [ ] Валидация email format и уникальности.

- [ ] **Создать модель `CustomerSyncLog` и настроить логирование (AC: 6)**
  - [ ] Создать модель `CustomerSyncLog` (в `apps/common/models.py`) для детального логирования операций с клиентами.
  - [ ] Добавить `ForeignKey` на `ImportSession` для связи лога с общей сессией.
  - [ ] В `CustomerDataProcessor` реализовать логику создания записей в `CustomerSyncLog` для каждого обработанного клиента (успех, ошибка, пропуск).

- [ ] **Реализовать поиск дубликатов (AC: 5)**
  - [ ] Логика поиска дубликатов должна быть в `CustomerDataProcessor`.
  - [ ] Поиск по onec_id (основной метод, get_or_create).
  - [ ] Поиск по email (вторичный метод).

## Definition of Done

- [ ] Импортированы тестовые клиенты всех типов
- [ ] Все клиенты получили корректные роли и цены
- [ ] Нет дубликатов в системе
- [ ] Логирование работает корректно через `CustomerSyncLog` и `ImportSession`
- [ ] Реальная интеграция с файлами от 1С
- [ ] Созданы тесты для всех сценариев

## Dev Notes

### Story Context

**Customer Integration Points:**

- Источник данных: 1С:Управление торговлей справочник клиентов
- Цель: Синхронизированная клиентская база с ролевыми ценами
- Критично: Правильный маппинг ролей для корректных цен

### Database Schema

```python
# Новые поля в User модели
class User(AbstractUser):
    # ... existing fields
    
    # 1C Integration fields
    onec_id = models.CharField('ID в 1С', max_length=100, blank=True, null=True, unique=True)
    # ... other sync fields

# Модель логирования
class CustomerSyncLog(models.Model):
    # ... fields
```

### Role Mapping Logic

```python
# Логика перенесена в CustomerDataProcessor
class CustomerDataProcessor:
    ROLE_MAPPING = { ... }
    def map_role(self, onec_role):
        # ...
```

### Sample Import Data

```xml
<customers>
  <customer>
    <id>1C-CUSTOMER-001</id>
    <type>individual</type>
    <email>ivan.petrov@email.com</email>
    <first_name>Иван</first_name>
    <last_name>Петров</last_name>
    <phone>+79161234567</phone>
    <customer_type>тренер</customer_type>
    <is_verified>true</is_verified>
  </customer>
</customers>
```

### Dependencies

- **Depends on:** User model, role system, Story 3.1.1 (ImportSession model)
- **Blocks:** Story 3.2.2 (conflict resolution)
- **Related:** Authentication system, pricing logic

## Story Points

**13** (High complexity due to new architecture, role mapping and validation)

## Priority

**High** - Критично для B2B функциональности

## Labels

`epic-3` `1c-integration` `customer-sync` `role-mapping` `b2b` `refactoring
