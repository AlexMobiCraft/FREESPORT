# Story 3.2.1: import-existing-customers

## Status

Ready for Development

## Story

**As a** менеджер по работе с клиентами,
**I want** импортировать существующих B2B контрагентов из 1С,
**so that** они могут сразу работать с платформой со своими персональными ценами.

## Acceptance Criteria

1. Создана команда `load_customers` с необходимой логикой и параметрами.
2. Логика импорта разделена на архитектуру Парсер/Процессор.
3. Модель `User` обновлена для интеграции с 1С.
4. Реализован маппинг ролей и типов клиентов (физ./юр. лица).
5. Созданы валидаторы данных и механизм поиска дубликатов.
6. Создана модель `CustomerSyncLog` и настроено двухуровневое логирование через `ImportSession`.

### Детальные задачи

- [ ] **Создать команду `load_customers` (AC: 1)**
  - [ ] Расположить в `apps/users/management/commands/`.
  - [ ] Реализовать параметры: `--file`, `--dry-run`, `--chunk-size`.
  - [ ] Команда должна использовать `CustomerDataParser` и `CustomerDataProcessor`.
  - [ ] Команда должна создавать и управлять `ImportSession` (тип `customers`).

- [ ] **Реализовать архитектуру Парсер/Процессор (AC: 2)**
  - [ ] Создать `CustomerDataParser` в `apps/users/services/`.
  - [ ] Создать `CustomerDataProcessor` в `apps/users/services/`.

- [ ] **Обновить модель User (AC: 3)**
  - [ ] `onec_id = CharField(max_length=100, unique=True, null=True)`
  - [ ] `sync_status = CharField(choices=SYNC_STATUSES, default='pending')`
  - [ ] `created_in_1c = BooleanField(default=False)`
  - [ ] `needs_1c_export = BooleanField(default=False)`
  - [ ] `last_sync_at = DateTimeField(null=True, blank=True)`
  - [ ] `sync_error_message = TextField(blank=True)`
  - [ ] Создать миграцию с индексами

- [ ] **Реализовать маппинг ролей (AC: 4)**
  - [ ] Логика маппинга должна быть частью `CustomerDataProcessor`.
  - [ ] Маппинг типов клиентов 1С → роли платформы.
    - **Решение PO (22.09.2025):** Использовать следующий маппинг:
      - `"Опт 1"` -> `wholesale_level1`
      - `"Опт 2"` -> `wholesale_level2`
      - `"Опт 3"` -> `wholesale_level3`
      - `"Тренерская"` -> `trainer`
      - `"РРЦ"` -> `retail`
  - [ ] Fallback к роли `retail` для неопознанных типов.
    - **Решение PO (22.09.2025):** Утверждено.

- [ ] **Поддержать физ.лица и юр.лица (AC: 4)**
  - [ ] Логика должна быть в `CustomerDataProcessor`.
  - [ ] Определение типа клиента по наличию company_name.
  - [ ] Валидация обязательных полей для каждого типа.

- [ ] **Создать валидаторы данных (AC: 5)**
  - [ ] Логика валидации должна быть в `CustomerDataProcessor`.
  - [ ] Валидация email format и уникальности.

- [ ] **Создать модель `CustomerSyncLog` и настроить логирование (AC: 6)**
  - [ ] Создать модель `CustomerSyncLog` (в `apps/common/models.py`) для детального логирования операций с клиентами.
  - [ ] Добавить `ForeignKey` на `ImportSession` для связи лога с общей сессией.
  - [ ] В `CustomerDataProcessor` реализовать логику создания записей в `CustomerSyncLog` для каждого обработанного клиента (успех, ошибка, пропуск).

- [ ] **Реализовать поиск дубликатов (AC: 7)**
  - [ ] Логика поиска дубликатов должна быть в `CustomerDataProcessor`.
  - [ ] Поиск по onec_id (основной метод, get_or_create).
  - [ ] Поиск по email (вторичный метод).

## Definition of Done

- [ ] Импортированы тестовые клиенты всех типов
- [ ] Все клиенты получили корректные роли и цены
- [ ] Нет дубликатов в системе
- [ ] Логирование работает корректно через `CustomerSyncLog` и `ImportSession`
- [ ] Реальная интеграция с файлами от 1С
- [ ] Созданы тесты для всех сценариев

## Dev Notes

### Story Context

**Customer Integration Points:**

- Источник данных: 1С:Управление торговлей справочник клиентов
- Цель: Синхронизированная клиентская база с ролевыми ценами
- Критично: Правильный маппинг ролей для корректных цен

**Место в системе интеграции с 1С:**

Эта история является критическим компонентом трехсторонней интеграции с 1С:

1. **Импорт товаров** (Stories 3.1.x) - загрузка каталога и цен
2. **Импорт клиентов** (эта история) - загрузка существующей клиентской базы
3. **Синхронизация заказов** (будущие истории) - экспорт заказов из платформы в 1С

Импорт клиентов должен происходить после импорта каталога, так как роли клиентов определяют типы цен, которые должны быть уже настроены в системе.

### Технические требования

**Используемые технологии:**

- **Парсинг XML:** Python xml.etree.ElementTree или lxml
- **Обработка данных:** Django ORM с оптимизацией bulk operations
- **Архитектура:** Парсер/Процессор для гибкости будущей интеграции через API
- **Логирование:** Django logging + кастомная модель CustomerSyncLog

**Переменные окружения:**

- `ONEC_DATA_PATH`: Путь к директории с файлами выгрузки из 1С
- `IMPORT_CHUNK_SIZE`: Размер пакета для обработки (по умолчанию: 100)
- `IMPORT_DRY_RUN`: Режим тестового запуска без сохранения данных (True/False)

### Database Schema

```python
# Новые поля в User модели
class User(AbstractUser):
    # ... existing fields
    
    # 1C Integration fields
    onec_id = models.CharField('ID в 1С', max_length=100, blank=True, null=True, unique=True)
    # ... other sync fields

# Модель логирования
class CustomerSyncLog(models.Model):
    # ... fields
```

### Role Mapping Logic

```python
# Логика перенесена в CustomerDataProcessor
class CustomerDataProcessor:
    ROLE_MAPPING = { ... }
    def map_role(self, onec_role):
        # ...
```

### Sample Import Data

```xml
<customers>
  <customer>
    <id>1C-CUSTOMER-001</id>
    <type>individual</type>
    <email>ivan.petrov@email.com</email>
    <first_name>Иван</first_name>
    <last_name>Петров</last_name>
    <phone>+79161234567</phone>
    <customer_type>тренер</customer_type>
    <is_verified>true</is_verified>
  </customer>
</customers>
```

### Dependencies

- **Depends on:** User model, role system, Story 3.1.1 (ImportSession model)
- **Blocks:** Story 3.2.2 (conflict resolution)
- **Related:** Authentication system, pricing logic

### Информация из Story 3.1.1 (ImportSession model)

**Модель ImportSession** (из Story 3.1.1):

- Поля: `import_type`, `status`, `started_at`, `finished_at`, `report_details` (JSONField), `error_message`
- Типы импорта: `CATALOG`, `STOCKS`, `PRICES`, `CUSTOMERS`
- Статусы: `STARTED`, `COMPLETED`, `FAILED`
- Используется для отслеживания сессий импорта и атомарности операций

**Использование в этой истории:**

- Команда `load_customers` должна создавать сессию с типом `CUSTOMERS`
- Все ошибки и статистика должны логироваться в `report_details`
- В конце работы статус должен обновляться на `COMPLETED` или `FAILED`

### Edge Cases и обработка ошибок

**1. Обработка дубликатов клиентов:**

- **Сценарий:** Клиент существует в 1С и на платформе (разные ID)
- **Решение:** Поиск по onec_id (основной) и email (вторичный), слияние записей
- **Логирование:** Запись в CustomerSyncLog с типом 'duplicate_customer'

**2. Некорректные данные из 1С:**

- **Сценарий:** Отсутствует email или невалидный формат
- **Решение:** Пропуск записи с логированием ошибки, продолжение импорта
- **Логирование:** Запись в CustomerSyncLog с типом 'validation_error'

**3. Несопоставимые типы клиентов:**

- **Сценарий:** Тип клиента в 1С не соответствует маппингу ролей
- **Решение:** Fallback к роли 'retail' с логированием предупреждения
- **Логирование:** Запись в CustomerSyncLog с типом 'role_mapping_warning'

**4. Прерывание импорта:**

- **Сценарий:** Сбой системы или ошибка в файле данных
- **Решение:** Откат транзакции через ImportSession, сохранение прогресса
- **Логирование:** Обновление статуса ImportSession на 'failed' с деталями ошибки

**5. Конфликты данных:**

- **Сценарий:** Данные клиента в 1С и на платформе различаются
- **Решение:** Приоритет данным из 1С для импортируемых клиентов
- **Логирование:** Запись в CustomerSyncLog с типом 'data_conflict'

### Тестирование

**Принципы тестирования (согласно [`docs/architecture/10-testing-strategy.md`](docs/architecture/10-testing-strategy.md)):**

- **Пирамида тестирования:** Основание - быстрые unit-тесты, середина - интеграционные тесты, вершина - E2E тесты
- **Полная изоляция тестов:** Каждый тест выполняется в изолированной среде с автоматической очисткой
- **Генерация уникальных данных:** Использование комбинированного подхода для избежания конфликтов
- **Маркировка тестов:** Обязательное использование маркеров `@pytest.mark.unit` и `@pytest.mark.integration`

**Подход к тестированию:**

- **Unit-тесты:** Для изолированного тестирования CustomerDataParser и CustomerDataProcessor
- **Интеграционные тесты:** Для проверки полной команды load_customers с реальными XML-данными
- **Тесты edge cases:** Для проверки обработки ошибок и особых сценариев
- **Performance тесты:** Для проверки производительности при импорте больших объемов данных

**Требования к покрытию:**

- **Общее покрытие:** ≥70%
- **Критические модули:** ≥90% (CustomerDataProcessor, CustomerDataParser, CustomerSyncLog)

**Ключевые тестовые сценарии:**

1. **Успешный импорт нового клиента:**
   - Создание клиента с корректными данными
   - Проверка маппинга роли
   - Проверка создания записей в CustomerSyncLog

2. **Обновление существующего клиента:**
   - Импорт клиента с существующим onec_id
   - Проверка обновления данных
   - Проверка статуса синхронизации

3. **Обработка дубликатов:**
   - Импорт клиента с существующим email
   - Проверка логики слияния записей
   - Проверка логирования дубликатов

4. **Валидация данных:**
   - Импорт клиента с невалидным email
   - Проверка пропуска записи с логированием ошибки
   - Проверка продолжения импорта после ошибки

5. **Маппинг ролей:**
   - Импорт клиентов с различными типами из 1С
   - Проверка корректного маппинга на роли платформы
   - Проверка fallback-логики для неизвестных типов

6. **Обработка ошибок импорта:**
   - Имитация сбоя в середине процесса
   - Проверка отката через ImportSession
   - Проверка сохранения прогресса

**Тестовые данные:**

- Создать тестовые XML-файлы с различными сценариями
- Включить клиентов всех типов (физ.лица, юр.лица)
- Включить пограничные случаи (пустые поля, невалидные данные)

**Критерии успеха тестирования:**

- Покрытие кода ≥90% для критических модулей
- Все edge cases обработаны корректно
- Performance тесты подтверждают обработку ≥1000 клиентов за приемлемое время
- Интеграционные тесты проходят с реальными данными из 1С

## Story Points

**13** (High complexity due to new architecture, role mapping and validation)

## Priority

**High** - Критично для B2B функциональности

## Labels

`epic-3` `1c-integration` `customer-sync` `role-mapping` `b2b` `refactoring
