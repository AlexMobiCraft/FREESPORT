# Story 3.4.3: data-integrity-checks

## Status
Ready for Development

## Story
**As a** системный администратор,
**I want** быть уверен, что синхронизация не нарушает целостность базы данных,
**so that** система остается стабильной и надежной.

## Acceptance Criteria

1. Созданы проверки referential integrity между связанными моделями
2. Настроена валидация бизнес-правил
3. Реализованы проверки консистентности данных
4. Созданы команды для диагностики целостности
5. Настроены automated integrity checks
6. Созданы тесты для всех проверок
7. Настроены алерты при нарушении целостности

### Integrity Checks:

**Referential Integrity:**
- User ↔ CustomerSyncLog связи
- User ↔ SyncConflict связи (для аудита конфликтов)
- Product ↔ Category связи
- User.onec_id уникальность
- User.onec_guid уникальность
- Orphaned records detection в CustomerSyncLog

**Business Rules:**
- Цены товаров должны быть положительными
- Email должен быть уникальным (с учетом нормализации)
- ИНН валидация для юр.лиц (10 или 12 цифр)
- onec_id уникальность среди клиентов из 1С
- Клиенты с created_in_1c=True должны иметь onec_id или onec_guid

**Data Consistency:**
- Суммы в корзине = цены товаров * количество
- Остатки товаров не отрицательные без резерва
- Синхронизация timestamps логичны
- Status transitions валидны

## Definition of Done
- [ ] БД остается консистентной после любых операций
- [ ] Нарушения выявляются автоматически в течение 5 минут
- [ ] Проблемы решаются в рамках SLA
- [ ] 100% автоматизация проверок

## Story Points
**5** (Medium complexity, validation logic)

## Priority
**High** - Критично для стабильности системы

## Labels
`epic-3` `data-integrity` `validation` `automated-checks` `database`