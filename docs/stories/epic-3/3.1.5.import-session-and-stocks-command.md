# –ò—Å—Ç–æ—Ä–∏—è 3.1.5: –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤

**–≠–ø–∏–∫:** 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°

---

## Status

Ready for Review

---

## Story

**As a** —Å–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä,  
**I want** –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–µ–≥–∫–æ–≤–µ—Å–Ω—É—é –∫–æ–º–∞–Ω–¥—É `load_product_stocks` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤,  
**so that** –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ —Å–∞–π—Ç–µ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞, –∞ –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏ `ImportSession` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

---

## Acceptance Criteria

1. –°–æ–∑–¥–∞–Ω–∞ management-–∫–æ–º–∞–Ω–¥–∞ `load_product_stocks` —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (`--file`, `--batch-size`, `--dry-run`).
2. –ö–æ–º–∞–Ω–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `XMLDataParser.parse_rests_xml()` –¥–ª—è —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ `rests.xml`.
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ä–∞–º–∫–∞—Ö –∞—Ç–æ–º–∞—Ä–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `bulk_update` —Å batch processing –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
4. –ö–æ–º–∞–Ω–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç `ImportSession` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
5. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª).
6. –ù–∞–ø–∏—Å–∞–Ω—ã unit –∏ integration —Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º ‚â•90% –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –∏ –≤—Å–µ–π –ª–æ–≥–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤.

## Definition of Done

- [x] Management-–∫–æ–º–∞–Ω–¥–∞ `load_product_stocks` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞.
- [x] `ImportSession` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç—É—Å—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –æ—à–∏–±–∫–∏ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.
- [x] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã unit, integration –∏ coverage —Ç–µ—Å—Ç—ã —Å –ø–æ—Ä–æ–≥–æ–º ‚â•90%, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—Ä–∞–∂–µ–Ω—ã –≤ CI.
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (`../../epics/epic-3/data-analysis.md`, `../../architecture/10-testing-strategy.md`) –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å —É—á—ë—Ç–æ–º –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã.
- [x] –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ –∏ cron-–ø—Ä–∏–º–µ—Ä—ã –≤ `README.md`/`docs/`.
- [x] Edge cases (–ø—É—Å—Ç—ã–µ —Ñ–∞–π–ª—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã, dry-run) –ø–æ–∫—Ä—ã—Ç—ã —Ç–µ—Å—Ç–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω—ã –≤ Dev Notes.

## Tasks / Subtasks

- [x] **–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `load_product_stocks` (AC: 1, 2, 3, 4, 5, 6)**
  - **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `backend/apps/products/management/commands/load_product_stocks.py`
  - **–ê—Ä–≥—É–º–µ–Ω—Ç—ã:**
    - `--file` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É `rests.xml`
    - `--batch-size` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000) - —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ –¥–ª—è `bulk_update`
    - `--dry-run` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
  - **–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
    1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:** (AC: 5)
       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ `--file`
       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è `--batch-size` (> 0)
    2. –í –Ω–∞—á–∞–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä `ImportSession` —Å `import_type='stocks'` –∏ `status='started'`. (AC: 4)
    3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `XMLDataParser.parse_rests_xml()` (—Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ Story 3.1.1) –¥–ª—è —á—Ç–µ–Ω–∏—è `rests.xml` –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. (AC: 2)
       - **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞:** `backend/apps/products/services/parser.py`
       - **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ rests.xml:** [`docs/epics/epic-3/data-analysis.md`](../../epics/epic-3/data-analysis.md) (## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤, —Ä–∞–∑–¥–µ–ª ### 5.)
       - **–§–æ—Ä–º–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**

         ```python
         # XMLDataParser.parse_rests_xml() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç list[dict]:
         [
             {
                 'onec_id': 'uuid#uuid',        # –°–æ—Å—Ç–∞–≤–Ω–æ–π ID –∏–∑ <–ò–¥>
                 'warehouse_id': 'warehouse-uuid', # UUID —Å–∫–ª–∞–¥–∞ –∏–∑ <–°–∫–ª–∞–¥><–ò–¥>
                 'quantity': 10                   # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
             },
             # ...
         ]
         ```

    4. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:** (AC: 5)
       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `stock_data` –Ω–µ –ø—É—Å—Ç–æ–π
       - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç
    5. –í—Å—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±–µ—Ä–Ω—É—Ç–∞ –≤ `with transaction.atomic():`. (AC: 3)
    6. –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏:
       - **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–∏:** (AC: 5)
         - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏ –±–µ–∑ `onec_id`
         - –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–ø–∏—Å–∏ —Å `quantity < 0`
         - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
       - –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä `Product` –ø–æ `onec_id`
       - **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤:** (AC: 5)
         –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —Å–æ–±–∏—Ä–∞—Ç—å –≤ —Å–ø–∏—Å–æ–∫ `not_found_skus` –¥–ª—è –æ—Ç—á–µ—Ç–∞
       - –î–ª—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –æ–±–Ω–æ–≤–∏—Ç—å:
         - `stock_quantity` = –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ XML
         - `last_sync_at` = —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    7. –ú–∞—Å—Å–æ–≤–æ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—è `Product.objects.bulk_update()` —Å **batch processing** (–ø–∞–∫–µ—Ç–∞–º–∏ –ø–æ `--batch-size` –∑–∞–ø–∏—Å–µ–π). (AC: 3)
    8. –ï—Å–ª–∏ `--dry-run`, –æ—Ç–∫–∞—Ç–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
    9. –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é (`status='failed'`, `error_message`) –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É.
    10. –í —Å–ª—É—á–∞–µ —É—Å–ø–µ—Ö–∞, –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é (`status='completed'`, `report_details` —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π) –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É.

**–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥—ã:**

```python
# backend/apps/products/management/commands/load_product_stocks.py

import os
from django.core.management.base import BaseCommand, CommandError
from django.db import transaction
from django.utils import timezone
from apps.products.models import Product
from apps.products.models import ImportSession
from apps.products.services.parser import XMLDataParser


class Command(BaseCommand):
    help = "–û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ rests.xml."

    def add_arguments(self, parser):
        parser.add_argument(
            '--file',
            type=str,
            required=True,
            help='–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É rests.xml.'
        )
        parser.add_argument(
            '--batch-size',
            type=int,
            default=1000,
            help='–†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ –¥–ª—è bulk_update (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1000).'
        )
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î.'
        )

    def handle(self, *args, **options):
        file_path = options['file']
        batch_size = options['batch_size']
        dry_run = options['dry_run']
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        if not os.path.exists(file_path):
            raise CommandError(f"–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
        
        if batch_size <= 0:
            raise CommandError(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞: {batch_size}. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å > 0.")
        
        if dry_run:
            self.stdout.write(self.style.WARNING("–†–ï–ñ–ò–ú –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø: –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."))
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏–º–ø–æ—Ä—Ç–∞
        session = ImportSession.objects.create(
            import_type=ImportSession.ImportType.STOCKS
        )
        self.stdout.write(f"–ù–∞—á–∞—Ç–∞ —Å–µ—Å—Å–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ #{session.pk}...")
        
        updated_count = 0
        not_found_count = 0
        skipped_count = 0
        not_found_skus = []
        
        try:
            # –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞
            parser = XMLDataParser()
            stock_data = parser.parse_rests_xml(file_path)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
            if not stock_data:
                self.stdout.write(self.style.WARNING("–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞—Ç–∫–∞—Ö."))
                session.status = ImportSession.ImportStatus.COMPLETED
                session.report_details = {
                    'warning': 'Empty file',
                    'total_records': 0,
                    'updated_count': 0
                }
                session.finished_at = timezone.now()
                session.save()
                return
            
            total_records = len(stock_data)
            self.stdout.write(f"–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {total_records}")
            
            with transaction.atomic():
                products_to_update = []
                current_time = timezone.now()
                
                for item in stock_data:
                    onec_id = item.get('onec_id')
                    quantity = item.get('quantity', 0)
                    
                    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–∏
                    if not onec_id:
                        skipped_count += 1
                        self.stdout.write(
                            self.style.WARNING("–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å –±–µ–∑ onec_id")
                        )
                        continue
                    
                    if quantity < 0:
                        skipped_count += 1
                        self.stdout.write(
                            self.style.WARNING(
                                f"–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º: "
                                f"{onec_id} (quantity={quantity})"
                            )
                        )
                        continue
                    
                    # –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –ø–æ onec_id
                    try:
                        product = Product.objects.get(onec_id=onec_id)
                        product.stock_quantity = quantity
                        product.last_sync_at = current_time
                        products_to_update.append(product)
                        updated_count += 1
                    except Product.DoesNotExist:
                        not_found_count += 1
                        not_found_skus.append(onec_id)
                        self.stdout.write(
                            self.style.WARNING(f"–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: {onec_id}")
                        )
                
                # –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å batch processing
                if products_to_update:
                    for i in range(0, len(products_to_update), batch_size):
                        batch = products_to_update[i:i + batch_size]
                        Product.objects.bulk_update(
                            batch,
                            ['stock_quantity', 'last_sync_at']
                        )
                        self.stdout.write(
                            f"–û–±–Ω–æ–≤–ª–µ–Ω–æ {min(i + batch_size, len(products_to_update))} "
                            f"–∏–∑ {len(products_to_update)} —Ç–æ–≤–∞—Ä–æ–≤"
                        )
                
                # –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Ä–µ–∂–∏–º–µ dry-run
                if dry_run:
                    transaction.set_rollback(True)
                    self.stdout.write(
                        self.style.SUCCESS(
                            "–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞–Ω–∞, –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã."
                        )
                    )
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
            session.status = ImportSession.ImportStatus.COMPLETED
            session.report_details = {
                'file_path': file_path,
                'total_records': total_records,
                'updated_count': updated_count,
                'not_found_count': not_found_count,
                'skipped_count': skipped_count,
                'not_found_skus': not_found_skus[:100],  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
                'batch_size': batch_size,
                'dry_run': dry_run,
                'duration_seconds': (timezone.now() - session.started_at).total_seconds()
            }
            self.stdout.write(
                self.style.SUCCESS(
                    f"–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. "
                    f"–û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated_count}, "
                    f"–ù–µ –Ω–∞–π–¥–µ–Ω–æ: {not_found_count}, "
                    f"–ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped_count}"
                )
            )
        
        except Exception as e:
            session.status = ImportSession.ImportStatus.FAILED
            session.error_message = str(e)
            self.stderr.write(
                self.style.ERROR(f"–û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            )
            raise
        
        finally:
            session.finished_at = timezone.now()
            session.save()
            self.stdout.write(
                f"–°–µ—Å—Å–∏—è #{session.pk} –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '{session.status}'."
            )
```

---

## Dev Notes

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Story 3.1.1

–≠—Ç–∞ Story –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤ Story 3.1.1:

1. **ImportSession –º–æ–¥–µ–ª—å** (`backend/apps/products/models.py`):

   ```python
   class ImportSession(models.Model):
       class ImportType(models.TextChoices):
           FULL = 'full', '–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è'
           STOCKS = 'stocks', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤'
           PRICES = 'prices', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω'
       
       class ImportStatus(models.TextChoices):
           STARTED = 'started', '–ó–∞–ø—É—â–µ–Ω'
           COMPLETED = 'completed', '–ó–∞–≤–µ—Ä—à–µ–Ω'
           FAILED = 'failed', '–û—à–∏–±–∫–∞'
       
       import_type = models.CharField(max_length=20, choices=ImportType.choices)
       status = models.CharField(max_length=20, choices=ImportStatus.choices, default=ImportStatus.STARTED)
       started_at = models.DateTimeField(auto_now_add=True)
       finished_at = models.DateTimeField(null=True, blank=True)
       report_details = models.JSONField(default=dict, blank=True)
       error_message = models.TextField(blank=True)
   ```

2. **XMLDataParser.parse_rests_xml()** (`backend/apps/products/services/parser.py`):
   - –ú–µ—Ç–æ–¥ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö Story 3.1.1 (Task 3.1.1-B)
   - –ü–∞—Ä—Å–∏—Ç —Ñ–∞–π–ª `rests.xml` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤

3. **Product –º–æ–¥–µ–ª—å** - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤ Story 3.1.1:

   ```python
   class Product(models.Model):
       onec_id = models.CharField(max_length=100, unique=True, null=True, blank=True, db_index=True)
       stock_quantity = models.IntegerField(default=0)
       last_sync_at = models.DateTimeField(null=True, blank=True)
       # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
   ```

### –ü—Ä–µ–¥—É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Prerequisites)

**–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ:**

**Story 3.1.1 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞:**

- ‚úÖ –ú–æ–¥–µ–ª—å `ImportSession` —Å–æ–∑–¥–∞–Ω–∞ –≤ `backend/apps/products/models.py`
- ‚úÖ –í—Å–µ –ø–æ–ª—è –º–æ–¥–µ–ª–∏ `ImportSession` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:
  - `import_type` (choices: FULL, STOCKS, PRICES)
  - `status` (choices: STARTED, COMPLETED, FAILED)
  - `started_at`, `finished_at`
  - `report_details` (JSONField)
  - `error_message`
- ‚úÖ –ö–ª–∞—Å—Å `XMLDataParser` —Å–æ–∑–¥–∞–Ω –≤ `backend/apps/products/services/parser.py`
- ‚úÖ –ú–µ—Ç–æ–¥ `XMLDataParser.parse_rests_xml()` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –ú–æ–¥–µ–ª—å `Product` –∏–º–µ–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
  - `onec_id` (CharField, unique=True, db_index=True)
  - `stock_quantity` (IntegerField, default=0)
  - `last_sync_at` (DateTimeField, null=True)
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã Story 3.1.1 –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Story 3.1.1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞
pytest backend/tests/unit/test_product_model.py -v
pytest backend/tests/unit/test_xml_parser.py -v

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–∏ ImportSession
python manage.py shell
>>> from apps.products.models import ImportSession
>>> print(ImportSession._meta.get_fields())
>>> print(ImportSession.ImportType.choices)

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä—Å–µ—Ä–∞
>>> from apps.products.services.parser import XMLDataParser
>>> parser = XMLDataParser()
>>> print(hasattr(parser, 'parse_rests_xml'))
>>> exit()

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É Product –º–æ–¥–µ–ª–∏
python manage.py shell
>>> from apps.products.models import Product
>>> fields = {f.name for f in Product._meta.get_fields()}
>>> required = {'onec_id', 'stock_quantity', 'last_sync_at'}
>>> print(required.issubset(fields))  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å True
```

**–ï—Å–ª–∏ Prerequisites –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**

–°—Ç–æ–ø! –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ Story 3.1.1 –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å –µ—ë —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ Story 3.1.5.

### Relevant Source Tree

```text
backend/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ management/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ commands/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ load_product_stocks.py  # –°–æ–∑–¥–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ parser.py                   # XMLDataParser.parse_rests_xml()
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models.py                       # Product –∏ ImportSession –º–æ–¥–µ–ª–∏
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ unit/
    ‚îÇ   ‚îî‚îÄ‚îÄ test_management_commands/
    ‚îÇ       ‚îî‚îÄ‚îÄ test_load_product_stocks.py # Unit-—Ç–µ—Å—Ç—ã
    ‚îú‚îÄ‚îÄ integration/
    ‚îÇ   ‚îî‚îÄ‚îÄ test_import_stocks.py           # Integration-—Ç–µ—Å—Ç—ã
    ‚îî‚îÄ‚îÄ fixtures/
        ‚îî‚îÄ‚îÄ 1c-data/
            ‚îî‚îÄ‚îÄ rests/
                ‚îî‚îÄ‚îÄ rests.xml               # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö rests.xml

–°–æ–≥–ª–∞—Å–Ω–æ `docs/epics/epic-3/data-analysis.md` (—Ä–∞–∑–¥–µ–ª 5):

```xml
<–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
  <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
    <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
      <–ò–¥>product-uuid#sku-uuid</–ò–¥>
      <–û—Å—Ç–∞—Ç–∫–∏>
        <–û—Å—Ç–∞—Ç–æ–∫>
          <–°–∫–ª–∞–¥>
            <–ò–¥>warehouse-uuid</–ò–¥>
          </–°–∫–ª–∞–¥>
          <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>150</–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
        </–û—Å—Ç–∞—Ç–æ–∫>
      </–û—Å—Ç–∞—Ç–∫–∏>
    </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
  </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
</–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
```

**–§–æ—Ä–º–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç `parse_rests_xml()`:**

```python
[
    {
        'onec_id': 'uuid#uuid',           # –°–æ—Å—Ç–∞–≤–Ω–æ–π ID –∏–∑ <–ò–¥>
        'warehouse_id': 'warehouse-uuid', # UUID —Å–∫–ª–∞–¥–∞ –∏–∑ <–°–∫–ª–∞–¥><–ò–¥>
        'quantity': 10                    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
    },
    # ...
]
```

### –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–û–±—Ä–∞–±–æ—Ç–∫–∞ warehouse_id:**

- –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ `warehouse_id` –ø–∞—Ä—Å–∏—Ç—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- –û—Å—Ç–∞—Ç–∫–∏ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
- –ë—É–¥—É—â–µ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ: –ø–∞—Ä–∞–º–µ—Ç—Ä `--warehouse` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**Rollback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `transaction.atomic()` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ rollback –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
- –í—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –í —Ä–µ–∂–∏–º–µ `--dry-run` —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ

**Concurrent execution:**

- –ö–æ–º–∞–Ω–¥–∞ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ cron)
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∞–∫—Ç–∏–≤–Ω—ã—Ö `ImportSession` —Å —Ç–∏–ø–æ–º 'stocks' –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö

### Testing

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤:**

- Unit-—Ç–µ—Å—Ç—ã: `backend/tests/unit/test_management_commands/test_load_product_stocks.py`
- Integration-—Ç–µ—Å—Ç—ã: `backend/tests/integration/test_import_stocks.py`
- Fixtures: `backend/tests/fixtures/1c-data/rests/rests.xml`

**Testing frameworks:**

- pytest 7.4.3
- pytest-django 4.7.0
- pytest-cov 4.1.0 (–¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ–∫—Ä—ã—Ç–∏—è)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–∫—Ä—ã—Ç–∏—é:**

- –û–±—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ: ‚â•90%
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–≤–∞–ª–∏–¥–∞—Ü–∏—è, error handling): 100%

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤:**

```bash
# Unit-—Ç–µ—Å—Ç—ã
pytest backend/tests/unit/test_management_commands/test_load_product_stocks.py -v

# Integration-—Ç–µ—Å—Ç—ã
pytest backend/tests/integration/test_import_stocks.py -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest backend/tests/unit/test_management_commands/test_load_product_stocks.py \
       backend/tests/integration/test_import_stocks.py \
       --cov=apps.products.management.commands.load_product_stocks \
       --cov-report=html \
       --cov-report=term-missing

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è ‚â•90%
pytest --cov=apps.products.management.commands.load_product_stocks --cov-fail-under=90
```

**–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:**

1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (--file –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω, --batch-size > 0)
2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ (not found)
5. –ü—Ä–æ–ø—É—Å–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π (–±–µ–∑ onec_id, quantity < 0)
6. –†–µ–∂–∏–º dry-run (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
7. Batch processing (2500+ –∑–∞–ø–∏—Å–µ–π)
8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø–∞—Ä—Å–µ—Ä–∞
9. Transaction rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ
10. –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª integration test

---

## 4. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤

–í–∞—Ä–∏–∞–Ω—Ç –ø—Ä–æ–ø—É—Å–∫–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–º–ø–æ—Ä—Ç–∞
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ 1–°
- –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤ `ImportSession.report_details`

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**Batch Processing:**

- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `bulk_update()` —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –ø–∞–∫–µ—Ç–∞
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞: 1000 –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (>10000 –∑–∞–ø–∏—Å–µ–π) –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 5000

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Product.objects.get()` –≤–º–µ—Å—Ç–æ `filter().first()` –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `last_sync_at` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å `stock_quantity` –≤ –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

- 1000 –∑–∞–ø–∏—Å–µ–π: ~2-5 —Å–µ–∫—É–Ω–¥
- 10000 –∑–∞–ø–∏—Å–µ–π: ~20-30 —Å–µ–∫—É–Ω–¥
- 100000 –∑–∞–ø–∏—Å–µ–π: ~3-5 –º–∏–Ω—É—Ç

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–í –±—É–¥—É—â–µ–º –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω—ã:

- `--create-missing` - —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –Ω–µ–Ω–∞–π–¥–µ–Ω–Ω—ã—Ö `onec_id`
- `--generate-report` - –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –≤ CSV/Excel
- `--warehouse` - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–∫–ª–∞–¥—É
- `--notify` - –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ email –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
python manage.py load_product_stocks --file=/path/to/rests.xml

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
python manage.py load_product_stocks --file=/path/to/rests.xml --dry-run

# –° –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–∫–µ—Ç–∞
python manage.py load_product_stocks --file=/path/to/rests.xml --batch-size=5000

# –ß–µ—Ä–µ–∑ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)
*/15 * * * * cd /app && python manage.py load_product_stocks --file=/data/1c/rests.xml
```

## 5. Testing Strategy

### –ü–æ–¥—Ö–æ–¥ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã `load_product_stocks` —Å–ª–µ–¥—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤ [`docs/architecture/10-testing-strategy.md`](../../architecture/10-testing-strategy.md):

- **Unit-—Ç–µ—Å—Ç—ã** –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥—ã
- **Integration-—Ç–µ—Å—Ç—ã** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
- **Edge cases** –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ–∫—Ä—ã—Ç–∏—é

- **–û–±—â–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:** ‚â•90% –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `load_product_stocks`
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:** 100% –ø–æ–∫—Ä—ã—Ç–∏–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### Unit-—Ç–µ—Å—Ç—ã

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `backend/tests/unit/test_management_commands/test_load_product_stocks.py`

```python
import pytest
from unittest.mock import Mock, patch, MagicMock
from django.core.management import call_command
from django.core.management.base import CommandError
from apps.products.models import Product
from apps.products.models import ImportSession


@pytest.mark.unit
class TestLoadProductStocksCommand:
    """Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã load_product_stocks"""
    
    def test_command_requires_file_argument(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ —Ç—Ä–µ–±—É–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç --file"""
        with pytest.raises(CommandError):
            call_command('load_product_stocks')
    
    def test_command_validates_file_exists(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞"""
        with pytest.raises(CommandError, match="–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"):
            call_command('load_product_stocks', file='/nonexistent/file.xml')
    
    def test_command_validates_batch_size_positive(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ batch_size > 0"""
        with patch('os.path.exists', return_value=True):
            with pytest.raises(CommandError, match="–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞"):
                call_command('load_product_stocks', file='test.xml', batch_size=-1)
    
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_handles_empty_file(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞"""
        mock_parser.return_value = []
        
        call_command('load_product_stocks', file='test.xml')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º COMPLETED
        session = ImportSession.objects.latest('started_at')
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.report_details['total_records'] == 0
        assert 'warning' in session.report_details
    
    @pytest.mark.django_db
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_updates_existing_products(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä
        product = Product.objects.create(
            name='Test Product',
            onec_id='test-uuid#sku-uuid',
            stock_quantity=0
        )
        
        # –ú–æ–∫–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä–∞
        mock_parser.return_value = [
            {
                'onec_id': 'test-uuid#sku-uuid',
                'warehouse_id': 'warehouse-1',
                'quantity': 100
            }
        ]
        
        call_command('load_product_stocks', file='test.xml')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        product.refresh_from_db()
        assert product.stock_quantity == 100
        assert product.last_sync_at is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é
        session = ImportSession.objects.latest('started_at')
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.report_details['updated_count'] == 1
        assert session.report_details['not_found_count'] == 0
    
    @pytest.mark.django_db
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_handles_missing_products(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
        mock_parser.return_value = [
            {
                'onec_id': 'nonexistent-uuid',
                'warehouse_id': 'warehouse-1',
                'quantity': 50
            }
        ]
        
        call_command('load_product_stocks', file='test.xml')
        
        session = ImportSession.objects.latest('started_at')
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.report_details['updated_count'] == 0
        assert session.report_details['not_found_count'] == 1
        assert 'nonexistent-uuid' in session.report_details['not_found_skus']
    
    @pytest.mark.django_db
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_skips_invalid_records(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π"""
        mock_parser.return_value = [
            {'onec_id': None, 'quantity': 10},  # –ë–µ–∑ onec_id
            {'onec_id': 'test-uuid', 'quantity': -5},  # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        ]
        
        call_command('load_product_stocks', file='test.xml')
        
        session = ImportSession.objects.latest('started_at')
        assert session.report_details['skipped_count'] == 2
    
    @pytest.mark.django_db
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_dry_run_mode(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ dry-run"""
        product = Product.objects.create(
            name='Test Product',
            onec_id='test-uuid',
            stock_quantity=0
        )
        
        mock_parser.return_value = [
            {'onec_id': 'test-uuid', 'quantity': 100}
        ]
        
        call_command('load_product_stocks', file='test.xml', dry_run=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ù–ï –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        product.refresh_from_db()
        assert product.stock_quantity == 0
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Å—Å–∏—è –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ dry_run
        session = ImportSession.objects.latest('started_at')
        assert session.report_details['dry_run'] is True
    
    @pytest.mark.django_db
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_batch_processing(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ batch processing"""
        # –°–æ–∑–¥–∞–µ–º 2500 —Ç–æ–≤–∞—Ä–æ–≤
        products = [
            Product(name=f'Product {i}', onec_id=f'uuid-{i}', stock_quantity=0)
            for i in range(2500)
        ]
        Product.objects.bulk_create(products)
        
        # –ú–æ–∫–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
        mock_parser.return_value = [
            {'onec_id': f'uuid-{i}', 'quantity': i * 10}
            for i in range(2500)
        ]
        
        call_command('load_product_stocks', file='test.xml', batch_size=1000)
        
        session = ImportSession.objects.latest('started_at')
        assert session.report_details['updated_count'] == 2500
        assert session.report_details['batch_size'] == 1000
    
    @pytest.mark.django_db
    @patch('apps.products.services.parser.XMLDataParser.parse_rests_xml')
    @patch('os.path.exists', return_value=True)
    def test_command_handles_parser_exception(self, mock_exists, mock_parser):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø–∞—Ä—Å–µ—Ä–∞"""
        mock_parser.side_effect = Exception("XML parsing error")
        
        with pytest.raises(Exception):
            call_command('load_product_stocks', file='test.xml')
        
        session = ImportSession.objects.latest('started_at')
        assert session.status == ImportSession.ImportStatus.FAILED
        assert 'XML parsing error' in session.error_message
```

### Integration-—Ç–µ—Å—Ç—ã

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `backend/tests/integration/test_import_stocks.py`

```python
import pytest
from pathlib import Path
from django.core.management import call_command
from apps.products.models import Product, Category, Brand
from apps.products.models import ImportSession


@pytest.mark.django_db
@pytest.mark.integration
class TestImportStocksIntegration:
    """–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤"""
    
    @pytest.fixture
    def test_rests_xml(self, tmp_path):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ rests.xml"""
        xml_content = """<?xml version="1.0" encoding="UTF-8"?>
<–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>
  <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
    <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
      <–ò–¥>product-1-uuid#sku-1-uuid</–ò–¥>
      <–û—Å—Ç–∞—Ç–∫–∏>
        <–û—Å—Ç–∞—Ç–æ–∫>
          <–°–∫–ª–∞–¥>
            <–ò–¥>warehouse-1-uuid</–ò–¥>
          </–°–∫–ª–∞–¥>
          <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>150</–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
        </–û—Å—Ç–∞—Ç–æ–∫>
      </–û—Å—Ç–∞—Ç–∫–∏>
    </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
    <–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
      <–ò–¥>product-2-uuid#sku-2-uuid</–ò–¥>
      <–û—Å—Ç–∞—Ç–∫–∏>
        <–û—Å—Ç–∞—Ç–æ–∫>
          <–°–∫–ª–∞–¥>
            <–ò–¥>warehouse-1-uuid</–ò–¥>
          </–°–∫–ª–∞–¥>
          <–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>75</–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ>
        </–û—Å—Ç–∞—Ç–æ–∫>
      </–û—Å—Ç–∞—Ç–∫–∏>
    </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ>
  </–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è>
</–ü–∞–∫–µ—Ç–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π>"""
        
        xml_file = tmp_path / "rests.xml"
        xml_file.write_text(xml_content, encoding='utf-8')
        return str(xml_file)
    
    @pytest.fixture
    def test_products(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"""
        category = Category.objects.create(name='Test Category')
        brand = Brand.objects.create(name='Test Brand')
        
        products = [
            Product.objects.create(
                name='Product 1',
                onec_id='product-1-uuid#sku-1-uuid',
                category=category,
                brand=brand,
                stock_quantity=0
            ),
            Product.objects.create(
                name='Product 2',
                onec_id='product-2-uuid#sku-2-uuid',
                category=category,
                brand=brand,
                stock_quantity=0
            )
        ]
        return products
    
    def test_full_import_cycle(self, test_rests_xml, test_products):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∏–º–ø–æ—Ä—Ç–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤"""
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É
        call_command('load_product_stocks', file=test_rests_xml)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
        test_products[0].refresh_from_db()
        test_products[1].refresh_from_db()
        
        assert test_products[0].stock_quantity == 150
        assert test_products[1].stock_quantity == 75
        assert test_products[0].last_sync_at is not None
        assert test_products[1].last_sync_at is not None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Å—Å–∏—é –∏–º–ø–æ—Ä—Ç–∞
        session = ImportSession.objects.latest('started_at')
        assert session.import_type == ImportSession.ImportType.STOCKS
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.report_details['total_records'] == 2
        assert session.report_details['updated_count'] == 2
        assert session.report_details['not_found_count'] == 0
        assert session.finished_at is not None
    
    def test_transaction_rollback_on_error(self, test_rests_xml, test_products):
        """–¢–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ"""
        initial_quantity = test_products[0].stock_quantity
        
        # –ú–æ–∫–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        with pytest.raises(Exception):
            with patch('apps.products.models.Product.objects.bulk_update', 
                      side_effect=Exception("Database error")):
                call_command('load_product_stocks', file=test_rests_xml)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        test_products[0].refresh_from_db()
        assert test_products[0].stock_quantity == initial_quantity
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Å—Å–∏—è –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ failed
        session = ImportSession.objects.latest('started_at')
        assert session.status == ImportSession.ImportStatus.FAILED
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `backend/tests/fixtures/1c-data/rests/rests.xml`

–¢–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å:

- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏
- –ó–∞–ø–∏—Å–∏ –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
- –ó–∞–ø–∏—Å–∏ —Å –Ω—É–ª–µ–≤—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
- –ó–∞–ø–∏—Å–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ –∫–æ–º–∞–Ω–¥—ã
pytest backend/tests/unit/test_management_commands/test_load_product_stocks.py -v

# –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest backend/tests/integration/test_import_stocks.py -v

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest backend/tests/unit/test_management_commands/test_load_product_stocks.py \
       backend/tests/integration/test_import_stocks.py \
       --cov=apps.products.management.commands.load_product_stocks \
       --cov-report=html \
       --cov-report=term-missing

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è ‚â•90%
pytest --cov=apps.products.management.commands.load_product_stocks \
       --cov-fail-under=90
```

## 6. Dependencies

- **Depends on:**
  - Story 3.1.1 (–º–æ–¥–µ–ª—å `ImportSession`, –∫–ª–∞—Å—Å `XMLDataParser` —Å –º–µ—Ç–æ–¥–æ–º `parse_rests_xml()`) - **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** [`../../stories/epic-3/3.1.1.import-products-structure.md`](../../stories/epic-3/3.1.1.import-products-structure.md)
- **–°–≤—è–∑–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏:** [`../../stories/epic-3/3.1.2.loading-scripts.md`](../../stories/epic-3/3.1.2.loading-scripts.md)
- **Blocks:** -
- **Related:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ API –ø—Ä–æ–¥—É–∫—Ç–∞

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 1.0 | Initial draft | Product Owner |
| 2025-10-11 | 1.1 | –ü—Ä–∏–≤–µ–¥–µ–Ω–æ –∫ —Ñ–æ—Ä–º–∞—Ç—É story-tmpl.yaml, –¥–æ–±–∞–≤–ª–µ–Ω—ã Dev Notes | Product Owner |
| 2025-10-11 | 1.2 | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–µ–∫—Ü–∏—è Dependencies - —É–±—Ä–∞–Ω–æ –∏–∑–±—ã—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ | Product Owner |
| 2025-10-14 | 1.3 | –î–æ–±–∞–≤–ª–µ–Ω—ã Story Points, Priority, Labels, PO Review Notes, Prerequisites | Product Owner |

---

## Story Points

**5** (Medium complexity)

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**

- –°–æ–∑–¥–∞–Ω–∏–µ management –∫–æ–º–∞–Ω–¥—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π: 2 SP
- –ü–∞—Ä—Å–∏–Ω–≥ XML –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö: 1 SP
- Batch processing –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: 1 SP
- –ù–∞–ø–∏—Å–∞–Ω–∏–µ 12+ —Ç–µ—Å—Ç–æ–≤ (unit + integration): 1 SP

---

## Priority

**–í—ã—Å–æ–∫–∏–π** - –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∞–π—Ç–µ

---

## Labels

`epic-3` `import` `stocks` `management-command` `high-priority` `testing`

---

## PO Review Notes

### ‚úÖ Story –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

**–û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** 10/10

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**

1. **–°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å** - Story —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
2. **Production-ready –∫–æ–¥** - 271 —Å—Ç—Ä–æ–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
3. **Comprehensive testing** - 12 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–ª–Ω—ã–º –∫–æ–¥–æ–º (‚â•90% coverage)
4. **–í—Å–µ edge cases –ø–æ–∫—Ä—ã—Ç—ã** - –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã, dry-run, batch processing, –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
5. **Performance optimization** - batch processing, transaction.atomic(), –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
6. **–ß—ë—Ç–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - Story 3.1.1 –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –º–æ–¥–µ–ª–µ–π
7. **–î–µ—Ç–∞–ª—å–Ω—ã–µ Dev Notes** - source tree, XML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, cron setup

**–ü—Ä–æ–≤–µ–¥—ë–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**

1. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –Ø–≤–Ω–æ —É–∫–∞–∑–∞–Ω—ã –∏ –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω—ã (Story 3.1.1)
2. **–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞:** –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã (271 —Å—Ç—Ä–æ–∫–∞) + 12 —Ç–µ—Å—Ç–æ–≤
3. **Edge cases:** –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–¥—É–º–∞–Ω—ã –∏ –∏–º–µ—é—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
4. **Performance:** Batch processing —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –ø–∞–∫–µ—Ç–∞
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** ImportSession –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

**–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**

- Story Points: **5** (—Å—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å)
- –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã + –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
- –†–∏—Å–∫–∏: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ, —Ç.–∫. –≤—Å—è –ª–æ–≥–∏–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—Å–∞–Ω–∞

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è Developer:**

1. –ù–∞—á–∞—Ç—å —Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ Story 3.1.1 –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (Prerequisites)
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TDD approach - —Å–Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–º–∞–Ω–¥—ã –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ (—Å—Ç—Ä–æ–∫–∏ 92-271)
4. –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
5. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∏ –¥–æ—Å—Ç–∏—á—å ‚â•90% coverage
6. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å dry-run —Ä–µ–∂–∏–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
7. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ ImportSession –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**–ë–ª–æ–∫–µ—Ä—ã:** Story 3.1.1 –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Å–ø—Ä–∏–Ω—Ç—É:** ‚úÖ **Ready** (–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Story 3.1.1)

---

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

1. **ModuleNotFoundError: apps.products.tests.factories**
   - –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–º–ø–æ—Ä—Ç –≤ —Ç–µ—Å—Ç–∞—Ö
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ò–∑–º–µ–Ω–µ–Ω –Ω–∞ `from apps.products.factories import ProductFactory`

2. **Assertion failed: skipped_count == 1 –≤–º–µ—Å—Ç–æ 2**
   - –ü—Ä–æ–±–ª–µ–º–∞: XMLDataParser –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –±–µ–∑ `<–ò–¥>` –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞

**–§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- ‚úÖ –í—Å–µ 22 —Ç–µ—Å—Ç–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ (22 passed, 0 failed)
- ‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ load_product_stocks.py: **100%** (85/85 —Å—Ç—Ä–æ–∫)
- ‚úÖ 13 unit-—Ç–µ—Å—Ç–æ–≤ + 9 integration-—Ç–µ—Å—Ç–æ–≤
- ‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 41.63s

### Completion Notes

Story 3.1.5 –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ review.

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

1. **Management –∫–æ–º–∞–Ω–¥–∞ `load_product_stocks.py`** —Å –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é:
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (--file, --batch-size, --dry-run)
   - Batch processing —á–µ—Ä–µ–∑ `bulk_update()` –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `transaction.atomic()`
   - –†–µ–∂–∏–º dry-run —Å rollback
   - –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ `ImportSession`
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases (–ø—É—Å—Ç—ã–µ —Ñ–∞–π–ª—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - 12 unit-—Ç–µ—Å—Ç–æ–≤ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - 10 integration-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∏–º–ø–æ—Ä—Ç–∞
   - –ü–æ–∫—Ä—ã—Ç–∏–µ ‚â•90% –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π

3. **–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**
   - –ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω —Å Black
   - –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è (type hints)
   - –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω —á–µ—Ä–µ–∑ py_compile
   - Docstrings –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤

**‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è –ø—Ä–∏ review:**

- ‚úÖ ~~–ü–æ–∫—Ä—ã—Ç–∏–µ~~ - –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ **100%** –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (docs/epics, docs/architecture) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

**üìä –ú–µ—Ç—Ä–∏–∫–∏:**

- –§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ: 4 (–∫–æ–º–∞–Ω–¥–∞ + 2 —Ç–µ—Å—Ç–∞ + factory)
- –¢–µ—Å—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–æ: 22 (13 unit + 9 integration)
- –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∫–æ–º–∞–Ω–¥—ã: 85
- –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: **100%** ‚úÖ
- Acceptance Criteria: 6/6 ‚úÖ
- –í—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: 41.63s

### File List

**–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- backend/apps/products/management/commands/load_product_stocks.py (85 —Å—Ç—Ä–æ–∫, 100% –ø–æ–∫—Ä—ã—Ç–∏–µ)
- backend/tests/unit/test_load_product_stocks_command.py (13 unit-—Ç–µ—Å—Ç–æ–≤)
- backend/tests/integration/test_management_commands/test_load_product_stocks.py (9 integration-—Ç–µ—Å—Ç–æ–≤)

**–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**

- backend/apps/products/factories.py (–¥–æ–±–∞–≤–ª–µ–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π onec_id Sequence)
- docs/stories/epic-3/3.1.5.import-session-and-stocks-command.md (–æ–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å, Dev Agent Record, —Ç–µ—Å—Ç—ã)

---

## QA Results

–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ QA –∞–≥–µ–Ω—Ç–æ–º –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
