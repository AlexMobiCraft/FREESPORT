# Story 3.1.1: import-products-structure

## Status

Ready for Development

## Story

**As a** разработчик,
**I want** создать систему импорта товаров из 1С,
**so that** каталог автоматически синхронизируется с ERP системой.

## Acceptance Criteria

1. Обновлена модель `Product` и создана модель `ImportSession` для поддержки интеграции.
2. Логика импорта разделена на архитектуру Парсер/Процессор.
3. Создана management-команда `load_catalog`, использующая сессии импорта.
4. Реализована логика обработки ролевого ценообразования.
5. Реализованы валидаторы для данных товаров.
6. Настроено детальное логирование процесса импорта в `ImportSession`.
7. Написаны unit и integration тесты для всего функционала.

### Детальные задачи

- [ ] **Обновить модели для интеграции (AC: 1)**
  - [x] В модель `Product` добавить поля: `onec_id`, `sync_status`, `last_sync_at`.
  - [x] Создать миграцию для модели `Product`.
  - [ ] Создать модель `ImportSession` с полями: `status`, `started_at`, `finished_at`, `report_details` (JSONField).

- [ ] **Реализовать архитектуру Парсер/Процессор (AC: 2)**
  - [ ] Создать `XMLDataParser` для файлов `goods.xml`, `offers.xml`, `prices.xml`, `rests.xml`.
  - [ ] Создать `ProductDataProcessor`, который принимает данные от парсера.

- [ ] **Создать management-команду `load_catalog` (AC: 3)**
  - [ ] Реализовать параметры: `--file`, `--dry-run`, `--chunk-size`.
  - [ ] Команда должна создавать запись `ImportSession` в начале работы.
  - [ ] Команда должна оркестрировать вызов `XMLDataParser` и `ProductDataProcessor`.
  - [ ] В конце работы команда обновляет статус `ImportSession` (`completed` или `failed`).

- [ ] **Реализовать обработку цен (AC: 4)**
  - [x] ~~Добавить поля для всех ролей в модель `Product`~~ (Выполнено).
  - [ ] В `ProductDataProcessor` реализовать маппинг цен из `prices.xml`.
  - [ ] Реализовать fallback-логику для `federation_rep`.
    - **Решение PO (22.09.2025):** Если цена для `federation_rep` отсутствует, использовать розничную цену (`retail`).

- [ ] **Создать валидаторы данных (AC: 5)**
  - [ ] В `ProductDataProcessor` добавить валидатор уникальности `onec_id`.
  - [ ] В `ProductDataProcessor` добавить валидатор обязательных полей.

- [ ] **Настроить логирование (AC: 6)**
  - [ ] В `ProductDataProcessor` логировать ошибки валидации и статистику в `ImportSession.report_details`.

- [ ] **Создать тесты (AC: 7)**
  - [ ] Unit-тесты для `XMLDataParser`.
  - [ ] Unit-тесты для `ProductDataProcessor`.
  - [ ] Интеграционные тесты для команды `load_catalog`.

## Definition of Done

- [ ] Команда успешно импортирует тестовые данные товаров
- [ ] Все тесты проходят с покрытием ≥90%
- [ ] Логируются все операции импорта в `ImportSession`
- [ ] Код прошел code review
- [ ] Документация обновлена

## Dev Notes

### Story Context

**Epic Integration Points:**

- Интегрируется с: 1С:Управление торговлей
- Технология: Django Management Commands + XML/JSON parsing
- Следует паттерну: FREESPORT ролевое ценообразование
- Точки касания: Product model, User roles, sync logging

### Technical Architecture

```python
# apps/products/services/parser.py
class XMLDataParser:
    def parse(self, file_path):
        # returns list[dict]
        pass

# apps/products/services/processor.py
class ProductDataProcessor:
    def __init__(self, session_id):
        self.session_id = session_id

    def process_data(self, data: list[dict]):
        # validation and db operations
        pass

# apps/products/management/commands/import_catalog_from_1c.py
class Command(BaseCommand):
    def handle(self, *args, **options):
        session = ImportSession.objects.create()
        parser = XMLDataParser()
        processor = ProductDataProcessor(session.id)
        
        raw_data = parser.parse(options['file'])
        processor.process_data(raw_data)
        
        session.status = 'completed'
        session.save()
```

### Dependencies

- **Blocks:** Story 3.1.2 (скрипты загрузки)
- **Depends on:** Database design (Story 1.8)
- **Related:** 1С integration architecture

## Story Points

**13** (Complexity increased due to new architectural requirements)

## Priority

**High** - Критический путь для Epic 3

## Labels

`epic-3` `1c-integration` `product-management` `django-commands` `refactoring`

## Dev Agent Record

### Agent Model Used

James - Full Stack Developer (dev agent)

### Completion Notes

- ✅ **Task 3.1.1-A (AC: 3) ЗАВЕРШЕН**: Дополнены поля интеграции с 1С в Product модель
- ✅ Добавлены поля: `onec_id` (unique), `sync_status` (choices), `last_sync_at`, `error_message`
- ✅ Создана миграция `0009_add_1c_integration_fields`
- ✅ Добавлены индексы для оптимизации запросов по новым полям
- ✅ Написаны comprehensive unit тесты для всех новых полей
- ✅ Все тесты проходят успешно (10/10 passed)
- ✅ Нет регрессий в существующем функционале
- ✅ Исправлены некорректные пути к тестам в архитектурной документации

### File List

- backend/apps/products/models.py - добавлены 1С интеграционные поля
- backend/apps/products/migrations/0009_add_1c_integration_fields.py - миграция БД
- backend/tests/unit/test_models/test_product_models.py - добавлены тесты для новых полей
- docs/architecture/source-tree.md - исправлены пути к тестам
- docs/stories/2.5.product-detail-api.md - исправлены пути к тестам

### Change Log

- 2025-09-07: Task 3.1.1-A реализован James (dev agent)
  - Добавлены поля интеграции с 1С в Product модель
  - Создана миграция с индексами для производительности
  - Написаны unit тесты с покрытием всех edge cases
  - Исправлена документация по путям к тестам

## QA Results

### Review Date: 2025-09-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation of the `Product` model update is of high quality. The code is clean, follows project conventions, and includes appropriate database indexes for performance.

### Refactoring Performed

No refactoring was necessary as the code quality is high.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✗] (Only a part of AC #1 is complete)

### Improvements Checklist

The following items represent the remaining work required to complete this story:

- [ ] Create the `ImportSession` model (AC #1)
- [ ] Implement the `XMLDataParser` and `ProductDataProcessor` (AC #2)
- [ ] Create the `load_catalog` management command (AC #3)
- [ ] Implement price mapping and fallback logic (AC #4)
- [ ] Create data validators for the processor (AC #5)
- [ ] Implement detailed logging into `ImportSession` (AC #6)
- [ ] Write integration tests for the complete workflow (AC #7)

### Security Review

No security implications were found in the current changes.

### Performance Considerations

Database indexes have been correctly added for the new fields, which satisfies performance considerations for this change.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.1.1-import-products-structure.yml

### Recommended Status

[✗ Changes Required - See unchecked items above]
