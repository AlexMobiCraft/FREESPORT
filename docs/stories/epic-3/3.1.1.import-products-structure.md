# Story 3.1.1: import-products-structure

## Status

Ready for Development

## Story

**As a** разработчик,
**I want** создать систему импорта товаров из 1С,
**so that** каталог автоматически синхронизируется с ERP системой.

## Acceptance Criteria

1. Обновлена модель `Product` и создана модель `ImportSession` для поддержки интеграции.
2. Логика импорта разделена на архитектуру Парсер/Процессор.
3. Создана management-команда `load_catalog`, использующая сессии импорта.
4. Реализована логика обработки ролевого ценообразования.
5. Реализованы валидаторы для данных товаров.
6. Настроено детальное логирование процесса импорта в `ImportSession`.
7. Написаны unit и integration тесты для всего функционала.

### Детальные задачи

- [ ] **Обновить модели для интеграции (AC: 1)**
  - [x] В модель `Product` добавить поля: `onec_id`, `sync_status`, `last_sync_at`.
  - [x] Создать миграцию для модели `Product`.
  - [ ] Создать модель `ImportSession` с полями: `import_type`, `status`, `started_at`, `finished_at`, `report_details` (JSONField), `error_message`.
  - [ ] Создать миграцию для модели `ImportSession`.

- [ ] **Реализовать архитектуру Парсер/Процессор (AC: 2)**
  - [ ] Создать `XMLDataParser` для файлов `goods.xml`, `offers.xml`, `prices.xml`, `rests.xml`.
  - [ ] Создать `ProductDataProcessor`, который принимает данные от парсера.

- [ ] **Создать management-команду `load_catalog` (AC: 3)**
  - [ ] Реализовать параметры: `--file`, `--dry-run`, `--chunk-size`.
  - [ ] Команда должна создавать запись `ImportSession` в начале работы.
  - [ ] Команда должна оркестрировать вызов `XMLDataParser` и `ProductDataProcessor`.
  - [ ] В конце работы команда обновляет статус `ImportSession` (`completed` или `failed`).

- [ ] **Реализовать обработку цен (AC: 4)**
  - [x] ~~Добавить поля для всех ролей в модель `Product`~~ (Выполнено).
  - [ ] В `ProductDataProcessor` реализовать маппинг цен из `prices.xml`.
  - [ ] Реализовать fallback-логику для `federation_rep`.
    - **Решение PO (22.09.2025):** Если цена для `federation_rep` отсутствует, использовать розничную цену (`retail`).

- [ ] **Создать валидаторы данных (AC: 5)**
  - [ ] В `ProductDataProcessor` добавить валидатор уникальности `onec_id`.
  - [ ] В `ProductDataProcessor` добавить валидатор обязательных полей.

- [ ] **Настроить логирование (AC: 6)**
  - [ ] В `ProductDataProcessor` логировать ошибки валидации и статистику в `ImportSession.report_details`.

- [ ] **Создать тесты (AC: 7)**
  - [ ] Unit-тесты для `XMLDataParser` с проверкой структуры XML файлов.
  - [ ] Unit-тесты для `ProductDataProcessor` с проверкой валидации и маппинга цен.
  - [ ] Интеграционные тесты для команды `load_catalog` с тестовыми данными.
  - [ ] Тесты обработки ошибок импорта и логирования в `ImportSession`.
  - [ ] Тесты ролевого ценообразования с fallback-логикой.
  - [ ] Performance тесты для больших объемов данных (≥1000 товаров).

## Definition of Done

- [ ] Команда успешно импортирует тестовые данные товаров
- [ ] Все тесты проходят с покрытием ≥90% (критические модули ≥90% по [`docs/architecture/10-testing-strategy.md`](docs/architecture/10-testing-strategy.md))
- [ ] Логируются все операции импорта в `ImportSession`
- [ ] Код прошел code review
- [ ] Документация обновлена

## Testing Strategy

### Подход к тестированию

Тестирование импорта из 1С следует стратегии, описанной в [`docs/architecture/10-testing-strategy.md`](docs/architecture/10-testing-strategy.md):

- Unit-тесты для изолированных компонентов
- Интеграционные тесты для проверки взаимодействия
- Performance тесты для больших объемов данных

### Ключевые тестовые сценарии

#### 1. Unit-тесты для XMLDataParser

```python
# tests/unit/test_services/test_xml_parser.py
@pytest.mark.unit
class TestXMLDataParser:
    def test_parse_goods_xml_structure(self):
        """Проверка корректного парсинга структуры goods.xml"""
        
    def test_parse_prices_xml_with_role_mapping(self):
        """Проверка маппинга типов цен на роли пользователей"""
        
    def test_handle_malformed_xml_gracefully(self):
        """Проверка обработки некорректного XML"""
```

#### 2. Unit-тесты для ProductDataProcessor

```python
# tests/unit/test_services/test_product_processor.py
@pytest.mark.unit
class TestProductDataProcessor:
    def test_validate_unique_onec_id(self):
        """Проверка валидации уникальности onec_id"""
        
    def test_map_prices_to_user_roles(self):
        """Проверка маппинга цен на роли пользователей"""
        
    def test_federation_rep_fallback_to_retail(self):
        """Проверка fallback-логики для federation_rep"""
```

#### 3. Интеграционные тесты для команды load_catalog

```python
# tests/integration/test_management_commands/test_import_catalog_from_1c.py
@pytest.mark.django_db
@pytest.mark.integration
class TestImportCatalogCommand:
    def test_successful_import_with_test_data(self):
        """Проверка успешного импорта тестовых данных"""
        
    def test_import_creates_import_session_with_correct_status(self):
        """Проверка создания ImportSession с корректным статусом"""
        
    def test_import_logs_errors_to_import_session(self):
        """Проверка логирования ошибок в ImportSession"""
```

#### 4. Performance тесты

```python
# tests/performance/test_import_performance.py
@pytest.mark.django_db
@pytest.mark.slow
class TestImportPerformance:
    def test_import_1000_products_within_timeout(self):
        """Проверка импорта 1000 товаров в допустимое время"""
        
    def test_memory_usage_stable_during_large_import(self):
        """Проверка стабильного использования памяти при большом импорте"""
```

### Тестовые данные

Для тестирования использовать примеры XML файлов из `backend/tests/legacy/Обмен с сайтом/`:

- `propertiesOffers/propertiesOffers_1_1_6a1a8235-d7e8-41d9-9ba0-748c4d67d65e.xml`
- `rests/rests.xml`
- `units/units.xml`

### Требования к покрытию

- Общее покрытие: ≥70%
- Покрытие критических модулей: ≥90%
  - `apps.products.services.parser`
  - `apps.products.services.processor`
  - `apps.products.management.commands.import_catalog_from_1c`
  - `apps.products.models.ImportSession`

### Запуск тестов

```bash
# Запуск всех тестов импорта
pytest tests/unit/test_services/test_xml_parser.py tests/unit/test_services/test_product_processor.py tests/integration/test_management_commands/test_import_catalog_from_1c.py -v

# Запуск с покрытием
pytest --cov=apps.products.services --cov=apps.products.management.commands --cov-report=html

# Запуск performance тестов
pytest tests/performance/test_import_performance.py -v
```

## Разбиение на задачи

### Задача 1: Создание модели ImportSession (Приоритет: Высокий, 2 story points)

**Описание:** Создать модель ImportSession для отслеживания сессий импорта с полями import_type, status, started_at, finished_at, report_details, error_message.

**Файлы для изменения:**

- `backend/apps/products/models.py` - добавить модель ImportSession
- `backend/apps/products/migrations/XXXX_add_import_session.py` - создать миграцию

**Критерии приемки:**

- Модель создана со всеми полями и выборками
- Миграция создана и применена
- Написаны unit-тесты для модели

---

### Задача 2: Реализация XMLDataParser (Приоритет: Высокий, 3 story points)

**Описание:** Создать класс XMLDataParser для парсинга XML файлов от 1С (goods.xml, offers.xml, prices.xml, rests.xml).

**Файлы для изменения:**

- `backend/apps/products/services/parser.py` - создать класс XMLDataParser

**Критерии приемки:**

- Класс реализован с методами для парсинга всех типов XML
- Обрабатываются ошибки некорректной структуры XML
- Написаны unit-тесты с тестовыми данными из `backend/tests/legacy/Обмен с сайтом/`

---

### Задача 3: Реализация ProductDataProcessor (Приоритет: Высокий, 5 story points)

**Описание:** Создать класс ProductDataProcessor для обработки данных от парсера и сохранения в базу данных.

**Файлы для изменения:**

- `backend/apps/products/services/processor.py` - создать класс ProductDataProcessor

**Критерии приемки:**

- Класс реализован с методами валидации и сохранения данных
- Реализован маппинг типов цен на роли пользователей
- Реализована fallback-логика для federation_rep → retail/RRP
- Написаны unit-тесты

---

### Задача 4: Создание management-команды import_catalog_from_1c (Приоритет: Высокий, 3 story points)

**Описание:** Создать management-команду для импорта каталога из 1С с параметрами --file, --dry-run, --chunk-size.

**Файлы для изменения:**

- `backend/apps/products/management/commands/import_catalog_from_1c.py` - создать команду

**Критерии приемки:**

- Команда создана с необходимыми параметрами
- Команда создает и обновляет ImportSession
- Команда оркестрирует вызов XMLDataParser и ProductDataProcessor
- Написаны интеграционные тесты

---

### Задача 5: Тестирование системы импорта (Приоритет: Средний, 4 story points)

**Описание:** Написать comprehensive тесты для всей системы импорта.

**Файлы для изменения:**

- `tests/unit/test_services/test_xml_parser.py` - unit-тесты для парсера
- `tests/unit/test_services/test_product_processor.py` - unit-тесты для процессора
- `tests/integration/test_management_commands/test_import_catalog_from_1c.py` - интеграционные тесты
- `tests/performance/test_import_performance.py` - performance тесты

**Критерии приемки:**

- Все тесты проходят
- Покрытие кода ≥90% для критических модулей
- Performance тесты подтверждают обработку ≥1000 товаров

---

### Задача 6: Документирование и настройка окружения (Приоритет: Низкий, 1 story point)

**Описание:** Завершить документирование и настроить переменные окружения.

**Файлы для изменения:**

- `backend/.env.example` - добавить переменные окружения
- Обновить документацию при необходимости

**Критерии приемки:**

- Переменные окружения добавлены в .env.example
- Документация обновлена

### Предлагаемый порядок выполнения

1. Задача 1: Создание модели ImportSession
2. Задача 2: Реализация XMLDataParser
3. Задача 3: Реализация ProductDataProcessor
4. Задача 4: Создание management-команды
5. Задача 5: Тестирование системы импорта
6. Задача 6: Документирование и настройка окружения

## Dev Notes

### Story Context

**Epic Integration Points:**

- Интегрируется с: 1С:Управление торговлей
- Технология: Django Management Commands + XML/JSON parsing
- Следует паттерну: [`docs/prd/requirements.md#pricing`](docs/prd/requirements.md#pricing) (FREESPORT ролевое ценообразование)
- Точки касания: Product model, User roles, sync logging
- См. также: [`docs/architecture/tech-stack.md`](docs/architecture/tech-stack.md) (технологический стек)

### Technical Architecture

```python
# apps/products/models.py (дополнение)
class ImportSession(models.Model):
    class ImportType(models.TextChoices):
        CATALOG = 'catalog', 'Каталог товаров'
        STOCKS = 'stocks', 'Остатки товаров'
        PRICES = 'prices', 'Цены товаров'
    
    class ImportStatus(models.TextChoices):
        STARTED = 'started', 'Начато'
        COMPLETED = 'completed', 'Завершено'
        FAILED = 'failed', 'Ошибка'
    
    import_type = models.CharField(max_length=20, choices=ImportType.choices, default=ImportType.CATALOG)
    status = models.CharField(max_length=20, choices=ImportStatus.choices, default=ImportStatus.STARTED)
    started_at = models.DateTimeField(auto_now_add=True)
    finished_at = models.DateTimeField(null=True, blank=True)
    report_details = models.JSONField(default=dict, blank=True)
    error_message = models.TextField(blank=True)
    
    class Meta:
        ordering = ['-started_at']

# apps/products/services/parser.py
class XMLDataParser:
    def parse(self, file_path):
        # returns list[dict]
        pass

# apps/products/services/processor.py
class ProductDataProcessor:
    def __init__(self, session_id):
        self.session_id = session_id

    def process_data(self, data: list[dict]):
        # validation and db operations
        pass

# apps/products/management/commands/import_catalog_from_1c.py
class Command(BaseCommand):
    def handle(self, *args, **options):
        session = ImportSession.objects.create(import_type=ImportSession.ImportType.CATALOG)
        parser = XMLDataParser()
        processor = ProductDataProcessor(session.id)
        
        raw_data = parser.parse(options['file'])
        processor.process_data(raw_data)
        
        session.status = ImportSession.ImportStatus.COMPLETED
        session.save()
```

### Domain Concepts & Data Structure

#### 1С:Управление торговлей

**1С:Управление торговлей** - это ERP-система для управления торговой деятельностью, которая выгружает данные в формате CommerceML 3.1. Система предоставляет полную информацию о товарах, ценах, остатках и контрагентах.

#### Ролевое ценообразование FREESPORT

**Ролевое ценообразование** - это система маппинга типов цен из 1С на роли пользователей в FREESPORT. Каждый тип цены из 1С соответствует определенной роли пользователя в системе.

**Информация по типам цен (из `priceLists.xml`):**

`Опт 1` -> `wholesale_level1`
`Опт 2` -> `wholesale_level2`
`Опт 3` -> `wholesale_level3`
`Тренерская` -> `trainer`
`РРЦ` -> `retail` / `RRP`
`МРЦ` -> `MSRP`

**Внимание:** Тип цены для `federation_rep` не найден в данных 1С. Используется fallback-логика: `РРЦ` → `federation_rep`.

Для каждой роли в модели Product предусмотрены соответствующие поля цен.

#### Структура XML файлов от 1С

Данные из 1С поступают в формате CommerceML 3.1 и разделены по типам в разные файлы:

**Основные файлы:**

- `goods.xml` - основная информация о товарах (продуктах)
- `offers.xml` - торговые предложения (SKU), вариации товаров
- `prices.xml` - цены для каждого SKU
- `rests.xml` - остатки SKU на складах

**Структура goods.xml:**

```xml
<Каталог>
  <Товары>
    <Товар>
      <Ид>UUID-товара</Ид>
      <Артикул>Артикул товара</Артикул>
      <Наименование>Название товара</Наименование>
      <БазоваяЕдиница>Код единицы измерения</БазоваяЕдиница>
      <Группы>
        <Ид>UUID-категории</Ид>
      </Группы>
      <Описание>HTML-описание</Описание>
      <Картинка>путь/к/изображению.jpg</Картинка>
    </Товар>
  </Товары>
</Каталог>
```

**Структура prices.xml:**

```xml
<ПакетПредложений>
  <Предложения>
    <Предложение>
      <Ид>UUID-товара или SKU</Ид>
      <Цены>
        <Цена>
          <ИдТипаЦены>UUID-типа-цены</ИдТипаЦены>
          <ЦенаЗаЕдиницу>1000.00</ЦенаЗаЕдиницу>
          <Валюта>руб</Валюта>
        </Цена>
      </Цены>
    </Предложение>
  </Предложения>
</ПакетПредложений>
```

**Маппинг типов цен на роли пользователей:**

- UUID типа цены из `priceLists.xml` маппится на роль пользователя в системе FREESPORT
- Пример: "Опт 1 (300-600 тыс.руб в квартал)" → `wholesale`
- Fallback-логика: если цена для роли отсутствует, используется розничная цена

Подробное описание структуры данных см. в [`docs/epics/epic-3/data-analysis.md`](docs/epics/epic-3/data-analysis.md).

### Environment Variables

Для работы с импортом из 1С потребуются следующие переменные окружения:

```bash
# Пути к директориям с файлами 1С
ONEC_DATA_DIR=/path/to/1c/export/directory/
ONEC_BACKUP_DIR=/path/to/backup/directory/

# Настройки импорта
IMPORT_CHUNK_SIZE=1000
IMPORT_TIMEOUT=300
IMPORT_MAX_RETRIES=3

# Логирование
IMPORT_LOG_LEVEL=INFO
IMPORT_LOG_FILE=/var/log/import.log
```

### Dependencies

- **Blocks:** [`docs/stories/epic-3/3.1.2.loading-scripts.md`](docs/stories/epic-3/3.1.2.loading-scripts.md) (скрипты загрузки)
- **Depends on:** [`docs/stories/epic-1/1.8.database-design.md`](docs/stories/epic-1/1.8.database-design.md) (Database design)
- **Related:**
  - [`docs/architecture/source-tree.md`](docs/architecture/source-tree.md) (структура проекта)
  - [`docs/architecture/coding-standards.md`](docs/architecture/coding-standards.md) (стандарты кодирования Django)
  - [`docs/prd/requirements.md`](docs/prd/requirements.md) (требования к интеграции с 1С)

## Story Points

**13** (Complexity increased due to new architectural requirements)

## Priority

**High** - Критический путь для Epic 3

## Labels

`epic-3` `1c-integration` `product-management` `django-commands` `refactoring`

## Dev Agent Record

### Agent Model Used

James - Full Stack Developer (dev agent)

### Completion Notes

- ✅ **Task 3.1.1-A (AC: 3) ЗАВЕРШЕН**: Дополнены поля интеграции с 1С в Product модель
- ✅ Добавлены поля: `onec_id` (unique), `sync_status` (choices), `last_sync_at`, `error_message`
- ✅ Создана миграция `0009_add_1c_integration_fields`
- ✅ Добавлены индексы для оптимизации запросов по новым полям
- ✅ Написаны comprehensive unit тесты для всех новых полей
- ✅ Все тесты проходят успешно (10/10 passed)
- ✅ Нет регрессий в существующем функционале
- ✅ Исправлены некорректные пути к тестам в архитектурной документации

### File List

- backend/apps/products/models.py - добавлены 1С интеграционные поля
- backend/apps/products/migrations/0009_add_1c_integration_fields.py - миграция БД
- backend/tests/unit/test_models/test_product_models.py - добавлены тесты для новых полей
- docs/architecture/source-tree.md - исправлены пути к тестам
- docs/stories/2.5.product-detail-api.md - исправлены пути к тестам

### Change Log

- 2025-09-07: Task 3.1.1-A реализован James (dev agent)
  - Добавлены поля интеграции с 1С в Product модель
  - Создана миграция с индексами для производительности
  - Написаны unit тесты с покрытием всех edge cases
  - Исправлена документация по путям к тестам

## QA Results

### Review Date: 2025-09-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation of the `Product` model update is of high quality. The code is clean, follows project conventions, and includes appropriate database indexes for performance.

### Refactoring Performed

No refactoring was necessary as the code quality is high.

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✗] (Only a part of AC #1 is complete)

### Improvements Checklist

The following items represent the remaining work required to complete this story:

- [ ] Create the `ImportSession` model (AC #1)
- [ ] Implement the `XMLDataParser` and `ProductDataProcessor` (AC #2)
- [ ] Create the `load_catalog` management command (AC #3)
- [ ] Implement price mapping and fallback logic (AC #4)
- [ ] Create data validators for the processor (AC #5)
- [ ] Implement detailed logging into `ImportSession` (AC #6)
- [ ] Write integration tests for the complete workflow (AC #7)

### Security Review

No security implications were found in the current changes.

### Performance Considerations

Database indexes have been correctly added for the new fields, which satisfies performance considerations for this change.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/3.1.1-import-products-structure.yml

### Recommended Status

[✗ Changes Required - See unchecked items above]
