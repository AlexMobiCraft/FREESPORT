# Story 3.3.1: customer-identity-algorithms

## Status

Ready for Development

## Story

**As a** система интеграции с 1С,
**I want** детерминированно идентифицировать клиентов между порталом и 1С по уникальным идентификаторам,
**so that** обеспечить целостность данных и избежать дубликатов при синхронизации.

## Acceptance Criteria

1. Создан класс `CustomerIdentityResolver` с детерминированной логикой идентификации
2. Реализована идентификация B2B клиентов по ИНН (tax_id)
3. Реализована идентификация B2C клиентов по email
4. Реализован поиск по onec_id/onec_guid для уже синхронизированных клиентов
5. Настроена нормализация идентификаторов (email, ИНН)
6. Логирование всех попыток идентификации с результатами
7. Написаны тесты для всех сценариев идентификации

### Детальные задачи

- [ ] **Создать CustomerIdentityResolver (AC: 1)**
  - [ ] Класс в `apps/users/services/identity_resolution.py`
  - [ ] Метод `identify_customer(onec_customer_data)` - главный метод идентификации
  - [ ] Детерминированная логика без fuzzy matching
  - [ ] Логирование каждой попытки идентификации

- [ ] **Реализовать идентификацию по onec_id/onec_guid (AC: 4)**
  - [ ] **Приоритет 1:** поиск по `onec_id` (100% точность)
  - [ ] **Приоритет 2:** поиск по `onec_guid` (100% точность)
  - [ ] Если найдено - возвращаем клиента, пропускаем остальные проверки

- [ ] **Реализовать идентификацию B2B клиентов (AC: 2)**
  - [ ] **Приоритет 3:** поиск по `tax_id` (ИНН)
  - [ ] Нормализация ИНН: убрать пробелы, дефисы
  - [ ] Проверка корректности формата ИНН (10 или 12 цифр)
  - [ ] Если найдено - возвращаем клиента, это B2B

- [ ] **Реализовать идентификацию B2C клиентов (AC: 3)**
  - [ ] **Приоритет 4:** поиск по `email`
  - [ ] Нормализация email: lowercase, trim whitespace
  - [ ] Точное совпадение (без fuzzy matching)
  - [ ] Если найдено - возвращаем клиента, это B2C

- [ ] **Настроить нормализацию идентификаторов (AC: 5)**
  - [ ] Метод `normalize_inn(inn)` - нормализация ИНН
  - [ ] Метод `normalize_email(email)` - нормализация email
  - [ ] Валидация форматов идентификаторов
  - [ ] Обработка NULL/пустых значений

- [ ] **Настроить логирование (AC: 6)**
  - [ ] Логирование в CustomerSyncLog для каждой попытки
  - [ ] Запись использованного метода идентификации
  - [ ] Запись результата (найден/не найден)
  - [ ] Запись времени выполнения

## Definition of Done

- [ ] 100% точность идентификации по onec_id/onec_guid
- [ ] 100% точность идентификации B2B по ИНН
- [ ] 100% точность идентификации B2C по email
- [ ] 0% false positive rate (детерминированная логика)
- [ ] Время обработки 1000 клиентов <10 секунд
- [ ] Покрытие тестами ≥90%
- [ ] Все попытки идентификации залогированы

## Dev Notes

### Algorithm Architecture

**Принцип:** Детерминированная идентификация по уникальным идентификаторам с четкими приоритетами.

```python
class CustomerIdentityResolver:
    """Сервис детерминированной идентификации клиентов между порталом и 1С"""
    
    IDENTIFICATION_METHODS = [
        'onec_id',      # Приоритет 1: точное совпадение ID из 1С
        'onec_guid',    # Приоритет 2: точное совпадение GUID из 1С
        'tax_id',       # Приоритет 3: ИНН для B2B клиентов
        'email',        # Приоритет 4: email для B2C клиентов
    ]
    
    def identify_customer(self, onec_customer_data):
        """
        Главный метод идентификации клиента.
        
        Args:
            onec_customer_data (dict): Данные клиента из 1С
            
        Returns:
            tuple: (User|None, str|None) - найденный клиент и метод идентификации
        """
        # Приоритет 1: Поиск по onec_id
        if onec_id := onec_customer_data.get('onec_id'):
            customer = self._find_by_onec_id(onec_id)
            if customer:
                self._log_identification('onec_id', customer, onec_customer_data)
                return customer, 'onec_id'
        
        # Приоритет 2: Поиск по onec_guid
        if onec_guid := onec_customer_data.get('onec_guid'):
            customer = self._find_by_onec_guid(onec_guid)
            if customer:
                self._log_identification('onec_guid', customer, onec_customer_data)
                return customer, 'onec_guid'
        
        # Приоритет 3: Поиск B2B по ИНН
        if tax_id := onec_customer_data.get('tax_id'):
            normalized_inn = self.normalize_inn(tax_id)
            if normalized_inn and self._validate_inn(normalized_inn):
                customer = self._find_by_tax_id(normalized_inn)
                if customer:
                    self._log_identification('tax_id', customer, onec_customer_data)
                    return customer, 'tax_id'
        
        # Приоритет 4: Поиск B2C по email
        if email := onec_customer_data.get('email'):
            normalized_email = self.normalize_email(email)
            if normalized_email:
                customer = self._find_by_email(normalized_email)
                if customer:
                    self._log_identification('email', customer, onec_customer_data)
                    return customer, 'email'
        
        # Клиент не найден
        self._log_identification('not_found', None, onec_customer_data)
        return None, None
    
    def _find_by_onec_id(self, onec_id):
        """Точный поиск по onec_id"""
        try:
            return User.objects.get(onec_id=onec_id)
        except User.DoesNotExist:
            return None
    
    def _find_by_onec_guid(self, onec_guid):
        """Точный поиск по onec_guid"""
        try:
            return User.objects.get(onec_guid=onec_guid)
        except User.DoesNotExist:
            return None
    
    def _find_by_tax_id(self, tax_id):
        """Точный поиск по ИНН (B2B клиенты)"""
        try:
            return User.objects.get(tax_id=tax_id)
        except User.DoesNotExist:
            return None
    
    def _find_by_email(self, email):
        """Точный поиск по email (B2C клиенты)"""
        try:
            return User.objects.get(email=email)
        except User.DoesNotExist:
            return None

### Normalization Methods

```python
def normalize_inn(self, inn):
    """Нормализация ИНН"""
    if not inn:
        return None
    
    # Убираем все нецифровые символы
    digits_only = re.sub(r'[^\d]', '', str(inn))
    
    # ИНН должен быть 10 или 12 цифр
    if len(digits_only) not in [10, 12]:
        logger.warning(f"Invalid INN format: {inn}")
        return None
    
    return digits_only

def _validate_inn(self, inn):
    """Валидация формата ИНН"""
    if not inn:
        return False
    
    # Базовая проверка: только цифры и корректная длина
    if not inn.isdigit() or len(inn) not in [10, 12]:
        return False
    
    return True

def normalize_email(self, email):
    """Нормализация email"""
    if not email:
        return None
    
    # Приводим к lowercase и удаляем пробелы
    normalized = email.strip().lower()
    
    # Базовая валидация формата
    if '@' not in normalized or '.' not in normalized.split('@')[1]:
        logger.warning(f"Invalid email format: {email}")
        return None
    
    return normalized

### Logging Methods

```python
def _log_identification(self, method, customer, onec_data):
    """Логирование попытки идентификации"""
    from apps.common.models import CustomerSyncLog
    
    CustomerSyncLog.objects.create(
        operation_type='identify_customer',
        customer=customer,
        status='success' if customer else 'not_found',
        details={
            'identification_method': method,
            'onec_id': onec_data.get('onec_id'),
            'onec_guid': str(onec_data.get('onec_guid')) if onec_data.get('onec_guid') else None,
            'tax_id': onec_data.get('tax_id'),
            'email': onec_data.get('email'),
        },
        processed_by='CustomerIdentityResolver'
    )

### Integration with CustomerDataProcessor

```python
# В CustomerDataProcessor из Story 3.2.1
from apps.users.services.identity_resolution import CustomerIdentityResolver

class CustomerDataProcessor:
    def __init__(self):
        self.identity_resolver = CustomerIdentityResolver()
    
    def process_customer(self, onec_customer_data):
        """Обработка одного клиента из 1С"""
        # Используем CustomerIdentityResolver для поиска
        existing_customer, method = self.identity_resolver.identify_customer(onec_customer_data)
        
        if existing_customer:
            # Клиент найден - обогащаем данными из 1С (Story 3.2.2)
            return self._update_existing_customer(existing_customer, onec_customer_data, method)
        else:
            # Клиент не найден - создаем нового
            return self._create_new_customer(onec_customer_data)

## Story Points
**5** (Medium complexity - deterministic logic with clear priorities)

## Priority
**High** - Критично для качества синхронизации

## Labels
`epic-3` `identity-resolution` `deterministic-logic` `customer-sync`