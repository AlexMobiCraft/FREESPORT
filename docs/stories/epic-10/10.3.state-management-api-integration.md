# Story 10.3: State Management and API Integration

## Status
Draft

## Story
**As a** frontend developer,  
**I want** a reliable state management system and API client with proper error handling,  
**so that** I can efficiently manage application state and communicate with the backend API.

## Acceptance Criteria
1. Zustand stores работают корректно и управляют состоянием
2. API клиент автоматически добавляет JWT токены
3. Обработка ошибки 401 с автоматическим обновлением токена
4. TypeScript типы сгенерированы для всех API endpoints
5. Все сервисные функции реализованы и протестированы
6. Unit-тесты с MSW моками покрывают 80%+ кода
7. Retry логика работает для сетевых ошибок

## Tasks / Subtasks

- [ ] **Task 1: Настроить Zustand stores** (AC: 1)
  - [ ] Установить Zustand: `npm install zustand`
  - [ ] Создать `src/stores/authStore.ts` с методами login, logout, refresh
  - [ ] Создать `src/stores/cartStore.ts` с методами addItem, removeItem, updateQuantity
  - [ ] Добавить TypeScript типы для stores
  - [ ] Настроить DevTools интеграцию для отладки
  - [ ] Написать unit-тесты для authStore и cartStore

- [ ] **Task 2: Создать централизованный axios клиент** (AC: 2, 3, 7)
  - [ ] Установить axios: `npm install axios`
  - [ ] Создать `src/services/api-client.ts` с базовой конфигурацией
  - [ ] Добавить request interceptor для автоматического добавления JWT
  - [ ] Добавить response interceptor для обработки ошибки 401
  - [ ] Реализовать логику refresh token
  - [ ] Добавить retry логику для сетевых ошибок (3 попытки)
  - [ ] Добавить обработку timeout (30 секунд)
  - [ ] Написать unit-тесты для api-client

- [ ] **Task 3: Сгенерировать TypeScript типы из api-spec.yaml** (AC: 4)
  - [ ] Установить openapi-typescript: `npm install -D openapi-typescript`
  - [ ] Создать скрипт генерации типов в `package.json`
  - [ ] Сгенерировать типы: `npm run generate:types`
  - [ ] Создать `src/types/api.ts` с экспортом типов
  - [ ] Проверить что типы корректно генерируются

- [ ] **Task 4: Реализовать authService** (AC: 5, 6)
  - [ ] Создать `src/services/authService.ts`
  - [ ] Реализовать `login(email, password)` метод
  - [ ] Реализовать `register(userData)` метод
  - [ ] Реализовать `logout()` метод
  - [ ] Реализовать `refreshToken()` метод
  - [ ] Написать unit-тесты с MSW моками

- [ ] **Task 5: Реализовать productsService** (AC: 5, 6)
  - [ ] Создать `src/services/productsService.ts`
  - [ ] Реализовать `getAll(params)` метод с пагинацией
  - [ ] Реализовать `getById(id)` метод
  - [ ] Реализовать `search(query)` метод
  - [ ] Реализовать `filter(filters)` метод
  - [ ] Написать unit-тесты с MSW моками

- [ ] **Task 6: Реализовать categoriesService** (AC: 5, 6)
  - [ ] Создать `src/services/categoriesService.ts`
  - [ ] Реализовать `getAll()` метод
  - [ ] Реализовать `getTree()` метод для иерархии категорий
  - [ ] Написать unit-тесты с MSW моками

- [ ] **Task 7: Реализовать cartService** (AC: 5, 6)
  - [ ] Создать `src/services/cartService.ts`
  - [ ] Реализовать `get()` метод
  - [ ] Реализовать `add(productId, quantity)` метод
  - [ ] Реализовать `update(itemId, quantity)` метод
  - [ ] Реализовать `remove(itemId)` метод
  - [ ] Реализовать `applyPromo(code)` метод
  - [ ] Написать unit-тесты с MSW моками

- [ ] **Task 8: Реализовать ordersService** (AC: 5, 6)
  - [ ] Создать `src/services/ordersService.ts`
  - [ ] Реализовать `create(orderData)` метод
  - [ ] Реализовать `getAll(params)` метод с пагинацией
  - [ ] Реализовать `getById(id)` метод
  - [ ] Написать unit-тесты с MSW моками

- [ ] **Task 9: Настроить MSW для тестирования** (AC: 6)
  - [ ] Установить MSW: `npm install -D msw`
  - [ ] Создать `src/__mocks__/handlers.ts` с mock handlers
  - [ ] Создать `src/__mocks__/server.ts` для Node.js окружения
  - [ ] Настроить MSW в `jest.setup.js`
  - [ ] Создать mock данные для всех API endpoints

- [ ] **Task 10: Проверить покрытие тестами** (AC: 6)
  - [ ] Запустить `npm run test:coverage`
  - [ ] Убедиться что покрытие 80%+ для stores
  - [ ] Убедиться что покрытие 80%+ для services
  - [ ] Исправить недостающие тесты если нужно

## Dev Notes

### Previous Story Insights
Story 10.2 реализовала UI Kit компоненты. Теперь нужно создать слой для управления состоянием и взаимодействия с API.

### Tech Stack
[Source: architecture/tech-stack.md#state-management]

**State Management:** Zustand 4.5.7 - легковесное решение
**HTTP Client:** Axios 1.11.0 - HTTP клиент для API запросов

### Zustand Store Architecture
[Source: architecture/coding-standards.md#zustand-store]

См. примеры кода authStore и cartStore в документации по архитектуре.

### API Client Configuration
[Source: architecture/tech-stack.md#http-client]

Централизованный axios клиент с interceptors для JWT и retry логикой.

### Service Layer Implementation
[Source: docs/api-spec.yaml]

Реализовать сервисы: authService, productsService, categoriesService, cartService, ordersService.

### MSW Mock Configuration
[Source: frontend/docs/testing-standards.md#msw-mock-strategy]

Настроить MSW для unit-тестов с mock handlers.

### Testing
[Source: frontend/docs/testing-standards.md]

Unit-тесты для stores и services с покрытием 80%+.

### Project Structure
[Source: architecture/source-tree.md#frontend]

```
frontend/src/
├── stores/
│   ├── authStore.ts
│   ├── cartStore.ts
│   └── __tests__/
├── services/
│   ├── api-client.ts
│   ├── authService.ts
│   ├── productsService.ts
│   ├── categoriesService.ts
│   ├── cartService.ts
│   ├── ordersService.ts
│   └── __tests__/
├── types/
│   └── api.ts
└── __mocks__/
    ├── handlers.ts
    └── server.ts
```

## Change Log
| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-11-15 | 1.0     | Initial story creation               | Bob (SM)      |

## Dev Agent Record
_This section will be populated by the development agent during implementation._

## QA Results
_This section will be populated by QA Agent after story completion._
