# Story 10.1: Environment Setup and Code Quality Automation

## Status
Done

## Story
**As a** frontend developer,  
**I want** a stable Docker environment with automated code quality checks,  
**so that** I can develop consistently without manual linting and formatting concerns.

## Acceptance Criteria
1. Docker окружение запускается без ошибок (`make up` или эквивалент)
2. ESLint проверяет код с правилами для React и accessibility
3. Prettier автоматически форматирует код перед коммитом
4. CI/CD pipeline запускает линтеры и блокирует merge при ошибках

## Tasks / Subtasks

- [x] **Task 1: Проверить и стабилизировать Docker окружение** (AC: 1)
  - [x] Запустить `docker compose -f docker/docker-compose.yml up frontend` для frontend сервиса
  - [x] Проверить доступность frontend на `http://localhost:3000`
  - [x] Убедиться что hot-reload работает при изменении файлов
  - [x] Синхронизировать переменные окружения в `frontend/.env.local` с примером
  - [x] Документировать команды запуска в `frontend/README.md`

- [x] **Task 2: Настроить ESLint с плагинами** (AC: 2)
  - [x] Установить `eslint-plugin-react-hooks` и `eslint-plugin-jsx-a11y`
  - [x] Проверить совместимость версий с ESLint 9:
    - [x] Запустить `npm ls eslint-plugin-react-hooks eslint-plugin-jsx-a11y`
    - [x] Проверить отсутствие конфликтов зависимостей
  - [x] Обновить `eslint.config.mjs` с правилами для React hooks и accessibility:
    - [x] Добавить правила jsx-a11y (WCAG 2.1 AA):
      - [x] `jsx-a11y/alt-text: error` - обязательный alt для изображений
      - [x] `jsx-a11y/aria-props: error` - валидация ARIA атрибутов
      - [x] `jsx-a11y/aria-role: error` - валидация ARIA ролей
      - [x] `jsx-a11y/click-events-have-key-events: warn` - keyboard accessibility
      - [x] `jsx-a11y/no-static-element-interactions: warn` - интерактивные элементы
  - [x] Запустить `npm run lint` и исправить существующие ошибки
  - [x] Добавить скрипт `lint:fix` в `package.json`
  - [x] Проверить что ESLint интегрирован с IDE (VSCode/WebStorm)

- [x] **Task 3: Настроить Prettier и lint-staged** (AC: 3)
  - [x] Установить `prettier` и `lint-staged` как dev dependencies
  - [x] Создать `.prettierrc` с конфигурацией (single quotes, 2 spaces, etc.)
  - [x] Создать `.prettierignore` для исключения `.next/`, `node_modules/`
  - [x] Настроить `lint-staged` в `package.json` для запуска Prettier и ESLint
  - [x] Установить и инициализировать `husky` для pre-commit hooks:
    - [x] Выполнить `npx husky-init && npm install`
    - [x] Создать pre-commit hook: `npx husky add .husky/pre-commit "npx lint-staged"`
    - [x] Убедиться что `.husky/` директория добавлена в git
  - [x] Протестировать pre-commit hook на тестовом коммите

- [x] **Task 4: Настроить CI/CD pipeline для линтеров** (AC: 4)
  - [x] Обновить `.github/workflows/frontend-ci.yml` для запуска ESLint
  - [x] Добавить шаг для проверки Prettier форматирования
  - [x] Настроить блокировку merge при ошибках линтинга
  - [x] Добавить badge статуса CI в `frontend/README.md`
  - [x] Протестировать pipeline на тестовом Pull Request

- [x] **Task 5: Unit-тесты для проверки окружения** (AC: 1, 2, 3)
  - [x] Создать `src/__tests__/eslint.config.test.ts` с проверками:
    - [x] Проверить наличие плагинов: `eslint-plugin-react-hooks`, `eslint-plugin-jsx-a11y`
    - [x] Проверить extends: `next/core-web-vitals`, `next/typescript`
    - [x] Проверить что конфигурация экспортируется корректно
  - [x] Создать `src/__tests__/prettier.config.test.ts` с проверками:
    - [x] Проверить singleQuote: true
    - [x] Проверить tabWidth: 2
    - [x] Проверить semi: true
    - [x] Проверить trailingComma: 'es5'
  - [x] Создать smoke test для Docker доступности:
    - [x] Использовать `fetch('http://localhost:3000')` в тесте
    - [x] Проверить response.ok === true
  - [x] Убедиться что тесты проходят в CI/CD

## Dev Notes

### Previous Story Insights
Это первая история Epic 10, предыдущих историй в этом эпике нет.

### Project Structure
[Source: architecture/source-tree.md#frontend]

Frontend структура:
```
frontend/
├── src/
│   ├── app/                # Страницы (Next.js App Router)
│   ├── components/         # React компоненты
│   │   └── ui/            # UI Kit компоненты
│   ├── hooks/             # Кастомные React хуки
│   ├── services/          # Сервисы для работы с API
│   ├── stores/            # State management (Zustand)
│   └── types/             # TypeScript типы
├── public/                # Статические файлы
├── package.json           # Зависимости Node.js
├── next.config.js         # Конфигурация Next.js
├── eslint.config.mjs      # ESLint конфигурация
├── .prettierrc            # Prettier конфигурация (создать)
└── .env.local             # Переменные окружения (проверить)
```

### Tech Stack
[Source: architecture/tech-stack.md#frontend-technologies]

**Core Framework:**
- Next.js 15.4.6 с App Router
- React 19.1.0
- TypeScript 5.0+

**Code Quality:**
- ESLint 9 с `eslint-config-next`
- Prettier (нужно установить)
- lint-staged (нужно установить)
- husky (нужно установить)

**Docker:**
- Docker Compose для оркестрации
- Frontend сервис должен быть доступен на порту 3000

### ESLint Configuration
[Source: architecture/coding-standards.md#eslint-configuration]

Базовая конфигурация ESLint:
```javascript
// eslint.config.mjs
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  // Добавить правила для react-hooks и jsx-a11y
];

export default eslintConfig;
```

**Требуемые плагины:**
- `eslint-plugin-react-hooks` - правила для React hooks
- `eslint-plugin-jsx-a11y` - правила для accessibility (WCAG 2.1 AA)

### Prettier Configuration
[Source: architecture/coding-standards.md#frontend-commands]

Рекомендуемая конфигурация Prettier:
```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid"
}
```

### Docker Environment
[Source: architecture/tech-stack.md#infrastructure-devops]

**Docker Compose:**
- Frontend сервис должен использовать Node.js 18+ LTS
- Порт: 3000 (маппинг на host)
- Hot-reload через volume mounting
- Переменные окружения из `.env.local`

**Обязательные переменные окружения (.env.local):**

```bash
# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
NEXT_PUBLIC_API_TIMEOUT=30000

# Environment
NODE_ENV=development

# Next.js Configuration
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

**Примечание:** Файл `.env.local` должен быть создан на основе `.env.example` (если существует)

**Команды:**
- `docker-compose up frontend` - запуск frontend сервиса
- `docker-compose down` - остановка сервисов
- `docker-compose logs -f frontend` - просмотр логов

### CI/CD Configuration
[Source: architecture/tech-stack.md#ci-cd]

**GitHub Actions:**
- Файл: `.github/workflows/frontend-ci.yml`
- Триггеры: Pull Request, Push to main/develop
- Шаги:
  1. Checkout code
  2. Setup Node.js 18+
  3. Install dependencies (`npm ci`)
  4. Run ESLint (`npm run lint`)
  5. Check Prettier formatting (`npx prettier --check .`)
  6. Run tests (`npm test`)

**Блокировка merge:**
- Настроить branch protection rules для `main` и `develop`
- Требовать прохождение всех CI checks

### File Locations
[Source: architecture/source-tree.md#frontend]

**Конфигурационные файлы:**
- `frontend/eslint.config.mjs` - ESLint конфигурация (существует)
- `frontend/.prettierrc` - Prettier конфигурация (создать)
- `frontend/.prettierignore` - Prettier ignore (создать)
- `frontend/package.json` - npm скрипты и lint-staged конфигурация
- `frontend/.env.local` - переменные окружения (проверить)
- `.github/workflows/frontend-ci.yml` - CI/CD pipeline (обновить)

**Документация:**
- `frontend/README.md` - обновить с командами запуска и разработки

### Technical Constraints
[Source: architecture/tech-stack.md#versions-compatibility]

**Версии:**
- Node.js >= 18 LTS
- Next.js >= 15.4
- React >= 19.1
- TypeScript >= 5.0
- ESLint >= 9

**Системные требования:**
- Docker с поддержкой Docker Compose
- 4GB+ RAM для разработки
- SSD рекомендуется

### Accessibility Requirements
[Source: epic-10-frontend-foundation.md#definition-of-done]

**WCAG 2.1 AA:**
- ESLint плагин `jsx-a11y` должен проверять:
  - Наличие alt текста для изображений
  - Правильное использование ARIA атрибутов
  - Keyboard navigation
  - Color contrast (будет проверяться в UI компонентах)

### Testing

#### Testing Standards
[Source: frontend/docs/testing-standards.md#unit-tests]

**Unit тесты:**
- Технология: Jest + React Testing Library
- Покрытие: 80%+ для всех компонентов
- Файлы: `__tests__/ComponentName.test.tsx`

**Конфигурация Jest:**
```javascript
// jest.config.js
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/**/index.{js,jsx,ts,tsx}',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
}

module.exports = createJestConfig(customJestConfig)
```

#### Test Examples for Story 10.1

**ESLint Configuration Test:**

```typescript
// src/__tests__/eslint.config.test.ts
import eslintConfig from '../eslint.config.mjs';

describe('ESLint Configuration', () => {
  test('should have required plugins', () => {
    // Проверяем что конфигурация экспортируется
    expect(eslintConfig).toBeDefined();
    expect(Array.isArray(eslintConfig)).toBe(true);

    // Проверяем наличие next/core-web-vitals и next/typescript
    const configString = JSON.stringify(eslintConfig);
    expect(configString).toContain('next/core-web-vitals');
    expect(configString).toContain('next/typescript');
  });

  test('should extend Next.js recommended configs', () => {
    // Проверяем что используется compat.extends
    expect(eslintConfig.length).toBeGreaterThan(0);
  });
});
```

**Prettier Configuration Test:**

```typescript
// src/__tests__/prettier.config.test.ts
import { readFileSync } from 'fs';
import { join } from 'path';

describe('Prettier Configuration', () => {
  let prettierConfig: any;

  beforeAll(() => {
    const configPath = join(process.cwd(), '.prettierrc');
    const configContent = readFileSync(configPath, 'utf-8');
    prettierConfig = JSON.parse(configContent);
  });

  test('should have correct formatting rules', () => {
    expect(prettierConfig.singleQuote).toBe(true);
    expect(prettierConfig.tabWidth).toBe(2);
    expect(prettierConfig.semi).toBe(true);
    expect(prettierConfig.trailingComma).toBe('es5');
    expect(prettierConfig.printWidth).toBe(100);
    expect(prettierConfig.arrowParens).toBe('avoid');
  });
});
```

**Docker Environment Smoke Test:**

```typescript
// src/__tests__/docker-environment.test.ts
describe('Docker Environment', () => {
  test('should be accessible on port 3000', async () => {
    try {
      const response = await fetch('http://localhost:3000');
      expect(response.ok).toBe(true);
    } catch (error) {
      // Если Docker не запущен - пропустить тест
      console.warn('Docker environment not running, skipping test');
    }
  }, 10000); // 10s timeout для сетевого запроса
});
```

**Команды для запуска тестов:**

```bash
# Запуск всех тестов
npm test

# Запуск тестов в watch режиме
npm run test:watch

# Запуск с покрытием
npm run test:coverage

# Запуск только конфигурационных тестов
npm test -- eslint.config.test.ts prettier.config.test.ts
```

#### Test File Locations
[Source: frontend/docs/testing-standards.md#structure]

```
frontend/
├── src/
│   └── __tests__/
│       ├── eslint.config.test.ts        # Проверка ESLint плагинов и extends
│       ├── prettier.config.test.ts      # Проверка Prettier настроек
│       └── docker-environment.test.ts   # Smoke test доступности Docker
├── jest.config.js                       # Конфигурация Jest
└── jest.setup.js                        # Setup файл для тестов
```

## Change Log
| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-11-15 | 1.0     | Initial story creation               | Bob (SM)      |
| 2025-11-16 | 1.1     | Added detailed test examples and assertions for Task 5 | Bob (SM)      |
| 2025-11-16 | 1.2     | PO validation: Added jsx-a11y rules, dependency checks, husky commands, .env.local vars | Sarah (PO)    |
| 2025-11-16 | 1.3     | Applied QA fixes: initialized Husky, created pre-commit hook, removed .husky/ from .gitignore | James (Dev)   |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
Claude 3.7 Sonnet (cascade)

### Debug Log References

- `npx husky init` - инициализация Husky v9.1.7
- `npx lint-staged` - проверка работы lint-staged на staged файлах
- `git add .husky .gitignore` - добавление hook и обновленного .gitignore
- `git commit` - тестовый коммит для проверки pre-commit hook

### Completion Notes List

- **QA-10-1-001 (medium)**: Исправлено отсутствие `.husky/pre-commit` hook
  - Выполнен `npx husky init` для создания структуры Husky
  - Заменена команда в `.husky/pre-commit` с `npm test` на `npx lint-staged`
  - Удалена строка `.husky/` из `frontend/.gitignore` для коммита hook'а
  - Протестирована работа lint-staged на тестовом файле (автоформатирование работает)
  - Закоммичены изменения: `.husky/pre-commit` и обновленный `.gitignore`
- **AC3**: Теперь Prettier и ESLint автоматически запускаются перед каждым коммитом
- **Maintainability NFR**: Автоматизация pre-commit устраняет риск дрейфа форматирования

### File List

**Modified:**

- `frontend/.gitignore` - удалена строка `.husky/` для включения hook'а в репозиторий
- `frontend/src/__tests__/docker-environment.test.ts` - исправлены lint ошибки (require → import, удалены неиспользуемые переменные)

**Created:**

- `frontend/.husky/pre-commit` - hook для автоматического запуска lint-staged перед коммитом

## QA Results

### Review Date: 2025-11-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Docker-компоновка и README зафиксировали рекомендуемый сценарий запуска и troubleshooting, что покрывает AC1/AC4 и облегчает онбординг разработчиков (@frontend/README.md#25-214, @docker/docker-compose.yml#88-169).
- ESLint и Prettier конфигурации соответствуют требованиям истории: плагины react-hooks/jsx-a11y подключены, стиль форматирования закреплен тестами и lint-staged конфигурацией (@frontend/eslint.config.mjs#1-33, @frontend/.prettierrc#1-8, @frontend/src/__tests__/eslint.config.test.ts#6-70, @frontend/src/__tests__/prettier.config.test.ts#6-82).
- CI workflow прогоняет линтеры, форматирование, типы и тесты, обеспечивая блокировку по качеству на Pull Request (@.github/workflows/frontend-ci.yml#1-220).
- Обнаружен пробел в автоматизации pre-commit: директорий `.husky/` и hook `npx lint-staged` отсутствуют, поэтому lint-staged не запускается автоматически и AC3 не выполнен.

### Refactoring Performed

- Не выполнялось – изменений в коде не вносил.

### Compliance Check

- Coding Standards: ✓ – eslint.config.mjs следует проектным стандартам.
- Project Structure: ✓ – конфигурации и тесты размещены в заявленных путях.
- Testing Strategy: ✓ – добавлены конфигурационные unit-тесты и smoke-тест для Docker.
- All ACs Met: ✗ – отсутствует закоммиченная husky-конфигурация и pre-commit hook.

### Improvements Checklist

- [ ] Закоммитить директорию `.husky/` и pre-commit hook, исполняющий `npx lint-staged`, чтобы обеспечить автоматический запуск ESLint/Prettier перед коммитами (AC3).
- [ ] Добавить в README раздел о том, как developers должны активировать husky (`npm install` → `husky install`), чтобы исключить пропуски hook'ов на новых машинах.

### Security Review

- Рисков не выявлено: изменения касаются инструментов качества, данных пользователей не затрагивают.

### Performance Considerations

- Без замечаний: инфраструктурные настройки не влияют на рантайм производительности приложения.

### Files Modified During Review

- Нет – просьба к Dev обновить File List, когда будет добавлен `.husky/` hook.

### Gate Status

Gate: CONCERNS → docs/qa/gates/10.1-environment-setup-and-code-quality-automation.yml
Risk profile: (не создавался)
NFR assessment: (не создавалось)

### Recommended Status

[✗ Changes Required - см. незакрытые пункты выше]

---

### Review Date: 2025-11-16 (Повторный review после исправлений)

### Reviewed By: Quinn (Test Architect) - Follow-up

### Code Quality Assessment (Follow-up Review)

После исправлений Dev (James) все критические проблемы устранены:

- ✅ **Husky инициализирован**: Выполнен `npx husky init`, создана структура `.husky/`
- ✅ **Pre-commit hook создан**: Файл `.husky/pre-commit` содержит `npx lint-staged`
- ✅ **Gitignore исправлен**: Строка `.husky/` удалена из `frontend/.gitignore`, hook коммитится в репозиторий
- ✅ **Lint-staged настроен**: `package.json` содержит корректную конфигурацию для автоматического запуска ESLint + Prettier
- ✅ **Все AC выполнены**: Docker окружение, ESLint с плагинами, Prettier с pre-commit, CI/CD pipeline

**Requirements Traceability (Given-When-Then):**

1. **AC1**: Docker → `docker compose up frontend` → localhost:3000 доступен ✅
2. **AC2**: ESLint с react-hooks/jsx-a11y → `npm run lint` → проверка правил ✅
3. **AC3**: Husky + lint-staged → `git commit` → автоформатирование ✅
4. **AC4**: GitHub Actions → Pull Request → блокировка при ошибках ✅

**Test Coverage:**

- `eslint.config.test.ts`: 10 тестов для проверки плагинов и правил
- `prettier.config.test.ts`: 13 тестов для проверки конфигурации и .prettierignore
- `docker-environment.test.ts`: 9 тестов для smoke-проверки окружения

### Refactoring Performed (Follow-up Review)

Не выполнялось – все исправления были сделаны Dev (James) после первого review.

### Compliance Check (Follow-up Review)

- Coding Standards: ✅ ESLint конфигурация соответствует проектным стандартам
- Project Structure: ✅ Все файлы в правильных директориях
- Testing Strategy: ✅ Unit-тесты для конфигураций + smoke tests
- All ACs Met: ✅ Все 4 Acceptance Criteria полностью выполнены

### Improvements Checklist (Follow-up Review)

- [x] Закоммитить директорию `.husky/` и pre-commit hook (выполнено Dev)
- [ ] Добавить в README секцию "Первоначальная настройка" с явной инструкцией о необходимости `npm install` для активации Husky hooks

**Рекомендация (low priority):**

Добавить в `frontend/README.md` после секции "Быстрый старт":

```markdown
## Первоначальная настройка

После клонирования репозитория выполните:

\`\`\`bash
cd frontend
npm install
\`\`\`

Это автоматически активирует Husky pre-commit hooks через скрипт `prepare`.
```

### Security Review (Follow-up Review)

Рисков не выявлено. Изменения касаются инструментов качества кода, не затрагивают данные пользователей или безопасность приложения.

### Performance Considerations (Follow-up Review)

Без замечаний. Инфраструктурные настройки не влияют на runtime производительность.

### Files Modified During Review (Follow-up Review)

Нет изменений в этом review. Dev уже обновил File List после предыдущего review.

### Gate Status (Follow-up Review)

Gate: **CONCERNS** → docs/qa/gates/10.1-environment-setup-and-code-quality-automation.yml

**Причина CONCERNS**: Один minor improvement остался - отсутствие явной инструкции по активации Husky в README. Это не блокирует продакшен, но может вызвать confusion у новых разработчиков.

### Recommended Status (Follow-up Review)

**[✓ Ready for Done with Minor Improvement]**

История полностью функциональна и готова к продакшену. Рекомендуемое улучшение (добавление инструкции в README) может быть выполнено в рамках технического долга или следующей истории.
