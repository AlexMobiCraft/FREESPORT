# Story 10.1: Environment Setup and Code Quality Automation

## Status
Draft

## Story
**As a** frontend developer,  
**I want** a stable Docker environment with automated code quality checks,  
**so that** I can develop consistently without manual linting and formatting concerns.

## Acceptance Criteria
1. Docker окружение запускается без ошибок (`make up` или эквивалент)
2. ESLint проверяет код с правилами для React и accessibility
3. Prettier автоматически форматирует код перед коммитом
4. CI/CD pipeline запускает линтеры и блокирует merge при ошибках

## Tasks / Subtasks

- [ ] **Task 1: Проверить и стабилизировать Docker окружение** (AC: 1)
  - [ ] Запустить `docker-compose up` для frontend сервиса
  - [ ] Проверить доступность frontend на `http://localhost:3000`
  - [ ] Убедиться что hot-reload работает при изменении файлов
  - [ ] Синхронизировать переменные окружения в `frontend/.env.local` с примером
  - [ ] Документировать команды запуска в `frontend/README.md`

- [ ] **Task 2: Настроить ESLint с плагинами** (AC: 2)
  - [ ] Установить `eslint-plugin-react-hooks` и `eslint-plugin-jsx-a11y`
  - [ ] Обновить `eslint.config.mjs` с правилами для React hooks и accessibility
  - [ ] Запустить `npm run lint` и исправить существующие ошибки
  - [ ] Добавить скрипт `lint:fix` в `package.json`
  - [ ] Проверить что ESLint интегрирован с IDE (VSCode/WebStorm)

- [ ] **Task 3: Настроить Prettier и lint-staged** (AC: 3)
  - [ ] Установить `prettier` и `lint-staged` как dev dependencies
  - [ ] Создать `.prettierrc` с конфигурацией (single quotes, 2 spaces, etc.)
  - [ ] Создать `.prettierignore` для исключения `.next/`, `node_modules/`
  - [ ] Настроить `lint-staged` в `package.json` для запуска Prettier и ESLint
  - [ ] Установить `husky` для pre-commit hooks
  - [ ] Протестировать pre-commit hook на тестовом коммите

- [ ] **Task 4: Настроить CI/CD pipeline для линтеров** (AC: 4)
  - [ ] Обновить `.github/workflows/frontend-ci.yml` для запуска ESLint
  - [ ] Добавить шаг для проверки Prettier форматирования
  - [ ] Настроить блокировку merge при ошибках линтинга
  - [ ] Добавить badge статуса CI в `frontend/README.md`
  - [ ] Протестировать pipeline на тестовом Pull Request

- [ ] **Task 5: Unit-тесты для проверки окружения** (AC: 1, 2, 3)
  - [ ] Создать `src/__tests__/eslint.config.test.ts` с проверками:
    - [ ] Проверить наличие плагинов: `eslint-plugin-react-hooks`, `eslint-plugin-jsx-a11y`
    - [ ] Проверить extends: `next/core-web-vitals`, `next/typescript`
    - [ ] Проверить что конфигурация экспортируется корректно
  - [ ] Создать `src/__tests__/prettier.config.test.ts` с проверками:
    - [ ] Проверить singleQuote: true
    - [ ] Проверить tabWidth: 2
    - [ ] Проверить semi: true
    - [ ] Проверить trailingComma: 'es5'
  - [ ] Создать smoke test для Docker доступности:
    - [ ] Использовать `fetch('http://localhost:3000')` в тесте
    - [ ] Проверить response.ok === true
  - [ ] Убедиться что тесты проходят в CI/CD

## Dev Notes

### Previous Story Insights
Это первая история Epic 10, предыдущих историй в этом эпике нет.

### Project Structure
[Source: architecture/source-tree.md#frontend]

Frontend структура:
```
frontend/
├── src/
│   ├── app/                # Страницы (Next.js App Router)
│   ├── components/         # React компоненты
│   │   └── ui/            # UI Kit компоненты
│   ├── hooks/             # Кастомные React хуки
│   ├── services/          # Сервисы для работы с API
│   ├── stores/            # State management (Zustand)
│   └── types/             # TypeScript типы
├── public/                # Статические файлы
├── package.json           # Зависимости Node.js
├── next.config.js         # Конфигурация Next.js
├── eslint.config.mjs      # ESLint конфигурация
├── .prettierrc            # Prettier конфигурация (создать)
└── .env.local             # Переменные окружения (проверить)
```

### Tech Stack
[Source: architecture/tech-stack.md#frontend-technologies]

**Core Framework:**
- Next.js 15.4.6 с App Router
- React 19.1.0
- TypeScript 5.0+

**Code Quality:**
- ESLint 9 с `eslint-config-next`
- Prettier (нужно установить)
- lint-staged (нужно установить)
- husky (нужно установить)

**Docker:**
- Docker Compose для оркестрации
- Frontend сервис должен быть доступен на порту 3000

### ESLint Configuration
[Source: architecture/coding-standards.md#eslint-configuration]

Базовая конфигурация ESLint:
```javascript
// eslint.config.mjs
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
  // Добавить правила для react-hooks и jsx-a11y
];

export default eslintConfig;
```

**Требуемые плагины:**
- `eslint-plugin-react-hooks` - правила для React hooks
- `eslint-plugin-jsx-a11y` - правила для accessibility (WCAG 2.1 AA)

### Prettier Configuration
[Source: architecture/coding-standards.md#frontend-commands]

Рекомендуемая конфигурация Prettier:
```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid"
}
```

### Docker Environment
[Source: architecture/tech-stack.md#infrastructure-devops]

**Docker Compose:**
- Frontend сервис должен использовать Node.js 18+ LTS
- Порт: 3000 (маппинг на host)
- Hot-reload через volume mounting
- Переменные окружения из `.env.local`

**Команды:**
- `docker-compose up frontend` - запуск frontend сервиса
- `docker-compose down` - остановка сервисов
- `docker-compose logs -f frontend` - просмотр логов

### CI/CD Configuration
[Source: architecture/tech-stack.md#ci-cd]

**GitHub Actions:**
- Файл: `.github/workflows/frontend-ci.yml`
- Триггеры: Pull Request, Push to main/develop
- Шаги:
  1. Checkout code
  2. Setup Node.js 18+
  3. Install dependencies (`npm ci`)
  4. Run ESLint (`npm run lint`)
  5. Check Prettier formatting (`npx prettier --check .`)
  6. Run tests (`npm test`)

**Блокировка merge:**
- Настроить branch protection rules для `main` и `develop`
- Требовать прохождение всех CI checks

### File Locations
[Source: architecture/source-tree.md#frontend]

**Конфигурационные файлы:**
- `frontend/eslint.config.mjs` - ESLint конфигурация (существует)
- `frontend/.prettierrc` - Prettier конфигурация (создать)
- `frontend/.prettierignore` - Prettier ignore (создать)
- `frontend/package.json` - npm скрипты и lint-staged конфигурация
- `frontend/.env.local` - переменные окружения (проверить)
- `.github/workflows/frontend-ci.yml` - CI/CD pipeline (обновить)

**Документация:**
- `frontend/README.md` - обновить с командами запуска и разработки

### Technical Constraints
[Source: architecture/tech-stack.md#versions-compatibility]

**Версии:**
- Node.js >= 18 LTS
- Next.js >= 15.4
- React >= 19.1
- TypeScript >= 5.0
- ESLint >= 9

**Системные требования:**
- Docker с поддержкой Docker Compose
- 4GB+ RAM для разработки
- SSD рекомендуется

### Accessibility Requirements
[Source: epic-10-frontend-foundation.md#definition-of-done]

**WCAG 2.1 AA:**
- ESLint плагин `jsx-a11y` должен проверять:
  - Наличие alt текста для изображений
  - Правильное использование ARIA атрибутов
  - Keyboard navigation
  - Color contrast (будет проверяться в UI компонентах)

### Testing

#### Testing Standards
[Source: frontend/docs/testing-standards.md#unit-tests]

**Unit тесты:**
- Технология: Jest + React Testing Library
- Покрытие: 80%+ для всех компонентов
- Файлы: `__tests__/ComponentName.test.tsx`

**Конфигурация Jest:**
```javascript
// jest.config.js
const nextJest = require('next/jest')

const createJestConfig = nextJest({
  dir: './',
})

const customJestConfig = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/**/index.{js,jsx,ts,tsx}',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
}

module.exports = createJestConfig(customJestConfig)
```

#### Test Examples for Story 10.1

**ESLint Configuration Test:**

```typescript
// src/__tests__/eslint.config.test.ts
import eslintConfig from '../eslint.config.mjs';

describe('ESLint Configuration', () => {
  test('should have required plugins', () => {
    // Проверяем что конфигурация экспортируется
    expect(eslintConfig).toBeDefined();
    expect(Array.isArray(eslintConfig)).toBe(true);

    // Проверяем наличие next/core-web-vitals и next/typescript
    const configString = JSON.stringify(eslintConfig);
    expect(configString).toContain('next/core-web-vitals');
    expect(configString).toContain('next/typescript');
  });

  test('should extend Next.js recommended configs', () => {
    // Проверяем что используется compat.extends
    expect(eslintConfig.length).toBeGreaterThan(0);
  });
});
```

**Prettier Configuration Test:**

```typescript
// src/__tests__/prettier.config.test.ts
import { readFileSync } from 'fs';
import { join } from 'path';

describe('Prettier Configuration', () => {
  let prettierConfig: any;

  beforeAll(() => {
    const configPath = join(process.cwd(), '.prettierrc');
    const configContent = readFileSync(configPath, 'utf-8');
    prettierConfig = JSON.parse(configContent);
  });

  test('should have correct formatting rules', () => {
    expect(prettierConfig.singleQuote).toBe(true);
    expect(prettierConfig.tabWidth).toBe(2);
    expect(prettierConfig.semi).toBe(true);
    expect(prettierConfig.trailingComma).toBe('es5');
    expect(prettierConfig.printWidth).toBe(100);
    expect(prettierConfig.arrowParens).toBe('avoid');
  });
});
```

**Docker Environment Smoke Test:**

```typescript
// src/__tests__/docker-environment.test.ts
describe('Docker Environment', () => {
  test('should be accessible on port 3000', async () => {
    try {
      const response = await fetch('http://localhost:3000');
      expect(response.ok).toBe(true);
    } catch (error) {
      // Если Docker не запущен - пропустить тест
      console.warn('Docker environment not running, skipping test');
    }
  }, 10000); // 10s timeout для сетевого запроса
});
```

**Команды для запуска тестов:**

```bash
# Запуск всех тестов
npm test

# Запуск тестов в watch режиме
npm run test:watch

# Запуск с покрытием
npm run test:coverage

# Запуск только конфигурационных тестов
npm test -- eslint.config.test.ts prettier.config.test.ts
```

#### Test File Locations
[Source: frontend/docs/testing-standards.md#structure]

```
frontend/
├── src/
│   └── __tests__/
│       ├── eslint.config.test.ts        # Проверка ESLint плагинов и extends
│       ├── prettier.config.test.ts      # Проверка Prettier настроек
│       └── docker-environment.test.ts   # Smoke test доступности Docker
├── jest.config.js                       # Конфигурация Jest
└── jest.setup.js                        # Setup файл для тестов
```

## Change Log
| Date       | Version | Description                          | Author        |
|------------|---------|--------------------------------------|---------------|
| 2025-11-15 | 1.0     | Initial story creation               | Bob (SM)      |
| 2025-11-16 | 1.1     | Added detailed test examples and assertions for Task 5 | Bob (SM)      |

## Dev Agent Record
_This section will be populated by the development agent during implementation._

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_This section will be populated by QA Agent after story completion._
