# Story 1.8: database-design

## Status
Draft

## Story
**As a** разработчик,
**I want** спроектировать и создать структуру базы данных,
**so that** поддерживать все бизнес-процессы FREESPORT платформы.

## Acceptance Criteria

1. Создана ER-диаграмма базы данных
2. Реализованы модели Django для всех основных сущностей
3. Настроены миграции Django
4. Созданы индексы для оптимизации производительности
5. Добавлены базовые constraints и валидации

## Tasks / Subtasks

- [ ] Создать ER-диаграмму (AC: 1)
  - [ ] Спроектировать схему сущностей: User, Product, Order, Cart
  - [ ] Определить связи между сущностями (1:1, 1:N, M:N)
  - [ ] Добавить Company, Address, Category модели
  - [ ] Документировать бизнес-правила в диаграмме

- [ ] Реализовать Django модели (AC: 2)
  - [ ] Создать модели пользователей с ролевой системой
  - [ ] Реализовать модели товаров и категорий
  - [ ] Создать модели заказов и корзин
  - [ ] Добавить модели компаний и адресов для B2B

- [ ] Настроить миграции (AC: 3)
  - [ ] Создать initial migrations для всех приложений
  - [ ] Настроить data migrations для начальных данных
  - [ ] Проверить rollback capabilities
  - [ ] Документировать migration strategy

- [ ] Создать индексы (AC: 4)
  - [ ] Добавить индексы для поиска товаров
  - [ ] Создать составные индексы для фильтрации
  - [ ] Настроить full-text search индексы
  - [ ] Оптимизировать запросы с explain analyze

- [ ] Добавить constraints и валидации (AC: 5)
  - [ ] Database constraints (FK, unique, check)
  - [ ] Django model validation
  - [ ] Business logic validation (цены, остатки)
  - [ ] Data integrity checks

## Dev Notes

### Технический контекст из архитектуры:

**Database Configuration:**
- **Engine:** PostgreSQL 15+ с поддержкой JSONB
- **Connection:** DATABASE_URL environment variable
- **Pool:** Connection pooling для production
- **Backup:** Automated backup strategy

**Core Models (из архитектуры):**
```python
# Основные сущности системы
class User(AbstractUser):
    email = models.EmailField(unique=True)
    role = models.CharField(max_length=20, choices=USER_ROLES)
    company_name = models.CharField(max_length=200, blank=True)
    tax_id = models.CharField(max_length=50, blank=True)

class Product(models.Model):
    name = models.CharField(max_length=200)
    category = models.ForeignKey(Category, on_delete=models.CASCADE)
    brand = models.CharField(max_length=100)
    price_retail = models.DecimalField(max_digits=10, decimal_places=2)

class Order(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    status = models.CharField(max_length=20, choices=ORDER_STATUSES)
    total_amount = models.DecimalField(max_digits=10, decimal_places=2)
    created_at = models.DateTimeField(auto_now_add=True)
```

**Roles System:**
```python
USER_ROLES = [
    ('retail', 'Розничный покупатель'),
    ('wholesale_level1', 'Оптовик уровень 1'),
    ('wholesale_level2', 'Оптовик уровень 2'), 
    ('wholesale_level3', 'Оптовик уровень 3'),
    ('trainer', 'Тренер'),
    ('federation_rep', 'Представитель федерации'),
]
```

**Key Relationships:**
- User → Orders (1:N)
- User → CartItems (1:N)
- Product → OrderItems (1:N)
- Product → Category (N:1)
- Company → Users (1:N) для B2B

**Performance Indexes:**
```sql
-- Поиск товаров
CREATE INDEX idx_product_search ON products USING GIN(to_tsvector('russian', name));
-- Фильтрация по категории и цене
CREATE INDEX idx_product_category_price ON products(category_id, price_retail);
-- Заказы пользователя
CREATE INDEX idx_order_user_created ON orders(user_id, created_at DESC);
```

**Business Constraints:**
- Цены должны быть положительными
- Email уникальный для пользователей
- Остатки товаров не могут быть отрицательными
- Роли пользователей определяют доступные цены

### Testing

**Testing Standards:**
- **Model Tests:** pytest-django с фабриками
- **Migration Tests:** Проверка прямых и обратных миграций
- **Performance Tests:** Django test utils для query count
- **Data Integrity:** Constraint validation тесты

**Тестирование для этой истории:**
- Unit тесты для всех Django моделей
- Валидация model constraints и relationships
- Тесты миграций (forward/backward)
- Performance тесты для индексированных запросов
- Data integrity тесты для business rules

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_TBD - будет заполнено dev агентом_

### Debug Log References  
_TBD - будет заполнено dev агентом_

### Completion Notes List
_TBD - будет заполнено dev агентом_

### File List
_TBD - будет заполнено dev агентом_

## QA Results
_TBD - будет заполнено QA агентом_