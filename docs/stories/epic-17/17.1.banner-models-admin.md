# Story 17.1: Backend модели и Admin для баннеров

## Status

**Draft**

---

## Story

**As a** администратор магазина,  
**I want** создавать и управлять баннерами героя с настройкой таргетинга по группам пользователей через Django Admin,  
**so that** я могу динамически настраивать контент главной страницы для разных аудиторий без изменения кода.

---

## Acceptance Criteria

1. Создана модель `Banner` в новом приложении `apps/banners/`
2. Поля контента: `title`, `subtitle`, `image`, `image_alt`, `cta_text`, `cta_link`
3. Поля таргетинга: `show_to_guests`, `show_to_authenticated`, `show_to_trainers`, `show_to_wholesale`, `show_to_federation`
4. Поля управления: `is_active`, `priority`, `start_date`, `end_date`
5. Django Admin с list_display, list_filter, fieldsets
6. Миграции созданы и применены
7. Unit-тесты для модели (валидация, ordering, queryset filtering)

---

## Tasks / Subtasks

- [ ] **Task 1: Создание Django приложения `banners`** (AC: 1)
  - [ ] 1.1. Создать приложение командой `python manage.py startapp banners apps/banners`
  - [ ] 1.2. Добавить `apps.banners` в `INSTALLED_APPS` в `freesport/settings/base.py`
  - [ ] 1.3. Создать структуру файлов согласно source-tree

- [ ] **Task 2: Создать модель `Banner`** (AC: 1, 2, 3, 4)
  - [ ] 2.1. Реализовать поля контента: `title` (CharField, max_length=200), `subtitle` (CharField, 500, blank=True), `image` (ImageField, upload_to="banners/%Y/%m/", help_text="Рекомендуемый размер: 1920×600px"), `image_alt` (CharField, max_length=200, blank=True, help_text="Alt-текст для accessibility"), `cta_text` (CharField, 50), `cta_link` (CharField, 200)
  - [ ] 2.2. Реализовать поля таргетинга (BooleanField, default=False для каждого): `show_to_guests`, `show_to_authenticated`, `show_to_trainers`, `show_to_wholesale`, `show_to_federation`
  - [ ] 2.3. Реализовать поля управления: `is_active` (BooleanField, default=True), `priority` (IntegerField, default=0), `start_date` (DateTimeField, null=True, blank=True), `end_date` (DateTimeField, null=True, blank=True)
  - [ ] 2.4. Добавить метаданные: `created_at` (auto_now_add), `updated_at` (auto_now)
  - [ ] 2.5. Реализовать Meta класс: `verbose_name`, `verbose_name_plural`, `db_table="banners"`, `ordering=["-priority", "-created_at"]`
  - [ ] 2.6. Реализовать метод `__str__`
  - [ ] 2.7. Реализовать property `is_scheduled_active` для проверки активности с учётом дат
  - [ ] 2.8. Реализовать classmethod `get_for_user(cls, user=None)` для фильтрации баннеров по роли пользователя

- [ ] **Task 3: Создать миграции и применить** (AC: 6)
  - [ ] 3.1. Выполнить `python manage.py makemigrations banners`
  - [ ] 3.2. Выполнить `python manage.py migrate banners`
  - [ ] 3.3. Проверить что таблица `banners` создана в БД

- [ ] **Task 4: Настроить Django Admin** (AC: 5)
  - [ ] 4.1. Создать `BannerAdmin` с `list_display`: title, image_preview, is_active, priority, target_groups_display, start_date, end_date
  - [ ] 4.2. Настроить `list_filter`: is_active, все поля show_to_*
  - [ ] 4.3. Настроить `search_fields`: title, subtitle
  - [ ] 4.4. Создать `fieldsets`: Контент, Таргетинг, Управление
  - [ ] 4.5. Реализовать helper-метод `image_preview` для превью изображений в списке
  - [ ] 4.6. Реализовать helper-метод `target_groups_display` для отображения списка целевых групп

- [ ] **Task 5: Написать Unit-тесты для модели** (AC: 7)
  - [ ] 5.1. Создать `tests/unit/test_banner_model.py`
  - [ ] 5.2. Тест `test_banner_str_representation`
  - [ ] 5.3. Тест `test_banner_ordering_by_priority_and_created_at`
  - [ ] 5.4. Тест `test_is_scheduled_active_property`
  - [ ] 5.5. Тест `test_get_for_user_returns_guest_banners_for_anonymous`
  - [ ] 5.6. Тест `test_get_for_user_returns_authenticated_banners_for_logged_in_user`
  - [ ] 5.7. Тест `test_get_for_user_returns_wholesale_banners_for_wholesale_user`
  - [ ] 5.8. Тест `test_get_for_user_returns_trainer_banners_for_trainer`
  - [ ] 5.9. Тест `test_get_for_user_returns_federation_banners_for_federation_rep`
  - [ ] 5.10. Тест `test_get_for_user_excludes_inactive_banners`
  - [ ] 5.11. Тест `test_get_for_user_excludes_expired_banners`
  - [ ] 5.12. Использовать Factory Boy для создания тестовых данных (`BannerFactory`)

- [ ] **Task 6: Создать Factory для тестов** (AC: 7)
  - [ ] 6.1. Создать `apps/banners/factories.py` с `BannerFactory`
  - [ ] 6.2. Настроить lazy generation для ImageField

---

## Dev Notes

### Структура файлов

Согласно `docs/architecture/source-tree.md`, новое приложение создаётся в `backend/apps/`:

```text
backend/apps/banners/
├── __init__.py
├── admin.py           # Django Admin конфигурация (Task 4)
├── apps.py            # AppConfig
├── factories.py       # Factory Boy фабрики (Task 6)
├── models.py          # Banner модель (Task 2)
├── migrations/        # Django миграции (Task 3)
│   └── 0001_initial.py
└── tests/
    ├── __init__.py
    └── test_models.py  # Unit-тесты модели (Task 5)
```

[Source: docs/architecture/source-tree.md#backend]

### Модель User и ROLE_CHOICES

Роли пользователей определены в `backend/apps/users/models.py`:

```python
ROLE_CHOICES = [
    ("retail", "Розничный покупатель"),
    ("wholesale_level1", "Оптовик уровень 1"),
    ("wholesale_level2", "Оптовик уровень 2"),
    ("wholesale_level3", "Оптовик уровень 3"),
    ("trainer", "Тренер/Фитнес-клуб"),
    ("federation_rep", "Представитель федерации"),
    ("admin", "Администратор"),
]
```

Метод `get_for_user()` должен использовать эти роли для фильтрации:
- **Guests**: `user is None or not user.is_authenticated` → `show_to_guests=True`
- **Authenticated (retail)**: `show_to_authenticated=True`
- **Trainers**: `user.role == "trainer"` → `show_to_trainers=True`
- **Wholesale**: `user.role.startswith("wholesale")` → `show_to_wholesale=True`
- **Federation**: `user.role == "federation_rep"` → `show_to_federation=True`

[Source: backend/apps/users/models.py#L72-80]

### Coding Standards

- **Black** для форматирования (88 символов)
- **isort** для сортировки импортов
- **Flake8** для линтинга
- **mypy** для типизации — типизация обязательна для всех публичных методов

[Source: docs/architecture/coding-standards.md#backend]

### Паттерн модели

Следовать паттерну существующих моделей:
- Использовать verbose_name на русском для всех полей
- help_text для сложных полей
- Explicit db_table

[Source: docs/architecture/coding-standards.md#models]

### Существующие фабрики

Для тестов с различными ролями пользователей использовать существующую фабрику:

```python
from apps.users.factories import UserFactory

# Создание пользователей с разными ролями для тестов
guest_user = None  # Гость
retail_user = UserFactory(role="retail")
trainer_user = UserFactory(role="trainer")
wholesale_user = UserFactory(role="wholesale_level1")
federation_user = UserFactory(role="federation_rep")
```

[Source: backend/apps/users/factories.py]

### Django Admin Pattern

```python
@admin.register(Banner)
class BannerAdmin(admin.ModelAdmin):
    list_display = [...]
    list_filter = [...]
    search_fields = [...]
    fieldsets = (
        ("Контент", {"fields": (...)}),
        ("Таргетинг", {"fields": (...), "description": "..."}),
        ("Управление", {"fields": (...)}),
    )
```

[Source: docs/epics/epic-17/epic-17.banner-management.md#technical-notes]

---

## Testing

### Требования

- **Framework**: `pytest` + `pytest-django`
- **Маркировка**: `@pytest.mark.unit` для unit-тестов
- **Генерация данных**: `Factory Boy` (обязательно!)
- **Покрытие**: минимум 80% для модели

[Source: docs/architecture/10-testing-strategy.md#backend-tests]

### Структура тестов

```text
backend/tests/unit/test_banner_model.py
```

### Команды для запуска тестов

```bash
# Запустить все unit-тесты
pytest -m unit

# Запустить только тесты баннеров
pytest tests/unit/test_banner_model.py -v

# Запустить с покрытием
pytest tests/unit/test_banner_model.py --cov=apps.banners --cov-report=term-missing
```

### Паттерн теста

```python
import pytest
from django.test import TestCase
from apps.banners.factories import BannerFactory
from apps.banners.models import Banner
from apps.users.factories import UserFactory

@pytest.mark.unit
@pytest.mark.django_db
class TestBannerModel:
    """Unit-тесты модели Banner"""
    
    def test_banner_str_representation(self):
        banner = BannerFactory(title="Test Banner", priority=5)
        assert str(banner) == "Test Banner (priority: 5)"
    
    def test_get_for_user_returns_guest_banners_for_anonymous(self):
        BannerFactory(show_to_guests=True)
        BannerFactory(show_to_authenticated=True)
        
        banners = Banner.get_for_user(user=None)
        
        assert banners.count() == 1
        assert banners.first().show_to_guests is True
```

[Source: docs/architecture/10-testing-strategy.md#unit-tests]

---

## Change Log

| Date       | Version | Description                              | Author     |
|------------|---------|------------------------------------------|------------|
| 2025-12-19 | 0.1     | Initial story draft created              | Bob (SM)   |

---

## Dev Agent Record

### Agent Model Used

_TBD - populated by dev agent_

### Debug Log References

_TBD - populated by dev agent_

### Completion Notes List

_TBD - populated by dev agent_

### File List

_TBD - populated by dev agent_

---

## QA Results

_TBD - populated by QA agent_
