# Story 17.2: API эндпоинты для баннеров

## Status

**Done**

---

## Story

**As a** frontend разработчик,  
**I want** иметь REST API для получения активных баннеров с автоматической фильтрацией по роли текущего пользователя,  
**so that** Hero-секция главной страницы отображает только релевантные баннеры для каждой аудитории.

---

## Acceptance Criteria

1. `GET /api/banners/` — возвращает активные баннеры для текущего пользователя
2. Фильтрация по `is_active=True` и дате публикации (start_date/end_date)
3. Фильтрация по роли из JWT токена (или гость если не авторизован)
4. Сортировка по `priority` (DESC)
5. Сериализатор с полями: `id`, `title`, `subtitle`, `image_url`, `image_alt`, `cta_text`, `cta_link`
6. OpenAPI документация (drf-spectacular)
7. Integration-тесты для всех сценариев (гость, retail, wholesale, trainer, federation)

---

## Tasks / Subtasks

- [x] **Task 1: Создание сериализатора BannerSerializer** (AC: 5)
  - [x] 1.1. Создать `apps/banners/serializers.py`
  - [x] 1.2. Реализовать `BannerSerializer` с полями: `id`, `title`, `subtitle`, `image_url`, `image_alt`, `cta_text`, `cta_link`
  - [x] 1.3. Добавить SerializerMethodField для `image_url` (конвертация ImageField в URL)
  - [x] 1.4. Добавить типизацию методов согласно coding-standards

- [x] **Task 2: Создание ActiveBannersView** (AC: 1, 2, 3, 4)
  - [x] 2.1. Создать `apps/banners/views.py`
  - [x] 2.2. Реализовать `ActiveBannersView` (APIView или ViewSet)
  - [x] 2.3. Реализовать GET метод с вызовом `Banner.get_for_user(request.user)`
  - [x] 2.4. Настроить `permission_classes = [AllowAny]` для поддержки гостей
  - [x] 2.5. Добавить сортировку по `priority` DESC (уже реализовано в модели ordering)

- [x] **Task 3: Настроить URL маршруты** (AC: 1)
  - [x] 3.1. Создать `apps/banners/urls.py`
  - [x] 3.2. Зарегистрировать endpoint `/banners/` (list action)
  - [x] 3.3. Подключить URLs в `freesport/urls.py` с префиксом `/api/`

- [x] **Task 4: Добавить OpenAPI документацию** (AC: 6)
  - [x] 4.1. Добавить `@extend_schema` декораторы к view
  - [x] 4.2. Настроить summary, description, tags=["Banners"]
  - [x] 4.3. Описать response schema с примерами
  - [x] 4.4. Проверить спецификацию через `/api/docs/`

- [x] **Task 5: Написать Integration-тесты** (AC: 7)
  - [x] 5.1. Создать `backend/tests/integration/test_banners_api.py`
  - [x] 5.2. Тест `test_guest_gets_guest_banners` — гость получает баннеры с `show_to_guests=True`
  - [x] 5.3. Тест `test_retail_user_gets_authenticated_banners` — B2C пользователь
  - [x] 5.4. Тест `test_wholesale_user_gets_wholesale_banners` — оптовик (все уровни)
  - [x] 5.5. Тест `test_trainer_gets_trainer_banners` — тренер
  - [x] 5.6. Тест `test_federation_gets_federation_banners` — представитель федерации
  - [x] 5.7. Тест `test_inactive_banners_excluded` — неактивные баннеры не возвращаются
  - [x] 5.8. Тест `test_expired_banners_excluded` — истёкшие баннеры не возвращаются
  - [x] 5.9. Тест `test_future_start_date_excluded` — баннеры с start_date в будущем не возвращаются
  - [x] 5.10. Тест `test_banners_sorted_by_priority` — порядок сортировки
  - [x] 5.11. Использовать `BannerFactory` и `UserFactory` для данных

---

## Dev Notes

### Зависимости от Story 17.1

Эта история зависит от Story 17.1, которая создаёт:

- Модель `Banner` в `apps/banners/models.py`
- Метод `Banner.get_for_user(user)` для фильтрации по роли
- `BannerFactory` для тестов

[Source: docs/stories/epic-17/17.1.banner-models-admin.md]

### Структура файлов

Согласно source-tree.md и Epic 17, добавить в `apps/banners/`:

```text
backend/apps/banners/
├── serializers.py     # BannerSerializer (Task 1)
├── views.py           # ActiveBannersView (Task 2)
└── urls.py            # URL маршруты (Task 3)
```

[Source: docs/architecture/source-tree.md#backend]

### Паттерн ViewSet/APIView

Следовать паттерну существующих views. Пример из `PageViewSet`:

```python
from rest_framework import viewsets, permissions
from rest_framework.response import Response
from drf_spectacular.utils import extend_schema, OpenApiExample

class ActiveBannersView(viewsets.ViewSet):
    """ViewSet для получения активных баннеров"""
    
    permission_classes = [permissions.AllowAny]  # Доступно гостям
    
    @extend_schema(
        summary="Получить активные баннеры",
        description="Возвращает баннеры для текущего пользователя с учётом роли",
        tags=["Banners"],
        responses={200: BannerSerializer(many=True)},
    )
    def list(self, request):
        user = request.user if request.user.is_authenticated else None
        banners = Banner.get_for_user(user)
        serializer = BannerSerializer(banners, many=True, context={'request': request})
        return Response(serializer.data)
```

[Source: backend/apps/pages/views.py, backend/apps/products/views.py]

### Сериализатор с image_url

```python
from rest_framework import serializers
from .models import Banner

class BannerSerializer(serializers.ModelSerializer):
    """Сериализатор баннера для публичного API"""
    
    image_url = serializers.SerializerMethodField()
    
    class Meta:
        model = Banner
        fields = ['id', 'title', 'subtitle', 'image_url', 'image_alt', 'cta_text', 'cta_link']
        read_only_fields = fields
    
    def get_image_url(self, obj: Banner) -> str:
        """Получить полный URL изображения"""
        request = self.context.get('request')
        if obj.image and request:
            return request.build_absolute_uri(obj.image.url)
        return ''
```

[Source: docs/architecture/coding-standards.md#serializers]

### URL Configuration

```python
# apps/banners/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ActiveBannersView

router = DefaultRouter()
router.register(r'banners', ActiveBannersView, basename='banner')

app_name = 'banners'

urlpatterns = [
    path('', include(router.urls)),
]
```

Подключение в `freesport/urls.py`:

```python
urlpatterns = [
    # ...
    path('api/', include('apps.banners.urls')),
]
```

[Source: backend/apps/orders/urls.py]

### OpenAPI Response Schema

> **Примечание:** Для Hero-секции используется простой список без пагинации, т.к. количество активных баннеров для одной роли обычно 1-5 штук.

```json
[
  {
    "id": 1,
    "title": "Новая коллекция 2025",
    "subtitle": "Эксклюзивные новинки",
    "image_url": "/media/banners/2025/01/hero.webp",
    "image_alt": "Баннер новой коллекции",
    "cta_text": "Перейти в каталог",
    "cta_link": "/catalog"
  }
]
```

[Source: docs/epics/epic-17/epic-17.banner-management.md#api-design, адаптировано]

### Роли пользователей

```python
# Логика фильтрации (реализована в Banner.get_for_user)
# Гость: user is None → show_to_guests=True
# Authenticated (retail): show_to_authenticated=True
# Trainer: user.role == "trainer" → show_to_trainers=True
# Wholesale: user.role.startswith("wholesale") → show_to_wholesale=True
# Federation: user.role == "federation_rep" → show_to_federation=True
```

[Source: backend/apps/users/models.py#ROLE_CHOICES]

---

## Testing

### Требования

- **Framework**: `pytest` + `pytest-django`
- **Маркировка**: `@pytest.mark.integration` для integration-тестов
- **Генерация данных**: `Factory Boy` (BannerFactory, UserFactory)
- **Покрытие**: минимум 80% для endpoints

[Source: docs/architecture/10-testing-strategy.md#integration-tests]

### Структура тестов

```text
backend/tests/integration/test_banners_api.py
```

### Команды для запуска тестов

```bash
# Запустить integration-тесты
pytest -m integration

# Запустить только тесты баннеров
pytest tests/integration/test_banners_api.py -v

# С покрытием
pytest tests/integration/test_banners_api.py --cov=apps.banners --cov-report=term-missing
```

### Паттерн теста

```python
import pytest
from rest_framework import status
from rest_framework.test import APIClient
from django.urls import reverse
from apps.banners.factories import BannerFactory
from apps.users.factories import UserFactory

@pytest.mark.integration
@pytest.mark.django_db
class TestBannersAPI:
    """Integration-тесты API баннеров"""
    
    def setup_method(self):
        self.client = APIClient()
        self.url = '/api/banners/'
    
    def test_guest_gets_guest_banners(self):
        """Гость получает только баннеры с show_to_guests=True"""
        guest_banner = BannerFactory(show_to_guests=True, title="Guest Banner")
        auth_banner = BannerFactory(show_to_authenticated=True, title="Auth Banner")
        
        response = self.client.get(self.url)
        
        assert response.status_code == status.HTTP_200_OK
        titles = [b['title'] for b in response.json()]
        assert "Guest Banner" in titles
        assert "Auth Banner" not in titles
    
    def test_wholesale_user_gets_wholesale_banners(self):
        """Оптовик получает баннеры с show_to_wholesale=True"""
        user = UserFactory(role="wholesale_level2")
        self.client.force_authenticate(user=user)
        
        BannerFactory(show_to_wholesale=True, title="Wholesale Banner")
        BannerFactory(show_to_guests=True, title="Guest Only")
        
        response = self.client.get(self.url)
        
        assert response.status_code == status.HTTP_200_OK
        titles = [b['title'] for b in response.json()]
        assert "Wholesale Banner" in titles
```

[Source: docs/architecture/10-testing-strategy.md#backend-api-test]

---

## Change Log

| Date       | Version | Description                              | Author     |
|------------|---------|------------------------------------------|------------|
| 2025-12-19 | 0.1     | Initial story draft created              | Bob (SM)   |
| 2025-12-19 | 0.2     | Валидация: URL → /api/banners/, response без пагинации, добавлен image_alt и edge case тест | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

Нет критических проблем

### Completion Notes List

- ✅ Все 5 задач выполнены успешно
- ✅ Создан BannerSerializer с полной типизацией и SerializerMethodField для image_url
- ✅ Реализован ActiveBannersView (ViewSet) с поддержкой AllowAny для гостей
- ✅ Настроены URL маршруты: /api/banners/ подключён через роутер
- ✅ Добавлена полная OpenAPI документация через @extend_schema с примерами
- ✅ Написано 13 integration-тестов, все прошли успешно
- ✅ Покрытие кода: 88% (выше требуемых 80%)
- ✅ Линтинг Black: все файлы соответствуют стандартам
- ✅ Flake8: нет ошибок стиля кода
- ✅ MyPy: типизация корректна (ошибки в других модулях не связаны с banners)

### File List

**Созданные файлы:**

- `backend/apps/banners/serializers.py` - BannerSerializer для API
- `backend/apps/banners/views.py` - ActiveBannersView ViewSet
- `backend/apps/banners/urls.py` - URL маршруты для баннеров
- `backend/tests/integration/test_banners_api.py` - 13 integration-тестов

**Изменённые файлы:**

- `backend/freesport/urls.py` - добавлен path('api/', include('apps.banners.urls'))

---

## QA Results

### Review Date: 2025-12-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is high quality and follows the project's architecture seamlessly. The use of `Banner.get_for_user` logic encapsulates the filtering rules well, allowing the View to remain clean. The `BannerSerializer` correctly handles the `image_url` construction. Test coverage is comprehensive, addressing all user roles and edge cases (inactive, expired, future banners).

### Refactoring Performed

None required. The code was found to be compliant with standards upon first review.

### Compliance Check

- Coding Standards: [✓] Follows Black/Flake8/MyPy standards.
- Project Structure: [✓] Correct placement in `apps/banners/`.
- Testing Strategy: [✓] Integration tests cover all ACs and use `pytest-django`.
- All ACs Met: [✓] All 7 acceptance criteria are satisfied.

### Improvements Checklist

- [x] Verified Guest access
- [x] Verified Retail user access
- [x] Verified Wholesale (L1-L3) access
- [x] Verified Trainer access
- [x] Verified Federation access
- [x] Verified filtering (is_active, dates)
- [x] Verified sorting by priority

### Security Review

- **Access Control:** Correctly relies on `request.user` and the `Banner.get_for_user` method. `AllowAny` permission is appropriate as logic inside the view handles the differentiation between guest and auth users.

### Performance Considerations

- Start/End date filtering is done at the database level.
- Priority sorting is done at the database level.

### Gate Status

Gate: PASS → docs/qa/gates/17.2.banner-api.yml

### Recommended Status

[✓ Test Architecture Review Passed]
(Ready for Done)
