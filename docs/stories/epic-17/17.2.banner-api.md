# Story 17.2: API эндпоинты для баннеров

## Status

**Draft**

---

## Story

**As a** frontend разработчик,  
**I want** иметь REST API для получения активных баннеров с автоматической фильтрацией по роли текущего пользователя,  
**so that** Hero-секция главной страницы отображает только релевантные баннеры для каждой аудитории.

---

## Acceptance Criteria

1. `GET /api/banners/` — возвращает активные баннеры для текущего пользователя
2. Фильтрация по `is_active=True` и дате публикации (start_date/end_date)
3. Фильтрация по роли из JWT токена (или гость если не авторизован)
4. Сортировка по `priority` (DESC)
5. Сериализатор с полями: `id`, `title`, `subtitle`, `image_url`, `image_alt`, `cta_text`, `cta_link`
6. OpenAPI документация (drf-spectacular)
7. Integration-тесты для всех сценариев (гость, retail, wholesale, trainer, federation)

---

## Tasks / Subtasks

- [ ] **Task 1: Создание сериализатора BannerSerializer** (AC: 5)
  - [ ] 1.1. Создать `apps/banners/serializers.py`
  - [ ] 1.2. Реализовать `BannerSerializer` с полями: `id`, `title`, `subtitle`, `image_url`, `image_alt`, `cta_text`, `cta_link`
  - [ ] 1.3. Добавить SerializerMethodField для `image_url` (конвертация ImageField в URL)
  - [ ] 1.4. Добавить типизацию методов согласно coding-standards

- [ ] **Task 2: Создание ActiveBannersView** (AC: 1, 2, 3, 4)
  - [ ] 2.1. Создать `apps/banners/views.py`
  - [ ] 2.2. Реализовать `ActiveBannersView` (APIView или ViewSet)
  - [ ] 2.3. Реализовать GET метод с вызовом `Banner.get_for_user(request.user)`
  - [ ] 2.4. Настроить `permission_classes = [AllowAny]` для поддержки гостей
  - [ ] 2.5. Добавить сортировку по `priority` DESC (уже реализовано в модели ordering)

- [ ] **Task 3: Настроить URL маршруты** (AC: 1)
  - [ ] 3.1. Создать `apps/banners/urls.py`
  - [ ] 3.2. Зарегистрировать endpoint `/banners/` (list action)
  - [ ] 3.3. Подключить URLs в `freesport/urls.py` с префиксом `/api/`

- [ ] **Task 4: Добавить OpenAPI документацию** (AC: 6)
  - [ ] 4.1. Добавить `@extend_schema` декораторы к view
  - [ ] 4.2. Настроить summary, description, tags=["Banners"]
  - [ ] 4.3. Описать response schema с примерами
  - [ ] 4.4. Проверить спецификацию через `/api/docs/`

- [ ] **Task 5: Написать Integration-тесты** (AC: 7)
  - [ ] 5.1. Создать `backend/tests/integration/test_banners_api.py`
  - [ ] 5.2. Тест `test_guest_gets_guest_banners` — гость получает баннеры с `show_to_guests=True`
  - [ ] 5.3. Тест `test_retail_user_gets_authenticated_banners` — B2C пользователь
  - [ ] 5.4. Тест `test_wholesale_user_gets_wholesale_banners` — оптовик (все уровни)
  - [ ] 5.5. Тест `test_trainer_gets_trainer_banners` — тренер
  - [ ] 5.6. Тест `test_federation_gets_federation_banners` — представитель федерации
  - [ ] 5.7. Тест `test_inactive_banners_excluded` — неактивные баннеры не возвращаются
  - [ ] 5.8. Тест `test_expired_banners_excluded` — истёкшие баннеры не возвращаются
  - [ ] 5.9. Тест `test_future_start_date_excluded` — баннеры с start_date в будущем не возвращаются
  - [ ] 5.10. Тест `test_banners_sorted_by_priority` — порядок сортировки
  - [ ] 5.11. Использовать `BannerFactory` и `UserFactory` для данных

---

## Dev Notes

### Зависимости от Story 17.1

Эта история зависит от Story 17.1, которая создаёт:
- Модель `Banner` в `apps/banners/models.py`
- Метод `Banner.get_for_user(user)` для фильтрации по роли
- `BannerFactory` для тестов

[Source: docs/stories/epic-17/17.1.banner-models-admin.md]

### Структура файлов

Согласно source-tree.md и Epic 17, добавить в `apps/banners/`:

```text
backend/apps/banners/
├── serializers.py     # BannerSerializer (Task 1)
├── views.py           # ActiveBannersView (Task 2)
└── urls.py            # URL маршруты (Task 3)
```

[Source: docs/architecture/source-tree.md#backend]

### Паттерн ViewSet/APIView

Следовать паттерну существующих views. Пример из `PageViewSet`:

```python
from rest_framework import viewsets, permissions
from rest_framework.response import Response
from drf_spectacular.utils import extend_schema, OpenApiExample

class ActiveBannersView(viewsets.ViewSet):
    """ViewSet для получения активных баннеров"""
    
    permission_classes = [permissions.AllowAny]  # Доступно гостям
    
    @extend_schema(
        summary="Получить активные баннеры",
        description="Возвращает баннеры для текущего пользователя с учётом роли",
        tags=["Banners"],
        responses={200: BannerSerializer(many=True)},
    )
    def list(self, request):
        user = request.user if request.user.is_authenticated else None
        banners = Banner.get_for_user(user)
        serializer = BannerSerializer(banners, many=True, context={'request': request})
        return Response(serializer.data)
```

[Source: backend/apps/pages/views.py, backend/apps/products/views.py]

### Сериализатор с image_url

```python
from rest_framework import serializers
from .models import Banner

class BannerSerializer(serializers.ModelSerializer):
    """Сериализатор баннера для публичного API"""
    
    image_url = serializers.SerializerMethodField()
    
    class Meta:
        model = Banner
        fields = ['id', 'title', 'subtitle', 'image_url', 'image_alt', 'cta_text', 'cta_link']
        read_only_fields = fields
    
    def get_image_url(self, obj: Banner) -> str:
        """Получить полный URL изображения"""
        request = self.context.get('request')
        if obj.image and request:
            return request.build_absolute_uri(obj.image.url)
        return ''
```

[Source: docs/architecture/coding-standards.md#serializers]

### URL Configuration

```python
# apps/banners/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ActiveBannersView

router = DefaultRouter()
router.register(r'banners', ActiveBannersView, basename='banner')

app_name = 'banners'

urlpatterns = [
    path('', include(router.urls)),
]
```

Подключение в `freesport/urls.py`:

```python
urlpatterns = [
    # ...
    path('api/', include('apps.banners.urls')),
]
```

[Source: backend/apps/orders/urls.py]

### OpenAPI Response Schema

> **Примечание:** Для Hero-секции используется простой список без пагинации, т.к. количество активных баннеров для одной роли обычно 1-5 штук.

```json
[
  {
    "id": 1,
    "title": "Новая коллекция 2025",
    "subtitle": "Эксклюзивные новинки",
    "image_url": "/media/banners/2025/01/hero.webp",
    "image_alt": "Баннер новой коллекции",
    "cta_text": "Перейти в каталог",
    "cta_link": "/catalog"
  }
]
```

[Source: docs/epics/epic-17/epic-17.banner-management.md#api-design, адаптировано]

### Роли пользователей

```python
# Логика фильтрации (реализована в Banner.get_for_user)
# Гость: user is None → show_to_guests=True
# Authenticated (retail): show_to_authenticated=True
# Trainer: user.role == "trainer" → show_to_trainers=True
# Wholesale: user.role.startswith("wholesale") → show_to_wholesale=True
# Federation: user.role == "federation_rep" → show_to_federation=True
```

[Source: backend/apps/users/models.py#ROLE_CHOICES]

---

## Testing

### Требования

- **Framework**: `pytest` + `pytest-django`
- **Маркировка**: `@pytest.mark.integration` для integration-тестов
- **Генерация данных**: `Factory Boy` (BannerFactory, UserFactory)
- **Покрытие**: минимум 80% для endpoints

[Source: docs/architecture/10-testing-strategy.md#integration-tests]

### Структура тестов

```text
backend/tests/integration/test_banners_api.py
```

### Команды для запуска тестов

```bash
# Запустить integration-тесты
pytest -m integration

# Запустить только тесты баннеров
pytest tests/integration/test_banners_api.py -v

# С покрытием
pytest tests/integration/test_banners_api.py --cov=apps.banners --cov-report=term-missing
```

### Паттерн теста

```python
import pytest
from rest_framework import status
from rest_framework.test import APIClient
from django.urls import reverse
from apps.banners.factories import BannerFactory
from apps.users.factories import UserFactory

@pytest.mark.integration
@pytest.mark.django_db
class TestBannersAPI:
    """Integration-тесты API баннеров"""
    
    def setup_method(self):
        self.client = APIClient()
        self.url = '/api/banners/'
    
    def test_guest_gets_guest_banners(self):
        """Гость получает только баннеры с show_to_guests=True"""
        guest_banner = BannerFactory(show_to_guests=True, title="Guest Banner")
        auth_banner = BannerFactory(show_to_authenticated=True, title="Auth Banner")
        
        response = self.client.get(self.url)
        
        assert response.status_code == status.HTTP_200_OK
        titles = [b['title'] for b in response.json()]
        assert "Guest Banner" in titles
        assert "Auth Banner" not in titles
    
    def test_wholesale_user_gets_wholesale_banners(self):
        """Оптовик получает баннеры с show_to_wholesale=True"""
        user = UserFactory(role="wholesale_level2")
        self.client.force_authenticate(user=user)
        
        BannerFactory(show_to_wholesale=True, title="Wholesale Banner")
        BannerFactory(show_to_guests=True, title="Guest Only")
        
        response = self.client.get(self.url)
        
        assert response.status_code == status.HTTP_200_OK
        titles = [b['title'] for b in response.json()]
        assert "Wholesale Banner" in titles
```

[Source: docs/architecture/10-testing-strategy.md#backend-api-test]

---

## Change Log

| Date       | Version | Description                              | Author     |
|------------|---------|------------------------------------------|------------|
| 2025-12-19 | 0.1     | Initial story draft created              | Bob (SM)   |
| 2025-12-19 | 0.2     | Валидация: URL → /api/banners/, response без пагинации, добавлен image_alt и edge case тест | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_TBD - populated by dev agent_

### Debug Log References

_TBD - populated by dev agent_

### Completion Notes List

_TBD - populated by dev agent_

### File List

_TBD - populated by dev agent_

---

## QA Results

_TBD - populated by QA agent_
