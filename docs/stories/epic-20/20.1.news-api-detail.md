# Story 20.1: Backend API для детальной новости

## Status

**Ready for Review**

---

## Story

**As a** пользователь фронтенда,
**I want** получать детальную информацию о новости по её slug,
**so that** я могу просмотреть полное содержание новости на детальной странице.

---

## Acceptance Criteria

1. **AC1:** Endpoint `GET /api/v1/news/{slug}/` возвращает детальную информацию о новости
2. **AC2:** Endpoint возвращает только опубликованные новости (`is_published=True`, `published_at <= now()`)
3. **AC3:** Возвращается HTTP 404 если новость не найдена или не опубликована
4. **AC4:** Endpoint не требует аутентификации (AllowAny)
5. **AC5:** Ответ содержит все поля: id, title, slug, excerpt, content, image, published_at, created_at, updated_at, author, category
6. **AC6:** Image преобразуется в полный URL (как в NewsListView)
7. **AC7:** Endpoint задокументирован через drf-spectacular (@extend_schema)
8. **AC8:** Написаны unit-тесты с покрытием ≥70%

---

## Tasks / Subtasks

- [x] **Task 1: Создать NewsDetailView** (AC: 1, 2, 3, 4, 6)
  - [x] Создать класс `NewsDetailView(generics.RetrieveAPIView)` в `backend/apps/common/views.py`
  - [x] Использовать существующий `NewsSerializer` (тот же что и для списка)
  - [x] Переопределить `get_queryset()` для фильтрации по `is_published=True` и `published_at__lte=now()`
  - [x] Установить `lookup_field = "slug"` для поиска по slug вместо pk
  - [x] Установить `permission_classes = [AllowAny]`

- [x] **Task 2: Добавить маршрут в urls.py** (AC: 1)
  - [x] Добавить путь `path("news/<slug:slug>/", views.NewsDetailView.as_view(), name="news-detail")` в `backend/apps/common/urls.py`
  - [x] Разместить рядом с `path("news/", ...)` для логической группировки (порядок некритичен — маршруты не конфликтуют)

- [x] **Task 3: Документация API через drf-spectacular** (AC: 7)
  - [x] Добавить декоратор `@extend_schema()` с summary, description, responses
  - [x] Добавить `OpenApiExample` для успешного ответа
  - [x] Добавить `OpenApiResponse` для 404 ошибки
  - [x] Тег: `"News"` (ориентироваться на реализацию `NewsListView` в `backend/apps/common/views.py`, строки 550-573 для примера структуры `extend_schema`)

- [x] **Task 4: Unit-тесты** (AC: 8)
  - [x] Создать файл `backend/tests/unit/apps/common/test_news_detail_view.py`
  - [x] Тест: успешное получение опубликованной новости по slug
  - [x] Тест: 404 при несуществующем slug
  - [x] Тест: 404 при неопубликованной новости (`is_published=False`)
  - [x] Тест: 404 при новости с будущей датой публикации
  - [x] Тест: проверка структуры ответа (все поля присутствуют)
  - [x] Тест: проверка преобразования image в URL
  - [x] Тест: проверка category в детальном формате
  - [x] Тест: проверка category=None (новость без категории)

- [x] **Task 5: Проверка интеграции**
  - [x] Запустить тесты: `docker compose exec backend pytest tests/unit/apps/common/test_news_detail_view.py -v`
  - [x] Проверить документацию через Swagger UI

---

## Dev Notes

### Existing Code Context

**Модель News** (`backend/apps/common/models.py`, lines 529-621):

```python
class News(models.Model):
    title = models.CharField("Заголовок", max_length=200, db_index=True)
    slug = models.SlugField("URL-идентификатор", max_length=200, unique=True, db_index=True)
    excerpt = models.TextField("Краткое описание", blank=True)
    content = models.TextField("Содержание")
    image = models.ImageField("Изображение", upload_to="news/images/%Y/%m/%d/", blank=True, null=True)
    author = models.CharField("Автор", max_length=100, blank=True)
    category = models.ForeignKey(Category, on_delete=models.CASCADE, related_name="news", null=True, blank=True)
    is_published = models.BooleanField("Опубликовано", default=False, db_index=True)
    published_at = models.DateTimeField("Дата публикации", null=True, blank=True)
    created_at = models.DateTimeField("Дата создания", auto_now_add=True)
    updated_at = models.DateTimeField("Дата обновления", auto_now_add=True)
```

[Source: apps/common/models.py#News]

**Существующий NewsListView** (`backend/apps/common/views.py`, lines 554-573):

```python
class NewsListView(generics.ListAPIView):
    serializer_class = NewsSerializer
    permission_classes = [AllowAny]

    def get_queryset(self):
        return News.objects.filter(
            is_published=True,
            published_at__lte=timezone.now(),
        ).order_by("-published_at")
```

[Source: apps/common/views.py#NewsListView]

**Существующий NewsSerializer** (`backend/apps/common/serializers.py`, lines 142-192):

- Использует все поля модели News
- Преобразует `image` в полный URL через `request.build_absolute_uri()`
- Преобразует `category` в детальный формат `{id, name, slug}`
[Source: apps/common/serializers.py#NewsSerializer]

**Текущие маршруты** (`backend/apps/common/urls.py`):

```python
urlpatterns = [
    # ...
    path("news/", views.NewsListView.as_view(), name="news-list"),
]
```

[Source: apps/common/urls.py]

### Implementation Pattern

Следовать паттерну `NewsListView`:

1. Использовать `generics.RetrieveAPIView` для единственного объекта
2. Установить `lookup_field = "slug"`
3. Переопределить `get_queryset()` с теми же фильтрами
4. Добавить `@extend_schema()` декоратор для документации

### File Locations

| Файл | Действие |
|------|----------|
| `backend/apps/common/views.py` | Добавить `NewsDetailView` класс |
| `backend/apps/common/urls.py` | Добавить маршрут `news/<slug:slug>/` |
| `backend/tests/unit/apps/common/test_news_detail_view.py` | [NEW] Создать тесты |

### Response Payload Structure

Пример успешного JSON-ответа (соответствует `NewsSerializer`):

```json
{
  "id": 42,
  "title": "Новый релиз FREESPORT",
  "slug": "release-2025",
  "excerpt": "Краткое описание новости",
  "content": "<p>Полное содержание...</p>",
  "image": "https://example.com/media/news/images/2025/12/26/cover.jpg",
  "published_at": "2025-12-26T09:00:00Z",
  "created_at": "2025-12-25T18:00:00Z",
  "updated_at": "2025-12-25T18:30:00Z",
  "author": "Редакция FREESPORT",
  "category": {
    "id": 3,
    "name": "Анонсы",
    "slug": "announcements"
  }
}
```

> Источник: `backend/apps/common/serializers.py#142-192`

---

## Testing

### Testing Standards

- **Framework:** pytest + pytest-django
- **Структура тестов:** `backend/tests/unit/apps/{app_name}/`
- **Паттерн именования:** `test_{functionality}.py`
- **Minimum coverage:** 70%

### Test Commands

```bash
# Запуск тестов для этой истории
docker compose exec backend pytest tests/unit/apps/common/test_news_detail_view.py -v

# С покрытием
docker compose exec backend pytest tests/unit/apps/common/test_news_detail_view.py --cov=apps.common.views

# Все тесты common app
docker compose exec backend pytest tests/unit/apps/common/ -v
```

### Test Data Requirements

- Создать `News` объект с `is_published=True` и `published_at` в прошлом
- Создать `News` объект с `is_published=False`
- Создать `News` объект с `published_at` в будущем
- Для `category` и связанных данных можно использовать `CategoryFactory` из `backend/tests/factories.py` либо фикстуру `CategoryFactory` из `backend/tests/conftest.py` (см. строки 249-275)
- Для генерации изображений допускается использовать `SimpleUploadedFile` в тесте или общий хелпер из существующих тестов `apps.common`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Initial story draft | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used

Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

- Все тесты прошли успешно с первой попытки
- Исправлено форматирование кода (Black, isort)
- Flake8 проверка пройдена без ошибок

### Completion Notes List

- ✅ NewsDetailView успешно создан и протестирован
- ✅ Все 9 unit-тестов успешно прошли
- ✅ Endpoint `GET /api/v1/news/{slug}/` работает корректно
- ✅ Документация API добавлена через @extend_schema
- ✅ Покрытие кода тестами: NewsDetailView полностью покрыт
- ✅ Все Acceptance Criteria выполнены (AC1-AC8)

### File List

**Modified:**
- `backend/apps/common/views.py` - Добавлен `NewsDetailView` класс (строки 576-647)
- `backend/apps/common/urls.py` - Добавлен маршрут `news/<slug:slug>/` (строка 26)

**Created:**
- `backend/tests/unit/apps/common/test_news_detail_view.py` - Unit-тесты для NewsDetailView (9 тестов, все прошли)

---

## QA Results

_To be filled by QA Agent_
