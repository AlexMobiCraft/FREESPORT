# Story 15.3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

> **Epic**: [Epic 15 - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å](../../epics/epic-15/epic-15.admin-image-update.md)
> **–°–æ–∑–¥–∞–Ω–æ**: 2025-11-26
> **–°—Ç–∞—Ç—É—Å**: üìã Approved
> **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: Story 15.1 –∏ Story 15.2 –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω—ã

---

## Status

**Current Status**: Approved

---

## Story

**As a** –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã,
**I want** –≤–∏–¥–µ—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ —Å–ø–∏—Å–∫–µ —Å–µ—Å—Å–∏–π `ImportSessionAdmin` —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º,
**so that** —è –º–æ–≥—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## Acceptance Criteria

1. –ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ —Å–µ—Å—Å–∏–π —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
2. –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
3. –¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç: —É—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–æ–≤–∞—Ä–æ–≤, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
4. Coverage >= 80% –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
6. –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∏–ø—ã –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (regression tests)
7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `import_files/` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∏–º–ø–æ—Ä—Ç–∞
8. E2E —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow: —Ñ–æ—Ä–º–∞ ‚Üí Celery ‚Üí –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

---

## Tasks / Subtasks

- [ ] **Task 1: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files –≤ _create_and_run_import()** (AC: 7)
  - [ ] –†–∞—Å—à–∏—Ä–∏—Ç—å `_create_and_run_import()` ([views.py:164-258](../../../backend/apps/integrations/views.py#L164-L258))
  - [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ç–∫—É –¥–ª—è —Ç–∏–ø–∞ "images":
    ```python
    elif import_type == "images":
        if not (data_path / "goods" / "import_files").exists():
            raise FileNotFoundError(
                f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {data_path / 'goods' / 'import_files'}. "
                f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –∏–∑ 1–°."
            )
    ```
  - [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –î–û —Å–æ–∑–¥–∞–Ω–∏—è ImportSession
  - [ ] –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç –¥–ª—è —ç—Ç–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏

- [ ] **Task 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å ImportSessionAdmin** (AC: 1, 2)
  - [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ `ImportType.IMAGES` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É `colored_status()` –¥–ª—è —Å–µ—Å—Å–∏–π —Ç–∏–ø–∞ "images"
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É `celery_task_status()` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è Celery –∑–∞–¥–∞—á–∏
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç `duration()` –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
  - [ ] **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å `progress_display()` –¥–ª—è —Ç–∏–ø–∞ "images":
    - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `report_details["total_products"]` –≤–º–µ—Å—Ç–æ `total_items`
    - [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `report_details["processed"]` –≤–º–µ—Å—Ç–æ `processed_items`
    - [ ] –ï—Å–ª–∏ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è - –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è (–¥–æ–ø—É—Å—Ç–∏–º–æ)

- [ ] **Task 3: –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–π** (AC: 3)
  - [ ] **–¢–µ—Å—Ç: —É—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
    - [ ] –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Å `onec_id`
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `import_files/` —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=images`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ ImportSession —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º STARTED
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ Celery –∑–∞–¥–∞—á–∏
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å COMPLETED

  - [ ] **–¢–µ—Å—Ç: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ë–î**
    - [ ] –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É Product
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=images`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –æ—à–∏–±–∫–æ–π
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ImportSession –ù–ï —Å–æ–∑–¥–∞–Ω–∞

  - [ ] **–¢–µ—Å—Ç: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files**
    - [ ] –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `import_files/`
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=images`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `FileNotFoundError` —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ ImportSession –ù–ï —Å–æ–∑–¥–∞–Ω–∞

- [ ] **Task 4: –°–æ–∑–¥–∞—Ç—å E2E —Ç–µ—Å—Ç—ã –ø–æ–ª–Ω–æ–≥–æ flow** (AC: 8)
  - [ ] **E2E —Ç–µ—Å—Ç: –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
    - [ ] –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    - [ ] GET –∑–∞–ø—Ä–æ—Å –Ω–∞ `/admin/integrations/import_1c/`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–∏–ø–∞ "images" –≤ —Ñ–æ—Ä–º–µ
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å –≤—ã–±–æ—Ä–æ–º "images"
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ ImportSession
    - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å Celery –∑–∞–¥–∞—á—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (eager mode)
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ImportSession —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GET `/admin/integrations/session/` - —Å–µ—Å—Å–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å COMPLETED

  - [ ] **E2E —Ç–µ—Å—Ç: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≤ Celery –∑–∞–¥–∞—á–µ**
    - [ ] –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å `ProductDataProcessor` –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å ImportSession = FAILED
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `error_message` –≤ —Å–µ—Å—Å–∏–∏

- [ ] **Task 5: Regression —Ç–µ—Å—Ç—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∏–ø–æ–≤** (AC: 6)
  - [ ] **Regression —Ç–µ—Å—Ç: catalog —Ç–∏–ø —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ**
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=catalog`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å —Ç–∏–ø–æ–º CATALOG
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è "images" –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ catalog

  - [ ] **Regression —Ç–µ—Å—Ç: stocks —Ç–∏–ø —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–≤–∞—Ä—ã**
    - [ ] –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É Product
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=stocks`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—à–∏–±–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    - [ ] –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=stocks`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏

  - [ ] **Regression —Ç–µ—Å—Ç: prices —Ç–∏–ø —Ä–∞–±–æ—Ç–∞–µ—Ç**
    - [ ] –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=prices`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å —Ç–∏–ø–æ–º PRICES

  - [ ] **Regression —Ç–µ—Å—Ç: customers —Ç–∏–ø —Ä–∞–±–æ—Ç–∞–µ—Ç**
    - [ ] POST –∑–∞–ø—Ä–æ—Å —Å `import_type=customers`
    - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å —Ç–∏–ø–æ–º CUSTOMERS

- [ ] **Task 6: Coverage –∞–Ω–∞–ª–∏–∑ –∏ gap filling** (AC: 4)
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `pytest --cov=apps/integrations --cov=apps/products`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å coverage –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞:
    - [ ] `views.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files
    - [ ] `tasks.py` - —Ñ—É–Ω–∫—Ü–∏—è `_run_image_import()`
    - [ ] `tasks.py` - –≤–µ—Ç–∫–∞ "images" –≤ `_execute_import_type()`
    - [ ] `models.py` - –Ω–æ–≤—ã–π enum `ImportType.IMAGES`
  - [ ] –ï—Å–ª–∏ coverage < 80% - –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–µ—Å—Ç—ã
  - [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTML –æ—Ç—á–µ—Ç: `pytest --cov-report=html`

- [ ] **Task 7: –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** (AC: 5)
  - [ ] **–û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md**:
    - [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    - [ ] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç `report_details` –¥–ª—è —Ç–∏–ø–∞ "images"
    - [ ] –î–æ–±–∞–≤–∏—Ç—å troubleshooting —Å–µ–∫—Ü–∏—é
  - [ ] **–û–±–Ω–æ–≤–∏—Ç—å Epic 15**:
    - [ ] –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö 3 stories
    - [ ] –û–±–Ω–æ–≤–∏—Ç—å Definition of Done
  - [ ] **–°–æ–∑–¥–∞—Ç—å README –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
    - [ ] –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    - [ ] –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è
    - [ ] –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π

- [ ] **Task 8: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ cleanup**
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã: `make test`
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä—ã: `make lint`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å type hints: `mypy apps/`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: `python manage.py makemigrations --check`
  - [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `make format`
  - [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ TODO/FIXME –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ
  - [ ] Code review checklist –ø—Ä–æ–π–¥–µ–Ω

---

## Dev Notes

### Relevant Source Tree

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```
backend/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py:164-258           # _create_and_run_import() - –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py:207-235           # progress_display() - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ test_views.py          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã views
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ test_tasks.py          # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã tasks
‚îÇ   ‚îî‚îÄ‚îÄ products/
‚îÇ       ‚îî‚îÄ‚îÄ tests/
‚îÇ           ‚îî‚îÄ‚îÄ test_models.py         # –¢–µ—Å—Ç—ã –º–æ–¥–µ–ª–∏ ImportSession
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ CLAUDE.md                       # –û–±–Ω–æ–≤–∏—Ç—å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
    ‚îî‚îÄ‚îÄ epics/epic-15/
        ‚îî‚îÄ‚îÄ epic-15.admin-image-update.md  # –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
```

**–§–∞–π–ª—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `CLAUDE.md`
- Epic 15 —Å—Ç–∞—Ç—É—Å
- Coverage –æ—Ç—á–µ—Ç

---

### Existing System Integration

**1. ImportSessionAdmin –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** ([admin.py:14-236](../../../backend/apps/integrations/admin.py#L14-L236)):

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã**:

- `colored_status()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ ImportSession
- `celery_task_status()` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç Celery –∑–∞–¥–∞—á–∏ —á–µ—Ä–µ–∑ AsyncResult
- `duration()` - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞
- `progress_display()` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (—Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏)

**Progress display —Ç–µ–∫—É—â–∞—è –ª–æ–≥–∏–∫–∞** ([admin.py:207-235](../../../backend/apps/integrations/admin.py#L207-L235)):
```python
def progress_display(self, obj: Session) -> str:
    if obj.status == "in_progress" and obj.report_details:
        total = obj.report_details.get("total_items", 0)      # ‚Üê –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        processed = obj.report_details.get("processed_items", 0)  # ‚Üê –ù–ï —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        # ...
```

**Story 15.2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–∏–µ –∫–ª—é—á–∏**:
```python
report_details = {
    "total_products": count,     # ‚Üê –í–º–µ—Å—Ç–æ "total_items"
    "processed": processed_count, # ‚Üê –í–º–µ—Å—Ç–æ "processed_items"
    # ...
}
```

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è**:

**–í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**: –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å `progress_display()` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
```python
def progress_display(self, obj: Session) -> str:
    if obj.status == "in_progress" and obj.report_details:
        # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
        total = obj.report_details.get("total_items") or obj.report_details.get("total_products", 0)
        processed = obj.report_details.get("processed_items") or obj.report_details.get("processed", 0)

        if total > 0:
            # ... –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
```

**–í–∞—Ä–∏–∞–Ω—Ç B**: –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è —Ç–∏–ø–∞ "images" (–¥–æ–ø—É—Å—Ç–∏–º–æ, —Å—Ç–∞—Ç—É—Å –∏ duration –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)

---

**2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –≤ _create_and_run_import()** ([views.py:198-227](../../../backend/apps/integrations/views.py#L198-L227)):

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω**:
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞
if import_type == "catalog":
    required_subdirs = ["goods", "offers", "prices", "rests"]
    missing_subdirs = [
        subdir for subdir in required_subdirs if not (data_path / subdir).exists()
    ]
    if missing_subdirs:
        raise FileNotFoundError(
            f"–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ {data_dir}: "
            f"{', '.join(missing_subdirs)}. "
            f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –∏–∑ 1–° –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ."
        )
elif import_type == "stocks":
    if not (data_path / "rests").exists():
        raise FileNotFoundError(...)
```

**–î–æ–±–∞–≤–∏—Ç—å –¥–ª—è "images"**:
```python
elif import_type == "images":
    import_files_dir = data_path / "goods" / "import_files"
    if not import_files_dir.exists():
        raise FileNotFoundError(
            f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {import_files_dir}. "
            f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –∏–∑ 1–° —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤."
        )
```

---

**3. –§–æ—Ä–º–∞—Ç report_details –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤**:

**Catalog**:
```json
{
  "total_items": 1000,
  "processed_items": 1000,
  "created": 500,
  "updated": 400,
  "skipped": 100,
  "errors": 0
}
```

**Images** (–∏–∑ Story 15.2):
```json
{
  "total_products": 1000,
  "processed": 1000,
  "copied": 2500,
  "skipped": 100,
  "errors": 5,
  "last_updated": "2025-11-26T12:34:56"
}
```

**Customers**:
```json
{
  "total_customers": 500,
  "created": 300,
  "updated": 150,
  "skipped": 50,
  "errors": 0
}
```

**–í—ã–≤–æ–¥**: –ö–∞–∂–¥—ã–π —Ç–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π —Ñ–æ—Ä–º–∞—Ç, –Ω–æ –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤—Å–µ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

---

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

#### 1. E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Celery eager mode

**–ü–∞—Ç—Ç–µ—Ä–Ω**:
```python
import pytest
from django.test import TestCase, override_settings
from django.contrib.auth import get_user_model
from apps.products.models import ImportSession


@pytest.mark.integration
@override_settings(CELERY_TASK_ALWAYS_EAGER=True)
class TestImageImportE2E(TestCase):
    """E2E —Ç–µ—Å—Ç—ã –ø–æ–ª–Ω–æ–≥–æ flow –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π."""

    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
        self.client = Client()
        self.admin_user = get_user_model().objects.create_superuser(
            email="admin@test.com",
            password="testpass123"
        )
        self.client.force_login(self.admin_user)

    @patch("pathlib.Path.exists", return_value=True)
    @patch("apps.integrations.tasks.ProductDataProcessor")
    def test_full_image_import_flow(self, mock_processor_class, mock_path_exists):
        """
        –ü–æ–ª–Ω—ã–π E2E —Ç–µ—Å—Ç: —Ñ–æ—Ä–º–∞ ‚Üí POST ‚Üí Celery ‚Üí ImportSession –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.
        """
        # 1. –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
        from apps.products.tests.factories import ProductFactory
        ProductFactory.create_batch(3)

        # 2. Mock processor
        mock_processor = mock_processor_class.return_value
        mock_processor.import_product_images.return_value = {
            "copied": 2,
            "skipped": 0,
            "errors": 0,
        }

        # 3. GET —Ñ–æ—Ä–º—É –∏–º–ø–æ—Ä—Ç–∞
        response = self.client.get("/admin/integrations/import_1c/")
        assert response.status_code == 200
        assert "images" in str(response.content)

        # 4. POST –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–º–ø–æ—Ä—Ç
        response = self.client.post(
            "/admin/integrations/import_1c/",
            {"import_type": "images"}
        )

        # 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç
        assert response.status_code == 302

        # 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        session = ImportSession.objects.filter(
            import_type=ImportSession.ImportType.IMAGES
        ).first()

        assert session is not None
        assert session.celery_task_id is not None

        # 7. Celery –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (eager mode)
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        session.refresh_from_db()

        # 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.finished_at is not None
        assert session.report_details["total_products"] == 3
        assert session.report_details["processed"] == 3
        assert session.report_details["copied"] == 6  # 3 —Ç–æ–≤–∞—Ä–∞ * 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```

---

#### 2. Regression —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü–∞—Ç—Ç–µ—Ä–Ω**:
```python
@pytest.mark.integration
@override_settings(CELERY_TASK_ALWAYS_EAGER=True)
class TestExistingImportTypesRegression(TestCase):
    """Regression —Ç–µ—Å—Ç—ã: –Ω–æ–≤—ã–π —Ç–∏–ø –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ."""

    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
        self.client = Client()
        self.admin_user = get_user_model().objects.create_superuser(
            email="admin@test.com",
            password="testpass123"
        )
        self.client.force_login(self.admin_user)

    @patch("apps.integrations.tasks.call_command")
    def test_catalog_import_still_works(self, mock_call_command):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞: –∏–º–ø–æ—Ä—Ç catalog —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–∞ images."""
        # POST –∑–∞–ø—Ä–æ—Å –¥–ª—è catalog
        response = self.client.post(
            "/admin/integrations/import_1c/",
            {"import_type": "catalog"}
        )

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        session = ImportSession.objects.filter(
            import_type=ImportSession.ImportType.CATALOG
        ).first()

        assert session is not None
        assert session.celery_task_id is not None

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ call_command –±—ã–ª –≤—ã–∑–≤–∞–Ω –¥–ª—è catalog
        mock_call_command.assert_called_with(
            "import_catalog_from_1c",
            "--file-type",
            "all"
        )
```

---

#### 3. Coverage –∞–Ω–∞–ª–∏–∑

**–ö–æ–º–∞–Ω–¥—ã**:
```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö app
pytest --cov=apps/integrations --cov=apps/products \
       --cov-report=term-missing \
       --cov-report=html

# –ü—Ä–æ–≤–µ—Ä–∫–∞ coverage –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
pytest --cov=apps/integrations/views \
       --cov=apps/integrations/tasks \
       --cov-report=term-missing

# HTML –æ—Ç—á–µ—Ç
pytest --cov=apps/integrations --cov-report=html
# –û—Ç–∫—Ä—ã—Ç—å htmlcov/index.html
```

**–ê–Ω–∞–ª–∏–∑ gaps**:
```python
# –ù–∞–π—Ç–∏ –Ω–µ–æ—Ö–≤–∞—á–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ coverage –æ—Ç—á–µ—Ç–µ
# –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è:
# - Error handling paths
# - Edge cases (–ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏, None –∑–Ω–∞—á–µ–Ω–∏—è)
# - –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

---

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **Progress display - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞**:
   - –ï—Å–ª–∏ –Ω–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å - –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –¥–ª—è "images"
   - –°—Ç–∞—Ç—É—Å, Celery task status –∏ duration –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã feature

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files**:
   - –î–û–õ–ñ–ù–ê –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ `_create_and_run_import()` –î–û —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏
   - –ò–Ω–∞—á–µ —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞—Å—Ç—Å—è, –∞ Celery –∑–∞–¥–∞—á–∞ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π
   - –õ—É—á—à–µ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Ä–∞–∑—É

3. **E2E —Ç–µ—Å—Ç—ã —Å Celery**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `CELERY_TASK_ALWAYS_EAGER=True` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π flow –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ Celery worker
   - –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (—Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)

4. **Regression —Ç–µ—Å—Ç—ã –∫—Ä–∏—Ç–∏—á–Ω—ã**:
   - Epic 15 –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–µ
   - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ catalog, stocks, prices, customers –Ω–µ —Å–ª–æ–º–∞–ª–∏—Å—å
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

5. **Coverage —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è**:
   - >= 80% –¥–ª—è –ù–û–í–û–ì–û –∫–æ–¥–∞ (views.py –ø—Ä–æ–≤–µ—Ä–∫–∞, tasks.py —Ñ—É–Ω–∫—Ü–∏—è)
   - –î–æ–ø—É—Å—Ç–∏–º–æ –µ—Å–ª–∏ –û–ë–©–ò–ô coverage –Ω–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∑–∏–ª—Å—è –∏–∑-–∑–∞ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
   - –ì–ª–∞–≤–Ω–æ–µ - –Ω–æ–≤—ã–π –∫–æ–¥ —Ö–æ—Ä–æ—à–æ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏

---

### Testing

#### Testing Standards

**Framework**: Pytest 7.4.3 + pytest-django 4.7.0

**Coverage target**: >= 80% –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞

**Test file locations**:
- `backend/apps/integrations/tests/test_views.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã views
- `backend/apps/integrations/tests/test_tasks.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã tasks
- `backend/apps/integrations/tests/test_e2e.py` - E2E —Ç–µ—Å—Ç—ã (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

**Pytest markers**:
- `@pytest.mark.unit` - unit-—Ç–µ—Å—Ç—ã
- `@pytest.mark.integration` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `@pytest.mark.slow` - –º–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (E2E)

---

#### Testing Patterns

**1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏**

```python
import pytest
from django.test import TestCase
from unittest.mock import patch
from apps.integrations.views import _create_and_run_import


@pytest.mark.integration
class TestImageImportDirectoryValidation(TestCase):
    """–¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ import_files."""

    @patch("pathlib.Path.exists")
    @patch("apps.integrations.views.run_selective_import_task")
    def test_images_import_fails_if_directory_missing(
        self, mock_task, mock_path_exists
    ):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ FileNotFoundError –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ import_files."""
        # Mock: –æ—Å–Ω–æ–≤–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –µ—Å—Ç—å, –Ω–æ import_files –Ω–µ—Ç
        def path_exists_side_effect(path_obj):
            path_str = str(path_obj)
            if "import_files" in path_str:
                return False
            return True

        mock_path_exists.side_effect = path_exists_side_effect

        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç
        with pytest.raises(FileNotFoundError) as exc_info:
            _create_and_run_import("images")

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        assert "import_files" in str(exc_info.value)
        assert "–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞" in str(exc_info.value)

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Celery –∑–∞–¥–∞—á–∞ –ù–ï –∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å
        mock_task.delay.assert_not_called()

    @patch("pathlib.Path.exists", return_value=True)
    @patch("apps.integrations.views.run_selective_import_task")
    def test_images_import_succeeds_if_directory_exists(
        self, mock_task, mock_path_exists
    ):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ import_files."""
        from apps.products.tests.factories import ProductFactory

        # –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        ProductFactory.create()

        mock_task.delay.return_value.id = "test-task-id"

        # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç
        session = _create_and_run_import("images")

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞
        assert session is not None
        assert session.import_type == "images"

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Celery –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞
        mock_task.delay.assert_called_once_with(["images"])
```

---

**2. E2E —Ç–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ flow —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º**

```python
import pytest
from django.test import TestCase, Client, override_settings
from django.contrib.auth import get_user_model
from django.urls import reverse
from unittest.mock import patch
from apps.products.models import Product, ImportSession
from apps.products.tests.factories import ProductFactory


@pytest.mark.slow
@pytest.mark.integration
@override_settings(CELERY_TASK_ALWAYS_EAGER=True)
class TestImageImportE2EWithMonitoring(TestCase):
    """E2E —Ç–µ—Å—Ç—ã –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""

    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
        self.client = Client()
        User = get_user_model()
        self.admin_user = User.objects.create_superuser(
            email="admin@test.com",
            password="testpass123"
        )
        self.client.force_login(self.admin_user)

    @patch("pathlib.Path.exists", return_value=True)
    @patch("pathlib.Path.glob")
    @patch("apps.integrations.tasks.ProductDataProcessor")
    def test_e2e_image_import_with_monitoring(
        self, mock_processor_class, mock_glob, mock_path_exists
    ):
        """
        E2E: —Ñ–æ—Ä–º–∞ ‚Üí POST ‚Üí Celery ‚Üí ImportSession ‚Üí admin list.
        """
        # 1. –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
        products = ProductFactory.create_batch(5)

        # 2. Mock glob –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        from unittest.mock import MagicMock
        mock_glob.return_value = [
            MagicMock(name="img1.jpg"),
            MagicMock(name="img2.jpg"),
        ]

        # 3. Mock processor
        mock_processor = mock_processor_class.return_value
        mock_processor.import_product_images.return_value = {
            "copied": 2,
            "skipped": 0,
            "errors": 0,
        }

        # 4. GET —Ñ–æ—Ä–º—É –∏–º–ø–æ—Ä—Ç–∞
        url_form = reverse("admin:integrations_import_from_1c")
        response = self.client.get(url_form)

        assert response.status_code == 200
        import_types = response.context["import_types"]
        images_type = next((t for t in import_types if t["value"] == "images"), None)
        assert images_type is not None

        # 5. POST –∑–∞–ø—Ä–æ—Å –Ω–∞ –∏–º–ø–æ—Ä—Ç
        response = self.client.post(url_form, {"import_type": "images"})

        # 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
        assert response.status_code == 302
        assert "integrations/session" in response.url

        # 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ ImportSession
        session = ImportSession.objects.filter(
            import_type=ImportSession.ImportType.IMAGES
        ).first()

        assert session is not None
        assert session.status == ImportSession.ImportStatus.STARTED

        # 8. Celery –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å (eager mode)
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é
        session.refresh_from_db()

        # 9. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        assert session.status == ImportSession.ImportStatus.COMPLETED
        assert session.finished_at is not None
        assert session.report_details["total_products"] == 5
        assert session.report_details["processed"] == 5
        assert session.report_details["copied"] == 10  # 5 * 2 images

        # 10. GET —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π —á–µ—Ä–µ–∑ admin
        url_list = reverse("admin:integrations_session_changelist")
        response = self.client.get(url_list)

        assert response.status_code == 200
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Å—Å–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
        assert str(session.id) in str(response.content)
        assert "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤" in str(response.content)
```

---

**3. Regression —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç–∞**

```python
@pytest.mark.integration
@override_settings(CELERY_TASK_ALWAYS_EAGER=True)
class TestAllImportTypesRegression(TestCase):
    """Comprehensive regression —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç–∞."""

    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö."""
        self.client = Client()
        User = get_user_model()
        self.admin_user = User.objects.create_superuser(
            email="admin@test.com",
            password="testpass123"
        )
        self.client.force_login(self.admin_user)

    @patch("apps.integrations.tasks.call_command")
    def test_all_import_types_create_sessions(self, mock_call_command):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç–∞."""
        from apps.products.tests.factories import ProductFactory

        # –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Ç–∏–ø–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö catalog
        ProductFactory.create()

        import_types = ["catalog", "stocks", "prices", "customers", "images"]

        for import_type in import_types:
            with self.subTest(import_type=import_type):
                # –ú–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è —Ç–∏–ø–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                if import_type == "images":
                    with patch("pathlib.Path.exists", return_value=True), \
                         patch("apps.integrations.tasks.ProductDataProcessor"):
                        response = self.client.post(
                            "/admin/integrations/import_1c/",
                            {"import_type": import_type}
                        )
                else:
                    response = self.client.post(
                        "/admin/integrations/import_1c/",
                        {"import_type": import_type}
                    )

                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç
                assert response.status_code == 302

                # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
                session = ImportSession.objects.filter(
                    import_type=import_type.upper()
                ).order_by("-started_at").first()

                assert session is not None, f"Session –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è {import_type}"
```

---

**4. –¢–µ—Å—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ progress_display –¥–ª—è images**

```python
@pytest.mark.unit
class TestProgressDisplayAdaptation(TestCase):
    """–¢–µ—Å—Ç—ã –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ progress_display –¥–ª—è —Ç–∏–ø–∞ images."""

    def test_progress_display_works_with_images_format(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ progress_display —Å —Ñ–æ—Ä–º–∞—Ç–æ–º report_details –¥–ª—è images."""
        from apps.integrations.admin import ImportSessionAdmin
        from apps.integrations.models import Session

        # –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é —Å —Ñ–æ—Ä–º–∞—Ç–æ–º images
        session = Session.objects.create(
            import_type="images",
            status="in_progress",
            report_details={
                "total_products": 100,
                "processed": 50,
                "copied": 120,
                "skipped": 5,
                "errors": 2,
            }
        )

        admin = ImportSessionAdmin(Session, admin.site)
        result = admin.progress_display(session)

        # –ï—Å–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
        # –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "-"
        # (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Task 2)

        # –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ—Å–ª–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ:
        if "total_products" in result or "50%" in result:
            assert "progress" in result or "50" in result
        else:
            assert result == "-"
```

---

**5. Coverage gap analysis —Ç–µ—Å—Ç**

```python
@pytest.mark.unit
class TestCoverageGaps(TestCase):
    """–¢–µ—Å—Ç—ã –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è edge cases –∏ error paths."""

    def test_run_image_import_handles_empty_onec_id(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ onec_id."""
        from apps.products.tests.factories import ProductFactory

        # –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä –±–µ–∑ onec_id
        product = ProductFactory.create(onec_id="")

        # ... —Ç–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ onec_id

    def test_import_session_with_none_report_details(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ None –≤ report_details."""
        from apps.integrations.models import Session

        session = Session.objects.create(
            import_type="images",
            status="started",
            report_details=None  # Edge case
        )

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ admin –º–µ—Ç–æ–¥—ã –Ω–µ –ø–∞–¥–∞—é—Ç
        from apps.integrations.admin import ImportSessionAdmin
        admin = ImportSessionAdmin(Session, admin.site)

        # –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–π
        admin.progress_display(session)
        admin.colored_status(session)
```

---

## Change Log

| Date       | Version | Description                                    | Author |
|------------|---------|------------------------------------------------|--------|
| 2025-11-26 | 1.0     | –°–æ–∑–¥–∞–Ω–∏–µ Story 15.3 –Ω–∞ –æ—Å–Ω–æ–≤–µ Epic 15          | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

### Debug Log References

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

### Completion Notes List

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

### File List

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ dev agent –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏_

---

## QA Results

_–ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ QA agent –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è_

---

## References

- [Epic 15: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å](../../epics/epic-15/epic-15.admin-image-update.md)
- [Story 15.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞ "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"](15.1.admin-images-import-type.md)
- [Story 15.2: Celery –∑–∞–¥–∞—á–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π](15.2.celery-task-image-import.md)
- [ImportSessionAdmin](../../../backend/apps/integrations/admin.py#L14-L236)
- [_create_and_run_import()](../../../backend/apps/integrations/views.py#L164-L258)
- [Coding Standards - Testing](../../architecture/coding-standards.md#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
