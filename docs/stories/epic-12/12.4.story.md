# Story 12.4: Карточки товаров и списки

## Status

Draft

## Prerequisites

- **Story 12.1 (Обновление дизайн-токенов)** - CSS переменные и Tailwind конфигурация должны быть обновлены
- **Story 12.2 (Миграция базовых UI компонентов)** - Button, Badge должны быть обновлены под новую палитру

## Story

**As a** Frontend разработчик,
**I want** создать компонент ProductCard с поддержкой grid/list/compact layouts и новой дизайн-системой v2.0,
**so that** карточки товаров FREESPORT соответствовали новой монохромной графитовой цветовой схеме, отображали правильные цены для разных ролей пользователей и обеспечивали единообразный визуальный стиль платформы.

## Acceptance Criteria

1. Компонент ProductCard создан с поддержкой grid layout согласно Design System v2.0:
   - Изображение товара с соотношением сторон 1:1
   - Бренд отображается text-body-s, text-text-secondary (#4D4D4D)
   - Название товара text-body-m, text-text-primary (#1B1B1B)
   - Цена text-title-m (20px), font-weight: 600, text-text-primary
   - CTA кнопка "В корзину" использует обновленный Button компонент
   - Radius карточки: 12px (rounded-default)
   - Shadow: 0 8px 24px rgba(15, 23, 42, 0.08)
   - Hover: shadow увеличивается, translateY(-2px)
   - Padding: 16px внутри карточки

2. Компонент ProductCard поддерживает list layout:
   - Горизонтальный layout с изображением слева (120x120px)
   - Информация о товаре справа от изображения
   - Цена и CTA кнопка справа
   - Gap между элементами: 16px
   - Адаптивный переход на grid layout на мобильных

3. Компонент ProductCard поддерживает compact layout для RecommendationsRow:
   - Фиксированная ширина: 180px
   - Изображение товара с соотношением сторон 1:1
   - Бренд: text-caption (12px), text-text-secondary
   - Название: text-body-s (14px), text-text-primary, line-clamp-2
   - Цена: text-body-m (16px), font-weight: 600
   - Без CTA кнопки "В корзину" (клик на карточку ведет на PDP)
   - Кнопка избранного: size 16px, top-1.5 right-1.5
   - Padding: 12px внутри карточки
   - Gap: 16px между карточками в ряду

4. Бейджи товаров реализованы согласно Design System v2.0:
   - SALE: bg #F9E1E1, text #A63232
   - NEW: bg #E1F0FF, text #0F5DA3
   - HIT: bg #E3F6EC, text #1F7A4A
   - Position: absolute top-2 left-2 в grid/compact, inline в list
   - Shape: rounded-full, padding 4px 8px
   - Font: text-caption (12px), font-weight: 500

5. Кнопка "В избранное" реализована:
   - Icon Heart из lucide-react, size 20px (16px для compact)
   - Position: absolute top-2 right-2 (top-1.5 right-1.5 для compact)
   - Default: text-neutral-600 (#7D7D7D)
   - Hover/Active: text-[#A63232] (цвет sale)
   - Filled state для добавленных в избранное
   - aria-label="Добавить в избранное"

6. Ролевое ценообразование реализовано:
   - B2C пользователи видят retail_price
   - B2B пользователи видят соответствующую оптовую цену (opt1/opt2/opt3)
   - Тренеры видят trainer_price
   - B2B пользователи видят RRP/MSRP информацию (если showRRP/showMSRP = true)
   - Старая цена зачеркнута (line-through) при наличии скидки
   - Процент скидки отображается в Badge "sale"

7. Адаптивные стили реализованы:
   - Desktop: 4 карточки в ряд (grid-cols-4)
   - Tablet: 3 карточки в ряд (grid-cols-3)
   - Mobile: 2 карточки в ряд (grid-cols-2)
   - Gap между карточками: 16px

8. Все компоненты проходят accessibility проверку:
   - Контраст текста >= 4.5:1 (WCAG 2.1 AA)
   - Focus состояния видимы и соответствуют спецификации
   - aria-* атрибуты корректны
   - Keyboard navigation работает
   - alt текст для изображений товаров

9. Тесты созданы и проходят успешно:
   - Unit тесты для всех вариантов отображения (grid/list/compact)
   - Тесты ролевого ценообразования
   - Тесты accessibility атрибутов
   - Покрытие >= 80%

10. Документация компонента обновлена:
    - JSDoc комментарии
    - Props interface с описаниями
    - Примеры использования

## Tasks / Subtasks

- [ ] Task 1: Создание базовой структуры компонента ProductCard (AC: 1, 10)
  - [ ] 1.1 Создать директорию `frontend/src/components/business/ProductCard/`
  - [ ] 1.2 Создать файл `ProductCard.tsx` с базовым интерфейсом:
    ```typescript
    interface ProductCardProps {
      product: Product
      layout?: 'grid' | 'list' | 'compact'  // default: 'grid'
      mode?: 'b2c' | 'b2b'                   // default: 'b2c'
      userRole?: UserRole                    // default: 'retail'
      showRRP?: boolean
      showMSRP?: boolean
      onAddToCart?: (productId: number) => void
      onToggleFavorite?: (productId: number) => void
      isFavorite?: boolean
      className?: string
    }
    ```
  - [ ] 1.3 Добавить JSDoc комментарии к интерфейсу и компоненту
  - [ ] 1.4 Создать index.ts для экспорта компонента

- [ ] Task 2: Реализация Grid layout карточки (AC: 1)
  - [ ] 2.1 Создать контейнер карточки:
    - bg-white, rounded-[12px] (rounded-default)
    - shadow-[0_8px_24px_rgba(15,23,42,0.08)]
    - hover:shadow-[0_10px_32px_rgba(15,23,42,0.12)]
    - hover:translate-y-[-2px]
    - transition-all duration-[180ms] ease-[cubic-bezier(0.4,0,0.2,1)]
    - overflow-hidden
  - [ ] 2.2 Реализовать блок изображения:
    - aspect-square для соотношения 1:1
    - relative для позиционирования badge и favorite
    - Next.js Image component с fill и object-cover
    - Placeholder изображение при отсутствии
  - [ ] 2.3 Реализовать информационный блок:
    - Padding: p-4 (16px)
    - Бренд: text-body-s, text-text-secondary
    - Название: text-body-m, text-text-primary, line-clamp-2
    - Цена: text-title-m (20px), font-semibold
  - [ ] 2.4 Реализовать CTA блок:
    - Button компонент с variant="primary", size="medium"
    - Полная ширина: w-full
    - Текст: "В корзину"

- [ ] Task 3: Реализация List layout карточки (AC: 2)
  - [ ] 3.1 Создать горизонтальный контейнер:
    - flex, gap-4 (16px)
    - p-4 padding
    - Те же shadow и hover эффекты что и grid
  - [ ] 3.2 Реализовать блок изображения для list:
    - w-[120px], h-[120px], flex-shrink-0
    - rounded-[8px], overflow-hidden
  - [ ] 3.3 Реализовать информационный блок:
    - flex-1, flex flex-col justify-between
    - Бренд, название, краткое описание
  - [ ] 3.4 Реализовать блок цены и CTA:
    - flex flex-col items-end gap-2
    - Цена сверху, кнопка снизу
  - [ ] 3.5 Добавить адаптивный переход на grid для мобильных:
    - Использовать breakpoint sm (640px)
    - Условный рендеринг или CSS media queries

- [ ] Task 4: Реализация Compact layout карточки (AC: 3)
  - [ ] 4.1 Создать контейнер карточки для compact:
    - w-[180px], flex-shrink-0
    - bg-white, rounded-[12px]
    - Те же shadow и hover эффекты что и grid
    - cursor-pointer (вся карточка кликабельна)
  - [ ] 4.2 Реализовать блок изображения:
    - aspect-square для соотношения 1:1
    - relative для позиционирования badge и favorite
  - [ ] 4.3 Реализовать информационный блок:
    - Padding: p-3 (12px)
    - Бренд: text-caption (12px), text-text-secondary
    - Название: text-body-s (14px), text-text-primary, line-clamp-2
    - Цена: text-body-m (16px), font-semibold
  - [ ] 4.4 Кнопка избранного для compact:
    - size: 16px (w-4 h-4)
    - Position: absolute top-1.5 right-1.5
    - Меньший padding: p-1.5
  - [ ] 4.5 Обработчик клика на карточку:
    - onClick ведет на PDP (product detail page)
    - Без кнопки "В корзину"

- [ ] Task 5: Реализация Badge компонентов (AC: 4)
  - [ ] 5.1 Использовать обновленный Badge из Story 12.2:
    - Варианты: sale, new, hit
    - Убедиться что цвета соответствуют design-system.json
  - [ ] 5.2 Позиционирование в grid/compact layout:
    - absolute top-2 left-2
    - z-10 для наложения на изображение
  - [ ] 5.3 Позиционирование в list layout:
    - inline рядом с названием или ценой
    - ml-2 для отступа
  - [ ] 5.4 Логика отображения badge:
    - SALE: если есть old_price и скидка > 0
    - NEW: если product.is_new === true
    - HIT: если product.is_hit === true

- [ ] Task 6: Реализация кнопки "В избранное" (AC: 5)
  - [ ] 6.1 Создать компонент FavoriteButton или встроить в ProductCard:
    - Icon Heart из lucide-react
    - size: 20px (w-5 h-5) для grid/list, 16px (w-4 h-4) для compact
  - [ ] 6.2 Стилизация:
    - Default: text-neutral-600
    - Hover: text-[#A63232]
    - Active/Filled: text-[#A63232], HeartFilled или fill-current
  - [ ] 6.3 Позиционирование:
    - grid/list: absolute top-2 right-2, p-2
    - compact: absolute top-1.5 right-1.5, p-1.5
    - z-10
    - rounded-full bg-white/80 backdrop-blur-sm
  - [ ] 6.4 Accessibility:
    - aria-label="Добавить в избранное" / "Удалить из избранного"
    - role="button"
    - Keyboard accessible (Enter/Space)
  - [ ] 6.5 Обработчик onClick:
    - Вызывать onToggleFavorite(product.id)
    - Prevent event bubbling

- [ ] Task 7: Реализация ролевого ценообразования (AC: 6)
  - [ ] 7.1 Создать утилиту для определения цены по роли:
    ```typescript
    function getProductPrice(product: Product, userRole: UserRole): number {
      switch (userRole) {
        case 'retail': return product.retail_price
        case 'wholesale_level1': return product.opt1_price || product.retail_price
        case 'wholesale_level2': return product.opt2_price || product.opt1_price || product.retail_price
        case 'wholesale_level3': return product.opt3_price || product.opt2_price || product.opt1_price || product.retail_price
        case 'trainer': return product.trainer_price || product.retail_price
        case 'federation_rep': return product.federation_price || product.trainer_price || product.retail_price
        default: return product.retail_price
      }
    }
    ```
  - [ ] 7.2 Реализовать отображение цены:
    - Основная цена: text-title-m для grid/list, text-body-m для compact
    - Старая цена (если есть скидка): text-body-s, text-text-muted, line-through, mr-2
  - [ ] 7.3 Реализовать отображение RRP/MSRP для B2B:
    - Условие: showRRP && product.recommended_retail_price
    - Текст: "РРЦ: {price}" text-body-s, text-text-secondary
    - Аналогично для MSRP
  - [ ] 7.4 Расчет и отображение скидки:
    - Процент: Math.round((1 - currentPrice / oldPrice) * 100)
    - Отображать в Badge variant="sale"

- [ ] Task 8: Реализация адаптивных стилей (AC: 7)
  - [ ] 8.1 Создать компонент ProductGrid для обертки карточек:
    - grid gap-4
    - grid-cols-2 (mobile default)
    - sm:grid-cols-2
    - md:grid-cols-3
    - lg:grid-cols-4
    - xl:grid-cols-4
  - [ ] 8.2 Добавить поддержку переключения layout:
    - Props: layout: 'grid' | 'list'
    - List layout: flex flex-col gap-4
    - Возможность переключения пользователем
  - [ ] 8.3 Адаптивные размеры шрифтов:
    - Mobile: немного меньшие размеры если нужно
    - Проверить читаемость на всех размерах

- [ ] Task 9: Проверка accessibility (AC: 8)
  - [ ] 9.1 Проверить контраст всех текстовых элементов:
    - Использовать WebAIM Contrast Checker
    - text-text-primary на white: >= 4.5:1
    - text-text-secondary на white: >= 4.5:1
  - [ ] 9.2 Добавить focus ring:
    - Карточка: focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2
    - Кнопки: focus:ring-2 focus:ring-primary
  - [ ] 9.3 Добавить aria атрибуты:
    - role="article" для карточки
    - aria-label для кнопок без текста
    - alt для изображений с названием товара
  - [ ] 9.4 Keyboard navigation:
    - Табуляция через интерактивные элементы
    - Enter/Space для активации
    - Логический порядок фокуса

- [ ] Task 10: Создание и обновление тестов (AC: 9)
  - [ ] 10.1 Создать файл тестов `frontend/src/components/business/ProductCard/__tests__/ProductCard.test.tsx`
  - [ ] 10.2 Тесты рендеринга:
    - Рендеринг grid layout
    - Рендеринг list layout
    - Рендеринг compact layout
    - Отображение всех элементов (изображение, бренд, название, цена)
  - [ ] 10.3 Тесты ролевого ценообразования:
    - Retail пользователь видит retail_price
    - Wholesale пользователь видит opt_price
    - Trainer видит trainer_price
    - B2B видит RRP/MSRP если showRRP/showMSRP
  - [ ] 10.4 Тесты Badge:
    - Отображение SALE badge при скидке
    - Отображение NEW badge
    - Отображение HIT badge
    - Отсутствие badge если нет флагов
  - [ ] 10.5 Тесты интерактивности:
    - Клик на "В корзину" вызывает onAddToCart (grid/list)
    - Клик на карточку (compact) ведет на PDP
    - Клик на избранное вызывает onToggleFavorite
    - Hover эффекты применяются (visual regression)
  - [ ] 10.6 Тесты accessibility:
    - aria-label присутствует на кнопках
    - alt текст на изображениях
    - Keyboard navigation работает
  - [ ] 10.7 Запустить тесты и проверить покрытие >= 80%

- [ ] Task 11: Документация и интеграция (AC: 10)
  - [ ] 11.1 Обновить JSDoc комментарии
  - [ ] 11.2 Создать примеры использования в комментариях
  - [ ] 11.3 Добавить экспорт в `frontend/src/components/business/index.ts`
  - [ ] 11.4 Визуальная проверка в dev режиме:
    - Создать тестовую страницу с примерами всех вариантов
    - Проверить grid, list и compact layouts
    - Проверить все варианты badge
    - Проверить адаптивность
  - [ ] 11.5 Проверить что компонент не ломает существующие страницы

## Dev Notes

### Расположение компонента [Source: docs/architecture/04-component-structure.md#business]

```
frontend/src/components/
├── business/
│   ├── ProductCard/
│   │   ├── ProductCard.tsx         # СОЗДАТЬ
│   │   ├── index.ts                # СОЗДАТЬ
│   │   └── __tests__/
│   │       └── ProductCard.test.tsx # СОЗДАТЬ
│   └── index.ts                    # Добавить экспорт
```

### Интерфейс ProductCard [Source: docs/architecture/04-component-structure.md#ui-component-library]

```typescript
interface ProductCardProps {
  product: Product
  layout?: 'grid' | 'list' | 'compact'  // optional, default: 'grid'
  mode?: 'b2c' | 'b2b'                   // optional, default: 'b2c'
  userRole?: UserRole                    // optional, default: 'retail'
  showRRP?: boolean                      // Для B2B пользователей
  showMSRP?: boolean                     // Для B2B пользователей
  onAddToCart?: (productId: number) => void
  onToggleFavorite?: (productId: number) => void
  isFavorite?: boolean
  onClick?: () => void                   // Для compact layout (переход на PDP)
  className?: string
}

type UserRole = 'retail' | 'wholesale_level1' | 'wholesale_level2' | 'wholesale_level3' | 'trainer' | 'federation_rep' | 'admin'

// Использование с дефолтными значениями:
const ProductCard = ({
  product,
  layout = 'grid',
  mode = 'b2c',
  userRole = 'retail',
  showRRP = false,
  showMSRP = false,
  onAddToCart,
  onToggleFavorite,
  isFavorite = false,
  onClick,
  className,
}: ProductCardProps) => { ... }
```

### Ключевые цвета Design System v2.0 [Source: docs/frontend/design-system.json#foundations.colors]

```scss
// Primary (графитовая палитра)
$primary-default: #1F1F1F;
$primary-hover: #3A3A3A;
$primary-active: #0D0D0D;

// Text
$text-primary: #1B1B1B;
$text-secondary: #4D4D4D;
$text-muted: #7A7A7A;
$text-inverse: #FFFFFF;

// Neutral
$neutral-600: #7D7D7D; // Для иконок и разделителей

// Badge colors
$badge-sale-bg: #F9E1E1;
$badge-sale-text: #A63232;
$badge-new-bg: #E1F0FF;
$badge-new-text: #0F5DA3;
$badge-hit-bg: #E3F6EC;
$badge-hit-text: #1F7A4A;
```

### Типографика [Source: docs/frontend/design-system.json#foundations.typography]

```typescript
// Для ProductCard
title-m: { size: 20, lineHeight: 28, weight: 600 } // Цена
body-m: { size: 16, lineHeight: 24, weight: 500 }  // Название
body-s: { size: 14, lineHeight: 20, weight: 500 }  // Бренд
caption: { size: 12, lineHeight: 16, weight: 500 } // Badges
```

### Shadows и Motion [Source: docs/frontend/design-system.json#foundations]

```typescript
// Shadows
shadow-default: "0 8px 24px rgba(15, 23, 42, 0.08)"
shadow-hover: "0 10px 32px rgba(15, 23, 42, 0.12)"

// Motion
duration-medium: 180ms
easing: "cubic-bezier(0.4, 0, 0.2, 1)"
hover-lift: "translateY(-2px)"
```

### Спецификация из макета каталога [Source: docs/front-end-spec.md#каталог-товаров]

Структура карточки в каталоге:
```
┌────────────┐
│ [♡] [IMG]  │  <- Изображение с кнопкой избранного
│            │
│ Nike       │  <- Бренд (text-body-s)
│ Sportswear │  <- Название (text-body-m)
│ Club Fleece│
│ 7 499₽     │  <- Цена (text-title-m)
└────────────┘
```

### Product Type из backend [Source: docs/architecture/02-data-models.md]

```typescript
interface Product {
  id: number
  name: string
  slug: string
  brand: Brand
  category: Category
  description: string

  // Ценообразование
  retail_price: number
  opt1_price?: number
  opt2_price?: number
  opt3_price?: number
  trainer_price?: number
  federation_price?: number

  // Информационные цены для B2B
  recommended_retail_price?: number // RRP
  max_suggested_retail_price?: number // MSRP

  // Изображения
  main_image: string
  images: ProductImage[]

  // Статусы
  stock_quantity: number
  is_in_stock: boolean
  is_new: boolean
  is_hit: boolean

  // Скидки
  old_price?: number
  discount_percent?: number
}
```

### Взаимодействие с stores [Source: docs/architecture/source-tree.md#frontend]

```typescript
// Использование cartStore
import { useCartStore } from '@/stores/cartStore'

const { addItem } = useCartStore()

const handleAddToCart = () => {
  addItem(product.id, getProductPrice(product, userRole))
}

// Использование favoritesStore (если существует)
// или через API сервис
```

### Зависимость от обновленного Button [Source: Story 12.2]

Компонент ProductCard должен использовать обновленный Button из Story 12.2:
- variant="primary" с bg-primary (#1F1F1F)
- Hover: bg-primary-hover (#3A3A3A)
- Radius: 6px (rounded-sm)

### Иконки

Использовать из lucide-react:
- `Heart` - для кнопки избранного
- `ShoppingCart` - опционально для CTA (если используется иконка)

### RecommendationsRow спецификация [Source: docs/frontend/design-system.json#components.RecommendationsRow]

```typescript
// Для горизонтальных рекомендаций (связанная функциональность)
{
  maxVisibleCards: 6,
  cardGap: 16,
  cardWidth: 180,
  rating: "caption",
  badge: {
    component: "Badge",
    supportedVariants: ["hit", "new", "promo", "sale"],
    placement: "под ценой"
  }
}
```

### Technical Constraints

- **React 19.1.0**: Использовать forwardRef для компонента
- **TypeScript**: Строгая типизация всех props
- **Tailwind CSS 4.0**: Использовать @theme inline синтаксис
- **Next.js Image**: Использовать для оптимизации изображений
- **lucide-react**: Для иконок
- **Backward Compatibility**: Компонент не должен ломать существующие страницы

### Предыдущие Story Insights

**Story 12.2** (если завершена) обновляет:
- Button компонент с новыми цветами
- Badge компонент с новыми вариантами

Компоненты в Story 12.4 должны использовать эти обновленные компоненты.

**Story 12.3** создает:
- Breadcrumbs для навигации в каталоге
- Pagination для списка товаров

## Testing

**Test file locations:**
- `frontend/src/components/business/ProductCard/__tests__/ProductCard.test.tsx`

**Testing frameworks** [Source: docs/architecture/10-testing-strategy.md#frontend-tests]:
- Vitest 2.1.5 для unit тестов
- @testing-library/react 16.3.0 для компонентных тестов
- MSW 2.12.2 для API mocking (если нужно)

**Test standards:**
- Каждый layout (grid/list) должен быть протестирован
- Все варианты ценообразования проверяются
- Badge логика тестируется
- Accessibility атрибуты проверяются
- Интерактивность (клики, hover) тестируется

**Coverage requirements:**
- Минимум 80% покрытие для компонента
- Все публичные props должны быть протестированы

**Test commands:**
```bash
# Запуск тестов
npm test

# Запуск тестов с покрытием
npm run test:coverage

# Запуск конкретного теста
npx vitest run src/components/business/ProductCard/__tests__/ProductCard.test.tsx
```

**Пример теста ролевого ценообразования:**
```typescript
// ProductCard.test.tsx
import { render, screen } from '@testing-library/react'
import { ProductCard } from '../ProductCard'

const mockProduct = {
  id: 1,
  name: 'Test Product',
  brand: { name: 'Nike' },
  retail_price: 1200,
  opt1_price: 1000,
  trainer_price: 950,
  recommended_retail_price: 1300,
  max_suggested_retail_price: 1400,
  main_image: '/test.jpg',
  stock_quantity: 50,
  is_new: false,
  is_hit: false
}

describe('ProductCard', () => {
  it('displays retail pricing for B2C users', () => {
    render(
      <ProductCard
        product={mockProduct}
        userRole="retail"
        mode="b2c"
        layout="grid"
      />
    )

    expect(screen.getByText('1 200 ₽')).toBeInTheDocument()
    expect(screen.queryByText('РРЦ:')).not.toBeInTheDocument()
  })

  it('displays wholesale pricing and RRP for B2B users', () => {
    render(
      <ProductCard
        product={mockProduct}
        userRole="wholesale_level1"
        mode="b2b"
        layout="grid"
        showRRP={true}
      />
    )

    expect(screen.getByText('1 000 ₽')).toBeInTheDocument()
    expect(screen.getByText(/РРЦ.*1 300/)).toBeInTheDocument()
  })
})
```

## Change Log

| Date       | Version | Description                              | Author       |
|------------|---------|------------------------------------------|--------------|
| 2025-11-19 | 1.0     | Создание story на основе Epic 12.4       | Bob (SM)     |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
