# Story 12.2: Выбор опций товара (размер, цвет)

## Status
Draft

## Story
**Как** покупатель,
**Я хочу** выбирать размер и цвет товара перед добавлением в корзину,
**Чтобы** заказать именно тот вариант, который мне нужен.

## Acceptance Criteria
1. Селектор размеров отображается если товар имеет варианты размеров
2. Селектор цветов отображается если товар доступен в разных цветах
3. Недоступные опции (нет в наличии) визуально отключены
4. При выборе опции обновляется основное изображение товара (если есть)
5. При выборе опции обновляется информация о наличии
6. Выбранные опции сохраняются при добавлении в корзину
7. Валидация: нельзя добавить в корзину без выбора обязательных опций

## Tasks / Subtasks

- [ ] Создать компонент ProductOptions (AC: 1, 2, 3, 7)
  - [ ] Создать `src/components/product/ProductOptions.tsx`
  - [ ] Импортировать `ProductDetail` из `frontend/src/types/api.generated.ts` и объявить `type ProductOption = ProductDetail['options'][number]`
  - [ ] Отобразить группу опций размеров (Chip компоненты)
  - [ ] Отобразить группу опций цветов (Chip с цветовыми индикаторами)
  - [ ] Визуально отключить недоступные опции (opacity 0.5, cursor not-allowed)
  - [ ] Добавить состояние selectedOptions (useState)

- [ ] Реализовать логику выбора опций (AC: 4, 5, 6)
  - [ ] Обработчик onClick для выбора размера
  - [ ] Обработчик onClick для выбора цвета
  - [ ] Обновить основное изображение при выборе цвета (если доступно)
  - [ ] Обновить информацию о наличии при выборе опций
  - [ ] Сохранять selectedOptions в локальное состояние компонента

- [ ] Интеграция с ProductSummary (AC: 6, 7)
  - [ ] Передать selectedOptions в ProductSummary через props
  - [ ] Валидация перед добавлением в корзину (проверить обязательные опции)
  - [ ] Показать ошибку если обязательные опции не выбраны
  - [ ] Передать selectedOptions в cartItem при добавлении

- [ ] Дизайн опций согласно дизайн-системе
  - [ ] Chip для размеров: radius 16px, border-neutral-400 (см. [docs/front-end-spec.md#chip](../../front-end-spec.md#chip))
  - [ ] Selected state: bg-primary, text-inverse (см. палитру [docs/front-end-spec.md#цветовая-палитра](../../front-end-spec.md#%D1%86%D0%B2%D0%B5%D1%82%D0%BE%D0%B2%D0%B0%D1%8F-%D0%BF%D0%B0%D0%BB%D0%B8%D1%82%D1%80%D0%B0))
  - [ ] Disabled state: opacity 0.5 (см. [docs/front-end-spec.md#chip](../../front-end-spec.md#chip))
  - [ ] Цветовые опции с круглым индикатором цвета (16px) (см. [docs/front-end-spec.md#цветовые-индикаторы](../../front-end-spec.md#%D1%86%D0%B2%D0%B5%D1%82%D0%BE%D0%B2%D1%8B%D0%B5-%D0%B8%D0%BD%D0%B4%D0%B8%D0%BA%D0%B0%D1%82%D0%BE%D1%80%D1%8B))

- [ ] Написать unit тесты
  - [ ] Тест отображения опций размеров
  - [ ] Тест отображения опций цветов
  - [ ] Тест отключения недоступных опций
  - [ ] Тест выбора опций и обновления состояния
  - [ ] Тест валидации обязательных опций
  - [ ] Тест обновления изображения при выборе цвета

## Acceptance Criteria ↔ Tasks Traceability

| AC | Покрывающие задачи |
| --- | --- |
| 1 | «Создать компонент ProductOptions» — вывод размеров на уровне компонента @docs/stories/epic-12/12.2.product-options.md#22-28 |
| 2 | «Создать компонент ProductOptions» — вывод цветовых Chip @docs/stories/epic-12/12.2.product-options.md#22-28 |
| 3 | «Создать компонент ProductOptions» — disabled state и стили @docs/stories/epic-12/12.2.product-options.md#22-28 |
| 4 | «Реализовать логику выбора опций» — обработка кликов и обновление изображения @docs/stories/epic-12/12.2.product-options.md#30-35 |
| 5 | «Реализовать логику выбора опций» — обновление информации о наличии @docs/stories/epic-12/12.2.product-options.md#30-35 |
| 6 | «Реализовать логику выбора опций» + «Интеграция с ProductSummary» — сохранение selectedOptions и проброс в корзину @docs/stories/epic-12/12.2.product-options.md#30-42 |
| 7 | «Создать компонент ProductOptions» + «Интеграция с ProductSummary» — валидация обязательных опций @docs/stories/epic-12/12.2.product-options.md#22-42 |

## Dev Notes

### Relevant Source Tree
```markdown
frontend/src/
├── components/
│   └── product/
│       ├── ProductOptions.tsx     (NEW)
│       └── __tests__/
│           └── ProductOptions.test.tsx  (NEW)
└── types/
    └── api.generated.ts  (READ-ONLY — источник ProductDetail.options[])
```

### TypeScript Interfaces
```typescript
import { ProductDetail } from '@/types/api.generated';

export type ProductOption = ProductDetail['options'][number];

export interface SelectedOptions {
  size?: string;
  color?: string;
}
```

### Props и источники данных

```typescript
export interface ProductOptionsProps {
  product: ProductDetail; // источник: productsService.getProductBySlug
  selectedOptions: SelectedOptions;
  onSelectionChange: (next: SelectedOptions) => void; // пробрасывается в ProductSummary
  onOptionValidationError?: (message: string) => void;
}
```

- `product` инициализируется на странице товара (Story 12.1) и содержит `ProductDetail` с backend API @docs/stories/epic-12/12.1.product-detail-view.md#31-187.
- `selectedOptions` локально хранится в ProductOptions, но должен синхронизироваться с ProductSummary через prop `onSelectionChange`.
- Ошибки валидации (AC7) отображаются в блоке `ProductSummary`, поэтому обратный канал `onOptionValidationError` обязателен.

### Связь с ProductSummary

- См. Story 12.1 для ProductSummary и общих компонентов карточки товара @docs/stories/epic-12/12.1.product-detail-view.md#43-75
- ProductOptions передаёт `selectedOptions` в `ProductSummary` через props, чтобы обеспечить валидацию обязательных опций и построение `cartItem`

### Product options API reference

- Схема `ProductDetail` описана в `docs/api-spec.yaml` и задаёт базовые поля товара @docs/api-spec.yaml#700-811.
- Для story 12.2 backend расширяется полем `options: ProductOption[]`, которое сериализуется из 1С и возвращается в `/products/{id}/`. Типы синхронизируются через `frontend/src/types/api.generated.ts` после обновления OpenAPI.

### Структура ProductOption

```json
{
  "id": "size-42",
  "type": "size" | "color",
  "label": "42",
  "value": "42",
  "required": true,
  "is_available": true,
  "swatch_hex": "#004DFF",
  "image_url": "https://cdn.../blue.png"
}
```

- Для цветов и размеров требуется единая структура хранения: опции нормализуются на слое импорта 1С и прикрепляются к `ProductDetail.options`.
- `required` используется при валидации; `is_available` отражает складские остатки на уровне варианта.

### Компонент дизайн-системы

- **Chip:** используется для отображения опций
  - Default: bg-neutral-100, border-neutral-400
  - Selected: bg-primary, text-inverse
  - Disabled: opacity 0.5, cursor not-allowed
  - Radius: 16px, padding 8px 16px

### UX-сценарий выбора опций

1. Пользователь открывает страницу товара и видит две группы Chip: размеры и цвета (если доступны).
2. При клике по размеру выполняется выбор и сразу подсвечиваются связанные недоступные цвета (disabled state).
3. При выборе цвета обновляется Chip, вызывается `updateImageOnColorChange`, а блок наличия пересчитывается (AC4-5).
4. Кнопка «Добавить в корзину» в `ProductSummary` вызывает `validateOptions`; при ошибке показывается inline-уведомление и фокус переносится на первую незаполненную группу.
5. Успешный выбор сохраняется в `cartItem.options` и отображается в мини-корзине.

### Логика обновления изображения
```typescript
function updateImageOnColorChange(color: ProductOption) {
  if (color.image_url) {
    // Обновить основное изображение в ProductGallery
    setSelectedImage(color.image_url);
  }
}
```

> ⚠️ Tech debt: пока `ProductOption.image_url` и `swatch_hex` не хранятся в БД. Нужно согласовать формат хранения вариантов (импорт 1С → serializer ProductDetail), иначе функция остаётся заглушкой и не синхронизирует галерею и наличие.

### Валидация опций
```typescript
function validateOptions(selectedOptions: SelectedOptions, product: ProductDetail): boolean {
  const requiredOptions = product.options.filter(opt => opt.required);

  for (const option of requiredOptions) {
    if (option.type === 'size' && !selectedOptions.size) return false;
    if (option.type === 'color' && !selectedOptions.color) return false;
  }

  return true;
}
```

### Testing

#### Test file location
- `src/components/product/__tests__/ProductOptions.test.tsx`

#### Test cases
```typescript
describe('ProductOptions', () => {
  it('renders size options when available', () => {});
  it('renders color options when available', () => {});
  it('disables unavailable options', () => {});
  it('updates selected state on option click', () => {});
  it('validates required options before add to cart', () => {});
  it('updates image on color selection', () => {});
  it('shows error when required option not selected', () => {});
});
```

#### Testing standards & stack

- Unit и integration тесты пишутся на Vitest + React Testing Library в соответствии со стандартами @docs/frontend/testing-standards.md#1-332.
- Соблюдаем рекомендации по типам и jest-dom матчерам из @docs/frontend/testing-typescript-recommendations.md#12-141 (никаких `as any`).

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание story 12.2 на основе Epic 12 | Sarah (PO) |

## Dev Agent Record
(Заполняется dev-агентом)

## QA Results
(Заполняется QA-агентом)
