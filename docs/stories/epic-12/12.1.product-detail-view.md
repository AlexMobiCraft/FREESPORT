# Story 12.1: Просмотр детальной информации о товаре

## Status
Draft

## Story
**Как** посетитель сайта (B2C/B2B),
**Я хочу** просматривать детальную информацию о товаре с фотографиями и характеристиками,
**Чтобы** принять обоснованное решение о покупке.

## Acceptance Criteria
1. Страница доступна по URL `/product/[slug]` где slug — SEO-friendly идентификатор
2. Отображается галерея изображений товара с возможностью увеличения
3. Показывается название товара, артикул (SKU), бренд, описание
4. Выводится цена согласно роли пользователя (retail для гостей, wholesale_level1-3 для B2B, trainer_price, federation_price)
5. Отображается информация о наличии товара (в наличии/под заказ/нет в наличии)
6. Показывается рейтинг товара и количество отзывов (если доступны)
7. Блок характеристик товара в структурированном виде
8. Breadcrumbs навигация: Главная > Категория > Подкатегория > Товар
9. SEO метатеги корректно заполнены (title, description, OG tags)
10. Страница рендерится через SSR для SEO

## Tasks / Subtasks

- [ ] Создать структуру динамического роута (AC: 1, 10)
  - [ ] Создать `src/app/product/[slug]/page.tsx` с SSR
  - [ ] Создать `src/app/product/[slug]/loading.tsx` (skeleton)
  - [ ] Создать `src/app/product/[slug]/error.tsx` (error boundary)
  - [ ] Настроить `generateMetadata` для SEO (AC: 9)

- [ ] Реализовать API интеграцию (AC: 3, 4, 5, 6, 7)
  - [ ] Создать `src/services/productsService.ts` с методом `getProductBySlug(slug: string)`
  - [ ] Сгенерировать TypeScript типы из `api-spec.yaml` для ProductDetail
  - [ ] Добавить error handling для 404, 500 ошибок
  - [ ] Реализовать кэширование запросов (Next.js fetch cache)

- [ ] Создать компонент ProductBreadcrumbs (AC: 8)
  - [ ] Создать `src/components/product/ProductBreadcrumbs.tsx`
  - [ ] Использовать компонент Breadcrumb из дизайн-системы
  - [ ] Получать данные category из API response
  - [ ] Добавить структурированные данные schema.org/BreadcrumbList

- [ ] Создать компонент ProductInfo (AC: 3, 4, 5, 6)
  - [ ] Создать `src/components/product/ProductInfo.tsx`
  - [ ] Отобразить название (typography: headline-l)
  - [ ] Отобразить SKU и бренд (typography: body-m, color: text-secondary)
  - [ ] Отобразить description и full_description
  - [ ] Добавить Badge для статуса наличия (в наличии/под заказ)
  - [ ] Отобразить рейтинг (Star иконки + reviews_count)

- [ ] Реализовать логику ролевого ценообразования (AC: 4)
  - [ ] Создать утилиту `src/utils/pricing.ts` с функцией `getPriceForRole(product, userRole)`
  - [ ] Получать userRole из authStore (Zustand)
  - [ ] Для гостей показывать retail_price
  - [ ] Для B2B показывать соответствующий уровень (opt1/opt2/opt3_price)
  - [ ] Для тренеров показывать trainer_price
  - [ ] Для федераций показывать federation_price
  - [ ] Добавить unit тесты для всех ролей

- [ ] Создать компонент ProductSpecs (AC: 7)
  - [ ] Создать `src/components/product/ProductSpecs.tsx`
  - [ ] Отобразить specifications как таблицу key-value
  - [ ] Использовать DetailList стиль из дизайн-системы
  - [ ] Если specifications пустой — скрыть блок

- [ ] Создать layout страницы (AC: 2)
  - [ ] Desktop: двухколоночный (галерея 2/3, сводка 1/3)
  - [ ] Использовать Grid layout с gap 24px
  - [ ] Sticky позиционирование для ProductSummary (offset 96px)

- [ ] Написать unit тесты
  - [ ] Тест SSR рендеринга страницы
  - [ ] Тест корректного отображения всех полей
  - [ ] Тест ролевого ценообразования для каждой роли
  - [ ] Тест Breadcrumbs навигации
  - [ ] Тест обработки ошибок (404, 500)

- [ ] Написать integration тест
  - [ ] Создать MSW мок для `/products/{id}` API
  - [ ] Тест загрузки данных с сервера
  - [ ] Тест кэширования запросов
  - [ ] Тест fallback на error.tsx при ошибке

## Dev Notes

### Relevant Source Tree
```
frontend/src/
├── app/
│   └── product/
│       └── [slug]/
│           ├── page.tsx          # SSR страница (NEW)
│           ├── loading.tsx       # Skeleton (NEW)
│           └── error.tsx         # Error boundary (NEW)
├── components/
│   └── product/
│       ├── ProductBreadcrumbs.tsx  (NEW)
│       ├── ProductInfo.tsx         (NEW)
│       └── ProductSpecs.tsx        (NEW)
├── services/
│   └── productsService.ts          (NEW)
├── utils/
│   └── pricing.ts                  (NEW)
└── types/
    └── product.ts                  (UPDATE - добавить ProductDetail)
```

### API Endpoint
- **URL:** `GET /api/v1/products/{id}/`
- **Response:** ProductDetail schema (см. api-spec.yaml строки 790-811)

### Дизайн-система компоненты
- **Breadcrumb:** text-body-s, text-neutral-700, spacing 8px, separator ChevronRight
- **Badge варианты:**
  - В наличии: `delivered` (#E0F5E8 bg, #00AA5B text)
  - Под заказ: `transit` (#FFF1CC bg, #F5A623 text)
  - Нет в наличии: `cancelled` (#FFE1E8 bg, #E53935 text)
- **Typography:**
  - Название: headline-l (32px, 700)
  - SKU/Бренд: body-m (16px, 500), text-secondary
  - Описание: body-m (16px, 500)

### Ролевое ценообразование логика
```typescript
function getPriceForRole(product: ProductDetail, userRole: UserRole): number {
  switch (userRole) {
    case 'retail':
      return product.price.retail;
    case 'wholesale_level1':
      return product.price.wholesale?.level1 || product.price.retail;
    case 'wholesale_level2':
      return product.price.wholesale?.level2 || product.price.retail;
    case 'wholesale_level3':
      return product.price.wholesale?.level3 || product.price.retail;
    case 'trainer':
      return product.price.trainer || product.price.retail;
    case 'federation_rep':
      return product.price.federation || product.price.retail;
    case 'admin':
      return product.price.retail;
    default:
      return product.price.retail;
  }
}
```

### SEO Metadata генерация
```typescript
export async function generateMetadata({ params }: { params: { slug: string } }): Promise<Metadata> {
  const product = await getProductBySlug(params.slug);

  return {
    title: `${product.name} - ${product.brand} | FREESPORT`,
    description: product.description.substring(0, 160),
    openGraph: {
      title: product.name,
      description: product.description,
      images: [{ url: product.images[0].image, alt: product.name }],
      type: 'product',
    },
    alternates: {
      canonical: `/product/${product.slug}`,
    },
  };
}
```

### Важные замечания
- Использовать Next.js Image компонент с оптимизацией
- Кэшировать API запросы через `fetch(..., { next: { revalidate: 3600 } })`
- Для гостей (неавторизованных) всегда показывать retail_price
- Breadcrumbs должны строиться из category.breadcrumbs массива
- Обязательно добавить structured data для SEO (schema.org/Product)

### Testing

#### Test file location
- Unit тесты: `src/app/product/[slug]/__tests__/page.test.tsx`
- Component тесты: `src/components/product/__tests__/ProductInfo.test.tsx`
- Integration тесты: `src/app/product/__tests__/product-page.integration.test.tsx`

#### Test standards
- Использовать Vitest + React Testing Library
- MSW для моков API
- Покрытие > 80%
- Тестировать все роли пользователей для ценообразования

#### Testing frameworks
- Vitest 2.1.5
- React Testing Library 16.3.0
- MSW 2.12.2 для API моков

#### Specific testing requirements
- Проверить SSR рендеринг (renderToString)
- Проверить корректность SEO метатегов
- Проверить обработку ошибок (404, 500)
- Проверить кэширование запросов

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание story 12.1 на основе Epic 12 | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
(Заполняется dev-агентом)

### Debug Log References
(Заполняется dev-агентом)

### Completion Notes List
(Заполняется dev-агентом)

### File List
(Заполняется dev-агентом)

## QA Results
(Заполняется QA-агентом после завершения)
