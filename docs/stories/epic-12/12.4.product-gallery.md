# Story 12.4: Галерея изображений товара

## Status
Draft

## Story
**Как** покупатель,
**Я хочу** просматривать все изображения товара и увеличивать их,
**Чтобы** детально рассмотреть продукт перед покупкой.

## Acceptance Criteria
1. Основное изображение отображается в размере 520x520px с радиусом 16px
2. Вертикальная полоса превью (thumbnails) слева от основного изображения
3. Thumbnails размером 88x88px с gap 12px и радиусом 12px
4. Выбранный thumbnail подсвечивается рамкой 2px #0060FF
5. При клике на thumbnail меняется основное изображение
6. Возможность открыть полноэкранный режим просмотра (lightbox)
7. Навигация по изображениям в lightbox (стрелки влево/вправо)
8. Закрытие lightbox по клику вне изображения или на кнопку X
9. Lazy loading для изображений
10. Alt текст для всех изображений (accessibility)

## Tasks / Subtasks

- [ ] Создать компонент ProductGallery (AC: 1, 2, 3, 4, 5)
  - [ ] Создать `src/components/product/ProductGallery.tsx`
  - [ ] Отобразить основное изображение 520x520px с радиусом 16px
  - [ ] Добавить тень: 0 12px 32px rgba(15, 23, 42, 0.08)
  - [ ] Создать вертикальную полосу thumbnails (flex-col gap-3)
  - [ ] Thumbnails 88x88px с радиусом 12px
  - [ ] Выбранный thumbnail: ring-2 ring-primary (#0060FF)

- [ ] Реализовать логику переключения изображений (AC: 5)
  - [ ] State: selectedImageIndex (useState)
  - [ ] Обработчик onClick на thumbnail
  - [ ] Обновление selectedImageIndex при клике
  - [ ] Анимация смены изображения (fade-in)

- [ ] Создать Lightbox компонент (AC: 6, 7, 8)
  - [ ] Создать `src/components/common/Lightbox.tsx`
  - [ ] Modal overlay с backdrop blur
  - [ ] Полноэкранное изображение (max-width 90vw, max-height 90vh)
  - [ ] Кнопки навигации влево/вправо (ChevronLeft, ChevronRight иконки)
  - [ ] Кнопка закрытия X (top-right, size 44x44px)
  - [ ] Закрытие по клику на backdrop
  - [ ] Закрытие по Escape клавише

- [ ] Интеграция Next.js Image (AC: 9, 10)
  - [ ] Использовать Next.js Image компонент
  - [ ] Добавить priority для основного изображения
  - [ ] Lazy loading для thumbnails
  - [ ] Корректные alt тексты из product.images[].alt_text
  - [ ] Оптимизация размеров (sizes prop)

- [ ] Keyboard navigation (AC: 7)
  - [ ] Arrow Left/Right для навигации в lightbox
  - [ ] Escape для закрытия lightbox
  - [ ] Tab navigation доступен для thumbnails
  - [ ] Focus trap внутри lightbox

- [ ] Адаптивность для mobile (дополнительно)
  - [ ] Mobile: горизонтальный swipe вместо вертикальных thumbnails
  - [ ] Touch gestures для навигации
  - [ ] Thumbnails в горизонтальный scroll (snap-scroll)

- [ ] Написать unit тесты
  - [ ] Тест рендеринга галереи с изображениями
  - [ ] Тест смены изображения по клику на thumbnail
  - [ ] Тест подсветки выбранного thumbnail
  - [ ] Тест открытия/закрытия lightbox
  - [ ] Тест навигации в lightbox
  - [ ] Тест keyboard shortcuts

## Dev Notes

### Relevant Source Tree
```
frontend/src/
├── components/
│   ├── product/
│   │   ├── ProductGallery.tsx        (NEW)
│   │   └── __tests__/
│   │       └── ProductGallery.test.tsx (NEW)
│   └── common/
│       ├── Lightbox.tsx              (NEW)
│       └── __tests__/
│           └── Lightbox.test.tsx     (NEW)
```

### ProductGallery Компонент
```typescript
'use client';

import { useState } from 'react';
import Image from 'next/image';
import { ProductImage } from '@/types/product';
import Lightbox from '@/components/common/Lightbox';

interface ProductGalleryProps {
  images: ProductImage[];
  productName: string;
}

export default function ProductGallery({ images, productName }: ProductGalleryProps) {
  const [selectedImage, setSelectedImage] = useState(0);
  const [isLightboxOpen, setIsLightboxOpen] = useState(false);

  return (
    <div className="flex gap-3">
      {/* Thumbnails */}
      <div className="flex flex-col gap-3">
        {images.map((img, idx) => (
          <button
            key={img.id}
            onClick={() => setSelectedImage(idx)}
            className={`
              w-[88px] h-[88px] rounded-xl overflow-hidden
              transition-all duration-120
              ${idx === selectedImage ? 'ring-2 ring-primary' : 'ring-1 ring-neutral-300'}
              hover:ring-2 hover:ring-primary
            `}
            aria-label={`Просмотр изображения ${idx + 1}`}
          >
            <Image
              src={img.image}
              alt={img.alt_text}
              width={88}
              height={88}
              className="object-cover"
              loading="lazy"
            />
          </button>
        ))}
      </div>

      {/* Primary Image */}
      <div
        className="w-[520px] h-[520px] rounded-2xl shadow-default overflow-hidden cursor-pointer"
        onClick={() => setIsLightboxOpen(true)}
        role="button"
        tabIndex={0}
        aria-label="Открыть полноэкранный просмотр"
      >
        <Image
          src={images[selectedImage].image}
          alt={images[selectedImage].alt_text}
          width={520}
          height={520}
          className="object-cover"
          priority
          sizes="(max-width: 768px) 100vw, 520px"
        />
      </div>

      {/* Lightbox */}
      {isLightboxOpen && (
        <Lightbox
          images={images}
          initialIndex={selectedImage}
          onClose={() => setIsLightboxOpen(false)}
          productName={productName}
        />
      )}
    </div>
  );
}
```

### Lightbox Компонент
```typescript
'use client';

import { useState, useEffect } from 'react';
import Image from 'next/image';
import { X, ChevronLeft, ChevronRight } from 'lucide-react';
import { ProductImage } from '@/types/product';

interface LightboxProps {
  images: ProductImage[];
  initialIndex: number;
  onClose: () => void;
  productName: string;
}

export default function Lightbox({ images, initialIndex, onClose, productName }: LightboxProps) {
  const [currentIndex, setCurrentIndex] = useState(initialIndex);

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
      if (e.key === 'ArrowLeft') goToPrevious();
      if (e.key === 'ArrowRight') goToNext();
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentIndex]);

  const goToPrevious = () => {
    setCurrentIndex((prev) => (prev === 0 ? images.length - 1 : prev - 1));
  };

  const goToNext = () => {
    setCurrentIndex((prev) => (prev === images.length - 1 ? 0 : prev + 1));
  };

  return (
    <div
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center"
      onClick={onClose}
    >
      {/* Close Button */}
      <button
        onClick={onClose}
        className="absolute top-4 right-4 w-11 h-11 rounded-xl bg-neutral-300 hover:bg-neutral-400 flex items-center justify-center"
        aria-label="Закрыть"
      >
        <X size={24} className="text-neutral-900" />
      </button>

      {/* Image Container */}
      <div className="max-w-[90vw] max-h-[90vh] relative" onClick={(e) => e.stopPropagation()}>
        <Image
          src={images[currentIndex].image}
          alt={images[currentIndex].alt_text}
          width={1200}
          height={1200}
          className="object-contain"
          priority
        />
      </div>

      {/* Navigation */}
      {images.length > 1 && (
        <>
          <button
            onClick={(e) => { e.stopPropagation(); goToPrevious(); }}
            className="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-primary/20 hover:bg-primary/40 flex items-center justify-center"
            aria-label="Предыдущее изображение"
          >
            <ChevronLeft size={28} className="text-white" />
          </button>

          <button
            onClick={(e) => { e.stopPropagation(); goToNext(); }}
            className="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-primary/20 hover:bg-primary/40 flex items-center justify-center"
            aria-label="Следующее изображение"
          >
            <ChevronRight size={28} className="text-white" />
          </button>
        </>
      )}

      {/* Image Counter */}
      <div className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/60 px-4 py-2 rounded-full text-white text-sm">
        {currentIndex + 1} / {images.length}
      </div>
    </div>
  );
}
```

### Дизайн-система спецификация
**ProductGallery:**
- primaryImage: 520x520px, radius 16px, shadow: 0 12px 32px rgba(15, 23, 42, 0.08)
- thumbnails: vertical, 88x88px, gap 12px, radius 12px
- selectedBorder: 2px solid #0060FF
- viewerControls: iconSize 28px, buttonBackground rgba(0, 96, 255, 0.16), buttonRadius 40px

### Accessibility требования
- Alt тексты для всех изображений
- Keyboard navigation (Tab, Arrow keys, Escape)
- Focus visible indicators
- ARIA labels для кнопок
- Focus trap в lightbox

### Testing

#### Test file location
- `src/components/product/__tests__/ProductGallery.test.tsx`
- `src/components/common/__tests__/Lightbox.test.tsx`

#### Test cases
```typescript
describe('ProductGallery', () => {
  it('renders primary image with correct dimensions', () => {});
  it('renders thumbnails vertically with gap', () => {});
  it('highlights selected thumbnail with ring', () => {});
  it('changes primary image on thumbnail click', () => {});
  it('opens lightbox on primary image click', () => {});
  it('applies lazy loading to thumbnails', () => {});
  it('uses priority loading for primary image', () => {});
});

describe('Lightbox', () => {
  it('opens with correct initial image', () => {});
  it('navigates to next image on button click', () => {});
  it('navigates to previous image on button click', () => {});
  it('closes on X button click', () => {});
  it('closes on backdrop click', () => {});
  it('closes on Escape key', () => {});
  it('navigates with arrow keys', () => {});
  it('shows image counter', () => {});
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание story 12.4 на основе Epic 12 | Sarah (PO) |

## Dev Agent Record
(Заполняется dev-агентом)

## QA Results
(Заполняется QA-агентом)
