# Story 12.3: Добавление товара в корзину

## Status
Draft

## Story
**Как** авторизованный пользователь,
**Я хочу** добавить товар в корзину с выбранным количеством,
**Чтобы** продолжить покупки или оформить заказ.

## Acceptance Criteria
1. Кнопка "В корзину" видна и доступна для товаров в наличии
2. Возможность выбрать количество товара (с учетом min_order_quantity)
3. При клике на "В корзину" товар добавляется через API `/cart/items/`
4. Показывается уведомление об успешном добавлении
5. Обновляется счетчик товаров в корзине в Header
6. Товар добавляется в Zustand cartStore
7. Обработка ошибок (нет на складе, превышен лимит)
8. Для неавторизованных пользователей — кнопка "Войти для покупки"

## Tasks / Subtasks

- [ ] Создать компонент ProductSummary (AC: 1, 2)
  - [ ] Создать `src/components/product/ProductSummary.tsx`
  - [ ] Отобразить блок цены (priceBlock) согласно дизайн-системе
  - [ ] Добавить Input для выбора количества (min: min_order_quantity)
  - [ ] Кнопка "В корзину" (ctaPrimary) - размер 56px height
  - [ ] Кнопка "В избранное" (ctaSecondary) - опционально

- [ ] Реализовать API интеграцию корзины (AC: 3, 6)
  - [ ] Создать `src/services/cartService.ts`
  - [ ] Метод `addToCart(productId: number, quantity: number, options?: SelectedOptions)`
  - [ ] POST запрос к `/api/v1/cart/items/`
  - [ ] Обновить cartStore после успешного добавления

- [ ] Интеграция с Zustand cartStore (AC: 5, 6)
  - [ ] Создать/обновить `src/stores/cartStore.ts`
  - [ ] Action `addItem(item: CartItem)`
  - [ ] State `items: CartItem[]`, `totalItems: number`, `totalPrice: number`
  - [ ] Computed getter `getTotalItems()` для счетчика в Header

- [ ] Реализовать уведомления (AC: 4)
  - [ ] Использовать Toast компонент из дизайн-системы
  - [ ] Success toast: "Товар добавлен в корзину" с зеленой индикацией
  - [ ] Error toast: "Ошибка добавления" с красной индикацией
  - [ ] Auto-dismiss через 5 секунд

- [ ] Обработка состояний и ошибок (AC: 7, 8)
  - [ ] Loading state: показать Spinner в кнопке
  - [ ] Disabled state: если товара нет в наличии
  - [ ] Валидация: количество >= min_order_quantity
  - [ ] Валидация: количество <= stock_quantity
  - [ ] Для гостей: кнопка "Войти для покупки" → редирект на /login

- [ ] Обновить Header counter (AC: 5)
  - [ ] Header слушает cartStore.totalItems
  - [ ] Анимация обновления счетчика (scale + fade)
  - [ ] Badge с количеством товаров (sale вариант из дизайн-системы)

- [ ] Написать unit тесты
  - [ ] Тест отображения кнопки "В корзину"
  - [ ] Тест валидации количества (min/max)
  - [ ] Тест добавления в корзину (мок API)
  - [ ] Тест обновления cartStore
  - [ ] Тест показа success/error уведомлений
  - [ ] Тест для неавторизованных пользователей

- [ ] Написать integration тест
  - [ ] MSW мок для POST `/cart/items/`
  - [ ] Тест full flow: выбор количества → добавление → обновление Header

## Dev Notes

### Relevant Source Tree
```
frontend/src/
├── components/
│   ├── product/
│   │   ├── ProductSummary.tsx        (NEW)
│   │   └── __tests__/
│   │       └── ProductSummary.test.tsx (NEW)
│   └── layout/
│       └── Header.tsx                (UPDATE - добавить cart counter)
├── services/
│   └── cartService.ts                (NEW)
├── stores/
│   └── cartStore.ts                  (NEW/UPDATE)
└── types/
    └── cart.ts                       (NEW)
```

### API Endpoint
- **URL:** `POST /api/v1/cart/items/`
- **Request Body:**
```typescript
{
  product_id: number;
  quantity: number;
}
```
- **Response:** CartItem schema (см. api-spec.yaml строки 945-965)

### Zustand cartStore
```typescript
interface CartStore {
  items: CartItem[];
  totalItems: number;
  totalPrice: number;

  addItem: (item: CartItem) => void;
  removeItem: (id: number) => void;
  updateQuantity: (id: number, quantity: number) => void;
  clear: () => void;
}

export const useCartStore = create<CartStore>((set, get) => ({
  items: [],
  totalItems: 0,
  totalPrice: 0,

  addItem: (item) => set((state) => ({
    items: [...state.items, item],
    totalItems: state.totalItems + item.quantity,
    totalPrice: state.totalPrice + item.total_price,
  })),

  // ... другие actions
}));
```

### Toast компонент
- **Success:** bg-success-bg, border-success, icon CheckCircle
- **Error:** bg-danger-bg, border-danger, icon XCircle
- **Position:** top-right
- **Duration:** 5000ms (auto-dismiss)

### Дизайн ProductSummary
- **priceBlock:**
  - background: bg-panel
  - radius: 20px
  - shadow: shadow-modal (используйте CSS переменную)
  - padding: 24px
  - typography: headline-m (28px, 600)

- **ctaPrimary:**
  - background: bg-primary
  - hover: bg-primary-hover
  - textColor: text-inverse
  - radius: 16px
  - height: 56px
  - font: body-l (18px, 500)

### Важные замечания
- Проверять авторизацию перед добавлением в корзину
- Использовать optimistic updates для лучшего UX
- Rollback в случае ошибки API
- Сохранять корзину в localStorage для гостей (опционально)

### Testing

#### Test file location
- Unit: `src/components/product/__tests__/ProductSummary.test.tsx`
- Store: `src/stores/__tests__/cartStore.test.ts`
- Integration: `src/components/product/__tests__/add-to-cart.integration.test.tsx`

#### MSW Mock
```typescript
rest.post('/api/v1/cart/items/', (req, res, ctx) => {
  return res(
    ctx.status(201),
    ctx.json({
      id: 1,
      product: { ... },
      quantity: 2,
      unit_price: 12499,
      total_price: 24998,
      added_at: new Date().toISOString(),
    })
  );
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-30 | 1.0 | Создание story 12.3 на основе Epic 12 | Sarah (PO) |

## Dev Agent Record
(Заполняется dev-агентом)

## QA Results
(Заполняется QA-агентом)
