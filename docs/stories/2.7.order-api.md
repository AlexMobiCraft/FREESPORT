# Story 2.7: order-api

## Status
Ready for Development

## Story
**As a** покупатель с товарами в корзине,
**I want** создать заказ с адресом доставки и способом оплаты,
**so that** завершить процесс покупки.

## Acceptance Criteria

1. POST `/orders/` создает заказ из текущей корзины
2. GET `/orders/{id}/` отображает детали заказа
3. Автогенерация уникального номера заказа
4. Поддержка способов доставки и оплаты
5. Транзакционная целостность при создании

- [ ] Создать Order models (AC: 1, 3)
  - [ ] Создать Order model согласно архитектуре
  - [ ] Создать OrderItem model с снимком данных
  - [ ] Добавить автогенерацию order_number
  - [ ] Настроить choices для статусов, доставки, оплаты
  - [ ] Добавить computed properties для totals

- [ ] Реализовать создание заказа (AC: 1)
  - [ ] Создать OrderCreateSerializer с валидацией
  - [ ] Реализовать POST /orders/ endpoint
  - [ ] Валидация непустой корзины
  - [ ] Проверка наличия товаров на складе
  - [ ] Валидация минимальных количеств для B2B

- [ ] Транзакционная логика (AC: 5)
  - [ ] Обернуть создание заказа в atomic transaction
  - [ ] Перенос товаров из корзины в OrderItems
  - [ ] Сохранение снимка цен на момент заказа
  - [ ] Очистка корзины после успешного создания
  - [ ] Rollback при любой ошибке в процессе

- [ ] Order detail API (AC: 2)
  - [ ] Создать OrderDetailSerializer с nested items
  - [ ] Реализовать GET /orders/{id}/ endpoint
  - [ ] Включить все детали: товары, адреса, статус
  - [ ] Проверка доступа к собственным заказам
  - [ ] Оптимизация запросов с prefetch_related

- [ ] Способы доставки и оплаты (AC: 4)
  - [ ] Валидация delivery_method из predefined choices
  - [ ] Валидация payment_method из available options
  - [ ] Расчет стоимости доставки (пока static)
  - [ ] Проверка совместимости методов для B2B/B2C
  - [ ] Добавление метаданных для payment integration

## Dev Notes

### Story Context
**Existing System Integration:**
- Интегрируется с: Cart, User, Address models
- Технология: DRF с транзакционной логикой
- Следует паттерну: Django atomic transactions
- Точки касания: Order creation, cart clearing, inventory validation

### Technical Notes
- **Integration Approach:** Django atomic transactions с валидацией через serializers
- **Existing Pattern Reference:** Django transaction.atomic для критических операций
- **Key Constraints:** Обеспечить consistency между корзиной и заказом

### Order Creation Logic
```python
from django.db import transaction

@transaction.atomic
def create_order_from_cart(self, user, order_data):
    # 1. Валидация корзины
    cart = user.cart
    if not cart.items.exists():
        raise ValidationError("Корзина пуста")
    
    # 2. Проверка наличия товаров
    for item in cart.items.all():
        if item.product.stock_quantity < item.quantity:
            raise ValidationError(f"Недостаточно товара {item.product.name}")
    
    # 3. Создание заказа
    order = Order.objects.create(
        user=user,
        order_number=self.generate_order_number(),
        **order_data
    )
    
    # 4. Перенос items из корзины
    for cart_item in cart.items.all():
        OrderItem.objects.create(
            order=order,
            product=cart_item.product,
            quantity=cart_item.quantity,
            unit_price=cart_item.unit_price,
            total_price=cart_item.total_price,
            # Снимок данных товара
            product_name=cart_item.product.name,
            product_sku=cart_item.product.sku,
        )
    
    # 5. Очистка корзины
    cart.items.all().delete()
    
    return order
```

### Order Number Generation
```python
def generate_order_number(self):
    import uuid
    from datetime import datetime
    
    # Формат: FS-YYMMDD-XXXXX
    date_part = datetime.now().strftime('%y%m%d')
    random_part = str(uuid.uuid4().hex)[:5].upper()
    return f"FS-{date_part}-{random_part}"
```

### Order Statuses
```python
ORDER_STATUSES = [
    ('pending', 'Ожидает обработки'),
    ('confirmed', 'Подтвержден'),
    ('processing', 'В обработке'),
    ('shipped', 'Отгружен'),
    ('delivered', 'Доставлен'),
    ('cancelled', 'Отменен'),
]

DELIVERY_METHODS = [
    ('courier', 'Курьер'),
    ('pickup', 'Самовывоз'),
    ('post', 'Почта России'),
]

PAYMENT_METHODS = [
    ('card', 'Банковская карта'),
    ('cash', 'Наличные'),
    ('bank_transfer', 'Банковский перевод'),
]
```

### Testing
- Unit тесты для Order creation
- Тестирование транзакционной логики
- Проверка валидации inventory
- Тестирование очистки корзины
- Integration тесты с Cart и Product

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-16 | 1.0 | Initial brownfield story creation | BMad Orchestrator |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
_TBD - будет заполнено dev агентом_

### Completion Notes List
_TBD - будет заполнено dev агентом_

### File List
_TBD - будет заполнено dev агентом_

## QA Results
_TBD - будет заполнено QA агентом_