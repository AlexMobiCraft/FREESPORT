# Story 1.5: cicd-infrastructure

## Status
Draft

## Story
**As a** разработчик,
**I want** автоматизировать процессы сборки и развертывания,
**so that** ускорить циклы разработки и повысить качество кода.

## Acceptance Criteria

1. Настроен GitHub Actions или аналогичный CI/CD
2. Созданы pipeline для автоматического тестирования
3. Настроена автоматическая сборка Docker образов
4. Настроено автоматическое развертывание на тестовой среде
5. Добавлены уведомления о статусе сборки

## Tasks / Subtasks

- [ ] Настроить GitHub Actions (AC: 1)
  - [ ] Создать .github/workflows директорию
  - [ ] Настроить workflow для backend (Django + pytest)
  - [ ] Настроить workflow для frontend (Next.js + Jest)
  - [ ] Конфигурировать triggers: push, pull_request

- [ ] Создать testing pipeline (AC: 2)
  - [ ] Настроить автоматический запуск тестов при PR
  - [ ] Добавить coverage reporting
  - [ ] Настроить linting (Black, Flake8, ESLint, Prettier)
  - [ ] Добавить type checking (mypy, TypeScript)

- [ ] Настроить Docker builds (AC: 3)
  - [ ] Создать multi-stage Dockerfile для backend
  - [ ] Создать multi-stage Dockerfile для frontend  
  - [ ] Настроить Docker image registry
  - [ ] Добавить automated tagging strategy

- [ ] Настроить deployment на staging (AC: 4)
  - [ ] Создать staging environment конфигурацию
  - [ ] Настроить автоматический deploy при merge в develop
  - [ ] Добавить health checks после deployment
  - [ ] Настроить rollback strategy при ошибках

- [ ] Добавить уведомления (AC: 5)
  - [ ] Настроить Slack/email уведомления о build status
  - [ ] Добавить GitHub status checks для PR
  - [ ] Настроить уведомления о failed deployments
  - [ ] Создать dashboard для мониторинга builds

## Definition of Done

- [ ] GitHub Actions workflows для backend и frontend расположены в `.github/workflows/` и проходят тестовый прогон
- [ ] Pipeline запускает линтеры, тесты, сборку Docker образов и публикацию в registry
- [ ] Staging окружение деплоится автоматически из `develop`, production требует ручного подтверждения
- [ ] Slack/Email уведомления приходят по завершению сборки и при ошибках
- [ ] Документация CI/CD (README, `/docs/architecture/14-cicd-deployment.md`) обновлена
- [ ] Набор секретов/переменных окружения описан и хранится в GitHub Secrets

## Dev Notes

### Технический контекст из архитектуры:

**CI/CD Strategy (GitHub Actions):**
- **Triggers:** Push to main/develop, Pull Requests
- **Environments:** Development, Staging, Production
- **Docker Registry:** GitHub Container Registry (ghcr.io)
- **Deployment:** Docker Swarm на VPS/VDS сервере

**Pipeline Stages:**
```yaml
1. Code Quality:
   - Linting (Black, ESLint)
   - Type checking (mypy, TypeScript)
   - Security scanning (bandit, npm audit)

2. Testing:
   - Backend unit tests (pytest)
   - Frontend unit tests (Jest)
   - Integration tests
   - Coverage reporting (>80%)

3. Build:
   - Docker multi-stage builds
   - Image optimization
   - Security scanning
   - Tagging strategy

4. Deploy:
   - Staging auto-deploy (develop branch)
   - Production manual approval (main branch)
   - Health checks
   - Rollback capability
```

**Environment Configuration:**
```bash
# Staging Environment
STAGING_API_URL=https://staging-api.freesport.com
STAGING_WEB_URL=https://staging.freesport.com

# Production Environment  
PROD_API_URL=https://api.freesport.com
PROD_WEB_URL=https://freesport.com
```

**Docker Strategy:**
- **Backend:** Python 3.11-slim + Django production setup
- **Frontend:** Node.js 18-alpine + Next.js static build
- **Reverse Proxy:** Nginx с SSL termination
- **Orchestration:** Docker Swarm для production

**Quality Gates:**
- Все тесты должны проходить (exit code 0)
- Coverage > 80% для backend и frontend
- No linting errors
- Successful Docker build
- Security scans passed

### Testing

**Testing Standards:**
- CI/CD testing: GitHub Actions workflows тестируются локально
- Pipeline testing: Используется act для локального запуска workflows
- Build testing: Docker builds тестируются на разных environments
- Deployment testing: Blue-green deployment strategy с health checks

**Тестирование для этой истории:**
- Валидация GitHub Actions workflow syntax
- Тест успешной сборки Docker образов
- Проверка автоматического запуска тестов
- Валидация deployment процесса на staging
- Тест rollback процедуры при ошибках

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-08 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
_TBD - будет заполнено dev агентом_

### Debug Log References  
_TBD - будет заполнено dev агентом_

### Completion Notes List
_TBD - будет заполнено dev агентом_

### File List
_TBD - будет заполнено dev агентом_

## QA Results
_TBD - будет заполнено QA агентом_