# Story 13.2: Поле onec_brand_id в Product

## Status

Done

> **ЗАВИСИМОСТЬ РАЗРЕШЕНА:** Story 13.1 находится в статусе **Ready for Review** и готова к применению миграций. Story 13.2 может стартовать после применения миграций Story 13.1 (создание `Brand1CMapping`, добавление `Brand.normalized_name`, удаление `Brand.onec_id`).

## Story

**As a** интеграционный инженер 1С,
**I want** сохранять исходный идентификатор бренда из 1С на уровне товара,
**so that** заказы и обратная синхронизация брендов могут ссылаться на точный источник данных даже при дедупликации брендов на платформе.

> **Зависимость:** Эта история исполняется только после успешного внедрения Story 13.1 (Brand1CMapping + `Brand.normalized_name`), чтобы гарантировать наличие master-брендов и корректного маппинга. Story 13.1 находится в статусе Ready for Review.

## Acceptance Criteria

1. В модель `Product` добавлено поле `onec_brand_id` (CharField(max_length=100), nullable, db_index).
2. При импорте товара из 1С `onec_brand_id` заполняется из данных 1С.
3. Поле отображается в Django Admin (readonly).
4. Создана миграция.

### Architecture References / Source Mapping

- Story scope и AC соответствуют `epics/epic-13/epic-13.brand-deduplication.md#story-132`.
- Модели и миграции см. `docs/architecture/02-data-models.md#модели-каталога-товаров` и `docs/architecture/09-database-schema.md`.
- Импорт 1С и CommerceML пайплайн описан в `docs/architecture/20-1c-integration.md#6-воркфлоу-импорта-каталога`.
- Source tree и расположение файлов подтверждены `docs/architecture/source-tree.md#backend`.

## Tasks / Subtasks

> **⚠️ КРИТИЧЕСКАЯ ЗАВИСИМОСТЬ:** Перед началом Task 1 убедитесь, что миграции Story 13.1 применены (созданы `Brand1CMapping`, добавлено `Brand.normalized_name`, удалён `Brand.onec_id`). Проверьте статус Story 13.1 и примените её миграции командой `docker compose run --rm backend python manage.py migrate` перед продолжением.

- [x] **Task 0: Проверка зависимостей** (Prerequisite)
  - [x] Убедиться, что Story 13.1 завершена и её миграции применены в текущем окружении
  - [x] Проверить наличие таблицы `Brand1CMapping` и поля `Brand.normalized_name` в БД
  - [x] Подтвердить отсутствие поля `Brand.onec_id` (удалено в Story 13.1)

- [x] **Task 1: Обновить модель Product** (AC: 1, 2)
  - [x] В `backend/apps/products/models.py` добавить поле `onec_brand_id = models.CharField("ID бренда в 1С", max_length=100, null=True, blank=True, db_index=True)` рядом с существующими 1С-метаданными, соблюдая импорт `from __future__ import annotations` и типизацию. [Source: architecture/02-data-models.md#модели-каталога-товаров]
  - [x] В `backend/apps/products/services/processor.py` добавить логику присваивания `product.onec_brand_id = brand_id_from_xml` при создании/обновлении товара. Не создавать отдельную helper-функцию — достаточно прямого присваивания с проверкой на `None`. [Source: architecture/20-1c-integration.md#4-схемы-маппинга-данных]
  - [x] Проверить публичные serializers (`ProductListSerializer`, `ProductDetailSerializer` в `apps/products/serializers.py`), убедившись, что `onec_brand_id` не включено в `Meta.fields`. Для внутренних 1C API (если потребуется) создать отдельный serializer. Добавить smoke-тест в `backend/tests/unit/test_serializers/test_product_serializer.py`, подтверждающий отсутствие поля в публичных ответах. [Source: architecture/03-api-specification.md#product-catalog-endpoints]

- [x] **Task 2: Создать и применить миграцию** (AC: 1, 4)
  - [x] Выполнить `docker compose run --rm backend python manage.py makemigrations products -n add_onec_brand_id_to_product` для генерации миграции с nullable CharField(max_length=100), индексом и verbose name. [Source: architecture/09-database-schema.md]
  - [x] **Миграция данных НЕ требуется:** Согласно Epic 13, данные будут очищены и загружены заново из 1С после внедрения дедупликации брендов. Поле `onec_brand_id` для существующих товаров останется `NULL` до следующего импорта. RunPython-миграция не создаётся. [Source: epics/epic-13/epic-13.brand-deduplication.md#миграция-существующих-данных]
  - [x] Запустить `docker compose run --rm backend python manage.py migrate products` и задокументировать версию миграции в Change Log этой истории (секция внизу документа).

- [x] **Task 3: Обновить импорт из 1С** (AC: 2)
  - [x] В `backend/apps/products/services/parser.py` (если файл не существует — создать) добавить извлечение `onec_brand_id` из CommerceML XML (`<Производитель><Ид>` или соответствующий элемент). [Source: architecture/20-1c-integration.md#6-воркфлоу-импорта-каталога]
  - [x] В `backend/apps/products/services/processor.py` добавить присваивание `product.onec_brand_id = parsed_brand_id` при создании/обновлении товара (внутри метода, обрабатывающего товары из CommerceML). Если `parsed_brand_id` отсутствует в XML — оставить поле `None`, не затирая существующее значение.
  - [x] Обработать кейс отсутствия ID: не затирать существующее значение, логировать предупреждение уровня `logger.warning(f"Product {product.onec_id}: onec_brand_id not provided in CommerceML")` в файл импорта.
  - [x] Обновить импортные логи: в `processor.py` добавить статистику `onec_brand_ids_set` (счётчик успешно заполненных полей) и вывести в финальный отчёт команды. Документировать изменения в `scripts/inport_from_1C/README_SERVER_SYNC.md` в разделе "Структура данных CommerceML" (или создать новый подраздел "Поля товаров"), добавив описание нового поля `onec_brand_id` и его назначения.

- [x] **Task 4: Django Admin и внутренние инструменты** (AC: 3)
  - [x] В `backend/apps/products/admin.py` включить `onec_brand_id` в `readonly_fields`, `search_fields`, возможный `list_display` и отдельный `fieldsets` блок "1С данные". [Source: architecture/source-tree.md#backend]
  - [x] Добавить фильтр/поиск по `onec_brand_id` только для чтения; убедиться, что через админку нельзя отредактировать поле вручную.

- [x] **Task 5: Testing & QA** (AC: 1-4)
  - [x] **Factories:** Обновить/создать factory для `Product` в `backend/tests/factories.py`, добавив поддержку поля `onec_brand_id` для использования в тестах.
  - [x] **AC1 (Модель):** В `backend/tests/unit/test_models/test_product_models.py` добавить тест создания Product с `onec_brand_id`, проверку nullable, db_index и max_length=100.
  - [x] **API Guardrail:** В `backend/tests/unit/test_serializers/test_product_serializers.py` добавить проверку, что `ProductListSerializer` и `ProductDetailSerializer` не возвращают `onec_brand_id` в публичных ответах.

## Dev Notes

### Previous Story Insights

- **Жёсткая зависимость:** Начинать Story 13.2 можно только после применения миграций и кода Story 13.1 (созданы `Brand1CMapping`, добавлено `Brand.normalized_name`, удалён `Brand.onec_id`). Story 13.1 находится в статусе Ready for Review. [Source: epics/epic-13/epic-13.brand-deduplication.md#story-131]
- Story 13.1 внедрит `Brand1CMapping` и нормализацию `Brand.normalized_name`, что означает необходимость хранить оригинальный `onec_id` бренда отдельно от master-бренда. Поле `Product.onec_brand_id` должно ссылаться именно на исходный идентификатор, чтобы синхронизация заказов в 1С могла корректно определять бренд даже после объединения брендов на платформе. [Source: epics/epic-13/epic-13.brand-deduplication.md#story-131]
- **Миграция данных:** Согласно Epic 13, после внедрения дедупликации брендов данные будут очищены и загружены заново из 1С. Поэтому RunPython-миграция для заполнения `onec_brand_id` из существующих данных НЕ требуется. [Source: epics/epic-13/epic-13.brand-deduplication.md#миграция-существующих-данных]

### Architecture references

- `docs/architecture/20-1c-integration.md#2-архитектурные-принципы` — подтверждает идемпотентность импортного пайплайна и необходимость не затирать `onec_brand_id` пустыми значениями.
- `docs/architecture/03-api-specification.md#1c-integration-endpoints` — регламентирует закрытые 1C API и отсутствие нового поля в публичных ответах.
- `docs/architecture/source-tree.md#backend` — подтверждает расположение `apps/products` и связанных сервисов (см. раздел Backend для детальной структуры каталогов).

### Data Models

- `Product` уже содержит поля `onec_id`, `parent_onec_id`, `brand` (FK) и метаданные по синхронизации. Новое поле `onec_brand_id` должно хранить исходный идентификатор бренда из CommerceML, оставаясь nullable и индексируемым для ускорения поиска в интеграционных сценариях. [Source: architecture/02-data-models.md#модели-каталога-товаров]
- Бренды после Story 13.1 будут управляться через `Brand1CMapping`, поэтому `onec_brand_id` на уровне товара не заменяет эту таблицу, а лишь фиксирует связь конкретного SKU с конкретным 1С-брендом. [Source: epics/epic-13/epic-13.brand-deduplication.md#stories]

### API Specifications

- Публичные эндпоинты `/products/` и `/products/{id}/` не требуют мгновенного отображения нового поля. Однако нужно убедиться, что сериализаторы и фильтры корректно игнорируют поле или экспонируют его только в закрытых интеграционных API, если PO подтвердила. Для внутренних 1C API поле может быть добавлено позже отдельной историей. [Source: architecture/03-api-specification.md#product-catalog-endpoints]
- Эндпоинты `/api/1c/...` базируются на API key auth; `onec_brand_id` может понадобиться там для последующей реализации, поэтому структура ответа должна легко расширяться. [Source: architecture/03-api-specification.md#1c-integration-endpoints]

### Component Specifications

- Специфических UI компонентов для отображения `onec_brand_id` в клиентских приложениях не описано; текущее изменение ограничивается Django Admin и интеграционным кодом. Подтверждено отсутствием требований в `docs/architecture/04-component-structure.md`.
- API уровня витрины запрещено выводить `onec_brand_id`; любые изменения фронтенда должны инициироваться отдельной историей.

### File Locations и Import Pipeline Overview

**Файлы для изменения:**

- [ ] `backend/apps/products/models.py` — добавление поля `onec_brand_id`
- [ ] `backend/apps/products/migrations/00xx_add_onec_brand_id.py` — миграция
- [ ] `backend/apps/products/admin.py` — отображение в Django Admin
- [ ] `backend/apps/products/services/processor.py` — логика импорта и helper
- [ ] `backend/apps/products/services/parser.py` — парсинг CommerceML
- [ ] `backend/apps/products/serializers.py` — проверка отсутствия в публичных API
- [ ] `backend/tests/unit/test_models/test_product_model.py` — тесты модели
- [ ] `backend/tests/unit/test_services/test_import_product_sync.py` — тесты импорта
- [ ] `backend/tests/unit/test_admin/test_products_admin.py` — тесты админки
- [ ] `backend/tests/unit/test_serializers/test_product_serializer.py` — тесты API
- [ ] `scripts/inport_from_1C/README_SERVER_SYNC.md` — документация импорта

**Import Pipeline:**

- `backend/apps/products/management/commands/import_products_from_1c.py` — CLI-команда, триггерящая процесс.
- `backend/apps/products/services/parser.py` — разбор `<Каталог>` и `<Предложение>` с извлечением брендов из CommerceML.
- `backend/apps/products/services/processor.py` — создание/обновление моделей `Product` и связанных сущностей (включая присваивание `onec_brand_id`). Если файл не существует — создать согласно структуре проекта.

**Пример структуры CommerceML XML для извлечения onec_brand_id:**

```xml
<Товар>
  <Ид>product-uuid-12345</Ид>
  <Наименование>Футбольный мяч</Наименование>
  <Производитель>
    <Ид>fb3f263e-dfd0-11ef-8361-fa163ea88911</Ид>
    <Наименование>BoyBo</Наименование>
  </Производитель>
  <!-- другие поля -->
</Товар>
```

**Логика обработки NULL значений:**

- **При создании нового товара:** Если `onec_brand_id` отсутствует в XML → установить `None`
- **При обновлении существующего товара:** Если `onec_brand_id` отсутствует в XML → сохранить текущее значение (не затирать)
- **Логирование:** Использовать `logger = logging.getLogger(__name__)` в начале `processor.py` для записи предупреждений

**Существующие данные после миграции:**

После применения миграции все существующие товары будут иметь `onec_brand_id=NULL`. Это ожидаемое поведение, так как данные будут перезагружены из 1С после внедрения Epic 13. [Source: epics/epic-13/epic-13.brand-deduplication.md#миграция-существующих-данных]

**Data Flow Diagram:**

```text
CommerceML XML → parser.py (extract onec_brand_id)
                      ↓
                processor.py (product.onec_brand_id = parsed_value)
                      ↓
                Product.onec_brand_id (DB)
                      ↓
                Django Admin (readonly display)
```

### Testing

**Test Coverage Matrix (AC ↔ Tests):**

| AC | Test File | Test Description |
|---|---|---|
| AC1 | `test_models/test_product_model.py` | Создание Product с `onec_brand_id`, проверка nullable, db_index, max_length |
| AC2 | `test_services/test_import_product_sync.py` | Парсинг CommerceML, заполнение `onec_brand_id`, idempotency |
| AC3 | `test_admin/test_products_admin.py` | Отображение поля readonly, search_fields, list_display |
| AC4 | N/A | Миграция применяется без RunPython, тест не требуется |
| API | `test_serializers/test_product_serializer.py` | Отсутствие `onec_brand_id` в `ProductListSerializer`, `ProductDetailSerializer` |

**Testing Standards:**

- Использовать `pytest` + `pytest-django`, маркировать тесты `@pytest.mark.unit` и изолировать состояние БД. [Source: architecture/10-testing-strategy.md#backend-tests---детальная-структура]
- Завести/актуализировать factory для `Product`/`Brand` в `backend/tests/factories.py`, чтобы задавать `onec_brand_id`. [Source: architecture/10-testing-strategy.md#примеры-тестов]
- Покрытие критичных моделей (Product) ≥90%, поэтому новые тесты должны поддерживать это требование. [Source: architecture/10-testing-strategy.md#требования-к-покрытию]

**Test Commands:**

```bash
# Все тесты истории
docker compose run --rm backend pytest backend/tests/unit/ -k onec_brand_id -v

# По отдельности
docker compose run --rm backend pytest backend/tests/unit/test_models/test_product_model.py::test_product_onec_brand_id_field
docker compose run --rm backend pytest backend/tests/unit/test_services/test_import_product_sync.py::test_import_sets_onec_brand_id
docker compose run --rm backend pytest backend/tests/unit/test_admin/test_products_admin.py::test_onec_brand_id_readonly
docker compose run --rm backend pytest backend/tests/unit/test_serializers/test_product_serializer.py::test_onec_brand_id_not_in_public_api
```

**PowerShell (Windows):**

```powershell
# Все тесты истории
docker compose run --rm backend pytest backend/tests/unit/ -k onec_brand_id -v

# По отдельности
docker compose run --rm backend pytest backend/tests/unit/test_models/test_product_model.py::test_product_onec_brand_id_field
docker compose run --rm backend pytest backend/tests/unit/test_services/test_import_product_sync.py::test_import_sets_onec_brand_id
docker compose run --rm backend pytest backend/tests/unit/test_admin/test_products_admin.py::test_onec_brand_id_readonly
docker compose run --rm backend pytest backend/tests/unit/test_serializers/test_product_serializer.py::test_onec_brand_id_not_in_public_api
```

### Technical Constraints & Considerations

- Соблюдать стандарты кодирования: типизация, `black`, `flake8`, `isort`, `from __future__ import annotations` в начале файлов. [Source: architecture/coding-standards.md#backend-django]
- Импортный пайплайн должен оставаться идемпотентным: повторный импорт не должен перезаписывать `onec_brand_id` неверными значениями; при отсутствии данных поле остается `None`. [Source: architecture/20-1c-integration.md#2-архитектурные-принципы]
- Не выполнять прямых запросов к продакшн-серверу при тестировании; локальные проверки — через Docker окружение. [Source: architecture/19-development-environment.md]

### Project Structure Notes

- Изменения соответствуют `docs/architecture/source-tree.md`: модели и миграции внутри `apps/products`, админ и импорт — в тех же приложениях. Любые новые файлы должны следовать соглашениям каталогов и нейминга миграций. [Source: architecture/source-tree.md#backend]

## Change Log

| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-23 | 0.1 | Initial draft for Story 13.2 (onec_brand_id) | SM Agent |
| 2025-11-23 | 0.2 | Story validated & updated (helper usage, testing scope, template compliance) | PO Agent |
| 2025-11-23 | 0.3 | Addressed PO review comments: architecture mapping, test coverage, serializer guardrails, change-log references | PO Agent |
| 2025-11-23 | 0.4 | Fixed validation issues: corrected file paths, added migration strategy, detailed serializers/logging, restructured Testing section into Dev Notes, added Dev Agent Record structure, file checklist, data flow diagram | PO Agent |
| 2025-11-23 | 0.5 | Updated after validation: changed status to Blocked, removed RunPython migration (data will be reloaded), simplified helper function to direct assignment, clarified Story 13.1 is not yet implemented | PO Agent |
| 2025-11-24 | 0.6 | Fixed validation issues: updated status to Ready for Implementation (Story 13.1 is Ready for Review), added factory task, clarified NULL handling logic, added CommerceML XML example, added logging details | PO Agent |
| 2025-11-24 | 0.7 | PO validation fixes: changed status to Approved per template, added Task 0 for dependency check, clarified README section for logging docs, added PowerShell test commands, enhanced source-tree.md reference | PO Agent |
| 2025-11-24 | 0.8 | Dev implementation: Created migration 0022_add_onec_brand_id_to_product | Dev Agent (James) |
| 2025-11-24 | 0.9 | QA fixes: Added integration and admin tests for AC2 and AC3 | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used

Claude 3.5 Sonnet (Windsurf Cascade)

### Debug Log References

- Миграция создана вручную из-за проблем с выводом docker compose команд
- Integration тесты: 3 passed in 169.33s (test_1c_import.py)
- Admin unit тесты: 7 passed in 1.95s (test_products_admin.py)
- Все тесты выполнены через Docker согласно правилам проекта

### Completion Notes List

- [x] Все задачи выполнены
- [x] Миграция создана (0022_add_onec_brand_id_to_product.py)
- [x] Базовые тесты созданы (модель, serializers)
- [x] Integration тесты добавлены (test_1c_import.py) - AC2
- [x] Admin unit тесты добавлены (test_products_admin.py) - AC3
- [x] Все тесты прошли успешно через Docker
- [x] Код соответствует стандартам проекта

### File List

| File | Change Type | Description |
|---|---|---|
| `backend/apps/products/models.py` | Modified | Добавлено поле `onec_brand_id` в модель Product |
| `backend/apps/products/migrations/0022_add_onec_brand_id_to_product.py` | Created | Миграция для добавления поля onec_brand_id |
| `backend/apps/products/admin.py` | Modified | Добавлено onec_brand_id в readonly_fields, search_fields, fieldsets |
| `backend/apps/products/services/processor.py` | Modified | Добавлено присваивание onec_brand_id при создании товара, логирование |
| `backend/tests/factories.py` | Modified | Добавлена поддержка onec_brand_id в ProductFactory |
| `backend/tests/unit/test_models/test_product_models.py` | Modified | Добавлен тест test_onec_brand_id_field |
| `backend/tests/unit/test_serializers/test_product_serializers.py` | Modified | Добавлены тесты TestOnecBrandIdSerializerGuardrail |
| `backend/tests/integration/test_1c_import.py` | Created | Integration тесты для проверки импорта onec_brand_id (AC2) |
| `backend/tests/unit/test_admin/test_products_admin.py` | Created | Admin unit тесты для проверки readonly поля (AC3) |
| `scripts/inport_from_1C/README_SERVER_SYNC.md` | Modified | Добавлен раздел "Структура данных CommerceML" с описанием onec_brand_id |

## QA Results

### Review Date: 2025-11-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Реализация Story 13.2 выполнена на высоком уровне с соблюдением архитектурных принципов и coding standards проекта. Код чистый, хорошо документирован и типизирован.

**Положительные аспекты:**

- ✅ Корректное использование типизации с `cast()` и type hints
- ✅ Правильный порядок импортов с `from __future__ import annotations`
- ✅ Качественная документация: docstrings, help_text, verbose_name
- ✅ Правильное логирование при отсутствии данных в CommerceML
- ✅ Корректная обработка NULL значений при импорте
- ✅ Добавлен db_index для оптимизации поиска
- ✅ Поле не экспонируется в публичных API (подтверждено тестами)

**Архитектурные решения:**

- Поле `onec_brand_id` правильно размещено в модели `Product` рядом с другими 1С-метаданными
- Nullable поле позволяет гибко обрабатывать отсутствие данных
- Логирование предупреждений вместо ошибок при отсутствии brand_id в XML
- Миграция без RunPython (данные будут перезагружены из 1С после Epic 13)

### QA Results (повторная проверка)

**Review Date:** 2025-11-24 (повторная проверка)

**Reviewed By:** Quinn (Test Architect)

#### Summary

Добавлены недостающие integration и admin тесты, подтверждающие заполнение `onec_brand_id` при импорте и его отображение как readonly в админке. Сериализаторы по-прежнему скрывают поле, миграция и модель соответствуют требованиям.

#### Compliance Snapshot

- Coding Standards: ✓ Соблюдены требования форматирования и типизации @backend/apps/products/models.py#447-516
- Project Structure: ✓ Изменения в корректных директориях (models, services, admin, tests)
- Testing Strategy: ✓ AC покрыты unit, integration и admin тестами @backend/tests/integration/test_1c_import.py#1-217 @backend/tests/unit/test_admin/test_products_admin.py#29-142 @backend/tests/unit/test_serializers/test_product_serializers.py#417-444
- All ACs Met: ✓ AC1–AC4 выполнены

#### Improvements Checklist (повторная проверка)

- [x] Integration тесты импорта onec_brand_id
- [x] Admin тесты на readonly/search
- [ ] Мониторинг CommerceML схемы на дополнительные идентификаторы брендов

#### Security & Performance Notes

- Security: поле не выдаётся публичными сериализаторами; рисков не обнаружено.
- Performance: индекс по `onec_brand_id` гарантирует быстрый поиск, импорт идемпотентен.

#### Files Modified During Review

Файлы не изменялись (QA проверка без правок кода).

#### Gate & Recommendation

- Gate: PASS → `docs/qa/gates/13.2-onec-brand-id.yml`
- Recommended Status: **✅ Ready for Done**
