# План разработки парсеров для данных из 1С (Epic 3) — Версия 3.0

Этот документ описывает пошаговый план разработки парсеров для обработки данных в формате CommerceML 3.1 на основе фактической структуры выгрузки и результатов архитектурного ревью.

## Цели

1. Разработать модульные и последовательные парсеры для каждой сущности.
2. Обеспечить корректное создание и обновление моделей Django на основе данных из XML.
3. Гарантировать целостность данных и подготовить основу для будущего перехода на API.

## Архитектурные принципы

1. **Использование "Сессий импорта"**
    - **Задача:** обеспечить целостность данных при сбоях.
    - **Реализация:** создать модель `ImportSession` и привязывать к ней все создаваемые и обновляемые объекты. В случае сбоя это позволит откатить изменения.
2. **Абстрагирование сервисного слоя**
    - **Задача:** упростить будущий переход с файлового обмена на API.
    - **Реализация:** разделить логику на два слоя: `Парсер` (читает XML и приводит к внутреннему формату, например dict) и `Процессор` (принимает внутренний формат и работает с моделями Django). В будущем потребуется заменить только `Парсер`.

## Фазы разработки

### Фаза 1: Парсинг справочников

1. **Задача 1.1 – 1.3:** Парсинг `units.xml`, `storages.xml`, `priceLists.xml` .
2. **Задача 1.4: Справочники свойств (`propertiesGoods/`, `propertiesOffers/`)**
    - Создать модели `Property` и `PropertyValue`.
    - Реализовать парсер для директорий `propertiesGoods` и `propertiesOffers`.
    - **[Дополнение]** Если встречается свойство "Бренд" (или похожее), его значения (`<ВариантыЗначений>`) использовать для создания/обновления записей в модели `Brand`.

### Фаза 2: Парсинг каталога

1. **Задача 2.1:** Парсинг категорий (`groups.xml`)
2. **Задача 2.2:** Парсинг товаров (`goods/goods.xml`)
    - Извлекать базовые поля и связывать их с категорией и единицами измерения.
    - **[Дополнение]** При обработке `<ЗначенияСвойств>` находить свойство "Бренд" и устанавливать связь `product.brand` с соответствующей записью в модели `Brand`.

### Фаза 3: Парсинг торговых предложений (SKU) и связанных данных

1. **Задача 3.1:** Парсинг предложений (`offers.xml`).
2. **Задача 3.2:** Парсинг цен (`prices.xml`)
    - (Без изменений) Создать/обновить модель `Price`.
    - **[Дополнение]** Если для товара не найдена цена для роли `federation_rep`, использовать значение розничной цены (`retail_price` / «РРЦ»).
3. **Задача 3.3:** Парсинг остатков (`rests.xml`).

### Фаза 4: Финализация и тестирование

1. **Задача 4.1:** Создание главной management-команды
    - Создать команду `import_catalog_from_1c`.
2. **Задача 4.2:** Написание тестов.
    - **Примечание:** Для тестирования используются реальные данные из выгрузки 1С, расположенные в директории `data/import_1c/`. Генерация тестовых данных не требуется.
3. **Задача 4.3:** Логирование и обработка ошибок.

## Согласование

После ознакомления с этим планом и документом [`../../architecture/20-1c-integration.md`](../../architecture/20-1c-integration.md) (Приложение А) необходимо провести согласование для подтверждения подхода и начала разработки.
