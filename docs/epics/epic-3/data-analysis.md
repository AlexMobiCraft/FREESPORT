# Анализ структуры данных CommerceML (Epic 3) - Версия 2.0

Этот документ описывает фактическую структуру данных, полученных из 1С в формате CommerceML 3.1, на основе детального анализа файлов в директории `backend/tests/legacy/Обмен с сайтом`.

## Общая архитектура выгрузки

Выгрузка имеет модульную структуру. Данные не содержатся в одном файле, а разделены по разным директориям и файлам, каждый из которых является справочником или содержит определенный тип информации.

**Ключевые директории и файлы:**

- `goods/goods.xml`: Основная информация о товарах (продуктах).
- `groups/groups.xml`: Иерархия категорий товаров.
- `offers/offers.xml`: Торговые предложения (SKU), вариации товаров.
- `prices/prices.xml`: Цены для каждого SKU.
- `rests/rests.xml`: Остатки SKU на складах.
- `propertiesGoods/`: Справочники свойств товаров и их значений.
- `propertiesOffers/`: Справочники свойств предложений (SKU).
- `priceLists/priceLists.xml`: Справочник типов цен.
- `storages/storages.xml`: Справочник складов.
- `units/units.xml`: Справочник единиц измерения.
- `contragents/contragents.xml`: Справочник контрагентов (клиентов).

---

## Детальный анализ файлов

### 1. `goods/goods.xml` - Товары (Продукты)

- **Назначение**: Центральный файл, описывающий базовые товары.
- **Структура**: `<Каталог>` -> `<Товары>` -> `<Товар>`
- **Ключевые поля узла `<Товар>`**:
  - `<Артикул>`: Артикул товара.
  - `<Наименование>`: Базовое наименование товара.
  - `<БазоваяЕдиница>`: ID единицы измерения из `units.xml`.
  - `<Группы>`: Содержит `<Ид>` категории из `groups.xml`.
  - `<Описание>`: HTML-описание товара.
  - `<Картинка>`: Путь к файлу изображения. Может быть несколько.
  - `<ЗначенияСвойств>`: Блок со ссылками на значения свойств из справочников в `propertiesGoods/`.
  - `<ЗначенияРеквизитов>`: Дополнительные, неструктурированные реквизиты, такие как "ВидНоменклатуры", "ТипНоменклатуры", "Полное наименование".

### 2. `groups/groups.xml` - Категории

- **Назначение**: Описание иерархии каталога.
- **Структура**: `<Классификатор>` -> `<Группы>` -> `<Группа>`
- **Ключевые поля узла `<Группа>`**:
  - `<Ид>`: Уникальный UUID категории.
  - `<Наименование>`: Название категории.
  - `<Группы>`: Вложенный узел для дочерних категорий, что формирует дерево.

### 3. `offers/offers.xml` - Торговые предложения (SKU)

- **Назначение**: Описание конкретных вариаций товаров.
- **Структура**: `<ПакетПредложений>` -> `<Предложения>` -> `<Предложение>`
- **Ключевые поля узла `<Предложение>`**:
  - `<Ид>`: Составной идентификатор вида `[ИдТовара]#[ИдХарактеристики]`. Позволяет связать SKU с базовым товаром из `goods.xml`.
  - `<Наименование>`: Полное наименование SKU (например, с указанием цвета и размера).
  - `<ХарактеристикиТовара>`: Список характеристик, определяющих данный SKU (например, "Длина коробки", "Вес").
  - `<ЗначенияСвойств>`: Ссылки на ID свойств из `propertiesOffers/`.

### 4. `prices/prices.xml` - Цены

- **Назначение**: Указание цен для товаров и их предложений.
- **Структура**: `<ПакетПредложений>` -> `<Предложения>` -> `<Предложение>`
- **Ключевые поля узла `<Предложение>`**:
  - `<Ид>`: ID товара или SKU, к которому относится цена.
  - `<Цены>` -> `<Цена>`:
.  - `<ИдТипаЦены>`: UUID типа цены из `priceLists.xml`.
.  - `<ЦенаЗаЕдиницу>`: Числовое значение цены.
.  - `<Валюта>`: Валюта (например, `руб`).

### 5. `rests/rests.xml` - Остатки

- **Назначение**: Указание количества товара на складах.
- **Структура**: `<ПакетПредложений>` -> `<Предложения>` -> `<Предложение>`
- **Ключевые поля узла `<Предложение>`**:
  - `<Ид>`: ID товара или SKU.
  - `<Остатки>` -> `<Остаток>`:
.  - `<Склад>`:
. . - `<Ид>`: UUID склада из `storages.xml`.
. . - `<Количество>`: Числовое значение остатка.

### 6. Справочники

- **`priceLists/priceLists.xml`**: Справочник типов цен. Содержит ID и наименования (например, "РРЦ", "Опт 1").
- **`storages/storages.xml`**: Справочник складов. Содержит ID и наименования складов.
- **`units/units.xml`**: Справочник единиц измерения (шт, кг, м и т.д.).
- **`propertiesGoods/` и `propertiesOffers/`**: Директории с XML-файлами, описывающими свойства и их возможные значения (`<ВариантыЗначений>`). Например, свойство "Цвет" и его варианты "Красный", "Синий".
- **`contragents/contragents.xml`**: Справочник клиентов (покупателей) с их реквизитами. На данном этапе для парсинга каталога не используется, но важен для будущей интеграции заказов.

## Схема взаимодействия данных

1. **Категории (`groups.xml`)** образуют древовидную структуру.
2. **Товары (`goods.xml`)** привязываются к категориям через `<Группы>`.
3. **Предложения/SKU (`offers.xml`)** привязываются к товарам через составной `<Ид>`.
4. **Цены (`prices.xml`)** и **Остатки (`rests.xml`)** привязываются к товарам или SKU по их `<Ид>`.
5. Все идентификаторы (типы цен, склады, единицы измерения, свойства) расшифровываются с помощью соответствующих файлов-справочников.

Эта структура требует последовательного парсинга, начиная со справочников и категорий, и заканчивая обновлением товаров ценами и остатками.

---

## Анализ файлов-справочников

Детальное описание структуры и ключевых полей основных справочников.

### 1. `priceLists/priceLists.xml` - Справочник типов цен

- **Назначение:** Определяет соответствие между UUID типа цены и его коммерческим названием. Крайне важен для маппинга цен на роли пользователей в FREESPORT.
- **Структура:** `<ТипыЦен>` -> `<ТипЦены>`
- **Ключевые поля узла `<ТипЦены>`:**
  - `<Ид>`: Уникальный UUID типа цены. **Пример:** `90d2c899-b3f2-11ea-81c3-00155d3cae02`.
  - `<Наименование>`: Человекочитаемое название типа цены. **Пример:** `Опт 1 (300-600 тыс.руб в квартал)`.
  - `<Валюта>`: Валюта цены, как правило, `RUB`.
  - `<Налог>`: Информация о налогах, обычно НДС.

### 2. `propertiesGoods/` и `propertiesOffers/` - Справочники свойств

- **Назначение:** Описывают все возможные характеристики товаров (например, "Бренд", "Цвет", "Материал") и их значения.
- **Структура:** Каждый файл в директории описывает одно свойство. `<Классификатор>` -> `<Свойства>` -> `<Свойство>`
- **Ключевые поля узла `<Свойство>`:**
  - `<Ид>`: Уникальный UUID свойства.
  - `<Наименование>`: Название свойства. **Пример:** `Бренд`.
  - `<ВариантыЗначений>`: Перечень возможных значений этого свойства.
  - `<Справочник>`:
    - `<ИдЗначения>`: UUID конкретного значения.
    - `<Значение>`: Текстовое представление значения. **Пример:** `Nike`.

### 3. `units/units.xml` - Справочник единиц измерения

- **Назначение:** Определяет единицы, в которых измеряется товар (штуки, килограммы, упаковки и т.д.).
- **Структура:** `<ЕдиницыИзмерения>` -> `<ЕдиницаИзмерения>`
- **Ключевые поля узла `<ЕдиницаИзмерения>`:**
  - `<Ид>`: Кодовый идентификатор единицы. **Пример:** `796`.
  - `<НаименованиеКраткое>`: Краткое обозначение. **Пример:** `шт`.
  - `<НаименованиеПолное>`: Полное наименование. **Пример:** `штук`.

### 4. `storages/storages.xml` - Справочник складов

- **Назначение:** Перечень складов, с которых могут отгружаться товары.
- **Структура:** `<Склады>` -> `<Склад>`
- **Ключевые поля узла `<Склад>`:**
  - `<Ид>`: Уникальный UUID склада.
  - `<Наименование>`: Название склада. **Пример:** `1 СДВ склад`.
