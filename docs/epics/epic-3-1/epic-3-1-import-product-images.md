# Epic 3.1: Импорт и связь изображений товаров из 1С - Brownfield Enhancement

## Epic Goal

Реализовать автоматический импорт изображений товаров из директории выгрузки 1С и установить связь между товарами и их изображениями через поля `main_image` и `gallery_images` модели Product.

## Epic Description

### Existing System Context

**Текущая функциональность:**
- Epic 3 реализует парсинг данных о товарах из XML выгрузки 1С (CommerceML 3.1)
- Команда `import_catalog_from_1c` импортирует товары, категории, бренды, цены и остатки
- Модель Product имеет поля для изображений: `main_image` (ImageField) и `gallery_images` (JSONField)
- XML файлы товаров содержат теги `<Картинка>` с относительными путями к изображениям

**Технологический стек:**
- Django 4.2 + PostgreSQL 15+
- Django ImageField для хранения изображений
- JSON поле для галереи изображений
- Management команды для импорта из 1С
- XMLDataParser и ProductDataProcessor для обработки данных

**Точки интеграции:**
- Модель Product ([backend/apps/products/models.py:161-349](backend/apps/products/models.py))
- Команда импорта ([backend/apps/products/management/commands/import_catalog_from_1c.py](backend/apps/products/management/commands/import_catalog_from_1c.py))
- XMLDataParser для парсинга XML
- ProductDataProcessor для обработки данных товаров

### Enhancement Details

**Что добавляется:**

Пропущенная функциональность импорта изображений из директории `data/import_1c/goods/import_files/`, где:
- Изображения хранятся в поддиректориях, названных по первым двум символам ID товара из 1С (например, `73/` для товара `73f9d61e-...`)
- Имена файлов изображений содержат ID товара в 1С
- XML содержит пути к изображениям в тегах `<Картинка>` (например, `import_files/73/73f9d61e-5673-11f0-8041-fa163ea88911_a62d33ce-5673-11f0-8041-fa163ea88911.png`)

**Как интегрируется:**
1. Расширение XMLDataParser для извлечения путей изображений из тега `<Картинка>`
2. Добавление логики в ProductDataProcessor для копирования изображений в Django media storage
3. Установка связи через поля `main_image` (первое изображение) и `gallery_images` (остальные)
4. Обработка множественных изображений для одного товара

**Критерии успеха:**
- Все изображения из `data/import_1c/goods/import_files/` корректно импортируются
- Первое изображение устанавливается как `main_image`
- Дополнительные изображения добавляются в `gallery_images`
- Связь товар-изображение устанавливается по `onec_id`
- Обработка отсутствующих файлов с логированием ошибок

### Stories

1. **Story 1: Парсинг путей изображений из XML**
   - Расширить XMLDataParser для извлечения всех тегов `<Картинка>` из goods.xml
   - Валидация путей изображений
   - Обработка множественных изображений для одного товара
   - Unit-тесты для парсера с реальными XML данными

2. **Story 2: Импорт изображений в Django media storage**
   - Расширить ProductDataProcessor для копирования изображений из `import_files/` в Django media
   - Установка `main_image` (первое изображение) и `gallery_images` (остальные)
   - Обработка дубликатов и отсутствующих файлов
   - Логирование успешных и неудачных импортов

3. **Story 3: Интеграционное тестирование импорта изображений**
   - Тесты на реальных данных из `data/import_1c/goods/`
   - Верификация корректности путей в БД
   - Проверка физического наличия файлов в media storage
   - Тестирование edge cases (отсутствующие файлы, невалидные пути)

### Compatibility Requirements

- [x] Существующий API Product остается неизменным
- [x] Поля `main_image` и `gallery_images` уже существуют в модели - миграция БД не требуется
- [x] Команда `import_catalog_from_1c` расширяется без breaking changes
- [x] Обратная совместимость с товарами без изображений
- [x] Производительность: batch обработка изображений для минимизации I/O

### Risk Mitigation

**Primary Risk:** Большой объем изображений может замедлить импорт и занять много места в media storage

**Mitigation:**
- Использование bulk операций для копирования файлов
- Опциональный параметр `--skip-images` в команде импорта
- Проверка доступного дискового пространства перед импортом
- Поддержка инкрементального импорта (только новые/измененные изображения)

**Rollback Plan:**
- Очистка media storage от импортированных изображений
- Обнуление полей `main_image` и `gallery_images` для затронутых товаров
- Восстановление из backup ImportSession

### Definition of Done

- [ ] Все 3 истории завершены с acceptance criteria
- [ ] Изображения корректно импортируются из реальных данных `data/import_1c/goods/`
- [ ] Связь товар-изображение работает через `onec_id`
- [ ] Unit и интеграционные тесты покрывают >90% нового кода
- [ ] Существующие тесты импорта каталога проходят без регрессий
- [ ] Документация команды `import_catalog_from_1c` обновлена

---

## Validation Checklist

### Scope Validation

- [x] Epic завершается в 3 stories максимум ✅
- [x] Архитектурная документация не требуется (используем существующие паттерны парсера/процессора) ✅
- [x] Enhancement следует существующим паттернам XMLDataParser + ProductDataProcessor ✅
- [x] Интеграционная сложность управляема (расширение существующих классов) ✅

### Risk Assessment

- [x] Риск для существующей системы низкий (только добавление функциональности) ✅
- [x] Rollback план осуществим (очистка media + reset полей изображений) ✅
- [x] Тестирование покрывает существующую функциональность (тесты Epic 3) ✅
- [x] Команда имеет достаточные знания о точках интеграции (XMLDataParser, ProductDataProcessor) ✅

### Completeness Check

- [x] Epic goal ясный и достижимый ✅
- [x] Stories правильно размещены (парсинг → импорт → тестирование) ✅
- [x] Критерии успеха измеримы (все изображения импортированы, связь установлена) ✅
- [x] Зависимости идентифицированы (Epic 3, модель Product, структура import_files/) ✅

---

## Story Manager Handoff

**Story Manager Handoff:**

"Пожалуйста, разработайте детальные user stories для этого brownfield эпика. Ключевые соображения:

- Это enhancement к существующей системе импорта из 1С, работающей на Django 4.2 + PostgreSQL 15+
- **Точки интеграции:**
  - XMLDataParser для парсинга тегов `<Картинка>` из goods.xml
  - ProductDataProcessor для копирования изображений в Django media
  - Модель Product с полями `main_image` и `gallery_images`
  - Команда `import_catalog_from_1c` для оркестрации импорта

- **Существующие паттерны для соблюдения:**
  - Bulk операции через ProductDataProcessor (chunk_size=1000)
  - Логирование через ImportSession
  - Обработка ошибок с продолжением импорта
  - Dry-run режим для тестирования

- **Критические требования совместимости:**
  - Товары без изображений должны корректно обрабатываться
  - API Product остается неизменным
  - Существующие тесты Epic 3 не должны ломаться
  - Команда импорта должна поддерживать `--skip-images` флаг

- **Каждая история должна включать:**
  - Верификацию работы на реальных данных из `data/import_1c/goods/`
  - Unit-тесты и интеграционные тесты
  - Обработку edge cases (отсутствующие файлы, невалидные пути)
  - Проверку, что существующая функциональность импорта остается нетронутой

Эпик должен поддерживать целостность системы при доставке функциональности импорта изображений товаров из выгрузки 1С."

---

## Зависимости

- **Epic 3:** Импорт товаров из 1С (реализован)
- **Модель Product:** Поля `main_image` и `gallery_images` (существуют)
- **Структура данных 1С:** Директория `data/import_1c/goods/import_files/` с изображениями
- **XMLDataParser:** Базовый функционал парсинга CommerceML 3.1
- **ProductDataProcessor:** Обработка данных товаров с bulk операциями

## Технические детали

### Структура путей изображений в 1С

**XML структура (goods.xml):**
```xml
<Товар>
    <Ид>73f9d61e-5673-11f0-8041-fa163ea88911</Ид>
    <Наименование>Детский защитный велошлем COSMORIDE</Наименование>
    <Картинка>import_files/73/73f9d61e-5673-11f0-8041-fa163ea88911_a62d33ce-5673-11f0-8041-fa163ea88911.png</Картинка>
    <!-- Возможны дополнительные теги <Картинка> для галереи -->
</Товар>
```

**Физическая структура директории:**
```
data/import_1c/goods/import_files/
├── 00/
│   ├── 001a16a4-b810-11ed-860f-fa163edba792_24062354-2f7b-11ee-998f-fa163e775e1f.jpg
│   └── ...
├── 01/
├── ...
└── 73/
    └── 73f9d61e-5673-11f0-8041-fa163ea88911_a62d33ce-5673-11f0-8041-fa163e775e1f.png
```

### Логика маппинга

1. **Парсинг XML:** Извлечь все теги `<Картинка>` для каждого товара
2. **Построение полного пути:** `data/import_1c/goods/{относительный_путь_из_xml}`
3. **Копирование в media:** Django `default_storage.save()` в `media/products/`
4. **Установка связи:**
   - Первое изображение → `Product.main_image`
   - Остальные → `Product.gallery_images` (JSON список путей)

### Обработка ошибок

- **Файл не найден:** Логировать warning, пропустить изображение, продолжить импорт
- **Невалидный формат:** Валидация расширения файла (jpg, jpeg, png, webp)
- **Дубликаты:** Проверить существование файла в media, использовать существующий
- **Отсутствие изображений:** Товар без изображений валиден, пропустить обработку изображений

---

**Дата создания:** 2025-11-08
**Статус:** Draft
**Приоритет:** Medium
**Владелец Epic:** Product Team
