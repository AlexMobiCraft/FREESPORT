# Epic: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑ 1–° - Brownfield Enhancement

## Epic Goal

–†–∞–∑–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–º–ø–æ—Ä—Ç–∞ –∏–∑ 1–° –Ω–∞ –¥–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–µ—Å—Å–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤ –±–æ–ª–µ–µ –ª–æ–≥–∏—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –∏—Å–ø—Ä–∞–≤–∏–≤ –Ω–µ–¥–æ—á–µ—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ 9.5.

## Epic Description

### Existing System Context:

- **–¢–µ–∫—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:** Django admin –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å action "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π –∏–º–ø–æ—Ä—Ç–∞
- **Technology stack:** Django 5.0, Django Admin, Celery –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á, Redis –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- **Integration points:** 
  - IntegrationImportSession model (proxy –º–æ–¥–µ–ª—å ImportSession)
  - Celery –∑–∞–¥–∞—á–∞ run_selective_import_task
  - Django admin actions —Å intermediate page
  - Redis distributed lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### Existing Import Infrastructure (–∏–∑ Epic 3):

**–ü–∞—Ä—Å–µ—Ä—ã –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã (‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ Epic 3):**
- `XMLDataParser` (`apps/products/services/parser.py`) - –ø–∞—Ä—Å–∏–Ω–≥ XML —Ñ–∞–π–ª–æ–≤ CommerceML 3.1
- `ProductDataProcessor` (`apps/products/services/processor.py`) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ü–µ–Ω
- `CustomerDataParser` (`apps/users/services/parser.py`) - –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤
- `CustomerDataProcessor` (`apps/users/services/processor.py`) - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤

**Management –∫–æ–º–∞–Ω–¥—ã (‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ Epic 3):**
- `import_catalog_from_1c` - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–º–ø–æ—Ä—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
  - `--data-dir` - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ settings.ONEC_DATA_DIR)
  - `--file-type` - –≤—ã–±–æ—Ä–æ—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç (goods|offers|prices|rests|all)
  - `--dry-run` - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
  - `--chunk-size` - —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è bulk –æ–ø–µ—Ä–∞—Ü–∏–π
  - `--skip-validation` - –ø—Ä–æ–ø—É—Å–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
  - `--clear-existing` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
- `load_product_stocks` - –ª–µ–≥–∫–æ–≤–µ—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–æ–≤
- `import_customers_from_1c` - –∏–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ contragents.xml

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö 1–° (CommerceML 3.1):**
- –°–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: `goods_1_*.xml`, `offers_*.xml`, `prices_1_*.xml`, `rests_1_*.xml`
- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏: `units.xml`, `storages.xml`, `priceLists.xml`
- –°–≤–æ–π—Å—Ç–≤–∞: `propertiesGoods/`, `propertiesOffers/`
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: `groups.xml` (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏)
- –ö–ª–∏–µ–Ω—Ç—ã: `contragents.xml`

**ImportSession —Ç–∏–ø—ã:**
- `CATALOG` - –∏–º–ø–æ—Ä—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤
- `STOCKS` - –∏–º–ø–æ—Ä—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤
- `PRICES` - –∏–º–ø–æ—Ä—Ç —Ü–µ–Ω
- `CUSTOMERS` - –∏–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤

### Enhancement Details:

**–ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è:**
1. –£–¥–∞–ª—è–µ—Ç—Å—è admin action "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°" —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–µ—Å—Å–∏–π
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é "–ò–º–ø–æ—Ä—Ç –∏–∑ 1–°" –≤ —Ä–∞–∑–¥–µ–ª–µ –ò–ù–¢–ï–ì–†–ê–¶–ò–ò
3. –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–°–µ—Å—Å–∏–∏ –∏–º–ø–æ—Ä—Ç–∞" –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è –∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è read-only –∂—É—Ä–Ω–∞–ª–æ–º
4. –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "–ò–º–ø–æ—Ä—Ç –∏–∑ 1–°" –ø–æ–ª—É—á–∞–µ—Ç —Ñ–æ—Ä–º—É –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–ø—É—Å–∫–∞

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é Celery –∑–∞–¥–∞—á—É run_selective_import_task
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º —Å–æ–∑–¥–∞–Ω–∏—è ImportSession —Å celery_task_id
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç Redis lock –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤

**Success criteria:**
- –ò–º–ø–æ—Ä—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ –≤—ã–±–æ—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Å—Å–∏–π
- –ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—É—Å–∫–∞
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–∞

## Stories

### Story 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã "–ò–º–ø–æ—Ä—Ç –∏–∑ 1–°"

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö management –∫–æ–º–∞–Ω–¥ –∏–∑ Epic 3.

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Django admin view –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –º–æ–¥–µ–ª–∏ (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ImportSession)
- URL: `/admin/integrations/import_1c/`
- –§–æ—Ä–º–∞ —Å radio buttons –¥–ª—è —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç–∞:
  - **"–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥"** ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `import_catalog_from_1c --file-type=all --data-dir={ONEC_DATA_DIR}`
    - –í–∫–ª—é—á–∞–µ—Ç: goods, offers, prices, rests, priceLists, units, storages, properties, groups
  - **"–¢–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏"** ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `import_catalog_from_1c --file-type=rests --data-dir={ONEC_DATA_DIR}`
  - **"–¢–æ–ª—å–∫–æ —Ü–µ–Ω—ã"** ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `import_catalog_from_1c --file-type=prices --data-dir={ONEC_DATA_DIR}`
  - **"–ö–ª–∏–µ–Ω—Ç—ã"** ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `import_customers_from_1c --file={ONEC_DATA_DIR}/contragents/contragents.xml`
- –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ `_validate_dependencies`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Redis lock –º–µ—Ö–∞–Ω–∏–∑–º
- –°–æ–∑–¥–∞–≤–∞—Ç—å ImportSession —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º Celery –∑–∞–¥–∞—á–∏
- –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –º–µ–Ω—é –ò–ù–¢–ï–ì–†–ê–¶–ò–ò –ø–µ—Ä–µ–¥ "–°–µ—Å—Å–∏–∏ –∏–º–ø–æ—Ä—Ç–∞"

**Acceptance Criteria:**
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ URL `/admin/integrations/import_1c/`
- [ ] –§–æ—Ä–º–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç 4 —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
- [ ] –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–∏–ø–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è management –∫–æ–º–∞–Ω–¥–∞ —á–µ—Ä–µ–∑ Celery
- [ ] –°–æ–∑–¥–∞–µ—Ç—Å—è ImportSession —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º (CATALOG/STOCKS/PRICES/CUSTOMERS)
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—Å—Ç–∞—Ç–∫–∏/—Ü–µ–Ω—ã —Ç—Ä–µ–±—É—é—Ç –∫–∞—Ç–∞–ª–æ–≥)
- [ ] Redis lock –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å Task ID –∏ Session ID –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

### Story 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–µ—Å—Å–∏–π –∏–º–ø–æ—Ä—Ç–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–µ—Å—Å–∏–π –≤ read-only –∂—É—Ä–Ω–∞–ª —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- –£–¥–∞–ª–∏—Ç—å admin action "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°" –∏–∑ IntegrationImportSessionAdmin
- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å URL —Å `/admin/integrations/integrationimportsession/` –Ω–∞ `/admin/integrations/session/`
- –°–¥–µ–ª–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É read-only:
  - –£–±—Ä–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π —á–µ—Ä–µ–∑ admin
  - –£–±—Ä–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–µ—Å—Å–∏–π
  - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
  - –ú–µ—Ç–æ–¥ `celery_task_status` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ Celery –∑–∞–¥–∞—á–∏
  - JavaScript –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (`import_session_auto_refresh.js`)
  - –ö–æ–ª–æ–Ω–∫–∏: ID, –¢–∏–ø –∏–º–ø–æ—Ä—Ç–∞, –°—Ç–∞—Ç—É—Å, Celery Task, –ù–∞—á–∞–ª–æ, –û–∫–æ–Ω—á–∞–Ω–∏–µ, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  - –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É, —Ç–∏–ø—É –∏–º–ø–æ—Ä—Ç–∞, –¥–∞—Ç–µ

**Acceptance Criteria:**
- [ ] URL –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ `/admin/integrations/session/`
- [ ] Admin action "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç" —É–¥–∞–ª–µ–Ω
- [ ] –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ admin
- [ ] –ö–æ–ª–æ–Ω–∫–∞ "Celery Task" –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- [ ] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
- [ ] –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

### Story 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ flow –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**
- End-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç–∞:
  - –ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ (–≤—Å–µ —Ñ–∞–π–ª—ã)
  - –¢–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏ (—Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ rests_*.xml)
  - –¢–æ–ª—å–∫–æ —Ü–µ–Ω—ã (—Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ prices_*.xml)
  - –ö–ª–∏–µ–Ω—Ç—ã (contragents.xml)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis lock (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è ImportSession —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–µ—Å—Å–∏–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
  - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–º–ø–æ—Ä—Ç–∞
  - –û–ø–∏—Å–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –∏–º–ø–æ—Ä—Ç–∞ –∏ –∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  - Troubleshooting guide

**Acceptance Criteria:**
- [ ] –í—Å–µ 4 —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã end-to-end
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ—Å—Ç–∞—Ç–∫–∏/—Ü–µ–Ω—ã —Ç—Ä–µ–±—É—é—Ç –∫–∞—Ç–∞–ª–æ–≥)
- [ ] Redis lock –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
- [ ] Celery –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–µ—Å—Å–∏–π
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∞

## Dependencies on Epic 3

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–≤—Å–µ ‚úÖ DONE):**

- ‚úÖ **Story 3.1.1** (import-products-structure) - –±–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–º–ø–æ—Ä—Ç–∞
  - –ú–æ–¥–µ–ª–∏: ImportSession, –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ Product/Category/Brand —Å onec_id
  - XMLDataParser, ProductDataProcessor
  - –ö–æ–º–∞–Ω–¥–∞ import_catalog_from_1c (–±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)

- ‚úÖ **Story 3.1.2** (loading-scripts) - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥
  - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: --file-type, --chunk-size, --skip-validation, --clear-existing
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (goods_*.xml, prices_*.xml, rests_*.xml)
  - –ö–æ–º–∞–Ω–¥—ã backup_db, restore_db, rotate_backups

- ‚úÖ **Story 3.1.5** (import-session-and-stocks-command) - –∏–º–ø–æ—Ä—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤
  - –ö–æ–º–∞–Ω–¥–∞ load_product_stocks
  - –ú–µ—Ç–æ–¥ XMLDataParser.parse_rests_xml()
  - Batch processing –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤

- ‚úÖ **Story 3.2.1.0** (import-existing-customers) - –∏–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤
  - CustomerDataParser, CustomerDataProcessor
  - –ö–æ–º–∞–Ω–¥–∞ import_customers_from_1c
  - –ú–æ–¥–µ–ª—å CustomerSyncLog

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ Epic 3:**

```python
# –ü–∞—Ä—Å–µ—Ä—ã
from apps.products.services.parser import XMLDataParser
from apps.users.services.parser import CustomerDataParser

# –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã
from apps.products.services.processor import ProductDataProcessor
from apps.users.services.processor import CustomerDataProcessor

# –ú–æ–¥–µ–ª–∏
from apps.products.models import ImportSession
from apps.common.models import CustomerSyncLog

# Management –∫–æ–º–∞–Ω–¥—ã (–≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ call_command)
call_command('import_catalog_from_1c', data_dir=..., file_type=...)
call_command('load_product_stocks', file=...)
call_command('import_customers_from_1c', file=...)
```

## Compatibility Requirements

- [x] –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ API –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º–∏ (Celery –∑–∞–¥–∞—á–∏)
- [x] –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã –ë–î –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è
- [x] UI –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ª–µ–¥—É—é—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º Django Admin
- [x] Performance impact –º–∏–Ω–∏–º–∞–ª–µ–Ω (–ø–µ—Ä–µ–Ω–æ—Å –ª–æ–≥–∏–∫–∏)
- [x] –í—Å–µ management –∫–æ–º–∞–Ω–¥—ã –∏–∑ Epic 3 —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## Risk Mitigation

- **Primary Risk:** –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
- **Mitigation:** –ü–æ—ç—Ç–∞–ø–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞ –¥–æ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **Rollback Plan:** Git revert –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–µ—Å—Ç–∞—Ä—Ç backend –∏ celery –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

## Definition of Done

- [ ] –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "–ò–º–ø–æ—Ä—Ç –∏–∑ 1–°" —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–µ—Å—Å–∏–π –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ read-only —Ä–µ–∂–∏–º–µ
- [ ] –í–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–µ—Å—Å–∏–π
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

## Validation Checklist

### Scope Validation:
- [x] Epic –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω –≤ 3 –∏—Å—Ç–æ—Ä–∏–∏
- [x] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
- [x] Enhancement —Å–ª–µ–¥—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º Django Admin
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è–µ–º–∞

### Risk Assessment:
- [x] –†–∏—Å–∫ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∏–∑–∫–∏–π
- [x] –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏–º (Git revert)
- [x] –ü–æ–¥—Ö–æ–¥ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- [x] –ö–æ–º–∞–Ω–¥–∞ –∏–º–µ–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ –∑–Ω–∞–Ω–∏—è —Ç–æ—á–µ–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Completeness Check:
- [x] –¶–µ–ª—å —ç–ø–∏–∫–∞ —è—Å–Ω–∞ –∏ –¥–æ—Å—Ç–∏–∂–∏–º–∞
- [x] –ò—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [x] –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –∏–∑–º–µ—Ä–∏–º—ã
- [x] –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã

---

## Story Manager Handoff:

"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ brownfield —ç–ø–∏–∫–∞. –ö–ª—é—á–µ–≤—ã–µ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è:

- –≠—Ç–æ —É–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ Django 5.0 —Å Django Admin
- –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: Celery –∑–∞–¥–∞—á–∏, Redis locks, ImportSession –º–æ–¥–µ–ª–∏
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã: Django Admin custom pages, admin actions —Å intermediate pages
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã Celery –∑–∞–¥–∞—á, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
- –ö–∞–∂–¥–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

–≠–ø–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞ –¥–≤–µ –ª–æ–≥–∏—á–µ—Å–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã."

---

## Implementation Notes

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

**1. –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ "–ò–º–ø–æ—Ä—Ç –∏–∑ 1–°" (Story 1):**

```python
# backend/apps/integrations/admin.py

class ImportFrom1CAdmin(admin.ModelAdmin):
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑ 1–°"""
    
    def changelist_view(self, request):
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∏–º–ø–æ—Ä—Ç–∞
        if request.method == 'POST':
            import_type = request.POST.get('import_type')
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            if import_type in ['stocks', 'prices']:
                if not Product.objects.exists():
                    messages.error(request, "–°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥")
                    return redirect('.')
            
            # Redis lock
            redis_conn = get_redis_connection("default")
            lock = redis_conn.lock("import_catalog_lock", timeout=3600)
            if not lock.acquire(blocking=False):
                messages.warning(request, "–ò–º–ø–æ—Ä—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
                return redirect('.')
            
            try:
                # –°–æ–∑–¥–∞–Ω–∏–µ ImportSession
                session_type_map = {
                    'catalog': ImportSession.ImportType.CATALOG,
                    'stocks': ImportSession.ImportType.STOCKS,
                    'prices': ImportSession.ImportType.PRICES,
                    'customers': ImportSession.ImportType.CUSTOMERS,
                }
                
                session = ImportSession.objects.create(
                    import_type=session_type_map[import_type],
                    status=ImportSession.ImportStatus.STARTED,
                )
                
                # –ó–∞–ø—É—Å–∫ Celery –∑–∞–¥–∞—á–∏
                data_dir = settings.ONEC_DATA_DIR
                
                if import_type == 'catalog':
                    task = run_selective_import_task.delay(['catalog'], data_dir)
                elif import_type == 'stocks':
                    task = run_selective_import_task.delay(['stocks'], data_dir)
                elif import_type == 'prices':
                    task = run_selective_import_task.delay(['prices'], data_dir)
                elif import_type == 'customers':
                    task = run_selective_import_task.delay(['customers'], data_dir)
                
                session.celery_task_id = task.id
                session.save(update_fields=['celery_task_id'])
                
                messages.success(
                    request,
                    f"–ò–º–ø–æ—Ä—Ç –∑–∞–ø—É—â–µ–Ω (Task ID: {task.id}, Session ID: {session.pk})"
                )
            finally:
                lock.release()
        
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
        context = {
            'title': '–ò–º–ø–æ—Ä—Ç –∏–∑ 1–°',
            'import_types': [
                {'value': 'catalog', 'label': '–ü–æ–ª–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥', 
                 'description': '–¢–æ–≤–∞—Ä—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ü–µ–Ω—ã, –æ—Å—Ç–∞—Ç–∫–∏, —Å–≤–æ–π—Å—Ç–≤–∞'},
                {'value': 'stocks', 'label': '–¢–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏',
                 'description': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤'},
                {'value': 'prices', 'label': '–¢–æ–ª—å–∫–æ —Ü–µ–Ω—ã',
                 'description': '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω —Ç–æ–≤–∞—Ä–æ–≤'},
                {'value': 'customers', 'label': '–ö–ª–∏–µ–Ω—Ç—ã',
                 'description': '–ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –∏–∑ 1–°'},
            ],
        }
        return TemplateResponse(request, 'admin/integrations/import_1c.html', context)

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
admin.site.register(ImportFrom1C, ImportFrom1CAdmin)
```

**2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IntegrationImportSessionAdmin (Story 2):**

```python
class IntegrationImportSessionAdmin(admin.ModelAdmin):
    model = IntegrationImportSession
    
    # –£–¥–∞–ª–∏—Ç—å actions
    actions = []  # –ë—ã–ª–æ: ["trigger_selective_import"]
    
    # Read-only
    def has_add_permission(self, request):
        return False
    
    def has_change_permission(self, request, obj=None):
        return False
    
    def has_delete_permission(self, request, obj=None):
        return False
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
    list_display = (
        "id",
        "import_type",
        "colored_status",
        "celery_task_status",  # ‚Üê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        "started_at",
        "finished_at",
        "duration",
    )
    
    @admin.display(description="Celery Task")
    def celery_task_status(self, obj):
        # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ 9.5
        if not obj.celery_task_id:
            return format_html('<span style="color: gray;">-</span>')
        
        from celery.result import AsyncResult
        task_result = AsyncResult(obj.celery_task_id)
        state = task_result.state
        
        status_map = {
            "PENDING": ("‚è≥", "gray", "–í –æ—á–µ—Ä–µ–¥–∏"),
            "STARTED": ("‚ñ∂Ô∏è", "blue", "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"),
            "SUCCESS": ("‚úÖ", "green", "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"),
            "FAILURE": ("‚ùå", "red", "–û—à–∏–±–∫–∞"),
            "RETRY": ("üîÑ", "orange", "–ü–æ–≤—Ç–æ—Ä"),
        }
        
        icon, color, label = status_map.get(state, ("‚ùì", "black", state))
        return format_html(
            '<span style="color: {}; font-weight: bold;">{} {}</span>',
            color, icon, label
        )
    
    class Media:
        js = ("admin/js/import_session_auto_refresh.js",)  # ‚Üê –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
```

**3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Celery –∑–∞–¥–∞—á–∏ (apps/integrations/tasks.py):**

–ó–∞–¥–∞—á–∞ `run_selective_import_task` —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç:
- `import_catalog_from_1c --file-type=all` –¥–ª—è 'catalog'
- `import_catalog_from_1c --file-type=rests` –¥–ª—è 'stocks'
- `import_catalog_from_1c --file-type=prices` –¥–ª—è 'prices'
- `import_customers_from_1c` –¥–ª—è 'customers'

**4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**

```python
def _validate_dependencies(import_types):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ –∏–º–ø–æ—Ä—Ç–∞"""
    if 'stocks' in import_types or 'prices' in import_types:
        if not Product.objects.exists():
            return False, "–°–Ω–∞—á–∞–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤"
    return True, ""
```

**5. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:**

–ö–æ–º–∞–Ω–¥–∞ `import_catalog_from_1c` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
- `goods_1_*.xml`, `goods_2_*.xml`, ... (–º–µ—Ç–æ–¥ `_collect_xml_files`)
- `prices_1_*.xml`, `prices_2_*.xml`, ...
- `rests_1_*.xml`, `rests_2_*.xml`, ...

**6. JavaScript –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):**

```javascript
// backend/static/admin/js/import_session_auto_refresh.js
// –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏ 9.5
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
```

---

**–°—Ç–∞—Ç—É—Å:** –≠–ø–∏–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—á–µ—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏ 9.5)
**–û—Ü–µ–Ω–∫–∞:** 3-5 –¥–Ω–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
