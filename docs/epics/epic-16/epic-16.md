# Epic 16: Личный кабинет - Brownfield Enhancement

**Epic ID:** 16
**Приоритет:** P0 (критичный)
**Длительность:** 4 недели
**Тип:** Brownfield Enhancement
**Статус:** Planned
**Дата создания:** 2025-12-15

---

## Epic Goal

Реализовать полнофункциональный личный кабинет для зарегистрированных пользователей платформы FREESPORT с поддержкой управления профилем, просмотром истории заказов, управлением адресами доставки и избранными товарами. Обеспечить ролевую персонализацию интерфейса для B2B и B2C клиентов.

---

## Epic Description

### Existing System Context

**Текущая функциональность:**
- Реализована система аутентификации с JWT токенами (Epic 28)
- Работает система оформления заказов (Epic 15)
- Поддерживается ролевая модель пользователей (7 ролей: retail, wholesale_level1-3, trainer, federation_rep, admin)
- Действует корзина покупок (Epic 26)
- Функционирует каталог товаров с фильтрацией

**Технологический стек:**
- **Backend:** Django 5.2.7 + Django REST Framework, PostgreSQL 15+, Redis
- **Frontend:** Next.js 15.5.7, React 19.1.0, TypeScript 5.0+, Zustand 4.5.7
- **Аутентификация:** JWT с refresh токенами
- **API документация:** OpenAPI 3.1.0 через drf-spectacular

**Интеграционные точки:**
- `/api/v1/auth/*` - аутентификация пользователей
- `/api/v1/users/profile/` - данные профиля
- `/api/v1/orders/*` - история заказов
- `/api/v1/addresses/*` - адреса доставки
- `/api/v1/favorites/*` - избранные товары
- `authStore` (Zustand) - глобальное состояние аутентификации

### Enhancement Details

**Что добавляется:**

Личный кабинет представляет собой защищённую область приложения, доступную только авторизованным пользователям. Включает:

1. **Единый Layout личного кабинета** с навигацией между разделами
2. **Профиль пользователя** - редактирование личных данных, контактной информации
3. **История заказов** - просмотр всех заказов с детализацией, статусами, функцией повторного заказа
4. **Управление адресами** - CRUD операции с адресами доставки
5. **Избранные товары** - список отложенных товаров с возможностью добавления в корзину
6. **Ролевая персонализация** - различные возможности для B2B (оптовые уровни) и B2C клиентов

**Как интегрируется:**
- Маршруты под защищённой группой `/profile/*`
- Next.js middleware для проверки аутентификации
- SSR для первичной загрузки данных профиля
- CSR для динамических обновлений (заказы, адреса)
- Axios interceptors для автоматической обработки JWT токенов
- Интеграция с существующими stores (authStore, cartStore)

**Критерии успеха:**
- Пользователь может редактировать свой профиль и видеть изменения в реальном времени
- История заказов отображается с пагинацией (20 заказов на страницу)
- Функция "Повторить заказ" добавляет товары из прошлого заказа в корзину
- Управление адресами работает без перезагрузки страницы (optimistic UI)
- B2B клиенты видят дополнительные поля (компания, ИНН) и функции экспорта
- Мобильная версия удобна для использования
- Unit-тесты покрывают 80%+ кода
- E2E тесты проверяют критические сценарии

---

## Stories

### Story 16.1: Layout личного кабинета и страница профиля

**Описание:** Создать базовый layout личного кабинета с навигацией и реализовать страницу редактирования профиля.

**Задачи:**
- Создать `/profile` layout с боковой навигацией (desktop) и табами (mobile)
- Реализовать страницу `/profile` с формой редактирования данных пользователя
- Интеграция с `/api/v1/users/profile/` (GET, PUT)
- Валидация форм через React Hook Form + Zod
- Обработка различных ролей пользователей (отображение полей компании для B2B)
- Middleware для защиты маршрутов `/profile/*`

**Acceptance Criteria:**
- Layout отображается корректно на desktop, tablet, mobile
- Форма профиля загружает текущие данные пользователя
- Успешное сохранение отображает toast уведомление
- B2B пользователи видят поля компании (company_name, tax_id, verification_status)
- Неавторизованные пользователи перенаправляются на `/login`
- Покрытие unit-тестами 80%+

---

### Story 16.2: История заказов с функцией повторного заказа

**Описание:** Реализовать страницу истории заказов с детальной информацией, пагинацией и возможностью повторить заказ.

**Задачи:**
- Создать страницу `/profile/orders` со списком заказов
- Реализовать детальный просмотр заказа `/profile/orders/[id]`
- Интеграция с `/api/v1/orders/` (GET) и `/api/v1/orders/{id}/` (GET)
- Пагинация списка заказов (20 на страницу)
- Фильтрация по статусу заказа (все, новый, в обработке, отправлен, доставлен, отменён)
- Функция "Повторить заказ" - добавление товаров из заказа в корзину
- Для B2B клиентов - кнопка "Экспорт в PDF/Excel" (упрощённая версия)

**Acceptance Criteria:**
- Список заказов отображается с пагинацией
- Клик по заказу открывает детальную информацию
- Фильтры работают без перезагрузки страницы
- Кнопка "Повторить заказ" добавляет все товары в корзину и показывает уведомление
- Для заказов с недоступными товарами показывается предупреждение
- Экспорт заказа генерирует PDF документ (только для B2B)
- E2E тест проверяет флоу повторного заказа

---

### Story 16.3: Управление адресами доставки и избранными товарами

**Описание:** Реализовать управление адресами доставки и список избранных товаров.

**Задачи:**
- Создать страницу `/profile/addresses` с CRUD операциями для адресов
- Создать страницу `/profile/favorites` со списком избранных товаров
- Интеграция с `/api/v1/addresses/*` (GET, POST, PUT, DELETE)
- Интеграция с `/api/v1/favorites/*` (GET, POST, DELETE)
- Модальные окна для добавления/редактирования адресов
- Optimistic UI для операций с адресами
- Добавление товаров из избранного в корзину
- Автодополнение адресов (опционально - через DaData API)

**Acceptance Criteria:**
- Пользователь может добавить новый адрес через модальное окно
- Редактирование адреса обновляет данные без перезагрузки
- Удаление адреса показывает подтверждение и работает optimistic UI
- Список избранного отображается карточками товаров
- Кнопка "В корзину" добавляет товар из избранного
- Удаление из избранного работает мгновенно
- Если товара нет в наличии, показывается соответствующий бейдж
- Unit-тесты для всех CRUD операций

---

## Compatibility Requirements

- [x] **Существующие API остаются неизменными** - используются текущие endpoints
- [x] **Middleware аутентификации** - работает с существующим authStore
- [x] **UI следует существующим паттернам** - используется UI Kit из design-system.json
- [x] **Интеграция с корзиной** - функция "Повторить заказ" использует существующий cartStore
- [x] **Адаптивность** - следует mobile-first подходу как в других разделах
- [x] **TypeScript типы** - генерируются из OpenAPI спецификации
- [x] **Производительность** - SSR для первичной загрузки, CSR для обновлений

---

## Risk Mitigation

**Primary Risk:** Конфликты с существующей системой аутентификации при навигации между защищёнными и публичными страницами.

**Mitigation:**
- Использовать централизованный middleware для проверки токенов
- Единый подход к обработке 401 ошибок через axios interceptors
- Автоматическое обновление токенов через refresh endpoint
- Тестирование переходов между защищёнными/публичными областями

**Secondary Risk:** Производительность при загрузке большого количества заказов для активных B2B клиентов.

**Mitigation:**
- Серверная пагинация с лимитом 20 заказов на страницу
- Бесконечная прокрутка (infinite scroll) как опция
- Кэширование списка заказов в Zustand store
- Индексы БД на user_id и created_at полях

**Rollback Plan:**
- Новые маршруты `/profile/*` легко деактивировать через роутинг
- Откат миграций БД не требуется (используются существующие модели)
- Feature flag для постепенного раскатывания личного кабинета

---

## Definition of Done

- [x] Все 3 stories завершены с выполненными acceptance criteria
- [x] Существующая функциональность проверена через regression тесты
- [x] Интеграционные точки работают корректно:
  - Авторизация через authStore
  - Добавление в корзину через cartStore
  - API endpoints отвечают корректно
- [x] Unit-тесты: покрытие 80%+
- [x] E2E тесты покрывают:
  - Редактирование профиля
  - Повторный заказ
  - Управление адресами
  - Добавление из избранного в корзину
- [x] Документация обновлена:
  - README с описанием новых маршрутов
  - Компоненты документированы через JSDoc
  - API интеграции описаны
- [x] Соответствие design-system.json проверено
- [x] Адаптивная вёрстка протестирована (mobile/tablet/desktop)
- [x] Accessibility проверен (WCAG 2.1 AA)
- [x] PageSpeed Insights > 70
- [x] Code review пройден
- [x] CI/CD проверки зелёные (ESLint, TypeScript, тесты)
- [x] Нет критических багов
- [x] Smoke-тесты пройдены на staging окружении

---

## Validation Checklist

### Scope Validation
- [x] Epic завершается в 3 stories
- [x] Архитектурная документация не требуется (используется существующая)
- [x] Enhancement следует существующим паттернам (Next.js App Router, Zustand stores)
- [x] Интеграционная сложность управляемая (используются текущие API)

### Risk Assessment
- [x] Риск для существующей системы низкий (новые маршруты, существующие API)
- [x] Rollback план осуществим (деактивация маршрутов)
- [x] Тестирование покрывает существующую функциональность (regression)
- [x] Команда имеет достаточные знания интеграционных точек

### Completeness Check
- [x] Epic goal ясен и достижим
- [x] Stories правильно декомпозированы
- [x] Success criteria измеримы
- [x] Dependencies идентифицированы (Epic 15 - авторизация, Epic 17 - заказы)

---

## Handoff to Story Manager

**Story Manager Handoff:**

"Пожалуйста, разработайте детальные user stories для этого brownfield epic. Ключевые соображения:

- Это enhancement к существующей системе на **Next.js 15.4.6 + React 19.1.0 + TypeScript 5.0+**
- **Интеграционные точки:**
  - `authStore` (Zustand) - глобальное состояние авторизации
  - `cartStore` (Zustand) - корзина покупок
  - Django REST API endpoints: `/api/v1/users/profile/`, `/api/v1/orders/*`, `/api/v1/addresses/*`, `/api/v1/favorites/*`
  - Next.js middleware для защиты маршрутов
- **Существующие паттерны для следования:**
  - UI Kit компоненты из `frontend/docs/design-system.json`
  - React Hook Form + Zod для валидации форм
  - Axios interceptors для обработки JWT токенов
  - SSR для первичной загрузки, CSR для динамических обновлений
  - Mobile-first responsive дизайн
  - Optimistic UI для мгновенного feedback
- **Критические требования совместимости:**
  - TypeScript без `as any`
  - Следование ESLint/Prettier правилам
  - Unit-тесты с покрытием 80%+
  - E2E тесты для критических флоу (Playwright)
  - Accessibility WCAG 2.1 AA
- **Каждая story должна включать проверку:** что существующая функциональность (авторизация, корзина, оформление заказов) остаётся нетронутой

Epic должен поддерживать целостность системы при доставке функционала личного кабинета с ролевой персонализацией для B2B/B2C клиентов."

---

## Related Documentation

- **Frontend Plan:** `docs/frontend/frontend-development-plan.md` (раздел 3.3, строки 57-63)
- **UX Spec:** `docs/frontend/front-end-spec.md` (раздел "Личный кабинет B2B", строки 169-178)
- **Design System:** `docs/frontend/design-system.json` (компоненты: Tabs,Card, Button, Badge, Lists)
- **Testing Standards:** `docs/frontend/testing-standards.md` (весь документ)
- **API Spec:** `docs/api-spec.yaml` (endpoints: /profile, /orders, /addresses, /favorites)
- **PRD Documents:** `docs/prd/*.md`
- **Source Epic Plan:** `docs/epics/frontend-epics-10-19-plan.md` (строки 305-321, матрица документов строка 431)

---

**Создано:** 2025-12-15
**Автор:** Sarah (PO Agent)
**Версия:** 1.0
