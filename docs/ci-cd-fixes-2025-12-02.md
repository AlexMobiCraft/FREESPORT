# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è CI/CD –¥–ª—è GitHub Actions

## –î–∞—Ç–∞: 2025-12-02

## –ü—Ä–æ–±–ª–µ–º—ã

1. **–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î**: `django.db.utils.InterfaceError: connection already closed` –∏ `FATAL: role 'root' does not exist`
2. **–û—à–∏–±–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏**: `duplicate key value violates unique constraint` –¥–ª—è SKU, onec_id, –∏–º–µ–Ω–∏ —Ü–≤–µ—Ç–∞ –∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π

## –†–µ—à–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î

**–§–∞–π–ª**: `backend/freesport/settings/test.py`

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∂–µ –±—ã–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `postgres` –≤–º–µ—Å—Ç–æ `root`:

```python
DATABASES = {
    "default": {
        "USER": _get_env_value("DB_USER", ("POSTGRES_USER", "PGUSER"), "postgres"),
        # ...
    }
}
```

**–§–∞–π–ª**: `.github/workflows/backend-ci.yml`

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:

```yaml
env:
  DB_USER: postgres
  DB_PASSWORD: postgres
  DB_NAME: freesport_test
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î –ø–µ—Ä–µ–¥ —Ç–µ—Å—Ç–∞–º–∏

**–§–∞–π–ª**: `backend/tests/conftest.py`

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏

```python
@pytest.fixture(autouse=True)  # –ë—ã–ª–æ: autouse=False
def clear_db_before_test(transactional_db):
    """
    –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ deadlock'–æ–≤
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
    """
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –≤ —Å–ø–∏—Å–æ–∫ –æ—á–∏—Å—Ç–∫–∏

```python
model_order = [
    "cart.CartItem",
    "orders.OrderItem",
    "orders.Order",
    "cart.Cart",
    "products.ProductImage",
    "products.ProductVariants",  # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è duplicate key
    "products.ColorMappings",    # –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è duplicate key
    "products.Product",
    "products.Category",
    "products.Brand",
    "users.Address",
    "users.Company",
    "common.AuditLog",
    "common.SyncLog",
]
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã TRUNCATE (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è)

```python
@pytest.fixture
def truncate_db(transactional_db):
    """
    –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å TRUNCATE –∏ —Å–±—Ä–æ—Å–æ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Ñ–∏–∫—Å—Ç—É—Ä—É —è–≤–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
    """
    # ... –∫–æ–¥ –æ—á–∏—Å—Ç–∫–∏ —Å TRUNCATE
```

### 3. **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: pytest.ini

**–§–∞–π–ª**: `pytest.ini`

**–ü—Ä–æ–±–ª–µ–º–∞**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ `backend.settings`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ë–î.

**–†–µ—à–µ–Ω–∏–µ**:

```ini
[pytest]
DJANGO_SETTINGS_MODULE = freesport.settings.test  # –ë—ã–ª–æ: backend.settings
```

–≠—Ç–æ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ** –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ! –ë–µ–∑ –Ω–µ–≥–æ pytest –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ `backend/backend/settings.py`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥ –∏–º–µ—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ë–î.

### 4. –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –≤ CI

**–§–∞–π–ª**: `.github/workflows/backend-ci.yml`

```yaml
- name: Run database migrations
  run: |
    # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –ë–î –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
    echo "üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    PGPASSWORD=postgres psql -h localhost -U postgres -c "DROP DATABASE IF EXISTS freesport_test;" || true
    PGPASSWORD=postgres psql -h localhost -U postgres -c "CREATE DATABASE freesport_test;" || true
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
    python -c "import django; django.setup(); from django.db import connections; connections.close_all()" || true
    python manage.py migrate --noinput
```

### 5. –£–ª—É—á—à–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤

**–§–∞–π–ª**: `.github/workflows/backend-ci.yml`

```yaml
- name: Run tests with coverage
  run: |
    echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º..."
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º --reuse-db –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ë–î –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏
    # –î–æ–±–∞–≤–ª—è–µ–º -v –¥–ª—è –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
    pytest --reuse-db -v --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing --cov-fail-under=70
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `postgres`
2. ‚úÖ **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω pytest.ini** - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ `freesport.settings.test`
3. ‚úÖ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏** - –ë–î –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º
4. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–∫—Å—Ç—É—Ä–∞ TRUNCATE** - –¥–ª—è —Ç–µ—Å—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –ë–î
5. ‚úÖ **–£–ª—É—á—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å CI** - –ë–î –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
6. ‚úÖ **–£—Å–∫–æ—Ä–µ–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–ª–∞–≥ `--reuse-db`

## –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
cd backend
source venv/bin/activate  # –∏–ª–∏ venv\Scripts\activate –Ω–∞ Windows

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DJANGO_SETTINGS_MODULE=freesport.settings.test
export DB_USER=postgres
export DB_PASSWORD=postgres
export DB_NAME=freesport_test

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pytest --reuse-db -v
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ CI/CD –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º
2. **–ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º –∏ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. **Factory Boy**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–∞–±—Ä–∏–∫–∞—Ö (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `get_unique_suffix()`)
4. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `transactional_db` —Ñ–∏–∫—Å—Ç—É—Ä—É –¥–ª—è —Ç–µ—Å—Ç–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
