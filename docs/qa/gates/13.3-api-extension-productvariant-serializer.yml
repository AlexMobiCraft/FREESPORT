# Quality Gate Decision for Story 13.3
# Generated by Quinn (Test Architect) - Re-Review after ProductFactory fix

schema: 1
story: "13.3"
story_title: "API расширение с ProductVariantSerializer"
gate: FAIL
status_reason: "После исправления ProductFactory обнаружены 3 новые критические проблемы: (1) ProductListSerializer содержит поле 'sku' для Product модели - это поле ProductVariant, (2) ProductViewSet не имеет lookup_field='slug', (3) Serializer небезопасно обращается к request.user без проверки атрибута"
reviewer: "Quinn (Test Architect)"
updated: "2025-12-02T14:30:00Z"

# Waiver не активен
waiver: { active: false }

# Критические проблемы блокируют gate
top_issues:
  - id: "CODE-002"
    severity: critical
    finding: "ProductListSerializer включает поле 'sku' (строка 225), но Product модель НЕ имеет этого поля - sku принадлежит ProductVariant"
    suggested_action: "Удалить 'sku' из ProductListSerializer.Meta.fields (строка 225) и из serializer полей (строки 232-236 должны остаться для ProductVariant prices)"
    suggested_owner: dev
    impact: "Блокирует OpenAPI validation: 'Field name sku is not valid for model Product'"
    refs:
      - "backend/apps/products/serializers.py:225"

  - id: "CODE-003"
    severity: critical
    finding: "ProductViewSet не имеет lookup_field='slug' - используется pk по умолчанию вместо slug"
    suggested_action: "Добавить lookup_field = 'slug' в ProductViewSet класс после permission_classes"
    suggested_owner: dev
    impact: "Блокирует все 14 API тестов: NoReverseMatch для 'product-detail' с slug"
    refs:
      - "backend/apps/products/views.py:~105"

  - id: "CODE-004"
    severity: high
    finding: "ProductVariantSerializer.get_current_price небезопасно обращается к request.user - WSGIRequest может не иметь атрибута user"
    suggested_action: "Изменить строку 63: user = getattr(request, 'user', None) if request else None"
    suggested_owner: dev
    impact: "Блокирует 10/18 unit тестов: AttributeError 'WSGIRequest' object has no attribute 'user'"
    refs:
      - "backend/apps/products/serializers.py:63"

  - id: "TEST-003"
    severity: high
    finding: "14/14 API тестов падают из-за отсутствия lookup_field='slug' в ProductViewSet"
    suggested_action: "После добавления lookup_field='slug' - перезапустить: docker compose exec backend pytest apps/products/tests/test_api_products.py -v"
    suggested_owner: dev
    refs:
      - "backend/apps/products/tests/test_api_products.py"

  - id: "TASK-001"
    severity: medium
    finding: "TypeScript типы не регенерированы (AC6 частично не выполнено)"
    suggested_action: "После прохождения OpenAPI валидации - запустить: cd frontend && npm run generate:types"
    suggested_owner: dev
    refs:
      - "frontend/src/types/api.generated.ts"

# Risk summary
risk_summary:
  totals:
    critical: 2  # sku в Product serializer + отсутствие lookup_field
    high: 3      # request.user безопасность + Tests + TypeScript
    medium: 0
    low: 0
  highest: critical
  recommendations:
    must_fix:
      - "Удалить 'sku' из ProductListSerializer.Meta.fields - это поле только ProductVariant"
      - "Добавить lookup_field='slug' в ProductViewSet"
      - "Исправить get_current_price для безопасного доступа к request.user"
      - "Перезапустить все тесты после исправлений"
      - "Валидировать OpenAPI спецификацию"
      - "Регенерировать TypeScript типы"
    monitor:
      - "Проверить что performance тесты проходят после исправлений"
      - "Убедиться что Integration Verification (IV1, IV2, IV3) проходят"

# Evidence - проведенный анализ
evidence:
  files_reviewed: 8
  tests_attempted: 32  # 18 unit + 14 API
  tests_passed: 8      # 8/18 unit прошли (те что без serializer.data)
  tests_failed: 24     # 10 unit + 14 API
  tests_errors: 0
  validation_errors: 1  # OpenAPI validation failed
  trace:
    ac_covered: [1, 2, 4, 5]  # AC 1-2, 4-5 реализованы в коде
    ac_gaps: [3, 6, 7, 8]     # AC 3,6-8 не могут быть проверены из-за ошибок

# NFR Validation
nfr_validation:
  security:
    status: CONCERNS
    notes: "Роле-ориентированное ценообразование реализовано, но небезопасный доступ к request.user может вызвать исключения"
  performance:
    status: CONCERNS
    notes: "NFR1 тест создан, но не может быть выполнен. prefetch_related реализован корректно в коде."
  reliability:
    status: FAIL
    notes: "Система нестабильна: 24/32 теста падают, OpenAPI validation не проходит"
  maintainability:
    status: PASS
    notes: "Код хорошо структурирован, типизирован, документирован. Проблемы архитектурные - легко исправляются."

# Quality score (0-100)
# Formula: 100 - (20 × FAILs) - (10 × CONCERNS)
# 100 - (20 × 1) - (10 × 2) = 60
quality_score: 60

# Gate expires (2 weeks freshness window)
expires: "2025-12-16T14:30:00Z"

# Detailed Analysis
detailed_analysis:
  code_quality:
    serializer_implementation: "GOOD - ProductVariantSerializer корректен, но ProductListSerializer имеет ошибку с полем 'sku'"
    viewset_optimization: "GOOD - prefetch_related реализован, но отсутствует lookup_field='slug'"
    api_spec_quality: "EXCELLENT - OpenAPI схема детальная, но не может быть валидирована из-за ошибки в serializer"
    factory_quality: "EXCELLENT - ProductFactory исправлен ✅"

  test_coverage:
    unit_tests: "18 тестов написаны comprehensive: 8 passed, 10 failed (request.user проблема)"
    api_tests: "14 тестов включают роли, edge cases, performance - все failed (lookup_field проблема)"
    integration_tests: "IV1-IV3 тесты созданы, но не могут выполниться"

  architecture:
    serializer_design: "CONCERNS - ProductVariantSerializer SOLID, но ProductListSerializer содержит поле из другой модели"
    model_separation: "CORRECT - ProductVariant отделен от Product"
    viewset_design: "CONCERNS - отсутствие lookup_field='slug' нарушает endpoint contract"

# Recommendations по приоритетам
recommendations:
  immediate:  # Must fix before re-review (критические блокеры)
    - action: "Удалить 'sku' из ProductListSerializer.Meta.fields"
      priority: "CRITICAL"
      estimated_effort: "1 минута"
      location: "строка 225"
      reason: "Product модель НЕ имеет поля sku - это поле ProductVariant"
      refs:
        - "backend/apps/products/serializers.py:225"

    - action: "Добавить lookup_field='slug' в ProductViewSet"
      priority: "CRITICAL"
      estimated_effort: "1 минута"
      location: "после строки ~105 (permission_classes)"
      code: "lookup_field = 'slug'"
      reason: "API endpoints используют slug (/products/{slug}/), а не pk"
      refs:
        - "backend/apps/products/views.py:~105"

    - action: "Исправить get_current_price для безопасного доступа к request.user"
      priority: "HIGH"
      estimated_effort: "1 минута"
      location: "строка 63"
      current_code: "user: User | None = request.user if request else None"
      fixed_code: "user: User | None = getattr(request, 'user', None) if request else None"
      reason: "WSGIRequest в тестах может не иметь атрибута user до middleware"
      refs:
        - "backend/apps/products/serializers.py:63"

    - action: "Валидировать OpenAPI спецификацию"
      priority: "HIGH"
      estimated_effort: "1 минута"
      command: "docker compose exec backend python manage.py spectacular --validate"
      run_after: "Удаление 'sku' из ProductListSerializer"

    - action: "Запустить unit тесты"
      priority: "HIGH"
      estimated_effort: "2 минуты"
      command: "docker compose exec backend pytest apps/products/tests/test_serializers.py -v"
      run_after: "Исправление get_current_price"

    - action: "Запустить API тесты"
      priority: "HIGH"
      estimated_effort: "3 минуты"
      command: "docker compose exec backend pytest apps/products/tests/test_api_products.py -v"
      run_after: "Добавление lookup_field='slug'"

    - action: "Регенерировать TypeScript типы"
      priority: "MEDIUM"
      estimated_effort: "2 минуты"
      command: "cd frontend && npm run generate:types"
      run_after: "Прохождение OpenAPI validation"

  future:  # После успешного исправления критических проблем
    - action: "Рассмотреть кэширование variants для дополнительной оптимизации"
      refs:
        - "backend/apps/products/views.py"

    - action: "Добавить мониторинг response time в production"
      refs: []

# Comparison with previous gate (2025-12-02 12:00)
progress_since_last_gate:
  resolved_issues:
    - "CODE-001: ProductFactory исправлен ✅ (удалены некорректные поля ProductVariant)"

  new_issues:
    - "CODE-002: ProductListSerializer содержит 'sku' (CRITICAL NEW)"
    - "CODE-003: ProductViewSet отсутствует lookup_field='slug' (CRITICAL NEW)"
    - "CODE-004: Небезопасный доступ к request.user (HIGH NEW)"

  overall_progress: "75% - ProductFactory исправлен, но обнаружены архитектурные проблемы в serializer и viewset"

# История изменений gate
history:
  - at: "2025-12-01T00:00:00Z"
    gate: FAIL
    note: "Первичный review - Story в Draft, код не реализован"

  - at: "2025-12-02T12:00:00Z"
    gate: FAIL
    note: "Финальный review - Serializer реализован отлично, но ProductFactory содержит критическую ошибку"

  - at: "2025-12-02T14:30:00Z"
    gate: FAIL
    note: "Re-review после fix ProductFactory - обнаружены 3 новые проблемы: (1) sku в Product serializer, (2) отсутствие lookup_field, (3) небезопасный request.user"

# Test Results Detail
test_results:
  unit_tests:
    total: 18
    passed: 8
    failed: 10
    errors: 0
    failure_reason: "AttributeError: WSGIRequest.user - небезопасный доступ в get_current_price"
    passed_tests:
      - test_get_current_price_for_retail_user
      - test_get_current_price_for_wholesale_user
      - test_get_current_price_for_anonymous_user
      - test_get_current_price_without_request_context
      - test_all_fields_are_read_only
      - test_serializer_with_trainer_user
      - test_serializer_with_federation_user
      - test_current_price_decimal_to_string_conversion

  api_tests:
    total: 14
    passed: 0
    failed: 14
    errors: 0
    failure_reason: "NoReverseMatch: Reverse for 'product-detail' with slug - отсутствует lookup_field='slug'"

  openapi_validation:
    status: FAILED
    error: "Field name 'sku' is not valid for model Product"
    location: "ProductListSerializer.Meta.fields"

# Estimated Time to Fix ALL Issues
estimated_fix_time:
  critical_fixes: "3 минуты"  # 1 мин каждый × 3 fixes
  testing: "6 минут"           # 1+2+3 минут validation+unit+api
  typescript_regen: "2 минуты"
  total: "~11 минут"

# Next Steps для Dev
next_steps:
  step_1:
    action: "Удалить 'sku' из ProductListSerializer.Meta.fields (строка 225)"
    file: "backend/apps/products/serializers.py"

  step_2:
    action: "Добавить lookup_field='slug' в ProductViewSet после permission_classes"
    file: "backend/apps/products/views.py"

  step_3:
    action: "Изменить строку 63 в get_current_price: user = getattr(request, 'user', None) if request else None"
    file: "backend/apps/products/serializers.py"

  step_4:
    action: "Валидировать OpenAPI"
    command: "docker compose exec backend python manage.py spectacular --validate"

  step_5:
    action: "Запустить все тесты"
    commands:
      - "docker compose exec backend pytest apps/products/tests/test_serializers.py -v"
      - "docker compose exec backend pytest apps/products/tests/test_api_products.py -v"

  step_6:
    action: "Регенерировать TypeScript типы"
    command: "cd frontend && npm run generate:types"
