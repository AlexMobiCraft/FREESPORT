# Развертывание проекта на сервере

Этот документ описывает простой и надежный способ обновления проекта на удаленном сервере.

Мы используем единый `deploy.sh` скрипт, который запускается **непосредственно на сервере**. Это исключает все проблемы, связанные с Docker для Windows и удаленными контекстами.

## Порядок действий

**1. Подключитесь к серверу по SSH**

```bash
ssh root@5.35.124.149
```

**2. Перейдите в директорию проекта**

```bash
cd /home/freesport/freesport
```

**3. Запустите скрипт развертывания**

Для развертывания ветки `develop` (ветка по умолчанию):
```bash
./scripts/deploy/deploy.sh
```

Для развертывания конкретной ветки (например, `feature/new-logic`):
```bash
./scripts/deploy/deploy.sh feature/new-logic
```

Или так:
```bash
BRANCH=feature/new-logic ./scripts/deploy/deploy.sh
```

## Что делает скрипт `deploy.sh`

Скрипт выполняет все необходимые шаги в правильном порядке:
1.  **Обновляет код** из указанной ветки в Git.
2.  **Собирает новые Docker образы** (`backend` и `frontend`), используя `docker-compose.build.yml`.
3.  **Останавливает и удаляет старые контейнеры.**
4.  **Запускает новые контейнеры** из свежесобранных образов, используя `docker-compose.prod.yml`.
5.  **Выполняет миграции** базы данных Django.
6.  **Собирает статические файлы** Django.
7.  **Удаляет старые, неиспользуемые Docker образы**, чтобы освободить место.

## Первоначальная настройка сервера

Если вы настраиваете сервер с нуля, убедитесь, что:
-   Установлен `git`, `docker` и `docker-compose`.
-   Репозиторий проекта склонирован в `/home/freesport/freesport`.
-   Создан файл `.env.prod` с необходимыми переменными окружения.

## Устранение неполадок на сервере

-   **Ошибка `permission denied` для `./scripts/deploy/deploy.sh`:**
    -   Выполните `chmod +x ./scripts/deploy/deploy.sh`.
-   **Ошибка `permission denied` для Docker:**
    -   Убедитесь, что ваш пользователь добавлен в группу `docker`: `sudo usermod -aG docker $USER`. После этого может потребоваться перелогиниться.
-   **Ошибка сборки образов:**
    -   Проверьте логи сборки на наличие ошибок в `Dockerfile` или проблем с зависимостями.

Этот подход значительно упрощает процесс развертывания и делает его более предсказуемым и надежным.
