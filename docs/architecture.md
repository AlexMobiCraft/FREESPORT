# FREESPORT Platform - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#1-–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [–ú–æ–¥–µ–ª–∏ –î–∞–Ω–Ω—ã—Ö](#2-–º–æ–¥–µ–ª–∏-–¥–∞–Ω–Ω—ã—Ö)
3. [–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è API](#3-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è-api)
4. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤](#4-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
5. [–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –°—Ç–µ–∫](#5-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
6. [–í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#6-–≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
7. [–í–Ω–µ—à–Ω–∏–µ API](#7-–≤–Ω–µ—à–Ω–∏–µ-api)
8. [–û—Å–Ω–æ–≤–Ω—ã–µ –†–∞–±–æ—á–∏–µ –ü—Ä–æ—Ü–µ—Å—Å—ã](#8-–æ—Å–Ω–æ–≤–Ω—ã–µ-—Ä–∞–±–æ—á–∏–µ-–ø—Ä–æ—Ü–µ—Å—Å—ã)
9. [–°—Ö–µ–º–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö](#9-—Å—Ö–µ–º–∞-–±–∞–∑—ã-–¥–∞–Ω–Ω—ã—Ö)
10. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#10-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
11. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#11-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
12. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –û–±—Ä–∞–±–æ—Ç–∫–∏ –û—à–∏–±–æ–∫](#12-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–æ—à–∏–±–æ–∫)
13. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å](#13-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å)
14. [CI/CD –°—Ç—Ä–∞—Ç–µ–≥–∏—è](#14-cicd-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è)
15. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°](#15-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏-—Å-1—Å)

**üìã –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [API Views Documentation](api-views-documentation.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Django ViewSets –∏ endpoints
- [Test Catalog API](test-catalog-api.md) - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ API
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°](architecture/20-1c-integration.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°:–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π
- [–ó–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É 1–°](architecture/request-to-1c-developer.md) - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°

---

## 1. –í–≤–µ–¥–µ–Ω–∏–µ

# –í–≤–µ–¥–µ–Ω–∏–µ

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

**FREESPORT** - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è API-First –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –∫–æ–º–º–µ—Ä—Ü–∏–∏, –æ–±—ä–µ–¥–∏–Ω—è—é—â–∞—è 5 —Ç–æ—Ä–≥–æ–≤—ã—Ö –º–∞—Ä–æ–∫ –≤ –µ–¥–∏–Ω–æ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º–µ B2B/B2C –ø—Ä–æ–¥–∞–∂. –ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –æ–ø—Ç–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–æ–≤, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã—Ö —Ñ–µ–¥–µ—Ä–∞—Ü–∏–π –∏ –¥–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤.

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

**Architecture Pattern:** API-First (Headless) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å SSR/SSG
**Primary Technology Stack:** Django REST Framework + Next.js
**Database:** PostgreSQL —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
**Integration Layer:** REST API + WebHooks + BFF (Backend for Frontend)
**Authentication:** JWT —Ç–æ–∫–µ–Ω—ã —Å refresh —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π

## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

- **B2B Functionality:** 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–ø—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–æ–ª–µ–π: —Ç—Ä–µ–Ω–µ—Ä –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏ —Å–ø–æ—Ä—Ç–∞
- **B2C Integration:** –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–æ–∑–Ω–∏—á–Ω—ã—Ö –ø—Ä–æ–¥–∞–∂ —Å –Æ–ö–∞—Å—Å–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π  
- **ERP Integration:** –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –æ–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ —Å 1–° (–æ—Å—Ç–∞—Ç–∫–∏, –∑–∞–∫–∞–∑—ã, —Å—Ç–∞—Ç—É—Å—ã)
- **Multi-Brand Support:** 5 —Ç–æ—Ä–≥–æ–≤—ã—Ö –º–∞—Ä–æ–∫ –≤ –µ–¥–∏–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- **Scalability:** –ú–æ–Ω–æ—Ä–µ–ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

## –ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

1. **API-First + SSR/SSG Approach:** –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
2. **Next.js Hybrid Rendering:** SSG –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, SSR –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö, ISR –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–æ–≤
3. **BFF Layer:** Next.js API Routes –∫–∞–∫ –ø—Ä–æ—Å–ª–æ–π–∫–∞ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
4. **Monorepo Structure:** –£–ø—Ä–æ—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –º–µ–∂–¥—É –±—Ä–µ–Ω–¥–∞–º–∏
5. **PostgreSQL Choice:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSONB, full-text search, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
4. **Django + DRF:** –ó—Ä–µ–ª–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é –∏ ORM

---

## 2. –ú–æ–¥–µ–ª–∏ –î–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤—è–∑–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π

```mermaid
erDiagram
    User ||--o{ Order : places
    User ||--o{ CartItem : has
    User ||--o{ UserRole : assigned
    
    Product ||--o{ CartItem : contains
    Product ||--o{ OrderItem : ordered
    Product }|--|| Category : belongs_to
    Product ||--o{ ProductPrice : has_pricing
    
    Order ||--o{ OrderItem : contains
    Order }|--|| OrderStatus : has_status
    Order }|--|| PaymentMethod : paid_with
    
    Category ||--o{ Category : parent_child
    
    UserRole }|--|| Role : defines
    ProductPrice }|--|| PriceType : categorized_by
```

### –ú–æ–¥–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

```python
# –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π
class User(AbstractUser):
    email = models.EmailField(unique=True)
    phone = models.CharField(max_length=20, blank=True)
    role = models.CharField(max_length=20, choices=USER_ROLES, default='retail')
    company_name = models.CharField(max_length=200, blank=True)
    tax_id = models.CharField(max_length=50, blank=True)  # –ò–ù–ù –¥–ª—è B2B
    is_verified = models.BooleanField(default=False)
    verification_token = models.CharField(max_length=100, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

USER_ROLES = [
    ('retail', '–†–æ–∑–Ω–∏—á–Ω—ã–π –ø–æ–∫—É–ø–∞—Ç–µ–ª—å'),
    ('wholesale_level1', '–û–ø—Ç–æ–≤–∏–∫ —É—Ä–æ–≤–µ–Ω—å 1'),
    ('wholesale_level2', '–û–ø—Ç–æ–≤–∏–∫ —É—Ä–æ–≤–µ–Ω—å 2'), 
    ('wholesale_level3', '–û–ø—Ç–æ–≤–∏–∫ —É—Ä–æ–≤–µ–Ω—å 3'),
    ('trainer', '–¢—Ä–µ–Ω–µ—Ä'),
    ('federation_rep', '–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏'),
    ('admin', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'),
]

class UserProfile(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    birth_date = models.DateField(blank=True, null=True)
    avatar = models.ImageField(upload_to='avatars/', blank=True)
    delivery_address = models.TextField(blank=True)
    legal_address = models.TextField(blank=True)
    preferred_delivery_method = models.CharField(max_length=50, blank=True)
```

### –ú–æ–¥–µ–ª–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤

```python
class Category(models.Model):
    name = models.CharField(max_length=200)
    slug = models.SlugField(unique=True)
    parent = models.ForeignKey('self', null=True, blank=True, on_delete=models.CASCADE)
    description = models.TextField(blank=True)
    image = models.ImageField(upload_to='categories/', blank=True)
    is_active = models.BooleanField(default=True)
    sort_order = models.PositiveIntegerField(default=0)
    seo_title = models.CharField(max_length=200, blank=True)
    seo_description = models.TextField(blank=True)

class Brand(models.Model):
    name = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(unique=True)
    logo = models.ImageField(upload_to='brands/', blank=True)
    description = models.TextField(blank=True)
    website = models.URLField(blank=True)
    is_active = models.BooleanField(default=True)

class Product(models.Model):
    name = models.CharField(max_length=300)
    slug = models.SlugField(unique=True)
    brand = models.ForeignKey(Brand, on_delete=models.CASCADE)
    category = models.ForeignKey(Category, on_delete=models.CASCADE)
    description = models.TextField()
    short_description = models.CharField(max_length=500, blank=True)
    
    # –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    retail_price = models.DecimalField(max_digits=10, decimal_places=2)
    opt1_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    opt2_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    opt3_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    trainer_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    federation_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø–æ–∫—É–ø–∫–∏)
    recommended_retail_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)  # RRP
    max_suggested_retail_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)  # MSRP
    
    # –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è
    sku = models.CharField(max_length=100, unique=True)
    stock_quantity = models.PositiveIntegerField(default=0) # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
    reserved_quantity = models.PositiveIntegerField(default=0) # –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω–∞—Ö
    min_order_quantity = models.PositiveIntegerField(default=1)
    
    # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    main_image = models.ImageField(upload_to='products/')
    gallery_images = models.JSONField(default=list, blank=True)
    
    # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏  
    specifications = models.JSONField('–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏', default=dict, blank=True)
    
    # SEO & Meta
    seo_title = models.CharField(max_length=200, blank=True)
    seo_description = models.TextField(blank=True)
    
    # Flags
    is_active = models.BooleanField(default=True)
    is_featured = models.BooleanField(default=False)
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–°
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    onec_id = models.CharField(max_length=100, blank=True, null=True)  # 1C reference
    last_sync_at = models.DateTimeField(null=True, blank=True)
    
    # Computed properties
    @property
    def is_in_stock(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ (—É—Å—Ç–∞—Ä–µ–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ available_quantity)"""
        return self.stock_quantity > 0

    @property
    def available_quantity(self):
        """–î–æ—Å—Ç—É–ø–Ω–æ–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∑–∞ –≤—ã—á–µ—Ç–æ–º —Ä–µ–∑–µ—Ä–≤–æ–≤)"""
        return self.stock_quantity - self.reserved_quantity

    @property
    def can_be_ordered(self):
        """–ú–æ–∂–Ω–æ –ª–∏ –∑–∞–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä (–∞–∫—Ç–∏–≤–µ–Ω –∏ –≤ –Ω–∞–ª–∏—á–∏–∏)"""
        return self.is_active and self.available_quantity > 0
```

### –ú–æ–¥–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏

```python
class Order(models.Model):
    # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–∫–∞–∑–∞
    order_number = models.CharField(max_length=50, unique=True)
    user = models.ForeignKey(User, on_delete=models.CASCADE, null=True, blank=True)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ (–¥–ª—è –≥–æ—Å—Ç–µ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤)
    customer_name = models.CharField(max_length=200, blank=True)
    customer_email = models.EmailField(blank=True)
    customer_phone = models.CharField(max_length=20, blank=True)
    
    # –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
    status = models.CharField(max_length=50, choices=ORDER_STATUSES, default='pending')
    total_amount = models.DecimalField(max_digits=10, decimal_places=2)
    discount_amount = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    delivery_cost = models.DecimalField(max_digits=10, decimal_places=2, default=0)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ
    delivery_address = models.TextField()
    delivery_method = models.CharField(max_length=50, choices=DELIVERY_METHODS)
    delivery_date = models.DateField(null=True, blank=True)
    
    # Payment Information
    payment_method = models.CharField(max_length=50, choices=PAYMENT_METHODS)
    payment_status = models.CharField(max_length=50, choices=PAYMENT_STATUSES, default='pending')
    payment_id = models.CharField(max_length=100, blank=True)  # YuKassa payment ID
    
    # –ü–æ–ª—è –¥–ª—è B2B
    company_name = models.CharField(max_length=200, blank=True)
    tax_id = models.CharField(max_length=50, blank=True)
    purchase_order_number = models.CharField(max_length=100, blank=True)
    
    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∞—É–¥–∏—Ç
    onec_id = models.CharField(max_length=100, blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    notes = models.TextField(blank=True)
    
    # –í—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    @property
    def total_items(self):
        """–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ"""
        return sum(item.quantity for item in self.items.all())

    @property
    def calculated_total(self):
        """–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –æ–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞"""
        return sum(item.total_price for item in self.items.all())

    @property
    def can_be_cancelled(self):
        """–ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑"""
        return self.status in ['pending', 'confirmed']

ORDER_STATUSES = [
    ('pending', '–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏'),
    ('confirmed', '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω'),
    ('processing', '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'),
    ('shipped', '–û—Ç–≥—Ä—É–∂–µ–Ω'),
    ('delivered', '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'),
    ('cancelled', '–û—Ç–º–µ–Ω–µ–Ω'),
    ('returned', '–í–æ–∑–≤—Ä–∞—â–µ–Ω'),
]

#### –õ–æ–≥–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤

–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂ (overselling) –≤ —Å–∏—Å—Ç–µ–º–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Ö –≤ –∫–æ—Ä–∑–∏–Ω—É. –≠—Ç–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —Å–∏–≥–Ω–∞–ª–æ–≤ Django (`pre_save`, `post_delete`) –¥–ª—è –º–æ–¥–µ–ª–∏ `CartItem`.

- **–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–≤–µ–ª–∏—á–µ–Ω–∏–∏** —Ç–æ–≤–∞—Ä–∞ –≤ `CartItem`, –ø–æ–ª–µ `product.reserved_quantity` –∞—Ç–æ–º–∞—Ä–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è.
- **–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏/—É–º–µ–Ω—å—à–µ–Ω–∏–∏** —Ç–æ–≤–∞—Ä–∞ –∏–∑ `CartItem`, –ø–æ–ª–µ `product.reserved_quantity` –∞—Ç–æ–º–∞—Ä–Ω–æ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è.

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ (`Order`) –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (`stock_quantity`) —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è, –∞ —Ä–µ–∑–µ—Ä–≤ (`reserved_quantity`) –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –∑–∞ —Å—á–µ—Ç —É–¥–∞–ª–µ–Ω–∏—è `CartItem`.

–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–º —Ä–µ—à–µ–Ω–∏–∏:
- **ADR:** [–õ–æ–≥–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É](./decisions/story-3.x-product-reservation-logic.md)

class OrderItem(models.Model):
    order = models.ForeignKey(Order, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField()
    unit_price = models.DecimalField(max_digits=10, decimal_places=2)
    total_price = models.DecimalField(max_digits=10, decimal_places=2)
    
    # –°–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–µ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–∫–∞–∑–∞
    product_name = models.CharField(max_length=300)
    product_sku = models.CharField(max_length=100)
    
    class Meta:
        unique_together = ('order', 'product')  # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

```python
class Cart(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, null=True, blank=True)
    session_key = models.CharField(max_length=100, blank=True)  # For guest users
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class CartItem(models.Model):
    cart = models.ForeignKey(Cart, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey(Product, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField(default=1)
    added_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        unique_together = ('cart', 'product')

# –ê—É–¥–∏—Ç–æ—Ä—Å–∫–∏–π –∂—É—Ä–Ω–∞–ª –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º B2B
class AuditLog(models.Model):
    user = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    action = models.CharField(max_length=100)
    resource_type = models.CharField(max_length=50)
    resource_id = models.CharField(max_length=100)
    changes = models.JSONField(default=dict)
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    timestamp = models.DateTimeField(auto_now_add=True)

# –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ 1–°
class SyncLog(models.Model):
    sync_type = models.CharField(max_length=50, choices=[
        ('products', '–¢–æ–≤–∞—Ä—ã'),
        ('stocks', '–û—Å—Ç–∞—Ç–∫–∏'), 
        ('orders', '–ó–∞–∫–∞–∑—ã'),
        ('prices', '–¶–µ–Ω—ã'),
    ])
    status = models.CharField(max_length=20, choices=[
        ('started', '–ù–∞—á–∞—Ç–∞'),
        ('completed', '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'),
        ('failed', '–û—à–∏–±–∫–∞'),
    ])
    records_processed = models.PositiveIntegerField(default=0)
    errors_count = models.PositiveIntegerField(default=0)
    error_details = models.JSONField(default=list)
    started_at = models.DateTimeField(auto_now_add=True)
    completed_at = models.DateTimeField(null=True, blank=True)
```

---

## 3. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è API

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ö–µ–º—ã OpenAPI 3.1

```yaml
openapi:
info:
  title: FREESPORT API
  description: Comprehensive e-commerce API supporting B2B/B2C operations
  version: "1.0.0"
  contact:
    name: FREESPORT Development Team
    email: dev@freesport.com

servers:
  - url: https://api.freesport.com/v1
    description: Production server
  - url: https://staging-api.freesport.com/v1
    description: Staging server

security:
  - BearerAuth: []
  - ApiKeyAuth: []

paths:
  # Authentication Endpoints
  /auth/login/:
    post:
      tags: [Authentication]
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
              required: [email, password]
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  user:
                    $ref: '#/components/schemas/User'

  /auth/refresh/:
    post:
      tags: [Authentication]
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
              required: [refresh_token]

  # Product Catalog Endpoints  
  /products/:
    get:
      tags: [Products]
      summary: List products with filtering and pagination
      parameters:
        - name: category
          in: query
          schema:
            type: string
        - name: brand
          in: query
          schema:
            type: string
        - name: min_price
          in: query
          schema:
            type: number
        - name: max_price
          in: query
          schema:
            type: number
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Products list
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  next:
                    type: string
                    nullable: true
                  previous:
                    type: string
                    nullable: true
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'

  /products/{id}/:
    get:
      tags: [Products]
      summary: Get product details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Product details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductDetail'

  # Cart Management
  /cart/:
    get:
      tags: [Cart]
      summary: Get current user's cart
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Cart contents
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cart'
    
    post:
      tags: [Cart]
      summary: Add item to cart
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                product_id:
                  type: integer
                quantity:
                  type: integer
                  minimum: 1
              required: [product_id, quantity]

  # Order Management
  /orders/:
    get:
      tags: [Orders]
      summary: List user orders
      security:
        - BearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, processing, shipped, delivered, cancelled]
        - name: page
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Orders list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderList'
    
    post:
      tags: [Orders]
      summary: Create new order
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderCreate'
      responses:
        '201':
          description: Order created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

# Webhooks for YuKassa Integration (OpenAPI 3.1 feature)
webhooks:
  payment-notification:
    post:
      tags: [Webhooks]
      summary: YuKassa payment notification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentWebhook'
      responses:
        '200':
          description: Webhook processed successfully

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
        email:
          type: string
          format: email
        first_name:
          type: string
        last_name:
          type: string
        role:
          type: string
          enum: [retail, wholesale_level1, wholesale_level2, wholesale_level3, trainer, federation_rep, admin]
        company_name:
          type: string
        phone:
          type: string
        is_verified:
          type: boolean

    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        slug:
          type: string
        brand:
          $ref: '#/components/schemas/Brand'
        category:
          $ref: '#/components/schemas/Category'
        current_price:
          type: number
          format: decimal
          description: –¶–µ–Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        retail_price:
          type: number
          format: decimal
        price_type:
          type: string
          enum: [retail, wholesale_level1, wholesale_level2, wholesale_level3, trainer, federation]
        recommended_retail_price:
          type: number
          format: decimal
          description: RRP - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ç–æ–≤–∏–∫–∏, —Ç—Ä–µ–Ω–µ—Ä—ã, —Ñ–µ–¥–µ—Ä–∞–ª—ã)
          nullable: true
        max_suggested_retail_price:
          type: number
          format: decimal  
          description: MSRP - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
          nullable: true
        main_image:
          type: string
          format: uri
        stock_quantity:
          type: integer
        min_order_quantity:
          type: integer
        is_available:
          type: boolean

    ProductDetail:
      allOf:
        - $ref: '#/components/schemas/Product'
        - type: object
          properties:
            description:
              type: string
            short_description:
              type: string
            gallery_images:
              type: array
              items:
                type: string
                format: uri
            seo_title:
              type: string
            seo_description:
              type: string

    Order:
      type: object
      properties:
        id:
          type: integer
        order_number:
          type: string
        status:
          type: string
          enum: [pending, confirmed, processing, shipped, delivered, cancelled]
        total_amount:
          type: number
          format: decimal
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        delivery_address:
          type: string
        payment_method:
          type: string
        payment_status:
          type: string
        created_at:
          type: string
          format: date-time
        # –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è
        total_items:
          type: integer
          description: "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ"
          readOnly: true
        calculated_total:
          type: number
          format: decimal
          description: "–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –æ–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–π"
          readOnly: true
        can_be_cancelled:
          type: boolean
          description: "–ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑"
          readOnly: true

    PaymentWebhook:
      type: object
      properties:
        type:
          type: string
          enum: [notification]
        event:
          type: string
          enum: [payment.succeeded, payment.canceled]
        object:
          type: object
          properties:
            id:
              type: string
            status:
              type: string
            amount:
              type: object
              properties:
                value:
                  type: string
                currency:
                  type: string
            metadata:
              type: object
              properties:
                order_id:
                  type: string
```

### –°–ª–æ–π BFF (Backend for Frontend)

Next.js API Routes —Å–ª—É–∂–∞—Ç –∫–∞–∫ –ø—Ä–æ—Å–ª–æ–π–∫–∞ –º–µ–∂–¥—É frontend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –∏ Django API, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è:

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ BFF:
- **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö Django API endpoints
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–∫—Ä—ã—Ç–∏–µ sensitive API keys –∏ tokens –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞  
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Server-side –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥ –Ω—É–∂–¥—ã frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### BFF API Routes Structure:

```typescript
// /app/api/products/route.ts - Aggregated products with pricing
import { NextRequest, NextResponse } from 'next/server';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const brand = searchParams.get('brand');
    const category = searchParams.get('category');
    
    // Aggregate data from multiple Django endpoints
    const [productsRes, pricingRes, inventoryRes] = await Promise.all([
      fetch(`${process.env.DJANGO_API_URL}/products/?brand=${brand}&category=${category}`, {
        headers: { 'Authorization': `Bearer ${process.env.API_TOKEN}` }
      }),
      fetch(`${process.env.DJANGO_API_URL}/pricing/?brand=${brand}`),
      fetch(`${process.env.DJANGO_API_URL}/inventory/`)
    ]);

    const products = await productsRes.json();
    const pricing = await pricingRes.json();
    const inventory = await inventoryRes.json();

    // Transform and combine data with RRP/MSRP for B2B users
    const enrichedProducts = products.map(product => ({
      ...product,
      price: pricing[product.id] || product.base_price,
      in_stock: inventory[product.id]?.quantity > 0,
      estimated_delivery: calculateDelivery(product.warehouse_location),
      // ‚úÖ Include RRP/MSRP for B2B users only (FR5)
      ...(isB2BUser(request) && {
        recommendedRetailPrice: product.recommended_retail_price,
        maxSuggestedRetailPrice: product.max_suggested_retail_price
      })
    }));

    return NextResponse.json({
      products: enrichedProducts,
      total: products.length,
      has_more: products.length === 20
    });

  } catch (error) {
    console.error('BFF Products API Error:', error);
    return NextResponse.json(
      { error: 'Failed to fetch products' },
      { status: 500 }
    );
  }
}
```

```typescript
// /app/api/auth/login/route.ts - Secure authentication
import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    // Authenticate with Django API
    const authResponse = await fetch(`${process.env.DJANGO_API_URL}/auth/login/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!authResponse.ok) {
      return NextResponse.json(
        { error: 'Invalid credentials' },
        { status: 401 }
      );
    }

    const { access_token, refresh_token, user } = await authResponse.json();

    // Set secure HTTP-only cookies
    cookies().set('access_token', access_token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 15 * 60 // 15 minutes
    });

    cookies().set('refresh_token', refresh_token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 7 * 24 * 60 * 60 // 7 days
    });

    // Return user data (without tokens)
    return NextResponse.json({ user });

  } catch (error) {
    console.error('BFF Auth Error:', error);
    return NextResponse.json(
      { error: 'Authentication failed' },
      { status: 500 }
    );
  }
}
```

### BFF Middleware –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```typescript
// middleware.ts - Server-side authentication
import { NextRequest, NextResponse } from 'next/server';
import { verifyToken } from '@/lib/auth';

export async function middleware(request: NextRequest) {
  // Protect API routes
  if (request.nextUrl.pathname.startsWith('/api/protected')) {
    const accessToken = request.cookies.get('access_token');
    
    if (!accessToken) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    try {
      const isValid = await verifyToken(accessToken.value);
      if (!isValid) {
        return NextResponse.json({ error: 'Token expired' }, { status: 401 });
      }
    } catch (error) {
      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
    }
  }

  // Protect dashboard pages
  if (request.nextUrl.pathname.startsWith('/dashboard')) {
    const accessToken = request.cookies.get('access_token');
    
    if (!accessToken) {
      return NextResponse.redirect(new URL('/login', request.url));
    }
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    '/api/protected/:path*',
    '/dashboard/:path*',
    '/api/cart/:path*',
    '/api/orders/:path*'
  ]
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ FR5)
function isB2BUser(request: NextRequest): boolean {
  // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ —Å–µ—Å—Å–∏–∏
  const authHeader = request.headers.get('authorization');
  if (!authHeader) return false;
  
  try {
    const token = authHeader.replace('Bearer ', '');
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const userRole = decoded.role;
    
    // B2B —Ä–æ–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å RRP/MSRP
    const b2bRoles = ['wholesale_level1', 'wholesale_level2', 'wholesale_level3', 'trainer', 'federation_rep'];
    return b2bRoles.includes(userRole);
  } catch (error) {
    return false;
  }
}
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ API

```python
# JWT Authentication with Refresh Tokens
from rest_framework_simplejwt.authentication import JWTAuthentication
from rest_framework_simplejwt.tokens import RefreshToken

class CustomJWTAuthentication(JWTAuthentication):
    def get_user(self, validated_token):
        user = super().get_user(validated_token)
        # Add custom user role validation
        if not user.is_active:
            raise AuthenticationFailed('User account is disabled.')
        return user

# API Rate Limiting
from django_ratelimit.decorators import ratelimit

@ratelimit(key='ip', rate='100/h', method='POST')
@ratelimit(key='user', rate='1000/h', method='POST')  
def create_order(request):
    # Order creation logic
    pass

# Input Validation & Serialization
class ProductFilterSerializer(serializers.Serializer):
    category = serializers.CharField(max_length=100, required=False)
    brand = serializers.CharField(max_length=100, required=False)
    min_price = serializers.DecimalField(max_digits=10, decimal_places=2, required=False)
    max_price = serializers.DecimalField(max_digits=10, decimal_places=2, required=False)
    search = serializers.CharField(max_length=200, required=False)
    
    def validate(self, data):
        if 'min_price' in data and 'max_price' in data:
            if data['min_price'] > data['max_price']:
                raise serializers.ValidationError("min_price cannot be greater than max_price")
        return data
```

---

## 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### Frontend Architecture (Next.js 14+)

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
frontend/src/
‚îú‚îÄ‚îÄ app/                          # App Router (Next.js 13+)
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/                   # Route groups
‚îÇ   ‚îú‚îÄ‚îÄ catalog/
‚îÇ   ‚îú‚îÄ‚îÄ product/[id]/
‚îÇ   ‚îú‚îÄ‚îÄ admin/                    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ api/                      # API Routes (BFF)
‚îú‚îÄ‚îÄ components/                   # React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ ui/                       # –ë–∞–∑–æ–≤—ã–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Input/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Modal/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Toast/
‚îÇ   ‚îú‚îÄ‚îÄ business/                 # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductCard/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cart/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Checkout/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ B2BVerification/
‚îÇ   ‚îú‚îÄ‚îÄ admin/                    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ApplicationModeration/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Integration1CMonitor/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserManagement/
‚îÇ   ‚îî‚îÄ‚îÄ layout/                   # –õ–µ–π–∞—É—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ Header/
‚îÇ       ‚îú‚îÄ‚îÄ Navigation/
‚îÇ       ‚îî‚îÄ‚îÄ Footer/
‚îú‚îÄ‚îÄ hooks/                        # Custom React hooks
‚îú‚îÄ‚îÄ services/                     # API —Å–µ—Ä–≤–∏—Å—ã
‚îú‚îÄ‚îÄ stores/                       # State management (Zustand)
‚îú‚îÄ‚îÄ types/                        # TypeScript —Ç–∏–ø—ã
‚îî‚îÄ‚îÄ utils/                        # –£—Ç–∏–ª–∏—Ç—ã
```

#### UI Component Library (—Å–æ–≥–ª–∞—Å–Ω–æ front-end-spec.md)

**–ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```typescript
// –ö–Ω–æ–ø–∫–∏ —Å B2B/B2C –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
interface ButtonProps {
  variant: 'primary' | 'secondary' | 'outline' | 'ghost' | 'b2b-bulk' | 'danger'
  size: 'xs' | 'sm' | 'md' | 'lg' | 'xl'
  mode: 'b2c' | 'b2b' | 'universal'
}

// –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ä–æ–ª–µ–≤—ã–º —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º  
interface ProductCardProps {
  mode: 'b2c' | 'b2b'
  layout: 'grid' | 'list' | 'compact'
  product: Product
  showRRP?: boolean // –î–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  showMSRP?: boolean // –î–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
}

// –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
interface SortOptionsProps {
  options: SortOption[]
  currentSort: string
  mode: 'b2c' | 'b2b'
}
```

**–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```typescript
// –î–∞—à–±–æ—Ä–¥ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
interface AdminDashboardProps {
  kpis: KPIData
  alerts: AlertItem[]
  integrationStatus: Integration1CStatus
  systemMetrics: SystemMetrics
}

// –ú–æ–¥–µ—Ä–∞—Ü–∏—è B2B –∑–∞—è–≤–æ–∫
interface ModerationListProps {
  applications: B2BApplication[]
  filters: ModerationFilters
  onApprove: (id: string, role: UserRole) => void
  onReject: (id: string, reason: string) => void
}

// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°
interface Integration1CMonitorProps {
  status: CircuitBreakerStatus
  syncHistory: SyncLogEntry[]
  onManualSync: (type: SyncType) => void
}
```

### Backend Architecture (Django + DRF)

#### –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

```
backend/
‚îú‚îÄ‚îÄ apps/                             # Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ users/                        # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views/                    # ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ views (Story 2.3)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py           # –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authentication.py     # UserRegistrationView, UserLoginView
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile.py            # UserProfileView
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ misc.py               # user_roles_view
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ personal_cabinet.py   # Dashboard, Addresses, Favorites, Orders
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # User, Company, Address, Favorite
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serializers.py            # DRF serializers —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ urls.py                   # Router —Å ViewSets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/               # Database migrations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py                  # Django admin
‚îÇ   ‚îú‚îÄ‚îÄ products/                     # –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # Product, Category, Brand
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py                  # API endpoints –∫–∞—Ç–∞–ª–æ–≥–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serializers.py            # –†–æ–ª–µ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ filters.py                # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
‚îÇ   ‚îú‚îÄ‚îÄ orders/                       # –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # Order, OrderItem
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py                  # Checkout, order management
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks.py                  # Celery tasks –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ cart/                         # –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py                 # Cart, CartItem
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ views.py                  # Session-based cart
‚îÇ   ‚îî‚îÄ‚îÄ common/                       # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ       ‚îú‚îÄ‚îÄ permissions.py            # Custom permissions
‚îÇ       ‚îú‚îÄ‚îÄ pagination.py             # –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ exceptions.py             # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
‚îÇ       ‚îî‚îÄ‚îÄ utils.py                  # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ freesport/                        # Django –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ settings/                     # –ú–æ–¥—É–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py                   # OpenAPI 3.1, JWT, DRF
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ development.py            # Dev –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ production.py             # Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ urls.py                       # Root URL configuration
‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py                       # WSGI application
‚îú‚îÄ‚îÄ requirements.txt                  # Python dependencies
‚îú‚îÄ‚îÄ TODO_TEMPORARY_FIXES.md           # ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥–ª—É—à–µ–∫
‚îî‚îÄ‚îÄ manage.py                         # Django CLI
```

#### Views Architecture Pattern (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ Story 2.3)

**–ú–æ–¥—É–ª—å–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è views –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏:**

```python
# apps/users/views/__init__.py - –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
from .authentication import UserRegistrationView, UserLoginView
from .profile import UserProfileView  
from .misc import user_roles_view
from .personal_cabinet import UserDashboardView, AddressViewSet, FavoriteViewSet

# apps/users/views/authentication.py - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
class UserRegistrationView(APIView):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —Ä–æ–ª–µ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π B2B/B2C"""
    
class UserLoginView(APIView):
    """JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"""

# apps/users/views/personal_cabinet.py - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
class UserDashboardView(APIView):
    """–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
class AddressViewSet(viewsets.ModelViewSet):
    """CRUD —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞–º–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
    
class FavoriteViewSet(viewsets.ModelViewSet):
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏"""
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º–æ–¥—É–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:**
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**: –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ endpoints –±–µ–∑ –∑–∞–≥—Ä–æ–º–æ–∂–¥–µ–Ω–∏—è
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö URL patterns —á–µ—Ä–µ–∑ __init__.py

#### State Management Strategy

```typescript
// User store (Zustand)
interface UserStore {
  user: User | null
  userRole: UserRole
  isAuthenticated: boolean
  permissions: string[]
}

// Cart store —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π B2B –ª–æ–≥–∏–∫–∏
interface CartStore {
  items: CartItem[]
  userMode: 'b2c' | 'b2b'
  minimumOrderAmount: number
  bulkDiscounts: BulkDiscount[]
}

// UI state –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
interface UIStore {
  modals: ModalState[]
  notifications: Notification[]
  theme: 'b2c' | 'b2b'
}
```

#### Responsive Design System

```scss
// Breakpoints (—Å–æ–≥–ª–∞—Å–Ω–æ front-end-spec.md)
$breakpoints: (
  xs: 0,           // –ú–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã
  sm: 576px,       // –ë–æ–ª—å—à–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã  
  md: 768px,       // –ü–ª–∞–Ω—à–µ—Ç—ã
  lg: 992px,       // –ù–µ–±–æ–ª—å—à–∏–µ –Ω–æ—É—Ç–±—É–∫–∏
  xl: 1200px,      // –ë–æ–ª—å—à–∏–µ —ç–∫—Ä–∞–Ω—ã
  xxl: 1400px      // –®–∏—Ä–æ–∫–∏–µ –º–æ–Ω–∏—Ç–æ—Ä—ã
);

// –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞
$text-base: clamp(1rem, 0.95rem + 0.25vw, 1.1rem);
$text-lg: clamp(1.125rem, 1rem + 0.5vw, 1.25rem);
```

---

## 5. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –°—Ç–µ–∫

### Backend —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|------------|---------|---------------|
| **–í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫** | Django | 4.2 LTS | –ó—Ä–µ–ª—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫, –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, ORM, —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |
| **API —Ñ—Ä–µ–π–º–≤–æ—Ä–∫** | Django REST Framework | 3.14+ | –û—Ç—Ä–∞—Å–ª–µ–≤–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è Django API, –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è |
| **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** | PostgreSQL | 15+ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSONB, –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å |
| **–ö–µ—à** | Redis | 7.0+ | –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –±—Ä–æ–∫–µ—Ä Celery |
| **–û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á** | Celery | 5.3+ | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è |
| **–í–µ–±-—Å–µ—Ä–≤–µ—Ä** | Nginx | 1.24+ | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã, –æ–±—Ä–∞—Ç–Ω—ã–π –ø—Ä–æ–∫—Å–∏, –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ |
| **WSGI —Å–µ—Ä–≤–µ—Ä** | Gunicorn | 21.0+ | –ì–æ—Ç–æ–≤—ã–π –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É Python WSGI —Å–µ—Ä–≤–µ—Ä |

### Frontend —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|-----------|------------|---------|---------------|
| **–§—Ä–µ–π–º–≤–æ—Ä–∫** | Next.js | 14+ | SSR/SSG/ISR, SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| **–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞** | –ì–∏–±—Ä–∏–¥–Ω—ã–π SSR/SSG/CSR | - | SSG –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö, SSR –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö, CSR –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö |
| **–Ø–∑—ã–∫** | TypeScript | 5.0+ | –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ª—É—á—à–∏–π –æ–ø—ã—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º** | Zustand | 4.4+ | –õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ–π, —Å–æ–≤–º–µ—Å—Ç–∏–º —Å SSR |
| **UI —Ñ—Ä–µ–π–º–≤–æ—Ä–∫** | Tailwind CSS | 3.3+ | Utility-first –ø–æ–¥—Ö–æ–¥, —Å–æ–≤–º–µ—Å—Ç–∏–º —Å SSR |
| **–§–æ—Ä–º—ã** | React Hook Form | 7.45+ | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ-—Ä–µ–Ω–¥–µ—Ä—ã |
| **API —Å–ª–æ–π** | Next.js API Routes | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π | BFF —Å–ª–æ–π, —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ API –≤—ã–∑–æ–≤—ã |

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ DevOps

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|---------|
| **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** | Docker | –°—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ |
| **–û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è** | Docker Compose (dev/staging) / Docker Swarm (prod) | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | Sentry + Grafana + Prometheus | Error tracking + performance monitoring |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** | next/image (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è) + Pillow (–∑–∞–≥—Ä—É–∑–∫–∞) | Django —Ö—Ä–∞–Ω–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—ã, Next.js –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ –ª–µ—Ç—É |
| **–•—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤** | S3-Compatible (MinIO/AWS) | –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Docker Swarm |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|---------|
| **SSL/TLS** | Let's Encrypt | HTTPS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ |
| **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** | JWT (Simple JWT) | Stateless –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |
| **–•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π** | Argon2 | –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π |
| **–§–∞–µ—Ä–≤–æ–ª** | UFW | –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å |

---

## 6. –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```mermaid
C4Deployment
    title Deployment Diagram - FREESPORT Production Infrastructure (Optimized Layout)

    %% –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    Deployment_Node(client, "Client Devices", "User Environment") {
        Person(b2b_users, "B2B Users", "Wholesale buyers, trainers")
        Person(b2c_users, "B2C Users", "Retail customers")
        Person(admins, "Administrators", "System managers")
    }
    %% –û—Å–Ω–æ–≤–Ω–æ–π —É–∑–µ–ª —Å–µ—Ä–≤–µ—Ä–∞ —Å –≤–ª–æ–∂–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    Deployment_Node(cloud, "VPS/VDS Server", "Production Environment") {
        
        %% –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–∑–µ–ª –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –æ—Ç–≤–µ—á–∞—é—â–∏—Ö –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤
        Deployment_Node(app_layer, "Application Layer") {
            Container(nginx, "Nginx", "Web Server", "Load balancer, SSL")
            Container(nextjs, "Next.js App", "Node.js 18+", "Frontend + BFF")
            Container(django, "Django API", "Python 3.11+", "Backend API")
        }

        %% –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–∑–µ–ª –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏ —Ñ–æ–Ω–æ–≤—ã—Ö —Å–ª—É–∂–± —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º
        Deployment_Node(data_layer, "Data & Processing Layer") {
            ContainerDb(postgres, "PostgreSQL", "Database", "Primary data store")
            Container(celery, "Celery Workers", "Python 3.11+", "Async tasks")
            ContainerDb(redis, "Redis", "Cache & Broker", "Sessions, message queue")
            Container(celery_beat, "Celery Beat", "Python 3.11+", "Task scheduler")
        }

        %% --- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–≤—è–∑–∏ ---
        Rel(nginx, nextjs, "–ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã", "port 3000")
        Rel(nginx, django, "–ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç /api", "port 8000")
        Rel(nextjs, django, "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≤—ã–∑–æ–≤—ã API")

        Rel(django, postgres, "–ß–∏—Ç–∞–µ—Ç/–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ", "SQL/5432")
        Rel(django, redis, "–ö—ç—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ")

        Rel(celery, redis, "–ó–∞–±–∏—Ä–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑", "Queue/6379")
        Rel(celery_beat, redis, "–ü—É–±–ª–∏–∫—É–µ—Ç –∑–∞–¥–∞—á–∏ –≤")
        Rel(celery, postgres, "–ß–∏—Ç–∞–µ—Ç/–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ")
    }

    %% –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
    Deployment_Node(external, "External Services", "Third-party Integrations") {
        System_Ext(onec, "1C ERP", "Business management")
        System_Ext(yukassa, "YuKassa", "Payment processing")
        System_Ext(delivery, "Delivery APIs", "CDEK, Boxberry")
    }

    %% --- –í–Ω–µ—à–Ω–∏–µ —Å–≤—è–∑–∏ ---
    Rel(b2b_users, nginx, "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç", "HTTPS")
    Rel(b2c_users, nginx, "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç", "HTTPS")
    Rel(admins, nginx, "–£–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑", "HTTPS")

    Rel(django, onec, "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ", "API/Files")
    Rel(django, yukassa, "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏", "Webhooks")
    Rel(django, delivery, "–ü–æ–ª—É—á–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã", "API")
```

### –°—Ö–µ–º–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```mermaid
graph LR
    subgraph "DMZ Zone"
        NGINX[Nginx<br/>:443, :80]
        FIREWALL[Firewall<br/>Rules]
    end
    
    subgraph "Application Zone"
        NEXT[Next.js<br/>:3000]
        DJANGO[Django<br/>:8000]
        CELERY[Celery Workers<br/>Background]
    end
    
    subgraph "Data Zone"
        POSTGRES[PostgreSQL<br/>:5432]
        REDIS[Redis<br/>:6379]
        FILES[File Storage<br/>Local/S3]
    end
    
    subgraph "External Zone"
        ONEC[1C ERP<br/>Various]
        PAYMENTS[YuKassa<br/>:443]
        DELIVERY[Delivery APIs<br/>:443]
    end
    
    Internet -->|TCP:443| FIREWALL
    FIREWALL -->|HTTP/HTTPS| NGINX
    
    NGINX -->|Proxy| NEXT
    NGINX -->|Proxy /api/| DJANGO
    NGINX -->|Static files| FILES
    
    NEXT -->|Internal API| DJANGO
    
    DJANGO -->|SQL| POSTGRES
    DJANGO -->|Cache| REDIS
    CELERY -->|Queue| REDIS
    CELERY -->|Data| POSTGRES
    
    DJANGO -.->|Scheduled sync| ONEC
    DJANGO -.->|Webhooks| PAYMENTS
    DJANGO -.->|Rate limited| DELIVERY
```

### –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å –ø–æ—Ä—Ç–∞–º–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏

```mermaid
graph TB
    subgraph "Frontend Layer"
        FE_COMPONENTS[React Components]
        FE_SERVICES[Frontend Services]
        FE_STORES[Zustand Stores]
        FE_ROUTER[Next.js Router]
    end
    
    subgraph "BFF Layer (Next.js API)"
        BFF_AUTH[Auth Middleware<br/>Port: JWT validation]
        BFF_RATE[Rate Limiter<br/>Port: Request control]
        BFF_AGGREGATE[Data Aggregator<br/>Port: Multi-source data]
    end
    
    subgraph "Backend API Layer"
        API_AUTH[Authentication<br/>Port: /auth/*]
        API_PRODUCTS[Products API<br/>Port: /products/*]
        API_ORDERS[Orders API<br/>Port: /orders/*]
        API_USERS[Users API<br/>Port: /users/*]
        API_CART[Cart API<br/>Port: /cart/*]
    end
    
    subgraph "Business Logic Layer"
        BL_USER[User Management<br/>Interface: UserService]
        BL_PRODUCT[Product Management<br/>Interface: ProductService]
        BL_ORDER[Order Processing<br/>Interface: OrderService]
        BL_PRICING[Pricing Engine<br/>Interface: PricingService]
        BL_INVENTORY[Inventory Management<br/>Interface: InventoryService]
    end
    
    subgraph "Integration Layer"
        INT_1C[1C Connector<br/>Interface: ERPInterface]
        INT_PAYMENT[Payment Gateway<br/>Interface: PaymentInterface]
        INT_DELIVERY[Delivery APIs<br/>Interface: ShippingInterface]
    end
    
    subgraph "Data Access Layer"
        DAL_USER[User Repository<br/>Interface: IUserRepository]
        DAL_PRODUCT[Product Repository<br/>Interface: IProductRepository]
        DAL_ORDER[Order Repository<br/>Interface: IOrderRepository]
    end
    
    FE_COMPONENTS --> FE_SERVICES
    FE_SERVICES --> BFF_AUTH
    FE_STORES --> FE_SERVICES
    
    BFF_AUTH --> API_AUTH
    BFF_RATE --> API_PRODUCTS
    BFF_AGGREGATE --> API_ORDERS
    
    API_AUTH --> BL_USER
    API_PRODUCTS --> BL_PRODUCT
    API_ORDERS --> BL_ORDER
    API_CART --> BL_PRODUCT
    
    BL_ORDER --> BL_PRICING
    BL_ORDER --> BL_INVENTORY
    BL_PRODUCT --> BL_PRICING
    
    BL_USER --> DAL_USER
    BL_PRODUCT --> DAL_PRODUCT
    BL_ORDER --> DAL_ORDER
    
    BL_ORDER --> INT_1C
    BL_ORDER --> INT_PAYMENT
    BL_ORDER --> INT_DELIVERY
    BL_INVENTORY --> INT_1C
```

### –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```mermaid
graph TB
    subgraph "Client Layer"
        WEB[Next.js App]
        MOBILE[Future Mobile App]
        ADMIN_CUSTOM[Custom Admin Dashboard]
        ADMIN_DJANGO[Django Admin Panel]
    end
    
    subgraph "API Gateway Layer (Nginx)"
        NGINX[Nginx + Load Balancer]
        SSL[SSL Termination]
        BASIC_RATE[Basic IP Rate Limiting]
        STATIC[Static Files Serving]
    end
    
    subgraph "BFF Layer (Next.js API)"
        AUTH_BFF[JWT Authentication]
        SMART_RATE[Smart Rate Limiting]
        RBAC[Role-Based Access Control]
        AGGREGATION[Data Aggregation]
    end
    
    subgraph "Application Layer"
        API[Django REST API]
        CELERY[Celery Workers]
        SCHEDULER[Celery Beat]
    end
    
    subgraph "Data Layer"
        PG[(PostgreSQL)]
        REDIS[(Redis Cache)]
        FILES[File Storage]
    end
    
    subgraph "External Integrations"
        ONEC[1C ERP System]
        YUKASSA[YuKassa Payment Gateway]
        DELIVERY[Delivery Services]
    end
    
    WEB --> NGINX
    MOBILE --> NGINX
    ADMIN_CUSTOM --> NGINX
    ADMIN_DJANGO --> NGINX
    
    NGINX --> SSL
    SSL --> BASIC_RATE
    BASIC_RATE --> STATIC
    STATIC --> AUTH_BFF
    
    AUTH_BFF --> SMART_RATE
    SMART_RATE --> RBAC
    RBAC --> AGGREGATION
    AGGREGATION --> API
    
    ADMIN_DJANGO --> API
    
    API --> PG
    API --> REDIS
    API --> FILES
    API --> CELERY
    
    CELERY --> ONEC
    CELERY --> YUKASSA
    CELERY --> DELIVERY
    
    SCHEDULER --> CELERY
```

### –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —Å–ª–æ—è–º

#### Nginx Gateway Layer:
- **SSL Termination**: Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- **–ë–∞–∑–æ–≤–æ–µ Rate Limiting**: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É —Å IP
- **Static Files**: –†–∞–∑–¥–∞—á–∞ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ –∏ —Å—Ç–∞—Ç–∏–∫–∏
- **Load Balancing**: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ Django
- **DDoS Protection**: –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

#### Next.js BFF Layer:
- **JWT Authentication**: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ refresh logic
- **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ Rate Limiting**: 
  - 5 –ø–æ–ø—ã—Ç–æ–∫ –ª–æ–≥–∏–Ω–∞/–º–∏–Ω—É—Ç—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - 10 –∑–∞–∫–∞–∑–æ–≤/–¥–µ–Ω—å –¥–ª—è —Ä–æ–∑–Ω–∏—á–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  - –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Role-Based Access Control**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- **Data Aggregation**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö API endpoints
- **Request/Response —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è**: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ frontend –Ω—É–∂–¥—ã

#### Django API Layer:
- **Business Logic**: –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Data Management**: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
- **External Integrations**: 1C, –ø–ª–∞—Ç–µ–∂–∏, –¥–æ—Å—Ç–∞–≤–∫–∞
- **Admin Interface**: Django Admin –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    ADMIN STRATEGY                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    Django Admin     ‚îÇ      Next.js Custom Admin        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ CRUD —Ç–æ–≤–∞—Ä—ã       ‚îÇ ‚Ä¢ –î–∞—à–±–æ—Ä–¥—ã –ø—Ä–æ–¥–∞–∂                ‚îÇ
‚îÇ ‚Ä¢ CRUD –∫–∞—Ç–µ–≥–æ—Ä–∏–∏    ‚îÇ ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤              ‚îÇ
‚îÇ ‚Ä¢ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤ ‚îÇ ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏/–∞–∫—Ü–∏—è–º–∏       ‚îÇ
‚îÇ ‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —é–∑–µ—Ä–∞–º–∏‚îÇ ‚Ä¢ –û—Ç—á–µ—Ç—ã –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è           ‚îÇ
‚îÇ ‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã–µ         ‚îÇ ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π           ‚îÇ
‚îÇ   –Ω–∞—Å—Ç—Ä–æ–π–∫–∏         ‚îÇ ‚Ä¢ UX-–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞  ‚îÇ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π UX                   ‚îÇ
‚îÇ –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã  ‚îÇ –ö–∞—Å—Ç–æ–º–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è:**
- Django Admin –¥–ª—è —Ä—É—Ç–∏–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è
- Custom Admin –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ UX –∏ —Å–ª–æ–∂–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ï–¥–∏–Ω–æ–µ API, —Ä–∞–∑–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

### –ú–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

**1–° Integration Resilience:**
- **Circuit Breaker Pattern**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Ñ–∞–π–ª–æ–≤—ã–π –æ–±–º–µ–Ω
- **File-based Fallback**: –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ XML/JSON –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **Retry Logic**: –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

**Payment Gateway Resilience:**
- **Webhook Validation**: –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø–æ–¥–ø–∏—Å—å YuKassa
- **Idempotency Keys**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- **Status Reconciliation**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤

**Database Resilience:**
- **Connection Pooling**: pgBouncer –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- **Read Replicas**: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤
- **Backup Strategy**: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –±—ç–∫–∞–ø—ã + WAL

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- Django API servers (stateless)
- Celery workers (–ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á)  
- Read-only replicas PostgreSQL
- Redis Cluster –¥–ª—è —Å–µ—Å—Å–∏–π –∏ –∫—ç—à–∞

**–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- CPU –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- RAM –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
- Storage –¥–ª—è –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤

---

## 7. –í–Ω–µ—à–Ω–∏–µ API

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–° ERP

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å Circuit Breaker Pattern

```mermaid
sequenceDiagram
    participant Django as Django API
    participant Celery as Celery Worker
    participant CB as Circuit Breaker
    participant OneCHTTP as 1C HTTP Service
    participant OneFTP as 1C FTP/File
    participant DB as PostgreSQL

    Django->>Celery: Sync Orders Task
    Celery->>CB: Check 1C Availability
    
    alt Circuit Open (1C Available)
        CB->>OneCHTTP: POST /orders
        OneCHTTP-->>CB: Order Created
        CB-->>Celery: Success Response
        Celery->>DB: Update Order Status
    else Circuit Closed (1C Unavailable)
        CB->>OneFTP: Export XML File
        OneFTP-->>CB: File Saved
        CB-->>Celery: Fallback Success
        Celery->>DB: Mark for Manual Processing
    end
```

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é

```python
# apps/integrations/onec/client.py
import requests
from circuit_breaker import CircuitBreaker
from datetime import datetime
import xml.etree.ElementTree as ET

class OneCIntegrationService:
    def __init__(self):
        self.circuit_breaker = CircuitBreaker(
            failure_threshold=5,
            recovery_timeout=300,  # 5 minutes
            expected_exception=requests.RequestException
        )
        self.base_url = settings.ONEC_API_URL
        self.credentials = (settings.ONEC_USERNAME, settings.ONEC_PASSWORD)
        self.fallback_path = settings.ONEC_FALLBACK_PATH
    
    @circuit_breaker
    def export_order(self, order: Order) -> dict:
        """Export order to 1C via HTTP API"""
        payload = self._prepare_order_payload(order)
        
        response = requests.post(
            f"{self.base_url}/orders/",
            json=payload,
            auth=self.credentials,
            timeout=30,
            headers={'Content-Type': 'application/json'}
        )
        response.raise_for_status()
        
        result = response.json()
        
        # Update order with 1C reference
        order.onec_id = result['id']
        order.save(update_fields=['onec_id'])
        
        return result
    
    def export_order_fallback(self, order: Order) -> str:
        """Fallback: Export order to XML file"""
        xml_content = self._generate_order_xml(order)
        filename = f"order_{order.order_number}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xml"
        filepath = os.path.join(self.fallback_path, filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(xml_content)
        
        # Mark order for manual processing
        order.notes = f"Exported to file: {filename} (1C API unavailable)"
        order.save(update_fields=['notes'])
        
        return filepath
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Æ–ö–∞—Å—Å–∞

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é

```python
# apps/payments/yukassa.py
import hashlib
import hmac
from yookassa import Configuration, Payment, Webhook

class YuKassaService:
    def __init__(self):
        Configuration.account_id = settings.YUKASSA_ACCOUNT_ID
        Configuration.secret_key = settings.YUKASSA_SECRET_KEY
        self.webhook_secret = settings.YUKASSA_WEBHOOK_SECRET
    
    def create_payment(self, order: Order) -> dict:
        """Create payment in YuKassa"""
        idempotency_key = self._generate_idempotency_key(order)
        
        payment_data = {
            "amount": {
                "value": str(order.total_amount),
                "currency": "RUB"
            },
            "confirmation": {
                "type": "redirect",
                "return_url": f"{settings.FRONTEND_URL}/orders/{order.id}/success"
            },
            "capture": True,
            "description": f"–ó–∞–∫–∞–∑ ‚Ññ{order.order_number}",
            "metadata": {
                "order_id": str(order.id),
                "order_number": order.order_number
            }
        }
        
        payment = Payment.create(payment_data, idempotency_key)
        
        # Update order with payment info
        order.payment_id = payment.id
        order.payment_status = 'pending'
        order.save(update_fields=['payment_id', 'payment_status'])
        
        return {
            'payment_id': payment.id,
            'confirmation_url': payment.confirmation.confirmation_url,
            'status': payment.status
        }
    
    def process_webhook(self, request_body: str, signature: str) -> bool:
        """Process YuKassa webhook with signature validation"""
        # Validate webhook signature
        if not self._validate_signature(request_body, signature):
            raise ValueError("Invalid webhook signature")
        
        webhook_data = json.loads(request_body)
        payment_id = webhook_data['object']['id']
        
        # Process payment update
        try:
            order = Order.objects.get(payment_id=payment_id)
            self._update_order_from_payment(order, webhook_data)
            return True
        except Order.DoesNotExist:
            logger.error(f"Order not found for payment_id: {payment_id}")
            return False
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–ª—É–∂–± –¥–æ—Å—Ç–∞–≤–∫–∏

#### CDEK API Integration

```python
# apps/integrations/delivery/services.py
class CDEKService:
    def __init__(self):
        self.base_url = 'https://api.cdek.ru/v2/'
        self.client_id = settings.CDEK_CLIENT_ID
        self.client_secret = settings.CDEK_CLIENT_SECRET
        self.access_token = None
    
    def calculate_delivery_cost(self, order_data: dict) -> dict:
        """Calculate delivery cost and time"""
        self._ensure_token()
        
        payload = {
            "type": 1,  # Delivery to door
            "from_location": {"code": order_data['warehouse_city_code']},
            "to_location": {"code": order_data['delivery_city_code']},
            "packages": [{
                "weight": order_data['total_weight'],
                "length": order_data['package_length'],
                "width": order_data['package_width'],
                "height": order_data['package_height']
            }]
        }
        
        response = requests.post(
            f"{self.base_url}calculator/tariff",
            json=payload,
            headers={"Authorization": f"Bearer {self.access_token}"}
        )
        
        return response.json()
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API

#### Circuit Breaker Configuration

```python
# settings/base.py
CIRCUIT_BREAKER_SETTINGS = {
    'ONEC_INTEGRATION': {
        'failure_threshold': 5,
        'recovery_timeout': 300,  # 5 minutes
        'monitor_requests': True
    },
    'YUKASSA_PAYMENTS': {
        'failure_threshold': 3,
        'recovery_timeout': 180,  # 3 minutes
        'monitor_requests': True
    },
    'DELIVERY_SERVICES': {
        'failure_threshold': 5,
        'recovery_timeout': 600,  # 10 minutes
        'monitor_requests': False  # Not critical for order processing
    }
}
```

#### Retry Logic with Exponential Backoff

```python
# core/utils.py
import time
import random
from functools import wraps

def retry_with_backoff(retries=3, backoff_in_seconds=1):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(retries):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == retries - 1:
                        raise e
                    
                    # Exponential backoff with jitter
                    wait_time = backoff_in_seconds * (2 ** attempt) + random.uniform(0, 1)
                    time.sleep(wait_time)
                    
            return func(*args, **kwargs)
        return wrapper
    return decorator
```

---

## 8. –û—Å–Ω–æ–≤–Ω—ã–µ –†–∞–±–æ—á–∏–µ –ü—Ä–æ—Ü–µ—Å—Å—ã

### –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```mermaid
flowchart TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É] --> B{–¢–∏–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏}
    B -->|B2C| C[–í–∞–ª–∏–¥–∞—Ü–∏—è email]
    B -->|B2B| D[–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ + –¥–æ–∫—É–º–µ–Ω—Ç—ã]
    
    C --> E[–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è]
    D --> F[–†—É—á–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è –∞–¥–º–∏–Ω–æ–º]
    
    E --> G[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥]
    F --> H{–û–¥–æ–±—Ä–µ–Ω–æ?}
    
    G --> I{–ö–æ–¥ –≤–µ—Ä–Ω—ã–π?}
    H -->|–î–∞| J[–ê–∫—Ç–∏–≤–∞—Ü–∏—è B2B –∞–∫–∫–∞—É–Ω—Ç–∞]
    H -->|–ù–µ—Ç| K[–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º]
    
    I -->|–î–∞| L[–ê–∫—Ç–∏–≤–∞—Ü–∏—è B2C –∞–∫–∫–∞—É–Ω—Ç–∞]
    I -->|–ù–µ—Ç| M[–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞]
    
    J --> N[–î–æ—Å—Ç—É–ø –∫ B2B —Ü–µ–Ω–∞–º]
    L --> O[–î–æ—Å—Ç—É–ø –∫ —Ä–æ–∑–Ω–∏—á–Ω—ã–º —Ü–µ–Ω–∞–º]
    K --> P[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é]
    M --> G
```

### –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞

```mermaid
sequenceDiagram
    participant User as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    participant Frontend as Next.js Frontend
    participant BFF as Next.js API (BFF)
    participant Django as Django API
    participant YuKassa as –Æ–ö–∞—Å—Å–∞
    participant Celery as Celery Worker
    participant OneC as 1C ERP

    User->>Frontend: –ù–∞–∂–∏–º–∞–µ—Ç "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
    Frontend->>BFF: POST /api/orders
    BFF->>Django: POST /orders/
    
    Django->>Django: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    Django->>Django: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
    Django->>Django: –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –ø–æ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Django->>YuKassa: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    YuKassa-->>Django: –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
    
    Django-->>BFF: –ó–∞–∫–∞–∑ + —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
    BFF-->>Frontend: –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
    Frontend-->>User: –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É
    
    User->>YuKassa: –û–ø–ª–∞—á–∏–≤–∞–µ—Ç –∑–∞–∫–∞–∑
    YuKassa->>Django: Webhook –æ —Å—Ç–∞—Ç—É—Å–µ –æ–ø–ª–∞—Ç—ã
    
    Django->>Celery: –ó–∞–¥–∞—á–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ 1–°
    Celery->>OneC: –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–∞
    OneC-->>Celery: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    Celery->>Django: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
```

### –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å 1–°

```mermaid
flowchart TD
    A[Celery Beat Scheduler] --> B[–ó–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏]
    B --> C{–ü—Ä–æ–≤–µ—Ä–∫–∞ Circuit Breaker}
    
    C -->|Open| D[HTTP –∑–∞–ø—Ä–æ—Å –∫ 1–°]
    C -->|Closed| E[–§–∞–π–ª–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç]
    
    D --> F{1–° –¥–æ—Å—Ç—É–ø–Ω–∞?}
    F -->|–î–∞| G[–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤]
    F -->|–ù–µ—Ç| H[Circuit Breaker -> Closed]
    
    G --> I[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤]
    I --> J[–≠–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤]
    J --> K[–ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤]
    
    E --> L[–°–æ–∑–¥–∞–Ω–∏–µ XML —Ñ–∞–π–ª–æ–≤]
    L --> M[–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ FTP –ø–∞–ø–∫—É]
    M --> N[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞]
    
    H --> O[–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ñ–∞–π–ª–æ–≤–æ–º—É –æ–±–º–µ–Ω—É]
    O --> L
    
    K --> P[–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏]
    N --> P
```

### Workflow —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ü–µ–Ω–∞–º–∏

```mermaid
stateDiagram-v2
    [*] --> PriceUpdate
    
    PriceUpdate --> B2CValidation: –†–æ–∑–Ω–∏—á–Ω–∞—è —Ü–µ–Ω–∞
    PriceUpdate --> B2BValidation: –û–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã
    
    B2CValidation --> PriceApproval: –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
    B2BValidation --> PriceApproval: –í–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
    
    PriceApproval --> AutoApproval: –ò–∑–º–µ–Ω–µ–Ω–∏–µ < 10%
    PriceApproval --> ManualApproval: –ò–∑–º–µ–Ω–µ–Ω–∏–µ > 10%
    
    AutoApproval --> PriceActivation
    ManualApproval --> AdminReview
    
    AdminReview --> PriceActivation: –û–¥–æ–±—Ä–µ–Ω–æ
    AdminReview --> PriceRejection: –û—Ç–∫–ª–æ–Ω–µ–Ω–æ
    
    PriceActivation --> CacheInvalidation
    CacheInvalidation --> PriceNotification
    
    PriceNotification --> [*]
    PriceRejection --> [*]
```

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤

```mermaid
flowchart TD
    A[–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∞–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç] --> B[–°–æ–∑–¥–∞–Ω–∏–µ Return Request]
    B --> C{–£—Å–ª–æ–≤–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞?}
    
    C -->|–í –ø—Ä–µ–¥–µ–ª–∞—Ö 14 –¥–Ω–µ–π| D[–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ]
    C -->|–í–Ω–µ —Å—Ä–æ–∫–∞| E[–†—É—á–Ω–æ–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ]
    C -->|–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä| F[–ó–∞–ø—Ä–æ—Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π]
    
    D --> G[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —ç—Ç–∏–∫–µ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞]
    E --> H{–†–µ—à–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞}
    F --> I[–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π]
    
    H -->|–û–¥–æ–±—Ä–µ–Ω–æ| G
    H -->|–û—Ç–∫–ª–æ–Ω–µ–Ω–æ| J[–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ]
    I -->|–û–¥–æ–±—Ä–µ–Ω–æ| G
    I -->|–û—Ç–∫–ª–æ–Ω–µ–Ω–æ| J
    
    G --> K[–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥]
    K --> L[–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞]
    L --> M{–¢–æ–≤–∞—Ä –≤ –ø–æ—Ä—è–¥–∫–µ?}
    
    M -->|–î–∞| N[–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤]
    M -->|–ù–µ—Ç| O[–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç]
    
    N --> P[–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ 1–°]
    O --> P
    J --> Q[–ó–∞–∫—Ä—ã—Ç–∏–µ –∑–∞—è–≤–∫–∏]
    P --> Q
```

---

## 9. –°—Ö–µ–º–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

### –î–∏–∑–∞–π–Ω –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö PostgreSQL

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

```sql
-- Users and Authentication
CREATE TABLE users_user (
    id SERIAL PRIMARY KEY,
    email VARCHAR(254) UNIQUE NOT NULL,
    first_name VARCHAR(150),
    last_name VARCHAR(150),
    phone VARCHAR(20),
    role VARCHAR(20) DEFAULT 'retail',
    company_name VARCHAR(200),
    tax_id VARCHAR(50),
    is_active BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT FALSE,
    verification_token VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users_user(email);
CREATE INDEX idx_users_role ON users_user(role);
CREATE INDEX idx_users_company ON users_user(company_name) WHERE company_name IS NOT NULL;

-- Brands
CREATE TABLE products_brand (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    logo VARCHAR(255),
    description TEXT,
    website VARCHAR(200),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Categories with hierarchical structure
CREATE TABLE products_category (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    parent_id INTEGER REFERENCES products_category(id),
    description TEXT,
    image VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    sort_order INTEGER DEFAULT 0,
    seo_title VARCHAR(200),
    seo_description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Products table with partitioning by brand_id
CREATE TABLE products_product (
    id SERIAL PRIMARY KEY,
    name VARCHAR(300) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    brand_id INTEGER NOT NULL REFERENCES products_brand(id),
    category_id INTEGER NOT NULL REFERENCES products_category(id),
    description TEXT,
    short_description VARCHAR(500),
    
    -- Multi-tier pricing structure
    retail_price DECIMAL(10,2) NOT NULL,
    opt1_price DECIMAL(10,2),
    opt2_price DECIMAL(10,2), 
    opt3_price DECIMAL(10,2),
    trainer_price DECIMAL(10,2),
    federation_price DECIMAL(10,2),
    
    -- RRP/MSRP –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
    recommended_retail_price DECIMAL(10,2),
    max_suggested_retail_price DECIMAL(10,2),
    
    -- Inventory
    sku VARCHAR(100) UNIQUE NOT NULL,
    stock_quantity INTEGER DEFAULT 0,
    min_order_quantity INTEGER DEFAULT 1,
    
    -- Images stored as JSONB for flexibility
    main_image VARCHAR(255),
    gallery_images JSONB DEFAULT '[]',
    
    -- SEO & Search
    seo_title VARCHAR(200),
    seo_description TEXT,
    search_vector TSVECTOR, -- Full-text search
    
    -- Status flags
    is_active BOOLEAN DEFAULT TRUE,
    is_featured BOOLEAN DEFAULT FALSE,
    
    -- Integration & Timestamps
    onec_id VARCHAR(100),
    last_sync_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT chk_positive_prices CHECK (
        retail_price > 0 AND
        (opt1_price IS NULL OR opt1_price > 0) AND
        (opt2_price IS NULL OR opt2_price > 0) AND
        (opt3_price IS NULL OR opt3_price > 0) AND
        (trainer_price IS NULL OR trainer_price > 0) AND
        (federation_price IS NULL OR federation_price > 0)
    ),
    CONSTRAINT chk_stock_non_negative CHECK (stock_quantity >= 0)
) PARTITION BY HASH (brand_id);

-- Orders with time-based partitioning
CREATE TABLE orders_order (
    id SERIAL,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    user_id INTEGER REFERENCES users_user(id),
    
    -- Customer info for guest orders
    customer_name VARCHAR(200),
    customer_email VARCHAR(254),
    customer_phone VARCHAR(20),
    
    -- Order details
    status VARCHAR(50) DEFAULT 'pending',
    total_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    delivery_cost DECIMAL(10,2) DEFAULT 0,
    
    -- Delivery
    delivery_address TEXT NOT NULL,
    delivery_method VARCHAR(50),
    delivery_date DATE,
    
    -- Payment
    payment_method VARCHAR(50),
    payment_status VARCHAR(50) DEFAULT 'pending',
    payment_id VARCHAR(100),
    
    -- B2B specific
    company_name VARCHAR(200),
    tax_id VARCHAR(50),
    purchase_order_number VARCHAR(100),
    
    -- Integration & audit
    onec_id VARCHAR(100),
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (created_at);

-- Order Items —Å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–º FOREIGN KEY –¥–ª—è —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
CREATE TABLE orders_orderitem (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL,
    order_created_at TIMESTAMP WITH TIME ZONE NOT NULL, -- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è FOREIGN KEY
    product_id INTEGER NOT NULL REFERENCES products_product(id),
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    
    -- Snapshot of product data at time of order
    product_name VARCHAR(300) NOT NULL,
    product_sku VARCHAR(100) NOT NULL,
    
    -- –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π FOREIGN KEY –≤–∫–ª—é—á–∞—é—â–∏–π partition key
    FOREIGN KEY (order_id, order_created_at) REFERENCES orders_order(id, created_at) ON DELETE CASCADE,
    
    CONSTRAINT chk_positive_quantity CHECK (quantity > 0),
    CONSTRAINT chk_positive_prices CHECK (unit_price > 0 AND total_price > 0)
);

-- Shopping Cart
CREATE TABLE cart_cart (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE REFERENCES users_user(id),
    session_key VARCHAR(100),  -- For guest users
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE cart_cartitem (
    id SERIAL PRIMARY KEY,
    cart_id INTEGER NOT NULL REFERENCES cart_cart(id) ON DELETE CASCADE,
    product_id INTEGER NOT NULL REFERENCES products_product(id),
    quantity INTEGER NOT NULL DEFAULT 1,
    added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(cart_id, product_id),
    CONSTRAINT chk_positive_quantity CHECK (quantity > 0)
);
```

#### –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```sql
-- Product search and filtering indexes
CREATE INDEX idx_products_brand ON products_product(brand_id);
CREATE INDEX idx_products_category ON products_product(category_id);
CREATE INDEX idx_products_active ON products_product(is_active) WHERE is_active = true;
CREATE INDEX idx_products_featured ON products_product(is_featured) WHERE is_featured = true;
CREATE INDEX idx_products_stock ON products_product(stock_quantity) WHERE stock_quantity > 0;
CREATE INDEX idx_products_price_retail ON products_product(retail_price);
CREATE INDEX idx_products_search ON products_product USING gin(search_vector);
CREATE INDEX idx_products_onec ON products_product(onec_id) WHERE onec_id IS NOT NULL;

-- Order indexes
CREATE INDEX idx_orders_user ON orders_order(user_id);
CREATE INDEX idx_orders_status ON orders_order(status);
CREATE INDEX idx_orders_payment ON orders_order(payment_id) WHERE payment_id IS NOT NULL;
CREATE INDEX idx_orders_created ON orders_order(created_at);
CREATE INDEX idx_orders_onec ON orders_order(onec_id) WHERE onec_id IS NOT NULL;

-- Order items indexes (–≤–∫–ª—é—á–∞—è order_created_at –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ JOIN)
CREATE INDEX idx_orderitems_order_composite ON orders_orderitem(order_id, order_created_at);
CREATE INDEX idx_orderitems_product ON orders_orderitem(product_id);

-- Cart indexes
CREATE INDEX idx_cart_user ON cart_cart(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_cart_session ON cart_cart(session_key) WHERE session_key IS NOT NULL;
CREATE INDEX idx_cartitems_cart ON cart_cartitem(cart_id);
CREATE INDEX idx_cartitems_product ON cart_cartitem(product_id);

-- Category hierarchy indexes
CREATE INDEX idx_categories_parent ON products_category(parent_id) WHERE parent_id IS NOT NULL;
CREATE INDEX idx_categories_active ON products_category(is_active) WHERE is_active = true;
```

#### –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

```sql
-- Full-Text Search Configuration
CREATE TEXT SEARCH CONFIGURATION russian_products (COPY = russian);

-- Update search vector trigger
CREATE OR REPLACE FUNCTION update_product_search_vector() 
RETURNS TRIGGER AS $$
BEGIN
    NEW.search_vector := 
        setweight(to_tsvector('russian_products', COALESCE(NEW.name, '')), 'A') ||
        setweight(to_tsvector('russian_products', COALESCE(NEW.description, '')), 'B') ||
        setweight(to_tsvector('russian_products', COALESCE(NEW.short_description, '')), 'C');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_product_search
    BEFORE INSERT OR UPDATE ON products_product
    FOR EACH ROW EXECUTE FUNCTION update_product_search_vector();
```

#### –°–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏

```sql
-- Create partitions for products table (by brand hash)
CREATE TABLE products_product_0 PARTITION OF products_product
    FOR VALUES WITH (modulus 4, remainder 0);
CREATE TABLE products_product_1 PARTITION OF products_product
    FOR VALUES WITH (modulus 4, remainder 1);
CREATE TABLE products_product_2 PARTITION OF products_product
    FOR VALUES WITH (modulus 4, remainder 2);
CREATE TABLE products_product_3 PARTITION OF products_product
    FOR VALUES WITH (modulus 4, remainder 3);

-- Create partitions for orders table (by month)
CREATE TABLE orders_order_2024_01 PARTITION OF orders_order
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE orders_order_2024_02 PARTITION OF orders_order
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
-- ... continue for other months

-- Automatic partition creation function
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
    start_date DATE;
    end_date DATE;
    partition_name TEXT;
BEGIN
    start_date := date_trunc('month', NOW());
    end_date := start_date + INTERVAL '1 month';
    partition_name := 'orders_order_' || to_char(start_date, 'YYYY_MM');
    
    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF orders_order
                    FOR VALUES FROM (%L) TO (%L)',
                   partition_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;
```

#### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –§–ó-152 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

```sql
-- Personal data audit log (–§–ó-152 compliance)
CREATE TABLE compliance_personaldatalog (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users_user(id) ON DELETE SET NULL,
    action VARCHAR(100) NOT NULL,
    data_type VARCHAR(100) NOT NULL,
    processed_data JSONB,
    purpose VARCHAR(200),
    legal_basis VARCHAR(200),
    ip_address INET,
    user_agent TEXT,
    processed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    CONSTRAINT chk_required_fields CHECK (
        action IS NOT NULL AND 
        data_type IS NOT NULL AND
        processed_at IS NOT NULL
    )
);

-- Consent management for GDPR/–§–ó-152
CREATE TABLE compliance_consent (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users_user(id) ON DELETE CASCADE,
    consent_type VARCHAR(100) NOT NULL,
    is_given BOOLEAN NOT NULL DEFAULT false,
    given_at TIMESTAMP WITH TIME ZONE,
    withdrawn_at TIMESTAMP WITH TIME ZONE,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(user_id, consent_type)
);

-- Sync logs for 1C integration monitoring
CREATE TABLE integrations_synclog (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL,
    records_processed INTEGER DEFAULT 0,
    errors_count INTEGER DEFAULT 0,
    error_details JSONB DEFAULT '[]',
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    
    CONSTRAINT chk_status CHECK (status IN ('started', 'completed', 'failed'))
);

CREATE INDEX idx_synclog_type_status ON integrations_synclog(sync_type, status);
CREATE INDEX idx_synclog_started ON integrations_synclog(started_at);
```

#### –•—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

```sql
-- Function to get price by user role
CREATE OR REPLACE FUNCTION get_user_price(
    p_product_id INTEGER,
    p_user_role VARCHAR(20)
) RETURNS DECIMAL(10,2) AS $$
DECLARE
    product_record RECORD;
    result_price DECIMAL(10,2);
BEGIN
    SELECT * INTO product_record 
    FROM products_product 
    WHERE id = p_product_id AND is_active = true;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Product not found or inactive: %', p_product_id;
    END IF;
    
    result_price := CASE p_user_role
        WHEN 'retail' THEN product_record.retail_price
        WHEN 'wholesale_level1' THEN COALESCE(product_record.opt1_price, product_record.retail_price)
        WHEN 'wholesale_level2' THEN COALESCE(product_record.opt2_price, product_record.retail_price)
        WHEN 'wholesale_level3' THEN COALESCE(product_record.opt3_price, product_record.retail_price)
        WHEN 'trainer' THEN COALESCE(product_record.trainer_price, product_record.retail_price)
        WHEN 'federation_rep' THEN COALESCE(product_record.federation_price, product_record.retail_price)
        ELSE product_record.retail_price
    END;
    
    RETURN result_price;
END;
$$ LANGUAGE plpgsql STABLE;

-- Function to calculate order total with user-specific pricing
CREATE OR REPLACE FUNCTION calculate_order_total(
    p_user_id INTEGER,
    p_cart_items JSONB
) RETURNS DECIMAL(10,2) AS $$
DECLARE
    user_role VARCHAR(20);
    item JSONB;
    total_amount DECIMAL(10,2) := 0;
    item_price DECIMAL(10,2);
BEGIN
    -- Get user role
    SELECT role INTO user_role FROM users_user WHERE id = p_user_id;
    
    -- Calculate total for each item
    FOR item IN SELECT * FROM jsonb_array_elements(p_cart_items)
    LOOP
        item_price := get_user_price(
            (item->>'product_id')::INTEGER,
            user_role
        );
        
        total_amount := total_amount + (item_price * (item->>'quantity')::INTEGER);
    END LOOP;
    
    RETURN total_amount;
END;
$$ LANGUAGE plpgsql STABLE;
```

#### –í–∞–∂–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

**1. –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π FOREIGN KEY –¥–ª—è —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:**
- `orders_orderitem` –≤–∫–ª—é—á–∞–µ—Ç `order_created_at` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å —Å–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π `orders_order`
- –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç referential integrity –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**2. –°–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- `products_product` - –ø–æ hash –æ—Ç `brand_id` –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- `orders_order` - –ø–æ range –æ—Ç `created_at` –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è

**3. –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:**
- Multi-tier pricing —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- RRP/MSRP –ø–æ–ª—è –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ FR5)

**4. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –§–ó-152:**
- Audit log —Å `ON DELETE SET NULL` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏—Ç–∞
- –°–∏—Å—Ç–µ–º–∞ —Å–æ–≥–ª–∞—Å–∏–π (consent management)

---

## 10. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –ü–∏—Ä–∞–º–∏–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```
                  E2E Tests
                 /        \
            Integration Tests
               /            \
          Frontend Unit  Backend Unit
```

**Testing Philosophy:** –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è FREESPORT –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –ø–∏—Ä–∞–º–∏–¥–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É–ø–æ—Ä–æ–º –Ω–∞ –±—ã—Å—Ç—Ä—ã–µ unit-—Ç–µ—Å—Ç—ã –≤ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ E2E —Ç–µ—Å—Ç—ã –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ.

### –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤

#### Frontend Tests

```
frontend/
‚îú‚îÄ‚îÄ __tests__/                     # Jest unit tests
‚îÇ   ‚îú‚îÄ‚îÄ components/               # Component tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductCard.test.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Cart.test.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserProfile.test.tsx
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                    # Custom hooks tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useAuth.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useCart.test.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useProducts.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/                 # API service tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ authService.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ productService.test.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ orderService.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils/                    # Utility function tests
‚îÇ       ‚îú‚îÄ‚îÄ formatPrice.test.ts
‚îÇ       ‚îú‚îÄ‚îÄ validation.test.ts
‚îÇ       ‚îî‚îÄ‚îÄ api-client.test.ts
‚îú‚îÄ‚îÄ __mocks__/                    # Mock implementations
‚îÇ   ‚îú‚îÄ‚îÄ api-responses/
‚îÇ   ‚îî‚îÄ‚îÄ localStorage.js
‚îî‚îÄ‚îÄ jest.config.js                # Jest configuration
```

**Frontend Testing Stack:**
- **Jest**: Unit testing framework
- **React Testing Library**: Component testing
- **MSW (Mock Service Worker)**: API mocking
- **Jest Environment**: jsdom –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π —Å—Ä–µ–¥—ã

#### Backend Tests

```
backend/
‚îú‚îÄ‚îÄ tests/                        # Django tests
‚îÇ   ‚îú‚îÄ‚îÄ unit/                     # Unit tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/              # Model tests
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_user.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_product.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_order.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serializers/         # Serializer tests
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_user_serializers.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_product_serializers.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/            # Business logic tests
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ test_auth_service.py
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ test_cart_service.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ test_order_service.py
‚îÇ   ‚îú‚îÄ‚îÄ integration/              # Integration tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_api_endpoints.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_1c_integration.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_yukassa_integration.py
‚îÇ   ‚îî‚îÄ‚îÄ fixtures/                 # Test data fixtures
‚îÇ       ‚îú‚îÄ‚îÄ products.json
‚îÇ       ‚îú‚îÄ‚îÄ users.json
‚îÇ       ‚îî‚îÄ‚îÄ orders.json
‚îú‚îÄ‚îÄ conftest.py                   # pytest configuration
‚îî‚îÄ‚îÄ pytest.ini                   # pytest settings
```

**Backend Testing Stack:**
- **pytest**: Primary testing framework
- **pytest-django**: Django integration
- **Factory Boy**: Test data generation
- **pytest-mock**: Mocking utilities
- **Django Test Database**: Isolated test database

#### E2E Tests

```
e2e/
‚îú‚îÄ‚îÄ tests/                        # Playwright E2E tests
‚îÇ   ‚îú‚îÄ‚îÄ auth/                     # Authentication flows
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ b2b-registration.spec.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ b2c-login.spec.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ password-recovery.spec.ts
‚îÇ   ‚îú‚îÄ‚îÄ catalog/                  # Product catalog tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product-search.spec.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product-filtering.spec.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ product-details.spec.ts
‚îÇ   ‚îú‚îÄ‚îÄ checkout/                 # Order placement tests
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ b2b-checkout.spec.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ b2c-checkout.spec.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payment-flow.spec.ts
‚îÇ   ‚îî‚îÄ‚îÄ admin/                    # Admin panel tests
‚îÇ       ‚îú‚îÄ‚îÄ order-management.spec.ts
‚îÇ       ‚îî‚îÄ‚îÄ user-management.spec.ts
‚îú‚îÄ‚îÄ fixtures/                     # Test data
‚îú‚îÄ‚îÄ page-objects/                 # Page Object Pattern
‚îÇ   ‚îú‚îÄ‚îÄ HomePage.ts
‚îÇ   ‚îú‚îÄ‚îÄ ProductPage.ts
‚îÇ   ‚îî‚îÄ‚îÄ CheckoutPage.ts
‚îú‚îÄ‚îÄ utils/                        # Test utilities
‚îî‚îÄ‚îÄ playwright.config.ts          # Playwright configuration
```

**E2E Testing Stack:**
- **Playwright**: Primary E2E framework
- **TypeScript**: Type-safe test scripts
- **Page Object Model**: Maintainable test structure
- **Multiple Browsers**: Chrome, Firefox, Safari testing

### –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤

#### Frontend Component Test —Å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ —Ä–æ–ª—è–º

```typescript
// ProductCard.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { ProductCard } from '../ProductCard';
import { CartProvider } from '../../contexts/CartContext';

const mockProduct = {
  id: 1,
  name: 'Test Product',
  retail_price: 1200,
  opt1_price: 1000,
  trainer_price: 950,
  recommended_retail_price: 1300, // RRP –¥–ª—è B2B
  max_suggested_retail_price: 1400, // MSRP –¥–ª—è B2B
  main_image: '/test-image.jpg',
  stock_quantity: 50
};

describe('ProductCard', () => {
  it('displays retail pricing for B2C users', () => {
    render(
      <CartProvider>
        <ProductCard product={mockProduct} userRole="retail" />
      </CartProvider>
    );

    expect(screen.getByText('1 200 ‚ÇΩ')).toBeInTheDocument();
    expect(screen.queryByText('–†–†–¶:')).not.toBeInTheDocument(); // RRP –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è B2C
    expect(screen.queryByText('–ú–∞–∫—Å. —Ü–µ–Ω–∞:')).not.toBeInTheDocument(); // MSRP –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è B2C
  });

  it('displays wholesale pricing and RRP/MSRP for B2B users', () => {
    render(
      <CartProvider>
        <ProductCard product={mockProduct} userRole="wholesale_level1" showRRP={true} showMSRP={true} />
      </CartProvider>
    );

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–ø—Ç–æ–≤—É—é —Ü–µ–Ω—É –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω—É—é
    expect(screen.getByText('1 000 ‚ÇΩ')).toBeInTheDocument();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç RRP –∏ MSRP –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
    expect(screen.getByText('–†–†–¶: 1 300 ‚ÇΩ')).toBeInTheDocument();
    expect(screen.getByText('–ú–∞–∫—Å. —Ü–µ–Ω–∞: 1 400 ‚ÇΩ')).toBeInTheDocument();
  });

  it('displays trainer pricing for trainers', () => {
    render(
      <CartProvider>
        <ProductCard product={mockProduct} userRole="trainer" />
      </CartProvider>
    );

    expect(screen.getByText('950 ‚ÇΩ')).toBeInTheDocument();
    expect(screen.getByText('–¶–µ–Ω–∞ –¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–æ–≤')).toBeInTheDocument();
  });
});
```

#### Backend API Test —Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Ä–æ–ª–µ–≤–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è

```python
# test_api_endpoints.py
import pytest
from rest_framework.test import APIClient
from rest_framework import status
from django.contrib.auth import get_user_model
from apps.products.models import Product, Category, Brand

User = get_user_model()

@pytest.fixture
def api_client():
    return APIClient()

@pytest.fixture 
def sample_product(db):
    brand = Brand.objects.create(name='Test Brand', slug='test-brand')
    category = Category.objects.create(name='Test Category', slug='test-category')
    return Product.objects.create(
        name='Test Product',
        slug='test-product',
        brand=brand,
        category=category,
        retail_price=1200,
        opt1_price=1000,
        opt2_price=950,
        opt3_price=900,
        trainer_price=950,
        federation_price=800,
        # RRP/MSRP –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
        recommended_retail_price=1300,
        max_suggested_retail_price=1400,
        stock_quantity=100
    )

@pytest.fixture
def users(db):
    return {
        'retail': User.objects.create_user(
            email='retail@test.com', 
            password='test123', 
            role='retail',
            is_active=True
        ),
        'wholesale': User.objects.create_user(
            email='wholesale@test.com', 
            password='test123', 
            role='wholesale_level1',
            is_active=True,
            is_verified=True
        ),
        'trainer': User.objects.create_user(
            email='trainer@test.com', 
            password='test123', 
            role='trainer',
            is_active=True,
            is_verified=True
        ),
        'federation': User.objects.create_user(
            email='federation@test.com', 
            password='test123', 
            role='federation_rep',
            is_active=True,
            is_verified=True
        )
    }

class TestPricingByUserRole:
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø–æ —Ä–æ–ª—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    
    def test_retail_user_gets_retail_price(self, api_client, users, sample_product):
        """B2C –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ä–æ–∑–Ω–∏—á–Ω—É—é —Ü–µ–Ω—É –±–µ–∑ RRP/MSRP"""
        api_client.force_authenticate(user=users['retail'])
        response = api_client.get(f'/api/v1/products/{sample_product.id}/')
        
        assert response.status_code == status.HTTP_200_OK
        assert response.data['current_price'] == 1200  # retail_price
        assert response.data['price_type'] == 'retail'
        # RRP/MSRP –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–ª—è B2C –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
        assert response.data['recommended_retail_price'] is None
        assert response.data['max_suggested_retail_price'] is None

    def test_b2b_user_gets_wholesale_price_with_rrp_msrp(self, api_client, users, sample_product):
        """B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ–ø—Ç–æ–≤—É—é —Ü–µ–Ω—É + RRP/MSRP"""
        api_client.force_authenticate(user=users['wholesale'])
        response = api_client.get(f'/api/v1/products/{sample_product.id}/')
        
        assert response.status_code == status.HTTP_200_OK
        assert response.data['current_price'] == 1000  # opt1_price
        assert response.data['price_type'] == 'wholesale_level1'
        # RRP/MSRP –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
        assert response.data['recommended_retail_price'] == 1300
        assert response.data['max_suggested_retail_price'] == 1400

    def test_trainer_gets_trainer_price(self, api_client, users, sample_product):
        """–¢—Ä–µ–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –¥–ª—è —Ç—Ä–µ–Ω–µ—Ä–æ–≤"""
        api_client.force_authenticate(user=users['trainer'])
        response = api_client.get(f'/api/v1/products/{sample_product.id}/')
        
        assert response.status_code == status.HTTP_200_OK
        assert response.data['current_price'] == 950  # trainer_price
        assert response.data['price_type'] == 'trainer'
        # –¢—Ä–µ–Ω–µ—Ä—ã —Ç–æ–∂–µ B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –≤–∏–¥—è—Ç RRP/MSRP (FR5)
        assert response.data['recommended_retail_price'] == 1300
        assert response.data['max_suggested_retail_price'] == 1400

    def test_federation_gets_federation_price(self, api_client, users, sample_product):
        """–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ñ–µ–¥–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª—É—á–∞–µ—Ç —Å–∞–º—É—é –Ω–∏–∑–∫—É—é —Ü–µ–Ω—É"""
        api_client.force_authenticate(user=users['federation'])
        response = api_client.get(f'/api/v1/products/{sample_product.id}/')
        
        assert response.status_code == status.HTTP_200_OK
        assert response.data['current_price'] == 800  # federation_price
        assert response.data['price_type'] == 'federation'
        # –§–µ–¥–µ—Ä–∞–ª—ã —Ç–æ–∂–µ B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –≤–∏–¥—è—Ç RRP/MSRP (FR5) 
        assert response.data['recommended_retail_price'] == 1300
        assert response.data['max_suggested_retail_price'] == 1400

class TestOrderCreationWithPricing:
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º"""
    
    def test_b2c_order_uses_retail_pricing(self, api_client, users, sample_product):
        """B2C –∑–∞–∫–∞–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–æ–∑–Ω–∏—á–Ω–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"""
        api_client.force_authenticate(user=users['retail'])
        
        order_data = {
            'items': [{'product_id': sample_product.id, 'quantity': 2}],
            'delivery_address': 'Test Address',
            'payment_method': 'yukassa'
        }
        
        response = api_client.post('/api/v1/orders/', order_data, format='json')
        
        assert response.status_code == status.HTTP_201_CREATED
        assert response.data['total_amount'] == 2400  # 2 * 1200 (retail_price)
        
    def test_b2b_order_uses_wholesale_pricing(self, api_client, users, sample_product):
        """B2B –∑–∞–∫–∞–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–æ–≤–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"""
        api_client.force_authenticate(user=users['wholesale'])
        
        order_data = {
            'items': [{'product_id': sample_product.id, 'quantity': 10}],
            'delivery_address': 'Business Address',
            'payment_method': 'invoice',
            'company_name': 'Test Company LLC',
            'tax_id': '1234567890',
            'purchase_order_number': 'PO-2024-001'
        }
        
        response = api_client.post('/api/v1/orders/', order_data, format='json')
        
        assert response.status_code == status.HTTP_201_CREATED
        assert response.data['total_amount'] == 10000  # 10 * 1000 (opt1_price)
        assert response.data['company_name'] == 'Test Company LLC'
        assert response.data['purchase_order_number'] == 'PO-2024-001'
```

#### E2E Test –¥–ª—è B2B —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

```typescript
// b2b-checkout.spec.ts
import { test, expect } from '@playwright/test';

test.describe('B2B Pricing and Checkout', () => {
  test.beforeEach(async ({ page }) => {
    // Login as B2B user
    await page.goto('/login');
    await page.fill('[data-testid="email-input"]', 'wholesale@test.com');
    await page.fill('[data-testid="password-input"]', 'test123');
    await page.click('[data-testid="login-button"]');
    await expect(page).toHaveURL('/dashboard');
  });

  test('displays B2B pricing with RRP/MSRP information', async ({ page }) => {
    await page.goto('/products/test-product');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø—Ç–æ–≤—É—é —Ü–µ–Ω—É
    await expect(page.locator('[data-testid="current-price"]')).toContainText('1 000 ‚ÇΩ');
    await expect(page.locator('[data-testid="price-type"]')).toContainText('–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ RRP/MSRP –¥–ª—è B2B –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
    await expect(page.locator('[data-testid="rrp-price"]')).toContainText('–†–†–¶: 1 300 ‚ÇΩ');
    await expect(page.locator('[data-testid="msrp-price"]')).toContainText('–ú–∞–∫—Å. —Ü–µ–Ω–∞: 1 400 ‚ÇΩ');
  });

  test('completes B2B checkout with company information', async ({ page }) => {
    // Add product to cart
    await page.goto('/products/test-product');
    await page.fill('[data-testid="quantity-input"]', '10');
    await page.click('[data-testid="add-to-cart"]');
    
    // Go to checkout
    await page.click('[data-testid="cart-icon"]');
    await page.click('[data-testid="checkout-button"]');
    
    // Verify B2B pricing in cart
    await expect(page.locator('[data-testid="line-total"]')).toContainText('10 000 ‚ÇΩ'); // 10 * 1000
    
    // Fill B2B-specific checkout form
    await page.selectOption('[data-testid="payment-method"]', 'invoice');
    await page.fill('[data-testid="company-name"]', 'Test Company LLC');
    await page.fill('[data-testid="tax-id"]', '1234567890');
    await page.fill('[data-testid="po-number"]', 'PO-2024-001');
    await page.fill('[data-testid="delivery-address"]', 'Business Address');
    
    // Submit order
    await page.click('[data-testid="place-order-button"]');
    
    // Verify order confirmation with B2B details
    await expect(page.locator('[data-testid="order-success"]')).toBeVisible();
    await expect(page.locator('[data-testid="order-total"]')).toContainText('10 000 ‚ÇΩ');
    await expect(page.locator('[data-testid="company-name"]')).toContainText('Test Company LLC');
    await expect(page.locator('[data-testid="po-number"]')).toContainText('PO-2024-001');
  });

  test('prevents retail users from seeing RRP/MSRP', async ({ page }) => {
    // Logout and login as retail user
    await page.click('[data-testid="logout-button"]');
    await page.fill('[data-testid="email-input"]', 'retail@test.com');
    await page.fill('[data-testid="password-input"]', 'test123');
    await page.click('[data-testid="login-button"]');
    
    await page.goto('/products/test-product');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–∑–Ω–∏—á–Ω—É—é —Ü–µ–Ω—É
    await expect(page.locator('[data-testid="current-price"]')).toContainText('1 200 ‚ÇΩ');
    
    // RRP/MSRP –ù–ï –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –¥–ª—è B2C –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (FR5)
    await expect(page.locator('[data-testid="rrp-price"]')).not.toBeVisible();
    await expect(page.locator('[data-testid="msrp-price"]')).not.toBeVisible();
  });
});
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### Frontend Test Configuration

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/setupTests.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@shared/(.*)$': '<rootDir>/../packages/shared/src/$1'
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/main.tsx'
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70
    }
  }
};
```

#### Backend Test Configuration

```ini
# pytest.ini
[tool:pytest]
DJANGO_SETTINGS_MODULE = config.settings.test
addopts = 
    --tb=short
    --cov=apps
    --cov-report=term-missing
    --cov-report=xml
    --cov-fail-under=70
markers =
    slow: marks tests as slow
    integration: marks tests as integration tests
    unit: marks tests as unit tests
```

### –ö–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

```bash
# Frontend Tests
npm run test:frontend              # Run all frontend tests
npm run test:frontend:watch        # Watch mode for development  
npm run test:frontend:coverage     # With coverage report

# Backend Tests  
pytest                            # Run all backend tests
pytest -m unit                    # Only unit tests
pytest -m integration            # Only integration tests
pytest --cov                     # With coverage

# E2E Tests
npx playwright test               # All E2E tests
npx playwright test --headed     # With browser UI
npx playwright test --project=chromium  # Specific browser

# All Tests
npm run test:all                  # Run complete test suite
```

### –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

**Code Coverage Requirements:**
- Frontend: –º–∏–Ω–∏–º—É–º 70% line coverage
- Backend: –º–∏–Ω–∏–º—É–º 70% line coverage  
- Critical paths (—Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –∑–∞–∫–∞–∑—ã, –ø–ª–∞—Ç–µ–∂–∏): –º–∏–Ω–∏–º—É–º 90% coverage

**Performance Requirements:**
- Unit tests: < 5 –º–∏–Ω—É—Ç –æ–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- Integration tests: < 10 –º–∏–Ω—É—Ç
- E2E tests: < 15 –º–∏–Ω—É—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞

**Test Quality Metrics:**
- –í—Å–µ —Ç–µ—Å—Ç—ã –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ user journeys –ø–æ–∫—Ä—ã—Ç—ã E2E —Ç–µ—Å—Ç–∞–º–∏
- –¶–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

---

## 11. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**Authentication & Authorization:**
```python
# JWT Token Configuration
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
}

# Role-Based Access Control (RBAC)
ROLE_PERMISSIONS = {
    'admin': ['*'],
    'wholesale_level1': ['view_wholesale_prices', 'create_order'],
    'wholesale_level2': ['view_wholesale_prices', 'create_order'],
    'wholesale_level3': ['view_wholesale_prices', 'create_order'],
    'trainer': ['view_trainer_prices', 'create_order', 'manage_team'],
    'federation_rep': ['view_federation_prices', 'manage_federation'],
    'retail': ['view_retail_prices', 'create_order'],
}
```

**Rate Limiting –ø–æ —Ä–æ–ª—è–º:**
- Admin: 10000/—á–∞—Å
- B2B users: 5000/—á–∞—Å
- Trainers: 3000/—á–∞—Å
- Retail: 1000/—á–∞—Å
- Anonymous: 100/—á–∞—Å

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ SLA/SLO –º–µ—Ç—Ä–∏–∫–∏

**Service Level Agreements (SLA):**
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã:** 99.9% uptime (8.76 —á–∞—Å–æ–≤ downtime –≤ –≥–æ–¥)
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API:** 95 percentile < 200ms
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü:** 95 percentile < 2 —Å–µ–∫—É–Ω–¥—ã
- **PageSpeed Insights:** > 85 –¥–ª—è –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
- **–ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:** –º–∏–Ω–∏–º—É–º 1000 RPS

**Service Level Objectives (SLO):**
- **API Response Time:**
  - GET endpoints: < 100ms (95 percentile)
  - POST endpoints: < 200ms (95 percentile)
  - –°–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (–ø–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä—ã): < 500ms (95 percentile)
  
- **Database Performance:**
  - –ü—Ä–æ—Å—Ç—ã–µ SELECT: < 10ms
  - –°–ª–æ–∂–Ω—ã–µ JOIN: < 50ms
  - –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∏: < 25ms
  
- **Frontend Performance:**
  - First Contentful Paint (FCP): < 1.2s
  - Largest Contentful Paint (LCP): < 2.5s
  - Cumulative Layout Shift (CLS): < 0.1
  - First Input Delay (FID): < 100ms
  
- **Cache Hit Rates:**
  - Redis cache: > 85%
  - Browser cache: > 90%
  - CDN cache: > 95%

**Error Rate Targets:**
- API errors: < 0.1% (4xx –∏ 5xx –æ—à–∏–±–∫–∏)
- Payment failures: < 0.5%
- 1C integration failures: < 1% (—Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º)

**Capacity Planning:**
- Concurrent users: –¥–æ 500 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Daily orders: –¥–æ 1000 –∑–∞–∫–∞–∑–æ–≤ –≤ –¥–µ–Ω—å
- Product catalog: –¥–æ 100,000 —Ç–æ–≤–∞—Ä–æ–≤
- Storage growth: 50GB –≤ –≥–æ–¥

### –§–ó-152 Compliance

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- –Ø–≤–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ü–î
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–∞ —Å–æ–≥–ª–∞—Å–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö:**
- –û–±—â–∏–µ –ü–î: –∏–º—è, email, —Ç–µ–ª–µ—Ñ–æ–Ω
- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ: –∫–æ–º–ø–∞–Ω–∏—è, –ò–ù–ù –¥–ª—è B2B
- –°–æ–≥–ª–∞—Å–∏—è: –º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –ø–µ—Ä–µ–¥–∞—á–∞ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**Docker Security:**
- Non-root users –≤–æ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö
- Read-only —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã
- –°–µ—Ç–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã (frontend/backend/database)
- Secrets —á–µ—Ä–µ–∑ Docker Swarm secrets

**Firewall Configuration:**
- UFW —Å —Ç–æ—á–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –¥–ª—è –ø–æ—Ä—Ç–æ–≤
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –ø–æ—Ä—Ç–æ–≤ (Telnet, RDP, SMB)
- Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ç–∏
- –î–æ—Å—Ç—É–ø SSH —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç–µ–π

**Nginx Security Headers:**
- Strict-Transport-Security (HSTS)
- Content-Security-Policy
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**Database Performance:**
- Connection pooling —á–µ—Ä–µ–∑ pgBouncer
- Query optimization —Å select_related/prefetch_related
- Redis caching —Å TTL —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
- Partitioning –¥–ª—è orders –ø–æ –≤—Ä–µ–º–µ–Ω–∏

**Frontend Performance:**
- Next.js Image optimization —Å WebP/AVIF
- Bundle splitting –∏ tree shaking
- Virtual scrolling –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤
- Client-side caching —Å stale-while-revalidate

**Cache Strategy:**
- Product list: 5 –º–∏–Ω—É—Ç TTL
- Product detail: 10 –º–∏–Ω—É—Ç TTL
- Category tree: 30 –º–∏–Ω—É—Ç TTL
- User sessions: 1 —á–∞—Å TTL

**CDN & Image Optimization:**
- Multi-size image generation (thumbnail/medium/large)
- WebP —Å JPEG fallback
- Nginx image serving —Å proper caching headers

---

## 12. –°—Ç—Ä–∞—Ç–µ–≥–∏—è –û–±—Ä–∞–±–æ—Ç–∫–∏ –û—à–∏–±–æ–∫

### Frontend Error Handling

**React Error Boundaries:**
- Global ErrorBoundary –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ React –æ—à–∏–±–æ–∫
- Component-level fallbacks –¥–ª—è graceful degradation
- Automatic error reporting to monitoring service

**API Error Handling:**
```typescript
interface ApiError {
  message: string;
  code: string;
  details?: Record<string, any>;
  status: number;
}

// User-friendly error messages
const getErrorMessage = (error: ApiError): string => {
  switch (error.code) {
    case 'NETWORK_ERROR': return '–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
    case 'VALIDATION_ERROR': return '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π';
    case 'INSUFFICIENT_STOCK': return '–¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
    case 'PAYMENT_FAILED': return '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–ª–∞—Ç–µ–∂–∞';
    default: return error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
  }
};
```

**Next.js Error Pages:**
- Custom error.tsx –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
- not-found.tsx –¥–ª—è 404 –æ—à–∏–±–æ–∫
- API route error handling —Å proper HTTP codes

### Backend Error Handling

**Custom Exception Classes:**
```python
class FreeSportException(Exception):
    default_message = "An error occurred"
    default_code = "FREESPORT_ERROR"
    default_status = status.HTTP_500_INTERNAL_SERVER_ERROR

class ValidationException(FreeSportException):
    default_code = "VALIDATION_ERROR"
    default_status = status.HTTP_400_BAD_REQUEST

class InsufficientStockException(FreeSportException):
    default_code = "INSUFFICIENT_STOCK"
    default_status = status.HTTP_409_CONFLICT

class PaymentException(FreeSportException):
    default_code = "PAYMENT_FAILED"
    default_status = status.HTTP_402_PAYMENT_REQUIRED
```

**Global Exception Handler:**
- Standardized error response format
- Automatic logging for all exceptions
- Different handling for custom vs system exceptions
- Database error fallbacks

**Service Layer Error Handling:**
- Transactional integrity –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Graceful fallbacks –¥–ª—è external service failures
- Retry logic —Å exponential backoff

### Circuit Breaker Pattern

**External Service Protection:**
- Circuit breaker –¥–ª—è 1C –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- Failure threshold: 5 –Ω–µ—É–¥–∞—á
- Recovery timeout: 60 —Å–µ–∫—É–Ω–¥
- Fallback to file export –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API

### Error Monitoring

**Error Aggregation:**
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –æ—à–∏–±–æ–∫ –ø–æ hash
- Count tracking –¥–ª—è —á–∞—Å—Ç–æ—Ç—ã –æ—à–∏–±–æ–∫
- Resolution tracking –¥–ª—è bug fixing

**Alert System:**
- Email alerts –¥–ª—è critical errors
- Slack integration –¥–ª—è development team
- Error rate monitoring –∏ thresholds

**Error Categories:**
- Frontend errors (JavaScript/React)
- Backend errors (Django/API)
- Integration errors (1C/YuKassa)
- Database errors (PostgreSQL)

### Retry Strategies

**Celery Tasks:**
- Max 3 retries —Å exponential backoff
- Different retry delays –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏
- Final fallback mechanisms
- Admin notifications –ø—Ä–∏ complete failure

**API Calls:**
- Network timeout: 30 —Å–µ–∫—É–Ω–¥
- Retry on 5xx errors (–Ω–µ –Ω–∞ 4xx)
- Client-side retry —Å user feedback

---

## 13. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

### System Health Monitoring

**Key Metrics:**
- API response time (SLA: < 2 —Å–µ–∫—É–Ω–¥—ã)
- Database query time (SLA: < 1 —Å–µ–∫—É–Ω–¥–∞)
- Error rate (SLA: < 5%)
- System uptime (SLA: 99.9%)
- Resource utilization (CPU < 75%, Memory < 80%, Disk < 85%)

**Health Check Endpoints:**
```python
# /api/v1/health/ - comprehensive health status
{
  "status": "healthy|unhealthy",
  "version": "1.0.0",
  "environment": "production",
  "api": {
    "database": {"healthy": true, "response_time": 0.05},
    "cache": {"healthy": true, "response_time": 0.01},
    "data": {"products_count": 15000, "orders_24h": 45}
  },
  "system": {
    "cpu": {"usage_percent": 35.2, "healthy": true},
    "memory": {"usage_percent": 68.5, "healthy": true},
    "disk": {"usage_percent": 45.1, "healthy": true}
  }
}
```

### Business Metrics

**Sales Analytics:**
- Daily/weekly/monthly revenue tracking
- B2B vs B2C performance breakdown
- Average order value (AOV) trends
- Top performing products and categories
- Customer acquisition and retention metrics

**Operational Metrics:**
- Cart abandonment rate
- User registration trends
- Active sessions monitoring
- Integration health (1C sync success rate)
- Payment processing success rate

### Alert Management

**Alert Levels and Thresholds:**
- **Info**: General information (CPU > 50%)
- **Warning**: Attention needed (Response time > 1.5s)
- **Error**: Service degradation (Error rate > 2%)
- **Critical**: Service outage (Database down)

**Notification Channels:**
- Email alerts –¥–ª—è error/critical levels
- Slack integration –¥–ª—è critical alerts
- Dashboard notifications –¥–ª—è all levels
- SMS alerts –¥–ª—è critical infrastructure failures

**Auto-escalation Rules:**
- Critical alerts ‚Üí immediate notification
- Unacknowledged alerts ‚Üí escalate after 15 minutes
- Repeat alerts ‚Üí suppress duplicates within 1 hour

### Monitoring Stack

**Infrastructure:**
- Prometheus –¥–ª—è metrics collection
- Grafana –¥–ª—è visualization –∏ dashboards
- Custom Django health checks
- WebSocket real-time updates

**Application Monitoring:**
```python
class MetricsCollector:
    @staticmethod
    def get_system_metrics():
        return {
            'cpu_percent': psutil.cpu_percent(),
            'memory': psutil.virtual_memory()._asdict(),
            'disk': psutil.disk_usage('/')._asdict(),
            'timestamp': time.time()
        }
    
    @staticmethod
    def get_business_metrics():
        return {
            'daily_orders': Order.objects.filter(created_at__date=today).count(),
            'daily_revenue': Order.objects.filter(
                created_at__date=today, payment_status='completed'
            ).aggregate(Sum('total_amount'))['total_amount__sum'] or 0
        }
```

### Real-time Dashboard

**WebSocket Integration:**
- Live system metrics updates
- Real-time business KPIs
- Alert notifications
- Connection status monitoring

**Dashboard Features:**
- System resource utilization charts
- Business performance graphs
- Alert history –∏ acknowledgment
- Integration status monitoring
- User activity heatmaps

### Automated Reporting

**Daily Reports:**
- System health summary
- Business performance overview
- Error rate analysis
- Integration status

**Weekly Reports:**
- Performance trends
- Business growth metrics
- System utilization patterns
- Alert frequency analysis

**Business Intelligence:**
- Revenue forecasting
- Customer behavior analysis
- Product performance insights
- Operational efficiency metrics

---

## 14. CI/CD –°—Ç—Ä–∞—Ç–µ–≥–∏—è

### Deployment Strategy

**Environment-Specific Orchestration:**
- **Development/Staging**: Docker Compose (standalone)
- **Production**: Docker Swarm Mode (orchestrated cluster)

**Deployment Pipeline:**
1. **Feature branches** ‚Üí –∫–æ–¥ validation –∏ security scan
2. **Develop branch** ‚Üí –ø–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã + staging deploy
3. **Main branch** ‚Üí production deployment

### Container Orchestration

**Docker Swarm Configuration (Production):**
```yaml
# Multi-service deployment with scaling
django:
  deploy:
    replicas: 3
    update_config:
      parallelism: 1
      delay: 30s
      order: start-first
      failure_action: rollback
    resources:
      limits:
        memory: 512M
        cpus: '0.5'
```

**Secrets Management:**
- Docker Swarm external secrets
- Environment-specific configuration
- Secure credential handling

### GitHub Actions CI/CD

**Pipeline Phases:**
1. **Code Quality**: Linting, formatting, type checking
2. **Testing**: Unit tests, integration tests, coverage reports
3. **Security**: Vulnerability scanning (Trivy, Safety, Semgrep)
4. **Build**: Multi-platform Docker images (AMD64/ARM64)
5. **Deploy**: Environment-specific deployment strategies

**Branch-based Triggers:**
- Feature branches ‚Üí validation tests only
- Develop ‚Üí full test suite + staging deploy
- Main ‚Üí production deployment
- Pull requests ‚Üí comprehensive validation

### Deployment Automation

**Smart Health Checks:**
```bash
wait_for_health_check() {
  local max_attempts=${1:-30}
  local attempt=1
  
  while [[ $attempt -le $max_attempts ]]; do
    if curl -f "$HEALTH_CHECK_URL" >/dev/null 2>&1; then
      echo "‚úÖ Health check passed (attempt $attempt)"
      return 0
    fi
    sleep 10
    ((attempt++))
  done
  
  echo "‚ùå Health check failed after $max_attempts attempts"
  return 1
}
```

**Rolling Updates:**
- Zero-downtime deployments
- Automatic rollback on failure
- Progressive deployment (start-first strategy)
- Service-specific update parallelism

### Environment Management

**Configuration Strategy:**
- Environment-specific .env files (.env.dev, .env.staging, .env.prod)
- Validation of required environment variables
- Secure secrets handling via Docker secrets

**Database Migration Strategy:**
- Automated migrations during deployment
- Backward-compatible schema changes
- Rollback-safe migration design

### Monitoring & Observability

**Deployment Monitoring:**
- Real-time deployment status tracking
- Automated health check validation
- Service logs aggregation
- Resource utilization monitoring

**Status Dashboard:**
```bash
# Deployment status utility
./scripts/deployment-status.sh production
# Shows: services status, health checks, resource usage, logs
```

### Rollback Strategy

**Automated Rollback:**
- Health check failures trigger automatic rollback
- Version-specific rollback capability
- Service-by-service rollback support
- State preservation during rollback

**Manual Rollback:**
```bash
./scripts/rollback.sh production v1.2.3
# Smart rollback with health validation
```

### Security Integration

**CI/CD Security:**
- Dependency vulnerability scanning
- SAST (Static Application Security Testing)
- Container image security scanning
- Secrets scanning prevention

**Production Security:**
- Network isolation –º–µ–∂–¥—É services
- Non-root container execution
- Security headers enforcement
- SSL/TLS termination

### Performance Optimization

**Build Optimization:**
- Docker layer caching
- Multi-stage builds
- Parallel test execution
- Efficient artifact management

**Runtime Optimization:**
- Resource limits –∏ reservations
- Service scaling based on demand
- Connection pooling
- Cache strategies

---

## 15. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°

### –û–±–∑–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**FREESPORT Platform** –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å **1–°:–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π** –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏:

- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤:** –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞, —Ü–µ–Ω, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞–º–∏:** –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–ª–∏—á–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤  
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π:** –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤:** –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –∏–∑ –≤–µ–±-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ 1–°
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤:** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ 1–°

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞

```mermaid
graph TB
    subgraph "1–°:–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π"
        A[–¢–æ–≤–∞—Ä—ã –∏ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞] --> B[–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö]
        C[–û—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤] --> B
        D[–¶–µ–Ω—ã –ø–æ —Ç–∏–ø–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤] --> B
        E[–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤] --> F[–í—ã–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤]
        G[–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤] --> H[HTTP API 1–°]
    end

    subgraph "FREESPORT Platform"
        B --> I[Management Commands]
        F --> I
        H --> J[Webhook Handlers]
        I --> K[Data Parsers]
        K --> L[Data Validators]
        L --> M[Django Models]
        M --> N[REST API]
        O[Order Export] --> H
        P[Customer Export] --> H
    end
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**Management Commands:**
- `import_catalog_from_1c` - –∏–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- `import_offers_from_1c` - –∏–º–ø–æ—Ä—Ç —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤  
- `import_customers_from_1c` - –∏–º–ø–æ—Ä—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã
- `sync_customers_with_1c` - –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- `export_orders_to_1c` - —ç–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ 1–°

**–°–µ—Ä–≤–∏—Å—ã:**
- `CustomerSyncService` - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- `CustomerIdentityResolver` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏
- `CustomerConflictResolver` - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- `DataParser` - –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–æ–≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- `ImportDataValidator` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ú–æ–¥–µ–ª–∏:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `onec_id`, `sync_status`, `last_sync_at` –≤ –º–æ–¥–µ–ª–∏ User –∏ Product
- `CustomerSyncLog` - –∞—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `ImportLog` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏–º–ø–æ—Ä—Ç–∞

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π

**–î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤:**
1. **–ò–º–ø–æ—Ä—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ 1–°** –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
2. **–≠–∫—Å–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π** —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ 1–°  
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π** –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
4. **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —á–µ—Ä–µ–∑ —Ä—É—á–Ω—É—é –º–æ–¥–µ—Ä–∞—Ü–∏—é

**Identity Resolution:**
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ `email` + `onec_id`
- –ù–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É + –§–ò–û
- –ú–∞–ø–ø–∏–Ω–≥ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏

### –§–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö

> **–ü–†–ò–ú–ï–ß–ê–ù–ò–ï:** –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ö–µ–º—ã –º–∞–ø–ø–∏–Ω–≥–∞ –±—É–¥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ 1–° –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã.

**–û–∂–∏–¥–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:**
- CommerceML 2.0 (XML —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è 1–°)
- JSON —á–µ—Ä–µ–∑ HTTP API
- CSV —Ñ–∞–π–ª—ã
- –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ XML —Ñ–æ—Ä–º–∞—Ç—ã

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ê—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ management commands

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å select_related/prefetch_related
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ú–µ—Ç—Ä–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–î–∞—à–±–æ—Ä–¥ –≤ Django Admin:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ–ø–µ—Ä–∞—Ü–∏–π
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—á–µ—Ä–µ–¥–µ–π —ç–∫—Å–ø–æ—Ä—Ç–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°:

- **[–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°](architecture/20-1c-integration.md)** - –ü–æ–ª–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
- **[–ó–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É 1–°](architecture/request-to-1c-developer.md)** - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤

---

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2025-09-05 - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°
- **–î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª 15: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°** - –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°:–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–µ–π
- **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π** - –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- **Management Commands** - –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ç–æ–≤–∞—Ä–æ–≤, –∫–ª–∏–µ–Ω—Ç–æ–≤, —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
- **Identity Resolution** - –Ω–∞–¥–µ–∂–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏
- **–°–æ–∑–¥–∞–Ω –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É 1–°** - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

### 2025-08-10 - –£–ª—É—á—à–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ Order –∏ SyncLog
- **–î–æ–±–∞–≤–ª–µ–Ω—ã –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ Order**:
  - `total_items` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ
  - `calculated_total` - —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ 
  - `can_be_cancelled` - —Å—Ç–∞—Ç—É—Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞
- **–î–æ–±–∞–≤–ª–µ–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ unique_together –≤ OrderItem**: `('order', 'product')` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
- **–û–±–Ω–æ–≤–ª–µ–Ω—ã API —Å—Ö–µ–º—ã**: –î–æ–±–∞–≤–ª–µ–Ω—ã readonly –ø–æ–ª—è –¥–ª—è –Ω–æ–≤—ã—Ö –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö —Å–≤–æ–π—Å—Ç–≤
- **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**: –¢–æ–≤–∞—Ä –º–æ–∂–µ—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∑–∞–∫–∞–∑–µ —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏, –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
- **–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–∏–ø—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ SyncLog**: –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø 'prices' –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω —Å 1–°
- **–ù–æ–≤—ã–µ SYNC_TYPES**: ['products', 'stocks', 'orders', 'prices'] –≤–º–µ—Å—Ç–æ ['products', 'orders', 'stocks']

---

*–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é FREESPORT –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –≤ –µ–¥–∏–Ω–æ–º –º–µ—Å—Ç–µ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è.*