# Story 2.1: API Documentation (Swagger) - Принятые технические решения

**Дата:** 16 августа 2025  
**Статус:** COMPLETED  
**Разработчик:** Claude Sonnet 4

## Context

- Первая версия документации API требовала унифицированного подхода к генерации и публикации схемы.
- Архитектура проекта на Django/DRF нуждалась в современном инструменте, поддерживающем OpenAPI 3.1.0.
- Команда фронтенда и интеграторы ожидали интерактивный UI и машиночитаемую схему для автоматизации.

## Decision

- Принята миграция на OpenAPI 3.1.0 с использованием `drf-spectacular` как основного генератора.
- Определена структура из трёх эндпоинтов (`/api/schema/`, `/api/docs/`, `/api/redoc/`) для разных сценариев потребления.
- Закреплены стандарты версионирования (`/api/v1/`) и категоризации эндпоинтов через теги в настройках схемы.

## Consequences

- **Плюсы:** единая живая документация, готовность к webhook-интеграциям, прозрачный процесс для фронтенда и партнёров.
- **Минусы:** необходимость поддерживать актуальность настроек `drf-spectacular`, повышенные требования к описанию эндпоинтов и сериализаторов.
- **Технический долг:** плановая кастомизация UI и автоматические проверки схемы в CI для предотвращения регрессий.

## Обзор

Документ описывает ключевые технические и архитектурные решения, принятые при реализации Story 2.1: API Documentation с автоматической генерацией Swagger/OpenAPI документации.

## Архитектурные решения

### 1. Выбор OpenAPI 3.1.0 вместо 3.0

**Решение:** Миграция с OpenAPI 3.0 на OpenAPI 3.1.0

**Обоснование:**
- Соответствие современным стандартам API документации
- Улучшенная поддержка JSON Schema
- Готовность к webhook интеграциям (ЮКасса)
- Требование архитектурной документации (п.3 "Спецификация API")

**Техническая реализация:**
- Обновление drf-spectacular с v0.27.0 до v0.28.0
- Установка 'OAS_VERSION': '3.1.0' в SPECTACULAR_SETTINGS
- Обновление всех связанных документов проекта

**Альтернативы рассмотренные:**
- Оставить OpenAPI 3.0 - отклонено из-за архитектурных требований
- Использовать другие инструменты документации - отклонено из-за экосистемы Django

### 2. Выбор drf-spectacular для генерации документации

**Решение:** Использование drf-spectacular вместо drf-yasg

**Обоснование:**
- Активная поддержка и развитие
- Нативная поддержка OpenAPI 3.1.0
- Лучшая интеграция с Django REST Framework
- Более богатые возможности кастомизации UI

**Конфигурация:**
```python
SPECTACULAR_SETTINGS = {
    'TITLE': 'FREESPORT API',
    'DESCRIPTION': 'API для B2B/B2C платформы спортивных товаров',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
    'OAS_VERSION': '3.1.0',
    # Расширенные настройки UI и серверов
}
```

### 3. Структура эндпоинтов документации

**Решение:** Три отдельных эндпоинта для разных типов потребления

**Эндпоинты:**
- `/api/schema/` - машиночитаемая OpenAPI схема (JSON)
- `/api/docs/` - интерактивный Swagger UI для разработчиков
- `/api/redoc/` - читаемая документация для пользователей API

**Обоснование:**
- Разделение машиночитаемой и человекочитаемой документации
- Swagger UI для интерактивного тестирования
- ReDoc для красивого отображения документации

## Технические решения

### 1. Версионирование API

**Решение:** Префикс /api/v1/ для всех эндпоинтов

**Обоснование:**
- Подготовка к будущим версиям API
- Обратная совместимость при изменениях
- Стандартная практика для REST API

**Реализация в URLs:**
```python
urlpatterns = [
    path('api/v1/', include('apps.common.urls')),
    path('api/v1/', include('apps.users.urls')),
    # Остальные приложения
]
```

### 2. Категоризация эндпоинтов через теги

**Решение:** Расширенная система тегов для группировки API

**Теги реализованы:**
- Authentication - аутентификация и авторизация
- Users - управление пользователями
- Products - каталог товаров
- Cart - корзина покупок
- Orders - заказы
- Search - поиск
- System - служебные эндпоинты
- Webhooks - внешние интеграции

**Обоснование:**
- Улучшенная навигация в документации
- Логическая группировка функциональности
- Подготовка к webhook интеграциям

### 3. Конфигурация серверов

**Решение:** Определение development и production серверов в схеме

**Конфигурация:**
```python
'SERVERS': [
    {'url': 'http://localhost:8001', 'description': 'Development server'},
    {'url': 'https://api.freesport.ru', 'description': 'Production server'},
]
```

**Обоснование:**
- Упрощение тестирования для фронтенд команды
- Готовность к развертыванию в production
- Соответствие стандартам OpenAPI

### 4. JWT аутентификация в документации

**Решение:** Автоматическое определение схемы безопасности из DRF настроек

**Реализация:**
- Автоматическое обнаружение JWT через django-rest-framework-simplejwt
- Отображение Bearer схемы в Swagger UI
- Интеграция с кнопкой "Authorize" для тестирования

**Обоснование:**
- Единообразие с фактической системой аутентификации
- Возможность тестирования защищенных эндпоинтов
- Автоматическая синхронизация с настройками безопасности

## Решения по интеграции

### 1. Webhook готовность

**Решение:** Подготовка схемы для webhook эндпоинтов

**Обоснование:**
- Планируемая интеграция с ЮКасса требует webhook
- OpenAPI 3.1.0 имеет улучшенную поддержку webhook
- Заблаговременная подготовка инфраструктуры

**Подготовленная структура:**
- Тег "Webhooks" в документации
- Примеры схем для payment callbacks
- Готовность к описанию асинхронных операций

### 2. Health Check эндпоинт

**Решение:** Создание демонстрационного /api/v1/health/ эндпоинта

**Обоснование:**
- Демонстрация работы документации
- Подготовка к мониторингу production среды
- Пример простого эндпоинта для фронтенд команды

**Реализация:**
```python
class HealthCheckView(APIView):
    def get(self, request):
        return Response({
            'status': 'healthy',
            'timestamp': timezone.now(),
            'version': '1.0.0'
        })
```

## Производственные соображения

### 1. Безопасность документации

**Решение:** Документация доступна в development, контролируется в production

**Настройки безопасности:**
- SERVE_INCLUDE_SCHEMA: False для отключения в production при необходимости
- Возможность ограничения доступа через Django permissions
- Отдельная настройка для внутренних и внешних эндпоинтов

### 2. Производительность

**Решение:** Генерация схемы "на лету" с возможностью кэширования

**Обоснование:**
- Автоматическое обновление при изменении кода
- Минимальная нагрузка на сервер
- Возможность статической генерации для production

### 3. Кастомизация UI

**Решение:** Настройка брендинга и дополнительных опций UI

**Кастомизации:**
- Заголовок и описание API
- Логотип FREESPORT (планируется)
- Дополнительные ссылки на документацию проекта

## Интеграция с разработкой

### 1. Workflow разработчиков

**Процесс:**
1. Разработчик создает новый API endpoint
2. Добавляет соответствующие docstrings и serializers
3. Документация автоматически обновляется
4. Тестирование через Swagger UI
5. Фронтенд команда получает актуальную документацию

### 2. Стандарты документирования

**Требования к API endpoints:**
- Обязательные docstrings для всех views
- Примеры запросов и ответов в serializers
- Описание параметров и их валидации
- Указание возможных HTTP статусов

## Будущие улучшения

### Краткосрочные (следующие 2-4 недели)
1. Добавление примеров запросов/ответов для всех endpoints
2. Кастомизация UI с логотипом FREESPORT
3. Настройка статической генерации для production

### Среднесрочные (1-3 месяца)
1. Интеграция webhook документации для ЮКасса
2. Автоматическое тестирование схемы в CI/CD
3. Генерация клиентских SDK из OpenAPI схемы

### Долгосрочные (3-6 месяцев)
1. Версионирование API с поддержкой множественных схем
2. Интерактивные туториалы в документации
3. Интеграция с системой мониторинга API

## Заключение

Реализация Story 2.1 заложила фундамент для качественной документации API:

✅ **Современная технологическая база** - OpenAPI 3.1.0 + drf-spectacular  
✅ **Автоматическая генерация** - минимальные усилия для поддержания актуальности  
✅ **Готовность к интеграциям** - webhook поддержка, версионирование  
✅ **Удобство разработки** - интерактивное тестирование, четкая структура  

Документация API стала центральной точкой для координации между backend и frontend командами, обеспечивая высокое качество интеграции.