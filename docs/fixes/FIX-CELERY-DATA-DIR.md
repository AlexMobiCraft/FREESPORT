# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Celery worker –Ω–µ –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ 1–°

## –ü—Ä–æ–±–ª–µ–º–∞

Celery worker –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–º–ø–æ—Ä—Ç–∞:
```
CommandError: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: goods
```

## –ü—Ä–∏—á–∏–Ω–∞

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Docker Compose –¥–ª—è Celery worker –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏:
1. ‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `ONEC_DATA_DIR`
2. ‚ùå Volume mount —Å –¥–∞–Ω–Ω—ã–º–∏ 1–° (`../data:/app/data`)

## –†–µ—à–µ–Ω–∏–µ

### –ò–∑–º–µ–Ω–µ–Ω—ã —Ñ–∞–π–ª—ã

1. **`docker/docker-compose.yml`** (–ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞)
   - –î–æ–±–∞–≤–ª–µ–Ω volume: `- ../data:/app/data`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: `- ONEC_DATA_DIR=/app/data/import_1c`

2. **`docker/docker-compose.prod.yml`** (–ø—Ä–æ–¥–∞–∫—à–Ω)
   - –î–æ–±–∞–≤–ª–µ–Ω volume: `- ${ONEC_DATA_DIR:-../data/import_1c}:/app/data/import_1c`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: `- ONEC_DATA_DIR=${ONEC_DATA_DIR:-/app/data/import_1c}`

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```powershell
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
cd c:\Users\38670\DEV_WEB\FREESPORT
docker-compose -f docker/docker-compose.yml down

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose -f docker/docker-compose.yml up -d --build celery

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose -f docker/docker-compose.yml logs -f celery
```

### –ü—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä

**–í–ê–ñ–ù–û:** –í—ã–ø–æ–ª–Ω—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `5.35.124.149`

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@5.35.124.149

# –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /root/freesport

# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ 1–° —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p /root/freesport/data/import_1c

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Celery worker
docker-compose -f docker/docker-compose.prod.yml stop celery

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
docker-compose -f docker/docker-compose.prod.yml build backend

# –ó–∞–ø—É—Å—Ç–∏—Ç—å Celery worker —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
docker-compose -f docker/docker-compose.prod.yml up -d celery

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose -f docker/docker-compose.prod.yml logs -f celery
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ ONEC_DATA_DIR —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
docker exec freesport-celery-worker env | grep ONEC_DATA_DIR

# –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏:
# ONEC_DATA_DIR=/app/data/import_1c

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
docker exec freesport-celery-worker ls -la /app/data/import_1c
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö 1–°

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `data/import_1c` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:

```
data/import_1c/
‚îú‚îÄ‚îÄ goods/          # –¢–æ–≤–∞—Ä—ã
‚îú‚îÄ‚îÄ offers/         # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ prices/         # –¶–µ–Ω—ã
‚îú‚îÄ‚îÄ rests/          # –û—Å—Ç–∞—Ç–∫–∏
‚îú‚îÄ‚îÄ priceLists/     # –¢–∏–ø—ã —Ü–µ–Ω
‚îî‚îÄ‚îÄ contragents/    # –ö–ª–∏–µ–Ω—Ç—ã
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: `http://localhost:8001/admin` (–ª–æ–∫–∞–ª—å–Ω–æ) –∏–ª–∏ `https://5.35.124.149/admin` (–ø—Ä–æ–¥–∞–∫—à–Ω)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏" ‚Üí "–°–µ—Å—Å–∏–∏ –∏–º–ø–æ—Ä—Ç–∞"
3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ action "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏–∑ 1–°"
4. –í—ã–±–µ—Ä–∏—Ç–µ "–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤" –∏ –Ω–∞–∂–º–∏—Ç–µ "‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç"
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Celery - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–∫–∏ "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è"

## –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)

```bash
# –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ docker-compose
git checkout HEAD~1 docker/docker-compose.yml docker/docker-compose.prod.yml

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose -f docker/docker-compose.yml restart celery
```

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- ‚úÖ `docker/docker-compose.yml` - –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ `docker/docker-compose.prod.yml` - –æ–±–Ω–æ–≤–ª–µ–Ω
- üìÑ `backend/freesport/settings/base.py` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ONEC_DATA_DIR (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- üìÑ `backend/apps/integrations/tasks.py` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ONEC_DATA_DIR (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
