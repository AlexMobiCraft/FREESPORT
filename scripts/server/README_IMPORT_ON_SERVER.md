# Импорт каталога напрямую на сервере

## Обзор

Скрипт `import_catalog_on_server.ps1` выполняет импорт XML-файлов в базу данных напрямую на удалённом сервере, минуя локальную машину и Docker-контейнеры.

## Схема работы

```
Сервер (5.35.124.149)
/home/freesport/freesport/data/import_1c/*.xml
         ↓ (Django manage.py import_catalog_from_1c)
База данных PostgreSQL на сервере
```

## Параметры скрипта

### Основные параметры
- `ServerIP` - IP-адрес сервера (по умолчанию: `5.35.124.149`)
- `User` - Пользователь SSH (по умолчанию: `root`)
- `RemoteDataPath` - Путь к XML-файлам на сервере (по умолчанию: `/home/freesport/freesport/data/import_1c`)
- `RemoteProjectPath` - Путь к проекту Django на сервере (по умолчанию: `/home/freesport/freesport`)
- `SshKeyPath` - Путь к SSH-ключу (по умолчанию: `C:\Users\38670\.ssh\id_ed25519`)

### Параметры импорта
- `ChunkSize` - Размер пакета для импорта (по умолчанию: `500`)
- `SkipBackup` - Пропустить создание резервной копии
- `SkipMigrate` - Пропустить применение миграций
- `DryRun` - Тестовый запуск без изменений в базе данных
- `BackupPath` - Путь для сохранения резервной копии

## Примеры использования

### Стандартный запуск
```powershell
.\import_catalog_on_server.ps1
```
Выполнит полный импорт с резервным копированием и миграциями.

### Тестовый запуск
```powershell
.\import_catalog_on_server.ps1 -DryRun
```
Проверит процесс импорта без изменения данных в базе.

### Пропуск резервного копирования
```powershell
.\import_catalog_on_server.ps1 -SkipBackup
```
Выполнит импорт без создания резервной копии.

### Указание пути для бэкапа
```powershell
.\import_catalog_on_server.ps1 -BackupPath "/home/freesport/backups/catalog_$(Get-Date -Format 'yyyyMMdd_HHmmss').json"
```

### Изменение размера пакета
```powershell
.\import_catalog_on_server.ps1 -ChunkSize 1000
```
Увеличит размер пакета для ускорения импорта.

## Процесс выполнения

1. **Проверка соединения** - Установка SSH-соединения с сервером
2. **Проверка файлов** - Поиск XML-файлов в указанной директории
3. **Резервное копирование** - Создание бэкапа базы данных (если не пропущено)
4. **Миграции** - Применение миграций Django (если не пропущено)
5. **Импорт** - Загрузка данных из XML-файлов в базу данных
6. **Завершение** - Отчёт о выполнении операции

## Преимущества

- **Быстродействие** - импорт выполняется на сервере без передачи данных по сети
- **Эффективность** - прямая работа с базой данных на сервере
- **Безопасность** - автоматическое резервное копирование перед импортом
- **Гибкость** - различные режимы выполнения
- **Контроль** - детальное логирование процесса

## Требования

### На сервере
- Python и Django проект
- PostgreSQL база данных
- SSH доступ с ключевой аутентификацией
- Установленные зависимости проекта

### На локальной машине
- PowerShell 5.1 или выше
- OpenSSH клиент
- Доступ к SSH-ключу

## Устранение неполадок

### Ошибка соединения
```powershell
# Проверьте доступность сервера
ssh root@5.35.124.149

# Проверьте SSH-ключ
ssh-add -l
```

### Ошибка "Проект не найден"
```powershell
# Проверьте путь к проекту на сервере
ssh root@5.35.124.149 "ls -la /home/freesport/freesport"
```

### Ошибка "XML-файлы не найдены"
```powershell
# Проверьте наличие файлов
ssh root@5.35.124.149 "find /home/freesport/freesport/data/import_1c -name '*.xml' | wc -l"
```

### Ошибка импорта
Проверьте логи Django на сервере:
```powershell
ssh root@5.35.124.149 "cd /home/freesport/freesport && python manage.py import_catalog_from_1c --help"
```

## Мониторинг прогресса

Скрипт показывает детальную информацию о каждом шаге:
- Количество найденных XML-файлов
- Примеры файлов для импорта
- Статус резервного копирования
- Результат применения миграций
- Прогресс импорта

## Безопасность

- Использование SSH-ключей для аутентификации
- Автоматическое резервное копирование перед изменениями
- Возможность тестового запуска
- Подробное логирование всех операций