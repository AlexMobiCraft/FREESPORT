# –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è FREESPORT (Windows –≤–µ—Ä—Å–∏—è)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ HTTPS –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ IP –∞–¥—Ä–µ—Å—É
# –í–ê–ñ–ù–û: –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞!

Write-Host "üîê –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –¥–ª—è FREESPORT..."

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
$CERT_DIR = "docker\nginx\ssl"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if (-not (Test-Path $CERT_DIR)) {
    New-Item -ItemType Directory -Path $CERT_DIR -Force
}

# –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
$KEY_PATH = "$CERT_DIR\key.pem"
$CERT_PATH = "$CERT_DIR\cert.pem"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ —É–∂–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
if ((Test-Path $CERT_PATH) -and (Test-Path $KEY_PATH)) {
    Write-Host "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ $CERT_DIR. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ."
} else {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ OpenSSL
    try {
        $null = openssl version 2>$null
        if ($LASTEXITCODE -ne 0) {
            throw "OpenSSL –Ω–µ –Ω–∞–π–¥–µ–Ω"
        }
    } catch {
        Write-Host "‚ùå –û—à–∏–±–∫–∞: OpenSSL –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ."
        Write-Host "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OpenSSL:"
        Write-Host "1. –°–∫–∞—á–∞–π—Ç–µ —Å https://slproweb.com/products/Win32OpenSSL.html"
        Write-Host "2. –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ Git for Windows (–≤–∫–ª—é—á–∞–µ—Ç OpenSSL)"
        Write-Host "3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ WSL (Windows Subsystem for Linux)"
        exit 1
    }

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
    Write-Host "üîë –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞..."
    openssl genrsa -out "$KEY_PATH" 2048
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞"
        exit 1
    }

    # –°–æ–∑–¥–∞–µ–º —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    Write-Host "üìú –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
    openssl req -new -x509 -key "$KEY_PATH" -out "$CERT_PATH" -days 365 -subj "/C=RU/ST=Moscow/L=Moscow/O=FREESPORT/OU=IT/CN=localhost"
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
        exit 1
    }

    Write-Host "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ $CERT_DIR"
    Write-Host "   - $KEY_PATH (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á)"
    Write-Host "   - $CERT_PATH (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç)"
}

Write-Host ""
Write-Host "üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:"
Write-Host "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ–±–Ω–æ–≤–∏–ª–∏ –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≤–∫–ª—é—á–∞—è —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏ docker-compose.yml)."
Write-Host "2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:"
Write-Host "   docker-compose down && docker-compose up -d"

Write-Host ""
Write-Host "‚ö†Ô∏è  –í–ê–ñ–ù–û:"
Write-Host "- –≠—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ, –∏ –±—Ä–∞—É–∑–µ—Ä—ã –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
Write-Host "- –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∞–π—Ç—É https://localhost –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–∏—Å–∫–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ."
Write-Host "- –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ (production) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –æ—Ç Let's Encrypt –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞."

Write-Host ""
Write-Host "üåê –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:"
Write-Host "- Frontend: http://localhost:3000"
Write-Host "- Backend API: http://localhost:8001/api/v1"
Write-Host "- Nginx (HTTPS): https://localhost (—Å —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º)"