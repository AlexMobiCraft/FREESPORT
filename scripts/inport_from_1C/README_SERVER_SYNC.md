# Скрипты импорта каталога с синхронизацией с сервером

## Обзор

Скрипты импорта каталога были модернизированы для работы с данными, расположенными на удалённом сервере в директории `/home/freesport/freesport/data/import_1c`.

## Скрипты

### 1. `run_catalog_import.ps1`

Простой скрипт для импорта каталога с синхронизацией данных.

**Параметры:**
- `ComposeFile` - Docker Compose файл (по умолчанию: `docker-compose.test.yml`)
- `DataDir` - Директория данных в контейнере (по умолчанию: `/app/data/import_1c`)
- `ServerIP` - IP-адрес сервера (по умолчанию: `5.35.124.149`)
- `RemoteDataPath` - Путь к данным на сервере (по умолчанию: `/home/freesport/freesport/data/import_1c`)
- `SshKeyPath` - Путь к SSH-ключу (по умолчанию: `C:\Users\38670\.ssh\id_ed25519`)
- `SkipSync` - Пропустить синхронизацию с сервера
- `UseLocalData` - Использовать только локальные данные

**Примеры использования:**
```powershell
# Стандартный запуск с синхронизацией
.\run_catalog_import.ps1

# Использовать локальные данные без синхронизации
.\run_catalog_import.ps1 -UseLocalData

# Пропустить синхронизацию
.\run_catalog_import.ps1 -SkipSync

# Указать другой сервер
.\run_catalog_import.ps1 -ServerIP "192.168.1.100" -RemoteDataPath "/custom/path/data"
```

### 2. `run_catalog_import_with_backup.ps1`

Расширенный скрипт с резервным копированием и дополнительными опциями.

**Параметры:**
- Все параметры из `run_catalog_import.ps1`
- `ChunkSize` - Размер пакета для импорта (по умолчанию: `500`)
- `SkipMigrate` - Пропустить миграции базы данных
- `SkipBackup` - Пропустить создание резервной копии
- `SkipImport` - Пропустить импорт данных
- `BackupOutput` - Путь для сохранения резервной копии
- `ImportArgs` - Дополнительные аргументы для команды импорта

**Примеры использования:**
```powershell
# Стандартный запуск с резервным копированием
.\run_catalog_import_with_backup.ps1

# Пропустить миграции и резервное копирование
.\run_catalog_import_with_backup.ps1 -SkipMigrate -SkipBackup

# Указать размер пакета и путь для бэкапа
.\run_catalog_import_with_backup.ps1 -ChunkSize 1000 -BackupOutput "C:\backups"

# Использовать локальные данные с дополнительными аргументами импорта
.\run_catalog_import_with_backup.ps1 -UseLocalData -ImportArgs @("--verbose", "--dry-run")
```

## Процесс работы

1. **Синхронизация данных** (если не указано иное)
   - Скрипт автоматически запускает `sync_import_data.ps1`
   - Данные копируются с сервера `/home/freesport/freesport/data/import_1c`
   - Используется инкрементальное копирование с проверкой хешей

2. **Запуск сервисов Docker**
   - Запускаются PostgreSQL и Redis
   - Ожидается готовность сервисов

3. **Применение миграций** (если не пропущено)
   - Выполняются миграции базы данных Django

4. **Импорт данных**
   - Запускается импорт каталога из 1С
   - Данные берутся из локальной директории `data/import_1c`

## Структура данных CommerceML

### Поля товаров

При импорте товаров из 1С извлекаются следующие ключевые поля:

- **`onec_id`** - Уникальный идентификатор товара/SKU из 1С (составной: `parent_id#sku_id`)
- **`parent_onec_id`** - ID базового товара из goods.xml
- **`onec_brand_id`** - Исходный идентификатор бренда из CommerceML (`<Производитель><Ид>`)
  - Сохраняется для обратной синхронизации заказов в 1С
  - Позволяет корректно определять бренд даже после дедупликации брендов на платформе
  - Если отсутствует в XML, поле остается `NULL` и логируется предупреждение
  - Не экспонируется в публичных API, только для внутренних интеграционных целей

## Преимущества

- **Автоматическая синхронизация** - всегда актуальные данные с сервера
- **Гибкость** - можно использовать локальные данные или пропустить синхронизацию
- **Безопасность** - резервное копирование перед импортом
- **Инкрементальное копирование** - только изменённые файлы
- **Детальное логирование** - полный контроль процесса

## Требования

- PowerShell 5.1 или выше
- Docker и Docker Compose
- Доступ к серверу по SSH
- Скрипт синхронизации `sync_import_data.ps1` в директории `../server/`

## Устранение неполадок

1. **Ошибка синхронизации**
   - Проверьте доступность сервера: `ssh root@5.35.124.149`
   - Проверьте путь к SSH-ключу
   - Убедитесь, что данные существуют на сервере

2. **Ошибка импорта**
   - Проверьте, что Docker сервисы запущены: `docker ps`
   - Проверьте логи контейнера: `docker logs freesport-backend-test`
   - Убедитесь, что локальная директория данных существует

3. **Проблемы с путями**
   - Скрипт автоматически определяет корень проекта
   - Локальные данные должны быть в `data/import_1c`
   - Удалённые данные в `/home/freesport/freesport/data/import_1c`
