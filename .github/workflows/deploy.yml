name: Deploy to Server

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è hotfix)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: production
      should_deploy: true
    steps:
      - name: –í—ã–±–æ—Ä production –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
  test:
    needs: setup
    if: needs.setup.outputs.should_deploy == 'true' && github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: freesport_test
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}

      - name: Install backend dependencies
        run: |
          cd backend
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          pip install pytest-django pytest-cov

      - name: Create test .env
        run: |
          cd backend
          cat > .env << EOF
          SECRET_KEY=test-secret-key
          DB_NAME=freesport_test
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_HOST=localhost
          DB_PORT=5432
          REDIS_URL=redis://localhost:6379/0
          DJANGO_SETTINGS_MODULE=freesport.settings.test
          EOF

      - name: Run backend tests
        env:
          DJANGO_SETTINGS_MODULE: freesport.settings.test
        run: |
          cd backend
          source venv/bin/activate
          python manage.py migrate --noinput
          pytest --ignore=tests/integration/test_management_commands/test_import_customers.py \
                 --ignore=tests/unit/test_services/test_customer_parser.py \
                 -m "not integration and not data_dependent" \
                 --cov=. --cov-fail-under=60

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --prefer-offline --no-audit

      - name: Run frontend tests
        run: |
          cd frontend
          npm run test:coverage
        env:
          CI: true

  # –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
  build:
    needs: [setup, test]
    if: always() && needs.setup.outputs.should_deploy == 'true' && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      backend_tag: ${{ steps.meta-backend.outputs.tags }}
      frontend_tag: ${{ steps.meta-frontend.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=raw,value=production

      - name: Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=sha,prefix=
            type=raw,value=production

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DJANGO_SETTINGS_MODULE=freesport.settings.production

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          file: frontend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            NODE_ENV=production

  # –î–µ–ø–ª–æ–π –Ω–∞ production
  deploy-production:
    needs: [setup, build]
    if: needs.setup.outputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create backup before deploy
        env:
          SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PRODUCTION_SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.PRODUCTION_DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            cd $DEPLOY_PATH
            
            echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
            BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
            docker compose -f docker/docker-compose.prod.yml exec -T db pg_dump -U postgres freesport > "backups/$BACKUP_FILE"
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –±—ç–∫–∞–ø–æ–≤
            ls -t backups/*.sql | tail -n +6 | xargs -r rm
            
            echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_FILE"
          ENDSSH

      - name: Deploy to production server
        env:
          SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PRODUCTION_SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.PRODUCTION_DEPLOY_PATH }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}:production
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}:production
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            cd $DEPLOY_PATH
            
            echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ Git..."
            git fetch origin main
            git checkout main
            git pull origin main
            
            echo "üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker pull $BACKEND_IMAGE
            docker pull $FRONTEND_IMAGE
            
            echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
            export BACKEND_IMAGE=$BACKEND_IMAGE
            export FRONTEND_IMAGE=$FRONTEND_IMAGE
            
            echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ (zero-downtime)..."
            # –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º backend –∏ celery
            docker compose -f docker/docker-compose.prod.yml up -d --no-deps --force-recreate backend
            sleep 15
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ backend
            if ! docker compose -f docker/docker-compose.prod.yml exec -T backend python manage.py check --deploy; then
              echo "‚ùå Backend health check failed, rolling back..."
              docker compose -f docker/docker-compose.prod.yml up -d --no-deps backend
              exit 1
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
            docker compose -f docker/docker-compose.prod.yml up -d --no-deps --force-recreate frontend celery celery-beat
            
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
            sleep 30
            
            echo "üîÑ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
            docker compose -f docker/docker-compose.prod.yml exec -T backend python manage.py migrate --noinput
            
            echo "üìÅ –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
            docker compose -f docker/docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput
            
            echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx (production —Å SSL)..."
            docker compose -f docker/docker-compose.prod.yml exec -T nginx nginx -t
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx..."
            docker compose -f docker/docker-compose.prod.yml exec -T nginx nginx -s reload
            
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f
            
            echo "‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ production –∑–∞–≤–µ—Ä—à–µ–Ω!"
          ENDSSH

      - name: Health check production
        env:
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ production..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
          for i in {1..10}; do
            if curl -sf "$PRODUCTION_URL/api/v1/health/" > /dev/null; then
              echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
              API_OK=true
              break
            fi
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/10..."
            sleep 15
          done
          
          if [ "$API_OK" != "true" ]; then
            echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend
          for i in {1..10}; do
            if curl -sf "$PRODUCTION_URL" > /dev/null; then
              echo "‚úÖ Frontend –¥–æ—Å—Ç—É–ø–µ–Ω"
              FRONTEND_OK=true
              break
            fi
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/10..."
            sleep 15
          done
          
          if [ "$FRONTEND_OK" != "true" ]; then
            echo "‚ùå Frontend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è"
            exit 1
          fi
          
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

      - name: Notify production deployment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success' 
              ? 'Production deployment completed successfully!'
              : 'Production deployment failed!';
            
            // –°–æ–∑–¥–∞–µ–º issue –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–µ–ø–ª–æ—è
            if (status !== 'success') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${emoji} Production Deployment Failed - ${new Date().toISOString()}`,
                body: `## Deployment Failed\n\n**Commit:** ${context.sha}\n**Actor:** ${context.actor}\n**Workflow Run:** ${context.runId}\n\nPlease investigate and fix the issue.`,
                labels: ['deployment', 'urgent']
              });
            }
            
            console.log(`${emoji} ${message}`);

  # Rollback (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
  rollback:
    if: github.event_name == 'workflow_dispatch' && failure()
    needs: [deploy-production]
    runs-on: ubuntu-latest
    
    steps:
      - name: Rollback notification
        run: |
          echo "‚ö†Ô∏è –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
          echo "–î–ª—è –æ—Ç–∫–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –æ–±—Ä–∞–∑"
          echo "–ö–æ–º–∞–Ω–¥–∞: docker compose -f docker/docker-compose.prod.yml up -d --force-recreate"
