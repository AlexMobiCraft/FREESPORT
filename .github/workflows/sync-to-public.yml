name: Sync Clean Version to Public Repo

on:
  push:
    branches:
      - main  # Срабатывает только при пуше в main ветку приватного репозитория

jobs:
  build-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Private Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove Internal and Heavy Files
        run: |
          echo "Starting cleanup of internal and sensitive files..."
          
          # 1. Удаление инструментов ИИ и логов работы
          rm -rf _bmad/ _bmad-output/ .claude/ .gemini-clipboard/ .agent/ .agents/ .agentvibes/ .windsurf/
          rm -rf .kilocodemodes/ .roomodes/ .web-bundles/ .kilocode/
          
          # 2. Удаление секретных файлов и локальных конфигов
          rm -f .env .env.prod .mcp.json FREESPORT.code-workspace project-context.md codebase.xml
          rm -f AGENTS.md GEMINI.md CLAUDE.md
          
          # 3. Удаление тяжелых данных и архивов 1С
          rm -rf data/import_1c/ data/import_1c.zip
          rm -f import_1c.tar.gz import_data_xml_only.zip
          
          # 4. Удаление временных файлов и логов
          rm -rf logs/ .pytest_cache/ .husky/ .pytype/
          
          # 5. Удаление тестовых и отладочных Docker-конфигураций (часто вызывают ложные срабатывания Secret Scanning)
          rm -f backend/Dockerfile.test backend/Dockerfile.dev frontend/Dockerfile.dev
          rm -f docker/docker-compose-temp.yml
          
          # 7. Очистка документации от черновиков
          rm -f docs/Отчет_для_заказчика.md
          rm -rf docs/archive/  # Мы сохранили старый README туда, в паблике он не нужен
          
          # 8. Удаление самих workflow файлов для публичного репозитория
          # Это решает проблему отсутствия прав 'workflow' у PAT и скрывает внутренние CI процессы
          rm -rf .github/workflows/
          
          echo "Cleanup finished."

      - name: Push to Public Repository
        env:
          # Используем кастомное имя переменной, чтобы избежать конфликта с системным GITHUB_TOKEN
          SYNC_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          PUBLIC_REPO_URL: "github.com/AlexMobiCraft/FREESPORT-B2B.git"
        run: |
          # Создаем временную директорию для формирования чистого коммита
          mkdir ../public_sync
          cp -ra . ../public_sync/
          cd ../public_sync
          
          # УДАЛЯЕМ ПАПКУ .git приватного репозитория, чтобы не переносить историю коммитов!
          # Это предотвратит срабатывание Secret Scanning на старые коммиты.
          rm -rf .git
          
          # Инициализируем абсолютно новый чистый репозиторий с веткой main
          git init -b main
          git config user.name "Freesport Sync Bot"
          git config user.email "bot@freesport.ru"
          
          git add .
          git commit -m "chore: public release $(date +'%Y-%m-%d %H:%M')"
          
          # Явно передаем токен в URL.
          git remote add public "https://x-access-token:${SYNC_TOKEN}@${PUBLIC_REPO_URL}"
          
          # Отключаем использование учетных данных от actions/checkout
          git config --local http.https://github.com/.extraheader ""
          
          git push public main --force
          
          echo "Successfully synced to public repository!"
