name: Sync Clean Version to Public Repo

on:
  push:
    branches:
      - main  # Срабатывает только при пуше в main ветку приватного репозитория

jobs:
  build-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Private Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Remove Internal and Heavy Files
        run: |
          echo "Starting cleanup of internal and sensitive files..."
          
          # 1. Удаление инструментов ИИ и логов работы
          rm -rf _bmad/ _bmad-output/ .claude/ .gemini-clipboard/ .agent/ .agents/ .agentvibes/ .windsurf/
          rm -rf .kilocodemodes/ .roomodes/ .web-bundles/ .kilocode/
          
          # 2. Удаление секретных файлов и локальных конфигов
          rm -f .env .env.prod .mcp.json FREESPORT.code-workspace project-context.md codebase.xml
          rm -f AGENTS.md GEMINI.md CLAUDE.md
          
          # 3. Удаление тяжелых данных и архивов 1С
          rm -rf data/import_1c/ data/import_1c.zip
          rm -f import_1c.tar.gz import_data_xml_only.zip
          
          # 4. Удаление временных файлов и логов
          rm -rf logs/ .pytest_cache/ .husky/ .pytype/
          
          # 5. Очистка документации от черновиков (опционально)
          rm -f docs/Отчет_для_заказчика.md
          rm -rf docs/archive/  # Мы сохранили старый README туда, в паблике он не нужен
          rm -rf frontend/docs/

          # 6. Удаление скриптов
          rm -rf scripts/
          
          echo "Cleanup finished."

      - name: Push to Public Repository
        env:
          # В настройках приватного репозитория (Settings -> Secrets -> Actions)
          # создайте секрет PUBLIC_REPO_TOKEN с вашим Personal Access Token (PAT)
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
          # Замените на URL вашего публичного репозитория
          PUBLIC_REPO_URL: "github.com/AlexMobiCraft/FREESPORT-B2B.git"
        run: |
          # Создаем временную директорию для формирования чистого коммита
          mkdir ../public_sync
          cp -ra . ../public_sync/
          cd ../public_sync
          
          # Инициализируем новый репозиторий с чистого листа (без истории приватных коммитов)
          git init
          git config user.name "Freesport Sync Bot"
          git config user.email "bot@freesport.ru"
          
          git add .
          git commit -m "chore: public release $(date +'%Y-%m-%d %H:%M')"
          
          # Принудительная отправка в ветку main публичного репозитория
          git remote add public https://x-access-token:${GITHUB_TOKEN}@${PUBLIC_REPO_URL}
          git push public main --force
          
          echo "Successfully synced to public repository!"
