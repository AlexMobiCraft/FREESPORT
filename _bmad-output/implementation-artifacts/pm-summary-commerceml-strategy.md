#  Стратегия реализации CommerceML 3.1

## Предисловие (Preamble)
Этот документ закрепляет стратегическое решение о переходе на стандарт обмена CommerceML 3.1 для интеграции FREESPORT с 1С:Предприятие. Документ служит руководством для Project Manager'а и команды разработки, описывая текущий статус, необходимые изменения в реализованных модулях и специфические требования для будущих задач. Цель — обеспечить единое понимание стандарта и избежать архитектурных ошибок при реализации оставшихся эпиков.

## Статус
**Утвержден стандарт CommerceML 3.1.**
Предыдущие планы по откату на 2.10 аннулированы.

## Текущее состояние (Epic 4 - Экспорт заказов)
Эпик 4 реализован **частично**.
- **Готово:** Транспортный уровень (Auth, Init, базовый View). Настройки переведены на 3.1.
- **Требует реализации:** Логика генерации XML (`mode=query`) и подтверждения (`mode=success`).

## ⚠️ Developer Notice: Action Items

### 1. Проверка текущего кода (`backend/apps/integrations/onec_exchange/`)
- [ ] Убедиться, что `handle_init` возвращает `version=3.1`. (Уже сделано, **проверить!**)
- [ ] Проверить заглушку `handle_query`: корневой тег должен быть `<КоммерческаяИнформация ВерсияСхемы="3.1">`.

### 2. Реализация XML-генерации (Story 4.2)
При реализации сервиса экспорта **строго следовать схеме 3.1**:
> [!IMPORTANT]
> **Отличие 3.1:** Документы (заказы) должны быть обернуты в тег `<Контейнер>`.
> В версии 2.10 заказы шли списком сразу в корне. В 3.1 требуется группировка.

### 3. Модель Order (Story 4.1)
- Убедиться, что поля `sent_to_1c`, `status_1c` созданы корректно (если миграция уже была — проверить).

---

## ⚠️ Epic 5 Check (Импорт статусов)

В рамках подготовки к Epic 5 необходимо провести аудит соответствующих историй и обновить статус в `sprint-status.yaml`.

- [ ] **Проверка требований:** В `epics.md` убедиться, что требования к парсингу `orders.xml` учитывают структуру CommerceML 3.1 (вложенность в `<Контейнер>`).
- [ ] **Sprint Status:** Актуализировать файл `_bmad-output/implementation-artifacts/sprint-status.yaml`. Убедиться, что новые подзадачи по поддержке 3.1 отражены или добавлены в бэклог.

**Разработчику:** Приступая к задаче, начни с ревью файла `docs/integrations/1c/transport-layer.md` и убедись, что твоя реализация соответствует описанному там формату 3.1.
