# История 2.1: Потоковая загрузка файлов

Статус: выполнено

<!-- Примечание: Валидация необязательна. Запустите validate-create-story для проверки качества перед dev-story. -->

## История

Как Система,
Я хочу принимать большие бинарные файлы через загрузку по частям (chunked upload) без чрезмерного потребления оперативной памяти,
чтобы я могла надежно получать полный архив экспорта из 1С.

## Критерии приемки

1.  **Сессия аутентифицированной загрузки**
    *   **Дано** Аутентифицированная сессия и бинарный файл для загрузки
    *   **Когда** Отправляется POST-запрос на эндпоинт с `?mode=file&filename=import.zip&sessid=<session_key>` и бинарным телом
    *   **Тогда** Содержимое файла должно быть передано потоком во временный файл в `MEDIA_ROOT/1c_temp/`
    *   **И** Ответ должен быть `success` при успешной записи

2.  **Поддержка загрузки по частям (Chunked Upload)**
    *   **Дано** Отправлено несколько запросов с одним и тем же именем файла (представляющих части)
    *   **Когда** Эти запросы обрабатываются последовательно или параллельно
    *   **Тогда** Содержимое должно быть корректно добавлено в тот же физический файл в `1c_temp`
    *   **И** Итоговый размер файла должен совпадать с общим размером загруженных частей

3.  **Валидация безопасности сессии**
    *   **Дано** POST-запрос с `?mode=file&filename=X&sessid=<key>`
    *   **Когда** Параметр `sessid` НЕ совпадает с `request.session.session_key`
    *   **Тогда** Ответ должен быть 403 Forbidden с телом `failure\nInvalid session`

4.  **Обработка отсутствующих параметров**
    *   **Дано** POST-запрос с `?mode=file` без параметра `sessid`
    *   **Когда** Запрос обрабатывается
    *   **Тогда** Ответ должен быть 403 Forbidden с телом `failure\nMissing sessid`

## Задачи / Подзадачи

- [x] Реализация основного обработчика файлов (AC: 1, 2)
  - [x] Обновить `settings.py`, определив `TEMP_DIR` в `ONEC_EXCHANGE`, указывающий на `MEDIA_ROOT/1c_temp/`
  - [x] Реализовать логику обработчика `ICExchangeView.post()` для `mode=file`
  - [x] **Критично:** Создать изолированную директорию для каждой сессии: `MEDIA_ROOT/1c_temp/<sessid>/`
  - [x] Создать `FileStreamService` с методом `append_chunk(filename, content)`
  - [x] Убедиться, что `append_chunk` использует режим `ab` (append binary) для последовательной записи

- [x] Безопасность и Валидация (AC: 3, 4)
  - [x] Реализовать валидацию `sessid` против активной сессии запроса
  - [x] Убедиться, что ответы 403 возвращают точный ожидаемый 1С-совместимый текст (`failure\n...`)

- [x] Тестирование и Верификация
  - [x] Тест TC1: Валидная загрузка с корректным sessid (один чанк)
  - [x] Тест TC2: Загрузка с невалидным sessid
  - [x] Тест TC3: Загрузка без параметра sessid
  - [x] Тест TC4: Загрузка 250МБ в 3 чанка (симуляция)
  - [x] Проверить существование и целостность файла в `1c_temp` после загрузки

- [x] Доработки по ревью (ИИ)
  - [x] [AI-Review][HIGH] Реализовать потоковое чтение тела запроса для удовлетворения NFR2 (убрать вызов `request.body`) [backend/apps/integrations/onec_exchange/views.py:170]
  - [x] [AI-Review][MEDIUM] Реализовать валидацию `FILE_LIMIT_BYTES` в View
  - [x] [AI-Review][MEDIUM] Устранить риск повторного использования/повтора в режиме `append` (рассмотреть очистку сессии при `init`)
  - [x] [AI-Review][MEDIUM] Обновить список файлов истории и журнал изменений, чтобы отразить все измененные/удаленные файлы
  - [x] [AI-Review][MEDIUM] Улучшить тесты для проверки эффективности использования памяти (например, мок чтение блоков)
  - [x] [AI-Review][LOW] Переместить локальные импорты в `views.py` в начало файла [backend/apps/integrations/onec_exchange/views.py:136]

- [x] Доработки по второму ревью (ИИ)
  - [x] [AI-Review][HIGH] Исправить неэффективный цикл ввода-вывода в `views.py` - использовать менеджер контекста для открытия файла один раз на запрос вместо проверки директории и открытия файла для каждого чанка 64КБ.
  - [x] [AI-Review][MEDIUM] Убедиться, что все файлы реализации (`file_service.py`, тесты) отслеживаются в git.
  - [x] Все 36 тестов (23 загрузка файлов + 13 API обмена) прошли без регрессий

- [x] Доработки по ревью (ИИ)
  - [x] [AI-Review][HIGH] Безопасность: Блокировать публичный доступ к `1c_temp` в конфигурации Nginx [docker/nginx/conf.d/default.conf:45]
  - [x] [AI-Review][MEDIUM] Документация: Исправить список файлов истории, чтобы корректно помечать новые файлы как "Added" вместо "Modified"
  - [x] [AI-Review][MEDIUM] Рефакторинг: Использовать `django.contrib.auth.get_backends()[0]` вместо жестко закодированного пути к бэкенду в `handle_checkauth`

- [x] Доработки по ревью (ИИ) - 4
  - [x] [AI-Review][HIGH] Порча при конкурентной загрузке: Исправить риск порчи файла при чередующихся конкурентных загрузках, используя блокировку файлов или принудительную последовательную обработку [backend/apps/integrations/onec_exchange/views.py]
  - [x] [AI-Review][HIGH] Раскрытие информации: Предотвратить утечку деталей внутренних ошибок в глобальном обработчике исключений [backend/apps/integrations/onec_exchange/views.py]
  - [x] [AI-Review][MEDIUM] Небезопасные настройки тестов: Использовать `mock.patch.dict` для `settings.ONEC_EXCHANGE` в тестах, чтобы обеспечить потокобезопасность [backend/tests/integration/test_1c_file_upload.py]
  - [x] [AI-Review][MEDIUM] Неоднозначность конфига Nginx: Упростить `deny all; return 404;` до простого `return 404;` для строгого соответствия [docker/nginx/conf.d/default.conf]
  - [x] [AI-Review][LOW] Права доступа к файлам: Явно устанавливать права доступа к файлам в `FileStreamService` (например, 0o644) вместо полагания на umask [backend/apps/integrations/onec_exchange/file_service.py]

## Заметки разработчика

### Архитектурные паттерны и ограничения

-   **Эффективность памяти:** (NFR2 из Эпиков) НЕ читать все тело запроса в память. Использовать `streaming_content` Django или читать чанки из `request` напрямую, если возможно, или полагаться на стандартные обработчики загрузки файлов Django, но убедиться, что они настроены для больших файлов.
-   **Структура директорий:** Временные файлы ДОЛЖНЫ попадать в `1c_temp` (как определено в предполагаемом потоке `architecture.md`). Не обрабатывать и не распаковывать их пока (это История 2.2).
-   **Формат ответа:** 1С ожидает `text/plain` с `success` или `failure\nMessage`. НЕ возвращать JSON.
-   **Идемпотентность:** Повторная загрузка чанка (если 1С повторяет попытку) может добавить дубликаты, если не обработать это осторожно, но стандартное поведение 1С предполагает последовательные подтвержденные загрузки. Мы предполагаем логику "append" (добавление). *Уточнение: Стандартная обработка загрузки Django обычно перезаписывает или создает новые. Для поведения "append" через несколько запросов нам нужна явная обработка, или мы предполагаем, что 1С отправляет один запрос на файл, если это не строго "chunked" в смысле HTTP.*
    *   *Корректировка на основе протокола 1С:* 1С отправляет файл частями, используя стандартные POST-запросы, ожидая, что сервер будет добавлять их. `mode=file` часто подразумевает, что мы просто пишем то, что получаем, в файл с именем `filename`. Если файл существует, мы *добавляем* (append).
-   **Изоляция сессий:** (Из Party Mode) Сохранять файлы в `1c_temp/<sessid>/`, чтобы предотвратить коллизии между конкурентными сессиями или застрявшими предыдущими загрузками.
-   **Стратегия очистки:** (Из Party Mode) Мы реализуем очистку по TTL как отдельную задачу техдолга. Для этой истории полагаемся на изоляцию сессий, чтобы предотвратить блокировку новых импортов "застрявшими" файлами.

### Заметки по структуре проекта

-   **Новый сервис:** Рекомендуется `apps/products/services/import_1c/file_service.py` (или похожий) для файловых операций.
-   **View:** Продолжить модификацию `apps/products/views/integration_1c.py` (`ICExchangeView`).

## Запись агента-разработчика

### Используемая модель агента

Antigravity (Google Deepmind) / Режим агента-разработчика

### Ссылки на логи отладки

Н/Д

### Список заметок о выполнении

-   [x] Подтверждено создание директории `1c_temp` (через `FileStreamService._ensure_session_dir()`)
-   [x] Проверена логика проверки `sessid` (403 для отсутствующего/невалидного sessid)
-   [x] Протестировано поведение добавления (append) нескольких чанков (TC4 с 3 чанками пройден)
-   [x] Добавлена безопасность: санитайзинг имени файла предотвращает атаки обхода директорий (path traversal)
-   [x] 15 новых тестов пройдены + 13 существующих тестов пройдены (без регрессий)
-   [x] **[AI-Review]** Реализовано потоковое чтение тела с использованием `wsgi_request.read(chunk_size)` - чанки по 64КБ
-   [x] **[AI-Review]** Добавлена валидация `FILE_LIMIT_BYTES` с ответом 413 при превышении лимита
-   [x] **[AI-Review]** Добавлен метод `cleanup_session()` в `FileStreamService`, вызываемый во время режима `init`
-   [x] **[AI-Review]** Локальные импорты перемещены на уровень модуля в `views.py`
-   [x] **[AI-Review]** Добавлены тесты для FILE_LIMIT_BYTES (test_file_limit_exceeded), потоковой передачи (test_streaming_upload_uses_chunked_reads), cleanup_session
-   [x] Все 33 теста (20 загрузка файлов + 13 API обмена) пройдены без регрессий
-   [x] **[Second AI-Review]** Добавлен класс `FileWriter` и менеджер контекста `open_for_write()` для эффективного ввода-вывода
-   [x] **[Second AI-Review]** Рефакторинг `views.py` для использования менеджера контекста - файл открывается один раз на запрос вместо каждого чанка
-   [x] **[Second AI-Review]** Проверено, что все файлы отслеживаются в git (file_service.py, test_1c_file_upload.py)
-   [x] Все 36 тестов (23 загрузка файлов + 13 API обмена) пройдены без регрессий
-   [x] **[Third AI-Review]** Добавлено правило безопасности Nginx для блокировки публичного доступа к /media/1c_temp/ (возвращает 404)
-   [x] **[Third AI-Review]** Исправлен список файлов, чтобы корректно помечать новые файлы как "Added" вместо "Modified"
-   [x] **[Third AI-Review]** Рефакторинг handle_checkauth для использования get_backends()[0] вместо жестко закодированного пути к бэкенду
-   [x] Все 36 тестов (23 загрузка файлов + 13 API обмена) пройдены без регрессий после исправлений третьего ревью
-   [x] **[Fourth AI-Review]** Добавлен класс FileLock с паттерном lock file для кросс-платформенности (атомарное создание O_EXCL)
-   [x] **[Fourth AI-Review]** Интегрирована блокировка файлов в менеджер контекста open_for_write()
-   [x] **[Fourth AI-Review]** Добавлены явные права доступа к файлам (0o644) через os.open() в open_for_write()
-   [x] **[Fourth AI-Review]** Исправлено раскрытие информации - общий "Internal server error" вместо str(e)
-   [x] **[Fourth AI-Review]** Добавлен обработчик FileLockError, возвращающий 503 "File busy - retry later"
-   [x] **[Fourth AI-Review]** Рефакторинг тестов для использования monkeypatch.setitem и mock.patch.dict для потокобезопасности
-   [x] **[Fourth AI-Review]** Упрощен location nginx 1c_temp до простого `return 404;`
-   [x] Все 26 тестов загрузки файлов пройдены без регрессий после исправлений четвертого ревью

### Список файлов

-   `backend/freesport/settings/base.py` (Modified: добавлен `TEMP_DIR` в `ONEC_EXCHANGE`)
-   `backend/apps/integrations/onec_exchange/views.py` (Modified: потоковое чтение тела, валидация FILE_LIMIT_BYTES, очистка сессии в init, динамический auth backend)
-   `backend/apps/integrations/onec_exchange/file_service.py` (Added: FileStreamService с append_chunk, cleanup_session, менеджер контекста open_for_write)
-   `backend/tests/integration/test_1c_file_upload.py` (Added: 23 теста для загрузки файлов, потоковой передачи, очистки, менеджера контекста)
-   `docker/nginx/conf.d/default.conf` (Modified: блокировка публичного доступа к /media/1c_temp/)

## Журнал изменений (Change Log)

- 2026-01-23: Устранено 6 замечаний код-ревью (1 HIGH, 4 MEDIUM, 1 LOW) - все пункты разрешены
- 2026-01-23: Устранено 2 замечания второго код-ревью (1 HIGH, 1 MEDIUM) - эффективный ввод-вывод с менеджером контекста
- 2026-01-23: Устранено 3 замечания третьего код-ревью (1 HIGH, 2 MEDIUM) - безопасность Nginx, исправление списка файлов, рефакторинг бэкенда аутентификации
- 2026-01-23: Устранено 5 замечаний четвертого код-ревью (2 HIGH, 2 MEDIUM, 1 LOW) - блокировка файлов, раскрытие информации, безопасность тестов, упрощение nginx, права доступа к файлам
