---
stepsCompleted: [1, 2, 3, 4, 5, 6]
inputDocuments:
  - docs/api-contracts-backend.md
  - docs/data-models-backend.md
  - docs/development-guide.md
  - docs/integration-architecture.md
  - docs/source-tree-analysis-backend.md
  - docs/source-tree-analysis-frontend.md
  - docs/index.md
  - docs/Brief.md
  - docs/PRD.md
  - docs/front-end-spec.md
  - project-context.md
workflowType: 'architecture'
project_name: 'FREESPORT'
user_name: 'Alex'
date: '2026-01-18'
---

# Architecture Decision Document

_This document builds collaboratively through step-by-step discovery. Sections are appended as we work through each architectural decision together._

## Анализ контекста проекта

### Обзор требований

**Функциональные требования:**
Платформа требует надежной **API-first архитектуры** для обеспечения единого B2B/B2C опыта. Ключевые факторы:
- **Сложная ролевая логика:** 7 ролей пользователей, определяющих ценообразование, видимость товаров и процессы оформления заказа. Это требует полиморфизма на уровне сериализаторов и посредников (middleware).
- **Глубокая интеграция с ERP:** Асинхронная двусторонняя синхронизация с 1С является критической зависимостью, требующей выделенного слоя интеграции с высокой отказоустойчивостью.
- **Мультибрендовый каталог:** Для обработки различных спецификаций товаров 5 брендов в рамках единой схемы базы данных необходимы гибкие модели данных (EAV/JSONB).

**Нефункциональные требования:**
- **Производительность:** Строгие SLA (PageSpeed > 85) определяют выбор Next.js для гибридного рендеринга и Redis для агрессивного кэширования данных каталога.
- **Надежность:** Зависимость от внешних систем 1С требует использования паттернов проектирования, таких как Circuit Breaker (предохранитель), и транзакционных сессий импорта для предотвращения повреждения данных.
- **Масштабируемость:** Контейнеризированная архитектура микросервисов позволяет независимо масштабировать фоновые рабочие процессы (тяжелая обработка XML) и веб-серверы.

**Масштаб и сложность:**
- **Основной домен:** Полнофункциональная B2B/B2C электронная коммерция с синхронизацией ERP.
- **Уровень сложности:** Высокий (из-за бизнес-логики B2B и интеграции с устаревшими системами).
- **Предполагаемые архитектурные компоненты:** ~12 (Frontend, Backend API, БД, Redis, Celery Worker, Celery Beat, Nginx, коннектор 1С, платежный шлюз, шлюз доставки, сервис электронной почты, мониторинг).

### Технические ограничения и зависимости

- **Интеграция с наследием:** Необходимо строго придерживаться форматов данных XML 1С и GUID (`onec_id`).
- **Инфраструктура:** Обязательное развертывание по принципу Docker-first. Актуальное руководство: `docs/development-guide.md`.
- **База данных:** Использование PostgreSQL фиксировано; требуется строгая реляционная целостность для финансовых данных (заказы).
- **Разделение фронтенда и бэкенда:** Строгое разделение ответственности через контракт REST API.

### Выявленные сквозные вопросы (Cross-Cutting Concerns)

- **Аутентификация и авторизация:** Согласованный контроль доступа на основе ролей (RBAC) в API и маршрутизации фронтенда.
- **Синхронизация данных:** Поддержание согласованности в конечном счете (eventual consistency) между 1С и платформой.
- **Наблюдаемость (Observability):** Централизованное логирование и отслеживание ошибок, особенно для фоновых задач импорта.
- **Стратегия кэширования:** Многоуровневое кэширование (браузер, CDN, кэш приложения, кэш запросов БД) для достижения целей производительности без предоставления устаревших данных о ценах B2B-клиентам.

## Принятые архитектурные решения (ADR)

### ADR-001: API-First и паттерн BFF
- **Контекст:** Необходимость поддержки логики B2B/B2C и будущих мобильных приложений.
- **Решение:** Разделенная архитектура. Django REST Framework служит основным API. Next.js выступает в роли Backend-for-Frontend (BFF), обрабатывая адаптацию аутентификации, ограничение частоты запросов (rate limiting) и агрегацию данных.

### ADR-002: Стратегия интеграции с 1С
- **Контекст:** Критическая зависимость от ERP (1С) для товаров, остатков и пользователей.
- **Решение:** Асинхронная синхронизация на основе файлов XML (CommerceML). Использование `ImportSession` для атомарности. Основной инструмент: `VariantImportProcessor` и команда `import_products_from_1c`.

### ADR-003: Гибридный интерфейс администратора
- **Контекст:** Совмещение CRUD-операций и сложных B2B процессов.
- **Решение:** Django Admin для управления данными + кастомная админ-панель на Next.js для верификации и аналитики.

### ADR-004: Ценообразование на основе ролей
- **Контекст:** 7 типов цен.
- **Решение:** Динамическая сериализация цен в DRF в зависимости от роли токена JWT.

### ADR-005: Гибридная динамическая валидация B2B
- **Контекст:** Правила B2B (минимальный заказ, кратность) должны быть согласованы между FE и BE без дублирования кода.
- **Решение:** Бэкенд отдает правила через API (например, `/api/v1/cart/rules/`). Фронтенд запрашивает их и применяет динамически для мгновенного UX.

### ADR-006: Стратегия деплоя Recreate с предохранителями
- **Контекст:** Необходимость простого деплоя на VPS с минимизацией рисков простоя.
- **Решение:** Использование стратегии `Recreate`. Риски минимизируются через Docker `healthchecks` и сохранение состояния корзины на стороне клиента (`localStorage`), чтобы избежать потери данных при перезапуске контейнеров.

## Оценка стартового шаблона

### Основной технологический домен

**Full-stack Web Application** на базе Django и Next.js, согласно анализу требований проекта.

### Рассмотренные варианты

Проект использует кастомную архитектуру **Decoupled Monorepo**, которая была выбрана для обеспечения независимости фронтенда и бэкенда при сохранении единого управления кодом.

### Выбранный фундамент: Custom Django + Next.js Starter

**Обоснование выбора:**
Данная комбинация технологий (Django + Next.js) является отраслевым стандартом для сложных E-commerce систем с богатой бизнес-логикой (B2B) и высокими требованиями к SEO и производительности (B2C).

**Команды инициализации (для справки):**

```bash
# Backend (в папке /backend)
python -m venv venv
pip install -r requirements.txt
python manage.py migrate

# Frontend (в папке /frontend)
npm install
npm run dev
```

**Архитектурные решения, заложенные в основу:**

**Язык и среда выполнения:**
- Python 3.11+ и Node.js 18+.
- Полная поддержка TypeScript 5.0+ на фронтенде.

**Решение для стилизации:**
- Tailwind CSS 4.0 для быстрой верстки и легкой поддержки дизайн-системы через токены.

**Инструменты сборки:**
- Next.js Compiler (SWC) для фронтенда.
- Docker для обеспечения идентичности сред разработки и продакшена.

**Фреймворк для тестирования:**
- **Backend:** Pytest с плагинами для Django.
- **Frontend:** Vitest для модульных тестов и Playwright для E2E.

**Организация кода:**
- Модульная структура Django (apps/).
- Next.js App Router с использованием Route Groups (`(blue)`, `(electric)`) для реализации мультитемности.

**Опыт разработки:**
- Hot reloading для обоих слоев.
- Типизация API через TypeScript интерфейсы.
- Docker-first рабочий процесс, упрощающий развертывание.

## Паттерны реализации и правила консистентности

### Правила именования (Code Review Outcomes)

**Database & Backend:**
- **Таблицы:** `snake_case`, единственное число (напр., `order_item`).
- **Колонки:** `snake_case`.
- **API Payloads:** Строго **`snake_case`** для всех JSON полей (входящих и исходящих), чтобы исключить слой конвертации и возможные баги.

**API:**
- **Эндпоинты:** `kebab-case`, множественное число (напр., `/api/v1/product-variants/`).

**Frontend:**
- **Компоненты:** `PascalCase` (напр., `CartItem.tsx`).
- **Строгая типизация:** Запрещено использование `any`. Все ответы API должны быть описаны через TypeScript интерфейсы в `src/types/api.ts`.

### Структурные паттерны

**Организация проекта:**
- **Service Layer (Backend):** Вся бизнес-логика (особенно интеграции с 1С и расчеты B2B) выносится в `apps/{app}/services/`. Views остаются тонкими.
- **API Services (Frontend):** Все вызовы API инкапсулируются в `src/services/`.

### Паттерны надежности (Failure Mode Analysis)

1.  **Circuit Breaker для 1С:** При сбоях импорта сессия помечается как `failed`, данные откатываются.
2.  **Idempotency:** Все операции изменения данных (POST/PUT/PATCH) должны быть идемпотентными.
3.  **Graceful Degradation:** При недоступности бэкенда фронтенд сохраняет корзину в `localStorage` и показывает вежливое уведомление.
4.  **Сверка платежей:** Фоновая задача для сверки статусов с YuKassa.

### Уточнения логики (Rubber Duck Findings)

1.  **Price Snapshot:** В `OrderItem` сохраняется копия цены (`price`, `discount`) на момент заказа. Изменение цены товара в каталоге не должно влиять на историю заказов.
2.  **Smart Cache Invalidation:** При обновлении товаров через Celery инвалидировать кэш точечно (по тегам или ID), избегая полного сброса (`FLUSHALL`).
3.  **Non-blocking Migrations:** Миграции базы данных не должны блокировать таблицы на длительное время.

## Структура проекта и границы

### ADR-007: Организация монорепозитория (Decoupled Monorepo)
- **Контекст:** Необходимость управления Python и TypeScript проектами в одном репозитории.
- **Решение:** Выбрана структура «простого монорепозитория» (Decoupled Monorepo) без использования инструментов типа Turborepo или Nx. 
- **Обоснование:** Использование Turborepo признано избыточным (over-engineering), так как стек разнороден (Python + TS) и на данный момент имеется только одно фронтенд-приложение.

### Полная структура директорий

```text
FREESPORT/
├── docker/                     # Конфигурация Docker Compose
│   ├── docker-compose.yml      # Локальная разработка
│   ├── docker-compose.prod.yml # Продакшн
│   ├── nginx/                  # Конфиги Nginx
├── docs/                       # Проектная документация
├── backend/                    # Backend (Django REST Framework)
│   ├── freesport/              # Конфигурация Django
│   ├── apps/                   # Бизнес-приложения (users, products, orders, cart, common)
│   ├── data/                   # Данные для импорта (1С XML)
│   └── tests/                  # Глобальные тесты
└── frontend/                   # Frontend (Next.js)
    ├── src/
    │   ├── app/                # App Router ((blue), (electric), (auth))
    │   ├── components/         # ui, business
    │   ├── services/           # API Clients
    │   ├── store/              # Zustand
    │   ├── types/              # api.ts
    │   └── lib/                # Utils
```

### Архитектурные границы

**API Границы:**
- **Backend API (`/api/v1/`):** Единственная точка входа для данных. Строгий REST контракт.
- **BFF (`/api/auth/`):** Next.js API Routes используются только для проксирования или агрегации.

**Маппинг требований на структуру:**
- **B2B Validation:** `apps/cart/services/validation.py` + `src/services/cartValidation.py`.
- **1C Integration:** `apps/products/services/import_processor.py` + `backend/data/import_1c/`.

## Architecture Validation Results

### Coherence Validation ✅
- **Согласованность:** Структура проекта (Decoupled Monorepo) полностью соответствует выбранному стеку Django + Next.js. Границы ответственности между Backend API и Frontend BFF четко определены.
- **Риски:** Использование `snake_case` в API исключает ошибки трансформации данных.

### Requirements Coverage Validation ✅
- **B2B Логика:** Исследование кода подтвердило наличие:
    - Полей `company_name`, `tax_id` в модели `User`.
    - Схем Zod на фронтенде для валидации ИНН/ОГРН.
    - Проверки `min_order_quantity` в `OrderCreateSerializer`.
- **Ролевая модель:** Реализовано 7 ролей с разграничением цен на уровне сериализаторов.

### Implementation Readiness Validation ✅
- **ADR-005 (Dynamic Validation):** Для реализации эндпоинта `/api/v1/cart/rules/` утверждена следующая схема:
```json
{
  "min_order_total": 5000.00,
  "rules": [
    {
      "product_id": "uuid",
      "min_quantity": 5,
      "multiple_of": 1
    }
  ],
  "payment_methods": ["bank_transfer", "cash_on_delivery"]
}
```
- **Интеграция:** Механизм `ImportSession` готов к обработке транзакционных обновлений из 1С.

## Заключение
Архитектура FREESPORT признана готовой к реализации B2B-функционала. Выбранные паттерны (Service Layer, BFF, Hybrid Dynamic Validation) обеспечивают необходимую гибкость и производительность системы.

_Документ утвержден и готов к использованию в качестве базовой линии разработки._